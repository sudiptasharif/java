INPUT FILE:
TOTAL FOUND: 42283
-----------------------------------------------------------------------------------------
unit main;
interface

uses
  Windows, Messages, SysUtils, Classes, Graphics,extctrls, Controls, Forms, Dialogs,
  HTTPApp, DBWeb, DBTables, Db, DSProd, Utility, scktcomp,
  ttclEncoder, BatchDetailDMU,PPSAPIWeb,
  UploadFileContent, ImportFileParser,
  OExport, OExport_Vcl, OExport_VclForms, OJsonUtils,
  TempusDataSet, RemoteDataSet, ADODB, CardUtil, JpegUtil, Support, RNRegDMu, {tifImg32,tifftags,} alert, registry, msprodkey,
  clMailMessage, clTcpClient, clMC, clSmtp, Winshoes, UDPWinshoe,VersionInfo, activex,
  IQASvcComm,openxml,OPENXMLUtils,rnprofilesDMu,VarEval,prexpr,RNWebsvc,clSoap,clHttp,clHttpRequest, cgiapp,TempusUDPLoggerClientU,
  Math, Bcrypt, AWSAPIu, ttSAMLu,TTProfileXMLu,WebSrvComm,clSspiTls,POSTicketAPIU, DrawerAPIU,
  StopWatch, TempusExtendedClasses,QueryReportDMU,SynGdiPlus,
  ttWebUtilityU,ApplePayWeb,OJsonReadWrite,OJsonPTree,
  IVRRequestU, IVRVXMLU,ttSSReportingU,ttCustomReportingU,IDTechDecryptU,TTProfileU,TDataInterfaceU,ttJSONu,SMSEagle,URLShortener,
  POSEnterpriseReceiptGenU,POSEnterpriseTransactionU,PMRuntimeInfo,FileCtrl,ttDateUtils,RetailNetDMU,
  EmailU, // 2019-5-15 SS DVST-3437
  ProductActivationChangeLogU, ChangeLogUtil; // 2019-6-26 ss DVST-3764

type
  TCustomerInfoModule = class(TWebModule)
    Root: TPageProducer;
    IBSQL: TRemoteDataSet;
    HDQuery: TADOQuery;
    RNQuery: TADOQuery;
    RNDB: TADOConnection;
    RNQuery2: TADOQuery;
    SessionAuthQuery: TADOQuery;
    SMTP: TclSmtp;
    clMail: TclMailMessage;
    WSDB: TADOConnection;
    WSQuery: TADOQuery;
    UserQuery: TADOQuery;
    ADOQuery1: TADOQuery;
    HDDB: TADOConnection; //2016-10-19 jtm Feat OT# 1186
    RNDBDEV: TADOConnection; //2018-04-11 jtm

    procedure DataModule1Create(Sender: TObject);
    procedure CustomerInfoModulerootAction(Sender: TObject;
      Request: TWebRequest; Response: TWebResponse; var Handled: Boolean);
    procedure WebModuleDestroy(Sender: TObject);
    procedure CustomerInfoModulePAYMENTMATEAction(Sender: TObject;
      Request: TWebRequest; Response: TWebResponse; var Handled: Boolean);
    procedure CustomerInfoModuleWebActionItem2Action(Sender: TObject;
      Request: TWebRequest; Response: TWebResponse; var Handled: Boolean);
    procedure CustomerInfoModuleRNCHAINAUTHAction(Sender: TObject;
      Request: TWebRequest; Response: TWebResponse; var Handled: Boolean);
    procedure CustomerInfoModuleLOGOFFCHAINAction(Sender: TObject;
      Request: TWebRequest; Response: TWebResponse; var Handled: Boolean);
    procedure CustomerInfoModuleEchoAction(Sender: TObject;
      Request: TWebRequest; Response: TWebResponse; var Handled: Boolean);
    procedure CustomerInfoModuleWebVTAction(Sender: TObject;
      Request: TWebRequest; Response: TWebResponse; var Handled: Boolean);
    procedure CustomerInfoModulePPAction(Sender: TObject;
      Request: TWebRequest; Response: TWebResponse; var Handled: Boolean);
    procedure CustomerInfoModuleWebReferAction(Sender: TObject;
      Request: TWebRequest; Response: TWebResponse; var Handled: Boolean);
    procedure WebModuleBeforeDispatch(Sender: TObject;
      Request: TWebRequest; Response: TWebResponse; var Handled: Boolean);
    procedure WebModuleAfterDispatch(Sender: TObject; Request: TWebRequest;
      Response: TWebResponse; var Handled: Boolean);
    procedure CustomerInfoModulePPAPIAction(Sender: TObject;
      Request: TWebRequest; Response: TWebResponse; var Handled: Boolean);
  private
    ScriptName: String;
  public
    SessionSC : Integer;
    SessionVars : TStringList;
    CustomerSC : Integer;
    CustomerMembType : String;
    ChainCode : integer;
    UserContainer : String;
    ChainStoreCode : String;
    CacheChainCode: Boolean;
    StoreInfo : String;
    RNSessionID : String;
    AuthType : String;

    StoreName :String;
    StoreAddress1 : String;
    StoreAddress2 : String;
    StoreCity : String;
    StoreState : String;
    StoreZip : String;
    StorePhone : string;
    ReturnURL : String;
    DomainEmail : String;
    DomainSendAsEmail : String;
    DomainFriendlyName : String;
    DomainCompanyName : String;
    DomainHostFolder : String;
    DomainPlatform : String;
    DomainConfig : String;
    DomainInfrastructure : string;
    DomainHostname : string;

    DomainConfigXML : TOpenXML;
    DomainConfigXMLNode : TOpenXMLNode; //2016-06-22 jtm
    UserXML : TOpenXML;
    EmployeeXML : TOpenXML;  //2016-9-19 jtm: Feat OT# 1054
    ExternalXML : TOpenXML;
    ChangeMadeXML : TOpenXML;
    AttributesXML : TOpenXML;

    InstanceGUID : String;
    EventLogServer: TWinshoeUDPClient;
    LoadFileRecursionDepth : Integer;
    RecursionDepth : Integer; //2018-02-02 jtm: F#3765

    FRegistry : TRegIniFile;
    OpenXML : TOpenXML;

    VarEvaluator : TVarEval;
    VarExprEvalStr : String;
    fExprEval: TExpEval;

    SessionVarEval : TVarEval;

    PL : TTempusUDPLoggerClient;
    DebugLevel : integer;
    RetailNetDM : TRetailNetDM;

    TabTextLines :TStringList;
    RecordTextLines : TStringList;
    HTMLResp : TStringList;
    BatchXML : TstringList;
    BatchOXML : TOpenXML;
    AWSAPI : TTAWSAPI;
    ProfileXML : TTProfileXML; //2016-5-25 jtm
    POSTicketAPI : TPOSTicketAPI; //2016-09-29 snt Feat OT# 1120
    POSTicketAPIDB : TADOConnection; //2016-09-29 snt
    CustomReportSumFields : TStringList; //2017-07-19 jtm F#1879
    ttCustomReporting: TttCustomReporting;
    ttSSReporting : TttSSReporting;//2017-10-26 jtm: F#2241
    DrawerAPI : TDrawerAPI; //2017-11-16 jtm: F#2264
    DrawerAPIDB : TADOConnection; //2017-11-16 jtm: F#2264
    RNProfile : TTProfile;//2017-12-13 jtm
    RNProfileDI : TTADODataLayer;//2017-12-13 jtm
    StoreAttr1: TTTStringList; //2018-01-25 jtm
    StoreAttr2: TTTStringList;
    StoreAttr3: TTTStringList;
    StoreAttr4: TTTStringList;
    StoreAttr5: TTTStringList;
    StoreAttr6: TTTStringList;
    StoreAttrHierarchy : TTTStringList; //2018-02-02 jtm: F#3765

    ttWebUtility : TTTWebUtility;

    xExport: TOExport; //2018-03-14 bs: D#2595
    jsonText : string;
    RuntimeInfo : TPMRuntimeInfo; //2018-03-14 jtm: F#3832
    HASTOffsetEST : string; //2018-04-11 jtm: F#3664

    IsRedirectToChangePW: Boolean;

    function GetRNID : string;
    function GetRNCERT : string;overload;
    function GetEmpIdent: string;
    function GetStationIdent: string;
    function GetProfileXMLValueAsString(XPath: string; ADefault: String): string;
    function GetProfileXMLValueAsInteger(XPath: string; ADefault: integer): integer;
    function GetProfileXMLValueAsBoolean(XPath: string; ADefault: boolean): boolean;
    function GetProfileXMLValueAsNumber(XPath: string; ADefault: double): double;
    function GetStoreName: string;
    function GetStoreAddress: string;
    function GetStoreCSZ: string;
    function GetStorePhone: string;
    function GetCustIdentDesc(ADefault: String): string;
    function GetTranIdentDesc(ADefault: String): string;
    function GetCustIdentRequired(ADefault: boolean): boolean;
    function GetTranIdentRequired(ADefault: boolean): boolean;
    function GetDrawerIdent: string;
    procedure InitializeRuntimeInfo();
    Function BCryptPassword(pw : string; custguid: string): string;
    Function CheckBCryptPassword(pw : string; custguid: string; hash : string): boolean;
    Function RNAuthenticate : Boolean;
    Function RNSessionChainAuthenticate : Boolean;
    Function RNLoadHostName : String;
    Function GetStyle(Params : String): String;
    Function GetSessionID : String;
    Function ValidateCert(Request : String;var XMLRespSuccess : Boolean;var XMLRespMessage : String) : Boolean;
    Function ValidateAuthKey  : Boolean;
    procedure SetTheChainCode(const ARNIDasInt: Integer); //2018-09-12 jtm: DVST-100

    Function GetChainCode : Integer;
    Function SetChaincodeByRNID(RNID : String):Boolean;
    Function SetRNIDByChain(ChainStoreCode : String):Integer;
    Function GetCheckQuery : String;
    procedure GetCheckImage;  //2016-10-06 jtm: Feat OT#927
    procedure GetOpenBatchCheckImage; //2018-05-16 ajs: D#4615
    procedure DecodeImageData(ImageData : String; CheckCode : String); //2018-05-16 ajs: D#4615
    Function GetCardQuery : String;
    Function GetCheckQueryTable(RNID : String; //2018-06-20 bls: F#1807
                                FromDate : TDateTime;
                                ThruDate : TDateTime;
                                BatchSerial : Integer;
                                StationName : String;
                                ServiceName : String;
                                DisplayFormat : String;
                                ShowLinks : Boolean;
                                ARequest: TWebRequest;
                                xExport : TOExport;
                                isPaymentMate : Boolean;
                                AAllowAll: Boolean = false;
                                AExtraBreaksBetweenStoreCodes: Boolean = false) : String;
    Function GetCheckQueryTable2(RNID : String;
                                FromDate : TDateTime;
                                ThruDate : TDateTime;
                                BatchSerial : Integer;
                                StationName : String;
                                ServiceName : String;
                                DisplayFormat :String;
                                ARequest: TWebRequest;
                                xExport : TOExport;
                                AAllowAll: Boolean = false;
                                AExtraBreaksBetweenStoreCodes: Boolean = false) : String;
    Function GetCashQueryTable(RNID : String;
                                FromDate : TDateTime;
                                ThruDate : TDateTime;
                                BatchSerial : Integer;
                                StationName : String;
                                SaleType : String;
                                StationIdent : String;
                                DisplayFormat : String;
                                ShowLinks : Boolean;
                                xExport : TOExport) : String;   //2016-8-22 jtm: Feat OT# 1028
    Function GetCardQueryTable(RNID : String;
                                FromDate : TDateTime;
                                ThruDate : TDateTime;
                                BatchSerial : Integer;
                                StationName : String;
                                SaleType : String;
                                StationIdent : String;
                                DisplayFormat : String;
                                SettledOnly : boolean;
                                ShowLinks : Boolean;
                                isPaymentmate : boolean;
                                xExport : TOExport;
                                AAllowAll: Boolean = false;
                                AExtraBreaksBetweenStoreCodes: Boolean = false;
                                ASeparateStores : boolean = false) : String;  //2017-05-10 jtm F#1696
    Function GetCardQueryTableXML(RNID : String;
                                FromDate : TDateTime;
                                ThruDate : TDateTime;
                                BatchSerial : Integer;
                                StationName : String;
                                SaleType : String;
                                StationIdent : String;
                                DisplayFormat : String;
                                SettledOnly : boolean;
                                ShowLinks : Boolean) : String;       //2016-5-25 jtm
    Function GetDrawerQueryTable(RNID : String; FromDate : TDateTime; ThruDate : TDateTime; DisplayFormat : String) : String;//2016-5-25 jtm
    Function GetEODShiftReport(ARNID : String; DrawerIdent : string): string; //2016-5-25 jtm
    Function GetDrawerDetail(ARNID : String; DrawerIdent : string): string;//2016-5-25 jtm
    Function GetDrawerXMLbyDrawerIdent(ARNID : String; DrawerIdent :string) : string; //2016-5-25 jtm
    Function GetDrawerProfile(DisplayFormat :string) : string;  //2016-5-25 jtm
    Function GetDrawerVarianceReasons(DisplayFormat :string;Variance:string) : string;  //2017-11-16 jtm: F#2264
    Function GenerateApproveDrawerXML(ARNID,AEmpIdent,ADrawerIdent,AManagerVarApprovalNotes,AVarianceReason:string): string; //2017-11-16 jtm: F#2264
    Function GetUserQueryTable(AUsername: string; GUID: string; DisplayFormat: string; Download: Boolean): string; //2016-09-29 jtm Feat OT# 1055 // 2019-5-15 SS DVST-702: adding a boolean to be used during download
    Function GetRNLocationSelector(SelectedRNID : String) :String;
    Function ValidateRNID(RNID : String): Boolean;
    Function SetLocationRNIDOrAll(AQueryFields: TStrings): String;
    Function TCKEffectiveStatus(ADS : TDataSet) : Integer; overload;
    Function TCKEffectiveStatus(Status : string; AcceptDate: string; Voided: boolean) : Integer; overload;  //2016-10-06 jtm: Feat OT#927
    Function ColorByECAStatus(AStatus : integer) : String;
    Function ColorByECAStatusJSON(AStatus : integer) : String; //2018-07-18 bls: F#4978
    Function TCKStatusImage(ADS : TDataSet) : String;
    Function TCKStatusImageJSON(ADS : TDataSet) : String; //2018-07-18 bls: F#4978
    Function TCKCheckDetails(SystemCode : Integer) : String;
    Function LoadTCAuth(SystemCode : integer) : boolean; overload;
    Function LoadTCAuth(StoreSystemCode : string; StoreCode : string) : boolean; overload; //2016-10-06 jtm: Feat OT#927
    Function GetStoreInfo(RNID : Integer) : String;

    Function GetRNCERT(RNID : Integer) : String; overload;
    Procedure ProcessLog(ThreadID : Integer; Severity : Integer; EventName : String; Info: String;TransactionType : String; OpCode : Integer; Account : String); overload;
    Procedure ProcessLog(Severity : Integer; EventName : String; Info: String); overload;
    Function GetChainRNIDs(ASL : TStringList) : Integer;
    Function GetStoreNames(RNIDs,ASL : TStringList) : Integer; //2016-09-29 jtm Feat OT# 1055
    Function GetUserRNIDAccess(ASL : TStringList;CheckReadOnly:boolean) : Integer;  //2016-09-29 jtm Feat OT# 1177
    Function ValidateSessionID : Boolean;
    Function PaymentPortalCustomerAuthenticate : Boolean;
    Function GenerateSplitTable(SplitXML: String): String;
    Procedure LoadCustomerFormData(ADS : TDataSet); overload;
    Procedure LoadCustomerFormData(ADS : TDataSet;const AQueryFields, AContentFields: TStrings); overload;
    Procedure LoadCustomerXMLData(ADS : TDataSet; InputXML : TOpenXML);
    Procedure UpdateCustomerXMLData(ADS : TDataSet; InputXML : TOpenXML);

    Function ProcessIPXML(XMLRequest : String; XMLResponse : TStrings; Server : String) : Boolean;
    Function ProcessPPSAPIXML(XMLRequest : String; XMLResponse : TStrings; Server : String;Timeout: integer) : Boolean; overload;//2016-5-25 jtm
    Function ProcessPPSAPIXML(XMLRequest : String): string; overload; //2018-03-14 jtm: F#3832
    Function LoadWebFileFromFolder(FN : String;FolderName : String) : String;
    Function AddCustomer(RNID : STRING; CustGUID : String; InputXML : TOpenXML) :String;
    Function OpenCustomerQuery : boolean; overload;
    Function OpenCustomerQuery(AQueryFields : TStrings) : boolean; overload;
    Function OpenCustomerQueryGUID(RNID : String; CustGUID : String) : boolean;
    Function GenerateCustomerProfile(RNID : String; CustGUID : String) : String;
    Function OpenUserQueryGUID(UserGUID : String) : boolean;   //2016-09-29 jtm Feat OT# 1055


    Function RemovePayment(CustGUID : String; PaymentGUID : String) : Boolean;
    Function GenerateCustomerPaymentsOnFileAdmin(CustGUID : String) : String;
    Function GenerateSubAccountsOnFileAdmin(CustGUID : String) : String;   //2016-10-27 jtm: Feat OT# 1220
    Function ComputeCustomerSchedulesUsedByPaymentGUID(CustGUID : String; PaymentGUID : String): Integer;
    Function ComputeCustomerSchedulesUsedByChildGUID(CustGUID : String; ChildGUID : String): Integer;   //2016-10-27 jtm: Feat OT# 1220
    Function GetCustomerActivePaymentCount(CustGUID : String):Integer;
    Function AddCheckToAccount(const CustGUID, RNID : String;InputXML : TOpenXML) : String;
    Function AddCardToAccount(const CustGUID, RNID : String; InputXML : TOpenXML; CardDetails: TStringList = nil): boolean;
    Function DeletePaymentMethod(const CustGUID, RNID : String; InputXML : TOpenXML) : boolean;
    procedure findPaymentMethodByCustomerAndPaymentMethod(const CustGUID, PaymentGUID : string);

    Function GetConfigString(Parameter : String;DefaultValue : String) : String;
    Function GetConfigBoolean(Parameter : String;DefaultValue : Boolean) : Boolean;
    Function GetAppServerHost : String;
    Function GetBinDetails(AQuery : TADOQuery;BinNumber : String;WSResp:TstringList;var WSMessage : String):Boolean;
    Function OpenXMLLoad : Boolean;
    Function OpenXMLGetTag(TagName : String) : String;  overload;
    Function OpenXMLGetTag(TagName : String; Default : String) : String;   overload;

    Function UserXMLGetTag(TagName : String) : String;   overload;
    Function UserXMLGetTag(TagName : String; Default : String) : String; overload;
    procedure UserXMLSetTag(TagName : String; Value : String);       //2016-9-19 jtm: Feat OT# 1054
    Function EmployeeXMLGetTag(TagName : String) : String;   overload;
    Function EmployeeXMLGetTag(TagName : String; Default : String) : String; overload;
    procedure EmployeeXMLSetTag(TagName : String; Value : String);
    Function ExternalXMLGetTag(TagName : String) : String;
    Function AttributesXMLGetTag(TagName : String) : String;   overload;
    Function AttributesXMLGetTag(TagName : String; Default : String) : String; overload;
    procedure AttributesXMLSetTag(TagName : String; Value : String);

    Procedure ProcessPortalException(EMessage : String);
    procedure XMLSetTag(XML : TOpenXML;TagName : String; Value : String);  //2016-09-29 jtm Feat OT# 1055

    function VarIDFunc(const Identifier: String; ParameterList: TParameterList): TExpression;
    Function VarExprEvalAsString(AInStr : String;AnExpr : String) : String;
    Function GetDCCQuote(RNID : String; AXMLStr : String) : Boolean; //2018-06-20 ajs: F#2221
    Function ProcessPortalPayment(RNID : String; CustGUID : String; InPutXML : TOpenXML) : Boolean;
    Function ProcessPortalPaymentEx(RNID : String; CustGUID : String; InPutXML : TOpenXML;const AQueryFields, AContentFields: TStrings;var AResp:string;JSONResp : boolean = false) : Boolean;
    Function AddCustomerPaymentSchedule(RNID : String; CustGUID : String) : Boolean;
    Function ExternalWebSvc(Input : TStringList; Output : TStringList; URL :String; Action : String;SoapAction : string) : Integer;
    Function ExternalWebSvcEx(Input: TStringList; var Output: TStringList; URL :String; Action : String;APIUsername,APIPW:string;OAuth : boolean = false) : Integer; //2017-10-09 jtm: F#2265
    Function SendPaymentInvite(SessionID : String; Email : String; EmailTemplate : String; DestinationURL : String; FileName : String;ClientURL:string) : String;
    Function SendPaymentInviteSMS(SessionID : String;PhoneNumber : string; DestinationURL : String; FileName : String;ClientURL:string; ARNID:string; ACustIdent:string) : String;//2018-01-25 jtm: F#2080
    Function PracticeVelocityGetPatientInfo(ClinicRNID : String; DOB : TDateTime; LastName : String;PatientAccount : String; URL : String;ResultXML : TStringList) : Boolean;
    Function ValidateAddChildPost : Boolean;
    Function GetPVPracticeID(RNID : String) : String;
    Function GetPVPracticeRNID(PracticeID : String) : String;
    Function GetHJSchoolsByRepID(RepID : String) : String;
    function GetHJSchoolSelector(SelectedAR : String;IncludeAll : Boolean) : String;
    function GetHJSchoolName(SelectedAR : String) : String;
    function ProcessExternalPaymentPosts(PaymentRNID : String):string;
    Function NewAdoQuery : TADOQuery;
    Function LoadSchedGUIDToVars(AScheduleGUID : String; SiteRNID : String; LoadVars : TVarEval) : boolean;
    Function LoadCustGUIDToVars(CustGUID : String; LoadVars : TVarEval) : boolean;
    Function LoadRNIDToVars(ARNID: String; LoadVars: TVarEval): boolean;
    Function ComputeSchedule(AScheduleGUID : String; RNID : String;Increment : boolean;Email : string):integer;     //2016-8-08 jtm added Email
    Function QueryDate(AField : String) : TDatetime;
    Function GetRemoteAddress : String;
    Function GetRNUser(UserName : String) : Boolean;
    Function GetRNUserByGUID(AGUID : String) : Boolean;
    Function GetRNUserByEmail(Email : String) : string;
    function GetRNEmployeeGuidByEmail(Email: String): string;
    Procedure SetRNUser(UserName : String);      //2016-9-19 jtm: Feat OT# 1054
    Procedure LoadSessionVars(ADataSet : TDataSet);
    Function GetChildByValues(RNID : String; CustGUID : String; DOB : String; FirstName : String; LastName : String) : TDataSet;
    Function GetCustomerByEmail(CustRNID : String; EmailAddress: String) : TDataSet;
    Function OpenScheduledPaymentReportQuery(SiteRNID : String;
                                             SelectedRNID : String;
                                             Status : String;
                                             CustGUID : String;
                                             LastName : String;
                                             CustAccountNumber : String) : TDataSet;

    Procedure GenerateScheduledPaymentReport(ADS : TDataSet; DisplayFormat : String; ShowAction : Boolean; ShowLinks : Boolean);
    function DeliverHTMLEmail(Subject : String; ToEmail : String) : Boolean;
    Function GetCCAuthSig(RNID : String;BatchSystemCode : String) : String;
    Function GetCCBatch(RNID : String;BatchSystemCode : String; ReturnDetail : Boolean) : boolean;
    Function GetCCBatchFields(RNID : String;BatchSystemCode : String;FieldNameList : TStringList) : boolean; //2018-06-20 ajs: F#2227
    Function GetTCBatch(RNID : String;BatchSystemCode : String; ReturnDetail : boolean) : boolean;  //2016-5-25 jtm
    Function GetTCBatchFields(RNID, BatchSystemCode : String; FieldNames : TStringList) : boolean; //2018-06-20 bls: F#2227
    Function GetTCImageDetail(RNID : String;BatchSystemCode : String) : boolean; //2018-05-16 ajs: D#4615
    Function GetCashBatch(RNID : String;BatchSystemCode : String; ReturnDetail : boolean) : boolean; //2016-5-25 jtm
    Function GetCashBatchFields(RNID, BatchSystemCode : String; FieldNames : TStringList) : boolean; //2018-06-20 bls: F#2227
    Function GetCheckBatchToHTML(const UILinks : Boolean; const ARNID, EmpIdentP : string):String; //2016-5-25 jtm
    function DisplayStoreNameOnOpenCheck(const defaultValue: String = 'FALSE'): boolean;
    Function GetCheckBatchToGRID(const UILinks : Boolean; const ARNID, EmpIdentP : string):String; //2018-06-20 bls: F#840
    Function GetCashBatchToHTML(const UILinks : Boolean; const EmpIdentP: String):String;  //2016-5-25 jtm
    Function GetCashBatchToGRID(const UILinks : Boolean; const EmpIdentP : String):String; //2018-06-20 bls: F#840
    Function GetBatchToHTML(const UILinks:Boolean; const EmpIdentP: String):String;
    function DisplayStoreNameOnOpenCard(const defaultValue: String = 'FALSE'): boolean;
    Function GetBatchToGRID(const UILinks:Boolean; const EmpIdentP : String):String; //2018-06-20 bls: F#840
    Function GetCheckBatchToXLS(xExport : TOExport; const ARNID, DisplayFormat, EmpIdentP : String):String; //2016-6-13 jtm
    Function GetCashBatchToXLS(xExport: TOExport; const DisplayFormat, EmpIdentP : string):String;  //2016-6-13 jtm
    Function GetBatchToXLS(xExport : TOExport; const DisplayFormat, EmpIdentP : String):String; //2016-6-13 jtm
    function FetchStoreName(const ARNID: String): String;
    Function SingleBatchXMLToTableHTML(const ReadyOnly,ChargeAgain : boolean): String;
    Function SingleCheckBatchXMLToTableHTML(const ReadyOnly : boolean): String;   //2016-10-06 jtm: Feat OT#927
    Function SingleCashBatchXMLToTableHTML:String;    //2018-03-14 jtm: F#3832
    Function VoidCC(const RNID, BatchSystemCode : String) : String;
    Function ReverseCC(RNID : String;BatchSystemCode : String) : String; //2018-05-16 AJS: F#2433
    Function IssueCreditCC(RNID : String;BatchSystemCode : String; Amount : Currency; TranIdent : String) : String; //2017-11-17 ajs: F#2276
    Function ChargeAgainCC(const RNID, BatchSystemCode : String; Amount : Currency; tranIdentP : String = ''; custIdentP : String = ''; ccAuthType: String = 'SALE') : String; //2019-5-15 SS DVST-4406
    Function UserIs(Param : String; RNID : string) : boolean;
    Function IssueRefundTC(RNID : String;BatchSystemCode : String; Amount : Currency) : String; //2019-02-14 jtm: DVST-3122

    Function RetrieveReceipt(RNID : String;SystemCode : String;TicketGUID: string;TranType:String) : String;
    Function EmailReceipt(const EmailAddress : String; const RNID : String; const SystemCode : String; const TicketGUID: string; const TranType:String) : String; //2018-09-12 ajs: DVST-1235
    function SubmitInteractiveXML(RequestXMLStr: string): string;
    Procedure ExtractReceipt(ReceiptXML : TStringList;ReceiptText : TStringList);
    procedure DecodeToFile(const base64: AnsiString; const FileName: string);
    Function ShowStore(XMLStr : String): boolean;
    Procedure InitVars;
    Procedure SaveSessionVarEval;
    Function SendCustomerEmail(Email : string; EmailTemplate : string; EmailSubject:string;BCCList: string;ReplyTo:string) : boolean; //2016-8-08 jtm
    Function BuildEmployeeXML(ADS : TDataSet) : string;          //2016-9-19 jtm: Feat OT# 1054
    procedure XMLAddNode(XML : TOpenXML; Xpath,NewNode, value,NewNodeAttr,NewNodeAttrVal: string);
    Function UserNameExists(AUsername: string) : boolean;     //2016-09-29 jtm Feat OT# 1055
    Procedure LoadUserFormData(ADS : TDataSet; AUsername : string);
    Function RemoveUserRNIDAccess(ADS : TDataSet; AXMLStr : string) : boolean;
    Function RemoveUserChainAccess(ADS : TDataSet; AXMLStr : string) : boolean;  //2016-11-03 jtm Feat OT# 1247
    Function EscapeJSONTokens(value : String) : String; //2016-10-04 snt Feat OT# 1120
    Function GenerateCustomReportOptions: string;   //2016-10-19 jtm Feat OT# 1186
    Function GetCustomReport(AReportName,ADisplayFormat,ARNID : String;FromDate : TDateTime;ThruDate : TDateTime; xExport : TOExport): String; //2016-10-19 jtm Feat OT# 1186
    Function GetServiceNamesByRNID(ARNID: string; AProfileName : string;var ASL : TStringList;var ASL2 : TStringList): integer;  //2017-05-10 jtm F#1565/1564
    Function GetServiceNamesDropDown(ARNID: string; AProfileName:string; AFieldID:string;AIncludeAll: boolean;ACheckReadOnly:boolean):string;
    function GetUserServNameAccessByRNID(ASL: TStringList;ARNID:string;CheckReadOnly:boolean;DefaultServiceNameCount:integer): Integer;
    Function RemoveUserServNameAccessByRNID(ADS: TDataSet; AXMLStr : string;ARNID:string): boolean;
    function GetServiceNamesByUser(ARNID: string; AProfileName: string;ADisplayFormat :string;AUserGUID :string):string;
    Procedure DeleteXMLTag(Var RawXML: String; TagName : String);
    Function GetCustomReportChunked(StartPos,QueryCountInt : integer; AReportName,ADisplayFormat,ARNID : String;FromDate : TDateTime;ThruDate : TDateTime): String; //2017-06-20 jtm: F#1666
    procedure DoProcessExportNode(Sender: TObject; ExportRecord : TStringList; AExportType:TProcessExportType;AADS : TDataset;AReportFormat:TReportFormatType;ARecordTypeList: TStringList); //2017-06-20 jtm: F#1666
    Function GenerateReportXMLFromRequest: String;overload; //2017-10-26 jtm: F#2241
    Function GenerateReportXMLFromRequest(ASL:TStrings): String;overload; //2017-10-26 jtm: F#2241
    Function GenerateReportXMLFromRequestQuery : String; //2018-03-14 bs: D#2595
    Function GenerateReportGridHeaders:string; //2017-10-26 jtm: F#2241
    Function GenerateReportConfigXML:string;//2017-10-26 jtm: F#2241
    procedure GenerateAllLocationOptionsSL(var Locs:TTTStringList);//2017-10-26 jtm: F#2241
    procedure DoProcessRecord(Sender: TObject; ExportRecord : TStringList; AExportType:TProcessRecordType;AADS : TDataset);//2017-10-26 jtm: F#2241
    Function EpicGetPaySessionData(SessionID :string): boolean; //jtm: still in dev
    Function EpicPostTransactionResult(): boolean; //jtm: still in dev
    Function GenerateWebReferSession(RNID:string): boolean;
    Function DoGetAppServerEvent(Sender: TObject; ARNID : string):string;
    Function CCAuthRespErrorCodeToEpicDeclineType(ErrorCode:string):integer;
    Function CardTypeToEpicCardType(CardType : string): integer;
    function GetStoreAttrOptionsSL(var StoreAttr: TTTStringList; AttrNum : string):boolean;//2018-01-25 jtm F#2360
    Function StoreAttrSLToDHTMLXGrid(StoreAttr: TTTStringList) : string;
    procedure GetUserStoreAttrAccess; //2018-02-02 jtm: F#3765
    Function GetUserRNIDAccessByStoreAttr(var ASL : TStringList) : Integer;
    function StringListToSQLCommaTest(ASL: TStringList): string;
    procedure ProcessStoreAttributeXML(XML:TOpenXML;XMLNode:TOpenXMLNode);
    procedure ProcessStoreAttrFields(AQuery : TADOQuery; AFirstCon : boolean;AttrNum:integer);
    Function GenerateRNIDGridHeaders:string;
    function AuthenticateOAuthSession: boolean;//DEV
    Function VencaAccountValidation(ClinicRNID : String; DOB : string; LastFour : String; Account : String; URL : String;ResultXML : TStringList) : Boolean;//DEV
    function DateRangeNumToStr(number: string): string; //2018-04-11 jtm: F#3540
    function NumToBoolStr(num:string): string;

    function BatchXMLToHTML(UILinks: Boolean; LocationRNID: String): String;
    function BatchXMLToXLS(xExport : TOExport; DisplayFormat : String; LocationRNID: String): String;
    function CheckBatchXMLToXLS(ARNID : string; xExport : TOExport; DisplayFormat : String): String;
    function CheckBatchXMLToHTML(UILinks: Boolean;ARNID: string): String;
    function CashBatchXMLToHTML(UILinks: Boolean): String;
    function CashBatchXMLToXLS(xExport : TOExport; DisplayFormat : String): String;
    Function LoadCustPayHistGUIDToVars(PaymentHistGuid : String; LoadVars : TVarEval) : boolean;
    function VTCardAjaxPostReversal(RNID:string; SystemCode : string):string;
    function VTCardAjaxPostSuccess(AQueryFields:TStrings):string;
    function VTCardAjaxPost(const ARNID:string): string;
    function CreateSSReportSchedAjax(AQueryFields,AContentFields: TStrings; ARNID:string): string;
    function DeleteScheduleSSReportAjax(AQueryFields,AContentFields: TStrings; ARNID:string): string;
    function GetScheduledSSReportAjax(AQueryFields,AContentFields: TStrings; const ARNID:string): string;
    function GetScheduledSSReportRunsAjax(AQueryFields,AContentFields: TStrings; ARNID:string): string;

    function GetSSReportXMLAjax(AQueryFields,AContentFields: TStrings; ARNID:string): string;
    function GetSSReportGUIDAjaxDownload(AQueryFields,AContentFields: TStrings; ARNID:string): string;
    function DeleteSSReportAjax(AQueryFields,AContentFields: TStrings; ARNID:string): string;
    function GetSavedSSReportAjax(AQueryFields,AContentFields: TStrings; const ARNID:string): string;
    function SaveSSReportAjax(AQueryFields,AContentFields: TStrings; ARNID:string): string;
    function GetSSStoreAttrGridAjax(AQueryFields,AContentFields: TStrings; ARNID:string): string;
    function GetSSRNIDHeaders(AQueryFields,AContentFields: TStrings; ARNID:string): string;
    function GetSSReportHeaders(AQueryFields,AContentFields: TStrings; ARNID:string): string;
    function GetSSReportAjaxDownload(AQueryFields,AContentFields: TStrings; ARNID:string): string;

    function GetEmployeeGUIDFromUsername(AUsername:string):string;
    function DownloadSSRun(AQueryFields, AContentFields : TStrings; const ARNID : string; out fileName : string) : TMemoryStream;
    function GetMimeTypeFromFileName(const fileName : string) : string;
    procedure GetEmpIdentAndGuid(out tEmpIdent, tEmpGUID : string);
    function DeleteSSRun(AQueryFields, AContentFields : TStrings; const ARNID : string) : string;
    function TextWithoutNewLine(sL : TStringList) : string; //2018-07-18 bls: F#4978
    function SavedReportNameExists(AQueryFields,AContentFields: TStrings; ARNID:string): string;

    Function GetCardQueryTable5000(const AQueryFields, AContentFields: TStrings; xExport : TOExport) : string;
    Function GetCardQueryData(const dbConnection : TADOConnection; const QueryOptions : TStrings) : TDataSet;
    Function QueryDateTime(AField : String) : TDatetime;
    Function CustomerSearch(const AQueryFields, AContentFields: TStrings; const allowedRNIDs : string): string;
    Function PPAuthenticateTempusUser(const AQueryFields, AContentFields: TStrings; const ARNID: string;const ARNSessionID: string): string;
    Procedure SendPWReset(ADS : TDataSet);
    function AuthenticateOktaUser(const AAccessToken: string; const ARNID: string): boolean; //2018-09-12 jtm: DVST-1392
    function GetCustomerByAccountNum(const ARNID : string; const AAccountNumber:string):TDataset; //2018-09-12 jtm: DVST-1392
    Function GetTempusJS(const AQueryFields, AContentFields: TStrings): string;
    function VTChargeAgainSystemcode(const AQueryFields, AContentFields : TStrings): string;
    function GetVTCardDetailAjax(const AQueryFields, AContentFields : TStrings): string;
    Function CardForceAuth(const AQueryFields, AContentFields : TStrings): String;
    function CalculateSurcharge(const AQueryFields, AContentFields: TStrings): string;
    function GetVTTranTypeAjax(const AQueryFields, AContentFields : TStrings) : string;
    function HealthEdgeAPIRequest(const ARequestName: string; var AHEResponse:TStringList): boolean;
    function HealthEdgeAccountReferenceLookup(var AHERequest,AHEResponse:TStringList): boolean;
    function HealthEdgeFindBills(var AHERequest,AHEResponse:TStringList): boolean;
    function HealthEdgeGetBillDetailsByID(var AHERequest,AHEResponse:TStringList): boolean;
    function HealthEdgeGetMemberDetailsByHccId(var AHERequest,AHEResponse:TStringList): boolean;
    function HealthEdgeMembershipLookup(var AHERequest,AHEResponse:TStringList): boolean;
    procedure XMLToVarEval(AVarEval : TVarEval; AXML,AParentTag : string);
    function AddAccountAjax(const AQueryFields, AContentFields: TStrings; ARNID : string): string;
    Procedure AddChildToAccount(const CustGUID,ARNID: string;FirstName,LastName,DOB,AccountNum,ExternalCustIdent,ASubscriptionId : string);
    function GetProfileAjax(const AQueryFields, AContentFields: TStrings; ARNID : string): string;
    function ValidateHEUser(const AMembType : string; var ATranMessage : string) : boolean;
    function HEGetBills(var ATranMessage : string) : boolean;
    function LoadOpenXML(var AOpenXML : TOpenXML;const AXMLStr:string):boolean;
    function AddChildAccountAjax(const AQueryFields, AContentFields: TStrings; ARNID : string): string;
    function GetChildAccountsAjax(const AQueryFields, AContentFields: TStrings; ARNID : string): string;
    function DeleteChildAccountAjax(const AQueryFields, AContentFields: TStrings; ARNID : string): string;
    function ChildAccountExists(const ACustGUID,AAccountNum: string): boolean;
    function GetPaymentMethodsAjax(const AQueryFields, AContentFields: TStrings; ARNID : string): string;
    function GetAutomatedPaymentsAjax(const AQueryFields, AContentFields: TStrings; ARNID : string): string;
    function AddAutomatedPaymentAjax(const AQueryFields, AContentFields: TStrings; ARNID : string): string;
    function DeleteAutomatedPaymentAjax(const AQueryFields, AContentFields: TStrings; ARNID : string): string;
    function GetBillingInformationAjax(const AQueryFields, AContentFields: TStrings; ARNID : string): string;
    function GetAccountInformationAjax(const AQueryFields, AContentFields: TStrings; ARNID : string): string;
    function EditAccountInformationAjax(const AQueryFields, AContentFields: TStrings; ARNID : string): string;
    procedure GetAccountInformationJSON(AQuery: TADOQuery; var ASL: TStringList);
    function GetPaymentHistoryAjax(const AQueryFields, AContentFields: TStrings; ARNID : string): string;
    function EditAccountPWAjax(const AQueryFields, AContentFields: TStrings; ARNID : string): string;
    function UpdateAccountAjax(const AQueryFields, AContentFields: TStrings; ARNID : string): string;
    function ProcessPaymentAjax(const AQueryFields, AContentFields: TStrings; ARNID : string): string;

    function MakeCustomSplitTable(xmlWithData: String):String;//2018-12-19 ss: DVST-2901: Needed for generating custom split table
    function GetTableHeader(delimiter: Char; delimitedHeaders: String):String;
    function GetTableData(delimiter: Char; xmlWithData, targetChildNode, delimitedTags, delimitedDataTypes: String):String;
    function IsValidTableConfig(delimiter: Char; delimitedTags, delimitedHeaders: String):Boolean;
    function BuildTableDataOfTargetNode(targetXMLNode: String; xmlTagList, dataTypeList: TTTStringList):String;
    function GetAStringListFromDelimiterAndDelimitedText(delimiter: Char; delimitedText: String):TTTStringList;
    function MapDataTypeAndGetXMLTagStr(targetXMLNode, tagName, dataType:String):String;

    function GetTransHistoryGridDataAsXML(const TransHistSQL: String; AQueryFields: TStrings;
                                             const DisplayRNID, DisplayStoreName: boolean): String; //2018-12-19 ss: DVST-3056 To display tran hist as grid

    function ReturnZeroSubRowGridDataAsXML(): String; // 2018-12-19 ss: DVST-3056 to display Sub row grid data
    function GetTransHistSubRowGidDataAsXML(const RNID, CustGUID, PayHistGUID: String): String;
    function GetDomainConfigXMLByRNIDAndHostName(RNID, HostName: String):TOpenXML;
    function GetSplitDetailsXMLByCustAndPayHistGUID(CustGUID, PayHistGUID: String):TOpenXML;
    function BuildSplitXMLHeaderByAConfigXML(AConfigXML:TOpenXML):String;
    function BuildSplitXMLBodyByAConfigAndSplitXML(AConfigXML, SplitXML:TOpenXML; var TotalSplitDetails: Integer):String;
    function BuildXMLCellsOfTargetXMLNode(targetXMLNode: String; xmlTagList, dataTypeList: TTTStringList):String;
    procedure HEUpdateExistingAccount(ACustomerSC:Integer;ARNID:string);

    function buildJSONStrForTransData(ASQLQuery: String):String; // 2019-1-16 SS DVST-3660
    function buildJSONByADOQueryHeaderAndColumnPairs(ADOQuery: TADOQuery; HeaderList, ColList: TTTStringList; var Errors: TStringList):String;
    function buildEmptySubRowJSONByHeaderList(HeaderList: TTTStringList):TVarEval;
    function buildSplitXLSMainAndSubRowHeadersAsJSON(AConfigOpenXMLObj: TOpenXML; HeaderList: TTTStringList; Prefix: String; var Errors: TStringList):String;
    function buildSplitXLSMainAndSubRowBodyAsJSON(AConfigXMLObj, ASplitDetailsXMLObj: TOpenXML; HeaderList: TTTStringList; Prefix: String; var Errors: TStringList):String;
    function convertValueToDataType(value, datatype:String): String;
    function IsCobraAccount(AAccountID,AAccountName:string): boolean;

    function buildCustPaySchedTablsDateColsPerCustTimeZone(AScheduleGUID, SiteRNID : String):String;//2019-1-30 SS DVST-3951
    function VTIssueRefundToSystemcode(const AQueryFields, AContentFields: TStrings; ARNID : string): string; //2019-02-14 jtm: DVST-3122
    function PaymentReceipt(const AQueryFields, AContentFields: TStrings; const ARNID: string; out ContentType: string): string;
    function GetPortalConfig(const AQueryFields, AContentFields: TStrings; const ARNID: string): string;
    function GetDHTMLXForm(const AQueryFields, AContentFields: TStrings; const ARNID: string): string;

    procedure AdjustPaymetByCustGUIDAndPaymentAmount(CustGUID, Amount: String); // 2019-2-13 ss DVST-3840
    function GetVTCheckDetailAjax(const AQueryFields, AContentFields : TStrings): string;
    function ParseAndUploadFileDataToDB(UploadFileLocation, XMLAsFilePathOrString, RNID, ChainCode: String; RNDB : TADOConnection; DomainConfigXMLNode : TOPENXMLNode):String;

    function UpdateSessionVarsByConfig(AADOQuery: TADOQuery; APIXML:TOpenXML; CommaSeperatedUpdateList: String):String;//2019-3-13 ss DVST-3483
    function UpdateSessionVarsByUpdateTagList(AADOQuery: TADOQuery; APIXML:TOpenXML; UpdateTagList:TStringList):String;
    procedure SetCurrentUpdateTagList(AStringListToFill:TStringList);
    function ConvertADateTimeStrToDateTime(ADateTimeStr: String):TDateTime;
    function GetPPSQLBySysCodeSessionIDRNID(AXMLResp:TStringList; RNID, SystemCode, SessionID: String):String;

    function GetXMLTargetNodeValueByXPath(AXML, TargetXPath: String):String; //2019-3-13 ss DVST-3445

    function GetReceiptFromRNSessionIDInURL(const AQueryFields, AContentFields: TStrings):String; //2019-3-13 ss DVST-3849
    function GetSessionVarsFromWWWSessionBySessionID(SessionID: String; SessionVarsEval: TVarEval): Boolean;

    function IsPOSTicketOpen(ASessionVarEval, AVarEval: TVarEval): Boolean; // 2019-4-17 ss DVST-3651
    function IsPOSTicketAdd(ASessionVarEval, AVarEval: TVarEval):Boolean; 
    function IsPOSTicketUpdate(ASessionVarEval, AVarEval: TVarEval; AGWResponseXML:TStringList):Boolean;
    function IsPOSTicketDelete(ASessionVarEval, AVarEval: TVarEval; AGWResponseXML:TStringList):Boolean;
    procedure BuildTransactionTabSQLInTZ(const AQueryFields: TStrings; ARNQuery: TADOQuery; const AChainCode: Integer;
                                             const AHASTOffsetEST, AAdminRNID, ARNID: String; const DisplayRNID, DisplayStoreName: boolean); //2019-4-17 ss DVST-4900
    procedure BuildTransactionTabSQL(const AQueryFields: TStrings; ARNQuery:TADOQuery; const AChainCode: Integer;
                                             const AAdminRNID, ARNID: String; const DisplayRNID, DisplayStoreName: boolean); //2019-4-17 ss DVST-4900

    function GetCustPaymentOptionsAjax(const AQueryFields:TStrings; ARNQuery:TADOQuery):String; //2019-4-17 ss DVST-4900: Refactoring to avoid exception thrown because PP Action API is too long
    function GenerateSchoolOptions(ADS : TDataSet) : String;
    function GenerateAllSchoolOptions(IncludeALLOption : Boolean; IncludePleaseSelect : Boolean) : String;
    function GenerateAllLocationsOptions : String;
    function GenerateAllLocationStateOptions : String;
    function GenerateChildNameOptions(ADS : TDataSet; var ChildCount: Integer) : String;
    function GeneratePaymentOptions(ACustGUID : String;PaymentType : String; SelectPaymentGUID : String; var PaymentOptionsCount: Integer): String;
    procedure ValidateApplePaySession(AResponse: TWebResponse; AQueryFields, AContentFields: TStrings; const HostName: String);
    procedure ProcessPaymentApplePay(AResponse: TWebResponse; AQueryFields, AContentFields: TStrings; const HostName: String);

    function AddActivationAjax(const AContentFields: TStrings; AHDQuery:TADOQuery; ASessionVar:TVarEval):String;// 2019-5-15 SS DVST-210: Refactor
    function AddNewProductActivation(const AContentFields: TStrings; AHDQuery:TADOQuery; ASessionVar:TVarEval; ARNID, AEmail: String; var ActivationCode: String):Boolean;
    function GetCustomerZIPByAHDQueryAndARNID(AHDQuery:TADOQuery; ARNID: String):String;

    function GetUniqueActivationCodeForRNID(ARNID: String; AHDQuery:TADOQuery):String; // 2019-5-15 SS DVST-210: refactored inner PP API Action module method
    function AddNProductActivations(const AContentFields: TStrings; AHDQuery:TADOQuery; ASessionVar:TVarEval; N:Integer; ARNID, AEmail: String; ACList: TStringList):Boolean;// 2019-5-15 SS DVST-210
    function GenerateActivationOptions(maxNumOptions:String):String;
    function CheckIfCardIsDisbursable(CardDetails: TStringList; const ARNID: String; const UseGetBinDetail: boolean = false; ServiceName: String = 'CARD';
                                                               const ClientTxnGUID: String = ''; const AppServerSI: String = ''): boolean;
    function isCardDisbursable(const responseXML: String): boolean;
    function wasTransactionSuccessful(const responseXML: String): boolean;

    function GetUsersAjax(const AQueryFields, AContentFields: TStrings; var ContentType: String):String;
    function AddDeviceCapabilities(XML, CardEventParamsXPath: String; Capabilities: Array of String):String; // 2019-5-15 SS DVST-572

    function LockUserAjax(const AQueryFields:TStrings; ARNQuery:TADOQuery; CustomerMembType, ARNID: String): String; // 2019-6-26 SS DVST-5619
    function UnlockUserAjax(const AQueryFields:TStrings; ARNQuery:TADOQuery; CustomerMembType, ARNID: String): String;
    function OpenCommonDBQueryForLockUnlockAjax(const AQueryFields:TStrings; ARNQuery:TADOQuery; CustomerMembType, ARNID: String; var Answer:String):Boolean;{2019-6-26 SS DVST-5619 - OpenDBConnForLockUnlockAjax: This function encapsulates the common work that is done for the Lock and Unlock page}
    function LookupRegistryFromMerchantSessionID(ADOQuery: TADOQuery; const ARNID, MerchantSessionID: string): boolean;


    function GetUniqueActivationCodeForRNIDWithMaxTries(MaxTries: Integer;ARNID: String; AHDQuery:TADOQuery):String; // 2019-5-15 SS DVST-210
    procedure GetStoreScheduledPayments(AResponse: TWebResponse; AContentFields, AQueryFields: TStrings; const ARNID: String; const AChainCode: integer);
    procedure GetStorePaymentHistory(AResponse: TWebResponse; AContentFields, AQueryFields: TStrings; const ARNID, AHASTOffsetEST: String; const AChainCode: integer);

    function AddProductionActivationChangeLog(AChangeHost: String; ADataSet:TDataSet; UserName, RemoteAddress, HDDBConnString: String):Boolean; // 2019-6-26 ss DVST-3764
  end;

   TRecordFormatType = (ttrftHTML, ttrftXLS, ttrftXML, ttrftAJAX, ttrftJSON, ttrftGRID);  //2016-10-01 bah: D#1265
   TReportDelimiterType = (ttrdtCSV, ttrdtPipe, ttrdtTab, ttrdtRow); //2016-10-19 jtm Feat OT# 1186
var
  CustomerInfoModule: TCustomerInfoModule;

implementation

uses JPeg, clHttpUtils;


procedure TCustomerInfoModule.DataModule1Create(Sender: TObject);
var
  FN: array[0..MAX_PATH- 1] of char;
  ConnectionString, HDConnectionStr : string;
begin
  DebugLevel := 0;
  VarEvaluator := TVarEval.Create;
  SessionVarEval := TVarEval.Create;
  TabTextLines := TStringList.Create;
  fExprEval := TExpEval.Create;
  PL := TTempusUDPLoggerClient.create;
  PL.ProcessLog(ltinfo, 'APPCREATE','');

  LoadFileRecursionDepth := 0;
  RecursionDepth := 0;

  EventLogServer := NIL;
  InstanceGUID := PL.GetInstanceGUID;
  PL.AddAppValue('WSTXNGUID',InstanceGUID); //Force it to send this value too
  HTMLResp := TStringList.Create;
  BatchXML := TStringList.Create;
  AWSAPI   := TTAWSAPI.Create;
  StoreAttr1 := TTTStringList.Create;
  StoreAttr2 := TTTStringList.Create;
  StoreAttr3 := TTTStringList.Create;
  StoreAttr4 := TTTStringList.Create;
  StoreAttr5 := TTTStringList.Create;
  StoreAttr6 := TTTStringList.Create;
  StoreAttrHierarchy := TTTStringList.Create;
   ProcessLog(ltinfo,'WEBSVC Opening Registry',InstanceGUID);
  Try
   FRegistry := TRegIniFile.Create('Tempus Technologies');
   FRegistry.RootKey := HKEY_LOCAL_MACHINE;
   FRegistry.OpenKey('SOFTWARE\Tempus Technologies', True);
  except
     On E:Exception do begin
         ProcessLog(ltCritical,'Exception on Opening Registry key ' + E.Message,InstanceGUID);

     end;
  end;

  if assigned(FRegistry) then begin
      HDConnectionStr := '';
      HDConnectionStr := FRegistry.ReadString('GWDBConnStrings', 'HDConnString', '');  //jrs 10/25/2016 F#1222
      if (HDConnectionStr <> '') then begin
        HDDB.ConnectionString := HDConnectionStr;
      end else begin
          ProcessLog(ltCritical,'Websvc Create','HelpDesk Connection must be set in registry');
          ProcessPortalException('HelpDesk Connection must be set in registry');
          exit;
      end;
      ConnectionString := '';
      ConnectionString := FRegistry.ReadString('GWDBConnStrings', 'RNConnString', '');
      if (ConnectionString = '') then begin
          ConnectionString := FRegistry.ReadString('RetailNet ChainCodes', 'DBConn', '');
      end;
      if (ConnectionString <> '') then begin
          ProcessLog(ltInfo,'Websvc Create','Changing ConnectionString');
          RNDB.Close;
          RNDB.ConnectionString := ConnectionString;
      end else begin
         ProcessLog(ltCritical,'Websvc Create','Retailnet Connection must be set in registry');
         ProcessPortalException('Retailnet Connection must be set in registry');
         exit;
      end;
   end else begin
      ProcessLog(ltCritical,'Websvc Create','FRegistry not set');
      ProcessPortalException('FRegistry not set');
      exit;
   end;



  DebugLevel := FRegistry.ReadInteger('Websvc', 'DebugLevel', 0);
   RetailNetDM := TRetailNetDM.Create(FRegistry,PL.ProcessLog,RNDB);

   ProcessLog(ltinfo,'WEBSVC CREATE',InstanceGUID);


   Try
     SetString(ScriptName, FN, GetModuleFileName(hInstance, FN, SizeOf(FN)));
     ScriptName := ExtractFileName(ScriptName);
   except
      on E:Exception do begin
      end;
   end;

   ProcessLog(ltinfo,'WEBSVC Setting DB Connection',InstanceGUID);
                                                                   

   Try
     RNReg := TRNReg.Create(Nil);
     RNReg.SetConnection(RNDB);
     RNSessionID := '';
   Except
      on E:Exception do begin
         ProcessLog(ltWarning,'Exception on RNREG.SetConnection ' + E.Message,InstanceGUID);

      end;
   end;


  CustomerSC := 0;

   ttWebUtility := TTTWebUtility.Create(PL.ProcessLog, RetailNetDM,0);
   ProfileXML := nil;
   if ttDateUtils.IsDaylightSavingTime(Now) then begin //2018-04-11 jtm: F#3664
      HASTOffsetEST := '6';
   end else begin
      HASTOffsetEST := '5';
   end;
end;

procedure TCustomerInfoModule.CustomerInfoModulerootAction(Sender: TObject;
  Request: TWebRequest; Response: TWebResponse; var Handled: Boolean);
var
WS : String;
begin
   WS := '<HTML><TITLE>Tempus Technologies Web Services</TITLE><BODY><CENTER><IMG SRC="/Images/General/TempusLogoSmall.gif" border="0"><H3>Tempus Technologies Web Services<BR>' +
         'All connections to this server are logged.  Unauthorized access prohibited.</H3>' +
         'Server Time:' + FormatDateTime('MM/DD/YYYY HH:NN:SS', Now) + '<BR>'+
         'Your IP:' + Request.RemoteHost + '<BR></CENTER>' +
         '</BODY></HTML>';


  Response.Content := WS;
end;

Function TCustomerInfoModule.ProcessIPXML(XMLRequest : String; XMLResponse : TStrings; Server : String) : Boolean;
var
   CWS : TClientSocket;
   WS : String;
   ClientSockStream : TWinSocketStream;
   Line : String;
   InBuf : String;
   TransactionStart : TDateTime;
   Function StreamReadLn(AStream : TStream) : String;
   var
      BytesRead : Integer;
      InChr : String;
   Begin
      SetLength(InChr,10000);
      BytesRead := 1;
      While ((Pos(#10, InBuf) = 0) And (BytesRead > 0) and (CWS.Socket.Connected))  do begin
         BytesRead := 0;
         If TWinSocketStream(Astream).WaitForData(50000) then begin
            FillChar(InChr[1], 10000,#0);
            BytesRead := AStream.Read(InChr[1],10000);
            If BytesRead >0 then begin
               InBuf := InBuf + Copy(InChr,1,BytesRead);
            end;
            Application.ProcessMessages;
         end;
      End;
      Result := ParseToChar(InBuf, #10);

   end;
   Procedure StreamWriteln(AStream : TStream;AStr : String);
   Begin
      AStr := Trim(AStr) + #13 + #10;
      AStream.Write(AStr[1], Length(Astr));
   end;

Begin
   XMLResponse.Clear;
   TransactionStart := NOW;
   Result := False;
   Try
      CWS := TClientSocket.Create(NIL);
      CWS.Address := Server;
      CWS.Port := 980;
      CWS.Socket.ClientType := ctBlocking;
      ClientSockStream := TWinSocketStream.Create(CWS.Socket,120000);
      CWS.Active := True;
      Result := CWS.Socket.Connected;
      If Not CWS.Socket.Connected then begin
         ProcessLog(ltInfo,'SOCKET not connected to ' + Server,'ProcessIPXML');
         Result := False;
      end else begin
         ProcessLog(ltInfo,'Connected, Sending request to ' + Server + ':' + Stri(CWS.Port,-1) + ' ' + Stri(Length(XMLRequest),-1) + ' Bytes','ProcessIPXML');
         PL.StartTimer;
         StreamWriteLn(ClientSockStream, XMLRequest);
         WS := '';
         InBuf := '';
         ProcessLog(ltinfo,'Request Sent, waiting for response','ProcessIPXML');
         Repeat
            Line := StreamReadLn(ClientSockStream);
            ReplaceString(Line,#13,'');
            XMLResponse.Add(Line);

         until (Trim(Line) = '</TRANRESP>') or (Not CWS.Socket.Connected) or (Trim(Line) = '');
         If Trim(Line) = '</TRANRESP>' then Result := True;
         PL.StopTimer;
         PL.AddMessageValue('TRANSACTIONTYPE', GetXMLTagStr(XMLRequest, 'TRANSACTIONTYPE'));
         PL.SetLogIdentGUID('452EAA02-3477-49DD-9028-7336967FFD5B');
         ProcessLog(ltinfo,'Request Complete, ' + Stri(XMLResponse.Count,-1) + ' Lines, Success=' + GetXMLTag(XMLResponse, 'TRANSUCCESS'),'ProcessIPXML');

         If not Result then begin
            ProcessLog(ltWARNING,'XML Response Failure','ProcessIPXML');
         end else begin
         end;

         ProcessLog(ltInfo,'EXE TIME:' + FormatDateTime('HH:NN:SS.ZZZ', NOW-TransactionStart),'ProcessIPXML');

      end;

   except
     ON E:Exception do begin
         ProcessLog(ltWarning,'Exception ' + E.Message + ' Communicating with  ' + Server,'ProcessIPXML');
        Result := False;
     end;
   end;
   CWS.Close;
   if (Assigned(ClientSockStream)) then
      ClientSockStream.Free;
   CWS.Free;
   Result := True;
end;

Function TCustomerInfoModule.RNAuthenticate : Boolean;
var
   encoder : TclEncoder;
   WS : String;
   User : String;
   Pass : String;
Begin
  Result := False;
  ChainCode := 0;
  UserContainer := '';


  If Request.Authorization <> '' then begin
     encoder := TclEncoder.Create(nil);
     try
        WS := Request.Authorization;
        ParseToChar(WS,' ');
        WS := Trim(WS);
        Encoder.DecodeString(WS,WS,cmMIMEBase64);
        User := ParseToChar(WS,':');
        Pass := WS;

        RNQuery.SQL.Clear;
        RNQuery.SQL.Add('Select SystemCode, LogonPassword from chains where systemcode = ' + NumericOnly(User));
        RNQuery.Open;

        If (Trim(RNQuery.FieldByName('LogonPassword').AsString) = Trim(Pass)) then begin
           Result := true;
           ChainCode := RNQuery.FieldByName('SystemCode').AsInteger;
        end;
     finally
        encoder.Free();
     end;
  end;
  If Not Result then begin
      Response.StatusCode := 401;
      Response.WWWAuthenticate := 'Basic realm="RetailNet Secure Access"';
  end;

end;

Function TCustomerInfoModule.RNSessionChainAuthenticate : Boolean;
var
   WS: String;
   Dest : String;

Begin
   Result := False;
   GetSessionID;
   SessionAuthQuery.Close;
   SessionAuthQuery.SQL.Clear;
   SessionAuthQuery.SQL.Add('Select * from WWWSession where RNSessionID = ''' + RnSessionID + '''');
   SessionAuthQuery.Open;
   If SessionAuthQuery.RecordCount = 1 then begin
      If SessionAuthQuery.FieldByName('ChainAuthenticatedTill').AsDateTime > NOW then begin
         ChainCode := SessionAuthQuery.FieldByName('ChainCode').AsInteger;
         SessionAuthQuery.Edit;
         SessionAuthQuery.FieldByName('ChainAuthenticatedTill').AsDateTime := NOW + EncodeTime(1,0,0,0); //extend another 60 mins
         SessionAuthQuery.Post;
         Result := True;
      end else begin
         Dest := Request.pathInfo;
         If Request.Query <> '' then
            Dest := Dest + '?' + Request.Query;
         SessionAuthQuery.Edit;
         SessionAuthQuery.FieldByName('Dest').AsString := Dest;
         SessionAuthQuery.Post;


         WS := GetStyle('');
         ws := WS + '<HEAD><TITLE>Tempus Technologies RetailNet Chain Logon</TITLE></HEAD>';
         WS := WS + '<CENTER><TABLE border="0" cellspacing="0" cellpadding="3" bordercolorlight="#0000FF" style="border-collapse: collapse">';
         WS := WS + '<TR><TD align="CENTER" Colspan=2><IMG SRC="/Images/General/TempusLogoSmall.gif" border="0"></TD></TR>';
         WS := WS + '<form style="margin:0px;" method="post" name=''ChainAuth'' action=''RNCHAINAUTH'' id=''Form1'' >';
         WS := WS + '<TR><TD>User/Chain ID:</TD>' +
                            '    <TD><input name=USERNAME type=text id=USERNAME value="" onfocus="value=''" size=10 maxlength=50> </TD></TR>';
         WS := WS + '<TR><TD>Password:</TD>' +
                         '    <TD><input name=PASSWORD TYPE=PASSWORD id=PASSWORD value="" onfocus="value=''" size=10 maxlength=50> </TD></TR>';
         WS := WS + '<td colspan="2" align="CENTER"><input type="image" src="/images/general/Login.GIF" name="submit" value="GO" /></td></TR>';
        WS := WS + '   <input type=''hidden'' name=REFERPATH value=''PAYMENTMATE''>';


         WS := WS + '</FORM>';
         WS := WS + '</TABLE></CENTER>';
         Response.ContentType := 'text/html';
         Response.Content := WS;
      end;
   end;

end;

Function TCustomerInfoModule.GetStyle(Params : String): String;
Begin
   Result := '<STYLE TYPE="text/css">' +
             '<!--' +
             '   BODY' +
             '   {' +
             '     color:Black;' +
             '     font-size:10pt;' +
             '     background-color:White;' +
             '     font-family:sans-serif;' +
             '   }' +
             '   TABLE' +
             '   {' +
             '     color:Black;' +
             '     font-size:8pt;' +
             '     background-color:White;' +
             '     font-family:sans-serif;' +
             '   }' +
             'A:link{color:Blue}' +
             'A:visited{color:Purple}' +
             '-->' +
             '</STYLE>';
end;

Function TCustomerInfoModule.GetSessionID : String;
var
   SIDSystemCode : INteger;
   CookieSL : TStringList;
   Dest : String;
   SetCookie : Boolean;
Begin
   Randomize;
   SetCookie := False;
   If RNSessionID = '' then begin
      RNSessionID := ValidCharsOnly(Request.QueryFields.Values['SESSIONID'],True,True,'-');
      ProcessLog(ltInfo, 'GetSessionID', 'query field session id: ' + RNSessionID);
      SetCookie := true;
   end;

   If RNSessionID = '' then begin
      RNSessionID := ValidCharsOnly(Request.CookieFields.Values['RNSESSIONID'],True,True,'-');
      ProcessLog(ltInfo, 'GetSessionID', 'cookie field session id: ' + RNSessionID);
      SetCookie := false;
   end;
   try
      If RNSessionID <> '' then begin
         RNQuery.Close;
         RNQuery.SQL.Clear;
           RNQuery.SQL.Add('Select * from WWWSession where RNSessionID = ''' + RnSessionID + '''');
         RNQuery.Open;
         If RNQuery.RecordCount <> 1 then begin
            RNSessionID := ''; //Invalid sessionID
            RNQuery.Close;
         end else begin
            SIDSystemCode := RNQuery.FieldByName('SystemCode').AsInteger;
            SessionSC := SIDSystemCode;
            CustomerSC := RNQuery.FieldByName('CustomerSC').AsInteger;
            CustomerMembType := Trim(RNQuery.FieldByName('MembType').AsString);
            SessionVarEval.Vars.Text := RNQuery.FieldByName('SessionVars').AsString;
            If RNQuery.FieldByName('ChainCode').AsInteger <> 0 then
               ChainCode := RNQuery.FieldByName('ChainCode').AsInteger;
            RNQuery.Close;
            RNQuery.SQL.Clear;
            RNQuery.SQL.Add('Update WWWSession Set LastAccess = ''' + FormatDateTime('MM/DD/YYYY HH:NN:SS',now) +
                            ''', AccessCount = AccessCount + 1' +
                            ',RemoteAddress = ''' + GetRemoteAddress + '''');
            RNQuery.SQL.Add('where RNSessionID = ''' + RnSessionID + '''');
            RNQuery.ExecSQL;
            if SetCookie then begin
               CookieSL := TStringList.Create;
               CookieSL.Add('RNSESSIONID=' + RNSessionID);
               Response.SetCookieField(CookieSL, '', '/',-1,False);
               CookieSL.Free;
            end;
         end;
      end;

      If RNSessionID = '' then begin
         RNSessionID := GenerateGUID;//StringToSHADigestHex(SessionSeed);
         RNQuery.SQL.Clear;
         RNQuery.SQL.Add('Insert Into WWWSession (RNSessionID, DateAdded, AccessCount,RemoteAddress,WWWDomain) values (''' +
                          RNSessionID + ''',''' +
                          FormatDateTime('MM/DD/YYYY HH:NN:SS',now) + ''',1,'''+GetRemoteAddress + ''','''+trim(Request.Host)+''')');
         RNQuery.ExecSQL;

         CookieSL := TStringList.Create;
         CookieSL.Add('RNSESSIONID=' + RNSessionID);
         Response.SetCookieField(CookieSL, '', '/',-1,False);
         CookieSL.Free;

         RNQuery.Close;
         RNQuery.SQL.Clear;
         RNQuery.SQL.Add('Select * from WWWSession where RNSessionID = ''' + RnSessionID + '''');
         RNQuery.Open;
         SIDSystemCode := RNQuery.FieldByName('SystemCode').AsInteger;
         SessionSC := SIDSystemCode;
         RNQuery.Edit;
         Dest := Request.pathInfo;
         If Request.Query <> '' then
            Dest := Dest + '?' + Request.Query;
         RNQuery.FieldByName('DEST').AsString := Dest;
         RNQuery.Post;

      end;
      PL.AddAppValue('SESSIONID',  RNSessionID);
      Result := RNSessionID;
   except //2018-02-02 jtm: F#3765
      On E:Exception do begin
         ProcessLog(ltWarning, 'Exception GetSessionID:', E.Message);
         if ((ExceptionIsMultiUserInterference(RNQuery)) or (ExceptionIsPrimaryKeyConstraint(RNQuery))) and (RecursionDepth < 5) then begin
            Inc(RecursionDepth);
            ProcessLog(ltWarning, 'Exception GetSessionID:', 'start recursion:' + IntToStr(RecursionDepth));
            result := GetSessionID;
            RecursionDepth := 0;
         end else begin
            ProcessLog(ltWarning, 'Exception GetSessionID error number:', IntToStr(RNQuery2.Connection.Errors.Item[0].Number));
            result := '';
         end;
      end;
   end;
end;

Function TCustomerInfoModule.ValidateCert(Request : String;var XMLRespSuccess : Boolean;var XMLRespMessage : String) : Boolean;
var
   UserCert : String;
   RNID : String;
   RNIDasInt: Integer;
   Cert : TStringList;
   ChainCert : String;
   CachedCert: String;
Begin
   result := true;
   AuthType := 'RNID';
   exit;

   Result := False;
   if (RNID = '') then begin
      RNID := GetXMLTagStr(Request,'RNID');
      if (RNID = '') then begin
         RNID := GetXMLTagStr(Request,'PROFILE');
      end;
   end;
   RNIDasInt := Valu(RNID);
   UserCert := Trim(GetXMLTagStr(Request,'RNCERT'));
   ChainCert := AlphaNumericOnly(Trim(GetXMLTagStr(Request,'RNCHAINCERT')));

   AuthType := Trim(GetXMLTagStr(Request,'AUTHTYPE'));
   if AuthType = '' Then begin
      AuthType := 'RNID';
   end;

   If AuthType = 'CHAIN' then begin
      Result := False;
      If (ChainCode > 0) and (ChainStoreCode <> '') then begin
         If FileExists('\\RNDB02\Corpsys\ChainKeys\' + Stri(ChainCode,-1) + '.CHAIN.KEY') then begin
            Cert := TStringList.Create;
            Try
               Cert.LoadFromFile('\\RNDB02\Corpsys\ChainKeys\' + Stri(ChainCode,-1) + '.CHAIN.KEY');
               If Cert.Count > 0 then begin
                  if AESToRNCert(Cert[0]) = ChainCert then begin
                     Result := True;
                     FRegistry.WriteString('RetailNet CHAIN CERT HASH', Stri(ChainCode,-1),StringToSHADigestHex(ChainCert+Stri(ChainCode,-1)+ CardUtil.StringToSHADigestHex(msprodkey.View_Win_Key)));
                     AppendFileStr('\\RNDB02\Corpsys\ChainKeys\ChainAuth.' + Stri(ChainCode,-1) + '.Log', FormatDateTime('MM/DD/YYYY HH:NN:SS', NOW) + #9 + Stri(ChainCode,-1) + #9 + Stri(RNIDasInt,-1));
                  end else begin
                     XMLRespMessage := 'Invalid client supplied RNCHAINCERT, Request Logged.';
                     AppendFileStr('\\RNDB02\Corpsys\ChainKeys\' + Stri(ChainCode,-1) + '.InvalidRequest.'+ FormatDateTime('MM-DD-YYYY-HH-NN-SS', NOW) + '.XML', Request);
                  end;
               end else begin
                  XMLRespMessage := 'Invalid or empty Server Cert File';
               end;
            except
               on E:Exception do begin
                  XMLRespMessage := 'Exception loading Key '+E.Message;
               end;
            end;
            Cert.Free;

         end else begin
            XMLRespMessage := 'INVALID CHAIN AUTH CERT' + Stri(ChainCode,-1);
            XMLRespSuccess := False;
            ProcessLog(ltWarning, 'INVALID CHAIN AUTH CERT', 'VALIDATECERT');
         end;
      end else begin
         XMLRespMessage := 'CHAINCODE/RNCHAINCERT EXPECTED';
         XMLRespSuccess := False;
      end;
      Exit;
   end;

   if Trim(GetXMLTagStr(Request,'RNID')) = '' then begin
      XMLRespSuccess := False;
      XMLRespMessage := 'RNID EXPECTED';
      exit;
   end;
   if UserCert = '' then begin
      XMLRespSuccess := False;
      XMLRespMessage := 'RNCERT EXPECTED';
      exit;
   end;

   If Length(UserCert) > 50 then begin
      UserCert := StringToSHADigestHex(UserCert + 'I-iAEV9Jvalo\_V:lRNc=y]G[');
   end;

   CachedCert := FRegistry.ReadString('RetailNet CERT HASH', Stri(RNIDasInt,-1), '');
   If CachedCert <> '' then begin
      If FRegistry.ReadString('RetailNet CERT HASH', Stri(RNIDasInt,-1),'') =
         StringToSHADigestHex(UserCert+Stri(RNIDasInt,-1)+ CardUtil.StringToSHADigestHex(msprodkey.View_Win_Key)) then begin
         Result := True;
         FRegistry.WriteString('RetailNet CERT Last Auth', Stri(RNIDasInt,-1),FormatDateTime('YYYY-MM-DD HH:NN:SS', Now));
      end else begin
         XMLRespMessage := 'Invalid client supplied RNCERT: Request Logged.';
         ProcessLog(ltWarning, 'Invalid client supplied RNCERT', 'VALIDATECERT');
      end;
   end else If FileExists('\\RNDB02\Corpsys\Keys\' + Stri(RNIDasInt,-1) + '.KEY') then begin
      Cert := TStringList.Create;
      Try
         Cert.LoadFromFile('\\RNDB02\Corpsys\Keys\' + Stri(RNIDasInt,-1) + '.KEY');
         If Cert.Count > 0 then begin
            if (Cert[0] = UserCert) or (StringToSHADigestHex(Cert[0] + 'I-iAEV9Jvalo\_V:lRNc=y]G[') = UserCert) then begin
               Result := True;
               FRegistry.WriteString('RetailNet CERT HASH', Stri(RNIDasInt,-1),StringToSHADigestHex(UserCert+Stri(RNIDasInt,-1)+ CardUtil.StringToSHADigestHex(msprodkey.View_Win_Key)));
            end else begin
               XMLRespMessage := 'Invalid client supplied RNCERT, Request Logged.';
               ProcessLog(ltWarning, 'Invalid client supplied RNCERT', 'VALIDATECERT');
               AppendFileStr('\\RNDB02\Corpsys\Keys\' + Stri(RNIDasInt,-1) + '.InvalidRequest.'+ FormatDateTime('MM-DD-YYYY-HH-NN-SS', NOW) + '.XML', Request);
            end;
         end else begin
            XMLRespMessage := 'Invalid or empty Server Cert File';
         end;
      except
         on E:Exception do begin
            XMLRespMessage := 'Exception loading Key '+E.Message;
         end;
      end;
      Cert.Free;
   end else begin
      XMLRespMessage := 'RNCERT Not Allocated or unreadable';
   end;

   if (Result = true) then begin
      SetTheChainCode(RNIDasInt);
   end;

end;
Function TCustomerInfoModule.ValidateAuthKey  : Boolean;
var
   AuthKey : String;
   RNID : String;
   Salt : String;
   OurAuthKey : String;
   Date : String;
begin
    Result := False;
    AuthKey := ValidCharsOnly(Request.queryfields.Values['AUTHKEY'], true,true,'');
    RNID := ValidCharsOnly(Request.queryfields.Values['RNID'], false,true,'');
    Date := FormatDateTime('MM/DD/YYYY', Now);


    if length(AuthKey) = 40 then begin
      SessionAuthQuery.Close;
      SessionAuthQuery.SQL.Clear;
      SessionAuthQuery.SQL.Add('Select * from WWWSession where RNSessionID = ''' + RnSessionID + '''');
      SessionAuthQuery.Open;
      SessionAuthQuery.Edit;
      SessionAuthQuery.FieldByName('MembType').AsString := 'ADMIN';
      SessionAuthQuery.Post;
      ProcessLog(ltInfo,'Valid AuthKey:', AuthKey);
      Result := true;
    end else begin
      SessionAuthQuery.Close;
      SessionAuthQuery.SQL.Clear;
      SessionAuthQuery.SQL.Add('Select * from WWWSession where RNSessionID = ''' + RnSessionID + '''');
      SessionAuthQuery.Open;
      SessionAuthQuery.Edit;
      SessionAuthQuery.FieldByName('MembType').AsString := '';
      SessionAuthQuery.Post;
    end;

end;

Function TCustomerInfoModule.GetChainCode : Integer;
Begin
   Result := ChainCode;
end;

procedure TCustomerInfoModule.WebModuleDestroy(Sender: TObject);
begin
   RNReg.Free;
   TabTextLines.Free;
   VarEvaluator.Free;
   SessionVarEval.Free;
   fExprEval.Free;

   HTMLResp.Free;
   BatchXML.Free;
   FreeAndNil(AWSAPI);
   FreeAndNil(StoreAttr1);
   FreeAndNil(StoreAttr2);
   FreeAndNil(StoreAttr3);
   FreeAndNil(StoreAttr4);
   FreeAndNil(StoreAttr5);
   FreeAndNil(StoreAttr6);
   FreeAndNil(StoreAttrHierarchy);
   if Assigned(POSTicketAPIDB) then FreeAndNil(POSTicketAPIDB);
   if Assigned(POSTicketAPI) then FreeAndNil(POSTicketAPI);
   if ProfileXML <> nil then FreeAndNil(ProfileXML);
   if BatchOXML <> nil then BatchOXML.Free;
   if DomainConfigXML <> nil then FreeAndNil(DomainConfigXML);
   if UserXML <> nil then FreeAndNil(UserXML);
   if EmployeeXML <> nil then FreeAndNil(EmployeeXML);
   if ExternalXML <> nil then FreeAndNil(ExternalXML);
   if AttributesXML <> nil then FreeAndNil(AttributesXML);
   if ChangeMadeXML <> nil then FreeAndNil(ChangeMadeXML);
   if Assigned(DrawerAPIDB) then FreeAndNil(DrawerAPIDB); //2017-11-16 jtm: F#2264
   if Assigned(DrawerAPI) then FreeAndNil(DrawerAPI);
   if (assigned(RNProfile)) then begin//2017-12-13 jtm
      FreeAndNil(RNProfile);
   end;
   if (assigned(RNProfileDI)) then begin//2017-12-13 jtm
      FreeAndNil(RNProfileDI);
   end;

   Try
      If Assigned(EventLogServer) then begin
         EventLogServer.Disconnect;
         EventLogServer.Free;
       end;
   except
      On E:Exception do begin
      end;
   end;
   FreeAndNil(RetailNetDM);
   PL.Free;
   FRegistry.Free;
end;

procedure TCustomerInfoModule.CustomerInfoModulePAYMENTMATEAction(
  Sender: TObject; Request: TWebRequest; Response: TWebResponse;
  var Handled: Boolean);

Var
   WS: String;
   FromDate : TDateTime;
   ThruDate : TDateTime;
   DateStr : String;
   Res : String;
   StoreList : TStringList;
   I : integer;
   StoreData : String;

   xlsStream : TMemoryStream; //2018-03-14 bs: D#2595 //changed for 1.1.64.2
   xlsExporter : TOCustomExporter;
   xlsFileName : String;

begin
  If Not RNSessionChainAuthenticate then exit;

  Response.ContentType := 'text/html';
  GetSessionID;
  RNReg.ChainCode := ChainCode;

  xExport := TOExport.Create; //2018-03-14 bs: D#2595
  xlsExporter := TOExporterXLT.Create;
  
  WS := GetStyle('');
  ws := WS + '<HEAD><TITLE>Tempus Technologies PaymentMate</TITLE></HEAD>';
  WS := WS + '<CENTER><A href="/PAYMENTMATE">';
  WS := WS + '<IMG SRC="/Images/General/TempusLogoSmall.gif" border="0">';
  WS := WS + '<IMG SRC="/Images/General/PaymentMateSmall.gif" border="0">';
  WS := WS + '</CENTER></A><BR><HR>';
  If Request.queryfields.Values['PAGE'] = 'CHECK' then begin
     If Request.queryfields.Values['ACTION'] = 'CHECKQUERY' then begin
        Try
           DateStr := NormalizeWebInput(Request.queryfields.Values['FROMDATE']);
           FromDate := StrToDateTime(DateStr);
           DateStr := NormalizeWebInput(Request.queryfields.Values['THRUDATE']);
           ThruDate := StrToDateTime(DateStr);

           If Request.queryfields.Values['SHOWALL'] = 'TRUE' then begin
              Res := GetCheckQueryTable('ALL',FromDate,ThruDate,0,Trim(Request.queryfields.Values['STATIONIDENT']),Trim(Request.queryfields.Values['SERVICENAME']),Request.queryfields.Values['FORMAT'],False, Request, xExport, true, true, true);
           end else begin
              Res := GetCheckQueryTable(Request.queryfields.Values['RNID'],FromDate,ThruDate,0,Trim(Request.queryfields.Values['STATIONIDENT']),Trim(Request.queryfields.Values['SERVICENAME']),Request.queryfields.Values['FORMAT'],False, Request, xExport, true);
           end;
           If res = '' then
              Res := 'No Records Found<BR>';


           if Request.queryfields.Values['FORMAT'] = 'XLS' then begin
              xlsFileName :=  'TransactionHistory-' + FormatDateTime('YYYYMMDDHHNNSS',now) + '.xls'; //2018-03-14 bs: D#2595 //changed for 1.1.64.2
              Response.CustomHeaders.Values['Content-Disposition'] := 'attachment; filename=' + xlsFileName;

              if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEOLDXLSFORMAT', 'FALSE') = 'TRUE') OR
              (RNReg.RegGetValAsString('PMACCESS.USEOLDXLSFORMAT','FALSE') = 'TRUE') then begin
                 Response.Content := Res;
                 Response.ContentType := 'application/vnd.ms-excel';
              end else begin
                 xlsStream := TMemoryStream.Create();
                 xExport.SaveToStream(xlsStream, xlsExporter);
                 xlsStream.Position := 0;

                 Response.ContentStream := xlsStream;
                 Response.ContentType := 'application/vnd.ms-excel';
              end;
              Exit;
           end;
           WS := WS + Res;
           WS := WS + '<A HREF="PAYMENTMATE?RNID=' +Request.queryfields.Values['RNID'] +
                                         '&FROMDATE='+Request.queryfields.Values['FROMDATE'] +
                                         '&THRUDATE='+Request.queryfields.Values['THRUDATE'] +
                                         '&PAGE=CHECK&ACTION=CHECKQUERY&FORMAT=XLS&SHOWALL=' + Request.queryfields.Values['SHOWALL'] +'">Download in Excel</A>';

        Except
           On E:Exception do begin
              WS := WS + 'INVALID DATE';
           end;
        end;


     end else If Request.queryfields.Values['ACTION'] = 'CHECKDETAILS' then begin
        WS := WS + TCKCheckDetails(Valu(Request.queryfields.Values['CHECKCODE']));
     end;

  end else If Request.queryfields.Values['PAGE'] = 'CARD' then begin
     If Request.queryfields.Values['ACTION'] = 'CARDQUERY' then begin
        Try
           DateStr := NormalizeWebInput(Request.queryfields.Values['FROMDATE']);
           FromDate := StrToDateTime(DateStr);
           DateStr := NormalizeWebInput(Request.queryfields.Values['THRUDATE']);
           ThruDate := StrToDateTime(DateStr);

           If Request.queryfields.Values['SHOWALL'] = 'TRUE' then begin
               Res := GetCardQueryTable('ALL',FromDate,ThruDate,0,'',
                                             Request.queryfields.Values['SALETYPE'],
                                             NormalizeWebInput(Request.queryfields.Values['STATIONIDENT']),
                                             Request.queryfields.Values['FORMAT'],false,false,true,xExport,true,true,true);

           end else begin
              Res := GetCardQueryTable(Request.queryfields.Values['RNID'],FromDate,ThruDate,0,'',
                                       Request.queryfields.Values['SALETYPE'],
                                       NormalizeWebInput(Request.queryfields.Values['STATIONIDENT']),
                                       Request.queryfields.Values['FORMAT'],false,false,true,xExport,true);
           end;
           If res = '' then
              Res := 'No Records Found<BR>';

           if Request.queryfields.Values['FORMAT'] = 'XLS' then begin
              xlsFileName := 'TransactionHistory-' + FormatDateTime('YYYYMMDDHHNNSS',now) + '.xls'; //2018-03-14 bs: D#2595 //changed for 1.1.64.2
              Response.CustomHeaders.Values['Content-Disposition'] := 'attachment; filename=' + xlsFileName;

              if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEOLDXLSFORMAT', 'FALSE') = 'TRUE') OR
              (RNReg.RegGetValAsString('PMACCESS.USEOLDXLSFORMAT','FALSE') = 'TRUE') then begin
                 Response.Content := Res;
                 Response.ContentType := 'application/vnd.ms-excel';
              end else begin
                 xlsStream := TMemoryStream.Create();
                 xExport.SaveToStream(xlsStream, xlsExporter);
                 xlsStream.Position := 0;

                 Response.ContentStream := xlsStream;
                 Response.ContentType := 'application/vnd.ms-excel';
              end;
              Exit;
           end;
           WS := WS + Res;
           WS := WS + '<A HREF="PAYMENTMATE?RNID=' +Request.queryfields.Values['RNID'] +
                                         '&FROMDATE='+Request.queryfields.Values['FROMDATE'] +
                                         '&THRUDATE='+Request.queryfields.Values['THRUDATE'] +
                                         '&SALETYPE='+Request.queryfields.Values['SALETYPE'] +
                                         '&STATIONIDENT='+WebParamEncode(Request.queryfields.Values['STATIONIDENT']) +

                                         '&PAGE=CARD&ACTION=CARDQUERY&FORMAT=XLS&SHOWALL=' + Request.queryfields.Values['SHOWALL'] +'">Download in Excel</A>';


        Except
           On E:Exception do begin
              WS := WS + 'INVALID DATE ' + E.Message;
           end;
        end;
     end;
  end else begin
     WS := WS + '<CENTER>';
     WS := WS + '<TABLE border="0" cellspacing="0" cellpadding="3" bordercolorlight="#0000FF" style="border-collapse: collapse">';
     WS := WS + '<TR><TD>' + GetCheckQuery + '</TD><TD>' + GetCardQuery + '</TD></TR></TABLE>';
     WS := WS + '<BR><A href="LOGOFFCHAIN?REFERPATH=PAYMENTMATE"><IMG SRC="/Images/General/LogOff.gif" border="0"></A><BR>';
     WS := WS + '<BR><SMALL>Copyright (C) 2006-'+FormatDateTime('YYYY',NOW)+' Tempus Technologies, Inc. All Rights Reserved.';
     WS := WS + '<BR>All trademarks are property of their respective owners.';
     WS := WS + '<BR>Authorized users only, all access is logged.';
     WS := WS + '<BR>Your IP Address is: '+ Request.RemoteHost + '</SMALL></CENTER>';
  end;


  Response.Content := WS;
end;
Function TCustomerInfoModule.GetCheckQuery : String;
Begin

   Result := Result + '<TABLE border="1" cellspacing="0" cellpadding="3" bordercolorlight="#0000FF" style="border-collapse: collapse"><TR><TD>';
   Result := Result + '<TABLE border="0" cellspacing="0" cellpadding="3" bordercolorlight="#0000FF" style="border-collapse: collapse">';
   Result := Result + '<TR><TD align="CENTER" Colspan=2><IMG SRC="/Images/General/TelecheckSmallLogo.gif" border="0"></TD></TR>';
   Result := Result + '<form style="margin:0px;" name=''searchbox'' action=''PAYMENTMATE'' id=''Form1'' >';
   Result := Result + '<TR><TD Colspan=2>'+GetRNLocationSelector('')+ '</TD></TR>';
   Result := Result + '<TR><TD>From Date:</TD>' +
                      '    <TD><input name=FROMDATE type=text id=FROMDATE value="' +FormatDateTime('MM/DD/yyyy', Date-7) +'" onfocus="value=''" size=10 maxlength=50> </TD></TR>';
   Result := Result + '<TR><TD>Thru Date:</TD>' +
                      '    <TD><input name=THRUDATE type=text id=THRUDATE value="' +FormatDateTime('MM/DD/yyyy', Date) +'" onfocus="value=''" size=10 maxlength=50> </TD></TR>';

   If RNReg.RegGetValAsString('PMACCESS.SHOWALLLOCS','FALSE') = 'TRUE' then begin
      Result := Result + '<TR><TD></TD>' +
                         '    <TD><input name=SHOWALL type=CHECKBOX value="TRUE" onfocus="value=''" size=10 maxlength=50>Show all Locations</TD></TR>';
   end;
      Result := Result + '<TR><TD></TD>' +
                         '    <TD><input name=APPROVEDONLY type=CHECKBOX value="TRUE" onfocus="value=''" size=10 maxlength=50>Approved Checks only</TD></TR>';

   Result := Result + '<td colspan="2" align="CENTER"><input type="image" src="/images/general/SearchChecks.GIF" name="submit" value="GO" /></td></TR>';
   Result := Result + '<input type=''hidden'' name=''PAGE'' value=''CHECK''>';
   Result := Result + '<input type=''hidden'' name=''ACTION'' value=''CHECKQUERY''>';

   Result := Result + '</FORM>';
   Result := Result + '</TABLE>';
   Result := Result + '</TD></TR></TABLE>';

end;
Function TCustomerInfoModule.GetCardQuery : String;
Begin

   Result := Result + '<TABLE border="1" cellspacing="0" cellpadding="3" bordercolorlight="#0000FF" style="border-collapse: collapse"><TR><TD>';
   Result := Result + '<TABLE border="0" cellspacing="0" cellpadding="3" bordercolorlight="#0000FF" style="border-collapse: collapse">';
   Result := Result + '<TR><TD align="CENTER" Colspan=2><IMG SRC="/Images/General/fdc.gif" border="0"></TD></TR>';
   Result := Result + '<form style="margin:0px;" name=''searchbox'' action=''PAYMENTMATE'' id=''Form1'' >';
   Result := Result + '<TR><TD Colspan=2>'+GetRNLocationSelector('')+ '</TD></TR>';
   Result := Result + '<TR><TD>From Date:</TD>' +
                      '    <TD><input name=FROMDATE type=text id=FROMDATE value="' +FormatDateTime('MM/DD/yyyy', Date-7) +'" onfocus="value=''" size=10 maxlength=50> </TD></TR>';
   Result := Result + '<TR><TD>Thru Date:</TD>' +
                      '    <TD><input name=THRUDATE type=text id=THRUDATE value="' +FormatDateTime('MM/DD/yyyy', Date) +'" onfocus="value=''" size=10 maxlength=50> </TD></TR>';

   If RNReg.RegGetValAsString('PMACCESS.SHOWALLLOCS','FALSE') = 'TRUE' then begin
      Result := Result + '<TR><TD></TD>' +
                         '    <TD><input name=SHOWALL type=CHECKBOX value="TRUE" onfocus="value=''" size=10 maxlength=50>Show all Locations</TD></TR>';
   end;
      Result := Result + '<TR><TD></TD>' +
                         '    <TD><BR></TD></TR>';

   Result := Result + '<td colspan="2" align="CENTER"><input type="image" src="/images/general/SearchCards.GIF" name="submit" value="GO" /></td></TR>';
   Result := Result + '<input type=''hidden'' name=''PAGE'' value=''CARD''>';
   Result := Result + '<input type=''hidden'' name=''ACTION'' value=''CARDQUERY''>';

   Result := Result + '</FORM>';
   Result := Result + '</TABLE>';
   Result := Result + '</TD></TR></TABLE>';

end;

(*Function TCustomerInfoModule.GetCheckQueryTable(RNID : String;
                                                FromDate : TDateTime;
                                                ThruDate : TDateTime;
                                                BatchSerial : Integer;
                                                StationName : String;
                                                ServiceName : String;
                                                DisplayFormat :String;
                                                ShowLinks : Boolean;
                                                xExport: TOExport ) : String;
var
   WS : String;
   I : Integer;
   StoreInfo : String;
   CSV : TStringList;
   JSON : TStringList; //2018-03-14 bs: D#2595
   HTML : TStringList;
   CSVLine : TStringList;
   GRID : TStringList; //2018-06-14 bls: F#840

   LineAmt : single;

   EAmount : Currency;
   ECount  : Integer;
   PAmount : Currency;
   PCount  : Integer;
   VAmount : Currency;
   VCount  : Integer;
   DAmount : Currency;
   DCount  : Integer;
   ErrorAmount : Currency;
   ErrorCount  : Integer;
   CHType : String;
   AllowAll : boolean;
   RNIDList : TStringList;
   IncludeEmpIdent : boolean; //2016-06-13 jtm
   CSVStr : string;
   IncludeProfileFields : boolean;  //2016-7-28 jtm
   PreviousRNID : string;
   CustomField1Value, CustomField2Value, CustomField3Value, CustomField4Value, CustomField5Value, CustomField6Value : String;
   StoreSystemCodeLabel : string;
   IncludeRefundData : boolean; //2017-08-16 jtm: F#1833
   ShowVoidAsZero : boolean;
   DisplayInTZ : boolean; //2017-12-20 jtm: D#2620
   UsingAll : boolean;

   xlsWorkSheet : TExportWorksheet; //Represents actual xls worksheet //2018-03-14 bs: D#2595
   Row : TExportRow; //Represents actual row inside the TExportWorksheet
   iterator : integer;
   JSONString : string;
   DateRange : string;

   TranIdentHeader : string; //2018-4-24 bls: F#3735
   CustIdentHeader : string; //2018-4-24 bls: F#3735

   DisplayStoreName : boolean; //2018-04-30 bls: F#1129
   storeName : string;
   DisplayECAType : boolean; //2018-05-08 bls D#4384
   ecaStatus : string; //2018-05-08 bls D#4384

begin
   Result := '';
   IncludeEmpIdent := false;
   IncludeProfileFields := false;
   IncludeRefundData := false;
   ShowVoidAsZero := false;

   CSV := TStringList.Create;
   CSVLine := TStringList.Create;
   HTML := TStringList.Create;
   JSON := TStringList.Create;
   AllowAll := false;
   RNIDList := TStringList.Create;
   DisplayInTZ := false;
   UsingAll := false;
   DisplayStoreName := false;
   DisplayECAType := false; //2018-05-08 bls D#4384

   TranIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/TCTRANIDENTDESC', 'Tran Ident')); //2018-4-24 bls: F#3735
   CustIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/TCCUSTIDENTDESC', 'Cust Ident')); //2018-4-24 bls: F#3735

   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYECATYPE', 'FALSE') = 'TRUE' then DisplayECAType := true; //2018-05-08 bls D#4384
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CHECKHISTDISPLAYSTORENAME', 'FALSE') = 'TRUE' then DisplayStoreName := true; //2018-30-2018 bls: F#1129
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/ALLOWALLSEARCH', 'FALSE') = 'TRUE' then AllowAll := true;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL', '') <> '' then StoreSystemCodeLabel := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL'));  //2016-8-22 jtm: Feat OT#1038
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SHOWCHECKVOIDASZERO', 'FALSE') = 'TRUE' then ShowVoidAsZero := true;

   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE') = 'TRUE') then DisplayInTZ := true;//2017-12-20 jtm: D#2620
   if not (DisplayInTZ) then begin
      if (RNReg.RegGetValAsString('PMACCESS.DISPLAYINTZ','FALSE') = 'TRUE') then begin //for APM
         DisplayInTZ := true;
      end;
   end;
   if (AllowAll) and (RNID = 'ALL') then begin //2016-5-25 jtm
      GetChainRNIDs(RNIDList);
      UsingAll := true;
   end else begin
      If NOT ValidateRNID(RNID)  then begin
         Result := 'Invalid Store Code';
         exit;
      end;
      StoreInfo := GetStoreInfo(Valu(RNID));
      RNIDList.Add(NumericOnly(RNID));
   end;

   EAmount := 0;
   ECount  := 0;
   PAmount := 0;
   PCount  := 0;
   VAmount := 0;
   VCount  := 0;
   DAmount := 0;
   DCount  := 0;
   ErrorAmount := 0;
   ErrorCount  := 0;
   CustomField1Value := '';
   CustomField2Value := '';
   CustomField3Value := '';
   CustomField4Value := '';
   CustomField5Value := '';
   CustomField6Value := '';
   DateRange := '';

   RNQuery.Close;
   RNQuery.SQL.clear;
   RNQuery.SQL.Add(DRSQLVarsDec);

   if (DateRange = 'CUSTOM') or (DateRange = '')  then begin
      RNQuery.SQL.Add('set @BegDate = ''' + FormatDateTime('MM/DD/YYYY', Fromdate) + '''; set @EndDate =''' + FormatDateTime('MM/DD/YYYY', ThruDate + 1) + ''';');
   end else begin
      RNQuery.SQL.Add('set @DateRangeName = '''+DateRange+''';'+DRSQLSetBegDate + DRSQLSetEndDate);
   end;
   RNQuery.SQL.Add(DRSQLSetTZ);
   RNQuery.SQL.Add('set @BegDateHAST = DATEADD(hour,'+HASTOffsetEST+',@BegDate);set @EndDateHAST = DATEADD(hour,'+HASTOffsetEST+',@EndDate); ');

   RNQuery.SQL.Add('Select');
   if (DisplayInTZ) then begin
      RNQuery.SQL.Add('CASE r.KeyValue WHEN ''AST'' THEN DATEADD(hour,+1,tc.AuthDate) WHEN ''CST'' THEN DATEADD(hour,-1,tc.AuthDate) WHEN ''MST'' THEN DATEADD(hour,-2,tc.AuthDate) ');
      RNQuery.SQL.Add('WHEN ''PST'' THEN DATEADD(hour,-3,tc.AuthDate) WHEN ''AKST'' THEN DATEADD(hour,-4,tc.AuthDate)');
      RNQuery.SQL.Add('WHEN ''HAST'' THEN DATEADD(hour,'+HASTOffsetEST+',tc.AuthDate) ELSE tc.AuthDate END authdatetz,');
   end;
   RNQuery.SQL.Add('S.SystemCode RNID, tc.*,s.Name,s.City,s.State,s.ZIP');

   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYECATYPE', 'FALSE') = 'TRUE' then begin
      RNQuery.SQL.Add(', (case when tc.Voided = 1 then ''VOID'' when tc.RefundAmount > 0 then ''REFUND'' else ''SALE'' end) as ''TransactionType'''); //2018-05-08 bls D#4384
   end;

   RNQuery.SQL.Add('from TCAuth tc left outer join');
   RNQuery.SQL.Add('  Store s on tc.StoreCode = s.SystemCode');
   if (DisplayInTZ) then begin
      RNQuery.SQL.Add('left outer join REGISTRY r on r.SubKey1 = tc.storecode');
   end;
   RNQuery.SQL.Add('where (s.SystemCode in(' + RNIDList.CommaText + '))');

   if (DisplayInTZ) then begin
      RNQuery.SQL.Add('and r.subkey2 = ''storetz''');
      RNQuery.SQL.Add('and (Authdate >= case r.KeyValue WHEN ''AST'' THEN @BegDateAST WHEN ''CST'' THEN @BegDateCST WHEN ''MST'' THEN @BegDateMST WHEN ''PST'' THEN @BegDatePST WHEN ''AKST'' THEN @BegDateAKST WHEN ''HAST'' THEN @BegDateHAST ELSE @BegDate END)');  //figure out DST for AZ and HI
      RNQuery.SQL.Add('and (Authdate < case r.KeyValue WHEN ''AST'' THEN @EndDateAST WHEN ''CST'' THEN @EndDateCST WHEN ''MST'' THEN @EndDateMST WHEN ''PST'' THEN @EndDatePST WHEN ''AKST'' THEN @EndDateAKST WHEN ''HAST'' THEN @EndDateHAST ELSE @EndDate END)');
   end else begin
      RNQuery.SQL.Add('and (AuthDate >= @BegDate)');
      RNQuery.SQL.Add('and (AuthDate < @EndDate)');
   end;

   If Request.queryfields.Values['APPROVEDONLY'] = 'TRUE' then
      RNQuery.SQL.Add('AND (ECATranStatus in (''0'',''1''))');

   StationName := ValidCharsOnly(StationName,True,True,'-._ ');
   If length(StationName) > 20 then
      SetLength(StationName,20);
   If StationName <> '' then
      RNQuery.SQL.Add('And (StationIdent =''' + StationName + ''')');

   ServiceName := ValidCharsOnly(ServiceName,True,True,'-');
   If length(ServiceName) > 20 then
      SetLength(ServiceName,20);
   If ServiceName <> '' then
      RNQuery.SQL.Add('And (TCServiceName =''' + ServiceName + ''')');

   CHType := VarEvaluator.GetValueAsString('CHECKHISTTYPE');
   If CHType = '0' then
      RNQuery.SQL.Add('And (ECATranStatus =''0'') and (voided = 0)');
   If CHType = '1' then
      RNQuery.SQL.Add('And (ECATranStatus =''1'')and (voided = 0)');
   If CHType = '01' then
      RNQuery.SQL.Add('AND (ECATranStatus in (''0'',''1'')) and (voided = 0)');
   If CHType = '34' then
      RNQuery.SQL.Add('AND (ECATranStatus in (''3'',''4'','''')) and (voided = 0)');//2018-05-07 bls D#2603
   If CHType = 'VOID' then
      RNQuery.SQL.Add('AND (voided = 1)');



   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHEMPIDENT', 'FALSE') = 'TRUE') and (ValidCharsonly(Request.queryfields.Values['EMPIDENT'],True,True,'.-_:/&') <> '') then begin
      RNQuery.SQL.Add('And (TranEmployeeIdent LIKE ''' + ValidCharsonly(Request.queryfields.Values['EMPIDENT'],True,True,'.-_:/& ') + '%'')'); //2017-05-10 jtm D#1605  //2018-04-26 bls D#2533 
   end;
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHTRANIDENT', 'FALSE') = 'TRUE') and (ValidCharsonly(Request.queryfields.Values['TRANIDENT'],True,True,'.-_:/& ') <> '') then begin
      RNQuery.SQL.Add('And (TranIdent LIKE ''' + ValidCharsonly(Request.queryfields.Values['TRANIDENT'],True,True,'.-_:/& ') + '%'')'); //2017-05-10 jtm D#1605
   end;
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHDOLLARAMT', 'FALSE') = 'TRUE') and (ValidCharsonly(Request.queryfields.Values['DOLLARAMT'],False,True,'.') <> '') then begin
      if (NumericOnly(Request.queryfields.Values['DOLLARAMTCOMP']) = '0') then begin
          RNQuery.SQL.Add('And (TranAmount = ''' + ValidCharsonly(Request.queryfields.Values['DOLLARAMT'],false,True,'.') + ''')');
      end else if(NumericOnly(Request.queryfields.Values['DOLLARAMTCOMP']) = '1') then begin
          RNQuery.SQL.Add('And (TranAmount > ''' + ValidCharsonly(Request.queryfields.Values['DOLLARAMT'],false,True,'.') + ''')');
      end else if (NumericOnly(Request.queryfields.Values['DOLLARAMTCOMP']) = '2') then begin
          RNQuery.SQL.Add('And (TranAmount < ''' + ValidCharsonly(Request.queryfields.Values['DOLLARAMT'],false,True,'.') + ''')');
      end;
   end;
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHCUSTIDENT', 'FALSE') = 'TRUE') and (ValidCharsonly(Request.queryfields.Values['CUSTIDENT'],True,True,'.-_:/& ') <> '') then begin
      RNQuery.SQL.Add('And (TranCustomerCode LIKE ''' + ValidCharsonly(Request.queryfields.Values['CUSTIDENT'],True,True,'.-_:/& ') + '%'')'); //2017-05-10 jtm D#1605
   end;

   RNQuery.SQL.Add('Order by Storecode, AuthDate');
   ProcessLog(ltDebug,'GetCheckQueryTable RNQuery.SQL.Text',RNQuery.SQL.Text);




   RNQuery.Open;
   I := 0;
   WS := 'Checks from ' + FormatDateTime('MM/DD/YYYY',Fromdate) + ' Thru ' +FormatDateTime('MM/DD/YYYY',Thrudate) + ' <BR><B>' + RNID + '<BR>' + StoreInfo + '</B><BR>'  ;
   HTML.Clear;
   HTML.Add(WS);
   JSON.Append('[');
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEEMPIDENT', 'FALSE') = 'TRUE' then IncludeEmpIdent := true;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEPROFILEFIELDS', 'FALSE') = 'TRUE' then IncludeProfileFields := true;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEREFUNDDATA', 'FALSE') = 'TRUE' then IncludeRefundData := true;

   if xExport <> nil then begin //2018-05-16 bls: D#4292 - Moved up here in order to display a blank workbook without error
      xlsWorkSheet := xExport.AddWorkSheet;
   end;

   If RNquery.RecordCount > 0 then begin
      RNQuery.DisableControls;

      if DisplayStoreName then begin //2018-30-04 bls: F#1129
         storeName := '  <TD><B>Store Name</B></TD>';
      end else begin
         storeName := '';
      end;

      if DisplayECAType then begin //2018-05-11 bls: D#3790
         ecaStatus := '    <TD><B>ECA Status</B></TD>';
      end else begin
         ecaStatus := '';
      end;

      HTML.Add('<TABLE border="1" cellspacing="0" cellpadding="3"  style="border-collapse: collapse; font-size:7pt;font-family:veranda">'  +  //2017-09-06 jtm: D#1887
                 '<TR><TD><B>RNID</B></TD>' +
                 storeName +
                 '    <TD><B>Auth Date</B></TD>' +
                 '    <TD Align="Right"><B>Amount</B></TD>' +
                 ecaStatus +  //2018-05-11 bls: D#3790
                 '    <TD><B>CHK #</B></TD>' +
                 '    <TD><B>TCK Response</B></TD>' +
                 '    <TD Colspan=2 align="Center"><B>Status</B></TD>' +
                 '    <TD><B>' + TranIdentHeader + '</B></TD>'+ //2018-4-24 bls: F#3735
                 '    <TD><B>' + CustIdentHeader + '</B></TD>'+
                 '    <TD><B>Batch</B></TD>' +
                 '    <TD><B>Station</B></TD>' +
                 '    <TD><B>MID</B></TD>' +
                 '    <TD><B>Service</B></TD>');
      If DisplayFormat <> 'AJAX' then
         HTML.Add('    <TD><B></B></TD>');
      if IncludeEmpIdent then HTML.Add('    <TD><B>EmpIdent</B></TD>');
      if StoreSystemCodeLabel <> '' then
         HTML.Add('  <TD><B>'+ StoreSystemCodeLabel +'</B></TD>')
      else
         HTML.Add('  <TD><B>Item Serial</B></TD>');
      if IncludeRefundData then HTML.Add('    <TD><B>Refund Amount</B></TD>'+
                                          '    <TD><B>Last Refund Date</B></TD>');
      HTML.Add('</TR>');
      
      If (DisplayFormat = 'XLS') and (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEREPORTHEADERS', 'FALSE') = 'TRUE') then begin   //2016-06-13 jtm
         Row := xlsWorkSheet.AddRow;

         Row.AddCellString('RNID');

         if DisplayStoreName then begin
            Row.AddCellString('Store Name');
         end;

         Row.AddCellString('Auth Date');
         Row.AddCellString('Amount');

         if DisplayECAType then begin //2018-05-11 bls: D#3790
            Row.AddCellString('ECA Status'); //2018-05-11 bls: D#3790
         end;

         Row.AddCellString('CHK');
         Row.AddCellString('TCK Response');
         Row.AddCellString('Status');
         Row.AddCellString(TranIdentHeader);
         Row.AddCellString(CustIdentHeader);
         Row.AddCellString('Batch');
         Row.AddCellString('Station');
         Row.AddCellString('MID');
         Row.AddCellString('Service');
         Row.AddCellString('Store Name');
         Row.AddCellString('Store City');
         Row.AddCellString('Store State');
         Row.AddCellString('Store ZIP');

         if IncludeEmpIdent then Row.AddCellString('Employee Ident').SetCalculateColWidth;
         if StoreSystemCodeLabel <> '' then
            Row.AddCellString(StoreSystemCodeLabel)
         else
            Row.AddCellString('Station Code');
         if IncludeProfileFields then begin
            if not Assigned(ProfileXML) then ProfileXML := TTProfileXML.Create(StrToInt(Trim(RNQuery.FieldByName('StoreCode').AsString)), HDQuery);

            Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/NAME', ''));
            Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/NAME', ''));
            Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/NAME', ''));
            Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/NAME', ''));
            Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/NAME', ''));
            Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/NAME', ''));
         end;
         if IncludeRefundData then begin {CSVStr := CSVStr + 'Refund Amount'+ #9 +
                                          'Last Refund Date'+ #9;
            Row.AddCellString('Refund Amount').SetCalculateColWidth;
            Row.AddCellString('Last Refund Date').SetCalculateColWidth;
         end;

         For iterator := 0 to Row.Cells.Count - 1 do
         begin
            Row.Cells.Items[iterator].SetFontColor(clBlack).SetBorder(cbBottom).SetBGColor(TColor($80000000)).SetAlignment(cahCenter);
         end;
      end;


      Repeat
         If DisplayFormat = 'XML' then begin
               CSV.ADD('<CHECKHISTDETAIL>'+
                         '<RNID>' + Trim(RNQuery.FieldByName('StoreCode').AsString) + '</RNID>');
               if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620
                  CSV.ADD('<AUTHDATE>' + FormatDateTime('MM/DD/YYYY HH:NN:SS',RNQuery.FieldByname('AuthDatetz').AsDateTime)+ '</AUTHDATE>');
               end else begin
                  CSV.ADD('<AUTHDATE>' + FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('AuthDate').AsDateTime) + '</AUTHDATE>');
               end;
               CSV.ADD('<DISPLAYTEXT>' + Trim(RNQuery.FieldByName('DISPLAYTEXT').AsString) + '</DISPLAYTEXT>');
               CSV.ADD('<TRANAMT>' + Trim(StriReal(RNQuery.FieldByName('TranAmount').AsFloat,2)) + '</TRANAMT>');
               CSV.ADD('<UPDATEDAMT>' + Trim(StriReal(RNQuery.FieldByName('UpdatedAmount').AsFloat,2)) + '</UPDATEDAMT>');
               CSV.ADD('<RETURNCHECKFEE>' + Trim(StriReal(RNQuery.FieldByName('RETURNCHECKFEE').AsFloat,2)) + '</RETURNCHECKFEE>');

               If RNQuery.FieldByName('Voided').AsBoolean then
                  CSV.ADD('<VOIDEDDATE>' + FormatDateTime('MM/DD/YYYY', RNQuery.FieldByName('VOIDEDDATE').AsDateTime) + '</VOIDEDDATE>');

               CSV.ADD('<CHECKTYPE>' + Trim(RNQuery.FieldByName('CHECKTYPE').AsString)+ '</CHECKTYPE>' +
                                  '<AUTHCODE>' + Trim(RNQuery.FieldByName('APPROVALCODE').AsString)+ '</AUTHCODE>' +
                                  '<ROUTINGNUMBER>' + Trim(RNQuery.FieldByName('ResponseTransitNumber').AsString)+ '</ROUTINGNUMBER>' +
                                  '<CHECKNUMBER>' + Trim(RNQuery.FieldByName('ResponseCheckNumber').AsString)+ '</CHECKNUMBER>' +
                                  '<TRACEID>' + Trim(RNQuery.FieldByName('TRACEID').AsString)+ '</TRACEID>' +
                                  '<DENIALRECORDNUMBER>' + Trim(RNQuery.FieldByName('DENIALRECORDNUMBER').AsString)+ '</DENIALRECORDNUMBER>' +
                                  '<CUSTIDENT>' + Trim(RNQuery.FieldByName('TranCustomerCode').AsString)+ '</CUSTIDENT>' +
                                  '<STATIONIDENT>' + Trim(RNQuery.FieldByName('STATIONIDENT').AsString)+ '</STATIONIDENT>' +
                                  '<TRANIDENT>' + Trim(RNQuery.FieldByName('TRANIDENT').AsString)+ '</TRANIDENT>' +
                                  '<TCMID>' + Trim(RNQuery.FieldByName('TCMID').AsString)+ '</TCMID>' +
                                  '<SYSTEMCODE>' + Trim(RNQuery.FieldByName('StoreSystemCode').AsString)+ '</SYSTEMCODE>' +
                                  '<SERVICENAME>' + Trim(RNQuery.FieldByName('TCSERVICENAME').AsString)+ '</SERVICENAME>' +

                                  '<STORENAME>' + StoreName+ '</STORENAME>' +
                                  '<STORECITY>' + STORECITY+ '</STORECITY>' +
                                  '<STORESTATE>' + STORESTATE+ '</STORESTATE>' +
                                  '<STOREZIP>' + STOREZIP+ '</STOREZIP>');

             CSV.ADD('</CHECKHISTDETAIL>');

         end;



         LineAmt := RNQuery.FieldByName('TranAmount').AsFloat;
         If RNQuery.FieldByName('UpdatedAmount').AsFloat > 0 then
            LineAmt := RNQuery.FieldByName('UpdatedAmount').AsFloat;

         If DisplayFormat = 'XLS' then begin
            If (ShowVoidAsZero and RNQuery.FieldByName('Voided').AsBoolean) then begin
               LineAmt := 0;
            end;
            Row := xlsWorksheet.AddRow;

            Row.AddCellString(RNQuery.FieldByName('StoreCode').AsString);

            if DisplayStoreName then begin //2018-30-2018 bls: F#1129
               Row.AddCellString(RNQuery.FieldByName('NAME').AsString);
            end;
            
            if (DisplayInTZ) then begin
               Row.AddCellDateTime(RNQuery.FieldByname('AuthDatetz').AsDateTime).SetCalculateColWidth;
            end else begin
               Row.AddCellDateTime(RNQuery.FieldByName('AuthDate').AsDateTime).SetCalculateColWidth;
            end;

            Row.AddCellString(Format('%m',[LineAmt]));

            if DisplayECAType then begin //2018-05-11 bls: D#3790
               Row.AddCellString(RNQuery.FieldByName('TransactionType').AsString); //2018-05-11 bls: D#3790
            end;
               
            Row.AddCellString(Trim(RNQuery.FieldByName('ResponseCheckNumber').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('DisplayText').AsString)).SetCalculateColWidth;
            Row.AddCellString(Trim(RNQuery.FieldByName('ECATranStatus').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('TranIdent').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('TranCustomerCode').AsString));

            Row.AddCellString(Trim(RNQuery.FieldByName('BatchSerial').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('StationIdent').AsString)).SetCalculateColWidth;
            Row.AddCellString(Trim(RNQuery.FieldByName('TCMID').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('TCServiceName').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('Name').AsString)).SetCalculateColWidth;
            Row.AddCellString(Trim(RNQuery.FieldByName('City').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('State').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('ZIP').AsString));


            if IncludeEmpIdent then Row.AddCellString(Trim(RNQuery.FieldByName('TranEmployeeIdent').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('StoreSystemCode').AsString));
            if IncludeProfileFields then begin
               if PreviousRNID <> Trim(RNQuery.FieldByName('StoreCode').AsString) then begin
                  ProfileXML := TTProfileXML.Create(StrToInt(Trim(RNQuery.FieldByName('StoreCode').AsString)), HDQuery);
                  CustomField1Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/VALUE', '');
                  CustomField2Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/VALUE', '');
                  CustomField3Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/VALUE', '');
                  CustomField4Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/VALUE', '');
                  CustomField5Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/VALUE', '');
                  CustomField6Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/VALUE', '');
               end;
               Row.AddCellString(CustomField1Value);
               Row.AddCellString(CustomField2Value);
               Row.AddCellString(CustomField3Value);
               Row.AddCellString(CustomField4Value);
               Row.AddCellString(CustomField5Value);
               Row.AddCellString(CustomField6Value);
            end;
            if IncludeRefundData then begin
               Row.AddCellString(Trim(RNQuery.FieldByName('RefundAmount').AsString));
               Row.AddCellString(Trim(RNQuery.FieldByName('RefundDate').AsString));
            end;
            PreviousRNID := Trim(RNQuery.FieldByName('StoreCode').AsString);

         end else If DisplayFormat = 'JSON' then begin //2018-03-14 bs: D#2595
            If (ShowVoidAsZero and RNQuery.FieldByName('Voided').AsBoolean) then begin
               LineAmt := 0;
            end;

            JSON.Append('{"RNID":"' + RNQuery.FieldByName('StoreCode').AsString + '",');

            if DisplayStoreName then begin //2018-30-2018 bls: F#1129
               JSON.Append('"Store Name":"' + RNQuery.FieldByName('NAME').AsString + '",');
            end;
            if (DisplayInTZ) then begin
               JSON.Append('"Auth Date":"' + FormatDateTime('MM/DD/YYYY HH:NN:SS',RNQuery.FieldByname('AuthDatetz').AsDateTime) + '",');
            end else begin
               JSON.Append('"Auth Date":"' + FormatDateTime('MM/DD/YYYY HH:NN:SS',RNQuery.FieldByName('AuthDate').AsDateTime) + '",');
            end;

               JSON.Append('"Amount":"' + Format('%m',[LineAmt]) + '",');
               if DisplayECAType then begin //2018-05-11 bls: D#3790
                  JSON.Append('"ECA Status":"' + Trim(RNQuery.FieldByName('TransactionType').AsString) + '",'); //2018-05-11 bls: D#3790
               end;
               JSON.Append('"CHK":"' + Trim(RNQuery.FieldByName('ResponseCheckNumber').AsString) + '",');
               JSON.Append('"TCK Response":"' + Trim(RNQuery.FieldByName('DisplayText').AsString) + '",');
               JSON.Append('"Status":"' + Trim(RNQuery.FieldByName('ECATranStatus').AsString) + '",');
               JSON.Append('"' + TranIdentHeader + '":"' + Trim(RNQuery.FieldByName('TranIdent').AsString) + '",'); //2018-4-24 bls: F#3735
               JSON.Append('"' + CustIdentHeader +'":"' + Trim(RNQuery.FieldByName('TranCustomerCode').AsString) + '",'); //2018-4-24 bls: F#3735
               JSON.Append('"Batch":"' + Trim(RNQuery.FieldByName('BatchSerial').AsString) + '",');
               JSON.Append('"Station":"' + Trim(RNQuery.FieldByName('StationIdent').AsString) + '",');
               JSON.Append('"MID":"' + Trim(RNQuery.FieldByName('TCMID').AsString) + '",');
               JSON.Append('"Service":"' + Trim(RNQuery.FieldByName('TCServiceName').AsString) + '",');
               JSON.Append('"Store Name":"' + Trim(RNQuery.FieldByName('Name').AsString) + '",');
               JSON.Append('"Store City":"' + Trim(RNQuery.FieldByName('City').AsString) + '",');
               JSON.Append('"Store State":"' + Trim(RNQuery.FieldByName('State').AsString) + '",');
               JSON.Append('"Store ZIP":"' + Trim(RNQuery.FieldByName('ZIP').AsString) + '",');


            if IncludeEmpIdent then begin
               JSON.Append('"Employee Ident":"' + Trim(RNQuery.FieldByName('TranEmployeeIdent').AsString) + '",');
            end;
            JSON.Append('"Station Code":"' + Trim(RNQuery.FieldByName('StoreSystemCode').AsString) + '",');
            if IncludeProfileFields then begin
               if PreviousRNID <> Trim(RNQuery.FieldByName('StoreCode').AsString) then begin
                  ProfileXML := TTProfileXML.Create(StrToInt(Trim(RNQuery.FieldByName('StoreCode').AsString)), HDQuery);
                  CustomField1Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/VALUE', '');
                  CustomField2Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/VALUE', '');
                  CustomField3Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/VALUE', '');
                  CustomField4Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/VALUE', '');
                  CustomField5Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/VALUE', '');
                  CustomField6Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/VALUE', '');
               end;
               JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/NAME', '') + '":"' + CustomField1Value + '",');
               JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/NAME', '') + '":"' + CustomField2Value + '",');
               JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/NAME', '') + '":"' + CustomField3Value + '",');
               JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/NAME', '') + '":"' + CustomField4Value + '",');
               JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/NAME', '') + '":"' + CustomField5Value + '",');
               JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/NAME', '') + '":"' + CustomField6Value + '",');
            end;
            if IncludeRefundData then begin
               JSON.Append('"Refund Amount":"' + Trim(RNQuery.FieldByName('RefundAmount').AsString) + '",');
               JSON.Append('"Last Refund Date":"' + Trim(RNQuery.FieldByName('RefundDate').AsString) + '",');
            end;
            PreviousRNID := Trim(RNQuery.FieldByName('StoreCode').AsString);
            
            JSONString := JSON.Strings[JSON.Count - 1]; // Sets a string equal to the last string in the JSON StringList
            JSON.Delete(JSON.Count - 1); // Removes the last string in the JSON StringList
            delete(JSONString, length(JSONString), 1); // Deletes the trailing comma in the JSONString
            JSON.Append(JSONString + '},'); // Adds the JSONString to the JSON StringList with a closing curly brace and a comma (in case of more rows being created)

         end else begin
            WS := '<TR><TD>' + RNQuery.FieldByName('StoreCode').AsString + '</TD>';

            if DisplayStoreName then begin //2018-30-2018 bls: F#1129
               WS := WS + '   <TD>' + RNQuery.FieldByName('NAME').AsString + '</TD>'
            end;

            if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620
               WS := WS + '    <TD>' + FormatDateTime('MM/DD/YYYY HH:NN:SS',RNQuery.FieldByname('AuthDatetz').AsDateTime) + '</TD>';
            end else begin
               WS := WS + '    <TD>' + FormatDateTime('MM/DD/YYYY HH:NN:SS',RNQuery.FieldByName('AuthDate').AsDateTime) + '</TD>';
            end;
            WS := WS + '    <TD align="Right">';

            If RNQuery.FieldByName('UpdatedAmount').AsFloat > 0 then
               WS := WS + '<IMG SRC="/Images/General/Refresh.gif" border="0">';

            If RNQuery.FieldByName('Voided').AsBoolean then begin
               WS := WS + '<DEL>Void ' + Format('%m',[LineAmt]) + '</DEL></TD>';
               inc(VCount);
               VAmount := VAmount +  LineAmt;
            end else begin
               WS := WS + Format('%m',[LineAmt]) + '</TD>';
               If TCKEffectiveStatus(RNQuery) = 1 then begin
                  EAmount := EAmount + LineAmt;
                  Inc(ECount);
               end else If TCKEffectiveStatus(RNQuery) = 0 then begin
                  PAmount := PAmount + LineAmt;
                  Inc(PCount);
               end else If TCKEffectiveStatus(RNQuery) in [3,4] then begin
                  DAmount := DAmount + LineAmt;
                  Inc(DCount);
               end else If TCKEffectiveStatus(RNQuery) = -1 then begin
                  ErrorAmount := ErrorAmount + LineAmt;
                  Inc(ErrorCount);
               end;

            end;

            if DisplayECAType then begin //2018-05-11 bls: D#3790
               ecaStatus := '    <TD>' + RNQuery.FieldByName('TransactionType').AsString + '</TD>';
            end else begin
               ecaStatus := '';
            end;

            WS := WS + ecaStatus + //2018-05-11 bls: D#3790
                  '    <TD align="Right">' + RNQuery.FieldByName('ResponseCheckNumber').AsString + '</TD>' +
                  '    <TD>' + ColorByECAStatus(TCKEffectiveStatus(RNQuery)) + RNQuery.FieldByName('DisplayText').AsString + '</Font></TD>' +
                  '    <TD>' + RNQuery.FieldByName('ECATranStatus').AsString + '</TD>' +
                  '    <TD align="CENTER">' + TCKStatusImage(RNQuery) + '</TD>' +
                  '    <TD align="Right">' + RNQuery.FieldByName('TranIdent').AsString + '</TD>' +
                  '    <TD align="Right">' + RNQuery.FieldByName('TranCustomerCode').AsString + '</TD>' +
                  '    <TD>' + RNQuery.FieldByName('BatchSerial').AsString + '</TD>';
                  If DisplayFormat = 'AJAX' then begin
                     WS := WS+ '<TD>' + Trim(RNQuery.FieldByName('StationIdent').AsString)+'</TD>';
                  end else begin
                     WS := WS+'    <TD>' + '<A HREF="PAYMENTMATE?RNID=' +RNID +
                                          '&FROMDATE='+ FormatDateTime('MM/DD/YYYY',FromDate) +
                                          '&THRUDATE='+FormatDateTime('MM/DD/YYYY',ThruDate) +
                                          '&STATIONIDENT='+ WebParamEncode(Trim(RNQuery.FieldByName('StationIdent').AsString))+
                                          '&SERVICENAME='+ WebParamEncode(ServiceName)+
                                          '&PAGE=CHECK&ACTION=CHECKQUERY&FORMAT=' + DisplayFormat +'">' +
                                          Trim(RNQuery.FieldByName('StationIdent').AsString)+'</A></TD>';
                  end;
                  WS := WS  + '    <TD>' + RNQuery.FieldByName('TCMID').AsString + '</TD>' ;
                  If DisplayFormat = 'AJAX' then begin
                     WS := WS+ '<TD>' + Trim(RNQuery.FieldByName('TCServiceName').AsString)+'</TD>';
                     if IncludeEmpIdent then WS := WS+ '<TD>' + Trim(RNQuery.FieldByName('TranEmployeeIdent').AsString)+'</TD>';

                     If ShowLinks then begin
                        if (AllowAll) and (RNID = 'ALL') then begin
                           WS := WS +  '<TD><a href="javascript://" onclick="GetVTCheckDetailAJAX(''' + trim(RNQuery.FieldByName('StoreCode').AsString)+ ''','''+ trim(RNQuery.FieldByName('StoreSystemCode').AsString) + ''')">' + RNQuery.FieldByName('StoreSystemCode').AsString+ '</a></TD>';
                        end else begin
                           WS := WS +  '<TD><a href="javascript://" onclick="GetVTCheckDetailAJAX(''' + RNID+ ''','''+ trim(RNQuery.FieldByName('StoreSystemCode').AsString) + ''')">' + RNQuery.FieldByName('StoreSystemCode').AsString+ '</a></TD>';

                        end;
                     end else begin
                        WS := WS + '<TD>' + RNQuery.FieldByName('StoreSystemCode').AsString + '</TD>';
                     end;
                     if IncludeRefundData then   WS := WS + '<TD>' + Trim(RNQuery.FieldByName('RefundAmount').AsString)+'</TD>' +
                                                          '<TD>' + Trim(RNQuery.FieldByName('RefundDate').AsString)+'</TD>';
                  end else begin
                     WS := WS+ '<TD>' + '<A HREF="PAYMENTMATE?RNID=' +RNID +
                              '&FROMDATE='+ FormatDateTime('MM/DD/YYYY',FromDate) +
                              '&THRUDATE='+FormatDateTime('MM/DD/YYYY',ThruDate) +
                              '&STATIONIDENT='+ WebParamEncode(StationName)+
                              '&SERVICENAME='+ WebParamEncode(Trim(RNQuery.FieldByName('TCServiceName').AsString))+
                              '&PAGE=CHECK&ACTION=CHECKQUERY&FORMAT=' + DisplayFormat +'">' +
                              Trim(RNQuery.FieldByName('TCServiceName').AsString)+'</A></TD>';
                  end;
                  If DisplayFormat <> 'AJAX' then
                  WS := WS+  '    <TD Align="CENTER"><a href="PAYMENTMATE?PAGE=CHECK&ACTION=CHECKDETAILS&CHECKCODE=' + RNQuery.FieldByName('SystemCode').AsString +'">' +
                             '<IMG SRC="/Images/General/MagGlassSmall.gif" border="0"></A></TD>';
                  WS := WS+ '</TR>';
            HTML.Add(WS);
         end;
         RNQuery.Next;
      Until RNQuery.EOF;
      HTML.Add('</TABLE>');
   end else begin
      WS := '';
   end;
   
   HTML.Add('<BR><BR>' +
            '<TABLE border="1" cellspacing="0" colspan="2" cellpadding="3" bordercolorlight="#0000FF" style="border-collapse: collapse">'+
            '<TR><TD ALIGN=''CENTER''></TD>'+
            '    <TD ALIGN=''LEFT''><B>TOTALS</B></TD>'+
            '    <TD ALIGN=''RIGHT''><B>Count</B></TD>'+
            '    <TD ALIGN=''RIGHT''><B>Amount</B></TD>'+
            '    <TD ALIGN=''CENTER''><B>Description</B></TD>'+
            '</TR>'+
            '<TR><TD ALIGN=''CENTER''><B><IMG SRC="/Images/General/BoltSmall.gif" border="0"></TD><TD>Electronic Checks</TD>'+
            '    <TD align=''RIGHT''>'+ Format('%d',[ECount])+'</TD>'+
            '    <TD align=''RIGHT''>'+ Format('%m',[EAmount])+'</TD>'+
            '    <TD align=''LEFT''>Electronically offered and accepted</TD>'+
            '</TR>'+
            '<TR><TD ALIGN=''CENTER''><B><IMG SRC="/Images/General/CheckSmall.gif" border="0"></TD><TD>Paper Checks</TD>'+
            '    <TD align=''RIGHT''>'+ Format('%d',[PCount])+'</TD>'+
            '    <TD align=''RIGHT''>'+ Format('%m',[PAmount])+'</TD>'+
            '    <TD align=''LEFT''>Paper checks and Electronically offered but declined</TD>'+
            '</TR>'+
            '<TR><TD ALIGN=''CENTER''><B><IMG SRC="/Images/General/CheckSuccess.gif" border="0"></TD><TD>Approved Checks</TD>'+
            '    <TD align=''RIGHT''>'+ Format('%d',[PCount + ECount])+'</TD>'+
            '    <TD align=''RIGHT''>'+ Format('%m',[PAmount + EAmount])+'</TD>'+
            '    <TD align=''LEFT''>Total Electronic and Paper</TD>'+
            '</TR>');
   If VCount > 0 then begin
      HTML.Add('<TR><TD ALIGN=''CENTER''><B><IMG SRC="/Images/General/YellowExclamation.gif" border="0"></TD><TD>Voided Checks</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%d',[VCount])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[VAmount])+'</TD>'+
               '    <TD align=''LEFT''>Electronically offered but Voided</TD>'+
               '</TR>');
   end;
   If DCount > 0 then begin
      HTML.Add('<TR><TD ALIGN=''CENTER''><B><IMG SRC="/Images/General/XFailed.gif" border="0"></TD><TD>Declined Checks</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%d',[DCount])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[DAmount])+'</TD>'+
               '    <TD align=''LEFT''>Hard Decline (Code 4) and Risk Decline (Code 3)</TD>'+
               '</TR>');
   end;
   If ErrorCount > 0 then begin
      HTML.Add('<TR><TD ALIGN=''CENTER''><B><IMG SRC="/Images/General/ExclamationSmall.gif" border="0"></TD><TD>Transaction Issues</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%d',[ErrorCount])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[ErrorAmount])+'</TD>'+
               '    <TD align=''LEFT''>Invalid or Incomplete MICR, Invalid License, or low image quality</TD>'+
               '</TR>');
   end;
   HTML.Add('<TR><TD ALIGN=''CENTER''></TD><TD>Transaction Count</TD>'+
            '    <TD align=''RIGHT''>'+ Format('%d',[ErrorCount + DCount + VCount + PCount + ECount])+'</TD>'+
            '    <TD></TD>'+
            '    <TD align=''LEFT''>All Transactions</TD>'+
            '</TR>');
   HTML.Add('</TABLE><BR>');

   If DisplayFormat = 'XML' then begin
      Result := CSV.Text;
      Response.CustomHeaders.Values['Cache-Control'] := 'private';
      Response.CustomHeaders.Values['Pragma'] := 'private';
   end else If DisplayFormat = 'XLS' then begin
      Result := '';
      Response.CustomHeaders.Values['Cache-Control'] := 'private';
      Response.CustomHeaders.Values['Pragma'] := 'private';
   end else If DisplayFormat = 'JSON' then begin
      JSONString := stringreplace(JSON.Text, #13,'',[rfReplaceAll]); // Sets JSONString equal to all of the text in the JSON String list; Replaces all Carriage Return characters with nothing
      JSONString := stringreplace(JSONString, #10,'',[rfReplaceAll]); // Replaces all Line Feed characters with nothing
      delete(JSONString, length(JSONString), 1); // Deletes the trailing comma in the JSONString
      Result := JSONString + ']'; // Sends the complete JSONString back with a closing square bracket  
   end else
      Result := HTML.Text;

   HTML.Free;
   CSV.Free;
   CSVLine.Free;
   JSON.Free;
end;
*)

function TCustomerInfoModule.GetCheckQueryTable(RNID: String; FromDate,
               ThruDate: TDateTime; BatchSerial: Integer; StationName, ServiceName,
               DisplayFormat: String;
               ShowLinks: boolean;
               ARequest: TWebRequest;
               xExport: TOExport;
               isPaymentMate : Boolean;
               AAllowAll,
               AExtraBreaksBetweenStoreCodes: Boolean): String;
var
   WS : String;
   I : Integer;
   StoreInfo : String;
   CSV : TStringList;
   HTML : TStringList;
   JSON : TStringList; //2018-03-14 bs: D#2595
   GRID : TStringList; //2018-06-14 bls: F#840

   LineAmt : single;

   EAmount : Currency;
   ECount  : Integer;
   PAmount : Currency;
   PCount  : Integer;
   VAmount : Currency;
   VCount  : Integer;
   DAmount : Currency;
   DCount  : Integer;
   ErrorAmount : Currency;
   ErrorCount  : Integer;
   CHType : String;
   RNIDList : TStringList;
   IncludeEmpIdent : boolean; //2016-06-13 jtm
   IncludeProfileFields : boolean;  //2016-7-28 jtm
   PreviousRNID : variant;
   CustomField1Value, CustomField2Value, CustomField3Value, CustomField4Value, CustomField5Value, CustomField6Value : String;
   StoreSystemCodeLabel : string;
   IncludeRefundData : boolean; //2017-08-16 jtm: F#1833    //2018-06-14 bls: F#1807
   ShowVoidAsZero : boolean;  //2018-06-14 bls: F#1807
   RecordFormatType: TRecordFormatType;
   RNIDRecCount: Integer;
   UsingAll: Boolean;
   DisplayInTZ : boolean;
   DisplayInAMPM : boolean;
   IncludeBatchDate : boolean;
   xlsWorkSheet : TExportWorksheet; //Represents actual xls worksheet
   Row : TExportRow; //Represents actual row inside the TExportWorksheet
   JSONString : string;  //2018-06-14 bls: F#1807

   DateRange : string;
   TabText : TTTStringList; //2018-05-10 bls: D#2595

   TranIdentHeader : string; //2018-4-24 bls: F#3735   //2018-06-14 bls: F#1807
   CustIdentHeader : string; //2018-4-24 bls: F#3735   //2018-06-14 bls: F#1807

   DisplayStoreName : boolean; //2018-04-30 bls: F#1129  //2018-06-14 bls: F#1807
   storeName : string; //2018-06-14 bls: F#1807
   DisplayECAStatus : boolean;
   ecaStatus : string;

   ParameterList, QueryBuilder : TStringList; //2018-06-20 bls: F#840
   posStart, count, totalCount, orderBy, direction : string; //2018-06-20 bls: F#840
   useJSONResp : boolean; //2018-07-18 bls: F#4978

   procedure GetProfileInfo(AStoreCode : String);
   begin
      if (assigned(ProfileXML)) then begin
         FreeAndNil(ProfileXML);
      end;
      if AStoreCode <> '' then begin
         ProfileXML := TTProfileXML.Create(StrToInt(AStoreCode), HDQuery);
         CustomField1Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/VALUE', '');
         CustomField2Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/VALUE', '');
         CustomField3Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/VALUE', '');
         CustomField4Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/VALUE', '');
         CustomField5Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/VALUE', '');
         CustomField6Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/VALUE', '');
      end else begin
         CustomField1Value := '';
         CustomField2Value := '';
         CustomField3Value := '';
         CustomField4Value := '';
         CustomField5Value := '';
         CustomField6Value := '';
      end;
      if (assigned(RNProfileDI)) then begin
         FreeAndNil(RNProfileDI);
      end;
      if (assigned(RNProfile)) then begin
         FreeAndNil(RNProfile);
      end;
      RNProfileDI := TTADODataLayer.Create(RNDB);
      RNProfile := TTProfile.Create(AStoreCode,false, RNProfileDI);
   end;
   procedure ProcessHeader(AStoreCode: String; ADetailRecsExists: Boolean);
   var
      i : integer;
   begin
      RNIDRecCount := 0;
      EAmount := 0;
      ECount  := 0;
      PAmount := 0;
      PCount  := 0;
      VAmount := 0;
      VCount  := 0;
      DAmount := 0;
      DCount  := 0;
      ErrorAmount := 0;
      ErrorCount  := 0;
      CustomField1Value := '';
      CustomField2Value := '';
      CustomField3Value := '';
      CustomField4Value := '';
      CustomField5Value := '';
      CustomField6Value := '';

      if AStoreCode <> '' then begin
         StoreInfo := GetStoreInfo(Valu(AStoreCode));
      end else if UsingAll then begin
         StoreInfo := '';
      end else begin
         StoreInfo := GetStoreInfo(Valu(RNID));
      end;

      if (RecordFormatType in [ttrftHTML, ttrftAJAX]) then begin
         if (ADetailRecsExists AND isPaymentMate) Or (NOT isPaymentMate) then begin
            HTML.Add('Checks from ' + FormatDateTime('MM/DD/YYYY', Fromdate) + ' Thru ' + FormatDateTime('MM/DD/YYYY', Thrudate) + ' <BR><B>' +
               Trim(RNID) + '<BR>' + StoreInfo + '</B><BR>');

            if DisplayStoreName then begin //2018-30-04 bls: F#1129
               storeName := '  <TD><B>Store Name</B></TD>';
            end else begin
               storeName := '';
            end;

            if DisplayECAStatus then begin
               ecaStatus := '    <TD><B>ECA Status</B></TD>';
            end else begin
               ecaStatus := '';
            end;

            HTML.Append('<TABLE border="1" cellspacing="0" cellpadding="3"  style="border-collapse: collapse; font-size:7pt;font-family:veranda">' +
                       '<TR><TD><B>RNID</B></TD>' +
                       storeName +
                       '    <TD><B>Auth Date</B></TD>' +
                       '    <TD Align="Right"><B>Amount</B></TD>' +
                       ecaStatus +
                       '    <TD><B>CHK #</B></TD>' +
                       '    <TD><B>TCK Response</B></TD>' +
                       '    <TD Colspan=2 align="Center"><B>Status</B></TD>' +
                       '    <TD><B>' + TranIdentHeader + '</B></TD>' +
                       '    <TD><B>' + CustIdentHeader + '</B></TD>');
            if (IncludeBatchDate) then begin
               HTML.Append('    <TD><B>Batch Date</B></TD>');
            end;
            HTML.Append('    <TD><B>Batch</B></TD>' +
                       '    <TD><B>Station</B></TD>' +
                       '    <TD><B>MID</B></TD>' +
                       '    <TD><B>Service</B></TD>');

            If (RecordFormatType <> ttrftAJAX) then
               HTML.Append('    <TD><B></B></TD>');
            if IncludeEmpIdent then HTML.Append('    <TD><B>EmpIdent</B></TD>');

            if NOT isPaymentMate then begin
               if StoreSystemCodeLabel <> '' then
                  HTML.Append('  <TD><B>'+ StoreSystemCodeLabel +'</B></TD>')
               else
                  HTML.Append('  <TD><B>Item Serial</B></TD>');
            end;      

            if IncludeRefundData then HTML.Add('    <TD><B>Refund Amount</B></TD>' +
                                               '    <TD><B>Last Refund Date</B></TD>');

            HTML.Add('</TR>');
         end;
      end;
      If (RecordFormatType = ttrftXLS) and (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEREPORTHEADERS', 'FALSE') = 'TRUE') then begin   //2016-06-13 jtm

         if IncludeProfileFields then begin //2018-07-25 bls: D#5156
            ProcessLog(ltDebug,'ProcessHeaders StoreCode', AStoreCode);
            if (AStoreCode = '') then AStoreCode := Trim(RNQuery.FieldByName('StoreCode').AsString);//if we don't have a store code, then we might be searching using all, so let's just use the first RNID
            ProcessLog(ltDebug,'ProcessHeaders StoreCode after', AStoreCode);
            if ProfileXML = nil then GetProfileInfo(AStoreCode);
         end;

         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEOLDXLSFORMAT', 'FALSE') = 'TRUE') OR
         (RNReg.RegGetValAsString('PMACCESS.USEOLDXLSFORMAT','FALSE') = 'TRUE') then begin //2018-05-10 bls: D#2595
            if (ADetailRecsExists) then begin
               TabText.Clear();

               TabText.Append('RNID');

               if DisplayStoreName then begin
                  TabText.Append('Store Name');
               end;

               TabText.Append('Auth Date');
               TabText.Append('Amount');

               if DisplayECAStatus then begin
                  TabText.Append('ECA Status');
               end;

               TabText.Append('CHK #');
               TabText.Append('TCK Response');
               TabText.Append('Status');
               TabText.Append(TranIdentHeader);
               TabText.Append(CustIdentHeader);
               if (IncludeBatchDate) then begin
                  TabText.Append('Batch Date')
               end;
               TabText.Append('Batch');
               TabText.Append('Station');
               TabText.Append('MID');
               TabText.Append('Service');
               TabText.Append('Store Name');
               TabText.Append('Store City');
               TabText.Append('Store State');
               TabText.Append('Store ZIP');

               if IncludeEmpIdent then TabText.Append('Employee Ident');
               if StoreSystemCodeLabel <> '' then begin
                  TabText.Append(StoreSystemCodeLabel);
               end else begin
                  TabText.Append('Station Code');
               end;
               TabText.Append('Voided Date');        //2016-10-05

               if IncludeProfileFields then begin
                  TabText.Append(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/NAME', ''));
                  TabText.Append(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/NAME', ''));
                  TabText.Append(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/NAME', ''));
                  TabText.Append(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/NAME', ''));
                  TabText.Append(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/NAME', ''));
                  TabText.Append(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/NAME', ''));
               end;

               if IncludeRefundData then begin
                  TabText.Append('Refund Amount');
                  TabText.Append('Last Refund Date');
               end;

               CSV.Append(TabText.DelimitedText);
               TabText.Clear();
            end;
         end else begin
            Row := xlsWorkSheet.AddRow;
            if (ADetailRecsExists) then begin
               Row.AddCellString('RNID');

               if DisplayStoreName then begin
                  Row.AddCellString('Store Name');
               end;
               
               Row.AddCellString('Auth Date');
               Row.AddCellString('Amount');

               if DisplayECAStatus then begin
                  Row.AddCellString('ECA Status');
               end;

               Row.AddCellString('CHK #');
               Row.AddCellString('TCK Response');
               Row.AddCellString('Status');
               Row.AddCellString(TranIdentHeader);
               Row.AddCellString(CustIdentHeader);
               if (IncludeBatchDate) then begin
                  Row.AddCellString('Batch Date');
               end;
               Row.AddCellString('Batch');
               Row.AddCellString('Station');
               Row.AddCellString('MID');
               Row.AddCellString('Service');
               Row.AddCellString('Store Name');
               Row.AddCellString('Store City');
               Row.AddCellString('Store State');
               Row.AddCellString('Store ZIP');

               if IncludeEmpIdent then Row.AddCellString('Employee Ident');
               if StoreSystemCodeLabel <> '' then begin
                  Row.AddCellString(StoreSystemCodeLabel);
               end else begin
                  Row.AddCellString('Station Code');
               end;
               Row.AddCellString('Voided Date');

               if IncludeProfileFields then begin
                  Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/NAME', ''));
                  Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/NAME', ''));
                  Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/NAME', ''));
                  Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/NAME', ''));
                  Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/NAME', ''));
                  Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/NAME', ''));
               end;

               if IncludeRefundData then begin
                  Row.AddCellString('Refund Amount');
                  Row.AddCellString('Last Refund Date');
               end;

               For i := 0 to Row.Cells.Count - 1 do
               begin
                  Row.Cells.Items[i].SetFontColor(clBlack).SetBorder(cbBottom).SetBGColor(TColor($80000000)).SetAlignment(cahCenter);
               end;

            end;
         end;
      end;
   end;
   procedure ProcessFooter;
   begin
      processlog(ltInfo, 'GetCheckQueryTable2 ProcessFooter', String(PreviousRNID) + ' RecordCount=' + StrI(RNIDRecCount, -1));

      if (RecordFormatType in [ttrftHTML, ttrftAJAX]) then begin
         HTML.Append('</TABLE>');
         HTML.Append('<BR><BR>' +
                  '<TABLE border="1" cellspacing="0" colspan="2" cellpadding="3" bordercolorlight="#0000FF" style="border-collapse: collapse">' +
                  '<TR><TD ALIGN=''CENTER''></TD>' +
                  '    <TD ALIGN=''LEFT''><B>TOTALS</B></TD>' +
                  '    <TD ALIGN=''RIGHT''><B>Count</B></TD>' +
                  '    <TD ALIGN=''RIGHT''><B>Amount</B></TD>' +
                  '    <TD ALIGN=''CENTER''><B>Description</B></TD>' +
                  '</TR>'+
                  '<TR><TD ALIGN=''CENTER''><B><IMG SRC="/Images/General/BoltSmall.gif" border="0"></TD><TD>Electronic Checks</TD>' +
                  '    <TD align=''RIGHT''>' + Format('%d',[ECount]) + '</TD>' +
                  '    <TD align=''RIGHT''>' + Format('%m',[EAmount]) + '</TD>' +
                  '    <TD align=''LEFT''>Electronically offered and accepted</TD>' +
                  '</TR>'+
                  '<TR><TD ALIGN=''CENTER''><B><IMG SRC="/Images/General/CheckSmall.gif" border="0"></TD><TD>Paper Checks</TD>' +
                  '    <TD align=''RIGHT''>' + Format('%d',[PCount]) + '</TD>' +
                  '    <TD align=''RIGHT''>' + Format('%m',[PAmount]) + '</TD>' +
                  '    <TD align=''LEFT''>Paper checks and Electronically offered but declined</TD>'+
                  '</TR>'+
                  '<TR><TD ALIGN=''CENTER''><B><IMG SRC="/Images/General/CheckSuccess.gif" border="0"></TD><TD>Approved Checks</TD>' +
                  '    <TD align=''RIGHT''>' + Format('%d',[PCount + ECount]) + '</TD>' +
                  '    <TD align=''RIGHT''>' + Format('%m',[PAmount + EAmount]) + '</TD>' +
                  '    <TD align=''LEFT''>Total Electronic and Paper</TD>' +
                  '</TR>');
         If VCount > 0 then begin
            HTML.Append('<TR><TD ALIGN=''CENTER''><B><IMG SRC="/Images/General/YellowExclamation.gif" border="0"></TD><TD>Voided Checks</TD>'+
                     '    <TD align=''RIGHT''>' + Format('%d',[VCount]) + '</TD>' +
                     '    <TD align=''RIGHT''>' + Format('%m',[VAmount]) + '</TD>' +
                     '    <TD align=''LEFT''>Electronically offered but Voided</TD>' +
                     '</TR>');
         end;
         If DCount > 0 then begin
            HTML.Append('<TR><TD ALIGN=''CENTER''><B><IMG SRC="/Images/General/XFailed.gif" border="0"></TD><TD>Declined Checks</TD>'+
                     '    <TD align=''RIGHT''>' + Format('%d',[DCount]) + '</TD>' +
                     '    <TD align=''RIGHT''>' + Format('%m',[DAmount]) + '</TD>' +
                     '    <TD align=''LEFT''>Hard Decline (Code 4) and Risk Decline (Code 3)</TD>' +
                     '</TR>');
         end;
         If ErrorCount > 0 then begin
            HTML.Append('<TR><TD ALIGN=''CENTER''><B><IMG SRC="/Images/General/ExclamationSmall.gif" border="0"></TD><TD>Transaction Issues</TD>' +
                     '    <TD align=''RIGHT''>' + Format('%d',[ErrorCount]) + '</TD>' +
                     '    <TD align=''RIGHT''>' + Format('%m',[ErrorAmount]) + '</TD>' +
                     '    <TD align=''LEFT''>Invalid or Incomplete MICR, Invalid License, or low image quality</TD>' +
                     '</TR>');
         end;
         HTML.Append('<TR><TD ALIGN=''CENTER''></TD><TD>Transaction Count</TD>'+
                  '    <TD align=''RIGHT''>' + Format('%d',[ErrorCount + DCount + VCount + PCount + ECount]) + '</TD>' +
                  '    <TD></TD>' +
                  '    <TD align=''LEFT''>All Transactions</TD>' +
                  '</TR>');
         HTML.Append('</TABLE><BR>');
         if (AExtraBreaksBetweenStoreCodes) then begin
            HTML.Add('<BR><BR>');
         end;
      end;
   end;
   procedure FormatXML;
   begin
      CSV.Append('<CHECKHISTDETAIL>' +
                '<RNID>' + Trim(RNQuery.FieldByName('StoreCode').AsString) + '</RNID>');
      if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620
         CSV.Append('<AUTHDATE>' + FormatDateTime('MM/DD/YYYY HH:NN:SS',RNQuery.FieldByname('AuthDatetz').AsDateTime) + '</AUTHDATE>');
      end else begin
         CSV.Append('<AUTHDATE>' + FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('AuthDate').AsDateTime) + '</AUTHDATE>');
      end;
      CSV.Append('<DISPLAYTEXT>' + Trim(RNQuery.FieldByName('DISPLAYTEXT').AsString) + '</DISPLAYTEXT>');
      CSV.Append('<TRANAMT>' + Trim(StriReal(RNQuery.FieldByName('TranAmount').AsFloat,2)) + '</TRANAMT>');
      CSV.Append('<UPDATEDAMT>' + Trim(StriReal(RNQuery.FieldByName('UpdatedAmount').AsFloat,2)) + '</UPDATEDAMT>');
      CSV.Append('<RETURNCHECKFEE>' + Trim(StriReal(RNQuery.FieldByName('RETURNCHECKFEE').AsFloat,2)) + '</RETURNCHECKFEE>');

      If RNQuery.FieldByName('Voided').AsBoolean then
         CSV.Append('<VOIDEDDATE>' + FormatDateTime('MM/DD/YYYY', RNQuery.FieldByName('VOIDEDDATE').AsDateTime) + '</VOIDEDDATE>');

      CSV.Append('<CHECKTYPE>' + Trim(RNQuery.FieldByName('CHECKTYPE').AsString)+ '</CHECKTYPE>' +
                         '<AUTHCODE>' + Trim(RNQuery.FieldByName('APPROVALCODE').AsString) + '</AUTHCODE>' +
                         '<ROUTINGNUMBER>' + Trim(RNQuery.FieldByName('ResponseTransitNumber').AsString) + '</ROUTINGNUMBER>' +
                         '<CHECKNUMBER>' + Trim(RNQuery.FieldByName('ResponseCheckNumber').AsString) + '</CHECKNUMBER>' +
                         '<TRACEID>' + Trim(RNQuery.FieldByName('TRACEID').AsString)+ '</TRACEID>' +
                         '<DENIALRECORDNUMBER>' + Trim(RNQuery.FieldByName('DENIALRECORDNUMBER').AsString)+ '</DENIALRECORDNUMBER>' +
                         '<CUSTIDENT>' + Trim(RNQuery.FieldByName('TranCustomerCode').AsString)+ '</CUSTIDENT>' +
                         '<STATIONIDENT>' + Trim(RNQuery.FieldByName('STATIONIDENT').AsString)+ '</STATIONIDENT>' +
                         '<TRANIDENT>' + Trim(RNQuery.FieldByName('TRANIDENT').AsString)+ '</TRANIDENT>' +
                         '<TCMID>' + Trim(RNQuery.FieldByName('TCMID').AsString)+ '</TCMID>' +
                         '<SYSTEMCODE>' + Trim(RNQuery.FieldByName('StoreSystemCode').AsString) + '</SYSTEMCODE>' +
                         '<SERVICENAME>' + Trim(RNQuery.FieldByName('TCSERVICENAME').AsString) + '</SERVICENAME>' +

                         '<STORENAME>' + StoreName + '</STORENAME>' +
                         '<STORECITY>' + STORECITY + '</STORECITY>' +
                         '<STORESTATE>' + STORESTATE + '</STORESTATE>' +
                         '<STOREZIP>' + STOREZIP + '</STOREZIP>');

    CSV.Append('</CHECKHISTDETAIL>');

   end;
   procedure FormatXLS;
   begin
      If RNQuery.FieldByName('Voided').AsBoolean then begin
         LineAmt := 0;
      end;

      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEOLDXLSFORMAT', 'FALSE') = 'TRUE') OR
      (RNReg.RegGetValAsString('PMACCESS.USEOLDXLSFORMAT','FALSE') = 'TRUE') then begin //2018-05-10 bls: D#2595
         TabText.Clear();
         
         TabText.Append(RNQuery.FieldByName('StoreCode').AsString);

         if DisplayStoreName then begin //2018-04-30 bls: F#1129
            TabText.Append(RNQuery.FieldByName('NAME').AsString);
         end;

         if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620
            if DisplayInAMPM then begin
               TabText.Append(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByName('AuthDatetz').AsDateTime));
            end else begin
               TabText.Append(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('AuthDatetz').AsDateTime));
            end;
         end else begin
            TabText.Append(FormatDateTime('MM/DD/YYYY HH:NN:SS' ,RNQuery.FieldByName('AuthDate').AsDateTime));
         end;

         TabText.Append(Format('%m',[LineAmt]));

         if DisplayECAStatus then begin  //2018-05-11 bls: D#3790
            TabText.Append(RNQuery.FieldByName('TransactionType').AsString);
         end;

         TabText.Append(Trim(RNQuery.FieldByName('ResponseCheckNumber').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('DisplayText').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('ECATranStatus').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('TranIdent').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('TranCustomerCode').AsString));

         if (IncludeBatchDate) then begin
            if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620
               if DisplayInAMPM then begin
                  TabText.Append(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByName('BatchDatetz').AsDateTime));
               end else begin
                  TabText.Append(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('BatchDatetz').AsDateTime));
               end;
            end else begin
               TabText.Append(FormatDateTime('MM/DD/YYYY HH:NN:SS' ,RNQuery.FieldByName('BatchDate').AsDateTime));
            end;
         end;

         TabText.Append(Trim(RNQuery.FieldByName('BatchSerial').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('StationIdent').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('TCMID').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('TCServiceName').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('Name').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('City').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('State').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('ZIP').AsString));

         if IncludeEmpIdent then TabText.Append(Trim(RNQuery.FieldByName('TranEmployeeIdent').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('StoreSystemCode').AsString));

         if (RNQuery.FieldByName('Voided').AsBoolean) then begin
            TabText.Append(RNQuery.FieldByName('VoidedDate').AsString);
         end else begin
            TabText.Append('');
         end;

         if IncludeProfileFields then begin
            TabText.Append(CustomField1Value);
            TabText.Append(CustomField2Value);
            TabText.Append(CustomField3Value);
            TabText.Append(CustomField4Value);
            TabText.Append(CustomField5Value);
            TabText.Append(CustomField6Value);
         end;

         if IncludeRefundData then begin
            TabText.Append(Trim(RNQuery.FieldByName('RefundAmount').AsString));
            TabText.Append(Trim(RNQuery.FieldByName('RefundDate').AsString));
         end;
         
         CSV.Append(TabText.DelimitedText);
         TabText.Clear();
      end else begin
         Row := xlsWorkSheet.AddRow;

         Row.AddCellString(RNQuery.FieldByName('StoreCode').AsString);

         if DisplayStoreName then begin //2018-04-30 bls: F#1129
            Row.AddCellString(RNQuery.FieldByName('NAME').AsString);
         end;

         if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620
            if DisplayInAMPM then begin
               Row.AddCellString(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByName('AuthDatetz').AsDateTime));
            end else begin
               Row.AddCellString(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('AuthDatetz').AsDateTime));
            end;
         end else begin
            Row.AddCellString(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('AuthDate').AsDateTime));
         end;
         
         Row.AddCellString(Format('%m',[LineAmt]));

         if DisplayECAStatus then begin
            Row.AddCellString(RNQuery.FieldByName('TransactionType').AsString);
         end;
            
         Row.AddCellString(Trim(RNQuery.FieldByName('ResponseCheckNumber').AsString));
         Row.AddCellString(Trim(RNQuery.FieldByName('DisplayText').AsString));
         Row.AddCellString(Trim(RNQuery.FieldByName('ECATranStatus').AsString));
         Row.AddCellString(Trim(RNQuery.FieldByName('TranIdent').AsString));
         Row.AddCellString(Trim(RNQuery.FieldByName('TranCustomerCode').AsString));

         if (IncludeBatchDate) then begin
            if (DisplayInTZ) then begin
               if DisplayInAMPM then begin
                  Row.AddCellString(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByName('BatchDatetz').AsDateTime));
               end else begin
                  Row.AddCellString(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('BatchDatetz').AsDateTime));
               end;
            end else begin
               Row.AddCellString(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('BatchDate').AsDateTime));
            end;
         end;

         Row.AddCellString(Trim(RNQuery.FieldByName('BatchSerial').AsString));
         Row.AddCellString(Trim(RNQuery.FieldByName('StationIdent').AsString));
         Row.AddCellString(Trim(RNQuery.FieldByName('TCMID').AsString));
         Row.AddCellString(Trim(RNQuery.FieldByName('TCServiceName').AsString));
         Row.AddCellString(Trim(RNQuery.FieldByName('Name').AsString));
         Row.AddCellString(Trim(RNQuery.FieldByName('City').AsString));
         Row.AddCellString(Trim(RNQuery.FieldByName('State').AsString));
         Row.AddCellString(Trim(RNQuery.FieldByName('ZIP').AsString));

         if IncludeEmpIdent then Row.AddCellString(Trim(RNQuery.FieldByName('TranEmployeeIdent').AsString));
         Row.AddCellString(Trim(RNQuery.FieldByName('StoreSystemCode').AsString));

         if (RNQuery.FieldByName('Voided').AsBoolean) then begin
            Row.AddCellString(RNQuery.FieldByName('VoidedDate').AsString);
         end else begin
            Row.AddCellString('');
         end;

         if IncludeProfileFields then begin
            Row.AddCellString(CustomField1Value);
            Row.AddCellString(CustomField2Value);
            Row.AddCellString(CustomField3Value);
            Row.AddCellString(CustomField4Value);
            Row.AddCellString(CustomField5Value);
            Row.AddCellString(CustomField6Value);
         end;

         if IncludeRefundData then begin
            Row.AddCellString(Trim(RNQuery.FieldByName('RefundAmount').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('RefundDate').AsString));
         end;
      end;
   end;

   procedure FormatJSON;
   begin
      JSON.Append('{"RNID":"' + RNQuery.FieldByName('StoreCode').AsString + '",');

      if DisplayStoreName then begin
         JSON.Append('"Store Name":"' + RNQuery.FieldByName('NAME').AsString + '",');
      end;

      if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620
         if DisplayInAMPM then begin
            JSON.Append('"Auth Date":"' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByName('AuthDatetz').AsDateTime) + '",');
         end else begin
            JSON.Append('"Auth Date":"' + FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('AuthDatetz').AsDateTime) + '",');
         end;
      end else begin
         JSON.Append('"Auth Date":"' + FormatDateTime('MM/DD/YYYY HH:NN:SS',RNQuery.FieldByName('AuthDate').AsDateTime) + '",');
      end;

      JSON.Append('"Amount":"' + Format('%m',[LineAmt]) + '",');

      if DisplayECAStatus then begin
         JSON.Append('"ECA Status":"' + RNQuery.FieldByName('TransactionType').AsString + '",');
      end;

      JSON.Append('"CHK":"' + Trim(RNQuery.FieldByName('ResponseCheckNumber').AsString) + '",');
      JSON.Append('"TCK Response":"' + Trim(RNQuery.FieldByName('DisplayText').AsString) + '",');
      JSON.Append('"Status":"' + Trim(RNQuery.FieldByName('ECATranStatus').AsString) + '",');
      JSON.Append('"' + TranIdentHeader + '":"' + Trim(RNQuery.FieldByName('TranIdent').AsString) + '",');
      JSON.Append('"' + CustIdentHeader + '":"' + Trim(RNQuery.FieldByName('TranCustomerCode').AsString) + '",');
      if (IncludeBatchDate) then begin
         if (DisplayInTZ) then begin
            if DisplayInAMPM then begin
               JSON.Append('"Batch Date":"' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByName('BatchDatetz').AsDateTime) + '",');
            end else begin
               JSON.Append('"Batch Date":"' + FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('BatchDatetz').AsDateTime) + '",');
            end;
         end else begin
            JSON.Append('"Batch Date":"' + FormatDateTime('MM/DD/YYYY HH:NN:SS',RNQuery.FieldByName('BatchDate').AsDateTime) + '",');
         end;
      end;
      JSON.Append('"Batch":"' + Trim(RNQuery.FieldByName('BatchSerial').AsString) + '",');
      JSON.Append('"Station":"' + Trim(RNQuery.FieldByName('StationIdent').AsString) + '",');
      JSON.Append('"MID":"' + Trim(RNQuery.FieldByName('TCMID').AsString) + '",');
      JSON.Append('"Service":"' + Trim(RNQuery.FieldByName('TCServiceName').AsString) + '",');
      JSON.Append('"Store Name":"' + Trim(RNQuery.FieldByName('Name').AsString) + '",');
      JSON.Append('"Store City":"' + Trim(RNQuery.FieldByName('City').AsString) + '",');
      JSON.Append('"Store State":"' + Trim(RNQuery.FieldByName('State').AsString) + '",');
      JSON.Append('"Store ZIP":"' + Trim(RNQuery.FieldByName('ZIP').AsString) + '",');

      if IncludeEmpIdent then JSON.Append('"Employee Ident":"' + Trim(RNQuery.FieldByName('TranEmployeeIdent').AsString) + '",');

      if (RNQuery.FieldByName('Voided').AsBoolean) then begin
         JSON.Append('"Voided Date":"' + RNQuery.FieldByName('VoidedDate').AsString + '",');
      end else begin
         JSON.Append('"Voided Date":"",');
      end;

      if IncludeProfileFields then begin
         JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/NAME', '') + '":"' + CustomField1Value + '",');
         JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/NAME', '') + '":"' + CustomField2Value + '",');
         JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/NAME', '') + '":"' + CustomField3Value + '",');
         JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/NAME', '') + '":"' + CustomField4Value + '",');
         JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/NAME', '') + '":"' + CustomField5Value + '",');
         JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/NAME', '') + '":"' + CustomField6Value + '",');
      end;

      if IncludeRefundData then begin
         JSON.Append('"Refund Amount":"' +  Trim(RNQuery.FieldByName('RefundAmount').AsString) + '",');
         JSON.Append('"Last Refund Date":"' + Trim(RNQuery.FieldByName('RefundDate').AsString) + '",');
      end;
      JSON.Append('"Station Code":"' + Trim(RNQuery.FieldByName('StoreSystemCode').AsString) + '"}');
   end;

   procedure FormatGridJSON; //2018-07-18 bls: F#4978
   var
      storeCodeL, storeSysCodeL : string;
   begin
      storeCodeL := Trim(RNQuery.FieldByName('StoreCode').AsString);
      storeSysCodeL := trim(RNQuery.FieldByName('StoreSystemCode').AsString);

      GRID.Add('{"id":' + RNQuery.FieldByName('row').AsString + ',"data":[');
      GRID.Add('"' + storeCodeL + '",');

      if DisplayStoreName then begin //2018-30-2018 bls: F#1129
         GRID.Add('"' + Trim(RNQuery.FieldByName('NAME').AsString) + '",');
      end;

      if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620
         if DisplayInAMPM then begin
            GRID.Add('"' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByname('AuthDatetz').AsDateTime)) +  '",');
         end else begin
            GRID.Add('"' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('AuthDatetz').AsDateTime)) +  '",');
         end;
      end else begin
         GRID.Add('"' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('AuthDate').AsDateTime)) +  '",');
      end;

      GRID.Add('"');

      If RNQuery.FieldByName('UpdatedAmount').AsFloat > 0 then
         GRID.Add('<IMG SRC=\"\/Images\/General\/Refresh.gif\" border=\"0\" style=\"display: inline-block\" \/>');

      If RNQuery.FieldByName('Voided').AsBoolean then begin
         GRID.Add('<DEL>Void ' + Format('%m',[LineAmt]) + '<\/DEL>",');
      end else begin
         GRID.Add(Format('%m', [LineAmt]) + '",');
      end;

      if DisplayECAStatus then begin
         GRID.Add('"' + Trim(RNQuery.FieldByName('TransactionType').AsString) + '",');
      end;

      GRID.Add('"' + trim(RNQuery.FieldByName('ResponseCheckNumber').AsString) + '",');
      GRID.Add('"' + ColorByECAStatusJSON(TCKEffectiveStatus(RNQuery)) + Trim(RNQuery.FieldByName('DisplayText').AsString) + '</Font>",');
      GRID.Add('"' + Trim(RNQuery.FieldByName('ECATranStatus').AsString) + ' ');
      GRID.Add(TCKStatusImageJSON(RNQuery) + '",');
      GRID.Add('"' + trim(RNQuery.FieldByName('TranIdent').AsString) + '",');
      GRID.Add('"' + trim(RNQuery.FieldByName('TranCustomerCode').AsString) + '",');
      if (IncludeBatchDate) then begin
         if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620
            if DisplayInAMPM then begin
               GRID.Add('"' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByname('BatchDatetz').AsDateTime)) +  '",');
            end else begin
               GRID.Add('"' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('BatchDatetz').AsDateTime)) +  '",');
            end;
         end else begin
            GRID.Add('"' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('BatchDate').AsDateTime)) +  '",');
         end;
      end;
      GRID.Add('"' + Trim(RNQuery.FieldByName('BatchSerial').AsString) + '",');

      GRID.Add('"' + Trim(RNQuery.FieldByName('StationIdent').AsString)+ '",');

      GRID.Add('"' + Trim(RNQuery.FieldByName('TCMID').AsString) + '",');

      GRID.Add('"' + Trim(RNQuery.FieldByName('TCServiceName').AsString) + '",');
      if IncludeEmpIdent then GRID.Add('"' + Trim(RNQuery.FieldByName('TranEmployeeIdent').AsString) + '",');

      if IncludeRefundData then begin
         GRID.Add('"' + Trim(RNQuery.FieldByName('RefundAmount').AsString) + '",');
         GRID.Add('"' + Trim(RNQuery.FieldByName('RefundDate').AsString) + '",');
      end;

      If ShowLinks then begin
         if (AAllowAll) and (RNID = 'ALL') then begin
            GRID.Add('"<a href=\"javascript:\/\/\" onclick=\"GetVTCheckDetailAJAX(''' +
                        storeCodeL + ''',''' + storeSysCodeL + ''')\">' +
                        storeSysCodeL + '<\/a>"]}');
         end else begin
            GRID.Add('"<a href=\"javascript:\/\/\" onclick=\"GetVTCheckDetailAJAX(''' + RNID + ''',''' +
                        storeSysCodeL + ''')\">' + storeSysCodeL + '<\/a>"]}');
         end;
      end else begin
         GRID.Add('"' + storeSysCodeL + '"]}');
      end;
   end;


   procedure FormatGrid; //2018-06-20 bls: F#840
   begin
      GRID.Append('<row id=''' + RNQuery.FieldByName('row').AsString + '''>');
      GRID.Append('<cell>' + Trim(RNQuery.FieldByName('StoreCode').AsString) + '</cell>');

      if DisplayStoreName then begin //2018-30-2018 bls: F#1129
         GRID.Append('<cell>' + Trim(RNQuery.FieldByName('NAME').AsString) + '</cell>');
      end;

      if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620
         if DisplayInAMPM then begin
            GRID.Append('<cell>' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByname('AuthDatetz').AsDateTime)) +  '</cell>');
         end else begin
            GRID.Append('<cell>' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('AuthDatetz').AsDateTime)) +  '</cell>');
         end;
      end else begin
         GRID.Append('<cell>' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('AuthDate').AsDateTime)) +  '</cell>');
      end;

      GRID.Append('<cell><![CDATA[');

      If RNQuery.FieldByName('UpdatedAmount').AsFloat > 0 then
         GRID.Append('<IMG SRC="/Images/General/Refresh.gif" border="0" style="display: inline-block"/>');

      If RNQuery.FieldByName('Voided').AsBoolean then begin
         GRID.Append('<DEL>Void ' + Format('%m',[LineAmt]) + '</DEL>]]></cell>');
      end else begin
         GRID.Append(Format('%m',[LineAmt]) + ']]></cell>');
      end;

      if DisplayECAStatus then begin
         GRID.Append('<cell>' + Trim(RNQuery.FieldByName('TransactionType').AsString) + '</cell>');
      end;

      GRID.Append('<cell>' + trim(RNQuery.FieldByName('ResponseCheckNumber').AsString) + '</cell>');
      GRID.Append('<cell><![CDATA[' + ColorByECAStatus(TCKEffectiveStatus(RNQuery)) + Trim(RNQuery.FieldByName('DisplayText').AsString) + '</Font>]]></cell>');
      GRID.Append('<cell><![CDATA[' + Trim(RNQuery.FieldByName('ECATranStatus').AsString) + ' ');
      GRID.Append(TCKStatusImage(RNQuery) + ']]></cell>');
      GRID.Append('<cell>' + trim(RNQuery.FieldByName('TranIdent').AsString) + '</cell>');
      GRID.Append('<cell>' + trim(RNQuery.FieldByName('TranCustomerCode').AsString) + '</cell>');

      if (IncludeBatchDate) then begin
         if (DisplayInTZ) then begin
            if DisplayInAMPM then begin
               GRID.Append('<cell>' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByname('BatchDatetz').AsDateTime)) +  '</cell>');
            end else begin
               GRID.Append('<cell>' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('BatchDatetz').AsDateTime)) +  '</cell>');
            end;
         end else begin
            GRID.Append('<cell>' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('BatchDate').AsDateTime)) +  '</cell>');
         end;
      end;

      GRID.Append('<cell>' + Trim(RNQuery.FieldByName('BatchSerial').AsString) + '</cell>');

      GRID.Append('<cell>' + Trim(RNQuery.FieldByName('StationIdent').AsString)+'</cell>');

      GRID.Append('<cell>' + Trim(RNQuery.FieldByName('TCMID').AsString) + '</cell>');

      GRID.Append('<cell>' + Trim(RNQuery.FieldByName('TCServiceName').AsString) + '</cell>');
      if IncludeEmpIdent then GRID.Append('<cell>' + Trim(RNQuery.FieldByName('TranEmployeeIdent').AsString) + '</cell>');

      If ShowLinks then begin
         if (AAllowAll) and (RNID = 'ALL') then begin
            GRID.Append('<cell><![CDATA[<a href="javascript://" onclick="GetVTCheckDetailAJAX(''' +
                        trim(RNQuery.FieldByName('StoreCode').AsString) + ''',''' + trim(RNQuery.FieldByName('StoreSystemCode').AsString) + ''')">' +
                        Trim(RNQuery.FieldByName('StoreSystemCode').AsString) + '</a>]]></cell>');
         end else begin
            GRID.Append('<cell><![CDATA[<a href="javascript://" onclick="GetVTCheckDetailAJAX(''' + RNID + ''',''' +
                        trim(RNQuery.FieldByName('StoreSystemCode').AsString) + ''')">' + Trim(RNQuery.FieldByName('StoreSystemCode').AsString) + '</a>]]></cell>');
         end;
      end else begin
         GRID.Append('<cell>' + Trim(RNQuery.FieldByName('StoreSystemCode').AsString) + '</cell>');
      end;

      if IncludeRefundData then begin
         GRID.Append('<cell>' + Trim(RNQuery.FieldByName('RefundAmount').AsString) + '</cell>');
         GRID.Append('<cell>' + Trim(RNQuery.FieldByName('RefundDate').AsString) + '</cell>');
      end;

      GRID.Append('</row>');
   end;

   procedure FormatHTML;
   begin
      WS := '<TR><TD>' + RNQuery.FieldByName('StoreCode').AsString + '</TD>';

      if DisplayStoreName then begin //2018-30-2018 bls: F#1129
         WS := WS + '   <TD>' + RNQuery.FieldByName('NAME').AsString + '</TD>'
      end;

      if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620
         if DisplayInAMPM then begin
            WS := WS + '    <TD>' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByname('AuthDatetz').AsDateTime) + '</TD>';
         end else begin
            WS := WS + '    <TD>' + FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('AuthDatetz').AsDateTime) + '</TD>';
         end;
      end else begin
         WS := WS + '    <TD>' + FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('AuthDate').AsDateTime) + '</TD>';
      end;

      WS := WS + '    <TD align="Right">';

      If RNQuery.FieldByName('UpdatedAmount').AsFloat > 0 then
         WS := WS + '<IMG SRC="/Images/General/Refresh.gif" border="0">';

      If RNQuery.FieldByName('Voided').AsBoolean then begin
         WS := WS + '<DEL>Void ' + Format('%m',[LineAmt]) + '</DEL></TD>';
         inc(VCount);
         VAmount := VAmount +  LineAmt;
      end else begin
         WS := WS + Format('%m',[LineAmt]) + '</TD>';
         If TCKEffectiveStatus(RNQuery) = 1 then begin
            EAmount := EAmount + LineAmt;
            Inc(ECount);
         end else If TCKEffectiveStatus(RNQuery) = 0 then begin
            PAmount := PAmount + LineAmt;
            Inc(PCount);
         end else If TCKEffectiveStatus(RNQuery) in [3,4] then begin
            DAmount := DAmount + LineAmt;
            Inc(DCount);
         end else If TCKEffectiveStatus(RNQuery) = -1 then begin
            ErrorAmount := ErrorAmount + LineAmt;
            Inc(ErrorCount);
         end;
      end;

      if DisplayECAStatus then begin
         ecaStatus := '    <TD align="Right">' + RNQuery.FieldByName('TransactionType').AsString + '</TD>';
      end else begin
         ecaStatus := '';
      end;

      WS := WS + ecaStatus +
            '    <TD align="Right">' + RNQuery.FieldByName('ResponseCheckNumber').AsString + '</TD>' +
            '    <TD>' + ColorByECAStatus(TCKEffectiveStatus(RNQuery)) + RNQuery.FieldByName('DisplayText').AsString + '</Font></TD>' +
            '    <TD>' + RNQuery.FieldByName('ECATranStatus').AsString + '</TD>' +
            '    <TD align="CENTER">' + TCKStatusImage(RNQuery) + '</TD>' +
            '    <TD align="Right">' + RNQuery.FieldByName('TranIdent').AsString + '</TD>' +
            '    <TD align="Right">' + RNQuery.FieldByName('TranCustomerCode').AsString + '</TD>';
         if (IncludeBatchDate) then begin
            if (DisplayInTZ) then begin
               if DisplayInAMPM then begin
                  WS := WS + '    <TD>' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByname('BatchDatetz').AsDateTime) + '</TD>';
               end else begin
                  WS := WS + '    <TD>' + FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('BatchDatetz').AsDateTime) + '</TD>';
               end;
            end else begin
               WS := WS + '    <TD>' + FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('BatchDate').AsDateTime) + '</TD>';
            end;
         end;
         WS := WS + '    <TD>' + RNQuery.FieldByName('BatchSerial').AsString + '</TD>';

            if (RecordFormatType = ttrftAJAX) then begin
               WS := WS + '<TD>' + Trim(RNQuery.FieldByName('StationIdent').AsString) + '</TD>';
            end else begin
               WS := WS + '    <TD>' + '<A HREF="PAYMENTMATE?RNID=' + RNID +
                                    '&FROMDATE=' + FormatDateTime('MM/DD/YYYY', FromDate) +
                                    '&THRUDATE=' + FormatDateTime('MM/DD/YYYY', ThruDate) +
                                    '&STATIONIDENT=' + WebParamEncode(Trim(RNQuery.FieldByName('StationIdent').AsString)) +
                                    '&SERVICENAME=' + WebParamEncode(ServiceName) +
                                    '&PAGE=CHECK&ACTION=CHECKQUERY&FORMAT=' + DisplayFormat + '">' +
                                    Trim(RNQuery.FieldByName('StationIdent').AsString) + '</A></TD>';
            end;

            WS := WS + '    <TD>' + RNQuery.FieldByName('TCMID').AsString + '</TD>';

            if (RecordFormatType = ttrftAJAX) then begin
               WS := WS + '<TD>' + Trim(RNQuery.FieldByName('TCServiceName').AsString) + '</TD>';
               if IncludeEmpIdent then WS := WS + '<TD>' + Trim(RNQuery.FieldByName('TranEmployeeIdent').AsString) + '</TD>';

               If ShowLinks then begin
                  if (AAllowAll) and (RNID = 'ALL') then begin
                     WS := WS + '<TD><a href="javascript://" onclick="GetVTCheckDetailAJAX(''' + trim(RNQuery.FieldByName('StoreCode').AsString) + ''',''' +
                                 trim(RNQuery.FieldByName('StoreSystemCode').AsString) + ''')">' + RNQuery.FieldByName('StoreSystemCode').AsString + '</a></TD>';
                  end else begin
                     WS := WS + '<TD><a href="javascript://" onclick="GetVTCheckDetailAJAX(''' + RNID + ''',''' + trim(RNQuery.FieldByName('StoreSystemCode').AsString) + ''')">' +
                                 RNQuery.FieldByName('StoreSystemCode').AsString + '</a></TD>';
                  end;
               end else begin
                  WS := WS + '<TD>' + RNQuery.FieldByName('StoreSystemCode').AsString + '</TD>';
               end;

               if IncludeRefundData then   WS := WS + '<TD>' + Trim(RNQuery.FieldByName('RefundAmount').AsString) + '</TD>' +
                                                          '<TD>' + Trim(RNQuery.FieldByName('RefundDate').AsString) + '</TD>';
            end else begin
               WS := WS + '<TD>' + '<A HREF="PAYMENTMATE?RNID=' + RNID +
                        '&FROMDATE=' + FormatDateTime('MM/DD/YYYY', FromDate) +
                        '&THRUDATE=' + FormatDateTime('MM/DD/YYYY', ThruDate) +
                        '&STATIONIDENT=' + WebParamEncode(StationName) +
                        '&SERVICENAME=' + WebParamEncode(Trim(RNQuery.FieldByName('TCServiceName').AsString)) +
                        '&PAGE=CHECK&ACTION=CHECKQUERY&FORMAT=' + DisplayFormat + '">' +
                        Trim(RNQuery.FieldByName('TCServiceName').AsString) + '</A></TD>';
            end;
            if (RecordFormatType <> ttrftAJAX) then
               WS := WS +  '    <TD Align="CENTER"><a href="PAYMENTMATE?PAGE=CHECK&ACTION=CHECKDETAILS&CHECKCODE=' + RNQuery.FieldByName('SystemCode').AsString + '">' +
                       '<IMG SRC="/Images/General/MagGlassSmall.gif" border="0"></A></TD>';
            WS := WS+ '</TR>';
      HTML.Add(WS);
   end;

   Function getColumnName(gridColumn : string) : string; //2018-06-20 bls: F#840
   var
      sqlColName : string;

      tranIdent, custIdent, itemSerial : string;
   begin
      sqlColName := '';

      tranIdent := ValidCharsOnly(Trim(tranIdentHeader),true,false,'');
      custIdent := ValidCharsOnly(Trim(custIdentHeader),true,false,'');

      if StoreSystemCodeLabel <> '' then begin
         itemSerial := ValidCharsOnly(Trim(StoreSystemCodeLabel), true, false, '');
      end else begin
         itemSerial := 'ItemSerial';
      end;

      if gridColumn = 'RNID' then sqlColName := 'tc.StoreCode'
      else if gridColumn = 'StoreName' then sqlColName := 's.Name'
      else if gridColumn = 'AuthDate' then sqlColName := 'tc.AuthDate'
      else if gridColumn = 'Amount' then sqlColName := 'tc.TranAmount'
      else if gridColumn = 'ECAStatus' then sqlColName := 'tc.Voided ' + direction + ', tc.RefundAmount'
      else if gridColumn = 'CHK' then sqlColName := 'tc.ResponseCheckNumber'
      else if gridColumn = 'TCKResponse' then sqlColName := 'tc.DisplayText'
      else if gridColumn = 'Status' then sqlColName := 'tc.ECATranStatus'
      else if gridColumn = tranIdent then sqlColName := 'tc.TranIdent'
      else if gridColumn = custIdent then sqlColName := 'tc.TranCustomerCode'
      else if gridColumn = 'Batch' then sqlColName := 'tc.BatchSerial'
      else if gridColumn = 'BatchDate' then sqlColName := 'tc.BatchDate'
      else if gridColumn = 'EmpIdent' then sqlColName := 'tc.TranEmployeeIdent'
      else if gridColumn = 'Station' then sqlColName := 'tc.StationIdent'
      else if gridColumn = itemSerial then sqlColName := 'tc.StoreSystemCode'
      else if gridColumn = 'MID' then sqlColName := 'tc.TCMID'
      else if gridColumn = 'Service' then sqlColName := 'tc.TCServiceName'
      else if gridColumn = 'RefundAmount' then sqlColName := 'tc.RefundAmount'
      else if gridColumn = 'LastRefundDate' then sqlColName := 'tc.RefundDate'
      else sqlColName :=  'tc.AuthDate';

      Result := sqlColName;
   end;

begin
   If DisplayFormat = 'XML' then begin
      RecordFormatType := ttrftXML;
      CSV := TStringList.Create;
   end else If DisplayFormat = 'XLS'  then begin
      RecordFormatType := ttrftXLS;
      CSV := TStringList.Create;
      TabText := TTTStringList.Create;
   end else If DisplayFormat = 'JSON'  then begin
      RecordFormatType := ttrftJSON;
      JSON := TStringList.Create;
   end else If DisplayFormat = 'GRID'  then begin
      RecordFormatType := ttrftGRID;
      GRID := TStringList.Create;
   end else If DisplayFormat = 'AJAX'  then begin
      RecordFormatType := ttrftAJAX;
      HTML := TStringList.Create;
   end else begin
      RecordFormatType := ttrftHTML;
      HTML := TStringList.Create;
   end;

   Result := '';
   DisplayECAStatus := false;
   DisplayStoreName := false;
   IncludeEmpIdent := false;
   IncludeProfileFields := false;
   IncludeRefundData := false;
   RNIDList := TStringList.Create;
   DisplayInTZ := false;
   DateRange := '';
   ParameterList := TStringList.Create; //2018-06-20 bls: F#840
   QueryBuilder := TStringList.Create; //2018-06-20 bls: F#840

   if RecordFormatType = ttrftXLS then begin
      TabText.Delimiter := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/PREFERREDDELIMITER', TAB)[1]; //2018-05-10 bls: D#2595
   end;
      
   TranIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/TCTRANIDENTDESC', 'Tran Ident')); //2018-4-24 bls: F#3735
   CustIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/TCCUSTIDENTDESC', 'Cust Ident')); //2018-4-24 bls: F#3735

   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYECATYPE', 'FALSE') = 'TRUE' then DisplayECAStatus := true;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CHECKHISTDISPLAYSTORENAME', 'FALSE') = 'TRUE' then DisplayStoreName := true; //2018-30-2018 bls: F#1129
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/ALLOWALLSEARCH', 'FALSE') = 'TRUE' then AAllowAll := true;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL', '') <> '' then StoreSystemCodeLabel := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL'));  //2016-8-22 jtm: Feat OT#1038
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEEMPIDENT', 'FALSE') = 'TRUE' then IncludeEmpIdent := true;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEPROFILEFIELDS', 'FALSE') = 'TRUE' then IncludeProfileFields := true;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEREFUNDDATA', 'FALSE') = 'TRUE' then IncludeRefundData := true;
   useJSONResp := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEJSONFORGRIDS','TRUE')); //2018-07-18 bls: F#4978
   DisplayInAMPM := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINAMPM', 'FALSE'));
   IncludeBatchDate := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDECHECKBATCHDATE', 'FALSE'));
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE') = 'TRUE') then DisplayInTZ := true; //2017-12-20 jtm: D#2620
   if not (DisplayInTZ) then begin
      if (RNReg.RegGetValAsString('PMACCESS.DISPLAYINTZ','FALSE') = 'TRUE') then begin //for APM
         DisplayInTZ := true;
      end;
   end;

   if ((AAllowAll) and (RNID = 'ALL')) then begin
      UsingAll := true;
      GetChainRNIDs(RNIDList);
   end else begin
      If NOT ValidateRNID(RNID)  then begin
         Result := 'Invalid Store Code';
         exit;
      end;
      UsingAll := false;
      RNIDList.Add(NumericOnly(RNID));
      StoreInfo := GetStoreInfo(Valu(RNID));
   end;

   RNQuery.Close;
   RNQuery.SQL.clear;

   ParameterList.Append(DRSQLVarsDec);
   if (DateRange = 'CUSTOM') or (DateRange = '')  then begin
      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SEARCHONDATETIME', 'FALSE') = 'TRUE') then begin //2018-08-15 bls: 542
         ParameterList.Append('set @BegDate = ''' + FormatDateTime('MM/DD/YYYY hh:nn', Fromdate) + '''; set @EndDate =''' + FormatDateTime('MM/DD/YYYY hh:nn', ThruDate + 1) + ''';');
      end else begin
      ParameterList.Append('set @BegDate = ''' + FormatDateTime('MM/DD/YYYY', Fromdate) + '''; set @EndDate =''' + FormatDateTime('MM/DD/YYYY', ThruDate + 1) + ''';');
      end;
   end else begin
      ParameterList.Append('set @DateRangeName = '''+DateRange+''';'+ 'set @TZOffset = '';' +DRSQLSetGetDateTZ + DRSQLSetBegDate + DRSQLSetEndDate);
   end;
   ParameterList.Append(DRSQLSetTZ);
   ParameterList.Append('set @BegDateHAST = DATEADD(hour,+'+HASTOffsetEST+',@BegDate);set @EndDateHAST = DATEADD(hour,+'+HASTOffsetEST+',@EndDate); ');


   if RecordFormatType = ttrftGRID then begin //2018-06-20 bls: F#840
      posStart := '0';
      count := '100';

      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['posStart']))) <> '' then begin
          posStart := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['posStart']))); // Get Starting position
      end;
      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['count']))) <> '' then begin
          count := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['count']))); // Get amount of rows to receive from db
      end;
      if ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['orderby'])),true,false,'') <> '' then begin
          orderBy := Request.queryfields.Values['orderby']; // Determines which column to sort the data by
      end;
      if ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['direct'])),true,false,'') <> '' then begin
          direction := Request.queryfields.Values['direct']; // Determines whether the data will be ascending or descending
          if direction = 'des' then direction := 'DESC';
      end;

      ParameterList.Append('Set @StartPos = ' + posStart + '; set @count = ' + count + ';');
   end;

   QueryBuilder.Append('Select');
   if (DisplayInTZ) then begin
      QueryBuilder.Append('CASE r.KeyValue WHEN ''AST'' THEN DATEADD(hour,+1,tc.AuthDate) WHEN ''CST'' THEN DATEADD(hour,-1,tc.AuthDate) WHEN ''MST'' THEN DATEADD(hour,-2,tc.AuthDate) ');
      QueryBuilder.Append('WHEN ''PST'' THEN DATEADD(hour,-3,tc.AuthDate) WHEN ''AKST'' THEN DATEADD(hour,-4,tc.AuthDate)');
      QueryBuilder.Append('WHEN ''HAST'' THEN DATEADD(hour,-'+HASTOffsetEST+',tc.AuthDate) ELSE tc.AuthDate END authdatetz,');

      QueryBuilder.Append('CASE r.KeyValue WHEN ''AST'' THEN DATEADD(hour,+1,tc.BatchDate) WHEN ''CST'' THEN DATEADD(hour,-1,tc.BatchDate) WHEN ''MST'' THEN DATEADD(hour,-2,tc.BatchDate) ' +
                             'WHEN ''PST'' THEN DATEADD(hour,-3,tc.BatchDate) WHEN ''AKST'' THEN DATEADD(hour,-4,tc.BatchDate)' +
                             'WHEN ''HAST'' THEN DATEADD(hour,-'+HASTOffsetEST+',tc.BatchDate) ELSE tc.BatchDate END BatchDatetz,');
   end;
   QueryBuilder.Append('S.SystemCode RNID, tc.*,s.Name,s.City,s.State,s.ZIP');

   if DisplayECAStatus then begin
      QueryBuilder.Append(', (case when tc.Voided = 1 then ''VOID'' when tc.RefundAmount > 0 then ''REFUND'' else ''SALE'' end) as ''TransactionType'''); //2018-05-08 bls D#4384
   end;

   if RecordFormatType = ttrftGRID then begin  //2018-06-20 bls: F#840
      if orderBy = '' then begin
         QueryBuilder.Append(',ROW_NUMBER() OVER (ORDER BY tc.AuthDate) as row');
      end else begin
         QueryBuilder.Append(',ROW_NUMBER() OVER (ORDER BY ' + getColumnName(orderBy) + ' ' + direction + ') as row');
      end;   
   end;

   QueryBuilder.Append('from TCAuth tc left outer join');
   QueryBuilder.Append('  Store s on tc.StoreCode = s.SystemCode');
   
   if (DisplayInTZ) then begin
      QueryBuilder.Append('left outer join REGISTRY r on r.SubKey1 = tc.storecode');
   end;
   QueryBuilder.Append('where (s.SystemCode in(' + RNIDList.CommaText + '))');

   if (DisplayInTZ) then begin
      QueryBuilder.Append('and r.subkey2 = ''storetz''');
      QueryBuilder.Append('and (Authdate >= case r.KeyValue WHEN ''AST'' THEN @BegDateAST WHEN ''CST'' THEN @BegDateCST WHEN ''MST'' THEN @BegDateMST WHEN ''PST'' THEN @BegDatePST WHEN ''AKST'' THEN @BegDateAKST WHEN ''HAST'' THEN @BegDateHAST ELSE @BegDate END)'); //figure out DST for AZ and HI
      QueryBuilder.Append('and (Authdate < case r.KeyValue WHEN ''AST'' THEN @EndDateAST WHEN ''CST'' THEN @EndDateCST WHEN ''MST'' THEN @EndDateMST WHEN ''PST'' THEN @EndDatePST WHEN ''AKST'' THEN @EndDateAKST WHEN ''HAST'' THEN @EndDateHAST ELSE @EndDate END)');
   end else begin
      QueryBuilder.Append('and (AuthDate >= @BegDate)');
      QueryBuilder.Append('and (AuthDate < @EndDate)');
   end;

   If ARequest.queryfields.Values['APPROVEDONLY'] = 'TRUE' then
      QueryBuilder.Append('AND (ECATranStatus in (''0'',''1''))');

   StationName := ValidCharsOnly(StationName,True,True,'-._ ');
   If length(StationName) > 20 then
      SetLength(StationName, 20);
   If StationName <> '' then
      QueryBuilder.Append('And (StationIdent =''' + StationName + ''')');

   ServiceName := ValidCharsOnly(ServiceName,True,True,'-');
   If length(ServiceName) > 20 then
      SetLength(ServiceName,20);
   If ServiceName <> '' then
      QueryBuilder.Append('And (TCServiceName =''' + ServiceName + ''')');

   CHType := VarEvaluator.GetValueAsString('CHECKHISTTYPE');
   If CHType = '0' then
      QueryBuilder.Append('And (ECATranStatus =''0'') and (voided = 0)');
   If CHType = '1' then
      QueryBuilder.Append('And (ECATranStatus =''1'')and (voided = 0)');
   If CHType = '01' then
      QueryBuilder.Append('AND (ECATranStatus in (''0'',''1'')) and (voided = 0)');
   If CHType = '34' then
      QueryBuilder.Append('AND (ECATranStatus in (''3'',''4'','''')) and (voided = 0)'); //2018-05-07 bls D#2603
   If CHType = 'VOID' then
      QueryBuilder.Append('AND (voided = 1)');


   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHEMPIDENT', 'FALSE') = 'TRUE') and (ValidCharsonly(ARequest.queryfields.Values['EMPIDENT'],True,True,'') <> '') then begin
      QueryBuilder.Append('And (TranEmployeeIdent LIKE ''' + ValidCharsonly(ARequest.queryfields.Values['EMPIDENT'],True,True,'.-_:/& ') + '%'')'); //2018-04-26 bls D#2533
   end;
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHTRANIDENT', 'FALSE') = 'TRUE') and (ValidCharsonly(Request.queryfields.Values['TRANIDENT'],True,True,'.-_:/& ') <> '') then begin
      QueryBuilder.Append('And (TranIdent LIKE ''' + ValidCharsonly(Request.queryfields.Values['TRANIDENT'],True,True,'.-_:/& ') + '%'')'); //2017-05-10 jtm D#1605
   end;
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHCUSTIDENT', 'FALSE') = 'TRUE') and (ValidCharsonly(Request.queryfields.Values['CUSTIDENT'],True,True,'.-_:/& ') <> '') then begin
      QueryBuilder.Append('And (TranCustomerCode LIKE ''' + ValidCharsonly(Request.queryfields.Values['CUSTIDENT'],True,True,'.-_:/& ') + '%'')'); //2017-05-10 jtm D#1605
   end;

   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHDOLLARAMT', 'FALSE') = 'TRUE') and (ValidCharsonly(Request.queryfields.Values['DOLLARAMT'],False,True,'.') <> '') then begin
      if (NumericOnly(Request.queryfields.Values['DOLLARAMTCOMP']) = '0') then begin
         QueryBuilder.Append('And (TranAmount = ''' + ValidCharsonly(Request.queryfields.Values['DOLLARAMT'],false,True,'.') + ''')');
      end else if(NumericOnly(Request.queryfields.Values['DOLLARAMTCOMP']) = '1') then begin
         QueryBuilder.Append('And (TranAmount > ''' + ValidCharsonly(Request.queryfields.Values['DOLLARAMT'],false,True,'.') + ''')');
      end else if (NumericOnly(Request.queryfields.Values['DOLLARAMTCOMP']) = '2') then begin
         QueryBuilder.Append('And (TranAmount < ''' + ValidCharsonly(Request.queryfields.Values['DOLLARAMT'],false,True,'.') + ''')');
      end;
   end;
   
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHCUSTIDENT', 'FALSE') = 'TRUE') and (ValidCharsonly(Request.queryfields.Values['CUSTIDENT'],True,True,'.-_:/& ') <> '') then begin
      QueryBuilder.Append('And (TranCustomerCode LIKE ''' + ValidCharsonly(Request.queryfields.Values['CUSTIDENT'],True,True,'.-_:/& ') + '%'')'); //2017-05-10 jtm D#1605
   end;

   if RecordFormatType <> ttrftGRID then begin
      if (isPaymentMate) then begin
         QueryBuilder.Append('Order by S.systemcode, tc.AuthDate');
      end else begin
         QueryBuilder.Append('Order by tc.AuthDate');
      end;
   end;
   
   RNQuery.DisableControls;
   TADODataSet(RNQuery).CommandTimeout := 300;     //2016-10-05
   ProcessLog(ltDebug,'GetCheckQueryTable SQL Text', ParameterList.Text + QueryBuilder.Text);

   if RecordFormatType = ttrftGRID then begin //2018-06-20 bls: F#840
      if StrToInt(posStart) = 0 then begin
         RNQuery.SQL.Append(parameterList.Text + ' SELECT COUNT(*) as totalCount FROM(' + QueryBuilder.Text + ') as a');
         RNQuery.Open();
         totalCount := RNQuery.FieldByName('totalCount').AsString;
         SessionVarEval.AddValue('ClosedCheckTotalCount', totalCount);
         ProcessLog(ltinfo, 'getCheckQueryTable', 'Query Opened: Total Record Count: ' + totalCount);
      end;
      RNQuery.Close();
      RNQuery.SQL.Clear();

      RNQuery.SQL.Append(ParameterList.Text + ' SELECT * FROM(' + QueryBuilder.Text + ') as a WHERE row between (@StartPos + 1) and (@StartPos + @count) ');
   end else begin
      RNQuery.SQL.Append(ParameterList.Text + QueryBuilder.Text);
   end;

   RNQuery.Open;

   I := 0;
   PreviousRNID := Null;
   
   ParameterList.Free;
   QueryBuilder.Free;
   RNIDList.Free;
   
   if xExport <> nil then begin
      xlsWorkSheet := xExport.AddWorkSheet;
   end else if RecordFormatType = ttrftJSON then begin
      JSON.Append('[');
   end;

   if not isPaymentMate then begin
      if (UsingAll) then begin
         ProcessHeader('',true);
      end else begin
         ProcessHeader(Trim(RNQuery.FieldByName('RNID').AsString), not(RNQuery.FieldByName('StoreCode').IsNull));
      end;
   end;

   while (not(RNQuery.EOF)) do begin
      if (PreviousRNID <> Trim(RNQuery.FieldByName('RNID').AsString)) then begin
         if (PreviousRNID <> Null) then begin  //finishing up an old RNID
            if (isPaymentMate) then begin
               ProcessFooter;
            end;
         end;
         GetProfileInfo(Trim(RNQuery.FieldByName('RNID').AsString));
         if (isPaymentMate) then begin
            ProcessHeader(Trim(RNQuery.FieldByName('RNID').AsString), not(RNQuery.FieldByName('StoreCode').IsNull));
         end;
         PreviousRNID := Trim(RNQuery.FieldByName('RNID').AsString);
      end;

      if (RNQuery.FieldByName('StoreCode').IsNull) then begin
         RNQuery.Next;
         continue;
      end;

      inc(RNIDRecCount);
      Inc(I);

      LineAmt := RNQuery.FieldByName('TranAmount').AsFloat;
      If RNQuery.FieldByName('UpdatedAmount').AsFloat > 0 then
         LineAmt := RNQuery.FieldByName('UpdatedAmount').AsFloat;
         
      case RecordFormatType of
         ttrftXML:   FormatXML;
         ttrftXLS:   FormatXLS;
         ttrftJSON:  FormatJSON;
         ttrftGRID: begin //2018-06-20 bls: F#840
            if I = 1 then begin
               if useJSONResp then begin //2018-07-18 bls: F#4978
                  GRID.Add('{"total_count":' + SessionVarEval.GetValueAsString('ClosedCheckTotalCount') + ',"pos":' + posStart + ',"rows":[');
               end else begin
                  GRID.Add('<?xml version="1.0" encoding="UTF-8"?><rows total_count=''' + SessionVarEval.GetValueAsString('ClosedCheckTotalCount') + ''' pos= ''' + posStart + '''>');
               end;
            end;
            if useJSONResp then begin //2018-07-18 bls: F#4978
               FormatGRIDJSON;
            end else begin
               FormatGRID;
            end;
         end;
         ttrftHTML,
         ttrftAJAX:  FormatHTML
      end;
      RNQuery.Next;
      if (NOT RNQuery.EOF) AND (RecordFormatType = ttrftJSON) then JSON.Add(',');
      if (NOT RNQuery.EOF) AND (RecordFormatType = ttrftGRID) AND useJSONResp then GRID.Add(',');
   end;

   if (PreviousRNID <> Null) then begin  //Do the last footer
      ProcessFooter;
   end;

   case RecordFormatType of
      ttrftXML: begin
         Result := CSV.Text;
         Response.CustomHeaders.Values['Cache-Control'] := 'private';
         Response.CustomHeaders.Values['Pragma'] := 'private';
      end;
      ttrftXLS: begin
         Result := CSV.Text;
         Response.CustomHeaders.Values['Cache-Control'] := 'private';
         Response.CustomHeaders.Values['Pragma'] := 'private';
      end;
      ttrftJSON: begin
         JSON.Add(']');
         Result := TextWithoutNewLine(JSON); // Sends the complete JSONString back with a closing square bracket
      end;
      ttrftGRID: begin //2018-06-20 bls: F#840
         if RNQuery.RecordCount = 0 then begin
            if useJSONResp then begin //2018-07-18 bls: F#4978
               GRID.Add('{"total_count":0,"pos":0,"rows":[');
            end else begin
               GRID.Add('<?xml version="1.0" encoding="UTF-8"?><rows total_count=''0'' pos= ''0''>');
            end;
         end;
         if useJSONResp then begin
            GRID.Add(']}');
            Result := TextWithoutNewLine(GRID);
         end else begin
            Result := GRID.Text + '</rows>';
         end;
      end;
      ttrftHTML,
      ttrftAJAX: begin
         Result := HTML.Text;
      end;
   end;

   if assigned(HTML) then HTML.Free;
   if assigned(CSV) then CSV.Free;
   if assigned(TabText) then TabText.Free; //2018-05-10 bls: D#2595
   if assigned(JSON) then JSON.Free;
   if assigned(GRID) then GRID.Free; //2018-06-20 bls: F#840
end;



function TCustomerInfoModule.GetCheckQueryTable2(RNID: String; FromDate,
               ThruDate: TDateTime; BatchSerial: Integer; StationName, ServiceName,
               DisplayFormat: String;
               ARequest: TWebRequest;
               xExport: TOExport;
               AAllowAll,
               AExtraBreaksBetweenStoreCodes: Boolean): String;
var
   WS : String;
   I : Integer;
   StoreInfo : String;
   CSV : TStringList;
   HTML : TStringList;

   LineAmt : single;

   EAmount : Currency;
   ECount  : Integer;
   PAmount : Currency;
   PCount  : Integer;
   VAmount : Currency;
   VCount  : Integer;
   DAmount : Currency;
   DCount  : Integer;
   ErrorAmount : Currency;
   ErrorCount  : Integer;
   CHType : String;
   RNIDList : TStringList;
   IncludeEmpIdent : boolean; //2016-06-13 jtm
   IncludeProfileFields : boolean;  //2016-7-28 jtm
   PreviousRNID : variant;
   CustomField1Value, CustomField2Value, CustomField3Value, CustomField4Value, CustomField5Value, CustomField6Value : String;
   StoreSystemCodeLabel : string;
   RecordFormatType: TRecordFormatType;
   RNIDRecCount: Integer;
   UsingAll: Boolean;
   DisplayInTZ : boolean;

   xlsWorkSheet : TExportWorksheet; //Represents actual xls worksheet
   Row : TExportRow; //Represents actual row inside the TExportWorksheet
   DateRange : string;
   TabText : TTTStringList; //2018-05-10 bls: D#2595

   procedure ProcessHeader(AStoreCode: String; ADetailRecsExists: Boolean);
   begin
      RNIDRecCount := 0;
      EAmount := 0;
      ECount  := 0;
      PAmount := 0;
      PCount  := 0;
      VAmount := 0;
      VCount  := 0;
      DAmount := 0;
      DCount  := 0;
      ErrorAmount := 0;
      ErrorCount  := 0;
      CustomField1Value := '';
      CustomField2Value := '';
      CustomField3Value := '';
      CustomField4Value := '';
      CustomField5Value := '';
      CustomField6Value := '';

      if (assigned(ProfileXML)) then begin
         FreeAndNil(ProfileXML);
      end;
      ProfileXML := TTProfileXML.Create(StrToInt(AStoreCode), HDQuery);
      CustomField1Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/VALUE', '');
      CustomField2Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/VALUE', '');
      CustomField3Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/VALUE', '');
      CustomField4Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/VALUE', '');
      CustomField5Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/VALUE', '');
      CustomField6Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/VALUE', '');

      StoreInfo := GetStoreInfo(Valu(AStoreCode));
      if (RecordFormatType in [ttrftHTML, ttrftAJAX]) then begin
         WS := 'Checks from ' + FormatDateTime('MM/DD/YYYY',Fromdate) + ' Thru ' +FormatDateTime('MM/DD/YYYY',Thrudate) + ' <BR><B>' + AStoreCode + '<BR>' + StoreInfo + '</B><BR>'  ;
         HTML.Add(WS);

         if (ADetailRecsExists) then begin
            HTML.Add('<TABLE border="1" cellspacing="0" cellpadding="3" bordercolorlight="#0000FF" style="border-collapse: collapse">' +
                       '<TR><TD><B>RNID</B></TD>' +
                       '    <TD><B>Auth Date</B></TD>' +
                       '    <TD Align="Right"><B>Amount</B></TD>' +
                       '    <TD><B>CHK #</B></TD>' +
                       '    <TD><B>TCK Response</B></TD>' +
                       '    <TD Colspan=2 align="Center"><B>Status</B></TD>' +
                       '    <TD><B>Tran Ident</B></TD>' +
                       '    <TD><B>Cust Ident</B></TD>' +
                       '    <TD><B>Batch</B></TD>' +
                       '    <TD><B>Station</B></TD>' +
                       '    <TD><B>MID</B></TD>' +
                       '    <TD><B>Service</B></TD>');
            If (RecordFormatType <> ttrftAJAX) then
               HTML.Add('    <TD><B></B></TD>');
            if IncludeEmpIdent then HTML.Add('    <TD><B>EmpIdent</B></TD>');
            HTML.Add('</TR>');
         end;
      end;
      If (RecordFormatType = ttrftXLS) and (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEREPORTHEADERS', 'FALSE') = 'TRUE') then begin   //2016-06-13 jtm

         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEOLDXLSFORMAT', 'FALSE') = 'TRUE') OR
         (RNReg.RegGetValAsString('PMACCESS.USEOLDXLSFORMAT','FALSE') = 'TRUE') then begin //2018-05-10 bls: D#2595
            if (ADetailRecsExists) then begin
               TabText.Clear();

               TabText.Append('RNID');
               TabText.Append('Auth Date');
               TabText.Append('Amount');
               TabText.Append('CHK #');
               TabText.Append('TCK Response');
               TabText.Append('Status');
               TabText.Append('Tran Ident');
               TabText.Append('Cust Ident');
               TabText.Append('Batch');
               TabText.Append('Station');
               TabText.Append('MID');
               TabText.Append('Service');
               TabText.Append('Store Name');
               TabText.Append('Store City');
               TabText.Append('Store State');
               TabText.Append('Store ZIP');

               if IncludeEmpIdent then TabText.Append('Employee Ident');
               if StoreSystemCodeLabel <> '' then begin
                  TabText.Append(StoreSystemCodeLabel);
               end else begin
                  TabText.Append('Station Code');
               end;
               TabText.Append('Voided Date');        //2016-10-05

               if IncludeProfileFields then begin
                  TabText.Append(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/NAME', ''));
                  TabText.Append(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/NAME', ''));
                  TabText.Append(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/NAME', ''));
                  TabText.Append(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/NAME', ''));
                  TabText.Append(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/NAME', ''));
                  TabText.Append(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/NAME', ''));
               end;
               CSV.Append(TabText.DelimitedText);
               TabText.Clear();
            end;
         end else begin
            Row := xlsWorkSheet.AddRow;
            if (ADetailRecsExists) then begin
               Row.AddCellString('RNID');
               Row.AddCellString('Amount');
               Row.AddCellString('CHK #');
               Row.AddCellString('TCK Response');
               Row.AddCellString('Status');
               Row.AddCellString('Tran Ident');
               Row.AddCellString('Cust Ident');
               Row.AddCellString('Batch');
               Row.AddCellString('Station');
               Row.AddCellString('MID');
               Row.AddCellString('Service');
               Row.AddCellString('Store Name');
               Row.AddCellString('Store City');
               Row.AddCellString('Store State');
               Row.AddCellString('Store ZIP');

               if IncludeEmpIdent then Row.AddCellString('Employee Ident');
               if StoreSystemCodeLabel <> '' then begin
                  Row.AddCellString(StoreSystemCodeLabel);
               end else begin
                  Row.AddCellString('Station Code');
               end;
               Row.AddCellString('Voided Date');

               if IncludeProfileFields then begin
                  Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/NAME', ''));
                  Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/NAME', ''));
                  Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/NAME', ''));
                  Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/NAME', ''));
                  Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/NAME', ''));
                  Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/NAME', ''));
               end;
            end;
         end;
      end;
   end;
   procedure ProcessFooter;
   begin
      processlog(ltInfo, 'GetCheckQueryTable2 ProcessFooter', String(PreviousRNID) + ' RecordCount=' + StrI(RNIDRecCount, -1));

      if (RecordFormatType in [ttrftHTML, ttrftAJAX]) then begin
         HTML.Add('</TABLE>');
         HTML.Add('<BR><BR>' +
                  '<TABLE border="1" cellspacing="0" colspan="2" cellpadding="3" bordercolorlight="#0000FF" style="border-collapse: collapse">'+
                  '<TR><TD ALIGN=''CENTER''></TD>'+
                  '    <TD ALIGN=''LEFT''><B>TOTALS</B></TD>'+
                  '    <TD ALIGN=''RIGHT''><B>Count</B></TD>'+
                  '    <TD ALIGN=''RIGHT''><B>Amount</B></TD>'+
                  '    <TD ALIGN=''CENTER''><B>Description</B></TD>'+
                  '</TR>'+
                  '<TR><TD ALIGN=''CENTER''><B><IMG SRC="/Images/General/BoltSmall.gif" border="0"></TD><TD>Electronic Checks</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[ECount])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[EAmount])+'</TD>'+
                  '    <TD align=''LEFT''>Electronically offered and accepted</TD>'+
                  '</TR>'+
                  '<TR><TD ALIGN=''CENTER''><B><IMG SRC="/Images/General/CheckSmall.gif" border="0"></TD><TD>Paper Checks</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[PCount])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[PAmount])+'</TD>'+
                  '    <TD align=''LEFT''>Paper checks and Electronically offered but declined</TD>'+
                  '</TR>'+
                  '<TR><TD ALIGN=''CENTER''><B><IMG SRC="/Images/General/CheckSuccess.gif" border="0"></TD><TD>Approved Checks</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[PCount + ECount])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[PAmount + EAmount])+'</TD>'+
                  '    <TD align=''LEFT''>Total Electronic and Paper</TD>'+
                  '</TR>');
         If VCount > 0 then begin
            HTML.Add('<TR><TD ALIGN=''CENTER''><B><IMG SRC="/Images/General/YellowExclamation.gif" border="0"></TD><TD>Voided Checks</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%d',[VCount])+'</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%m',[VAmount])+'</TD>'+
                     '    <TD align=''LEFT''>Electronically offered but Voided</TD>'+
                     '</TR>');
         end;
         If DCount > 0 then begin
            HTML.Add('<TR><TD ALIGN=''CENTER''><B><IMG SRC="/Images/General/XFailed.gif" border="0"></TD><TD>Declined Checks</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%d',[DCount])+'</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%m',[DAmount])+'</TD>'+
                     '    <TD align=''LEFT''>Hard Decline (Code 4) and Risk Decline (Code 3)</TD>'+
                     '</TR>');
         end;
         If ErrorCount > 0 then begin
            HTML.Add('<TR><TD ALIGN=''CENTER''><B><IMG SRC="/Images/General/ExclamationSmall.gif" border="0"></TD><TD>Transaction Issues</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%d',[ErrorCount])+'</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%m',[ErrorAmount])+'</TD>'+
                     '    <TD align=''LEFT''>Invalid or Incomplete MICR, Invalid License, or low image quality</TD>'+
                     '</TR>');
         end;
         HTML.Add('<TR><TD ALIGN=''CENTER''></TD><TD>Transaction Count</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[ErrorCount + DCount + VCount + PCount + ECount])+'</TD>'+
                  '    <TD></TD>'+
                  '    <TD align=''LEFT''>All Transactions</TD>'+
                  '</TR>');
         HTML.Add('</TABLE><BR>');
         if (AExtraBreaksBetweenStoreCodes) then begin
            HTML.Add('<BR><BR>');
         end;
      end;
   end;
   procedure FormatXML;
   begin
      CSV.ADD('<CHECKHISTDETAIL>'+
                '<RNID>' + Trim(RNQuery.FieldByName('StoreCode').AsString) + '</RNID>');
      if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620
         CSV.Append('<AUTHDATE>' + FormatDateTime('MM/DD/YYYY',RNQuery.FieldByname('AuthDatetz').AsDateTime) + '</AUTHDATE>');
      end else begin
         CSV.Append('<AUTHDATE>' + FormatDateTime('MM/DD/YYYY', RNQuery.FieldByName('AuthDate').AsDateTime) + '</AUTHDATE>');
      end;
      CSV.ADD('<DISPLAYTEXT>' + Trim(RNQuery.FieldByName('DISPLAYTEXT').AsString) + '</DISPLAYTEXT>');
      CSV.ADD('<TRANAMT>' + Trim(StriReal(RNQuery.FieldByName('TranAmount').AsFloat,2)) + '</TRANAMT>');
      CSV.ADD('<UPDATEDAMT>' + Trim(StriReal(RNQuery.FieldByName('UpdatedAmount').AsFloat,2)) + '</UPDATEDAMT>');
      CSV.ADD('<RETURNCHECKFEE>' + Trim(StriReal(RNQuery.FieldByName('RETURNCHECKFEE').AsFloat,2)) + '</RETURNCHECKFEE>');

      If RNQuery.FieldByName('Voided').AsBoolean then
         CSV.ADD('<VOIDEDDATE>' + FormatDateTime('MM/DD/YYYY', RNQuery.FieldByName('VOIDEDDATE').AsDateTime) + '</VOIDEDDATE>');

      CSV.ADD('<CHECKTYPE>' + Trim(RNQuery.FieldByName('CHECKTYPE').AsString)+ '</CHECKTYPE>' +
                         '<AUTHCODE>' + Trim(RNQuery.FieldByName('APPROVALCODE').AsString)+ '</AUTHCODE>' +
                         '<ROUTINGNUMBER>' + Trim(RNQuery.FieldByName('ResponseTransitNumber').AsString)+ '</ROUTINGNUMBER>' +
                         '<CHECKNUMBER>' + Trim(RNQuery.FieldByName('ResponseCheckNumber').AsString)+ '</CHECKNUMBER>' +
                         '<TRACEID>' + Trim(RNQuery.FieldByName('TRACEID').AsString)+ '</TRACEID>' +
                         '<DENIALRECORDNUMBER>' + Trim(RNQuery.FieldByName('DENIALRECORDNUMBER').AsString)+ '</DENIALRECORDNUMBER>' +
                         '<CUSTIDENT>' + Trim(RNQuery.FieldByName('TranCustomerCode').AsString)+ '</CUSTIDENT>' +
                         '<STATIONIDENT>' + Trim(RNQuery.FieldByName('STATIONIDENT').AsString)+ '</STATIONIDENT>' +
                         '<TRANIDENT>' + Trim(RNQuery.FieldByName('TRANIDENT').AsString)+ '</TRANIDENT>' +
                         '<TCMID>' + Trim(RNQuery.FieldByName('TCMID').AsString)+ '</TCMID>' +
                         '<SYSTEMCODE>' + Trim(RNQuery.FieldByName('StoreSystemCode').AsString)+ '</SYSTEMCODE>' +
                         '<SERVICENAME>' + Trim(RNQuery.FieldByName('TCSERVICENAME').AsString)+ '</SERVICENAME>' +

                         '<STORENAME>' + StoreName+ '</STORENAME>' +
                         '<STORECITY>' + STORECITY+ '</STORECITY>' +
                         '<STORESTATE>' + STORESTATE+ '</STORESTATE>' +
                         '<STOREZIP>' + STOREZIP+ '</STOREZIP>');

    CSV.ADD('</CHECKHISTDETAIL>');

   end;
   procedure FormatXLS;
   begin
      If RNQuery.FieldByName('Voided').AsBoolean then begin
         LineAmt := 0;
      end;

      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEOLDXLSFORMAT', 'FALSE') = 'TRUE') OR
      (RNReg.RegGetValAsString('PMACCESS.USEOLDXLSFORMAT','FALSE') = 'TRUE') then begin //2018-05-10 bls: D#2595
         TabText.Clear();
         
         TabText.Append(RNQuery.FieldByName('StoreCode').AsString);

         if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620
            TabText.Append(RNQuery.FieldByname('AuthDatetz').AsString);
         end else begin
            TabText.Append(RNQuery.FieldByName('AuthDate').AsString);
         end;
         
         TabText.Append(Format('%m',[LineAmt]));
         TabText.Append(Trim(RNQuery.FieldByName('ResponseCheckNumber').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('DisplayText').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('ECATranStatus').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('TranIdent').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('TranCustomerCode').AsString));

         TabText.Append(Trim(RNQuery.FieldByName('BatchSerial').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('StationIdent').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('TCMID').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('TCServiceName').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('Name').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('City').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('State').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('ZIP').AsString));


         if IncludeEmpIdent then TabText.Append(Trim(RNQuery.FieldByName('TranEmployeeIdent').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('StoreSystemCode').AsString));

         if (RNQuery.FieldByName('Voided').AsBoolean) then begin
            TabText.Append(RNQuery.FieldByName('VoidedDate').AsString);
         end else begin
            TabText.Append('');
         end;
         if IncludeProfileFields then begin
            TabText.Append(CustomField1Value);
            TabText.Append(CustomField2Value);
            TabText.Append(CustomField3Value);
            TabText.Append(CustomField4Value);
            TabText.Append(CustomField5Value);
            TabText.Append(CustomField6Value);
         end;
         CSV.Append(TabText.DelimitedText);
         TabText.Clear();
      end else begin
         Row := xlsWorkSheet.AddRow;

         Row.AddCellString(RNQuery.FieldByName('StoreCode').AsString);

         if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620
            Row.AddCellString(FormatDateTime('MM/DD/YYYY HH:NN:SS',RNQuery.FieldByname('AuthDatetz').AsDateTime));
         end else begin
            Row.AddCellString(FormatDateTime('MM/DD/YYYY HH:NN:SS',RNQuery.FieldByName('AuthDate').AsDateTime));
         end;
            Row.AddCellString(Format('%m',[LineAmt]));
            Row.AddCellString(Trim(RNQuery.FieldByName('ResponseCheckNumber').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('DisplayText').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('ECATranStatus').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('TranIdent').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('TranCustomerCode').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('BatchSerial').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('StationIdent').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('TCMID').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('TCServiceName').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('Name').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('City').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('State').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('ZIP').AsString));


         if IncludeEmpIdent then Row.AddCellString(Trim(RNQuery.FieldByName('TranEmployeeIdent').AsString));
         Row.AddCellString(Trim(RNQuery.FieldByName('StoreSystemCode').AsString));

         if (RNQuery.FieldByName('Voided').AsBoolean) then begin
            Row.AddCellString(RNQuery.FieldByName('VoidedDate').AsString);
         end else begin
            Row.AddCellString('');
         end;
         if IncludeProfileFields then begin
            Row.AddCellString(CustomField1Value);
            Row.AddCellString(CustomField2Value);
            Row.AddCellString(CustomField3Value);
            Row.AddCellString(CustomField4Value);
            Row.AddCellString(CustomField5Value);
            Row.AddCellString(CustomField6Value);
         end;
      end;
   end;

   procedure FormatHTML;
   begin
      WS := '<TR><TD>' + RNQuery.FieldByName('StoreCode').AsString + '</TD>';

      if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620
         WS := WS + '    <TD>' + FormatDateTime('MM/DD/YYYY HH:NN:SS',RNQuery.FieldByname('AuthDatetz').AsDateTime)+  '</TD>';
      end else begin
         WS := WS + '    <TD>' + FormatDateTime('MM/DD/YYYY HH:NN:SS',RNQuery.FieldByName('AuthDate').AsDateTime) +  '</TD>';
      end;

      WS := WS + '    <TD align="Right">';

      If RNQuery.FieldByName('UpdatedAmount').AsFloat > 0 then
         WS := WS + '<IMG SRC="/Images/General/Refresh.gif" border="0">';

      If RNQuery.FieldByName('Voided').AsBoolean then begin
         WS := WS + '<DEL>Void ' + Format('%m',[LineAmt]) + '</DEL></TD>';
         inc(VCount);
         VAmount := VAmount +  LineAmt;
      end else begin
         WS := WS + Format('%m',[LineAmt]) + '</TD>';
         If TCKEffectiveStatus(RNQuery) = 1 then begin
            EAmount := EAmount + LineAmt;
            Inc(ECount);
         end else If TCKEffectiveStatus(RNQuery) = 0 then begin
            PAmount := PAmount + LineAmt;
            Inc(PCount);
         end else If TCKEffectiveStatus(RNQuery) in [3,4] then begin
            DAmount := DAmount + LineAmt;
            Inc(DCount);
         end else If TCKEffectiveStatus(RNQuery) = -1 then begin
            ErrorAmount := ErrorAmount + LineAmt;
            Inc(ErrorCount);
         end;

      end;

      WS := WS +'    <TD align="Right">' + RNQuery.FieldByName('ResponseCheckNumber').AsString + '</TD>' +
            '    <TD>' + ColorByECAStatus(TCKEffectiveStatus(RNQuery)) + RNQuery.FieldByName('DisplayText').AsString + '</Font></TD>' +
            '    <TD>' + RNQuery.FieldByName('ECATranStatus').AsString + '</TD>' +
            '    <TD align="CENTER">' + TCKStatusImage(RNQuery) + '</TD>' +
            '    <TD align="Right">' + RNQuery.FieldByName('TranIdent').AsString + '</TD>' +
            '    <TD align="Right">' + RNQuery.FieldByName('TranCustomerCode').AsString + '</TD>' +
            '    <TD>' + RNQuery.FieldByName('BatchSerial').AsString + '</TD>';
            if (RecordFormatType = ttrftAJAX) then begin
               WS := WS+ '<TD>' + Trim(RNQuery.FieldByName('StationIdent').AsString)+'</TD>';
            end else begin
               WS := WS+'    <TD>' + '<A HREF="PAYMENTMATE?RNID=' +RNID +
                                    '&FROMDATE='+ FormatDateTime('MM/DD/YYYY',FromDate) +
                                    '&THRUDATE='+FormatDateTime('MM/DD/YYYY',ThruDate) +
                                    '&STATIONIDENT='+ WebParamEncode(Trim(RNQuery.FieldByName('StationIdent').AsString))+
                                    '&SERVICENAME='+ WebParamEncode(ServiceName)+
                                    '&PAGE=CHECK&ACTION=CHECKQUERY&FORMAT=' + DisplayFormat +'">' +
                                    Trim(RNQuery.FieldByName('StationIdent').AsString)+'</A></TD>';
            end;
            WS := WS  + '    <TD>' + RNQuery.FieldByName('TCMID').AsString + '</TD>' ;
            if (RecordFormatType = ttrftAJAX) then begin
               WS := WS+ '<TD>' + Trim(RNQuery.FieldByName('TCServiceName').AsString)+'</TD>';
               if IncludeEmpIdent then WS := WS+ '<TD>' + Trim(RNQuery.FieldByName('TranEmployeeIdent').AsString)+'</TD>';
               WS := WS+ '<TD>' + Trim(RNQuery.FieldByName('StoreSystemCode').AsString)+'</TD>';
            end else begin
               WS := WS+ '<TD>' + '<A HREF="PAYMENTMATE?RNID=' +RNID +
                        '&FROMDATE='+ FormatDateTime('MM/DD/YYYY',FromDate) +
                        '&THRUDATE='+FormatDateTime('MM/DD/YYYY',ThruDate) +
                        '&STATIONIDENT='+ WebParamEncode(StationName)+
                        '&SERVICENAME='+ WebParamEncode(Trim(RNQuery.FieldByName('TCServiceName').AsString))+
                        '&PAGE=CHECK&ACTION=CHECKQUERY&FORMAT=' + DisplayFormat +'">' +
                        Trim(RNQuery.FieldByName('TCServiceName').AsString)+'</A></TD>';
            end;
            if (RecordFormatType <> ttrftAJAX) then
               WS := WS+  '    <TD Align="CENTER"><a href="PAYMENTMATE?PAGE=CHECK&ACTION=CHECKDETAILS&CHECKCODE=' + RNQuery.FieldByName('SystemCode').AsString +'">' +
                       '<IMG SRC="/Images/General/MagGlassSmall.gif" border="0"></A></TD>';
            WS := WS+ '</TR>';
      HTML.Add(WS);


   end;
begin
   TabText := TTTStringList.Create;
   If DisplayFormat = 'XML' then begin
      RecordFormatType := ttrftXML;
   end else If DisplayFormat = 'XLS'  then begin
      RecordFormatType := ttrftXLS;
   end else If DisplayFormat = 'AJAX'  then begin
      RecordFormatType := ttrftAJAX;
   end else begin
      RecordFormatType := ttrftHTML;
   end;
   Result := '';
   IncludeEmpIdent := false;
   IncludeProfileFields := false;

   CSV := TStringList.Create;
   HTML := TStringList.Create;
   RNIDList := TStringList.Create;
   DisplayInTZ := false;
   xlsWorkSheet := xExport.AddWorkSheet;
   DateRange := '';
   TabText.Delimiter := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/PREFERREDDELIMITER', TAB)[1]; //2018-05-10 bls: D#2595

   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/ALLOWALLSEARCH', 'FALSE') = 'TRUE' then AAllowAll := true;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL', '') <> '' then StoreSystemCodeLabel := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL'));  //2016-8-22 jtm: Feat OT#1038
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEEMPIDENT', 'FALSE') = 'TRUE' then IncludeEmpIdent := true;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEPROFILEFIELDS', 'FALSE') = 'TRUE' then IncludeProfileFields := true;

   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE') = 'TRUE') then DisplayInTZ := true; //2017-12-20 jtm: D#2620
   if not (DisplayInTZ) then begin
      if (RNReg.RegGetValAsString('PMACCESS.DISPLAYINTZ','FALSE') = 'TRUE') then begin //for APM
         DisplayInTZ := true;
      end;
   end;

   if ((AAllowAll) and (RNID = 'ALL')) then begin
      UsingAll := true;
      GetChainRNIDs(RNIDList);
   end else begin
      If NOT ValidateRNID(RNID)  then begin
         Result := 'Invalid Store Code';
         exit;
      end;
      UsingAll := false;
      RNIDList.Add(NumericOnly(RNID));
   end;

   RNQuery.Close;
   RNQuery.SQL.clear;
   RNQuery.SQL.Add(DRSQLVarsDec);

   if (DateRange = 'CUSTOM') or (DateRange = '')  then begin
      RNQuery.SQL.Add('set @BegDate = ''' + FormatDateTime('MM/DD/YYYY', Fromdate) + '''; set @EndDate =''' + FormatDateTime('MM/DD/YYYY', ThruDate + 1) + ''';');
   end else begin
      RNQuery.SQL.Add('set @DateRangeName = '''+DateRange+''';'+DRSQLSetBegDate + DRSQLSetEndDate);
   end;
   RNQuery.SQL.Add(DRSQLSetTZ);
   RNQuery.SQL.Add('set @BegDateHAST = DATEADD(hour,+'+HASTOffsetEST+',@BegDate);set @EndDateHAST = DATEADD(hour,+'+HASTOffsetEST+',@EndDate); ');

   RNQuery.SQL.Add('Select');
   if (DisplayInTZ) then begin
      RNQuery.SQL.Add('CASE r.KeyValue WHEN ''AST'' THEN DATEADD(hour,+1,tc.AuthDate) WHEN ''CST'' THEN DATEADD(hour,-1,tc.AuthDate) WHEN ''MST'' THEN DATEADD(hour,-2,tc.AuthDate) ');
      RNQuery.SQL.Add('WHEN ''PST'' THEN DATEADD(hour,-3,tc.AuthDate) WHEN ''AKST'' THEN DATEADD(hour,-4,tc.AuthDate)');
      RNQuery.SQL.Add('WHEN ''HAST'' THEN DATEADD(hour,-'+HASTOffsetEST+',tc.AuthDate) ELSE tc.AuthDate END authdatetz,');
   end;
   RNQuery.SQL.Add('S.SystemCode RNID, tc.*,s.Name,s.City,s.State,s.ZIP');
   RNQuery.SQL.Add('from TCAuth tc left outer join');
   RNQuery.SQL.Add('  Store s on tc.StoreCode = s.SystemCode');
   if (DisplayInTZ) then begin
      RNQuery.SQL.Add('left outer join REGISTRY r on r.SubKey1 = tc.storecode');
   end;
   RNQuery.SQL.Add('where (s.SystemCode in(' + RNIDList.CommaText + '))');

   if (DisplayInTZ) then begin
      RNQuery.SQL.Add('and r.subkey2 = ''storetz''');
      RNQuery.SQL.Add('and (Authdate >= case r.KeyValue WHEN ''AST'' THEN @BegDateAST WHEN ''CST'' THEN @BegDateCST WHEN ''MST'' THEN @BegDateMST WHEN ''PST'' THEN @BegDatePST WHEN ''AKST'' THEN @BegDateAKST WHEN ''HAST'' THEN @BegDateHAST ELSE @BegDate END)');  //figure out DST for AZ and HI
      RNQuery.SQL.Add('and (Authdate < case r.KeyValue WHEN ''AST'' THEN @EndDateAST WHEN ''CST'' THEN @EndDateCST WHEN ''MST'' THEN @EndDateMST WHEN ''PST'' THEN @EndDatePST WHEN ''AKST'' THEN @EndDateAKST WHEN ''HAST'' THEN @EndDateHAST ELSE @EndDate END)');
   end else begin
      RNQuery.SQL.Add('and (AuthDate >= @BegDate)');
      RNQuery.SQL.Add('and (AuthDate < @EndDate)');
   end;
   If ARequest.queryfields.Values['APPROVEDONLY'] = 'TRUE' then
      RNQuery.SQL.Add('AND (ECATranStatus in (''0'',''1''))');

   StationName := ValidCharsOnly(StationName,True,True,'-._ ');
   If length(StationName) > 20 then
      SetLength(StationName,20);
   If StationName <> '' then
      RNQuery.SQL.Add('And (StationIdent =''' + StationName + ''')');

   ServiceName := ValidCharsOnly(ServiceName,True,True,'-');
   If length(ServiceName) > 20 then
      SetLength(ServiceName,20);
   If ServiceName <> '' then
      RNQuery.SQL.Add('And (TCServiceName =''' + ServiceName + ''')');

   CHType := VarEvaluator.GetValueAsString('CHECKHISTTYPE');
   If CHType = '0' then
      RNQuery.SQL.Add('And (ECATranStatus =''0'') and (voided = 0)');
   If CHType = '1' then
      RNQuery.SQL.Add('And (ECATranStatus =''1'')and (voided = 0)');
   If CHType = '01' then
      RNQuery.SQL.Add('AND (ECATranStatus in (''0'',''1'')) and (voided = 0)');
   If CHType = '34' then
      RNQuery.SQL.Add('AND (ECATranStatus in (''3'',''4'')) and (voided = 0)');
   If CHType = 'VOID' then
      RNQuery.SQL.Add('AND (voided = 1)');



   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHEMPIDENT', 'FALSE') = 'TRUE') and (ValidCharsonly(ARequest.queryfields.Values['EMPIDENT'],True,True,'') <> '') then begin
      RNQuery.SQL.Add('And (TranEmployeeIdent LIKE ''' + ValidCharsonly(ARequest.queryfields.Values['EMPIDENT'],True,True,'') + '%'')');
   end;         
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHCUSTIDENT', 'FALSE') = 'TRUE') and (ValidCharsonly(Request.queryfields.Values['CUSTIDENT'],True,True,'.-_:/& ') <> '') then begin
      RNQuery.SQL.Add('And (TranCustomerCode LIKE ''' + ValidCharsonly(Request.queryfields.Values['CUSTIDENT'],True,True,'.-_:/& ') + '%'')'); //2017-05-10 jtm D#1605
   end;



   RNQuery.SQL.Add('Order by S.systemcode, tc.AuthDate');
   RNQuery.DisableControls;
   TADODataSet(RNQuery).CommandTimeout := 300;     //2016-10-05
   ProcessLog(ltDebug,'GetCheckQueryTable2 RNQuery.SQL.Text',RNQuery.SQL.Text);
   RNQuery.Open;

   I := 0;
   HTML.Clear;
   PreviousRNID := Null;
   while (not(RNQuery.EOF)) do begin
      if (PreviousRNID <> Trim(RNQuery.FieldByName('RNID').AsString)) then begin
         if (PreviousRNID <> Null) then begin  //finishing up an old RNID
            ProcessFooter;
         end;
         ProcessHeader(Trim(RNQuery.FieldByName('RNID').AsString), not(RNQuery.FieldByName('StoreCode').IsNull));
         PreviousRNID := Trim(RNQuery.FieldByName('RNID').AsString);
      end;
      if (RNQuery.FieldByName('StoreCode').IsNull) then begin
         RNQuery.Next;
         continue;
      end;
      inc(RNIDRecCount);
      Inc(I);
      LineAmt := RNQuery.FieldByName('TranAmount').AsFloat;
      If RNQuery.FieldByName('UpdatedAmount').AsFloat > 0 then
         LineAmt := RNQuery.FieldByName('UpdatedAmount').AsFloat;
      case RecordFormatType of
         ttrftXML:   FormatXML;
         ttrftXLS:   FormatXLS;
         ttrftHTML,
         ttrftAJAX:  FormatHTML
      end;
      RNQuery.Next;
   end;
   if (PreviousRNID <> Null) then begin  //Do the last footer
      ProcessFooter;
   end;

   case RecordFormatType of
      ttrftXML: begin
                  Result := CSV.Text;
                  Response.CustomHeaders.Values['Cache-Control'] := 'private';
                  Response.CustomHeaders.Values['Pragma'] := 'private';
               end;
      ttrftXLS: begin
                  Result := CSV.Text;
                  Response.CustomHeaders.Values['Cache-Control'] := 'private';
                  Response.CustomHeaders.Values['Pragma'] := 'private';
               end;
      ttrftHTML,
      ttrftAJAX: begin
                  Result := HTML.Text;
               end;
   end;


   HTML.Free;
   CSV.Free;
   TabText.Free; //2018-05-10 bls: D#2595
end;

Function TCustomerInfoModule.GetCardQueryTable(RNID : String;
                                                FromDate : TDateTime;
                                                ThruDate : TDateTime;
                                                BatchSerial : Integer;
                                                StationName : String;
                                                SaleType : String;
                                                StationIdent : String;
                                                DisplayFormat : String;
                                                SettledOnly : boolean;
                                                ShowLinks : boolean;
                                                isPaymentmate : boolean;
                                                xExport : TOExport;
                                                AAllowAll: Boolean = false;
                                                AExtraBreaksBetweenStoreCodes: Boolean = false;
                                                ASeparateStores : boolean = false) : String;
var
   WS : String;
   I : Integer;
   StoreInfo : String;
   TabText : TTTStringList;

   SaleVisaMC : Integer;
   SaleAMEX : Integer;
   SaleDISC : Integer;
   SaleQVisaMC : Integer;
   SaleQAMEX : Integer;
   SaleQDISC : Integer;
   SaleOTHR : Integer; //2017-11-16 jtm: D#1337
   SaleQOTHR : Integer;//2017-11-16 jtm: D#1337


   CreditVisaMC : Integer;
   CreditAMEX : Integer;
   CreditDISC : Integer;
   CreditQVisaMC : Integer;
   CreditQAMEX : Integer;
   CreditQDISC : Integer;
   CreditOTHR : Integer;//2017-11-16 jtm: D#1337
   CreditQOTHR : Integer;//2017-11-16 jtm: D#1337

   VoidVisaMC : Integer;
   VoidAMEX : Integer;
   VoidDISC : Integer;
   VoidQVisaMC : Integer;
   VoidQAMEX : Integer;
   VoidQDISC : Integer;
   VoidOTHR : Integer;//2017-11-16 jtm: D#1337
   VoidQOTHR : Integer;//2017-11-16 jtm: D#1337

   CRVoidVisaMC : Integer;
   CRVoidAMEX : Integer;
   CRVoidDISC : Integer;
   CRVoidQVisaMC : Integer;
   CRVoidQAMEX : Integer;
   CRVoidQDISC : Integer;
   CRVoidOTHR : Integer;//2017-11-16 jtm: D#1337
   CRVoidQOTHR : Integer;//2017-11-16 jtm: D#1337

   MaskAcct : String;

   WI : Integer;

   Line: TTTStringList;
   ReturnedRecs : integer;
   StartRow : integer;

   HTML : TStringList;
   CSV : TStringList;
   JSON : TStringList;
   GRID : TStringList; //2018-06-20 bls: F#840
   QueryBuilder, ParameterList : TStringList; //2018-06-20 bls: F#840
   RNIDList : TStringList; //2016-5-25 jtm
   IncludeServiceName : boolean;  //2016-3-28 jtm
   IncludeServiceNameDesc : boolean; //2018-01-25 ajs: F#2378
   Index : Integer; //2018-01-25 ajs: F#2378
   IncludeEmpIdent : boolean;
   IncludeCardHolderName : boolean;  //2016-5-10 jtm
   IncludeProfileFields : boolean;  //2016-7-28 jtm
   IncludeSFINDICATOR : boolean;
   IncludeCVVResp : boolean; //2018-3-14 ajs: F#3629
   IncludeAVSResp : boolean; //2018-3-14 ajs: F#3629
   IncludeAVSData : boolean; // 2019-06-15 tjr: DVST-564
   AVSDataHeader : string; // 2019-06-15 tjr: DVST-564
   IncludeProcessorToken: boolean;
   DisplayInAMPM : boolean;
   ExcludeExtraAmount : boolean;
   PreviousRNID : Variant;
   CustomField1Value, CustomField2Value, CustomField3Value, CustomField4Value, CustomField5Value, CustomField6Value : String;
   HTMLHeader : string;
   StoreSystemCodeLabel : string; //2016-8-08 jtm: Feat OT#1038
   OpenStopWatch: TStopWatch;
   RecordFormatType: TRecordFormatType;
   RNIDRecCount: Integer;
   UsingAll: Boolean;
   ServNameList : TStringList; //2017-05-10 jtm F#1565
   ServNameDescList : TStringList; //2018-01-25 ajs: F#2378
   ServiceNamesByRNID : integer;//2017-09-20 jtm: D#1946
   DisplayInTZ : boolean;
   DateRange : string; //2018-04-11 jtm: F#3540
   xlsWorkSheet : TExportWorksheet; //Represents actual xls worksheet
   Row : TExportRow; //Represents actual row inside the TExportWorksheet
   JSONString : string;

   TranIdentHeader : string;
   CustIdentHeader : string;
   DisplayStoreName : boolean; //2018-04-30 bls: F#1129
   posStart, count, totalCount, orderBy, direction : String; //2018-06-20 bls: F#840

   useJSONResp : boolean; //2018-07-18 bls: F#4978
   CCResults : TDataSet; //2018-07-18 bls: F#4978

   Procedure AddAmt(Var VisaMCInt : integer; Var AmexInt : integer; Var DiscInt : integer; Var OthrInt : integer;
                    Var VisaMCQInt : integer; Var AmexQInt : integer; Var DiscQInt : integer; Var OthrQInt : integer);
   Begin
      WI := Round(RNQuery.FieldByName('TranAmt').AsFloat *100);
      If (Trim(RNQuery.FieldByName('CardType').AsString) = 'VISA') or
         (Trim(RNQuery.FieldByName('CardType').AsString) = 'MC') then begin
         VisaMCInt := VISAMCInt + WI;
         Inc(VisaMCQInt);
      end else If (Trim(RNQuery.FieldByName('CardType').AsString) = 'AMEX') then begin
         AmexInt := AmexInt + WI;
         Inc(AmexQInt);
      end else If (Trim(RNQuery.FieldByName('CardType').AsString) = 'DISC') then begin
         DiscInt := DiscInt + WI;
         Inc(DiscQInt);
      end else if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEOTHERCARDTYPE', 'FALSE') = 'TRUE') then begin //2017-11-16 jtm: D#1337
         OthrInt := OthrInt + WI;
         Inc(OthrQInt);
      end;
   end;
   procedure GetProfileInfo(AStoreCode : String); //2017-05-10 jtm F#1696
   begin
      if (assigned(ProfileXML)) then begin
         FreeAndNil(ProfileXML);
      end;
      if AStoreCode <> '' then begin //2017-08-24 jtm: D#1872
         ProfileXML := TTProfileXML.Create(StrToInt(AStoreCode), HDQuery);
         CustomField1Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/VALUE', '');
         CustomField2Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/VALUE', '');
         CustomField3Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/VALUE', '');
         CustomField4Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/VALUE', '');
         CustomField5Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/VALUE', '');
         CustomField6Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/VALUE', '');
      end else begin
         CustomField1Value := '';
         CustomField2Value := '';
         CustomField3Value := '';
         CustomField4Value := '';
         CustomField5Value := '';
         CustomField6Value := '';
      end;
      if (assigned(RNProfileDI)) then begin //2017-12-20 jtm: D#2620
         FreeAndNil(RNProfileDI);
      end;
      if (assigned(RNProfile)) then begin
         FreeAndNil(RNProfile);
      end;
      RNProfileDI := TTADODataLayer.Create(RNDB);
      RNProfile := TTProfile.Create(AStoreCode,false, RNProfileDI);

   end;
   procedure ProcessHeader(AStoreCode: String; ADetailRecsExists: Boolean);
   var
      iterator : integer;
      storeName, thisRNID : string;
   begin
      processlog(ltInfo, 'GetCardQueryTable ProcessHeader', AStoreCode);
      RNIDRecCount := 0;
      SaleVisaMC := 0;
      SaleAMEX := 0;
      SaleDISC := 0;
      SaleQVisaMC := 0;
      SaleQAMEX := 0;
      SaleQDISC := 0;
      SaleOTHR := 0;
      SaleQOTHR := 0;

      CreditVisaMC := 0;
      CreditAMEX := 0;
      CreditDISC := 0;
      CreditQVisaMC := 0;
      CreditQAMEX := 0;
      CreditQDISC := 0;
      CreditOTHR := 0;
      CreditQOTHR := 0;

      VoidVisaMC := 0;
      VoidAMEX := 0;
      VoidDISC := 0;
      VoidQVisaMC := 0;
      VoidQAMEX := 0;
      VoidQDISC := 0;
      VoidOTHR := 0;
      VoidQOTHR := 0;

      CRVoidVisaMC := 0;
      CRVoidAMEX := 0;
      CRVoidDISC := 0;
      CRVoidQVisaMC := 0;
      CRVoidQAMEX := 0;
      CRVoidQDISC := 0;
      CRVoidOTHR := 0;
      CRVoidQOTHR := 0;

      CustomField1Value := '';
      CustomField2Value := '';
      CustomField3Value := '';
      CustomField4Value := '';
      CustomField5Value := '';
      CustomField6Value := '';

      storeName := '';
      thisRNID := trim(RNID);
      if AStoreCode <> '' then begin  //2017-05-10 jtm F#1696
         StoreInfo := GetStoreInfo(Valu(AStoreCode));
         thisRNID := trim(AStoreCode);
      end else if UsingAll then begin
         StoreInfo := '';
      end else begin
         StoreInfo := GetStoreInfo(Valu(RNID));
      end;

      if DisplayStoreName then begin //2018-04-30 bls: F#1129
         storeName := '  <TD><B>Store Name</B></TD>';
      end;

      if (RecordFormatType in [ttrftHTML, ttrftAJAX]) then begin
         WS := 'Card Authorizations from ' + FormatDateTime('MM/DD/YYYY',Fromdate) + ' Thru ' +FormatDateTime('MM/DD/YYYY',Thrudate) + ' <BR><B>' + thisRNID + '<BR>' + StoreInfo + '</B><BR>'  ;
         HTML.Add(WS);
         if (ADetailRecsExists) then begin
            HTMLHeader := '<TABLE border="1" cellspacing="0" cellpadding="3" bordercolorlight="#0000FF" style="border-collapse: collapse; font-size:7pt;font-family:veranda">' +
                     '<TR><TD><B>RNID</B></TD>'+
                     storeName + //2018-04-30 bls: F#1129
                     '    <TD><B>Auth Date</B></TD>'+
                     '    <TD><B>Type</B></TD>'+
                     '    <TD Align="Right"><B>Amount</B></TD>'+
                     '    <TD colspan=2><B>Auth Code</B></TD>'+
                     '    <TD><B>Batch Date</B></TD>'+
                     '    <TD><B>Batch ID</B></TD>'+
                     '    <TD><B>Type</B></TD>'+
                     '    <TD><B>Card Acct</B></TD>'+
                     '    <TD><B>' + TranIdentHeader + '</B></TD>'+ //2018-4-24 bls: F#3735
                     '    <TD><B>' + CustIdentHeader + '</B></TD>'; //2018-4-24 bls: F#3735
            if IncludeServiceName then HTMLHeader := HTMLHeader + '    <TD><B>Service Name</B></TD>';
            if IncludeEmpIdent then HTMLHeader := HTMLHeader + '    <TD><B>Emp Ident</B></TD>';
            if IncludeCardHolderName then HTMLHeader := HTMLHeader + '    <TD><B>CardName</B></TD>';
            if IncludeSFINDICATOR then HTMLHeader := HTMLHeader + '    <TD><B>SF</B></TD>';
            if IncludeCVVResp then HTMLHeader := HTMLHeader + '    <TD><B>CVVResp</B></TD>'; //2018-3-14 ajs: F#3629
            if IncludeAVSResp then HTMLHeader := HTMLHeader + '    <TD><B>AVSResp</B></TD>'; //2018-3-14 ajs: F#3629
            if IncludeAVSData then HTMLHeader := HTMLHeader + '    <TD><B>' + AVSDataHeader + '</B></TD>'; // 2019-06-15 tjr: DVST-564
            if IncludeProcessorToken then HTMLHeader := HTMLHeader + '<TD><STRONG>Processor Token</STRONG></TD>';
            HTMLHeader := HTMLHeader + '    <TD><B>EntryMode</B></TD>'+
                     '    <TD><B>Station</B></TD>';
            if StoreSystemCodeLabel <> '' then
               HTMLHeader := HTMLHeader +  '  <TD><B>'+ StoreSystemCodeLabel +'</B></TD>'
            else
               HTMLHeader := HTMLHeader + '  <TD><B>Item Serial</B></TD>';

            HTML.Add(HTMLHeader+ '</TR>');
         end;
      end;

      If (RecordFormatType = ttrftXLS) and (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEREPORTHEADERS', 'FALSE') = 'TRUE') then begin   //2016-3-28 jtm
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEOLDXLSFORMAT', 'FALSE') = 'TRUE') OR
         (RNReg.RegGetValAsString('PMACCESS.USEOLDXLSFORMAT','FALSE') = 'TRUE') then begin //2018-05-10 bls: D#2595
            if (ADetailRecsExists) then begin
               TabText.Append('RNID');

               if DisplayStoreName then begin  //2018-30-2018 bls: F#1129
                  TabText.Append('Store Name');
               end;

               TabText.Append('Auth Date');
               TabText.Append('Type');
               TabText.Append('Amount');

               if not ExcludeExtraAmount then TabText.Append('Amount');

               TabText.Append('Auth Code');
               TabText.Append('Non Auth Resp');
               TabText.Append('Batch Date');
               TabText.Append('Batch ID');
               TabText.Append('Type');
               TabText.Append('Card Acct');
               TabText.Append(TranIdentHeader);
               TabText.Append(CustIdentHeader);
               TabText.Append('Station');

               if StoreSystemCodeLabel <> '' then
                  TabText.Append(StoreSystemCodeLabel)
               else
                  TabText.Append('Station Code');
                  TabText.Append('Store Name');
                  TabText.Append('Store City');
                  TabText.Append('Store State');
                  TabText.Append('Store ZIP');

               TabText.Append('Entry Mode');
               if IncludeServiceName then TabText.Append('Service Name');
               if IncludeEmpIdent then TabText.Append('Employee Ident');
               if IncludeCardHolderName then TabText.Append('Card Holder Name');
               if IncludeSFINDICATOR then TabText.Append('SF');
               if IncludeCVVResp then TabText.Append('CVVRESP'); //2018-3-14 ajs: F#3629
               if IncludeAVSResp then TabText.Append('AVSRESP'); //2018-3-14 ajs: F#3629
               if IncludeAVSData then TabText.Append(AVSDataHeader); // 2019-06-15 tjr: DVST-564
               if IncludeProcessorToken then TabText.Add('Processor Token');
               if IncludeProfileFields then begin
                  ProcessLog(ltDebug,'ProcessHeaders StoreCode',AStoreCode);
                  if (AStoreCode = '') then AStoreCode := Trim(RNQuery.FieldByName('StoreCode').AsString);//2018-02-14 jtm: D#3794 //if we don't have a store code, then we might be searching using all, so let's just use the first RNID
                  ProcessLog(ltDebug,'ProcessHeaders StoreCode after',AStoreCode);
                  if ProfileXML = nil then GetProfileInfo(AStoreCode); //2017-05-24 jtm D#1688
                  TabText.Append(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/NAME', ''));
                  TabText.Append(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/NAME', ''));
                  TabText.Append(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/NAME', ''));
                  TabText.Append(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/NAME', ''));
                  TabText.Append(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/NAME', ''));
                  TabText.Append(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/NAME', ''));
               end;
               CSV.Append(TabText.DelimitedText);
               TabText.Clear();
            end;
         end else begin
            if (ADetailRecsExists) then begin
               Row := xlsWorkSheet.AddRow;
               Row.AddCellString('RNID');

               if DisplayStoreName then begin  //2018-30-2018 bls: F#1129
                  Row.AddCellString('Store Name');
               end;

               Row.AddCellString('Auth Date');
               Row.AddCellString('Type');
               Row.AddCellString('Amount');

               if not ExcludeExtraAmount then Row.AddCellString('Amount');

               Row.AddCellString('Auth Code');
               Row.AddCellString('Non Auth Resp');
               Row.AddCellString('Batch Date');
               Row.AddCellString('Batch ID');
               Row.AddCellString('Type');
               Row.AddCellString('Card Acct');
               Row.AddCellString(TranIdentHeader); //2018-4-24 bls: F#3735
               Row.AddCellString(CustIdentHeader); //2018-4-24 bls: F#3735
               Row.AddCellString('Station');

               if StoreSystemCodeLabel <> '' then
                  Row.AddCellString(StoreSystemCodeLabel)
               else
                  Row.AddCellString('Station Code');
                  Row.AddCellString('Store Name');
                  Row.AddCellString('Store City');
                  Row.AddCellString('Store State');
                  Row.AddCellString('Store ZIP');

               Row.AddCellString('Entry Mode');
               if IncludeServiceName then Row.AddCellString('Service Name');
               if IncludeEmpIdent then Row.AddCellString('Employee Ident');
               if IncludeCardHolderName then Row.AddCellString('Card Holder Name');
               if IncludeSFINDICATOR then Row.AddCellString('SF');
               if IncludeCVVResp then Row.AddCellString('CVVRESP' + #9); //2018-3-14 ajs: F#3629
               if IncludeAVSResp then Row.AddCellString('AVSRESP' + #9); //2018-3-14 ajs: F#3629
               if IncludeAVSData then Row.AddCellString(AVSDataHeader + #9); // 2019-06-15 tjr: DVST-564
               if IncludeProcessorToken then Row.AddCellString('Processor Token');
               if IncludeProfileFields then begin
                  ProcessLog(ltDebug,'ProcessHeaders StoreCode',AStoreCode);
                  if (AStoreCode = '') then AStoreCode := Trim(RNQuery.FieldByName('StoreCode').AsString);//2018-02-14 jtm: D#3794 //if we don't have a store code, then we might be searching using all, so let's just use the first RNID
                  ProcessLog(ltDebug,'ProcessHeaders StoreCode after',AStoreCode);
                  if ProfileXML = nil then GetProfileInfo(AStoreCode); //2017-05-24 jtm D#1688
                  Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/NAME', ''));
                  Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/NAME', ''));
                  Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/NAME', ''));
                  Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/NAME', ''));
                  Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/NAME', ''));
                  Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/NAME', ''));
               end;

               For iterator := 0 to Row.Cells.Count - 1 do begin
                  Row.Cells.Items[iterator].SetFontColor(clBlack).SetBorder(cbBottom).SetBGColor(TColor($80000000)).SetAlignment(cahCenter);
               end;
            end;
         end;
      end;
   end;
   procedure ProcessFooter;
   begin
      processlog(ltInfo, 'GetCardQueryTable ProcessFooter', String(PreviousRNID) + ' RecordCount=' + StrI(RNIDRecCount, -1));

      if (RecordFormatType in [ttrftHTML, ttrftAJAX]) then begin
         HTML.Add('</TABLE>');


         HTML.Add('<BR><BR>' +
                  '<TABLE border="1" cellspacing="0" cellpadding="3" bordercolorlight="#0000FF" style="border-collapse: collapse">'+
                  '<TR><TD ALIGN=''CENTER''><B>TOTALS</B></TD>'+
                  '    <TD ALIGN=''CENTER'' colspan=2><B>VISA/MC</B></TD>'+
                  '    <TD ALIGN=''CENTER'' colspan=2><B>AMEX</B></TD>'+
                  '    <TD ALIGN=''CENTER'' colspan=2><B>DISC</B></TD>');
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEOTHERCARDTYPE', 'FALSE') = 'TRUE') then begin
            HTML.Add('    <TD ALIGN=''CENTER'' colspan=2><B>OTHER</B></TD>');
         end;
         HTML.Add('    <TD ALIGN=''CENTER'' colspan=2><B>All Cards</B></TD>'+
                  '</TR>'+
                  '<TR><TD><B><IMG SRC="/Images/General/CheckSuccess.gif" border="0"> Sale</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[SaleQVisaMC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[SaleVisaMC/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[SaleQAMEX])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[SaleAMEX/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[SaleQDISC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[SaleDISC/100])+'</TD>');

         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEOTHERCARDTYPE', 'FALSE') = 'TRUE') then begin
            HTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[SaleQOthr])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[SaleOthr/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[SaleQVisaMC + SaleQAMEX+SaleQDISC+SaleQOthr])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[(SaleVisaMC + SaleAMEX +SaleDISC+SaleOthr)/100])+'</TD>');
         end else begin
            HTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[SaleQVisaMC + SaleQAMEX+SaleQDISC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[(SaleVisaMC + SaleAMEX +SaleDISC)/100])+'</TD>');
         end;

         HTML.Add('</TR>'+
                  '<TR><TD><B><IMG SRC="/Images/General/CashSmall.gif" border="0"> Credit</B></TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[CreditQVisaMC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[CreditVisaMC/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[CreditQAMEX])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[CreditAMEX/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[CreditQDISC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[CreditDISC/100])+'</TD>');
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEOTHERCARDTYPE', 'FALSE') = 'TRUE') then begin
            HTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[CreditQOthr])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[CreditOthr/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[CreditQVisaMC + CreditQAMEX+CreditQDISC+CreditQOthr])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[(CreditVisaMC + CreditAMEX +CreditDISC+CreditOthr)/100])+'</TD>' +
                  '</TR>'+
                  '<TR><TD><B><IMG SRC="/Images/General/CashSmall.gif" border="0"> NET</B></TD>'+
                  '    <TD colspan="8"></TD>'+ //spacer
                  '    <TD align=''RIGHT''>'+ Format('%d',[SaleQVisaMC + SaleQAMEX+SaleQDISC +SaleQOthr+ CreditQVisaMC + CreditQAMEX+CreditQDISC+CreditQOthr])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[((SaleVisaMC + SaleAMEX +SaleDISC+SaleOthr) - (CreditVisaMC + CreditAMEX +CreditDISC+CreditOthr))/100])+'</TD>'+

                  '</TR>');
         end else begin
            HTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[CreditQVisaMC + CreditQAMEX+CreditQDISC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[(CreditVisaMC + CreditAMEX +CreditDISC)/100])+'</TD>'+
                  '</TR>'+
                  '<TR><TD><B><IMG SRC="/Images/General/CashSmall.gif" border="0"> NET</B></TD>'+
                  '    <TD colspan="6"></TD>'+ //spacer
                  '    <TD align=''RIGHT''>'+ Format('%d',[SaleQVisaMC + SaleQAMEX+SaleQDISC + CreditQVisaMC + CreditQAMEX+CreditQDISC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[((SaleVisaMC + SaleAMEX +SaleDISC) - (CreditVisaMC + CreditAMEX +CreditDISC))/100])+'</TD>'+
                  '</TR>');
         end;
         HTML.Add('<TR><TD><B><IMG SRC="/Images/General/YellowExclamation.gif" border="0"> Voids</B></TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[VoidQVisaMC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[VoidVisaMC/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[VoidQAMEX])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[VoidAMEX/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[VoidQDISC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[VoidDISC/100])+'</TD>');
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEOTHERCARDTYPE', 'FALSE') = 'TRUE') then begin
            HTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[VoidQOthr])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[VoidOthr/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[VoidQVisaMC + VoidQAMEX+VoidQDISC+VoidQOthr])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[(VoidVisaMC + VoidAMEX +VoidDISC+VoidOthr)/100])+'</TD>');
         end else begin
            HTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[VoidQVisaMC + VoidQAMEX+VoidQDISC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[(VoidVisaMC + VoidAMEX +VoidDISC)/100])+'</TD>');
         end;

         if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDECREDITVOIDROW', 'FALSE')) then begin
            HTML.Add('<TR><TD><B><IMG SRC="/Images/General/YellowExclamation.gif" border="0"> Credit Voids</B></TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%d',[CRVoidQVisaMC])+'</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%m',[CRVoidVisaMC/100])+'</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%d',[CRVoidQAMEX])+'</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%m',[CRVoidAMEX/100])+'</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%d',[CRVoidQDISC])+'</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%m',[CRVoidDISC/100])+'</TD>');
            if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEOTHERCARDTYPE', 'FALSE') = 'TRUE') then begin
               HTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[CRVoidQOthr])+'</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%m',[CRVoidOthr/100])+'</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%d',[CRVoidQVisaMC + CRVoidQAMEX+CRVoidQDISC+CRVoidQOthr])+'</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%m',[(CRVoidVisaMC + CRVoidAMEX +CRVoidDISC+CRVoidOthr)/100])+'</TD>');
            end else begin
               HTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[CRVoidQVisaMC + CRVoidQAMEX+CRVoidQDISC])+'</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%m',[(CRVoidVisaMC + CRVoidAMEX +CRVoidDISC)/100])+'</TD>');
            end;
         end;

         HTML.Add('</TR>'+
                  '</TABLE><BR>');
         if (AExtraBreaksBetweenStoreCodes) then begin
            HTML.Add('<BR><BR>');
         end;
      end;
   end;
   procedure FormatXML;
   begin
      TabText.Clear;
      TabText.Append('<TRANHISTDETAIL>'+
                   '<RNID>' + Trim(RNQuery.FieldByName('StoreCode').AsString) + '</RNID>');
      if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620 //2018-04-11 jtm: F#3664 removed
         TabText.Append('<AUTHDATE>' + FormatDateTime('MM/DD/YYYY',RNQuery.FieldByname('AuthDatetz').AsDateTime) + '</AUTHDATE>');
      end else begin
         TabText.Append('<AUTHDATE>' + FormatDateTime('MM/DD/YYYY', RNQuery.FieldByName('AuthDate').AsDateTime) + '</AUTHDATE>');
      end;

       TabText.Append('<TRANTYPE>CARD</TRANTYPE>' +
                   '<SALETYPE>' + Trim(RNQuery.FieldByName('SALETYPE').AsString) + '</SALETYPE>');
       If RNQuery.FieldByName('CaptureFlag').AsBoolean then
         TabText.Append('<SETTLED>TRUE</SETTLED>')
       else
         TabText.Append('<SETTLED>FALSE</SETTLED>');

       If (Trim(RNQuery.FieldByName('SaleType').AsString) = 'CREDIT') or (Trim(RNQuery.FieldByName('SaleType').AsString) = 'REFUND') then begin   //2017-11-16 jtm: D#2021
         TabText.Append('<TRANAMT>' + '-' + Trim(StriReal(RNQuery.FieldByName('TranAmt').AsFloat,2)) +'</TRANAMT>');
       end else begin
         TabText.Append('<TRANAMT>' + Trim(StriReal(RNQuery.FieldByName('TranAmt').AsFloat,2)) + '</TRANAMT>');
       end;
       MaskAcct := '';
       if (Trim(RNQuery.FieldByName('CardAcct').AsString) <> '') then begin  //2017-12-20 jtm: F#2430
          if (Trim(RNQuery.FieldByName('ProcessorToken').AsString) <> '') then begin  //card number sent in, but either tokenized or not
            MaskAcct := MaskStr(Trim(RNQuery.FieldByName('ProcessorToken').AsString),DigitsToMask(Trim(RNQuery.FieldByName('ProcessorToken').AsString)));
            MaskAcct := '*..*' + NumericOnly(MaskAcct);
          end else begin
            MaskAcct := Trim(RNQuery.FieldByName('CardAcct').AsString);
            MaskAcct := 'X..X' + NumericOnly(MaskAcct);
          end;
       end else if (Trim(RNQuery.FieldByName('CardAcct').AsString) = '')  and (Trim(RNQuery.FieldByName('ProcessorToken').AsString) <> '') then begin //token passed directly
         MaskAcct := MaskStr(Trim(RNQuery.FieldByName('ProcessorToken').AsString),DigitsToMask(Trim(RNQuery.FieldByName('ProcessorToken').AsString)));
         MaskAcct := '#..#' + NumericOnly(MaskAcct);
       end;

       TabText.Append('<CARDACCT>' + Trim(MaskAcct)+ '</CARDACCT>' +
                            '<AUTHCODE>' + Trim(RNQuery.FieldByName('AUTHCODE').AsString)+ '</AUTHCODE>' +
                            '<NONAUTHRESP>' + Trim(RNQuery.FieldByName('NONAUTHRESP').AsString)+ '</NONAUTHRESP>' +
                            '<BATCHDATE>' + FormatDateTime('MM/DD/YYYY', RNQuery.FieldByName('BATCHDATE').AsDateTime)+ '</BATCHDATE>');

       if (DisplayInTZ) then begin //2018-11-14
         TabText.Append('<BATCHDATE>' + FormatDateTime('MM/DD/YYYY',RNQuery.FieldByname('BATCHDATEtz').AsDateTime) + '</BATCHDATE>');
       end else begin
         TabText.Append('<BATCHDATE>' + FormatDateTime('MM/DD/YYYY', RNQuery.FieldByName('BATCHDATE').AsDateTime) + '</BATCHDATE>');
       end;
        TabText.Append('<BATCHID>' + Trim(RNQuery.FieldByName('BATCHID').AsString)+ '</BATCHID>' +
                            '<CARDTYPE>' + Trim(RNQuery.FieldByName('CARDTYPE').AsString)+ '</CARDTYPE>' +
                            '<TRANIDENT>' + Trim(RNQuery.FieldByName('TRANIDENT').AsString)+ '</TRANIDENT>' +
                            '<CUSTIDENT>' + Trim(RNQuery.FieldByName('TranCustomerCode').AsString)+ '</CUSTIDENT>' +
                            '<STATIONIDENT>' + Trim(RNQuery.FieldByName('STATIONIDENT').AsString)+ '</STATIONIDENT>' +
                            '<SYSTEMCODE>' + Trim(RNQuery.FieldByName('StoreSystemCode').AsString)+ '</SYSTEMCODE>' +
                            '<STORENAME>' + StoreName+ '</STORENAME>' +
                            '<STORECITY>' + STORECITY+ '</STORECITY>' +
                            '<STORESTATE>' + STORESTATE+ '</STORESTATE>' +
                            '<STOREZIP>' + STOREZIP+ '</STOREZIP>');
       TabText.Append('<ENTRYMODE>' + GetCCTranEntryModeDisplayCode(RNQuery.FieldByName('TranEntryMode').AsString) + '</ENTRYMODE>');
       TabText.Append('</TRANHISTDETAIL>');
       CSV.Add(TabText.ToString);
   end;
   procedure FormatXLS;
   begin
      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEOLDXLSFORMAT', 'FALSE') = 'TRUE') OR
      (RNReg.RegGetValAsString('PMACCESS.USEOLDXLSFORMAT','FALSE') = 'TRUE') then begin //2018-05-10 bls: D#2595
         TabText.Append(Trim(RNQuery.FieldByName('StoreCode').AsString));

         if DisplayStoreName then begin //2018-30-2018 bls: F#1129
            TabText.Append(Trim(RNQuery.FieldByName('NAME').AsString));
         end;

         if (DisplayInTZ) then begin //2018-04-11 jtm: F#3664 removed
            TabText.Append(RNQuery.FieldByname('AuthDatetz').AsString);
         end else begin
            TabText.Append(RNQuery.FieldByName('AuthDate').AsString);
         end;

         TabText.Append(Trim(RNQuery.FieldByName('SaleType').AsString));
         If (Trim(RNQuery.FieldByName('SaleType').AsString) = 'CREDIT') or (Trim(RNQuery.FieldByName('SaleType').AsString) = 'REFUND') or (Trim(RNQuery.FieldByName('SaleType').AsString) = 'CRVOID') then begin
           TabText.Append('-' + Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat]));
         end else begin
           TabText.Append(Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat]));
         end;
         if not ExcludeExtraAmount then TabText.Append(Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat]));
         MaskAcct := '';
         if (Trim(RNQuery.FieldByName('CardAcct').AsString) <> '') then begin  //2017-12-20 jtm: F#2430
            if (Trim(RNQuery.FieldByName('ProcessorToken').AsString) <> '') then begin  //card number sent in, but either tokenized or not
               MaskAcct := MaskStr(Trim(RNQuery.FieldByName('ProcessorToken').AsString),DigitsToMask(Trim(RNQuery.FieldByName('ProcessorToken').AsString)));
               MaskAcct := '*..*' + NumericOnly(MaskAcct);
            end else begin
               MaskAcct := Trim(RNQuery.FieldByName('CardAcct').AsString);
               MaskAcct := 'X..X' + NumericOnly(MaskAcct);
            end;
         end else if (Trim(RNQuery.FieldByName('CardAcct').AsString) = '')  and (Trim(RNQuery.FieldByName('ProcessorToken').AsString) <> '') then begin //token passed directly
            MaskAcct := MaskStr(Trim(RNQuery.FieldByName('ProcessorToken').AsString),DigitsToMask(Trim(RNQuery.FieldByName('ProcessorToken').AsString)));
            MaskAcct := '#..#' + NumericOnly(MaskAcct);
         end;

         TabText.Append(Trim(RNQuery.FieldByName('AuthCode').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('NonAuthResp').AsString));

         if (DisplayInTZ) then begin
            TabText.Append(RNQuery.FieldByname('BatchDatetz').AsString);
         end else begin
            TabText.Append(RNQuery.FieldByName('BatchDate').AsString);
         end;
         TabText.Append(Trim(RNQuery.FieldByName('BatchID').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('CardType').AsString));
         TabText.Append(MaskAcct);
         TabText.Append(Trim(RNQuery.FieldByName('TranIdent').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('TranCustomerCode').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('StationIdent').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('StoreSystemCode').AsString));

         TabText.Append(Trim(RNQuery.FieldByName('Name').AsString));
         TabText.Append(Trim(RNQuery.FieldByName('City').AsString));
         TabText.Append(RNQuery.FieldByName('State').AsString);
         TabText.Append(RNQuery.FieldByName('ZIP').AsString);

         TabText.Append(GetCCTranEntryModeDisplayCode(RNQuery.FieldByName('TranEntryMode').AsString));

         if IncludeServiceName then begin //2018-01-25 ajs: F#2378
            if IncludeServiceNameDesc then begin
               Index :=  ServNameList.IndexOf(trim(RNQuery.FieldByName('CCServiceName').AsString));
               if (Index = -1) then begin
                  TabText.Append(Trim(RNQuery.FieldByName('CCServiceName').AsString));
               end else begin
                  TabText.Append((ServNameDescList[Index]));
               end;
            end else begin
               TabText.Append(Trim(RNQuery.FieldByName('CCServiceName').AsString));
            end;
         end;
         if IncludeEmpIdent then TabText.Append(Trim(RNQuery.FieldByName('TranEmployeeIdent').AsString));
         if IncludeCardHolderName then TabText.Append(Trim(RNQuery.FieldByName('CardName').AsString));
         if IncludeSFINDICATOR then begin
            if (Trim(RNQuery.FieldByName('SFTranGUID').AsString) <> '') then begin
               TabText.Append('X');
            end else begin
               TabText.Append(' ');
            end;
         end;
         if IncludeCVVResp then TabText.Append(Trim(RNQuery.FieldByName('CVVResp').AsString)); //2018-3-14 ajs: F#3629
         if IncludeAVSResp then TabText.Append(Trim(RNQuery.FieldByName('AVSResp').AsString)); //2018-3-14 ajs: F#3629
         if IncludeAVSData then TabText.Append(Trim(RNQuery.FieldByName('AVSData').AsString)); // 2019-06-15 tjr: DVST-564
         if IncludeProcessorToken then TabText.Add(Trim(RNQuery.FieldByName('ProcessorToken').AsString));
         if IncludeProfileFields then begin
            TabText.Append(CustomField1Value);
            TabText.Append(CustomField2Value);
            TabText.Append(CustomField3Value);
            TabText.Append(CustomField4Value);
            TabText.Append(CustomField5Value);
            TabText.Append(CustomField6Value);
         end;
         CSV.Append(TabText.DelimitedText);
         TabText.Clear();
      end else begin
         Row := xlsWorkSheet.AddRow;
         Row.AddCellString(Trim(RNQuery.FieldByName('StoreCode').AsString)).SetCalculateColWidth;;

         if DisplayStoreName then begin //2018-30-2018 bls: F#1129
            Row.AddCellString(Trim(RNQuery.FieldByName('NAME').AsString));
         end;

         if (DisplayInTZ) then begin //2018-04-11 jtm: F#3664 removed
            if DisplayInAMPM then begin
               Row.AddCellString(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByname('AuthDatetz').AsDateTime)).SetCalculateColWidth;
            end else begin
               Row.AddCellString(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('AuthDatetz').AsDateTime)).SetCalculateColWidth;
            end;
         end else begin
            Row.AddCellString(FormatDateTime('MM/DD/YYYY HH:NN:SS',RNQuery.FieldByName('AuthDate').AsDateTime)).SetCalculateColWidth;
         end;
         Row.AddCellString(Trim(RNQuery.FieldByName('SaleType').AsString)).SetCalculateColWidth;
         If (Trim(RNQuery.FieldByName('SaleType').AsString) = 'CREDIT') or (Trim(RNQuery.FieldByName('SaleType').AsString) = 'REFUND') then begin
           Row.AddCellString('-' + Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat])).SetCalculateColWidth;
         end else begin
           Row.AddCellString(Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat])).SetCalculateColWidth;
         end;
         if not ExcludeExtraAmount then Row.AddCellString(Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat])).SetCalculateColWidth;//Row.AddCellNumber(RNQuery.FieldByName('TranAmt').AsFloat).SetCalculateColWidth; //TabText.Append(Trim(StriReal(RNQuery.FieldByName('TranAmt').AsFloat,2)) + #9);

         MaskAcct := '';
         if (Trim(RNQuery.FieldByName('CardAcct').AsString) <> '') then begin  //2017-12-20 jtm: F#2430
            if (Trim(RNQuery.FieldByName('ProcessorToken').AsString) <> '') then begin  //card number sent in, but either tokenized or not
               MaskAcct := MaskStr(Trim(RNQuery.FieldByName('ProcessorToken').AsString),DigitsToMask(Trim(RNQuery.FieldByName('ProcessorToken').AsString)));
               MaskAcct := '*..*' + NumericOnly(MaskAcct);
            end else begin
               MaskAcct := Trim(RNQuery.FieldByName('CardAcct').AsString);
               MaskAcct := 'X..X' + NumericOnly(MaskAcct);
            end;
         end else if (Trim(RNQuery.FieldByName('CardAcct').AsString) = '')  and (Trim(RNQuery.FieldByName('ProcessorToken').AsString) <> '') then begin //token passed directly
            MaskAcct := MaskStr(Trim(RNQuery.FieldByName('ProcessorToken').AsString),DigitsToMask(Trim(RNQuery.FieldByName('ProcessorToken').AsString)));
            MaskAcct := '#..#' + NumericOnly(MaskAcct);
         end;

         Row.AddCellString(Trim(RNQuery.FieldByName('AuthCode').AsString));
         Row.AddCellString(Trim(RNQuery.FieldByName('NonAuthResp').AsString)).SetWidth(100);

         if (DisplayInTZ) then begin //2018-11-14 jtm:
            if DisplayInAMPM then begin
               Row.AddCellString(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByname('BatchDatetz').AsDateTime)).SetCalculateColWidth;
            end else begin
               Row.AddCellString(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('BatchDatetz').AsDateTime)).SetCalculateColWidth;
            end;
         end else begin
            Row.AddCellString(FormatDateTime('MM/DD/YYYY HH:NN:SS',RNQuery.FieldByName('BatchDate').AsDateTime)).SetCalculateColWidth;
         end;

         Row.AddCellString(Trim(RNQuery.FieldByName('BatchID').AsString)).SetCalculateColWidth;
         Row.AddCellString(Trim(RNQuery.FieldByName('CardType').AsString)).SetCalculateColWidth;
         Row.AddCellString(MaskAcct);
         Row.AddCellString(Trim(RNQuery.FieldByName('TranIdent').AsString));
         Row.AddCellString(Trim(RNQuery.FieldByName('TranCustomerCode').AsString)).SetWidth(100);
         Row.AddCellString(Trim(RNQuery.FieldByName('StationIdent').AsString)).SetCalculateColWidth;
         Row.AddCellString(Trim(RNQuery.FieldByName('StoreSystemCode').AsString));

         Row.AddCellString(Trim(RNQuery.FieldByName('Name').AsString)).SetCalculateColWidth;
         Row.AddCellString(Trim(RNQuery.FieldByName('City').AsString));
         Row.AddCellString(RNQuery.FieldByName('State').AsString);
         Row.AddCellString(RNQuery.FieldByName('ZIP').AsString);
         
         Row.AddCellString(GetCCTranEntryModeDisplayCode(RNQuery.FieldByName('TranEntryMode').AsString));
         if IncludeServiceName then begin //2018-01-25 ajs: F#2378
            if IncludeServiceNameDesc then begin
               Index :=  ServNameList.IndexOf(trim(RNQuery.FieldByName('CCServiceName').AsString));
               if (Index = -1) then begin
                  Row.AddCellString(Trim(RNQuery.FieldByName('CCServiceName').AsString));
               end else begin
                  Row.AddCellString((ServNameDescList[Index]));
               end;
            end else begin
               Row.AddCellString(Trim(RNQuery.FieldByName('CCServiceName').AsString));
            end;
         end;
         if IncludeEmpIdent then Row.AddCellString(Trim(RNQuery.FieldByName('TranEmployeeIdent').AsString));
         if IncludeCardHolderName then Row.AddCellString(Trim(RNQuery.FieldByName('CardName').AsString));
         if IncludeSFINDICATOR then begin
            if (Trim(RNQuery.FieldByName('SFTranGUID').AsString) <> '') then begin
               Row.AddCellString('X');
            end else begin
               Row.AddCellString(' ');
            end;
         end;
         if IncludeCVVResp then Row.AddCellString(Trim(RNQuery.FieldByName('CVVResp').AsString));   //2018-3-14 ajs: F#3629
         if IncludeAVSResp then Row.AddCellString(Trim(RNQuery.FieldByName('AVSResp').AsString));   //2018-3-14 ajs: F#3629
         if IncludeAVSData then Row.AddCellString(Trim(RNQuery.FieldByName('AVSData').AsString));   // 2019-06-15 tjr: DVST-564
         if IncludeProcessorToken then Row.AddCellString(Trim(RNQuery.FieldByName('ProcessorToken').AsString));
         if IncludeProfileFields then begin
            Row.AddCellString(CustomField1Value).SetCalculateColWidth;
            Row.AddCellString(CustomField2Value).SetCalculateColWidth;
            Row.AddCellString(CustomField3Value).SetCalculateColWidth;
            Row.AddCellString(CustomField4Value).SetCalculateColWidth;
            Row.AddCellString(CustomField5Value).SetCalculateColWidth;
            Row.AddCellString(CustomField6Value).SetCalculateColWidth;
         end;
      end;
   end;

   procedure FormatJSON;
   begin
      JSON.Append('{"RNID":"' + Trim(RNQuery.FieldByName('StoreCode').AsString) + '",');

      if DisplayStoreName then begin //2018-04-30 bls: F#1129
         JSON.Append('"Store Name":"' + Trim(RNQuery.FieldByName('NAME').AsString) + '",');
      end;

      if (DisplayInTZ) then begin //2018-04-11 jtm: F#3664 removed
         if DisplayInAMPM then begin
             JSON.Append('"Auth Date":"' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByName('AuthDatetz').AsDateTime) + '",');
         end else begin
             JSON.Append('"Auth Date":"' + FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('AuthDatetz').AsDateTime) + '",');
         end;
      end else begin
         JSON.Append('"Auth Date":"' + FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('AuthDate').AsDateTime) + '",');
      end;

      JSON.Append('"Transaction Type":"' + Trim(RNQuery.FieldByName('SaleType').AsString) + '",');
      If (Trim(RNQuery.FieldByName('SaleType').AsString) = 'CREDIT') or (Trim(RNQuery.FieldByName('SaleType').AsString) = 'REFUND') or (Trim(RNQuery.FieldByName('SaleType').AsString) = 'CRVOID') then begin
        JSON.Append('"Amount":"-' + Trim(StriReal(RNQuery.FieldByName('TranAmt').AsFloat,2)) + '",');
      end else begin
        JSON.Append('"Amount":"' + Trim(StriReal(RNQuery.FieldByName('TranAmt').AsFloat,2)) + '",');
      end;
      if not ExcludeExtraAmount then begin
      JSON.Append('"E Amount":"' + Trim(StriReal(RNQuery.FieldByName('TranAmt').AsFloat,2)) + '",');
      end;

      MaskAcct := '';

      if (Trim(RNQuery.FieldByName('CardAcct').AsString) <> '') then begin  //2017-12-20 jtm: F#2430
         if (Trim(RNQuery.FieldByName('ProcessorToken').AsString) <> '') then begin  //card number sent in, but either tokenized or not
            MaskAcct := MaskStr(Trim(RNQuery.FieldByName('ProcessorToken').AsString),DigitsToMask(Trim(RNQuery.FieldByName('ProcessorToken').AsString)));
            MaskAcct := '*..*' + NumericOnly(MaskAcct);
         end else begin
            MaskAcct := Trim(RNQuery.FieldByName('CardAcct').AsString);
            MaskAcct := 'X..X' + NumericOnly(MaskAcct);
         end;
      end else if (Trim(RNQuery.FieldByName('CardAcct').AsString) = '')  and (Trim(RNQuery.FieldByName('ProcessorToken').AsString) <> '') then begin //token passed directly
         MaskAcct := MaskStr(Trim(RNQuery.FieldByName('ProcessorToken').AsString),DigitsToMask(Trim(RNQuery.FieldByName('ProcessorToken').AsString)));
         MaskAcct := '#..#' + NumericOnly(MaskAcct);
      end;

      JSON.Append('"Auth Code":"' + Trim(RNQuery.FieldByName('AuthCode').AsString) + '",');
      JSON.Append('"Non Auth Resp":"' + Trim(RNQuery.FieldByName('NonAuthResp').AsString) + '",');
      if (DisplayInTZ) then begin //2018-04-11 jtm: F#3664 removed
         if DisplayInAMPM then begin
             JSON.Append('"Batch Date":"' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByName('BatchDatetz').AsDateTime) + '",');
         end else begin
             JSON.Append('"Batch Date":"' + FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('BatchDatetz').AsDateTime) + '",');
         end;
      end else begin
         JSON.Append('"Batch Date":"' + FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('BatchDate').AsDateTime) + '",');
      end;

      JSON.Append('"Batch ID":"' + Trim(RNQuery.FieldByName('BatchID').AsString) + '",');
      JSON.Append('"Card Type":"' + Trim(RNQuery.FieldByName('CardType').AsString) + '",');
      JSON.Append('"Card Acct":"' + MaskAcct + '",');
      JSON.Append('"' + TranIdentHeader + '":"' + Trim(RNQuery.FieldByName('TranIdent').AsString) + '",'); //2018-4-24 bls: F#3735
      JSON.Append('"' + CustIdentHeader +'":"' + Trim(RNQuery.FieldByName('TranCustomerCode').AsString) + '",'); //2018-4-24 bls: F#3735
      JSON.Append('"Station":"' + Trim(RNQuery.FieldByName('StationIdent').AsString) + '",');
      JSON.Append('"Station Code":"' + Trim(RNQuery.FieldByName('StoreSystemCode').AsString) + '",');
      JSON.Append('"Store Name":"' + Trim(RNQuery.FieldByName('Name').AsString) + '",');
      JSON.Append('"Store City":"' + Trim(RNQuery.FieldByName('City').AsString) + '",');
      JSON.Append('"Store State":"' + Trim(RNQuery.FieldByName('State').AsString) + '",');
      JSON.Append('"Store Zip":"' + Trim(RNQuery.FieldByName('ZIP').AsString) + '",');

      if IncludeServiceName then begin
         if IncludeServiceNameDesc then begin
            Index :=  ServNameList.IndexOf(trim(RNQuery.FieldByName('CCServiceName').AsString));
            if (Index = -1) then begin
               JSON.Append('"Service Name":"' + Trim(RNQuery.FieldByName('CCServiceName').AsString) + '",');
            end else begin
               JSON.Append('"Service Name":"' + (ServNameDescList[Index]) + '",');
            end;
         end else begin
            JSON.Append('"Service Name":"' + Trim(RNQuery.FieldByName('CCServiceName').AsString) + '",');
         end;
      end;
      if IncludeEmpIdent then begin
         JSON.Append('"Employee Ident":"' + Trim(RNQuery.FieldByName('TranEmployeeIdent').AsString) + '",');
      end;
      if IncludeCardHolderName then begin
         JSON.Append('"Card Holder Name":"' + Trim(RNQuery.FieldByName('CardName').AsString) + '",');
      end;
      if IncludeSFINDICATOR then begin
         if (Trim(RNQuery.FieldByName('SFTranGUID').AsString) <> '') then begin
            JSON.Append('"SF":"' + 'X' + '",');
         end else begin
            JSON.Append('"SF":"' + ' ' + '",');
         end;
      end;
      if IncludeCVVResp then begin
         JSON.Append('"CVV Response":"' + Trim(RNQuery.FieldByName('CVVResp').AsString) + '",');
      end;
      if IncludeAVSResp then begin
         JSON.Append('"AVS Response":"' + Trim(RNQuery.FieldByName('AVSResp').AsString) + '",');
      end;
      if IncludeAVSData then begin
         JSON.Append('"' + AVSDataHeader + '":"' + Trim(RNQuery.FieldByName('AVSData').AsString) + '",');
      end; // 2019-06-15 tjr: DVST-564
      if IncludeProcessorToken then JSON.Add('"Processor Token":"' + Trim(RNQuery.FieldByName('ProcessorToken').AsString) + '",');
      if IncludeProfileFields then begin
         JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/NAME', '') + '":"' + CustomField1Value + '",');
         JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/NAME', '') + '":"' + CustomField2Value + '",');
         JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/NAME', '') + '":"' + CustomField3Value + '",');
         JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/NAME', '') + '":"' + CustomField4Value + '",');
         JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/NAME', '') + '":"' + CustomField5Value + '",');
         JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/NAME', '') + '":"' + CustomField6Value + '",');
      end;

      JSON.Append('"Entry Mode":"' + GetCCTranEntryModeDisplayCode(RNQuery.FieldByName('TranEntryMode').AsString) + '"}');
   end;


   procedure FormatHTML;
   var
      storeCodeL, saleTypeL, tranAmtL, authCodeL, cardAcctL, ptokenL, servNameL, stationIdentL, sysCodeL : string;
   begin
      inc(ReturnedRecs);

      saleTypeL := Trim(CCResults.FieldByName('SaleType').AsString);
      tranAmtL := Format('%m',[CCResults.FieldByName('TranAmt').AsFloat]);
      authCodeL := CCResults.FieldByName('AuthCode').AsString;
      cardAcctL := Trim(CCResults.FieldByName('CardAcct').AsString);
      ptokenL := Trim(CCResults.FieldByName('ProcessorToken').AsString);
      servNameL := Trim(CCResults.FieldByName('CCServiceName').AsString);
      stationIdentL := Trim(CCResults.FieldByName('StationIdent').AsString);
      storeCodeL := Trim(CCResults.FieldByName('StoreCode').AsString);
      sysCodeL := CCResults.FieldByName('StoreSystemCode').AsString;

      HTML.Add('<TR><TD>' + storeCodeL + '</TD>');

      if DisplayStoreName then begin  //2018-30-2018 bls: F#1129
         HTML.Add('<TD>' + CCResults.FieldByName('NAME').AsString + '</TD>');
      end;

      if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620 //2018-04-11 jtm: F#3664 removed
         if DisplayInAMPM then begin
            HTML.Add('<TD>' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', CCResults.FieldByname('AuthDatetz').AsDateTime) + '</TD>');
         end else begin
            HTML.Add('<TD>' + FormatDateTime('MM/DD/YYYY HH:NN:SS', CCResults.FieldByname('AuthDatetz').AsDateTime) + '</TD>');
         end;
      end else begin
         HTML.Add('<TD>' + FormatDateTime('MM/DD/YYYY HH:NN:SS', CCResults.FieldByname('AuthDate').AsDateTime) + '</TD>');
      end;

      if (RecordFormatType = ttrftAJAX) then begin
         HTML.Add('<TD>' + saleTypeL + '</TD>')
      end else begin
         HTML.Add('<TD>' + '<A HREF="PAYMENTMATE?RNID=' + RNID +
                                      '&FROMDATE=' + FormatDateTime('MM/DD/YYYY', FromDate) +
                                      '&THRUDATE=' + FormatDateTime('MM/DD/YYYY', ThruDate) +
                                      '&SALETYPE=' + saleTypeL +
                                      '&STATIONIDENT=' + WebParamEncode(StationIdent) +
                                      '&PAGE=CARD&ACTION=CARDQUERY&FORMAT=' + DisplayFormat + '">' +
                                      saleTypeL + '</A></TD>');
      end;

      if (saleTypeL = 'CREDIT') or (saleTypeL = 'REFUND') then begin   //2017-11-16 jtm: D#2021
         HTML.Add('<TD align="Right">(' + tranAmtL + ')</TD>');
      end else if (saleTypeL = 'CRVOID') then begin    //2019-06-12 jtm: DVST-2864
         HTML.Add('<TD align="Right"><DEL>(' + tranAmtL + ')</DEL></TD>');
      end else if (saleTypeL = 'VOID') then begin
         HTML.Add('<TD align="Right"><DEL>' + tranAmtL + '</DEL></TD>');
      end else begin
         HTML.Add('<TD align="Right">' + tranAmtL + '</TD>');
      end;

      If (saleTypeL = 'CREDIT') or (saleTypeL = 'REFUND') then begin   //2017-11-16 jtm: D#2021
         HTML.Add('<TD><IMG SRC="/Images/General/CashSmall.gif" border="0"></TD>');
         if (saleTypeL = 'CREDIT') then begin
             HTML.Add('<TD align="Right"></TD>');
         end else begin
             HTML.Add('<TD align="Right">' + authCodeL + '</TD>');
         end;
         AddAmt(CreditVisaMC, CreditAMEX, CreditDisc,CreditOthr,CreditQVisaMC, CreditQAMEX, CreditQDisc,CreditQOthr);
      end else if (saleTypeL = 'CRVOID') then begin  //2017-11-16 jtm: D#2021
         HTML.Add('<TD><IMG SRC="/Images/General/YellowExclamation.gif" border="0"></TD>');
         HTML.Add('<TD align="Right">' + authCodeL + '</TD>');
         AddAmt(CRVoidVisaMC, CRVoidAMEX, CRVoidDisc,CRVoidOthr,CRVoidQVisaMC, CRVoidQAMEX, CRVoidQDisc, CRVoidQOthr);
      end else if (saleTypeL = 'VOID') then begin  //2017-11-16 jtm: D#2021
         HTML.Add('<TD><IMG SRC="/Images/General/YellowExclamation.gif" border="0"></TD>');
         HTML.Add('<TD align="Right">' + authCodeL + '</TD>');
         AddAmt(VoidVisaMC, VoidAMEX, VoidDisc,VoidOthr,VoidQVisaMC, VoidQAMEX, VoidQDisc, VoidQOthr);
      end else if Trim(RNQuery.FieldByName('AuthCode').AsString) <> '' then begin
         HTML.Add('<TD><IMG SRC="/Images/General/CheckSuccess.gif" border="0"></TD>');
         HTML.Add('<TD align="Right"><font color="GREEN">' + authCodeL + '</FONT></TD>');
         AddAmt(SaleVisaMC, SaleAMEX, SaleDisc,SaleOthr,SaleQVisaMC, SaleQAMEX, SaleQDisc,SaleQOthr);
      end else begin
         HTML.Add('<TD><IMG SRC="/Images/General/XFailed.gif" border="0"></TD>');
         HTML.Add('<TD align="Right"><font color="Red">' + CCResults.FieldByName('NonAuthResp').AsString + '</FONT></TD>');
      end;

      MaskAcct := '';
      if (cardAcctL <> '') then begin  //2017-03-22 jtm: F#2430
         if (ptokenL <> '') then begin  //card number sent in, but either tokenized or not
            MaskAcct := MaskStr(ptokenL, DigitsToMask(ptokenL));
            MaskAcct := '*..*' + NumericOnly(MaskAcct);
         end else begin
            MaskAcct := cardAcctL;
            MaskAcct := 'X..X' + NumericOnly(MaskAcct);
         end;
      end else if (cardAcctL = '')  and (ptokenL <> '') then begin //token passed directly
         MaskAcct := MaskStr(ptokenL, DigitsToMask(ptokenL));
         MaskAcct := '#..#' + NumericOnly(MaskAcct);
      end;
      if (DisplayInTZ) then begin //2018-11-14
         if DisplayInAMPM then begin
            HTML.Add('<TD>' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', CCResults.FieldByname('BatchDatetz').AsDateTime) + '</TD>');
         end else begin
            HTML.Add('<TD>' + FormatDateTime('MM/DD/YYYY HH:NN:SS', CCResults.FieldByname('BatchDatetz').AsDateTime) + '</TD>');
         end;
      end else begin
         HTML.Add('<TD>' + FormatDateTime('MM/DD/YYYY HH:NN:SS', CCResults.FieldByname('BatchDate').AsDateTime) + '</TD>');
      end;
      HTML.Add('<TD>' + CCResults.FieldByName('BatchID').AsString + '</TD>');
      HTML.Add('<TD>' + CCResults.FieldByName('CardType').AsString + '</TD>');
      HTML.Add('<TD>' + MaskAcct + '</TD>');
      HTML.Add('<TD>' + CCResults.FieldByName('TranIdent').AsString + '</TD>');
      HTML.Add('<TD>' + CCResults.FieldByName('TranCustomerCode').AsString + '</TD>');

      if IncludeServiceName then begin  //2018-01-25 ajs: F#2378
         if IncludeServiceNameDesc then begin
            Index :=  ServNameList.IndexOf(servNameL);
            if (Index = -1) then begin
               HTML.Add('<TD>' + servNameL + '</TD>');
            end else begin
               HTML.Add('<TD>' + ServNameDescList[Index] + '</TD>');
            end;
         end else begin
            HTML.Add('<TD>' + servNameL + '</TD>');
         end;
      end;

      if IncludeEmpIdent then HTML.Add('<TD>' + Trim(CCResults.FieldByName('TranEmployeeIdent').AsString) + '</TD>');
      if IncludeCardHolderName then HTML.Add('<TD>' + Trim(CCResults.FieldByName('CardName').AsString) + '</TD>');
      if IncludeSFINDICATOR then begin
         if (Trim(CCResults.FieldByName('SFTranGUID').AsString) <> '') then begin
            HTML.Add('<TD>X</TD>');
         end else begin
            HTML.Add('<TD> </TD>');
         end;
      end;

      if IncludeCVVResp then HTML.Add('<TD>' + Trim(CCResults.FieldByName('CVVResp').AsString) + '</TD>'); //2018-3-14 ajs: F#3629
      if IncludeAVSResp then HTML.Add('<TD>' + Trim(CCResults.FieldByName('AVSResp').AsString) + '</TD>'); //2018-3-14 ajs: F#3629
      if IncludeAVSData then HTML.Add('<TD>' + Trim(CCResults.FieldByName('AVSData').AsString) + '</TD>'); // 2019-06-15 tjr: DVST-564
      if IncludeProcessorToken then HTML.Add('<TD>' + Trim(CCResults.FieldByName('ProcessorToken').AsString) + '</TD>');

      HTML.Add('<TD>' + GetCCTranEntryModeDisplayCode(CCResults.FieldByName('TranEntryMode').AsString) + '</TD>');
      if (RecordFormatType = ttrftAJAX) then
         HTML.Add('<TD>' + stationIdentL + '</TD>')
      else
         HTML.Add('<TD>' + '<A HREF="PAYMENTMATE?RNID=' + RNID +
                                      '&FROMDATE=' + FormatDateTime('MM/DD/YYYY', FromDate) +
                                      '&THRUDATE=' + FormatDateTime('MM/DD/YYYY', ThruDate) +
                                      '&SALETYPE=' + SALETYPE +
                                      '&STATIONIDENT=' + WebParamEncode(stationIdentL) +
                                      '&PAGE=CARD&ACTION=CARDQUERY&FORMAT=' + DisplayFormat + '">'+
                                      stationIdentL + '</A></TD>');


      If ShowLinks then begin
         if (AAllowAll) and (RNID = 'ALL') then begin   //2016-6-28 jtm
            HTML.Add('<TD><a href="javascript://" onclick="GetVTCardDetailAJAX(''' + storeCodeL + ''',''' + sysCodeL + ''')">' + sysCodeL + '</a></TD>');
         end else begin
            HTML.Add('<TD><a href="javascript://" onclick="GetVTCardDetailAJAX(''' + RNID + ''',''' + sysCodeL + ''')">' + sysCodeL + '</a></TD>');
         end;
      end else begin
         HTML.Add('<TD>' + sysCodeL + '</TD>');
      end;

      HTML.Add('</TR>');
   end;
   
   procedure FormatGRID; //2018-06-20 bls: F#840
   begin
      GRID.Append('<row id=''' + RNQuery.FieldByName('row').AsString + '''>');
      GRID.Append('<cell>' + Trim(RNQuery.FieldByName('StoreCode').AsString) + '</cell>');

      if DisplayStoreName then begin  //2018-04-30 bls: F#1129
         GRID.Append('<cell>' + Trim(RNQuery.FieldByName('NAME').AsString) + '</cell>');
      end;

      if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620 //2018-04-11 jtm: F#3664 removed
         if DisplayInAMPM then begin
            GRID.Append('<cell>' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByname('AuthDatetz').AsDateTime)) + '</cell>');
         end else begin
            GRID.Append('<cell>' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('AuthDatetz').AsDateTime)) + '</cell>');
         end;
      end else begin
         GRID.Append('<cell>' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS',RNQuery.FieldByname('AuthDate').AsDateTime)) + '</cell>');
      end;

      GRID.Append('<cell>' + Trim(RNQuery.FieldByName('SaleType').AsString) + '</cell>');

      if (Trim(RNQuery.FieldByName('SaleType').AsString) = 'CREDIT') or (Trim(RNQuery.FieldByName('SaleType').AsString) = 'REFUND') then begin   //2017-11-16 jtm: D#2021
         GRID.Append('<cell>(' + Trim(Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat])) + ')</cell>');
      end else if (Trim(RNQuery.FieldByName('SaleType').AsString) = 'CRVOID') then begin //2019-06-12 jtm: DVST-2864
         GRID.Append('<cell><![CDATA[<DEL>(' + Trim(Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat])) + ')</DEL>]]></cell>');
      end else if (Trim(RNQuery.FieldByName('SaleType').AsString) = 'VOID') then begin
         GRID.Append('<cell><![CDATA[<DEL>' + Trim(Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat])) + '</DEL>]]></cell>');
      end else begin
         GRID.Append('<cell>' + Trim(Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat])) + '</cell>');
      end;

      If (Trim(RNQuery.FieldByName('SaleType').AsString) = 'CREDIT') or (Trim(RNQuery.FieldByName('SaleType').AsString) = 'REFUND') then begin   //2017-11-16 jtm: D#2021
         GRID.Append('<cell><![CDATA[<IMG SRC="/Images/General/CashSmall.gif" border="0" style="display: inline-block">');
         if (Trim(RNQuery.FieldByName('SaleType').AsString) = 'CREDIT') then begin
             GRID.Append(']]></cell>');
         end else begin
             GRID.Append(Trim(RNQuery.FieldByName('AuthCode').AsString) + ']]></cell>');
         end;
      end else if (Trim(RNQuery.FieldByName('SaleType').AsString) = 'VOID') or (Trim(RNQuery.FieldByName('SaleType').AsString) = 'CRVOID') then begin  //2017-11-16 jtm: D#2021
         GRID.Append('<cell><![CDATA[<IMG SRC="/Images/General/YellowExclamation.gif" border="0" style="display: inline-block"/>');
         GRID.Append(trim(RNQuery.FieldByName('AuthCode').AsString) + ']]></cell>');
      end else if Trim(RNQuery.FieldByName('AuthCode').AsString) <> '' then begin
         GRID.Append('<cell><![CDATA[<IMG SRC="/Images/General/CheckSuccess.gif" border="0" style="display: inline-block"/>');
         GRID.Append('<font color="GREEN">' + trim(RNQuery.FieldByName('AuthCode').AsString) + '</FONT>]]></cell>');
      end else begin
         GRID.Append('<cell><![CDATA[<IMG SRC="/Images/General/XFailed.gif" border="0" style="display: inline-block"/>');
         GRID.Append('<font color="Red">' + trim(RNQuery.FieldByName('NonAuthResp').AsString) + '</FONT>]]></cell>');
      end;

      MaskAcct := '';
      if (Trim(RNQuery.FieldByName('CardAcct').AsString) <> '') then begin  //2017-03-22 jtm: F#2430
         if (Trim(RNQuery.FieldByName('ProcessorToken').AsString) <> '') then begin  //card number sent in, but either tokenized or not
            MaskAcct := MaskStr(Trim(RNQuery.FieldByName('ProcessorToken').AsString),DigitsToMask(Trim(RNQuery.FieldByName('ProcessorToken').AsString)));
            MaskAcct := '*..*' + NumericOnly(MaskAcct);
         end else begin
            MaskAcct := Trim(RNQuery.FieldByName('CardAcct').AsString);
            MaskAcct := 'X..X' + NumericOnly(MaskAcct);
         end;
      end else if (Trim(RNQuery.FieldByName('CardAcct').AsString) = '')  and (Trim(RNQuery.FieldByName('ProcessorToken').AsString) <> '') then begin //token passed directly
         MaskAcct := MaskStr(Trim(RNQuery.FieldByName('ProcessorToken').AsString),DigitsToMask(Trim(RNQuery.FieldByName('ProcessorToken').AsString)));
         MaskAcct := '#..#' + NumericOnly(MaskAcct);
      end;

      if (DisplayInTZ) then begin //2018-11-14
         if DisplayInAMPM then begin
            GRID.Append('<cell>' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByname('BatchDatetz').AsDateTime)) + '</cell>');
         end else begin
            GRID.Append('<cell>' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('BatchDatetz').AsDateTime)) + '</cell>');
         end;
      end else begin
         GRID.Append('<cell>' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS',RNQuery.FieldByname('BatchDate').AsDateTime)) + '</cell>');
      end;
      GRID.Append('<cell>' + Trim(RNQuery.FieldByName('BatchID').AsString) + '</cell>' +
                     '<cell>' + trim(RNQuery.FieldByName('CardType').AsString) + '</cell>' +
                     '<cell>' + MaskAcct + '</cell>' +
                     '<cell>' + trim(RNQuery.FieldByName('TranIdent').AsString) + '</cell>' +
                     '<cell>' + trim(RNQuery.FieldByName('TranCustomerCode').AsString) + '</cell>');


      if IncludeServiceName then begin  //2018-01-25 ajs: F#2378
         if IncludeServiceNameDesc then begin
            Index :=  ServNameList.IndexOf(trim(RNQuery.FieldByName('CCServiceName').AsString));
            if (Index = -1) then begin
                GRID.Append('<cell>' + Trim(RNQuery.FieldByName('CCServiceName').AsString) + '</cell>');
            end else begin
                GRID.Append('<cell>' + ServNameDescList[Index] + '</cell>');
            end;
         end else begin
            GRID.Append('<cell>' + Trim(RNQuery.FieldByName('CCServiceName').AsString) + '</cell>');
         end;
      end;

      if IncludeEmpIdent then  GRID.Append('<cell>' + Trim(RNQuery.FieldByName('TranEmployeeIdent').AsString) + '</cell>');
      if IncludeCardHolderName then  GRID.Append('<cell>' + Trim(RNQuery.FieldByName('CardName').AsString) + '</cell>');
      if IncludeSFINDICATOR then begin
         if (Trim(RNQuery.FieldByName('SFTranGUID').AsString) <> '') then begin
             GRID.Append('<cell>' + 'X' + '</cell>');
         end else begin
             GRID.Append('<cell>' + ' ' + '</cell>');
         end;
      end;
      if IncludeCVVResp then GRID.Append('<cell>' + Trim(RNQuery.FieldByName('CVVResp').AsString) + '</cell>'); //2018-3-14 ajs: F#3629
      if IncludeAVSResp then GRID.Append('<cell>' + Trim(RNQuery.FieldByName('AVSResp').AsString) + '</cell>'); //2018-3-14 ajs: F#3629
      if IncludeAVSData then GRID.Append('<cell>' + Trim(RNQuery.FieldByName('AVSData').AsString) + '</cell>'); // 2019-06-15 tjr: DVST-564
      if IncludeProcessorToken then GRID.Add('<cell>' + Trim(RNQuery.FieldByName('ProcessorToken').AsString) + '</cell>');

      GRID.Append('<cell>' + GetCCTranEntryModeDisplayCode(RNQuery.FieldByName('TranEntryMode').AsString) + '</cell>');

      GRID.Append('<cell>' + Trim(RNQuery.FieldByName('StationIdent').AsString) + '</cell>');

      If ShowLinks then begin
         if (AAllowAll) and (RNID = 'ALL') then begin   //2016-6-28 jtm
            GRID.Append('<cell><![CDATA[<a href="javascript://" onclick="GetVTCardDetailAJAX(''' + trim(RNQuery.FieldByName('StoreCode').AsString) + ''',''' + Trim(RNQuery.FieldByName('StoreSystemCode').AsString) + ''')">' + Trim(RNQuery.FieldByName('StoreSystemCode').AsString) + '</a>]]></cell>');
         end else begin
            GRID.Append('<cell><![CDATA[<a href="javascript://" onclick="GetVTCardDetailAJAX(''' + RNID + ''','''+ RNQuery.FieldByName('StoreSystemCode').AsString + ''')">' + RNQuery.FieldByName('StoreSystemCode').AsString + '</a>]]></cell>');
         end;
      end else begin
         GRID.Append('<cell>' + RNQuery.FieldByName('StoreSystemCode').AsString + '</cell>');
      end;

      GRID.Append('</row>');
   end;

   procedure FormatGRIDJSON; //2018-07-18 bls: F#4978
   begin
      GRID.Add('{"id":' + RNQuery.FieldByName('row').AsString + ',"data":[');
      GRID.Add('"' + Trim(RNQuery.FieldByName('StoreCode').AsString) + '",');

      if DisplayStoreName then begin  //2018-04-30 bls: F#1129
         GRID.Add('"' + Trim(RNQuery.FieldByName('NAME').AsString) + '",');
      end;

      if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620 //2018-04-11 jtm: F#3664 removed
         if DisplayInAMPM then begin
            GRID.Add('"' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByname('AuthDatetz').AsDateTime)) + '",');
         end else begin
            GRID.Add('"' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('AuthDatetz').AsDateTime)) + '",');
         end;
      end else begin
         GRID.Add('"' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('AuthDate').AsDateTime)) + '",');
      end;

      GRID.Add('"' + Trim(RNQuery.FieldByName('SaleType').AsString) + '",');

      if (Trim(RNQuery.FieldByName('SaleType').AsString) = 'CREDIT') or (Trim(RNQuery.FieldByName('SaleType').AsString) = 'REFUND') then begin   //2017-11-16 jtm: D#2021
         GRID.Add('"(' + Trim(Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat])) + ')",');
      end else if (Trim(RNQuery.FieldByName('SaleType').AsString) = 'CRVOID') then begin //2019-06-12 jtm: DVST-2864
          GRID.Add('"<DEL>(' + Trim(Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat])) + ')<\/DEL>",');
      end else if (Trim(RNQuery.FieldByName('SaleType').AsString) = 'VOID') then begin
         GRID.Add('"<DEL>' + Trim(Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat])) + '<\/DEL>",');
      end else begin
         GRID.Add('"' + Trim(Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat])) + '",');
      end;

      If (Trim(RNQuery.FieldByName('SaleType').AsString) = 'CREDIT') or (Trim(RNQuery.FieldByName('SaleType').AsString) = 'REFUND') then begin   //2017-11-16 jtm: D#2021
         GRID.Add('"<IMG SRC=\"\/Images\/General\/CashSmall.gif\" border=\"0\" style=\"display: inline-block\" \/>');
         if (Trim(RNQuery.FieldByName('SaleType').AsString) = 'CREDIT') then begin
             GRID.Add('",');
         end else begin
             GRID.Add(Trim(RNQuery.FieldByName('AuthCode').AsString) + '",');
         end;

      end else if (Trim(RNQuery.FieldByName('SaleType').AsString) = 'VOID') or (Trim(RNQuery.FieldByName('SaleType').AsString) = 'CRVOID') then begin  //2017-11-16 jtm: D#2021
         GRID.Add('"<IMG SRC=\"\/Images\/General\/YellowExclamation.gif\" border=\"0\" style=\"display: inline-block\" \/>');
         GRID.Add(trim(RNQuery.FieldByName('AuthCode').AsString) + '",');
      end else if Trim(RNQuery.FieldByName('AuthCode').AsString) <> '' then begin
         GRID.Add('"<IMG SRC=\"\/Images\/General\/CheckSuccess.gif\" border=\"0\" style=\"display: inline-block\" \/>');
         GRID.Add('<font color=\"GREEN\">' + trim(RNQuery.FieldByName('AuthCode').AsString) + '<\/FONT>",');
      end else begin
         GRID.Add('"<IMG SRC=\"\/Images\/General\/XFailed.gif\" border=\"0\" style=\"display: inline-block\" \/>');
         GRID.Add('<font color=\"Red\">' + trim(RNQuery.FieldByName('NonAuthResp').AsString) + '<\/FONT>",');
      end;

      MaskAcct := '';
      if (Trim(RNQuery.FieldByName('CardAcct').AsString) <> '') then begin  //2017-03-22 jtm: F#2430
         if (Trim(RNQuery.FieldByName('ProcessorToken').AsString) <> '') then begin  //card number sent in, but either tokenized or not
            MaskAcct := MaskStr(Trim(RNQuery.FieldByName('ProcessorToken').AsString),DigitsToMask(Trim(RNQuery.FieldByName('ProcessorToken').AsString)));
            MaskAcct := '*..*' + NumericOnly(MaskAcct);
         end else begin
            MaskAcct := Trim(RNQuery.FieldByName('CardAcct').AsString);
            MaskAcct := 'X..X' + NumericOnly(MaskAcct);
         end;
      end else if (Trim(RNQuery.FieldByName('CardAcct').AsString) = '')  and (Trim(RNQuery.FieldByName('ProcessorToken').AsString) <> '') then begin //token passed directly
         MaskAcct := MaskStr(Trim(RNQuery.FieldByName('ProcessorToken').AsString),DigitsToMask(Trim(RNQuery.FieldByName('ProcessorToken').AsString)));
         MaskAcct := '#..#' + NumericOnly(MaskAcct);
      end;

      if (DisplayInTZ) then begin //2018-11-14
         if DisplayInAMPM then begin
            GRID.Add('"' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByname('BatchDatetz').AsDateTime)) + '",');
         end else begin
            GRID.Add('"' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('BatchDatetz').AsDateTime)) + '",');
         end;
      end else begin
         GRID.Add('"' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('BatchDate').AsDateTime)) + '",');
      end;


      GRID.Add('"' + Trim(RNQuery.FieldByName('BatchID').AsString) + '",');
      GRID.Add('"' + trim(RNQuery.FieldByName('CardType').AsString) + '",');
      GRID.Add('"' + MaskAcct + '",');
      GRID.Add('"' + trim(RNQuery.FieldByName('TranIdent').AsString) + '",');
      GRID.Add('"' + trim(RNQuery.FieldByName('TranCustomerCode').AsString) + '",');

      if IncludeServiceName then begin  //2018-01-25 ajs: F#2378
         if IncludeServiceNameDesc then begin
            Index :=  ServNameList.IndexOf(trim(RNQuery.FieldByName('CCServiceName').AsString));
            if (Index = -1) then begin
                GRID.Add('"' + Trim(RNQuery.FieldByName('CCServiceName').AsString) + '",');
            end else begin
                GRID.Add('"' + ServNameDescList[Index] + '",');
            end;
         end else begin
            GRID.Add('"' + Trim(RNQuery.FieldByName('CCServiceName').AsString) + '",');
         end;
      end;

      if IncludeEmpIdent then  GRID.Add('"' + Trim(RNQuery.FieldByName('TranEmployeeIdent').AsString) + '",');
      if IncludeCardHolderName then  GRID.Add('"' + Trim(RNQuery.FieldByName('CardName').AsString) + '",');
      if IncludeSFINDICATOR then begin
         if (Trim(RNQuery.FieldByName('SFTranGUID').AsString) <> '') then begin
             GRID.Add('"' + 'X' + '",');
         end else begin
             GRID.Add('"' + ' ' + '",');
         end;
      end;
      if IncludeCVVResp then GRID.Add('"' + Trim(RNQuery.FieldByName('CVVResp').AsString) + '",'); //2018-3-14 ajs: F#3629
      if IncludeAVSResp then GRID.Add('"' + Trim(RNQuery.FieldByName('AVSResp').AsString) + '",'); //2018-3-14 ajs: F#3629
      if IncludeAVSData then GRID.Add('"' + Trim(RNQuery.FieldByName('AVSData').AsString) + '",'); // 2019-06-15 tjr: DVST-564
      if IncludeProcessorToken then GRID.Add('"' + Trim(RNQuery.FieldByName('ProcessorToken').AsString) + '",');

      GRID.Append('"' + GetCCTranEntryModeDisplayCode(RNQuery.FieldByName('TranEntryMode').AsString) + '",');

      GRID.Append('"' + Trim(RNQuery.FieldByName('StationIdent').AsString) + '",');

      If ShowLinks then begin
         if (AAllowAll) and (RNID = 'ALL') then begin   //2016-6-28 jtm
            GRID.Add('"<a href=\"javascript:\/\/\" onclick=\"GetVTCardDetailAJAX(''' + trim(RNQuery.FieldByName('StoreCode').AsString) + ''',''' + Trim(RNQuery.FieldByName('StoreSystemCode').AsString) + ''')\">' + Trim(RNQuery.FieldByName('StoreSystemCode').AsString) + '<\/a>"]}');
         end else begin
            GRID.Add('"<a href=\"javascript:\/\/\" onclick=\"GetVTCardDetailAJAX(''' + RNID + ''','''+ RNQuery.FieldByName('StoreSystemCode').AsString + ''')\">' + RNQuery.FieldByName('StoreSystemCode').AsString + '<\/a>"]}');
         end;
      end else begin
         GRID.Add('"' + RNQuery.FieldByName('StoreSystemCode').AsString + '"]}');
      end;
   end;

   procedure ProcessEntryModeChart;
   begin
      HTML.Append('<BR><BR>' +
                  '<TABLE border="1" cellspacing="0" cellpadding="3" bordercolorlight="#0000FF" style="border-collapse: collapse">'+
                  '<TR><TD ALIGN=''CENTER''><B>Entry Mode Code</B></TD>'+
                  '    <TD ALIGN=''CENTER''><B>Description</B></TD>'+
                  '</TR>' +
                  '<TR><TD ALIGN=''CENTER''>EMV</TD>'+
                  '    <TD ALIGN=''CENTER''>EMV</TD>'+
                  '</TR>' +
                  '<TR><TD ALIGN=''CENTER''>CMAG</TD>'+
                  '    <TD ALIGN=''CENTER''>Contactless Mag</TD>'+
                  '</TR>' +
                  '<TR><TD ALIGN=''CENTER''>CEMV</TD>'+
                  '    <TD ALIGN=''CENTER''>Contactless EMV</TD>'+
                  '</TR>' +
                  '<TR><TD ALIGN=''CENTER''>S</TD>'+
                  '    <TD ALIGN=''CENTER''>Swipe</TD>'+
                  '</TR>' +
                  '<TR><TD ALIGN=''CENTER''>FS</TD>'+
                  '    <TD ALIGN=''CENTER''>Fallback Swipe</TD>'+
                  '</TR>' +
                  '<TR><TD ALIGN=''CENTER''>K</TD>'+
                  '    <TD ALIGN=''CENTER''>Manual Key</TD>'+
                  '</TR>' +
                  '<TR><TD ALIGN=''CENTER''>COF</TD>'+
                  '    <TD ALIGN=''CENTER''>Card on File</TD>'+
                  '</TR>' +
                  '<TR><TD ALIGN=''CENTER''>FK</TD>'+
                  '    <TD ALIGN=''CENTER''>EMV fallback to Manual Key</TD>'+
                  '</TR>' +
                  '<TR><TD ALIGN=''CENTER''>FCEMV</TD>'+
                  '    <TD ALIGN=''CENTER''>Fallback Contactless to Contact (Discover Only)</TD>'+
                  '</TR>' +
                  '<TR><TD ALIGN=''CENTER''>CMBL</TD>'+
                  '    <TD ALIGN=''CENTER''>Contact Mobile Commerce (Discover Only)</TD>'+
                  '</TR>' +
                  '</TABLE><BR><BR>');
   end;

   Function getColumnName(gridColumn : string) : string; //2018-06-20 bls: F#840
   var
      sqlColName : string;

      tranIdent, custIdent, itemSerial : string;
   begin
      sqlColName := '';

      tranIdent := ValidCharsOnly(Trim(tranIdentHeader),true,false,'');
      custIdent := ValidCharsOnly(Trim(custIdentHeader),true,false,'');

      if StoreSystemCodeLabel <> '' then begin
         itemSerial := ValidCharsOnly(Trim(StoreSystemCodeLabel), true, false, '');
      end else begin
         itemSerial := 'ItemSerial';
      end;

      if gridColumn = 'RNID' then sqlColName := 'cc.StoreCode'
      else if gridColumn = 'StoreName' then sqlColName := 's.Name'
      else if gridColumn = 'AuthDate' then sqlColName := 'cc.AuthDate'
      else if gridColumn = 'TranType' then sqlColName := 'cc.SaleType'
      else if gridColumn = 'Amount' then sqlColName := 'cc.TranAmt'
      else if gridColumn = 'AuthCode' then sqlColName := 'cc.AuthCode'
      else if gridColumn = 'BatchDate' then sqlColName := 'cc.BatchDate'
      else if gridColumn = 'BatchID' then sqlColName := 'cc.BatchID'
      else if gridColumn = 'CardType' then sqlColName := 'cc.CardType'
      else if gridColumn = 'CardAcct' then sqlColName := 'cc.ProcessorToken'
      else if gridColumn = tranIdent then sqlColName := 'cc.TranIdent'
      else if gridColumn = custIdent then sqlColName := 'cc.TranCustomerCode'
      else if gridColumn = 'ServiceName' then sqlColName := 'cc.CCServiceName'
      else if gridColumn = 'EmpIdent' then sqlColName := 'cc.TranEmployeeIdent'
      else if gridColumn = 'CardName' then sqlColName := 'cc.CardName'
      else if gridColumn = 'EntryMode' then sqlColName := 'cc.TranEntryMode'
      else if gridColumn = 'Station' then sqlColName := 'cc.StationIdent'
      else if gridColumn = itemSerial then sqlColName := 'cc.StoreSystemCode'
      else if gridColumn = 'SF' then sqlColName := 'cc.SFTranGUID'
      else if gridColumn = 'CVVResp' then sqlColName := 'cc.CVVResp'
      else if gridColumn = 'AVSResp' then sqlColName := 'cc.AVSResp'
      else if gridColumn = 'AVSData' then sqlColName := 'cc.AVSData'
      else if gridColumn = 'ProcessorToken' then sqlColName := 'cc.ProcessorToken'
      else sqlColName :=  'cc.AuthDate';

      Result := sqlColName;
   end;

   function getCCRecords : TDataSet; //2018-07-18 bls: F#4978
   var
      i : integer;
   begin
      RNQuery.Close;
      RNQuery.SQL.clear;

      ParameterList.Append(DRSQLVarsDec);
      Processlog(ltDebug, 'GetCardQueryTable DateRange',DateRange);
      if (DateRange = 'CUSTOM') or (DateRange = '')  then begin
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SEARCHONDATETIME', 'FALSE') = 'TRUE') then begin //2018-08-15 bls: 542
            ParameterList.Append('set @BegDate = ''' + FormatDateTime('MM/DD/YYYY hh:nn', Fromdate) + '''; set @EndDate =''' + FormatDateTime('MM/DD/YYYY hh:nn', ThruDate + 1) + ''';');
         end else begin
         ParameterList.Append('set @BegDate = ''' + FormatDateTime('MM/DD/YYYY', Fromdate) + '''; set @EndDate =''' + FormatDateTime('MM/DD/YYYY', ThruDate + 1) + ''';');
         end;
      end else begin
         ParameterList.Append('set @DateRangeName = '''+DateRange+''';'+DRSQLSetBegDate + DRSQLSetEndDate);
      end;
      ParameterList.Append(DRSQLSetTZ);
      ParameterList.Append('set @BegDateHAST = DATEADD(hour,+'+HASTOffsetEST+',@BegDate);set @EndDateHAST = DATEADD(hour,+'+HASTOffsetEST+',@EndDate); ');

      if RecordFormatType = ttrftGRID then begin //2018-06-20 bls: F#840
         posStart := '0';
         count := '100';

         if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['posStart']))) <> '' then begin
             posStart := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['posStart']))); // Get Starting position
         end;
         if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['count']))) <> '' then begin
             count := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['count']))); // Get amount of rows to receive from db
         end;
         if ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['orderby'])),true,false,'') <> '' then begin
             orderBy := Request.queryfields.Values['orderby']; // Determines which column to sort the data by
         end;
         if ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['direct'])),true,false,'') <> '' then begin
             direction := Request.queryfields.Values['direct']; // Determines whether the data will be Ascending or descending
             if direction = 'des' then direction := 'DESC';
         end;

         ParameterList.Append('Set @StartPos = ' + posStart + '; set @count = ' + count + ';');
      end;

      QueryBuilder.Append('SELECT');
      if (DisplayInTZ) then begin
         QueryBuilder.Append('CASE r.KeyValue WHEN ''AST'' THEN DATEADD(hour,+1,cc.AuthDate) WHEN ''CST'' THEN DATEADD(hour,-1,cc.AuthDate) WHEN ''MST'' THEN DATEADD(hour,-2,cc.AuthDate) ' +
                             'WHEN ''PST'' THEN DATEADD(hour,-3,cc.AuthDate) WHEN ''AKST'' THEN DATEADD(hour,-4,cc.AuthDate)' +
                             'WHEN ''HAST'' THEN DATEADD(hour,-'+HASTOffsetEST+',cc.AuthDate) ELSE cc.AuthDate END authdatetz,');
         QueryBuilder.Append('CASE r.KeyValue WHEN ''AST'' THEN DATEADD(hour,+1,cc.BatchDate) WHEN ''CST'' THEN DATEADD(hour,-1,cc.BatchDate) WHEN ''MST'' THEN DATEADD(hour,-2,cc.BatchDate) ' +
                             'WHEN ''PST'' THEN DATEADD(hour,-3,cc.BatchDate) WHEN ''AKST'' THEN DATEADD(hour,-4,cc.BatchDate)' +
                             'WHEN ''HAST'' THEN DATEADD(hour,-'+HASTOffsetEST+',cc.BatchDate) ELSE cc.BatchDate END BatchDatetz,');
      end;

         QueryBuilder.Append('s.SystemCode RNID, cc.*,s.Name,s.City,s.State,s.ZIP ');

      if RecordFormatType = ttrftGRID then begin //2018-06-20 bls: F#840
         if orderBy = '' then begin
            QueryBuilder.Append(',ROW_NUMBER() OVER (ORDER BY cc.AuthDate) as row');
         end else begin
            QueryBuilder.Append(',ROW_NUMBER() OVER (ORDER BY ' + getColumnName(orderBy) + ' ' + direction + ') as row');
         end;
      end;

      QueryBuilder.Append('from CCAuth cc left outer join');
      QueryBuilder.Append(' Store s on cc.StoreCode = s.SystemCode');
      if (DisplayInTZ) then begin
         QueryBuilder.Append('left outer join REGISTRY r on r.SubKey1 = cc.storecode');
      end;
      QueryBuilder.Append('where (s.SystemCode in(' + RNIDList.CommaText + '))');

      if (DisplayInTZ) then begin
         QueryBuilder.Append('and r.subkey2 = ''storetz''');
         QueryBuilder.Append('and (Authdate >= case r.KeyValue WHEN ''AST'' THEN @BegDateAST WHEN ''CST'' THEN @BegDateCST WHEN ''MST'' THEN @BegDateMST WHEN ''PST'' THEN @BegDatePST WHEN ''AKST'' THEN @BegDateAKST WHEN ''HAST'' THEN @BegDateHAST ELSE @BegDate END)'); //figure out DST for AZ and HI
         QueryBuilder.Append('and (Authdate < case r.KeyValue WHEN ''AST'' THEN @EndDateAST WHEN ''CST'' THEN @EndDateCST WHEN ''MST'' THEN @EndDateMST WHEN ''PST'' THEN @EndDatePST WHEN ''AKST'' THEN @EndDateAKST WHEN ''HAST'' THEN @EndDateHAST ELSE @EndDate END)');
      end else begin
         QueryBuilder.Append('and (AuthDate >= @BegDate)');
         QueryBuilder.Append('and (AuthDate < @EndDate)');
      end;

      If VarEvaluator.GetValueAsString('LASTFOUR') <> '' then begin
         QueryBuilder.Append('And ((ProcessorToken LIKE ''%' + VarEvaluator.GetValueAsString('LASTFOUR') + ''')'); //2017-03-22 jtm: Feat OT#1289
         QueryBuilder.Append('or (CardAcct LIKE ''%X' + VarEvaluator.GetValueAsString('LASTFOUR') + '''))');
      end;
      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHEMPIDENT', 'FALSE') = 'TRUE') and (ValidCharsonly(Request.queryfields.Values['EMPIDENT'],True,True,'.-_:/&') <> '') then begin
         QueryBuilder.Append('And (TranEmployeeIdent LIKE ''' + ValidCharsonly(Request.queryfields.Values['EMPIDENT'],True,True,'.-_:/&') + '%'')'); //2017-05-10 jtm D#1605
      end;
      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHCARDNAME', 'FALSE') = 'TRUE') and (ValidCharsonly(Request.queryfields.Values['CARDNAME'],True,True,'/ ') <> '') then begin  //2016-8-08 jtm: Feat OT#926
         QueryBuilder.Append('And (CardName LIKE ''%' + ValidCharsonly(Request.queryfields.Values['CARDNAME'],True,True,'/ ') + '%'')'); //2018-04-26 bls D#2532
      end;
      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHTRANIDENT', 'FALSE') = 'TRUE') and (ValidCharsonly(Request.queryfields.Values['TRANIDENT'],True,True,'.-_:/& ') <> '') then begin
         QueryBuilder.Append('And (TranIdent LIKE ''' + ValidCharsonly(Request.queryfields.Values['TRANIDENT'],True,True,'.-_:/& ') + '%'')'); //2017-05-10 jtm D#1605
      end;
      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHDOLLARAMT', 'FALSE') = 'TRUE') and (ValidCharsonly(Request.queryfields.Values['DOLLARAMT'],False,True,'.') <> '') then begin
         if (NumericOnly(Request.queryfields.Values['DOLLARAMTCOMP']) = '0') then begin
             QueryBuilder.Append('And (TranAmt = ''' + ValidCharsonly(Request.queryfields.Values['DOLLARAMT'],false,True,'.') + ''')');
         end else if(NumericOnly(Request.queryfields.Values['DOLLARAMTCOMP']) = '1') then begin
             QueryBuilder.Append('And (TranAmt > ''' + ValidCharsonly(Request.queryfields.Values['DOLLARAMT'],false,True,'.') + ''')');
         end else if (NumericOnly(Request.queryfields.Values['DOLLARAMTCOMP']) = '2') then begin
             QueryBuilder.Append('And (TranAmt < ''' + ValidCharsonly(Request.queryfields.Values['DOLLARAMT'],false,True,'.') + ''')');
         end;
      end;
      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHCUSTIDENT', 'FALSE') = 'TRUE') and (ValidCharsonly(Request.queryfields.Values['CUSTIDENT'],True,True,'.-_:/& ') <> '') then begin
         QueryBuilder.Append('And (TranCustomerCode LIKE ''' + ValidCharsonly(Request.queryfields.Values['CUSTIDENT'],True,True,'.-_:/& ') + '%'')');
      end;
     if IncludeProcessorToken then begin
         QueryBuilder.Add('And (ProcessorToken LIKE ''%' + ValidCharsonly(Request.queryfields.Values['PROCESSORTOKEN'], False, True, '') + '%'')');
     end;
      Processlog(ltInfo, 'GetCardQueryTable Search on ServiceName:', VarEvaluator.GetValueAsString('ServiceName'));

      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHONSERVICENAME', 'FALSE') = 'TRUE') and (VarEvaluator.GetValueAsString('ServiceName') <> '') then begin  //2017-5-10 jtm: Feat OT#1565
         Processlog(ltInfo, 'GetCardQueryTable Search on ServiceName:', VarEvaluator.GetValueAsString('ServiceName'));
         if (VarEvaluator.GetValueAsString('ServiceName') = 'ALL') then begin
            ServiceNamesByRNID := GetServiceNamesByRNID(RNID,'',ServNameList,ServNameDescList); //2017-09-20 jtm: D#1946
            if (ServiceNamesByRNID <> GetUserServNameAccessByRNID(ServNameList,RNID,(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/NOREADONLYLOCATIONS','FALSE') = 'TRUE'),ServiceNamesByRNID)) then begin //2017-09-25 jtm: D#1963
               QueryBuilder.Append('And (CCServiceName in (');
               QueryBuilder.Append(QuotedStr(ServNameList[0]));
               for i := 1 to ServNameList.Count-1 do begin
                  QueryBuilder.Append(','+QuotedStr(ServNameList[i]));
               end;
               QueryBuilder.Append('))');
            end;

         end else begin
            QueryBuilder.Append('And (CCServiceName = ''' + VarEvaluator.GetValueAsString('ServiceName') + ''')');
         end;
      end;
      SaleType := UpCaseString(AlphaOnly(SaleType));
      If SaleType <> '' then
         QueryBuilder.Append('And (SaleType=''' + SaleType + ''')');

      StationIdent := ValidCharsOnly(StationIdent,True,True,'-._');
      If StationIdent <> '' then
         QueryBuilder.Append('And (StationIdent =''' + StationIdent + ''')');

      If SettledOnly then
         QueryBuilder.Append('And (captureflag = 1)');

      if RecordFormatType <> ttrftGRID then begin //2018-06-20 bls: F#840
         if ASeparateStores then begin//2017-05-10 jtm F#1696
            QueryBuilder.Append('Order by s.SystemCode, cc.AuthDate');
         end else begin
            QueryBuilder.Append('Order by cc.AuthDate');
         end;
      end;      
      Processlog(ltDebug, 'GetCardQueryTable SQL Text', ParameterList.Text + QueryBuilder.Text);
      RNQuery.CursorType := ctOpenForwardOnly;
      RNQuery.DisableControls;
      TADODataSet(RNQuery).CommandTimeout := 300;      //2016-10-05
      OpenStopWatch.Start;

      if RecordFormatType = ttrftGRID then begin //2018-06-20 bls: F#840
         if StrToInt(posStart) = 0 then begin
            RNQuery.SQL.Append(parameterList.Text + ' SELECT COUNT(*) as totalCount FROM(' + QueryBuilder.Text + ') as a');
            RNQuery.Open();
            totalCount := RNQuery.FieldByName('totalCount').AsString;
            SessionVarEval.AddValue('totalCount', totalCount);
            ProcessLog(ltinfo, 'getCardQueryTable', 'Query Opened: Total Record Count: ' + totalCount);
         end;
         RNQuery.Close();
         RNQuery.SQL.Clear();

         RNQuery.SQL.Append(ParameterList.Text + ' SELECT * FROM(' + QueryBuilder.Text + ') as a WHERE row between (@StartPos + 1) and (@StartPos + @count)');
      end else begin
         RNQuery.SQL.Append(ParameterList.Text + QueryBuilder.Text);
      end;
      Processlog(ltDebug, 'GetCardQueryTable SQL Text before open',  RNQuery.SQL.Text);
      RNQuery.Open();

      OpenStopWatch.Stop;
      Processlog(ltInfo, 'GetCardQueryTable QueryTime', OpenStopWatch.ElapsedSecondsMillisecondsAsString);

      Result := RNQuery;

      parameterList.Free(); //2018-06-20 bls: F#840
      QueryBuilder.Free(); //2018-06-20 bls: F#840
   end;

begin
   Result := '';

   if (assigned(ProfileXML)) then begin
      FreeAndNil(ProfileXML);
   end;
   if (assigned(RNProfileDI)) then begin //2017-12-20 jtm: D#2620
      FreeAndNil(RNProfileDI);
   end;
   if (assigned(RNProfile)) then begin
      FreeAndNil(RNProfile);
   end;

   Line := TTTStringList.Create;
   TabText := TTTStringList.Create;
   If DisplayFormat = 'XML' then begin
      RecordFormatType := ttrftXML;
      CSV := TstringList.Create;
   end else If DisplayFormat = 'XLS'  then begin
      RecordFormatType := ttrftXLS;
      CSV := TstringList.Create;
   end else If DisplayFormat = 'AJAX'  then begin
      RecordFormatType := ttrftAJAX;
      HTML := TStringList.Create;
   end else If DisplayFormat = 'JSON' then begin
      RecordFormatType := ttrftJSON;
      JSON := TStringList.Create;
      JSON.Append('[');
   end else If DisplayFormat = 'GRID' then begin //2018-05-16 bls: F#840
      RecordFormatType := ttrftGRID;
      GRID := TStringList.Create();
   end else begin
      RecordFormatType := ttrftHTML;
      HTML := TStringList.Create;
   end;

   RNIDList := TStringList.Create;
   ServNameList := TStringList.Create;
   ServNameDescList := TStringList.Create;
   OpenStopWatch := TStopWatch.Create(false);
   DateRange := '';
   QueryBuilder := TStringList.Create(); //2018-06-20 bls: F#840
   ParameterList := TStringList.Create(); //2018-06-20 bls: F#840

   TranIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CCTRANIDENTDESC', 'Tran Ident')); //2018-04-30 bls: F#1129
   CustIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CCCUSTIDENTDESC', 'Cust Ident'));
   StoreSystemCodeLabel := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL', ''));
   TabText.Delimiter := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/PREFERREDDELIMITER', TAB)[1]; // String to Character conversion //2018-05-10 bls: D#2595

   useJSONResp := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEJSONFORGRIDS','TRUE')); //2018-07-18 bls: F#4978
   DisplayStoreName := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CARDHISTDISPLAYSTORENAME', 'FALSE'));
   if NOT isPaymentmate then begin
      AAllowAll := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/ALLOWALLSEARCH', 'FALSE'));
   end;
   DisplayInTZ := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE'));
   DisplayInAMPM := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINAMPM', 'FALSE'));
   IncludeEmpIdent := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEEMPIDENT', 'FALSE'));
   IncludeServiceName := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESERVICENAME', 'FALSE'));
   IncludeServiceNameDesc := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESERVICENAMEDESCRIPTION', 'FALSE'));
   IncludeCardHolderName := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDECARDHOLDERNAME', 'FALSE'));
   IncludeProfileFields := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEPROFILEFIELDS', 'FALSE'));
   ExcludeExtraAmount := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/EXCLUDEEXTRAAMOUNT', 'FALSE'));
   IncludeSFINDICATOR := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESFINDICATOR', 'FALSE'));
   IncludeCVVResp := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDECVVRESP', 'FALSE'));
   IncludeAVSResp := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEAVSRESP', 'FALSE'));
   IncludeAVSData := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEAVSDATA', 'FALSE')); // 2019-06-15 tjr: DVST-564
   AVSDataHeader := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/AVSDATAHEADER', 'AVSDATA'); // 2019-06-15 tjr: DVST-564
   IncludeProcessorToken := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESEARCHFIELD[@name="ProcessorToken"]', 'FALSE'));

   if not (DisplayInTZ) then begin
      ProcessLog(ltDebug,'PMACCESS.DISPLAYINTZ',RNReg.RegGetValAsString('PMACCESS.DISPLAYINTZ',''));
      if (RNReg.RegGetValAsString('PMACCESS.DISPLAYINTZ','FALSE') = 'TRUE') then begin //for APM
         DisplayInTZ := true;
      end;
   end;

   if ((AAllowAll) and (RNID = 'ALL')) then begin
      UsingAll := true;
      GetChainRNIDs(RNIDList);
      if NOT isPaymentmate then begin
         ASeparateStores := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEPARATESTORESONALLSEARCH', 'FALSE')); //2017-05-10 jtm F#1696
      end;   
   end else begin
      If NOT ValidateRNID(RNID)  then begin
         Result := 'Invalid Store Code';
         exit;
      end;
      UsingAll := false;
      RNIDList.Add(NumericOnly(RNID));
   end;

   CCResults := getCCRecords();
   CCResults.DisableControls;

   ReturnedRecs := 0;
   StartRow := 1;
   I := 0;
   TabText.Clear;
   PreviousRNID := Null;

   if xExport <> Nil then begin
      xlsWorkSheet := xExport.AddWorkSheet;
   end;
   
   if not ASeparateStores then begin
      if (UsingAll) then begin
         ProcessHeader('',true); //2017-05-10 jtm F#1696
      end else begin
         ProcessHeader(Trim(RNQuery.FieldByName('RNID').AsString), not(RNQuery.FieldByName('StoreCode').IsNull));
      end;
   end;

   while (NOT CCResults.EOF) do begin
      if (PreviousRNID <> Trim(CCResults.FieldByName('RNID').AsString)) then begin
         if (PreviousRNID <> Null) then begin  //finishing up an old RNID
            if ASeparateStores then begin  //2017-05-10 jtm F#1696
               ProcessFooter;
            end;
         end;
         GetProfileInfo(Trim(CCResults.FieldByName('RNID').AsString)); //2017-05-10 jtm F#1696
         if (IncludeServiceName) then begin //2018-01-29 jtm: D#3693
            ServiceNamesByRNID := GetServiceNamesByRNID(CCResults.FieldByName('RNID').AsString, '', ServNameList, ServNameDescList);
         end;

         if ASeparateStores then begin                     //2017-05-10 jtm F#1696
            ProcessHeader(Trim(CCResults.FieldByName('RNID').AsString), not(CCResults.FieldByName('StoreCode').IsNull));
         end;
         PreviousRNID := Trim(CCResults.FieldByName('RNID').AsString);
      end;

      if (CCResults.FieldByName('StoreCode').IsNull) then begin
         CCResults.Next;
         continue;
      end;

      inc(RNIDRecCount);
      Inc(I);
      case RecordFormatType of
         ttrftXML: FormatXML;
         ttrftXLS: FormatXLS;
         ttrftJSON: FormatJSON;
         ttrftGRID: begin //2018-06-20 bls: F#840
            If I = 1 then begin
               if useJSONResp then begin //2018-07-18 bls: F#4978
                  GRID.Add('{"total_count":' + SessionVarEval.GetValueAsString('totalCount') + ',"pos":' + posStart + ',"rows":[');
               end else begin
                  GRID.Add('<?xml version="1.0" encoding="UTF-8"?><rows total_count=''' + SessionVarEval.GetValueAsString('totalCount') + ''' pos= ''' + posStart + '''>');
               end;
            end;
            if useJSONResp then begin //2018-07-18 bls: F#4978
               FormatGridJSON;
            end else begin
               FormatGrid;
            end;
         end;
         ttrftHTML,
         ttrftAJAX: begin
            if I >= StartRow then begin
               FormatHTML
            end;
         end;
      end;
      RNQuery.Next;

      if (NOT RNQuery.EOF) AND (RecordFormatType = ttrftJSON) then JSON.Add(',')
      else if (NOT RNQuery.EOF) AND (RecordFormatType = ttrftGRID) and useJSONResp then GRID.Add(',');
   end;

   if (PreviousRNID <> Null) then begin  //Do the last footer
      ProcessFooter;
   end;
   case RecordFormatType of
      ttrftXML: begin
                  Result := CSV.Text;
                  Response.CustomHeaders.Values['Cache-Control'] := 'private';
                  Response.CustomHeaders.Values['Pragma'] := 'private';
               end;
      ttrftXLS: begin
                  Result := CSV.Text;
                  Response.CustomHeaders.Values['Cache-Control'] := 'private';
                  Response.CustomHeaders.Values['Pragma'] := 'private';
               end;
      ttrftJSON: begin
                  JSON.Add(']');
                  Result := TextWithoutNewLine(JSON);
               end;
      ttrftGRID: begin //2018-06-20 bls: F#840
                  if RNQuery.RecordCount = 0 then begin
                     if useJSONResp then begin //2018-07-18 bls: F#4978
                        GRID.Add('{"total_count":0,"pos":0,"rows":[');
                     end else begin
                        GRID.Append('<?xml version="1.0" encoding="UTF-8"?><rows total_count=''0'' pos= ''0''>');
                     end;
                  end;
                  if useJSONResp then begin
                     GRID.Add(']}');
                     Result := TextWithoutNewLine(GRID);
                  end else begin
                     Result := GRID.Text + '</rows>';
                  end;

                  Response.CustomHeaders.Values['Cache-Control'] := 'private';
                  Response.CustomHeaders.Values['Pragma'] := 'private';
               end;
      ttrftHTML: begin
                  ProcessEntryModeChart;
                  Result := HTML.Text;
               end;
      ttrftAJAX: begin
                  Result := HTML.Text;
               end;
   end;

   RNIDList.Free;
   if assigned(HTML) then HTML.Free;
   if assigned(CSV) then CSV.Free;
   if assigned(JSON) then JSON.Free;
   if assigned(GRID) then GRID.Free; //2018-06-20 bls: F#840
   if assigned(CCResults) then CCResults.Free;
   OpenStopWatch.Free;
   Line.Free;
   TabText.Free;
   ServNameList.Free;
   ServNameDescList.Free;
   processlog(ltInfo,'GetCardQueryTable RecCnt', StrI(ReturnedRecs, -1));
end;
Function TCustomerInfoModule.GetRNLocationSelector(SelectedRNID : String) :String;
var
   WS : String;
   I : Integer;
   Selected : Boolean;
Begin
   RNQuery.Close;
   RNQuery.SQL.Text := 'Select * from store where (ChainCode = ' + Stri(ChainCode,-1) + ')' +
                               ' Order by Name';
   RNQuery.Open;
   WS := '<select name="RNID" size="1">';
   I := 0;
   While Not RNQuery.EOF Do begin
      Inc(I);
      Selected := False;
      If SelectedRNID = RNQuery.FieldByName('SystemCode').AsString then
         Selected := true;
      If (SelectedRNID = '') and (I=1) then
         Selected := True;
      WS := WS + '<option ';
      If Selected then begin
         WS := WS + 'Selected ';
         StoreName := Trim(RNQuery.FieldByName('Name').AsString);
         StoreAddress1 := Trim(RNQuery.FieldByName('Address1').AsString);
         StoreAddress2 := Trim(RNQuery.FieldByName('Address2').AsString);
         StoreCity := Trim(RNQuery.FieldByName('City').AsString);
         StoreState := Trim(RNQuery.FieldByName('State').AsString);
         StoreZip := Trim(RNQuery.FieldByName('ZIP').AsString);
      end;

      WS := WS + 'value="'+ RNQuery.FieldByName('SystemCode').AsString +'">'+
                 Trim(RNQuery.FieldByName('Name').AsString) + ', '+
                 Trim(RNQuery.FieldByName('City').AsString) + ' ' +
                 Trim(RNQuery.FieldByName('State').AsString) + '</option>';
      RNQuery.Next;
   end;
   WS := WS + '</select>';

   RNQuery.Close;
   Result := WS;
end;
Function TCustomerInfoModule.SetLocationRNIDOrAll(AQueryFields: TStrings): String;
begin
   Result := AQueryFields.Values['LOCATIONRNID'];
   if (Result <> 'ALL') then begin
      Result := NumericOnly(Result);
   end;
end;
Function TCustomerInfoModule.ValidateRNID(RNID : String): Boolean;
var
   Qry: TAdoQuery;
Begin
   Qry := NewADOQuery;
   Result := False;
   If NumericOnly(RNID) = '' then exit;

   Qry.Close;
   Qry.SQL.Text := 'Select * from Store where (SystemCode = ' + NumericOnly(RNID) + ')';
   Qry.Open;

   If Qry.FieldByName('chaincode').AsInteger = ChainCode then begin
      Result := True;
   end;
   StoreInfo := GetStoreInfo(Valu(RNID));
   Qry.Close;
   FreeAndNil(Qry);
end;
Function TCustomerInfoModule.SetChaincodeByRNID(RNID : String):Boolean;
Begin
   RNQuery.Close;
   RNQuery.SQL.Text := 'Select ChainCode from Store where (SystemCode = ' + NumericOnly(RNID) + ')';
   RNQuery.Open;
   Result := False;
   ChainCode := -1;
   If RNQuery.RecordCount = 1 then begin
      Result := True;
      ChainCode := RNQuery.FieldByName('ChainCode').AsInteger;
   end;
   StoreInfo := GetStoreInfo(Valu(RNID));

end;
Function TCustomerInfoModule.SetRNIDByCHain(ChainStoreCode : String):Integer;
Begin
   RNQuery.Close;
   RNQuery.SQL.Text := 'Select SystemCode from Store where (ChainCode = ' + Stri(ChainCode,-1) + ') and ' +
                                                          '(StoreID = ''' + AlphaNumericOnly(ChainStoreCode) + ''')';
   RNQuery.Open;
   Result := -1;
   If RNQuery.RecordCount = 1 then begin
      Result := RNQuery.FieldByName('SystemCode').AsInteger;
   end else begin
      ChainCode := 0
   end;
   If Result >0 then
      StoreInfo := GetStoreInfo(Result)
   else
      StoreInfo := '';

end;


Function TCustomerInfoModule.TCKEffectiveStatus(ADS : TDataSet) : Integer;
var
  ES : Integer;
Begin
  ES := 0;
  If (Trim(ADS.FieldByName('ECATranStatus').AsString) = '1') and
     (ADS.FieldByName('ECAAcceptdate').AsDateTime > 0) and
     (NOT ADS.FieldByName('Voided').AsBoolean) then
     ES := 1;

  If (Trim(ADS.FieldByName('ECATranStatus').AsString) = '3')
     Then ES := 3;
  If (Trim(ADS.FieldByName('ECATranStatus').AsString) = '4')
     Then ES := 4;
  If (Trim(ADS.FieldByName('ECATranStatus').AsString) = '')
     Then ES := -1;
  If (Trim(ADS.FieldByName('ECATranStatus').AsString) = '-')
     Then ES := -1;
  Result := ES;

end;

Function TCustomerInfoModule.ColorByECAStatus(AStatus : integer) : String;
Begin
   Case AStatus of
      0: Result := '<font color="Black">';
      1: Result := '<font color="Green">';
      3: Result := '<font color="Red">';
      4: Result := '<font color="Red">';
     -1: Result := '<font color="Blue">';
   end;
end;

Function TCustomerInfoModule.ColorByECAStatusJSON(AStatus : integer) : String; //2018-07-18 bls: F#4978
Begin
   Case AStatus of
      0: Result := '<font color=\"Black\">';
      1: Result := '<font color=\"Green\">';
      3: Result := '<font color=\"Red\">';
      4: Result := '<font color=\"Red\">';
     -1: Result := '<font color=\"Blue\">';
   end;
end;
Function TCustomerInfoModule.TCKStatusImage(ADS : TDataSet) : String;
Begin
   Result := '';
   Case TCKEffectiveStatus(ADS) of
       0 : Result := '<IMG SRC="/Images/General/CheckSmall.gif" border="0" style="display: inline-block">'; //2018-06-20 bls: F#840
       1 : Result := '<IMG SRC="/Images/General/BoltSmall.gif" border="0" style="display: inline-block">'; //2018-06-20 bls: F#840
       3 : Result := '<IMG SRC="/Images/General/XFailed.gif" border="0" style="display: inline-block">'; //2018-06-20 bls: F#840
       4 : Result := '<IMG SRC="/Images/General/XFailed.gif" border="0" style="display: inline-block">'; //2018-06-20 bls: F#840
      -1 : Result := '<IMG SRC="/Images/General/ExclamationSmall.gif" border="0" style="display: inline-block">'; //2018-06-20 bls: F#840
   end;

end;
Function TCustomerInfoModule.TCKStatusImageJSON(ADS : TDataSet) : String; //2018-07-18 bls: F#4978
Begin
   Result := '';
   Case TCKEffectiveStatus(ADS) of
       0 : Result := '<IMG SRC=\"\/Images\/General\/CheckSmall.gif\" border=\"0\" style=\"display: inline-block\">'; //2018-06-20 bls: F#840
       1 : Result := '<IMG SRC=\"\/Images\/General\/BoltSmall.gif\" border=\"0\" style=\"display: inline-block\">'; //2018-06-20 bls: F#840
       3 : Result := '<IMG SRC=\"\/Images\/General\/XFailed.gif\" border=\"0\" style=\"display: inline-block\">'; //2018-06-20 bls: F#840
       4 : Result := '<IMG SRC=\"\/Images\/General\/XFailed.gif\" border=\"0\" style=\"display: inline-block\">'; //2018-06-20 bls: F#840
      -1 : Result := '<IMG SRC=\"\/Images\/General\/ExclamationSmall.gif\" border=\"0\" style=\"display: inline-block\">'; //2018-06-20 bls: F#840
   end;

end;
Function TCustomerInfoModule.TCKCheckDetails(SystemCode:Integer) : String;
var
   WS : String;
   Trace : String;
   RNID : String;
   ImageSize : integer;
   ImageSC : INteger;
   CheckHoriz : boolean;
Begin
   Result := '';
   If Not LoadTCAuth(SystemCode) Then begin
      Result := 'Could not load Check Details';
      exit;
   end;

   CheckHoriz := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ALIGNCHECKHORIZONTAL', 'FALSE'));
   if CheckHoriz then
      WS := WS + '<TABLE border="0"><TR><TD>';
   WS := WS + '<TABLE border="1" cellspacing="0" cellpadding="3" bordercolorlight="#0000FF" style="border-collapse: collapse">';
   WS := WS + '<TR><TD Align="Right"><B>RNID<BR>Location</B></TD><TD>' + RNQuery.FieldByName('StoreCode').AsString +'<BR>' +StoreInfo+'</TD></TR>';
   WS := WS + '<TR><TD Align="Right"><B>Auth Date</B></TD><TD>' + RNQuery.FieldByName('AuthDate').AsString +'</TD></TR>';
   If RNQuery.FieldByName('Voided').AsBoolean then
      WS := WS + '<TR><TD Align="Right"><B>Date Voided</B></TD><TD>' + RNQuery.FieldByName('VoidedDate').AsString +'</TD></TR>';

   WS := WS + '<TR><TD Align="Right"><B>Amount</B></TD><TD>$' + Trim(StriREal(RNQuery.FieldByName('TranAMount').AsFloat,2)) +'</TD></TR>';
   WS := WS + '<TR><TD Align="Right"><B>Check Number</B></TD><TD>' + RNQuery.FieldByName('ResponseCheckNumber').AsString +'</TD></TR>';
   WS := WS + '<TR><TD Align="Right"><B>Check Type</B></TD><TD>' + RNQuery.FieldByName('CheckType').AsString +'</TD></TR>';

   WS := WS + '<TR><TD Align="Right"><B>TCK Response</B></TD><TD>' + ColorByECAStatus(TCKEffectiveStatus(RNQuery)) +
                                                                     RNQuery.FieldByName('DisplayText').AsString +'</FONT></TD></TR>';
   WS := WS + '<TR><TD Align="Right"><B>Status</B></TD><TD>' + RNQuery.FieldByName('ECATranStatus').AsString +'</TD></TR>';
   WS := WS + '<TR><TD Align="Right"><B>Approval Code</B></TD><TD>' + RNQuery.FieldByName('ApprovalCode').AsString +'</TD></TR>';
   WS := WS + '<TR><TD Align="Right"><B>Trace ID</B></TD><TD>' + RNQuery.FieldByName('TraceID').AsString +'</TD></TR>';

   WS := WS + '<TR><TD Align="Right"><B>Tran Ident</B></TD><TD>' + RNQuery.FieldByName('TranIdent').AsString +'</TD></TR>';
   WS := WS + '<TR><TD Align="Right"><B>Batch Serial</B></TD><TD>' + RNQuery.FieldByName('BatchSerial').AsString +'</TD></TR>';
   If Trim(RNQuery.FieldByName('DenialRecordNumber').AsString) <> '' then
      WS := WS + '<TR><TD Align="Right"><B>Denial Record Number</B></TD><TD>' + RNQuery.FieldByName('DenialRecordNumber').AsString +'</TD></TR>';

   WS := WS + '<TR><TD Align="Right"><B>MID</B></TD><TD>' + RNQuery.FieldByName('TCMID').AsString +'</TD></TR>';
   WS := WS + '<TR><TD Align="Right"><B>Service Name</B></TD><TD>' + RNQuery.FieldByName('TCServiceName').AsString +'</TD></TR>';
   WS := WS + '<TR><TD Align="Right"><B>Station</B></TD><TD>' + RNQuery.FieldByName('StationIdent').AsString +'</TD></TR>';
   WS := WS + '<TR><TD Align="Right"><B>Store System Code</B></TD><TD>' + RNQuery.FieldByName('StoreSystemCode').AsString +'</TD></TR>';
   WS := WS + '<TR><TD Align="Right"><B>RN System Code</B></TD><TD>' + RNQuery.FieldByName('SystemCode').AsString +'</TD></TR>';


   WS := WS + '</TABLE>';
   Trace := Trim(RNQuery.FieldByName('TraceID').AsString);
   RNID := Trim(RNQuery.FieldByName('StoreCode').AsString);
   ImageSize := RNQuery.FieldByName('ImageSize').AsInteger;
   ImageSC := RNQuery.FieldByName('SystemCode').AsInteger;

   If Trace <> '' then begin
      RNQuery.Close;
      RNQuery.SQL.Text := 'Select * from tckfunddetail where  (AuthTrace =''' + Trace +''') Order by DetailDate';
      RNQuery.Open;
      If RNQuery.RecordCount > 0 then begin
         WS := WS + '<BR><B>Funding Summary</B></BR>';
         WS := WS + '<TABLE border="1" cellspacing="0" cellpadding="3" bordercolorlight="#0000FF" style="border-collapse: collapse">';
         WS := WS + '<TR><TD><B>Submit Date</B></TD><TD><B>Effective Date</B></TD><TD><B>Credit/Debit</B></TD><TD><B>Amount</B></TD><TD><B>Reason</B></TD><TD><B>Fund To Acct</B></TD></TR>';
         While not RNQuery.EOF do begin
            WS := WS + '<TR><TD>'+Trim(RNQuery.FieldByName('SubDate').AsString)+'</TD>' +
                           '<TD>'+Trim(RNQuery.FieldByName('EffectiveDate').AsString)+'</TD>' +
                           '<TD>'+Trim(RNQuery.FieldByName('CreditDebit').AsString)+'</TD>' +
                           '<TD align="RIGHT">'+Trim(StriReal(RNQuery.FieldByName('Amount').AsFloat,2))+'</TD>' +
                           '<TD>'+Trim(RNQuery.FieldByName('Reason').AsString)+'</TD>' +
                           '<TD align="RIGHT">'+Trim(RNQuery.FieldByName('FundToAcct').AsString)+'</TD>' + '</TR>';
            RNQuery.Next;
         end;
         WS := WS + '</TABLE><BR>';

      end;
   end;

   If ImageSize > 0 then begin
      if CheckHoriz then
         WS := WS + '</TD><TD>';
      WS := WS + '<TABLE border="0" style="width:800px">';
      WS := WS + '<TR><TD style="height:250px"><B><IMG SRC="GETCHECKIMAGE?CHECKCODE='+Stri(ImageSC,-1) + '&LOCATIONRNID=' + trim(RNID)+'"  border="0"></B></TD></TR></TABLE>';  // 2019-06-15 tjr: DVST-3507
      if CheckHoriz then
         WS := WS + '</TD></TR></TABLE>';
   end else begin
      if CheckHoriz then
         WS := WS + '</TD></TABLE>';
      WS := WS + '<BR>Image Not Available<BR>';
   end;

   If ImageSize > 0 then begin
      WS := WS + '<DIV id="hasImage" style="display: none">';
   end else begin
      WS := WS + '<DIV id="noImage" style="display: none">';
   end;
   WS := WS + '</DIV>';

   Result := WS;



end;

procedure TCustomerInfoModule.CustomerInfoModuleWebActionItem2Action(
  Sender: TObject; Request: TWebRequest; Response: TWebResponse;
  var Handled: Boolean);
Var
   WS: String;
   TifData,firstfour : String;
   S: TMemoryStream;
   CheckSC : String;
   ImageGUID : String;
   FN : string;   //2017-03-22 jtm: Feat OT#1414
   tiff: TTiffImage;//2017-03-22 jtm: Feat OT#1414
begin
  If Not RNSessionChainAuthenticate then exit;
  GetSessionID;
  WS := GetStyle('');
  RNReg.ChainCode := ChainCode;
  CheckSC :=NumericOnly(Request.queryfields.Values['CHECKCODE']);
  ProcessLog(0,ltInfo,'Starting Authentication','GETCHECKIMAGE','',0,CheckSC);
  If Not LoadTCAuth(Valu(Request.queryfields.Values['CHECKCODE'])) then exit;
  ProcessLog(0,ltInfo,'Authenticated','GETCHECKIMAGE','',0,CheckSC);

  Try
     if (RNReg.RegGetValAsString('PMACCESS.USELEGACYIMGCONVERT','FALSE') = 'TRUE') then begin //for APM //2018-01-25 jtm D#3544
         firstfour :=  copy(RNQuery.fieldByName('Imagedata').AsString, 0, 4);
         ProcessLog(ltDebug, 'DecodeImageData', firstfour);
         if (firstfour = 'IKag') then begin   //Old starts with IKag
            TIFData := Base64Decode(RNQuery.fieldByName('Imagedata').AsString);
         end else begin
            TIFData := STDBase64Decode(RNQuery.fieldByName('Imagedata').AsString); //and new starts with SUkq
         end;
     end else begin
         TIFData := STDBase64Decode(RNQuery.fieldByName('Imagedata').AsString);
     end;
  except
     On E:Exception do begin
        ProcessLog(0,ltWarning,'Image Decode Exception','GETCHECKIMAGE','Image Size=' + Stri(Length(RNQuery.fieldByName('Imagedata').AsString),-1),0,Request.queryfields.Values['CHECKCODE']);
     end;
  end;

   ImageGUID := GenerateGUID;
   FN := 'c:\ImageCache\' + ImageGUID + '.TIF';     //2017-03-22 jtm: Feat OT#1414
   SaveStringAsFile(FN,TIFData);
   if not assigned(gdip) then begin
      Gdip.RegisterPictures;
   end;

   If Not FileExists(FN) then begin
      ProcessLog(ltWarning, 'Image File does Not Exist', FN);
      exit;
   end;

   tiff := TTiffImage.Create;
   S := TMemoryStream.Create;
   tiff.LoadFromFile(FN);
   Try  //2017-03-22 jtm: Feat OT#1414
      SaveAs(tiff,S,gptJPG,80,700,200);
      ProcessLog(ltInfo, 'Image Resize complete, Setting TIF DPI to 200', 'Width:700');
   except
      On E:Exception do begin
        ProcessLog(ltInfo, 'Exception during resize', e.Message);
      end;
   end;

  (*Jpg := TJpegImage.Create;
  try
     JPG.CompressionQuality := 90;
     Jpg.Assign(LI.Picture.Bitmap);
     ProcessLog(0,ltInfo,'JPGOK' + Stri(JPG.Width,-1),'GETCHECKIMAGE','Image Size=' + Stri(Length(RNQuery.fieldByName('Imagedata').AsString),-1),0,Request.queryfields.Values['CHECKCODE']);
  except
    on E:Exception do begin
     ProcessLog(0,ltInfo,'JPGConv Fail' + Stri(LI.Compression,-1),'GETCHECKIMAGE','Image Size=' + Stri(Length(RNQuery.fieldByName('Imagedata').AsString),-1),0,Request.queryfields.Values['CHECKCODE']);

    end;
  end;

  If JPG.Width = 0 then begin //Redo it for other decode
     JPG.Free;
     LI.Free;
     TIFData := STDBase64Decode(RNQuery.fieldByName('Imagedata').AsString);
     SaveStringAsFile('c:\ImageCache\' + ImageGUID + '.TIF',TIFData);
     LI := TLoadImage.create(NIL);
     LI.Width := 700;
     LI.Height := 300;
     with LI.Picture do begin
        Cur_Rect := Bounds(0, 0, 700, 300);
     end;
     THM := TTifHeaderManager.Create('c:\ImageCache\' + ImageGUID + '.TIF'); //we need to do this before we assign the ImageFileName property of LI because LI creates some kind of lock on the file
     LI.ImageFileName := 'c:\ImageCache\' + ImageGUID + '.TIF';
     LI.ReScale := 50;

     if THM.TLoadImageShouldInvert then begin //in other implementations we had to do some wonky stuff here since Invert acts more like a toggle. Since this thing gets disposed each time (CGI) we aren't worried about setting invert back to false
      LI.Invert := true;
     end;

     LI.ReDraw(Cur_rect, False, True);
     FreeAndNil(THM);


     Jpg := TJpegImage.Create;
     try
        JPG.CompressionQuality := 90;
        Jpg.Assign(LI.Picture.Bitmap);
        ProcessLog(0,ltInfo,'JPGOK' + Stri(JPG.Width,-1),'GETCHECKIMAGE','Image Size=' + Stri(Length(RNQuery.fieldByName('Imagedata').AsString),-1),0,Request.queryfields.Values['CHECKCODE']);
     except
       on E:Exception do begin
        ProcessLog(0,ltInfo,'JPGConv Fail' + Stri(LI.Compression,-1),'GETCHECKIMAGE','Image Size=' + Stri(Length(RNQuery.fieldByName('Imagedata').AsString),-1),0,Request.queryfields.Values['CHECKCODE']);

        end;
     end;
  end;     *)


  DeleteFiles('c:\ImageCache\' + ImageGUID + '.TIF');

  S.Position := 0;
  Response.ContentType := 'image/jpeg';
  Response.ContentStream := S;// do not free the stream because the response
  tiff.Free;

end;
Function TCustomerInfoModule.LoadTCAuth(SystemCode : integer) : boolean;
Begin
   Result := False;
   RNQuery.Close;
   RNQuery.SQL.Text := 'Select * from TCAuth where (SystemCode = ' + Stri(SystemCode,-1) + ')';
   RNQuery.Open;
   If RNQuery.RecordCount = 0 then begin
      exit;
   end;
   If NOT ValidateRNID(RNQuery.FieldByName('StoreCode').AsString) then begin
      exit;
   end;
   RNQuery.Close;
   RNQuery.SQL.Text := 'Select * from TCAuth where (SystemCode = ' + Stri(SystemCode,-1) + ')';
   RNQuery.Open;
   REsult := RNQuery.RecordCount = 1;

end;
Function TCustomerInfoModule.GetStoreInfo(RNID : Integer) : String;
var
   Qry: TAdoQuery;
Begin
   Qry := NewADOQuery;
   Result := '';
   Qry.Close;
   Qry.SQL.Text := 'Select * from Store where (SystemCode = ' + Stri(RNID,-1) + ')';
   Qry.Open;
   StoreName := '';
   StoreAddress1 := '';
   StoreAddress2 := '';
   StoreCity := '';
   StoreState := '';
   StoreZip := '';
   StorePhone := '';
   If Qry.RecordCount = 1 then begin
      Result := Result + Trim(Qry.FieldByName('Name').AsString) + '<BR>';
      Result := Result + Trim(Qry.FieldByName('Address1').AsString) + '<BR>';
      If Trim(Qry.FieldByName('Address2').AsString) <> '' then
         Result := Result + Trim(Qry.FieldByName('Address2').AsString) + '<BR>';
      Result := Result + Trim(Qry.FieldByName('City').AsString) + ', ';
      Result := Result + Trim(Qry.FieldByName('State').AsString) + ' ';
      Result := Result + Trim(Qry.FieldByName('ZIP').AsString) + '<BR>';

      StoreName := Trim(Qry.FieldByName('Name').AsString);
      StoreAddress1 := Trim(Qry.FieldByName('Address1').AsString);
      StoreAddress2 := Trim(Qry.FieldByName('Address2').AsString);
      StoreCity := Trim(Qry.FieldByName('City').AsString);
      StoreState := Trim(Qry.FieldByName('State').AsString);
      StoreZip := Trim(Qry.FieldByName('ZIP').AsString);
      StorePhone := Trim(Qry.FieldByName('Voice').AsString);
   end;
   Qry.Close;
   FreeAndNil(Qry);
end;
procedure TCustomerInfoModule.CustomerInfoModuleRNCHAINAUTHAction(
  Sender: TObject; Request: TWebRequest; Response: TWebResponse;
  var Handled: Boolean);
var
   User : String;
   Pass : String;
   Path : String;
   Authenicated : boolean;
begin
   ProcessLog(ltInfo,'RNChainAuth',InstanceGUID);
   ProcessLog(ltInfo,'RNChainAuth',Request.Content);
   ProcessLog(ltInfo,'RNChainAuth',Request.ContentFields.Commatext);

   User := Request.ContentFields.Values['USERNAME'];
   Pass := Request.ContentFields.Values['PASSWORD'];
   PATH := Request.ContentFields.Values['REFERPATH'];

   Authenicated := false;

   ProcessLog(ltInfo,'RNChainAuth',user + '/' + Pass + '/' + Path);

   GetSessionID;
   RNQuery.Close;
   RNQuery.SQL.Clear;
   RNQuery.SQL.Add('Select SystemCode, LogonPassword from chains where systemcode = ' + NumericOnly(User));
   RNQuery.Open;

   ProcessLog(ltInfo,'RNCHAINAUTH Opened RNQuery Query',Stri(RNQuery.RecordCount,-1) + ' Records');

   SessionAuthQuery.Close;
   SessionAuthQuery.SQL.Clear;
   SessionAuthQuery.SQL.Add('Select * from WWWSession where RNSessionID = ''' + RnSessionID + '''');
   SessionAuthQuery.Open;

   If (RNQuery.RecordCount = 1) and (Trim(RNQuery.FieldByName('LogonPassword').AsString) = Trim(Pass)) then begin
      Authenicated := true;
      ChainCode := RNQuery.FieldByName('SystemCode').AsInteger;
   end;
   if (Authenicated) then begin
      ProcessLog(ltInfo,'RNCHAINAUTH', 'Authenticated');


      If SessionAuthQuery.RecordCount = 1 then begin
         SessionAuthQuery.Edit;
         SessionAuthQuery.FieldByName('ChainCode').AsInteger := ChainCode;
         SessionAuthQuery.FieldByName('ChainAuthenticatedTill').AsDateTime := Now + EncodeTime(1,0,0,0);
         SessionAuthQuery.Post;
      end;
   end else begin
      ProcessLog(ltWarning,'RNCHAINAUTH', 'Authentication Failed');
   end;
   Response.ContentType := 'text/html';
   Response.Content := '<head><title>Tempus RetailNet</title>' +
                       '<meta http-equiv="refresh" content="0;URL=' + Trim(SessionAuthQuery.FieldByName('Dest').AsString) + '"></head>';
end;

procedure TCustomerInfoModule.CustomerInfoModuleLOGOFFCHAINAction(
  Sender: TObject; Request: TWebRequest; Response: TWebResponse;
  var Handled: Boolean);
begin
   GetSessionID;
   SessionAuthQuery.Close;
   SessionAuthQuery.SQL.Clear;
   SessionAuthQuery.SQL.Add('Select * from WWWSession where RNSessionID = ''' + RnSessionID + '''');
   SessionAuthQuery.Open;
   If SessionAuthQuery.RecordCount = 1 then begin
      SessionAuthQuery.Edit;
      SessionAuthQuery.FieldByName('ChainAuthenticatedTill').AsDateTime := 0;
      SessionAuthQuery.Post;
   end;


   Response.ContentType := 'text/html';
   Response.Content := '<head><title>Tempus RetailNet</title>' +
                       '<meta http-equiv="refresh" content="0;URL=' + Request.QueryFields.Values['REFERPATH']+'"></head>';

end;

procedure TCustomerInfoModule.CustomerInfoModuleEchoAction(Sender: TObject;
  Request: TWebRequest; Response: TWebResponse; var Handled: Boolean);
begin
   Response.ContentType := 'text/xml';
   Response.Content := Request.Content;
end;

Function TCustomerInfoModule.GetRNCERT(RNID : Integer) : String;
var
   Cert : TStringList;
Begin
   Result := '';
   If FileExists('\\RNDB02\Corpsys\Keys\' + Stri(RNID,-1) + '.KEY') then begin
      Cert := TStringList.Create;
      Try
         Cert.LoadFromFile('\\RNDB02\Corpsys\Keys\' + Stri(RNID,-1) + '.KEY');
         If Cert.Count > 0 then begin
            Result := AESToRNCert(Cert[0]);
         end;
      except
         On E:Exception do begin
         end;
      end;
      Cert.Free;
   end;

end;


Procedure TCustomerInfoModule.ProcessLog(Severity : Integer; EventName : String; Info: String);
begin
   if (Severity = ltDebug) then begin
      if (debuglevel = 1) then begin
         PL.ProcessLog(Severity,EventName, info);
      end;
   end else begin
      PL.ProcessLog(Severity,EventName, info);
   end;
end;

Procedure TCustomerInfoModule.ProcessLog(ThreadID : Integer; Severity : Integer; EventName : String; Info: String;TransactionType : String; OpCode : Integer; Account : String);
var
   WS : String;
Begin
   PL.AddAppValue('ACCOUNT', Account);
   PL.ProcessLog(Severity,EventName,Info);

end;


Function TCustomerInfoModule.GetChainRNIDs(ASL : TStringList) : Integer;
var
   I : Integer;
Begin
   ASL.Clear;
   RNQuery.Close;
   RNQuery.SQL.Text := 'Select * from store where (ChainCode = ' + Stri(ChainCode,-1) + ')' +
                               ' Order by Name';
   RNQuery.Open;
   I := 0;
   While Not RNQuery.EOF Do begin
      Inc(I);
      ASL.Add(RNQuery.FieldByName('SystemCode').AsString);
      RNQuery.Next;
   end;
   RNQuery.Close;
   Result := I;
end;

procedure TCustomerInfoModule.CustomerInfoModuleWebVTAction(
  Sender: TObject; Request: TWebRequest; Response: TWebResponse;
  var Handled: Boolean);
Var
   WS: String;
   OKToAuth : Boolean;
   AuthHints : String;
   XS : String;
   MICR : String;
   TCRequest : TStringList;
   TCResponse : TStringList;
   XRM : String;
   RNID : String;
begin
   Response.ContentType := 'text/html';
   GetSessionID;
   RNID := RNLoadHostName;
   IF RNID = '' then begin
      Response.Content := 'Invalid HostName';
      exit;
   end;
   RNReg.ChainCode := ChainCode;

   WS := '';

   WS := WS + GetStyle('');
   if UpCaseString(Request.host) = 'DEV.SPECTRUMRETAILNET.COM' then begin
      WS := WS + UpCaseString(Request.host) + '<BR>';
      WS := WS + 'ChainCode=' + Stri(ChainCode,-1);
      WS := WS + 'RNID=' + RNID;
   end;
   WS := WS + '<script type="text/javascript">';
   WS := WS + 'function OnPL() {';
   ws := ws + '   document.getElementById("LoadImg").style.display = "none";';
   ws := ws + '   ShowHide();';
   WS := WS + '}';
   WS := WS + 'function BackToAuth() {';
   ws := ws + '   document.getElementById("AUTH").style.display = "";';
   ws := ws + '   document.getElementById("Legal").style.display = "none";';
   ws := ws + '   document.getElementById("Retry").style.display = "none";';
   ws := ws + '   ShowHide();';
   WS := WS + '}';

   WS := WS + 'function newXMLHttpRequest() {';
   WS := WS + '		var xmlreq = false;';
   WS := WS + '		if (window.XMLHttpRequest) {';
   WS := WS + '			xmlreq = new XMLHttpRequest();';
   WS := WS + '		} else if (window.ActiveXObject) {';
   WS := WS + '			try {';
   WS := WS + '				xmlreq = new ActiveXObject("Microsoft.XMLHTTP");';
   WS := WS + '			}';
   WS := WS + '			catch (e2) {';
   WS := WS + '				alert("Unable to create a Microsoft.XMLHTTP XMLHttpRequest.");';
   WS := WS + '			}';
   WS := WS + '		}';
   WS := WS + '		return xmlreq;';
   WS := WS + '	}';

   WS := WS + 'function Authorize() {';
   ws := ws + '   document.getElementById("Legal").style.display = "none";';
   ws := ws + '   document.getElementById("AuthSpin").style.display = "";';
   ws := ws + '   var ProcessCheckRequest= newXMLHttpRequest();';

   ws := ws + '    ProcessCheckRequest.open("POST", "https://' + Request.Host + '/webvt?ACTION=CHECKAUTH", false);';

   ws := ws + '                ProcessCheckRequest.send("<TRANSACTION>" +';
   ws := ws + '                                        "   <CHECKAMT>"+document.getElementById("CHECKAMT").value+"</CHECKAMT>" +';
   ws := ws + '                                        "   <FIRSTNAME>"+document.getElementById("FIRSTNAME").value+"</FIRSTNAME>" +';
   ws := ws + '                                        "   <LASTNAME>"+document.getElementById("LASTNAME").value+"</LASTNAME>" +';
   ws := ws + '                                        "   <CHECKROUTING>"+document.getElementById("ROUTING").value+"</CHECKROUTING>" +';
   ws := ws + '                                        "   <CHECKACCOUNT>"+document.getElementById("ACCOUNT").value+"</CHECKACCOUNT>" +';
   ws := ws + '                                        "   <CHECKNUMBER>"+document.getElementById("CHECKNUM").value+"</CHECKNUMBER>" +';
   ws := ws + '                                        "   <CHECKDL>"+document.getElementById("DLNUM").value+"</CHECKDL>" +';
   ws := ws + '                                        "   <CHECKDLSTATE>"+document.getElementById("STATE").value+"</CHECKDLSTATE>" +';
   ws := ws + '                                        "   <CHECKEMAIL>"+document.getElementById("EMAIL").value+"</CHECKEMAIL>" +';
   ws := ws + '                                        "   <TRANIDENT>' +Trim(Request.queryfields.Values['TRANIDENT']) +'</TRANIDENT>" +';


   ws := ws + '                                        "</TRANSACTION>\r\n");';


   WS := WS + '	  try {';
   ws := ws + '      var TranResult = ProcessCheckRequest.responseXML.documentElement.getElementsByTagName("TCECASTATUS")[0].firstChild.nodeValue;';
   ws := ws + '      if (TranResult == "4"){';
   ws := ws + '         document.getElementById("AuthSpin").style.display = "none";';
   ws := ws + '         document.getElementById("CheckDecline").style.display = "";';
   ws := ws + '         return;';
   ws := ws + '      }';
   ws := ws + '      if (TranResult == "3"){';
   ws := ws + '         document.getElementById("AuthSpin").style.display = "none";';
   ws := ws + '         document.getElementById("CheckDecline").style.display = "";';
   ws := ws + '         return;';
   ws := ws + '      }';
   ws := ws + '      if (TranResult == "1"){';
   ws := ws + '         document.getElementById("AuthSpin").style.display = "none";';
   ws := ws + '         document.getElementById("CheckApproved").style.display = "";';
   ws := Ws + '         document.getElementById("CONFIRMNUM").innerHTML = ' +
                           'ProcessCheckRequest.responseXML.documentElement.getElementsByTagName("TCAPPROVALCODE")[0].firstChild.nodeValue + "-" +' +
                           'ProcessCheckRequest.responseXML.documentElement.getElementsByTagName("TCSYSTEMCODE")[0].firstChild.nodeValue;';
   ws := ws + '         return;';
   ws := ws + '      }';

   WS := WS + '	      }';
   WS := WS + '	  catch (e3) {';

   WS := WS + '	  }';





   ws := ws + '   if (ProcessCheckRequest.responseXML.documentElement.getElementsByTagName("TRANRESPMESSAGE")[0].firstChild.nodeValue == "PLEASE RETRY"){';
   ws := ws + '      document.getElementById("AuthSpin").style.display = "none";';
   ws := ws + '      document.getElementById("Retry").style.display = "";';
   ws := ws + '      return;';
   ws := ws + '   }';
   ws := ws + '   if (ProcessCheckRequest.responseXML.documentElement.getElementsByTagName("TRANRESPMESSAGE")[0].firstChild.nodeValue == "NOT ELIGIBLE FOR ELECTRONIC"){';
   ws := ws + '      document.getElementById("AuthSpin").style.display = "none";';
   ws := ws + '      document.getElementById("Retry").style.display = "";';
   ws := ws + '      return;';
   ws := ws + '   }';
   ws := ws + '   document.getElementById("AuthSpin").style.display = "none";';
   ws := ws + '   document.getElementById("TranFail").style.display = "";';
   ws := ws + '   return;';




   ws := ws + ' document.getElementById("AuthSpin").innerHTML= TranResult + ProcessCheckRequest.responseText;';



   WS := WS + '}';

   ws := Ws + 'function trim(stringToTrim) {';
   ws := Ws + '	return stringToTrim.replace(/^\s+|\s+$/g,"");';
   ws := Ws + '}';
   ws := Ws + 'function isValidEmail(str) {';
   ws := Ws + '   return (str.indexOf(".") > 2) && (str.indexOf("@") > 0);';
   ws := Ws + '}';

   ws := Ws + 'function CalcKeyCode(aChar) {';
   ws := Ws + '  var character = aChar.substring(0,1);';
   ws := Ws + '  var code = aChar.charCodeAt(0);';
   ws := Ws + '  return code;';
   ws := Ws + '}';

   ws := Ws + 'function checkNumber(val) {';
   ws := Ws + '  var strPass = val.value;';
   ws := Ws + '  var strLength = strPass.length;';
   ws := Ws + '  var lchar = val.value.charAt((strLength) - 1);';
   ws := Ws + '  var cCode = CalcKeyCode(lchar);';
   ws := Ws + '  if (cCode < 48 || cCode > 57 ) {';
   ws := Ws + '    var myNumber = val.value.substring(0, (strLength) - 1);';
   ws := Ws + '    val.value = myNumber;';
   ws := Ws + '  }';
   ws := Ws + '  return false;';
   ws := Ws + '}';

   WS := WS + 'function StartPayment() {';

   ws := ws + '   if (document.getElementById("CHECKAMT").value <= 0){';
   ws := ws + '      document.getElementById("CHECKAMTHINT").innerHTML = "  Amount must be greater than $0.00";';
   ws := ws + '      return;';
   ws := ws + '   }';
   ws := ws + '   document.getElementById("CHECKAMTHINT").innerHTML = "";';


   ws := ws + '   document.getElementById("FIRSTNAME").value = trim(document.getElementById("FIRSTNAME").value.toUpperCase());';
   ws := ws + '   if (document.getElementById("FIRSTNAME").value == ""){';
   ws := ws + '      document.getElementById("NAMEHINT").innerHTML = "  First Name Required";';
   ws := ws + '      return;';
   ws := ws + '   }';
   ws := ws + '   document.getElementById("NAMEHINT").innerHTML = "";';

   ws := ws + '   document.getElementById("LASTNAME").value = trim(document.getElementById("LASTNAME").value.toUpperCase());';
   ws := ws + '   if (trim(document.getElementById("LASTNAME").value) == ""){';
   ws := ws + '      document.getElementById("NAMEHINT").innerHTML = "  Last Name Required";';
   ws := ws + '      return;';
   ws := ws + '   }';
   ws := ws + '   document.getElementById("NAMEHINT").innerHTML = "";';

   ws := ws + '   if (!isValidEmail(trim(document.getElementById("EMAIL").value))){';
   ws := ws + '      document.getElementById("EMAILHINT").innerHTML = "  Email Invalid";';
   ws := ws + '      return;';
   ws := ws + '   }';
   ws := ws + '   document.getElementById("EMAILHINT").innerHTML = "";';

   ws := ws + '   checkNumber(document.getElementById("PHONE"));';
   ws := ws + '   if (document.getElementById("PHONE").value.length < 10){';
   ws := ws + '      document.getElementById("PHONEHINT").innerHTML = "  Enter 10 digit phone";';
   ws := ws + '      return;';
   ws := ws + '   }';
   ws := ws + '   document.getElementById("PHONEHINT").innerHTML = "";';

   ws := ws + '   document.getElementById("DLNUM").value = trim(document.getElementById("DLNUM").value.toUpperCase());';
   ws := ws + '   if (document.getElementById("DLNUM").value == ""){';
   ws := ws + '      document.getElementById("DLHINT").innerHTML = "  DL # Required";';
   ws := ws + '      return;';
   ws := ws + '   }';

   ws := ws + '   if (document.getElementById("ROUTING").value.length != 9){';
   ws := ws + '      document.getElementById("CHECKDATAHINT").innerHTML = "<BR>Routing # (First Set of digits) Must be 9 numbers.";';
   ws := ws + '      return;';
   ws := ws + '   }';
   ws := ws + '   document.getElementById("CHECKDATAHINT").innerHTML = "";';

   ws := ws + '   if (document.getElementById("ACCOUNT").value.length <3){';
   ws := ws + '      document.getElementById("CHECKDATAHINT").innerHTML = "<BR>Please enter a valid account number (Second set of digits)";';
   ws := ws + '      return;';
   ws := ws + '   }';
   ws := ws + '   document.getElementById("CHECKDATAHINT").innerHTML = "";';

   ws := ws + '   document.getElementById("CHECKDATAHINT").innerHTML = "";';

   ws := ws + '   document.getElementById("AUTH").style.display = "none";';
   ws := ws + '   document.getElementById("Legal").style.display = "";';
   ws := Ws + '   document.getElementById("CONFIRMAMT").innerHTML = document.getElementById("CHECKAMT").value;';

   WS := WS + '}';
   WS := WS + 'function ShowHide() {';



   WS := WS + '   if (document.getElementById("SCANRB").checked) ';
   WS := WS + '    {document.getElementById("CHECKMANUALKEY").style.display = "none";';
   WS := WS + '     document.getElementById("CHECKSCANNED").style.display = "";';
   WS := WS + '     document.getElementById("MICR").focus();';
   WS := WS + '     document.getElementById("ACCOUNT").value="";';
   WS := WS + '     document.getElementById("CHECKNUM").value="";';
   WS := WS + '     document.getElementById("ROUTING").value=""};';
   WS := WS + '   if (document.getElementById("KEYRB").checked) ';
   WS := WS + '    {document.getElementById("CHECKMANUALKEY").style.display = "";';
   WS := WS + '     document.getElementById("CHECKSCANNED").style.display = "none";';
   WS := WS + '     document.getElementById("ROUTING").focus();';
   WS := WS + '     document.getElementById("MICR").value=""};';

   WS := WS + '}</script>';


   WS := WS + '<body onload="ShowHide()">';
   WS := WS + '<HEAD><TITLE>' + DomainFriendlyName+ ' Payment Site</TITLE></HEAD>';

   WS := WS + '<CENTER>';
   WS := WS + '<IMG SRC="/Images/Profiles/' + Stri(ChainCode,-1) + '/Logo250.gif" border="0">';
   WS := WS + '</CENTER><BR><BR>';

   WS := WS + '<CENTER>';

   OKToAuth := False;
   AuthHints := '';
   MICR := Trim(Request.queryfields.Values['MICR']);
   If Request.queryfields.Values['ACTION'] = 'CHECKAUTH' then begin



      TCRequest := TStringList.Create;
      TCResponse := TStringList.Create;
      TCRequest.Add('<TRANSACTION>');
      TCRequest.Add('   <TRANSACTIONTYPE>TCAUTH</TRANSACTIONTYPE>');
      TCRequest.Add('   <SERVICENAME>ICA</SERVICENAME>');
      TCRequest.Add('   <PROFILE>'+RNID+'</PROFILE>');
      TCRequest.Add('   <CHECKTYPE>PERSONAL</CHECKTYPE>');
      XS := Trim(StriReal(ValuReal(GetXMLTagStr(Request.Content,'CHECKAMT')),2));
      TCRequest.Add('   <CHECKAMT>' + XS + '</CHECKAMT>');

      TCRequest.Add('   <CHECKROUTING>'+Trim(NumericOnly(GetXMLTagStr(Request.Content,'CHECKROUTING')))+'</CHECKROUTING>');
      TCRequest.Add('   <CHECKACCOUNT>'+Trim(NumericOnly(GetXMLTagStr(Request.Content,'CHECKACCOUNT')))+'</CHECKACCOUNT>');
      TCRequest.Add('   <CHECKNUMBER>'+Trim(NumericOnly(GetXMLTagStr(Request.Content,'CHECKNUMBER')))+'</CHECKNUMBER>');
      TCRequest.Add('   <CHECKNAME>'+Trim(GetXMLTagStr(Request.Content,'FIRSTNAME') + ' ' + GetXMLTagStr(Request.Content,'FIRSTNAME'))+'</CHECKNAME>');

      TCRequest.Add('   <CHECKDL>'+Trim(AlphaNumericOnly(UpCaseString(GetXMLTagStr(Request.Content,'CHECKDL'))))+'</CHECKDL>');
      TCRequest.Add('   <CHECKDLSTATE>'+GetXMLTagStr(Request.Content,'CHECKDLSTATE')+'</CHECKDLSTATE>');
      TCRequest.Add('   <CHECKPHONE>'+Trim(NumericOnly(GetXMLTagStr(Request.Content,'CHECKPHONE')))+'</CHECKPHONE>');
      TCRequest.Add('   <TRANIDENT>'+ Trim(AlphaNumericOnly(UpCaseString(GetXMLTagStr(Request.Content,'TRANIDENT'))))+'</TRANIDENT>');
      TCRequest.Add('   <CUSTIDENT>'+ Trim(GetXMLTagStr(Request.Content,'FIRSTNAME') + ' ' + GetXMLTagStr(Request.Content,'LASTNAME'))+'</CUSTIDENT>');
      TCRequest.Add('   <STATIONIDENT>WEB-'+Request.RemoteHost +'</STATIONIDENT>');
      TCRequest.Add('</TRANSACTION>');
      XS := '';
      XRM := '';
      Try
         if UpCaseString(Request.host) = 'DEV.SPECTRUMRETAILNET.COM' then begin
            ProcessPPSAPIXML(TCRequest.text, TCResponse,GetAppServerHost,60);  //2017-01-06 jtm F#1343
         end else begin
            ProcessPPSAPIXML(TCRequest.text, TCResponse,GetAppServerHost,60);  //2017-01-06 jtm F#1343
         end;


         XS := GetXMLTag(TCResponse,'TCECASTATUS');
         XRM := GetXMLTag(TCResponse,'TRANRESPMESSAGE');
      except
         On E:Exception do begin
            XRM := 'Exception processing Transaction';
         end;
      end;

      If GetXMLTag(TCResponse,'TCECASTATUS') = '1' then begin
         WS := '<HTML>' + GetStyle('');
         WS := WS +    WS + '<IMG SRC="https://' + Request.Host + '/Images/Profiles/' + Stri(ChainCode,-1) + '/Logo250.gif" border="0"><BR><BR>';

         WS := WS + 'Thank you for your payment.  <BR>Your payment confirmation number is:<B>' +
               GetXMLTag(TCResponse,'TCAPPROVALCODE') + '-'+GetXMLTag(TCResponse,'TCSYSTEMCODE') + '</B>';
         WS := WS + '<BR>Name          : ' + GetXMLTagStr(Request.Content,'FIRSTNAME') + ' ' + GetXMLTagStr(Request.Content,'LASTNAME');
         WS := WS + '<BR>Payment Type  : Electronic Check';
         WS := WS + '<BR>Payment Amount: $' + Trim(StriReal(ValuReal(GetXMLTagStr(Request.Content,'CHECKAMT')),2));
         WS := WS + '<BR><BR>This is a receipt for your payment.  Please retain it for future reference.';

         WS := WS + '</HTML>';

         clMail.BuildMessage('',WS);

         clMail.From.FullAddress := '"' + DomainFriendlyName + '"<' + DomainSendAsEmail+'>';
         clMail.ToList.EmailAddresses := GetXMLTagStr(Request.Content,'CHECKEMAIL');
         clMail.Subject := 'Payment Confirmation Receipt';
         clMail.BCCList.Add(DomainEmail);
         SMTP.Open();
         try
           SMTP.Send(clMail);
         finally
           SMTP.Close();
         end;
      end;

      Response.ContentType := 'text/xml';
      Response.Content := TCResponse.Text;
      TCRequest.Free;
      TCResponse.Free;

      Exit;
   end else begin
      WS := WS + AuthHints;

      WS := WS + '<TABLE border="0" width="500" cellspacing="0" cellpadding="3" >';
      WS := WS + '<TR><TD width="500" align="CENTER"><IMG SRC="/Images/General/TelecheckSmallLogo.gif" border="0"></TD></TR>';
      WS := WS + '<TR><TD align="CENTER">';
      WS := WS + '<div id="AUTH">';
      WS := WS + '<TABLE border="0" cellspacing="0" cellpadding="3"  style="border-collapse: collapse">';



      XS := Request.queryfields.Values['CHECKAMT'];
      If XS = '' Then
         XS := '0.00'
      else
         XS := Trim(StriReal(ValuReal(XS),2));


      WS := WS + '<TR><TD align="RIGHT">First/Last Name:</TD>' +
                         '    <TD><input name=FIRSTNAME type=text id=FIRSTNAME value="'+''+'" onfocus="value=''" size=12 maxlength=50>' +
                             '<input name=LASTNAME type=text id=LASTNAME value="'+''+'" onfocus="value=''" size=20 maxlength=50><B><span id="NAMEHINT"></span></B></TD></TR>';
      WS := WS + '<TR><TD align="RIGHT">Email Address:</TD>' +
                         '    <TD><input name=EMAIL type=text id=EMAIL value="'+''+'" onfocus="value=''" size=30 maxlength=100><B><span id="EMAILHINT"></span></B> </TD></TR>';
      WS := WS + '<TR><TD align="RIGHT">Phone:</TD>' +
                         '    <TD><input name="PHONE" type="text" id="PHONE" onkeyup="javascript:checkNumber(document.getElementById(''PHONE''));" value="'+''+'" onfocus="value=''" size=12 maxlength=50><B><span id="PHONEHINT"></span></B> </TD></TR>';

      WS := WS + '<TR><TD align="RIGHT">Check Amount:</TD>' +
                         '    <TD><input name=CHECKAMT type=text id=CHECKAMT value="'+XS+'" onfocus="value=''" size=12 maxlength=50><B><span id="CHECKAMTHINT"></span></B> </TD></TR>';
      WS := WS + '<TR rel="sdualid" id="DLTR"><TD align="RIGHT">License/SSN/Fed ID:</TD>' +
                         '    <TD>' + HTMLTCKStateSelected('SSN') +'<input name=DLNUM type=text id=DLNUM value="" onfocus="value=''" size=20 maxlength=50><B><span id="DLHINT"></span></B> </TD></TR>';

      WS := WS + '<TR id="CHECKMANUALKEY"><TD align="CENTER">Manually Keyed<BR>Routing/Account:</TD>' +
                         '    <TD><IMG SRC="/Images/General/SampleCheck.gif" border="0"><BR>' +
                         '        <input name=ROUTING type=text onkeyup="javascript:checkNumber(document.getElementById(''ROUTING''));" id=ROUTING value=""  size=15 maxlength=9>' +
                         '        <input name=ACCOUNT type=text onkeyup="javascript:checkNumber(document.getElementById(''ACCOUNT''));" id=ACCOUNT value=""  size=20 maxlength=20>' +
                         '        <input name=CHECKNUM type=text style="display: none;" onkeyup="javascript:checkNumber(document.getElementById(''CHECKNUM''));" id=CHECKNUM value=""  size=8 maxlength=20>' +
                         '<B><span id="CHECKDATAHINT"></span></B>'+
                         '    </TD></TR>';


      WS := WS + '<TR><td colspan="2" align="CENTER"> <IMG onClick="StartPayment()" src="/images/general/Continue.GIF"  border="0">';
      WS := WS +  '  <A href="' + ReturnURL +'"><IMG SRC="/Images/General/Cancel.gif" border="0"></A></td></TR>';



      WS := WS + '</TABLE>';
      WS := WS + '</div>';
      WS := WS + '<div id="Legal" style="display: none;">';
      WS := WS + 'You are about to authorize a payment from your checking account in the amount of '+
                 '<B><span id="CONFIRMAMT"></span></B><BR><BR>';


      WS := WS + 'By clicking the "Process Now" button, you authorize an electronic '+
                 'debit from your checking account that will be ' +
                 'processed through the regular banking system.  '+
                 'If any of your payments are returned unpaid, you will '+
                 'be charged a returned item fee up to the maximum allowed '+
                 'by law. To exit without authorizing, click Cancel.<BR><BR>' +
                 'Click <a href="http://www.achex.com/html/NSF_pop.jsp" target="_blank">here</a>' +
                 ' to view your state''s returned item fee.<BR><BR>' +
                 '<IMG onClick="BackToAuth()" src="/images/general/GoBack.GIF"  border="0">   ' +
                 '<IMG onClick="Authorize()" src="/images/general/ProcessNow.GIF"  border="0">   ' +
                 '<A href="' + ReturnURL +'"><IMG SRC="/Images/General/Cancel.gif" border="0"></A>   ';

      WS := WS + '</div>';

      WS := WS + '<div id="AuthSpin" style="display: none;">';
      WS := WS + '<BR><B>Your payment is being processed.<BR><BR><IMG src="/images/general/loading.GIF"  border="0"><BR><BR>Please do not click Back or Refresh.</B><BR>';
      WS := WS + '</div>';

      WS := WS + '<div id="CheckDecline" style="display: none;">';
      WS := WS + 'We are sorry that we cannot accept your check at this time. Our decision is based, ' +
                 'in whole or in part, on information provided to us by TeleCheck. We encourage you ' +
                 'to call TeleCheck at 1-800-366-2425 or write TeleCheck Customer Care at P.O. Box 6806, ' +
                 'Hagerstown, MD 21741-6806. Please provide TeleCheck your driver''s license number and ' +
                 'the state where it was issued, and the complete banking numbers printed on the bottom ' +
                 'of your check. Under the Fair Credit Reporting Act, you have the right to a free ' +
                 'copy of your information held in TeleCheck''s files within 60 days from today. ' +
                 'You may also dispute the accuracy or completeness of any information in TeleCheck''s' +
                 ' consumer report. TeleCheck did not make the adverse decision to not accept your check ' +
                 'and is unable to explain why this decision was made.<BR><BR>' +
                 '<A href="' + ReturnURL +'"><IMG src="/images/general/Continue.GIF"  border="0"> </A>   ' ;
      WS := WS + '</div>';

      WS := WS + '<div id="CheckApproved" style="display: none;">';
      WS := WS + 'Your Payment has been Approved.<BR><BR><B>Thank you</B><BR><BR> ' +
                 'A receipt will be sent via email momentarily.<BR>' +
                 'Your Payment confirmation number is:<B><span id="CONFIRMNUM"></span></B>' +
                 '<BR><BR>' +
                 '<A href="' + ReturnURL +'"><IMG src="/images/general/Continue.GIF"  border="0"> </A>  ' ;
      WS := WS + '</div>';

      WS := WS + '<div id="Retry" style="display: none;">';
      WS := WS + 'We are unable to verify your checking account or identity information. Please review the information you entered to ensure that all information is correct.'+
                 ' If you are confident that the information you entered is correct, your account may not be eligible for electronic transactions, press Cancel to return.'+
                 '<BR><BR><IMG onClick="BackToAuth()" src="/images/general/GoBack.GIF"  border="0">   ' +
                 '<A href="' + ReturnURL +'"><IMG SRC="/Images/General/Cancel.gif" border="0"></A> ';

      WS := WS + '</div>';

      WS := WS + '<div id="TranFail" style="display: none;">';
      WS := WS + 'We''re sorry but we are unable to process your payment at this time.  We apologize for the inconvenience.<BR><BR>'+
                 '<A href="' + ReturnURL +'"><IMG SRC="/Images/General/Cancel.gif" border="0"></A> ';

      WS := WS + '</div>';

      WS := WS + '</TD></TR></TABLE>';
   end;

   WS := WS + '<BR><SMALL>Copyright (C) 2006-'+FormatDateTime('YYYY', Date)+' <A href="http://www.tempuspayment.com">Tempus Technologies, Inc.</A> All Rights Reserved.';
   WS := WS + '<BR>All trademarks are property of their respective owners.';
   WS := WS + '<BR>All access is logged.</SMALL></CENTER>';
   Ws := WS + '</body>';

  Response.Content := WS;
end;


Function TCustomerInfoModule.RNLoadHostName : String;
const
   METHOD_NAME = 'TCustomerInfoModule.RNLoadHostName()';
Begin
   Result := '';
   RNQuery.Close;
   RNQuery.SQL.Clear;
   RNQuery.SQL.Add('Select * from WWWHOST where HostName = ''' + ValidCharsOnly(UpCaseString(Request.Host),True,True,'.-') + '''');
   RNQuery.SQL.Add('Select * from WWWHOST where HostName = ''portaldemo.spectrumretailnet.com''');
   RNQuery.Open;
   ProcessLog(ltDebug, METHOD_NAME, 'RNQuery.SQL.Text = ' + RNQuery.SQL.TEXT); //2019-6-26 ss DVST-5619
   if (RNQuery.RecordCount = 0) then begin        //2015-10-09 jtm
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from WWWHOST where AltHostName = ''' + ValidCharsOnly(UpCaseString(Request.Host),True,True,'.-') + '''');
      RNQuery.Open;
   end;
   If RNQuery.RecordCount > 0 then begin
      ChainCode := RNQuery.FieldByName('ChainCode').AsInteger;
      Result := RNQuery.FieldByName('RNID').AsString;
      ReturnURL := Trim(RNQuery.FieldByName('ReturnURL').AsString);
      DomainEmail := Trim(RNQuery.FieldByName('DomainEmail').AsString);
      DomainSendAsEmail := Trim(RNQuery.FieldByName('SendAsEmail').AsString);
      DomainFriendlyName := Trim(RNQuery.FieldByName('DomainFriendlyName').AsString);
      DomainCompanyName := Trim(RNQuery.FieldByName('CompanyName').AsString);
      DomainHostFolder :=  Trim(RNQuery.FieldByName('HostFolder').AsString);
      DomainPlatform :=  UpCaseString(Trim(RNQuery.FieldByName('Platform').AsString));
      DomainConfig := RNQuery.FieldByName('ConfigData').AsString;
      DomainHostname := Request.Host;
      DomainHostname := 'portaldemo.spectrumretailnet.com';
      if (OpenXMLLoad) then begin
         StoreAttrHierarchy.StrictDelimiter := true; //2018-02-02 jtm: F#3765
         StoreAttrHierarchy.DelimitedText := DomainConfigXML.GetValueAsWideString('/CONFIGDATA/STOREATTRIBUTES/STOREATTRIBUTEHIERARCHY');
      end;
   end;
   PL.AddAppValue('ACCOUNT',  RNQuery.FieldByName('RNID').AsString);
   PL.AddAppValue('CHAINCODE',  RNQuery.FieldByName('ChainCode').AsString);

   RNQuery.Close;
   RNQuery.SQL.Clear;
   ProcessLog(ltDebug, METHOD_NAME, 'RESULT = '+ Result); //2019-6-26 ss DVST-5619
end;
Function TCustomerInfoModule.GetConfigString(Parameter : String;DefaultValue : String) : String;
var
   WS : String;
Begin
   WS := GetXMLTagStr(DomainConfig,Parameter);
   If WS = '' then
      Result := DefaultValue
   else
      Result := WS;
end;

Function TCustomerInfoModule.GetConfigBoolean(Parameter : String;DefaultValue : Boolean) : Boolean;
var
   WS : String;
Begin
   Result := DefaultValue;
   WS := Trim(UpCaseString(GetConfigString(Parameter,'')));
   If WS <> '' then begin
      If WS = 'TRUE' then Result := True;
      If WS = 'FALSE' then Result := False;
      If Valu(WS) > 0 then Result := True;
      If WS = '0' then Result := False;
   end;
end;


procedure TCustomerInfoModule.CustomerInfoModulePPAction(Sender: TObject;
  Request: TWebRequest; Response: TWebResponse; var Handled: Boolean);
Var
   RNID : String;
   Email : String;
   UserName : String;
   Password : String;
   ReportName : String;
   Headings : String;
   iter : Integer;
   WS :String;
   WS2 : String;
   WS3 : String;
   ParentGUID : String;
   AdminRNID : String;
   XMLResp :TStringList;
   PaymentToken : String;
   PaymentType : String;
   PaymentServiceName : String;
   PaymentRequest : String;
   PaymentResponse : String;
   TranIdent : String;
   CustIdent : String;
   PaymentHistGuid : String;
   ApprovalCode : String;
   NonAuthReason : String;
   HTMLEmail : String;
   EmailMessage : String;
   GWSystemCode : String;
   TranAmount : String;
   PaymentLocationRNID : String;
   AccountNumber : String;
   ReceiptNumber : String;
   PaymentAmount : String;
   PaymentOptionsCount : integer;
   ChildCount : Integer;
   PaymentRNID : String;
   BinResp : TStringList;
   BinRespDesc : String;
   ChildGUID : String;
   CustGUID : String;
   ExpDate : TDateTime;
   PageName : String;
   PaySchedGUID : String;
   CASAuthenticated : Boolean;
   CASUserName : String;
   CASOutput : TStringList;
   ShowAction : Boolean;
   ShowLinks : boolean;
   DisplayFormat : String;
   TabLine : String;
   TabLines : string;
   ADS : TdataSet;
   PVValidateResult : TStringList;
   PVRNID : string;
   SAMLXML : TOpenXML;
   SAML : TttSAML;
   DistrictCode : string;
   TechID : string;
   UseTechID : boolean;
   ActivationSC : string;
   ChangeXML : TOpenXML;
   ChangeXMLNode : TOPENXMLNode;
   FieldChangeNode : TOPENXMLNode;
   ChangeXMLStr : string;
   XMLString : string;
   Xpath : string;
   Activated : string;
   ActivationCode : string;
   Enabled : string;
   RNIDList : TStringList;
   FolderName : string; //2016-3-28 jtm
   ActSQLText : string;  //2016-5-10 jtm
   ActCount : string;
   ActTotalCount : string;
   ActPosStart : string;
   ActOrderBy : string;
   ActOrderDirect : string;
   ActColList : TStringList;
   ActivationExists : boolean;
   PosStart : string;      //2016-06-22 jtm
   QueryCount : string;
   QuerySQLText : string;
   QueryTotalCount : string;
   ResetGUID : string;    //2016-9-19 jtm: Feat OT# 1054
   PrevPW : TStringList;
   EmployeeNode : TOPENXMLNode;
   POSItemXMLReq : TStringList;  //2016-09-29 snt: Feat OT# 1120
   POSItemXMLResp : TStringList;
   POSItemCount : Integer;
   POSItemInfo : TStringList;
   POSItemJSONResp : TStringList;
   POSItemTaxRateStr : String;
   POSItemTaxRate : Double;

   EmployeeGUID : string;    //2016-09-29 jtm: Feat OT# 1055
   SingleUserXML : TOpenXML;
   SingleUserXMLStr : string;
   ChildFirst : string; //2016-10-19 jtm Def OT# 1270
   ChildLast : string;
   ConnectionString : String; //2017-04-05 jtm: Def OT# 1534

   IVRSessionID : string;
   IVRVxml : TIVRVXML;
   IVRRequest : TIVRRequest;
   IVRActionsXML : TOpenXML;

   StartPos : integer;      //2017-06-20 jtm: F#1666
   QueryCountInt : integer;
   FromDate : TDateTime;
   ThruDate : TDateTime;

   CustomField1 : string; //2017-09-20 jtm: F#2192
   CustomField2 : string;
   CustomField3 : string;
   CustomField4 : string;
   CustomField5 : string;
   CustomField6 : string;
   CustomField7 : string;
   CustomField8 : string;
   CustomField9 : string;
   CustomField10 : string;
   ReportFormat : TReportFormatType; //2017-10-26 jtm: F#2241
   EmpIdent : string; //2017-11-16 jtm: F#2264
   EpicSessionID : string;
   StoreAttr : TTTStringList; //2018-01-25 jtm F#2360
   xExport: TOExport; // Represents the file type
   xlsWorkSheet : TExportWorksheet; //Represents actual xls worksheet
   Row : TExportRow; //Represents actual row inside the TExportWorksheet
   xlsStream : TMemoryStream; //changed for 1.1.64.2
   xlsExporter : TOCustomExporter;
   xlsFileName : string;
   iterator : integer;
   JSON : TStringList;
   JSONString : string;
   BatchFieldNames : TStringList; //2018-06-20 ajs: F#2227

   LoanTypeExists : boolean; //2018-03-29 ajs: F#3383
   PaymentSuccess : boolean;
   TranIdentExpression : string;
   CustIdentExpression : string;
   ReportGUID : string;
   ReportDescription : string;

   csvParser : TImportFileParser; //2018-04-06 bls: F#3383
   fileUploader : TUploadFileContent;
   XMLFieldsToParse : string;
   ReturnCode :Integer; // 2019-2-13 ss DVST-3865

   UploadFile : string;          //2018-04-11 ajs: F#3384
   UploadFileLocation : string;  //2018-04-11 ajs: F#3384
   UploadFileName : string;      //2018-04-11 ajs: F#3384
   UploadFileSize : string;
   FileUploadDateTimeStr : string;
   FileUploadCount : integer;
   FileUploadLimit : integer;
   FileUploadTimeLimit : integer;
   FileUploadTimeLimitDate : TDateTime;
   RequestStream: TStringStream;
   RequestString: String;

   singleQuotePos : integer; //2018-05-18 bls: D#4332
   RunTime : TDateTime;
   dowSL : TStringList;
   frequency : string;
   EndType : string;
   StartDate : string;
   EndDate : string;
   weekStartDate : TDateTime;
   numofoccurances : integer;
   dayofthemonth : integer;
   Res : string;
   showTheLinks : boolean;
   CheckBatchFieldNames : TStringList; //2018-06-20 bls: F#2227
   LastName, FirstName : string;

   runFileName : string; //2018-07-25 bls: F#3541
   RefererURL : string;
   LocationName : String; //2019-4-17 ss DVST-3464
   IsDisplayTimeInTZ : Boolean; //2019-4-17 ss DVST-4900
   Function AddScheduledPayment : Boolean;
   Var
     FREQ : String;
     SchedPayLoc : String;
     PayAmt : Currency;
     GrossAmt : Currency;
     NumberOfPayments : Integer;
   begin
      SchedPayLoc := NumericOnly(Request.ContentFields.Values['School']);
      If SchedPayLoc = '' then
         SchedPayLoc := NumericOnly(Request.ContentFields.Values['Location']);

      If SchedPayLoc <> '' then begin
         Result := ValidateRNID(SchedPayLoc);
         If not Result then begin
            ProcessLog(ltWarning,'Attempt to add scheduled payment from Invalid Location RNID',NumericOnly(Request.ContentFields.Values['School']));
            exit;
         end;
      end;
      If SchedPayLoc = '' then SchedPayLoc := RNID;

      ChildGUID := GuidOnly(Request.ContentFields.Values['nameandacct']);
      If ChildGUID <> '' then begin
         RNQuery.Close;
         RNQuery.SQL.Clear;
         RNQuery.SQL.Add('select * from CustChild');
         RNQuery.SQL.Add('where (ChildGUID = '''+ChildGUID + ''')');
         RNQuery.SQL.Add('And (CustGUID = '''+ParentGUID + ''')');
         RNQuery.Open;
         If RnQuery.RecordCount = 0 then begin
           ProcessLog(ltWarning,'Attempt to process payment with invalid child guid ' + ChildGUID + '/' + ParentGUID,NumericOnly(Request.ContentFields.Values['School']));
         end else begin
            SchedPayLoc := Trim(RNquery.FieldByName('RNID').AsString);
         end;
         RNQuery.Close;
      end;


      If Valu(SchedPayLoc) = 0 then exit;

      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from CustPaySched where (CustGUID = '''+ParentGUID + ''')');
      RNQuery.Open;
      RNQuery.Insert;
      RNQuery.FieldByName('SiteRNID').AsString := RNID;
      RNQuery.FieldByName('RNID').AsString := SchedPayLoc;
      RNQuery.FieldByName('CustGUID').AsString := ParentGUID;
      RNQuery.FieldByName('ChildGUID').AsString := ChildGUID;

      RNQuery.FieldByName('PAYSCHEDGUID').AsString := GenerateGUID;
      RNQuery.FieldByName('PAYMENTGUID').AsString := GUIDOnly(Request.ContentFields.Values['payment']);
      FREQ := Request.ContentFields.Values['Frequency'];
      RNQuery.FieldByName('PaymentAmount').AsString := ValidCharsOnly(Request.ContentFields.Values['Amount'],false,true,'.');
      RNQuery.FieldByName('GrossAmount').AsCurrency := ValuReal(ValidCharsOnly(Request.ContentFields.Values['Balance'],false,true,'.'));
      RNQuery.FieldByName('Status').AsString := 'ACTIVE';
      RNQuery.FieldByName('ScheduleAdded').AsDateTime := Now;
      RNQuery.FieldByName('NumberOfPayments').AsInteger := Valu(Request.ContentFields.Values['NumberOfPayments']);
      RNQuery.FieldByName('PaymentsRemaining').AsInteger := RNQuery.FieldByName('NumberOfPayments').AsInteger;

      RNQuery.FieldByName('PaymentsMade').AsInteger := 0;
      If Trim(UpCaseString(FREQ))='MONTHLY' then begin
         RNQuery.FieldByName('FirstPayment').AsString := Request.ContentFields.Values['dateMonthly1'];
         RNQuery.FieldByName('Frequency').AsString := FREQ;
      end;
      If Trim(UpCaseString(FREQ))='ANNUALLY' then begin
         RNQuery.FieldByName('FirstPayment').AsString := Request.ContentFields.Values['dateAnnually'];
         RNQuery.FieldByName('Frequency').AsString := FREQ;
      end;
      If Trim(UpCaseString(FREQ))='QUARTERLY' then begin
         RNQuery.FieldByName('FirstPayment').AsString := Request.ContentFields.Values['dateQuarterly'];
         RNQuery.FieldByName('Frequency').AsString := FREQ;
      end;
      If Trim(UpCaseString(FREQ))='BIMONTHLY' then begin
         RNQuery.FieldByName('FirstPayment').AsString := Request.ContentFields.Values['DateBimonthly'];
         RNQuery.FieldByName('Frequency').AsString := FREQ;
      end;
      If Trim(UpCaseString(FREQ))='BIWEEKLY' then begin //2017-09-25 jtm: F#2203
         RNQuery.FieldByName('FirstPayment').AsString := Request.ContentFields.Values['DateBiweekly'];
         RNQuery.FieldByName('Frequency').AsString := FREQ;
      end;
      If Trim(UpCaseString(FREQ))='WEEKLY' then begin
         RNQuery.FieldByName('FirstPayment').AsString := Request.ContentFields.Values['DateWeekly'];
         RNQuery.FieldByName('Frequency').AsString := FREQ;
      end;
      RNQuery.FieldByName('NextPayment').AsDateTime := RNQuery.FieldByName('FirstPayment').AsDateTime;

      PayAmt := RNQuery.FieldByName('PaymentAmount').AsCurrency;
      GrossAmt := RNQuery.FieldByName('GrossAmount').AsCurrency;
      NumberOfPayments := RNQuery.FieldByName('NumberOfPayments').AsInteger;
      If (GrossAmt> 0) and (NumberOfPayments > 0) and (PayAmt=0) then begin  //only calculate the PaymentAmount if it is not present
         PayAmt := GrossAmt / NumberOfPayments * 100;
         If Frac(PayAmt) > 0 then PayAmt := Trunc(PayAmt + 1);
         PayAmt := PayAmt / 100;
         RNQuery.FieldByName('PaymentAmount').AsCurrency := PayAmt;
      end else if (GrossAmt= 0) and (NumberOfPayments > 0) and (PayAmt > 0) then begin  //only calculate the GrossAmount if it is not present
         GrossAmt := PayAmt * NumberOfPayments;
         RNQuery.FieldByName('GrossAmount').AsCurrency := GrossAmt;
      end;

      If (OpenXMLGetTag('/CONFIGDATA/STORECUSTOMFIELDS','FALSE') = 'TRUE') then begin //2017-09-20 jtm: F#2192
         CustomField1 := ValidCharsOnly(Request.ContentFields.Values['Custom1'],true,true,'/.-&(),:+=_ ');
         CustomField2 := ValidCharsOnly(Request.ContentFields.Values['Custom2'],true,true,'/.-&(),:+=_ ');
         CustomField3 := ValidCharsOnly(Request.ContentFields.Values['Custom3'],true,true,'/.-&(),:+=_ ');
         CustomField4 := ValidCharsOnly(Request.ContentFields.Values['Custom4'],true,true,'/.-&(),:+=_ ');
         CustomField5 := ValidCharsOnly(Request.ContentFields.Values['Custom5'],true,true,'/.-&(),:+=_ ');
         CustomField6 := ValidCharsOnly(Request.ContentFields.Values['Custom6'],true,true,'/.-&(),:+=_ ');
         CustomField7 := ValidCharsOnly(Request.ContentFields.Values['Custom7'],true,true,'/.-&(),:+=_ ');
         CustomField8 := ValidCharsOnly(Request.ContentFields.Values['Custom8'],true,true,'/.-&(),:+=_ ');
         CustomField9 := ValidCharsOnly(Request.ContentFields.Values['Custom9'],true,true,'/.-&(),:+=_ ');
         CustomField10 := ValidCharsOnly(Request.ContentFields.Values['Custom10'],true,true,'/.-&(),:+=_ ');
         if Length(CustomField1) > 200 then CustomField1 := Copy(CustomField1,0,200);
         if Length(CustomField2) > 200 then CustomField2 := Copy(CustomField2,0,200);
         if Length(CustomField3) > 200 then CustomField3 := Copy(CustomField3,0,200);
         if Length(CustomField4) > 200 then CustomField4 := Copy(CustomField4,0,200);
         if Length(CustomField5) > 200 then CustomField5 := Copy(CustomField5,0,200);
         if Length(CustomField6) > 200 then CustomField6 := Copy(CustomField6,0,200);
         if Length(CustomField7) > 200 then CustomField7 := Copy(CustomField7,0,200);
         if Length(CustomField8) > 200 then CustomField8 := Copy(CustomField8,0,200);

         RNQuery.FieldByName('Custom1').AsString := CustomField1;
         RNQuery.FieldByName('Custom2').AsString := CustomField2;
         RNQuery.FieldByName('Custom3').AsString := CustomField3;
         RNQuery.FieldByName('Custom4').AsString := CustomField4;
         RNQuery.FieldByName('Custom5').AsString := CustomField5;
         RNQuery.FieldByName('Custom6').AsString := CustomField6;
         RNQuery.FieldByName('Custom7').AsString := CustomField7;
         RNQuery.FieldByName('Custom8').AsString := CustomField8;
         RNQuery.FieldByName('Custom9').AsString := CustomField9;
         RNQuery.FieldByName('Custom10').AsString := CustomField10;
      end;

      if((StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/DISPLAYBALANCEDUE','FALSE'))) AND  (Trim(Request.ContentFields.Values['balanceType']) = 'balanceDue')) then begin // 2019-2-13 ss DVST-3841 balanceType is the name of the radio button
         RNQuery.FieldByName('Custom4').AsString := 'balanceDue';
         RNQuery.FieldByName('PaymentAmount').AsCurrency := 0;
         RNQuery.FieldByName('GrossAmount').AsCurrency := 0;
      end;
      ProcessLog(ltDebug,'AddCustomerPaymentSchedule','CustGUID: '+RNQuery.FieldByName('CustGUID').AsString);// 2019-2-13 ss DVST-3841 testing
      ProcessLog(ltDebug,'AddCustomerPaymentSchedule','PAYSCHEDGUID: '+RNQuery.FieldByName('PAYSCHEDGUID').AsString);// 2019-2-13 ss DVST-3841 testing

      RNQuery.Post;
      RNQuery.Close;
   end;

   Procedure AddCheckToAccount;
   Var
     BACCT : String;
   begin
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from CustPayment where (CustGUID = '''+ParentGUID + ''')');
      RNQuery.Open;
      RNQuery.Insert;
      RNQuery.FieldByName('CustGUID').AsString := ParentGUID;
      RNQuery.FieldByName('PaymentGUID').AsString := GenerateGUID;
      RNQuery.FieldByName('PaymentType').AsString := 'CHECK';
      RNQuery.FieldByName('ServiceName').AsString := 'ICA';
      RNQuery.FieldByName('CheckRouting').AsString := NumericOnly(Request.ContentFields.Values['BankRouting']);
      BAcct := NumericOnly(Request.ContentFields.Values['BankNumber']);
      RNQuery.FieldByName('CheckAccount').AsString := BAcct ;
      RNQuery.FieldByName('PaymentName').AsString := 'Bank Account ' + MaskStr(BAcct,DigitsToMask(Bacct));
      RNQuery.FieldByName('LicenseNum').AsString := Trim(ValidCharsOnly(UpCaseString(Request.ContentFields.Values['driversno']),True,True,'*'));
      RNQuery.FieldByName('LicenseState').AsString := ValidCharsOnly(Request.ContentFields.Values['driversstate'],True,False,'');

      RNQuery.FieldByName('CheckBN').AsString := ValidCharsOnly(Request.ContentFields.Values['BankName'], True,True, ' ');
      RNQuery.FieldByName('DateAdded').AsDateTime := Now;

      XMLResp := TStringList.Create;

      WS := '<TRANSACTION>' +
                           ' <RNID>'+RNID +'</RNID>' +
                           ' <TRANSACTIONTYPE>REPADDDATA</TRANSACTIONTYPE>' +
                           ' <REPCHECKROUTING>'+ Trim(NumericOnly(Request.ContentFields.Values['BankRouting']))+'</REPCHECKROUTING>' +
                           ' <REPCHECKACCOUNT>'+BAcct+'</REPCHECKACCOUNT>'+
                           ' <REPCUSTIDENT>'+Trim(RNQuery.FieldByName('PaymentGUID').AsString)+'</REPCUSTIDENT>'+
                           ' <REPLICENSE>'+ValidCharsOnly(UpCaseString(Request.ContentFields.Values['driversno']),True,True,'*')+'</REPLICENSE>'+
                           ' <REPLICENSESTATE>'+ValidCharsOnly(UpCaseString(Request.ContentFields.Values['driversstate']),True,True,'')+'</REPLICENSESTATE>';

      if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then       //2016-9-19 jtm: Feat OT# 1145
         WS := WS + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';

      WS := WS + ' </TRANSACTION>'+CRLF;
      VarEvaluator.AddValue('GatewayRNID',RNID);//2017-05-24 jtm: F#1821
      ProcessPPSAPIXML(WS, XMLResp,GetAppServerHost,0);

      RNQuery.FieldByName('PaymentToken').AsString := GetXMLTag(XMLResp,'REPTOKEN');
      XMLResp.Free;


      RNQuery.Post;
      RNQuery.Close;
   end;
   Procedure AddChildToAccount(CustGUID : String);
   var
      LastName : string;
      FirstName: string;
   begin
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from CustChild where (CustGUID = '''+CustGUID + ''')');
      RNQuery.Open;
      RNQuery.Insert;
      RNQuery.FieldByName('CustGUID').AsString := CustGUID;
      RNQuery.FieldByName('ChildGUID').AsString := GenerateGUID;
      RNQuery.FieldByName('RNID').AsString := Request.ContentFields.Values['Locations'];
      If Trim(Request.ContentFields.Values['Locations']) = '' then begin
         If UserXMLGetTag('/USERPROFILE/PORTALRNID') <> '' then
            RNQuery.FieldByName('RNID').AsString := UserXMLGetTag('/USERPROFILE/PORTALRNID')
         else
            RNQuery.FieldByName('RNID').AsString := RNID;
      end;

      LastName := ValidCharsOnly(Request.ContentFields.Values['ChildLast'],True,True,'-'' '); //2018-06-20 bls: F#4834
      FirstName := ValidCharsOnly(Request.ContentFields.Values['ChildFirst'],True,True,'-'' ');

      RNQuery.FieldByName('LastName').AsString := LastName; //2018-06-20 bls: F#4834
      RNQuery.FieldByName('FirstName').AsString := FirstName;
      RNQuery.FieldByName('ExternalCustIdent').AsString := VarEvaluator.GetValueAsString('ExternalCustIdent');
      Try
         RNQuery.FieldByName('DOB').AsString := ValidCharsOnly(Request.ContentFields.Values['DOB'],False,True,'/-');
      except
         on E:Exception do begin
            ProcessLog(ltWarning, 'AddChildToAccount DOB as string failed:', E.Message);
         end;
      end;
      RNQuery.FieldByName('DateAdded').AsDateTime := Now;
      RNQuery.FieldByName('AccountNumber').AsString := ValidCharsOnly(Request.ContentFields.Values['AccountNumber'],True,True,'-:/.');

      Try
         RNQuery.FieldByName('DOB').AsDateTime := StrToDate(Request.ContentFields.Values['DOB']);
      except
         On E:Exception do begin
            ProcessLog(ltWarning, 'AddChildToAccount DOB as DateTime failed:', E.Message);
         end;
      end;

      RNQuery.Post;
      RNQuery.Close;
   end;

   Procedure SaveChildToAccount(CustGUID : String; ChildGUID : String);
   var
      LastName, FirstName : string;
   begin
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from CustChild where (CustGUID = '''+ CustGUID + ''') and (ChildGUID = '''+ ChildGUID + ''')');
      RNQuery.Open;
      If RNQuery.RecordCount = 1 then begin
         RNQuery.Edit;

         LastName := ValidCharsOnly(Request.ContentFields.Values['ChildLast'],True,True,'-'' ');
         FirstName := ValidCharsOnly(Request.ContentFields.Values['ChildFirst'],True,True,'-'' ');

         RNQuery.FieldByName('LastName').AsString := LastName; //2018-06-20 bls: F#4834
         RNQuery.FieldByName('FirstName').AsString := FirstName;
         RNQuery.FieldByName('AccountNumber').AsString := ValidCharsOnly(Request.ContentFields.Values['AccountNumber'],True,True,'-:/.');
         RNQuery.Post;
      end;
      RNQuery.Close;
   end;

   Function GenerateChildGrid(CustGUID : String; ShowAction : Boolean) : String;
   var
     CG : String;
   Begin
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from CustChild left outer join store on (store.systemcode = CustChild.RNID) where (CustGUID = '''+CustGUID + ''') and (Hidden=0)');
      RNQuery.Open;
      CG := '';
      While Not RNQuery.EOF do begin
         CG := CG + '<tr><td>' + Trim(RNQuery.FieldByName('FirstName').AsString) + ' ' +
                                 Trim(RNQuery.FieldByName('LastName').AsString) + '</td><td>' +
                                 Trim(RNQuery.FieldByName('Name').AsString) + ', ' +
                                    Trim(RNQuery.FieldByName('City').AsString) + ' ' +
                                    Trim(RNQuery.FieldByName('State').AsString)+'</TD>'+
                                    '<TD>' + Trim(RNQuery.FieldByName('AccountNumber').AsString) +'</TD>';
         If ShowAction then
            CG := CG + '<TD><a href="/PP?PAGE=REMOVECHILD&CHILDGUID=' + Trim(RNQuery.FieldByName('ChildGUID').AsString) + '" class="mdbutton">Remove</a></td>';

         CG := CG + '</tr>';
         RNQuery.Next;
      end;
      Result := cg;
   end;

   Function GenerateScheduledPayments : String;
   var
     CG : String;
   Begin
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('select PaySchedGUID,NextPayment, Frequency, PaymentAmount, Status, firstname, lastname, paymentName,Name, Address1, City,State,Zip,PaymentsMade,paymentsremaining, NumberOfPayments,'+' custpaysched.Custom4 as CustPaySchedCustom4  from custpaysched'); // 2019-2-13 ss DVST-3842
      RNQuery.SQL.Add('left outer join store on (RNID=Store.SystemCode)');
      RNQuery.SQL.Add('left outer join custpayment on (CustPaySched.PaymentGUID=CustPayment.PaymentGUID)');
      RNQuery.SQL.Add('left outer join custchild on (CustPaySched.ChildGuid=custchild.ChildGUID)');
      RNQuery.SQL.Add('Where (custpaysched.CustGUID = '''+ParentGUID + ''')');
      RNQuery.Open;
      CG := '';
      While Not RNQuery.EOF do begin
         If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SCHEDPAY/CHILDNAME') = 'TRUE' then begin   //Use the child account name that the payment was made for -JTM 12/18/14
            CG :=  CG + '<tr><td class="calendarPage" style="padding-right:25px;" align="left" valign="top">' + Trim(RNQuery.FieldByName('firstname').AsString)+ ' ' + Trim(RNQuery.FieldByName('lastname').AsString)+ '</td>';
         end else
            CG := CG + '<tr><td class="calendarPage" style="padding-right:25px;" align="left" valign="top">' + Trim(RNQuery.FieldByName('Name').AsString)+ '</td>';
	      CG := CG + '<td class="calendarPage" style="padding-right:25px;" align="left" valign="top">' + Trim(RNQuery.FieldByName('PaymentName').AsString)+ '</td>';
	      CG := CG + '<td class="calendarPage" style="padding-right:25px;" align="left" valign="top">' + Trim(RNQuery.FieldByName('Frequency').AsString)+ '</td>';
	      CG := CG + '<td class="calendarPage" style="padding-right:25px;" align="left" valign="top">' + Trim(RNQuery.FieldByName('NextPayment').AsString)+ '</td>';

         if((StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/DISPLAYBALANCEDUE','FALSE'))) AND  (Trim(RNQuery.FieldByName('CustPaySchedCustom4').AsString) = 'balanceDue')) then begin // 2019-2-13 ss DVST-3842
            CG := CG + '<td class="calendarPage" style="padding-right:25px;" align="left" valign="top">' + 'On Current Balance Due'+ '</td>';
         end else begin
            CG := CG + '<td class="calendarPage" style="padding-right:25px;" align="left" valign="top">' + Trim(StriReal(RNQuery.FieldByName('PaymentAmount').AsFloat,2))+ '</td>';
         end;

         if RNQuery.FieldByName('NumberOfPayments').AsInteger > 0 then begin
   	      CG := CG + '<td class="calendarPage" style="padding-right:25px;" align="left" valign="top">' + Trim(RNQuery.FieldByName('PaymentsMade').AsString)+ '</td>';
   	      CG := CG + '<td class="calendarPage" style="padding-right:25px;" align="left" valign="top">' + Stri(RNQuery.FieldByName('NumberOfPayments').AsInteger - RNQuery.FieldByName('PaymentsMade').AsInteger,-1)+ '</td>';
         end else if(StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/DISPLAYNUMPAYMENTSZERO', 'FALSE'))) then begin // 2019-2-13 ss DVST 3841
   	      CG := CG + '<td class="calendarPage" style="padding-right:25px;" align="left" valign="top">' + Trim(RNQuery.FieldByName('PaymentsMade').AsString)+ '</td>';
   	      CG := CG + '<td class="calendarPage" style="padding-right:25px;" align="left" valign="top">' + 'Will Continue Till Cancelled.'+ '</td>';
         end;
         CG := CG + '<td class="calendarPage" align="left" valign="top"><font class="blink"><a href="/PP?PAGE=REMOVESCHEDULEDPAYMENT&PAYSCHEDGUID=' +
                                 Trim(RNQuery.FieldByName('PAYSCHEDGUID').AsString) + '" >Cancel</a></font></td></tr>';
         RNQuery.Next;
      end;
      Result := cg;
   end;
   Function GenerateCustomerPaymentHistory(CustGUID : String; PSGUID : String; IncludeHyperLinks : Boolean) : String;
   var
     CG : String;
   Begin
      RNQuery.Close;
      RNQuery.SQL.Clear;
      If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYHIST/CHILDNAME') = 'TRUE' then begin        //Use a different query to get the child account name that the payment was made for -JTM 12/4/14
         RNQuery.SQL.Add('select Store.SystemCode as RNID, CustPaymentHistory.SystemCode as PaymentSerial,CustPaymentHistory.ApprovalCode as AC, CustPaymentHistory.PaymentGUID as PayGUID, custHistDesc, PaymentDate,PayHistGUID,CustPaymentHistory.PaymentAmount, ' +
                      'paymentName,custpaymenthistory.CHILDGUID, custchild.FIRSTNAME as firstname, custchild.LASTNAME as lastname,');
         If ((OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERPROFILE/INCLUDETRANIDENT','FALSE') = 'TRUE') or (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERPROFILE/INCLUDECUSTIDENT','FALSE') = 'TRUE')) then begin
            RNQuery.SQL.Add('checkauth.TranIdent as CKTranIdent, cardauth.TranIdent as CCTranIdent, checkauth.TranCustomerCode as CKCustIdent,cardauth.TranCustomerCode as CCCustIdent,');
         end;

         RNQuery.SQL.Add('Name, Address1, City,State,Zip from custpaymenthistory');
         RNQuery.SQL.Add('left outer join store on (RNID=Store.SystemCode)');
         RNQuery.SQL.Add('left outer join custpayment on (custpaymenthistory.PaymentGUID=CustPayment.PaymentGUID)');
         RNQuery.SQL.Add('left outer join custchild on (custpaymenthistory.CHILDGUID=custchild.CHILDGUID)');
         If ((OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERPROFILE/INCLUDETRANIDENT','FALSE') = 'TRUE') or (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERPROFILE/INCLUDECUSTIDENT','FALSE') = 'TRUE')) then begin
            RNQuery.SQL.Add('left outer join (Select TranIdent,TranCustomerCode,StoreSystemCode,StoreCode From CCAuth)cardauth on (cardauth.StoreCode=Store.SYSTEMCODE and cardauth.StoreSystemCode=CustPaymentHistory.GWSystemCode)');
            RNQuery.SQL.Add('left outer join (Select TranIdent,TranCustomerCode,StoreSystemCode,StoreCode From TCAuth)checkauth on (checkauth.StoreCode=Store.SYSTEMCODE and checkauth.StoreSystemCode=CustPaymentHistory.GWSystemCode)');
         end;
         RNQuery.SQL.Add('Where (custpaymenthistory.CustGUID = '''+CustGUID + ''') and (ApprovalCode <> '''') ');
         If PSGUID <> '' then begin
            RNQuery.SQL.Add('And (custpaymenthistory.PaySchedGUID = '''+PSGUID + ''')');
         end;
         RNQuery.SQL.Add('order by paymentdate desc');
      end else begin
         RNQuery.SQL.Add('select Store.SystemCode as RNID, CustPaymentHistory.SystemCode as PaymentSerial,CustPaymentHistory.ApprovalCode as AC, CustPaymentHistory.PaymentGUID as PayGUID, custHistDesc, PaymentDate,PayHistGUID,CustPaymentHistory.PaymentAmount, ');

         If ((OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERPROFILE/INCLUDETRANIDENT','FALSE') = 'TRUE') or (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERPROFILE/INCLUDECUSTIDENT','FALSE') = 'TRUE')) then begin
            RNQuery.SQL.Add('checkauth.TranIdent as CKTranIdent, cardauth.TranIdent as CCTranIdent, checkauth.TranCustomerCode as CKCustIdent,cardauth.TranCustomerCode as CCCustIdent,');
         end;
         RNQuery.SQL.Add(' paymentName,Name, Address1, City,State,Zip from custpaymenthistory');
         RNQuery.SQL.Add('left outer join store on (RNID=Store.SystemCode)');
         RNQuery.SQL.Add('left outer join custpayment on (custpaymenthistory.PaymentGUID=CustPayment.PaymentGUID)');
         If ((OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERPROFILE/INCLUDETRANIDENT','FALSE') = 'TRUE') or (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERPROFILE/INCLUDECUSTIDENT','FALSE') = 'TRUE')) then begin
            RNQuery.SQL.Add('left outer join (Select TranIdent,TranCustomerCode,StoreSystemCode,StoreCode From CCAuth)cardauth on (cardauth.StoreCode=Store.SYSTEMCODE and cardauth.StoreSystemCode=CustPaymentHistory.GWSystemCode)');
            RNQuery.SQL.Add('left outer join (Select TranIdent,TranCustomerCode,StoreSystemCode,StoreCode From TCAuth)checkauth on (checkauth.StoreCode=Store.SYSTEMCODE and checkauth.StoreSystemCode=CustPaymentHistory.GWSystemCode)');
         end;
         RNQuery.SQL.Add('Where (custpaymenthistory.CustGUID = '''+CustGUID + ''') and (ApprovalCode <> '''') ');
         If PSGUID <> '' then
            RNQuery.SQL.Add('And (custpaymenthistory.PaySchedGUID = '''+PSGUID + ''')');
         RNQuery.SQL.Add('order by paymentdate desc');
       end;
      RNQuery.Open;

      CG := '';
      While Not RNQuery.EOF do begin
         CG := CG + '<tr><td align="left" valign="top">'+ FormatDateTime('MM/DD/YYYY',RNquery.FieldByName('PaymentDate').AsDateTime) + '</td>';

         If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYHIST/CHILDNAME') = 'TRUE' then begin   //Use the child account name that the payment was made for -JTM 12/4/14
            CG :=  CG + '    <td align="left" valign="top">' + Trim(RNQuery.FieldByName('firstname').AsString)+ ' ' + Trim(RNQuery.FieldByName('lastname').AsString)+ '</td>';
         end else
            CG := CG + '    <td align="left" valign="top">' + Trim(RNQuery.FieldByName('Name').AsString)+ '</td>';
         If Trim(RNQuery.FieldByName('PaymentName').AsString) <> '' then
            CG := CG + '    <td align="left" valign="top">' + Trim(RNQuery.FieldByName('PaymentName').AsString)+ '</td>'
         else If Trim(RNQuery.FieldByName('AC').AsString) = 'OFFLINE' then
            CG := CG + '    <td align="left" valign="top">Offline ' + Trim(RNQuery.FieldByName('PayGUID').AsString)+ '</td>'
         else
            CG := CG + '    <td align="left" valign="top">' + Trim(RNQuery.FieldByName('CustHistDesc').AsString)+ '</td>';

         CG := CG + '    <td align="right" valign="top">$';
         If IncludeHyperLinks then CG := CG + '<a href="/PP?PAGE=PAYMENTRECEIPT&PAYHISTGUID='+Trim(RNQuery.FieldByName('PayHistGuid').AsString) +'">';
         Cg := CG + Trim(StriReal(RNQuery.FieldByName('PaymentAmount').AsFloat,2));
         If IncludeHyperLinks then CG := CG +  '</a>';

         If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERPROFILE/INCLUDETRANIDENT','FALSE') = 'TRUE' then begin
            If Trim(RNQuery.FieldByName('CCTranIdent').AsString) <> '' then begin
               CG := CG + '    <td align="left" valign="top">' + Trim(RNQuery.FieldByName('CCTranIdent').AsString)+ '</td>';
            end else if Trim(RNQuery.FieldByName('CKTranIdent').AsString) <> '' then begin
               CG := CG + '    <td align="left" valign="top">' + Trim(RNQuery.FieldByName('CKTranIdent').AsString)+ '</td>';
            end else begin
               CG := CG + '    <td align="left" valign="top"></td>';
            end;
         end;
         If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERPROFILE/INCLUDECUSTIDENT','FALSE') = 'TRUE' then begin
            If Trim(RNQuery.FieldByName('CCCustIdent').AsString) <> '' then begin
               CG := CG + '    <td align="left" valign="top">' + Trim(RNQuery.FieldByName('CCCustIdent').AsString)+ '</td>';
            end else if Trim(RNQuery.FieldByName('CKCustIdent').AsString) <> '' then begin
               CG := CG + '    <td align="left" valign="top">' + Trim(RNQuery.FieldByName('CKCustIdent').AsString)+ '</td>';
            end else begin
               CG := CG + '    <td align="left" valign="top"></td>';
            end;
         end;
         
         CG := CG + '</td>    <td align="right" valign="top">' + Trim(RNQuery.FieldByName('RNID').AsString) + '-' +
                                                      Trim(RNQuery.FieldByName('PaymentSerial').AsString) + '-' +
                                                      FormatDateTime('YYMMDD',RNQuery.FieldByName('PaymentDate').AsDateTime)  +'</tr>';
        RNQuery.Next;
      end;
      Result := cg;
   end;
   Function GeneratePaymentGrid : String;
   var
     CG : String;
     ct : String;
   Begin
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from CustPayment left outer join custpaysched on (CustPaySched.PaymentGUID = CustPayment.PaymentGUID) where (CustPayment.CustGUID = '''+ParentGUID + ''') and (Hidden = 0)');
      RNQuery.Open;
      CG := '';
      If RNQuery.RecordCount >0  then begin
         While Not RNQuery.EOF do begin
            if Trim(RNQuery.FieldByName('PaymentType').AsString) = 'CHECK' then begin
               CG := CG + '<tr><td>CHECK</TD><td>' + Trim(RNQuery.FieldByName('PaymentName').AsString)+'</td>';
               If Trim(RNQuery.FieldByName('Status').AsString) = 'ACTIVE' then
                  CG := CG + '<TD>Cancel scheduled payments to remove</TD></TR>'
               else
                  CG := CG + '<TD><a href="/PP?PAGE=REMOVEPAYMENT&PAYMENTGUID=' + Trim(RNQuery.FieldByName('PAYMENTGUID').AsString) + '" class="mdbutton">Remove Bank Account</a></td></tr>';
            end;
            if Trim(RNQuery.FieldByName('PaymentType').AsString) = 'CARD' then begin
               CT := Trim(RNQuery.FieldByName('CardIssueType').AsString);
               If CT <> '' then
                  CT := ' (' + CT + ')';
               CG := CG + '<tr><td>CARD' + CT +  '</TD><td>' + Trim(RNQuery.FieldByName('PaymentName').AsString)+ ' Expires ' + FormatDateTime('MM/YY', RNquery.FieldByName('CardExpires').asDateTime) + '</td>';

               If Trim(RNQuery.FieldByName('Status').AsString) = 'ACTIVE' then
                  CG := CG + '<TD>Cancel scheduled payments to remove</TD></TR>'
               else
                  CG := CG + '<TD><a href="/PP?PAGE=REMOVEPAYMENT&PAYMENTGUID='+ Trim(RNQuery.FieldByName('PAYMENTGUID').AsString) + '" class="mdbutton">Remove Credit Card</a></td></tr>';

            end;

            RNQuery.Next;
         end;
      end else begin
         CG := '<TR><TD><B>**NO PAYMENT METHODS ON FILE**</B></TD></TR>';
      end;
      Result := cg;
   end;

   Function GenerateSchoolOptionsWithSelected(ADS : TDataSet; const selectedRNID : integer) : String;
   var
     WS : String;
     StoreProfile : string;
   Begin
      WS := '';
      ADS.First;
      While Not ADS.EOF do begin
         StoreProfile := ADS.FieldByName('Siblings').AsString;
         if ShowStore(StoreProfile) then begin
            WS := WS + '<option value="' + ADS.FieldByName('SystemCode').AsString + '" ';
            if selectedRNID = ADS.FieldByName('SystemCode').AsInteger then begin
               WS := WS + 'selected';
            end;

            WS := WS + '> ';
            If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONNAMEFORMAT') = 'NAMEONLY' then begin
               WS := WS + Trim(ADS.FieldByName('Name').AsString) +'</option>';
            end else if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONNAMEFORMAT') = 'UNITCITYSTATE' then begin
               WS := WS + Trim(ADS.FieldByName('StoreId').AsString) + ', '+ Trim(ADS.FieldByName('City').AsString)+', '+ Trim(ADS.FieldByName('State').AsString) +'</option>';
            end else begin
               WS := WS + Trim(ADS.FieldByName('State').AsString) + '-' +Trim(ADS.FieldByName('Name').AsString) +'</option>';
            end;
         end;
         ADS.Next;
      end;
      Result := WS;
   end;

   Function GenerateLocationsWithSelected : String;
   var
     WS : String;
     StoreProfile : string;
   Begin
      WS := '';
      RNQuery2.Close;
      RNQuery2.SQL.Clear;
      RNQuery2.SQL.Add('Select * from Store where (Chaincode = ' + Stri(ChainCode,-1) + ')');
      If GetConfigString('HIDECHAINRNIDS','') <> '' then begin
         RNQuery2.SQL.Add('and (NOT systemcode in (' + GetConfigString('HIDECHAINRNIDS','')+'))');
      end;
      if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONORDER','') <> '' then begin
         RNQuery2.SQL.Add('Order by ' + OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONORDER',''));
      end else begin
         RNQuery2.SQL.Add('Order by State,City,Name');
      end;

      RNQuery2.Open;
      RNQuery2.First;
      While Not RNQuery2.EOF do begin
         if ShowStore(RNQuery2.FieldByName('Siblings').AsString) then begin
            WS := WS + '<option value="'+ RNQuery2.FieldByName('SystemCode').AsString +'"';
            If RNQuery2.FieldByName('SystemCode').AsString = RNQuery.FieldByName('SystemCode').AsString then begin
               WS := WS + ' selected';
            end;
            WS := WS + '> ';
            If (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONFORMAT') = 'CITYLOCNAME') then begin
               WS := WS + Trim(RNQuery2.FieldByName('City').AsString) + ', ' + Trim(RNQuery2.FieldByName('State').AsString) + ':' +
                          Trim(RNQuery2.FieldByName('Name').AsString) + ' ' +'</option>';
            end else begin
               WS := WS + Trim(RNQuery2.FieldByName('State').AsString) + '-' +
                          Trim(RNQuery2.FieldByName('Name').AsString) + ' ' +
                          Trim(RNQuery2.FieldByName('Address1').AsString) + ', ' +
                          Trim(RNQuery2.FieldByName('City').AsString)+'</option>';
            end;
         end;
         RNQuery2.Next;
      end;
      RNQuery2.Close;

      Result := WS;
   end;
   


   Function GenerateAllSchoolOptionsWithSelected(IncludeALLOption : Boolean; IncludePleaseSelect : Boolean; const selectedRNID : integer) : String;
   Var
      Locs : String;
      AllowedRNIDs : String;
      RNIDAccess : TStringList;
   Begin
      AllowedRNIDs := UserXMLGetTag('/USERPROFILE/ALLOWEDRNIDS');
      RNIDAccess := TStringList.Create;
      if GetUserRNIDAccess(RNIDAccess,false) > 0 then AllowedRNIDs := RNIDAccess.CommaText; //2016-09-29 jtm Feat OT# 1177
      if UserXMLGetTag('/USERPROFILE/CHAINACCESS/CHAIN[@ID="' + trim(Stri(ChainCode,-1))+'"]/READONLY') <> '' then  AllowedRNIDs := '';   //2016-11-03 jtm Feat OT# 1247
      if (AllowedRNIDs = '') then AllowedRNIDs := ExternalXMLGetTag('/EXTERNALXML/ALLOWEDRNIDS'); //2016-8-22 jtm: Feat OT#1074
      If (AllowedRNIDs <> '') then IncludeAllOption := False;

      If (OpenXMLGetTag('/CONFIGDATA/RNIDACCESSBYSTOREATTRIBUTES/ONDROPDOWN', 'FALSE') = 'TRUE') then begin //2018-01-25 jtm F#2360
         if (GetUserRNIDAccessByStoreAttr(RNIDAccess) > 0) then begin
            AllowedRNIDs := RNIDAccess.CommaText;
         end else if (OpenXMLGetTag('/CONFIGDATA/RNIDACCESSBYSTOREATTRIBUTES/OVERRIDEOTHERCONFIGS', 'FALSE') = 'TRUE') then begin
            AllowedRNIDs := '1234'; //give it a dummy rnid when overriding other config settings
         end;
      end;

      RNQuery2.Close;
      RNQuery2.SQL.Clear;
      RNQuery2.SQL.Add('Select * from Store where (Chaincode = ' + Stri(ChainCode,-1) + ')');
      If GetConfigString('HIDECHAINRNIDS','') <> '' then begin
         RNQuery2.SQL.Add('and (NOT systemcode in (' + GetConfigString('HIDECHAINRNIDS', '') + '))');
      end;
      If AllowedRNIDs <> '' then begin
         RNQuery2.SQL.Add('and (systemcode in (' + AllowedRNIDs + '))');
      end;

      if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONORDER','') <> '' then begin //2017-05-24 jtm: F#1778
         RNQuery2.SQL.Add('Order by ' + OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONORDER', ''));
      end else begin
         RNQuery2.SQL.Add('Order by State, Name');
      end;

      RNQuery2.Open;
      Locs := GenerateSchoolOptionsWithSelected(RNquery2, selectedRNID);

      If (RNQuery2.RecordCount > 1) and (IncludePleaseSelect) then begin
         Locs := '<option value=""> Please Select</option>' + Locs;
      end;
      If (IncludePleaseSelect) and (RNQuery2.RecordCount = 1) and (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/INCLUDEPLEASESELECT', 'FALSE') = 'TRUE') then begin //2017-06-07 jtm: D#1713
         Locs := '<option value=""> Please Select</option>' + Locs;
      end;
      If IncludeAllOption then begin
         Locs := '<option value="ALL"> All Locations</option>' + Locs;
      end;
      Result := Locs;                                                    
      RNQuery2.Close;
      FreeAndNil(RNIDAccess);
   end;

   Function GetAllowedRNIDs(const isCustomerSearch : boolean): string;
   const
      METHOD_NAME = 'GetAllowedRNIDs(...)';// 2019-4-17 ss DVST-5291
   var
      RNIDAccess : TStringList;
      AllowedRNIDs: String;
   begin
      if not assigned(userxml) AND isCustomerSearch then begin
         GetRNUser(SessionVarEval.GetValueAsString('Session.Username'));
      end;
      AllowedRNIDs := UserXMLGetTag('/USERPROFILE/ALLOWEDRNIDS');
      RNIDAccess := TStringList.Create;
      if GetUserRNIDAccess(RNIDAccess, false) > 0 then AllowedRNIDs := RNIDAccess.CommaText;
      if UserXMLGetTag('/USERPROFILE/CHAINACCESS/CHAIN[@ID="' + Trim(Stri(ChainCode,-1)) + '"]/READONLY') <> '' then  AllowedRNIDs := '';
      if (AllowedRNIDs = '') then AllowedRNIDs := ExternalXMLGetTag('/EXTERNALXML/ALLOWEDRNIDS');

      If (OpenXMLGetTag('/CONFIGDATA/RNIDACCESSBYSTOREATTRIBUTES/ONDROPDOWN', 'FALSE') = 'TRUE') then begin
         if (GetUserRNIDAccessByStoreAttr(RNIDAccess) > 0) then begin
            AllowedRNIDs := RNIDAccess.CommaText;
         end else if (OpenXMLGetTag('/CONFIGDATA/RNIDACCESSBYSTOREATTRIBUTES/OVERRIDEOTHERCONFIGS', 'FALSE') = 'TRUE') then begin
            AllowedRNIDs := '1234';
         end;
      end;
      Result := AllowedRNIDs;
      ProcessLog(ltInfo, METHOD_NAME, 'AllowedRNIDs = '+AllowedRNIDs);// 2019-4-17 ss DVST-5291
      FreeAndNil(RNIDAccess);
   end;

   Function GenerateAllLocationReadOnlyOptions(IncludeALLOption : Boolean; IncludePleaseSelect : Boolean) : String; //2017-05-24 jtm: F#1554
   Var
      Locs : String;
      AllowedRNIDs : String;
      RNIDAccess : TStringList;
      i:integer;
      NoRNIDAccess : boolean; //2017-06-07 jtm: D#1714
   Begin
      AllowedRNIDs := UserXMLGetTag('/USERPROFILE/ALLOWEDRNIDS');
      RNIDAccess := TStringList.Create;
      NoRNIDAccess := false;
      if GetUserRNIDAccess(RNIDAccess,true) > 0 then begin
         if RNIDAccess.CommaText = '' then  //2017-06-07 jtm: D#1714
            NoRNIDAccess := true
         else
            AllowedRNIDs := RNIDAccess.CommaText;
      end;
      FreeAndNil(RNIDAccess);
      if not NoRNIDAccess then begin  //2017-06-07 jtm: D#1714
         if UserXMLGetTag('/USERPROFILE/CHAINACCESS/CHAIN[@ID="'+trim(Stri(ChainCode,-1))+'"]/READONLY') = 'FALSE' then  AllowedRNIDs := '';   //2016-11-03 jtm Feat OT# 1247
         if (AllowedRNIDs = '') and (ExternalXMLGetTag('/EXTERNALXML/READONLY')='FALSE') then AllowedRNIDs := ExternalXMLGetTag('/EXTERNALXML/ALLOWEDRNIDS'); //2016-8-22 jtm: Feat OT#1074
         If (AllowedRNIDs <> '') then IncludeAllOption := False;

         If (OpenXMLGetTag('/CONFIGDATA/RNIDACCESSBYSTOREATTRIBUTES/ONDROPDOWN', 'FALSE') = 'TRUE') then begin //2018-01-25 jtm F#2360
            if (GetUserRNIDAccessByStoreAttr(RNIDAccess) > 0) then begin
               AllowedRNIDs := RNIDAccess.CommaText;
            end else if (OpenXMLGetTag('/CONFIGDATA/RNIDACCESSBYSTOREATTRIBUTES/OVERRIDEOTHERCONFIGS', 'FALSE') = 'TRUE') then begin
               AllowedRNIDs := '1234'; //give it a dummy rnid when overriding other config settings
            end;
         end;
         RNQuery2.Close;
         RNQuery2.SQL.Clear;
         RNQuery2.SQL.Add('Select * from Store where (Chaincode = ' + Stri(ChainCode,-1) + ')');
         If GetConfigString('HIDECHAINRNIDS','') <> '' then begin
            RNQuery2.SQL.Add('and (NOT systemcode in (' + GetConfigString('HIDECHAINRNIDS','')+'))');
         end;
         If AllowedRNIDs <> '' then begin
            RNQuery2.SQL.Add('and (systemcode in (' + AllowedRNIDs+'))');
         end;

         if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONORDER','') <> '' then begin
            RNQuery2.SQL.Add('Order by ' + OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONORDER',''));
         end else begin
            RNQuery2.SQL.Add('Order by State,Name');
         end;

         RNQuery2.Open;
         Locs := GenerateSchoolOptions(RNquery2);
         If (RNQuery2.RecordCount > 0) and (IncludePleaseSelect) then begin
            Locs := '<option value=""> Please Select</option>' + Locs;
         end;
         If IncludeAllOption then begin
            Locs := '<option value="ALL"> All Locations</option>' + Locs;
         end;
      end;
      Result := Locs;
      RNQuery2.Close;
   end;
   Function GenerateAllSchoolOptionsDHTMLXGrid(IncludeALLOption : Boolean) : String; //2017-10-26 jtm: F#2241
   Var
      Locs, StoreName : String; //2018-08-15 bls: 560
      AllowedRNIDs : String;
      RNIDAccess : TStringList;
      StoreProfile : string;
      i,iter : integer;
      RNIDGridFields : TStringList;
   Begin
      AllowedRNIDs := UserXMLGetTag('/USERPROFILE/ALLOWEDRNIDS');
      RNIDAccess := TStringList.Create;
      if GetUserRNIDAccess(RNIDAccess,false) > 0 then AllowedRNIDs := RNIDAccess.CommaText;

      if UserXMLGetTag('/USERPROFILE/CHAINACCESS/CHAIN[@ID="'+trim(Stri(ChainCode,-1))+'"]/READONLY') <> '' then  AllowedRNIDs := '';  
      if (AllowedRNIDs = '') then AllowedRNIDs := ExternalXMLGetTag('/EXTERNALXML/ALLOWEDRNIDS');
      If (AllowedRNIDs <> '') then IncludeAllOption := False;

      If (OpenXMLGetTag('/CONFIGDATA/RNIDACCESSBYSTOREATTRIBUTES/ONGRID', 'FALSE') = 'TRUE') then begin //2018-01-25 jtm F#2360
         if (GetUserRNIDAccessByStoreAttr(RNIDAccess) > 0) then begin
            AllowedRNIDs := RNIDAccess.CommaText;
         end else if (OpenXMLGetTag('/CONFIGDATA/RNIDACCESSBYSTOREATTRIBUTES/OVERRIDEOTHERCONFIGS', 'FALSE') = 'TRUE') then begin //2018-02-02 jtm: F#3765
            AllowedRNIDs := '1234'; //give it a dummy rnid when overriding other config settings
         end;
      end;

      RNQuery2.Close;
      RNQuery2.SQL.Clear;
      RNQuery2.SQL.Add('Select * from Store where (Chaincode = ' + Stri(ChainCode,-1) + ')');
      If GetConfigString('HIDECHAINRNIDS','') <> '' then begin
         RNQuery2.SQL.Add('and (NOT systemcode in (' + GetConfigString('HIDECHAINRNIDS','')+'))');
      end;
      If AllowedRNIDs <> '' then begin
         RNQuery2.SQL.Add('and (systemcode in (' + AllowedRNIDs+'))');
      end;

      if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONORDER','') <> '' then begin 
         RNQuery2.SQL.Add('Order by ' + OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONORDER',''));
      end else begin
         RNQuery2.SQL.Add('Order by State,Name');
      end;

      RNQuery2.Open;
      i := 1; //start at row 1 unless all option included
      Locs := '<?xml version="1.0" encoding="iso-8859-1"?><rows total_count='''+IntToStr(RNQuery2.RecordCount)+''' pos= "0">';

      RNQuery2.First;
      If (OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/RNIDGRIDSTOREFIELDS','')<>'') then begin //2018-02-02 jtm: F#3765
          RNIDGridFields := TStringList.Create;
          RNIDGridFields.CommaText := OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/RNIDGRIDSTOREFIELDS');
      end;
      While Not RNQuery2.EOF do begin
         StoreProfile := RNQuery2.FieldByName('Siblings').AsString;
         StoreName := Trim(RNQuery2.FieldByName('Name').AsString); //2018-08-15 bls: 560

         if Pos('&', StoreName) > 0 then begin //2018-08-15 bls: 560
            StoreName := StringReplace(StoreName, '&', '&amp;', [rfReplaceAll]);
         end;

         if ShowStore(StoreProfile) then begin
            Locs := Locs + '<row id="'+IntToStr(i)+'"><cell>0</cell><cell>'+RNQuery2.FieldByName('SystemCode').AsString+'</cell>';

            If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONNAMEFORMAT') = 'NAMEONLY' then begin
               Locs := Locs + '<cell>'+ StoreName +'</cell>'; //2018-08-15 bls: 560
            end else if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONNAMEFORMAT') = 'UNITCITYSTATE' then begin
               Locs := Locs + '<cell>'+ Trim(RNQuery2.FieldByName('StoreId').AsString) + ', '+ Trim(RNQuery2.FieldByName('City').AsString)+', '+ Trim(RNQuery2.FieldByName('State').AsString)+'</cell>';
            end else begin
               Locs := Locs + '<cell>'+ Trim(RNQuery2.FieldByName('State').AsString) + '-' + StoreName +'</cell>'; //2018-08-15 bls: 560
            end;
            If (OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/RNIDGRIDSTOREFIELDS','')<>'') then begin //2018-02-02 jtm: F#3765
                for iter := 0 to RNIDGridFields.Count -1 do begin
                   Locs := Locs + '<cell>'+ Trim(RNQuery2.FieldByName(RNIDGridFields[iter]).AsString)+'</cell>';
                end;
            end;
            Locs := Locs + '</row>';
            inc(i);
         end;
         RNQuery2.Next;
      end;
      Locs := Locs + '</rows>';
      Result := Locs;
      RNQuery2.Close;
      FreeAndNil(RNIDAccess);
      if (assigned(RNIDGridFields)) then FreeAndNil(RNIDGridFields);
   end;
   Function GenerateStorAttrList(var StoreAttr : TTTStringList; AttrNum : string) : String; 
   Var
      Locs : String;
      AttrName : String;
      i : integer;
   Begin
      Locs := '<option value="">All</option>';
      if (GetStoreAttrOptionsSL(StoreAttr, NumericOnly(AttrNum))) then begin
         for i := 0 to StoreAttr.Count - 1 do begin
            AttrName := '';
            AttrName := StoreAttr.Strings[i];
            Locs := Locs + '<option value="' + AttrName + '">' + AttrName + '</option>';
         end;
      end;
      Result := Locs;
   end;

   Function GenerateChainOptions : String; //2016-11-03 jtm Feat OT# 1247
   var
     WS : String;
   Begin
      WS :=  '<option value="'+ Stri(ChainCode,-1) +'">' + Stri(ChainCode,-1) +'</option>';
      Result := WS;
   end;
   Function LoadWebFile(FN : String) : String;
   var
      WS : String;
      INC : String;
      FilePath : String;
   Begin
      Result := LoadWebFileFromFolder(FN,'');
      Exit;

   End;
   Procedure SendValidation(ADS : TDataSet);
   var
      WS : String;
   Begin
      WS := '<HTML>Thank you for creating your account.<BR>As a one time security measure before making payments, you must validate your account.  Click <A HREF="https://'+UpCaseString(Request.Host)+'/PP?PAGE=CONFIRMACCOUNT&CONFIRMGUID='+
            Trim(ADS.FieldByName('ConfirmGUID').AsString) +'&EMAIL='+Trim(ADS.FieldByName('Email').AsString)+'">HERE</A> to complete validation.<BR>Thank you.';

      clMail.BuildMessage('',WS);
      clMail.From.FullAddress := '"' + DomainFriendlyName+'"<'+DomainSendAsEmail+'>';
      clMail.ToList.EmailAddresses := Trim(ADS.FieldByName('Email').AsString);
      clMail.Subject := 'Account Creation Validation for ' + DomainFriendlyName;
      SMTP.Open();
      try
         SMTP.Send(clMail);
      finally
         SMTP.Close();
      end;
   end;

   procedure GetRequestDataAsStream; //2018-04-11 jtm
   var
      BytesRead, ContentLength: Integer;
      Buffer: array[0..1023] of Byte;
   begin
      RequestStream := TStringStream.Create(RequestString);
      ContentLength := Request.ContentLength;
      ProcessLog(ltInfo, 'GetRequestDataAsStream', 'Begin while loop');
      while ContentLength > Length(Request.Content) do begin
         BytesRead := Request.ReadClient(Buffer[0], Min(ContentLength, SizeOf(Buffer)));
         if BytesRead < 1 then break;
         RequestStream.Write(Buffer[0], BytesRead);
         Dec(ContentLength, BytesRead);
      end;
      ProcessLog(ltInfo, 'GetRequestDataAsStream', 'Finish while loop');
      RequestStream.Position:= 0;
   end;
begin
 Try
   Response.ContentType := 'text/html';
   Response.Expires := -1;
   Response.CustomHeaders.Values['Cache-Control'] := 'no-cache';
   Response.CustomHeaders.Values['Pragma'] := 'no-cache';
   try
   RNQuery.SQL.Text := 'Set transaction isolation level read uncommitted';
   RNQuery.ExecSQL;
   RNQuery.SQL.Text := '';
   Except
      on E:Exception do begin
         ProcessLog(ltCritical,'Exception on first PPAction RNQuery.ExecSQL', E.Message);
         ProcessLog(ltCritical,'Exception on first PPAction RNQuery.ExecSQL RNQuery.Connection.ConnectionString', RNQuery.Connection.ConnectionString);
         raise;
      end;
   end;
   GetSessionID;
   ProcessLog(ltDebug, 'CustomerInfoModulePPAction(...)', 'RNSessionID = '+RNSessionID); // 2019-6-26 ss DVST-3764
   RNID := RNLoadHostName;
   IF RNID = '' then begin
      Response.Content := 'Invalid HostName';
      exit;
   end;
   ttWebUtility.RNLoadHostName(DomainHostname);
   RNReg.ChainCode := ChainCode;
   ProcessLog(ltDebug,'ChainCode',IntToStr(ChainCode));
   PaymentLocationRNID := NumericOnly(Request.queryfields.Values['LOCATIONRNID']);
   ProcessLog(ltDebug, 'CustomerInfoModulePPAction', 'PaymentLocationRNID from NumericOnly(Request.queryfields.Values[''LOCATIONRNID'']) = '+PaymentLocationRNID); // 2019-4-17 ss DVST-3651
   if(PaymentLocationRNID = '') then begin // 2019-4-17 ss DVST-3651
      PaymentLocationRNID := RNID;
      ProcessLog(ltDebug, 'CustomerInfoModulePPAction', 'PaymentLocationRNID is empty so, it is made equal to RNID. As such PaymentLocationRNID = '+PaymentLocationRNID);
   end;
   try
      ConnectionString := FRegistry.ReadString('RetailNet ChainCodes', 'DBConn', '');
      if (ConnectionString = '') then begin
         POSTicketAPI := TPOSTicketAPI.Create(RNDB, ProcessLog, PaymentLocationRNID, InstanceGUID, ChainCode);
      end else begin
         POSTicketAPIDB := TADOConnection.Create(nil);
         POSTicketAPIDB.Connected := false;
         POSTicketAPIDB.LoginPrompt := false;
         POSTicketAPIDB.ConnectionString := ConnectionString;
         POSTicketAPIDB.IsolationLevel := ilReadUncommitted;
         POSTicketAPI := TPOSTicketAPI.Create(POSTicketAPIDB, ProcessLog, PaymentLocationRNID, InstanceGUID, ChainCode);
      end;
   Except
      on E:Exception do begin
         ProcessLog(ltWarning,'Exception on POSTicketAPI.Create ' + E.Message,InstanceGUID);
      end;
   end;
   PaymentLocationRNID := '';
   PageName := Request.queryfields.Values['PAGE'];
   PageName := 'PROFILE';
   PL.AddAppValue('RESOURCE',PageName);
   If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAGEREPLACEMENTS/PAGEREPLACEMENT[@PAGENAME=''' + PageName + ''']') <> '' then
      PageName := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAGEREPLACEMENTS/PAGEREPLACEMENT[@PAGENAME=''' + PageName + ''']');

   If (OpenXMLGetTag('/CONFIGDATA/EPICEXTPAYPAGE','FALSE') = 'TRUE') and (PageName = '') then begin //jtm:
      EpicSessionID := ValidCharsOnly(Request.QueryFields.Values['id'],true,true,'-');
      SessionVarEval.AddValue('EpicSessionID',EpicSessionID);
      ProcessLog(ltInfo,'EpicSessionID:', EpicSessionID);
      if (EpicSessionID <> '') then begin
         if (EpicGetPaySessionData(EpicSessionID)) then begin
            GenerateWebReferSession(RNID);
            WS := LoadWebFileFromFolder('hosted_payment.htm','');
         end else begin
            WS := LoadWebFileFromFolder('session_error.htm','');
         end;
      end;
      Response.Content := WS;
      exit;
   end;

   If PageName = 'ADDACCOUNT' then begin
      Email := Trim(Request.ContentFields.Values['email']);
      EMail := ValidCharsOnly(Email,True,True,'_.-#@+/');
      ReplaceString(Email,'--','-');
      SessionVarEval.AddValue('WEUSERID', EMail);
      Password := Request.ContentFields.Values['password'];

      If Email = '' then begin
         Response.Content := '<head><title>Portal Home</title>' +
                          '<meta http-equiv="refresh" content="0;URL=/PP"></head>';
         Exit;
      end;

      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from Customers where (StoreCode = '+RNID + ') and (Email = ''' + email + ''')');
      RNQuery.Open;
      If RNQuery.RecordCount > 0 then begin
         RNQuery.Close;
         PaymentPortalCustomerAuthenticate;
         exit;
      end;
      RNQuery.Insert;
      ParentGUID := GenerateGUID;
      ProcessLog(ltinfo,'AddingCustomerAccount',ParentGUID);
      RNQuery.FieldByName('CustomerCode').AsString := ParentGUID;
      RNQuery.FieldByName('Storecode').AsString := RNID;
      RNQuery.FieldByName('ChainCode').AsInteger := ChainCode;
      RNQuery.FieldByName('StartDate').AsDateTime := Now;
      RNQuery.FieldByName('LastWeblogon').AsDateTime := Now;
      RNQuery.FieldByName('Email').AsString := Trim(UpCaseString(Request.ContentFields.Values['Email']));

      if GetConfigBoolean('REQUIREVALIDATION',True) then begin
         RNQuery.FieldByName('ConfirmGUID').AsString := GenerateGUID;
      end else begin
         RNQuery.FieldByName('ConfirmGUID').AsString := 'VALIDATED';
      end;

      LoadCustomerFormData(RNQUERY);

      If OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/CASESENSITIVE', 'FALSE') = 'FALSE' then Password := UpCaseString(Password);

      RNQuery.FieldByName('PasswordBcrypt').AsString := BCryptPassword(Trim(Password),Trim(ParentGUID));
      ProcessLog(ltinfo,'AddingCustomerAccount beforepost',RNQuery.FieldByName('SystemCode').AsString);
      RNQuery.Post;
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from Customers where (StoreCode = '+RNID + ') and (Customercode = ''' + ParentGUID + ''')');
      RNQuery.Open;

      if GetConfigBoolean('REQUIREVALIDATION',True) then begin
         SendValidation(RNQuery);
      end;

      CustomerSC :=RNQuery.FieldByName('SystemCode').AsInteger;
      ProcessLog(ltinfo,'AddingCustomerAccount',Stri(CustomerSC,-1));

      If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/HIDECHILDONCREATE') <> 'TRUE' then begin
         AddChildToAccount(ParentGUID);
      end;
      If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/CREATECHILDLOCATIONONLY') = 'TRUE' then begin
         AddChildToAccount(ParentGUID);
      end;

      ProcessLog(ltinfo,'Updating WWW Session',Stri(CustomerSC,-1));

      SessionAuthQuery.Close;
      SessionAuthQuery.SQL.Clear;
      SessionAuthQuery.SQL.Add('Select * from WWWSession where RNSessionID = ''' + RnSessionID + '''');
      SessionAuthQuery.Open;
      SessionAuthQuery.Edit;
      SessionAuthQuery.FieldByName('CustomerSC').AsInteger := CustomerSC;
      SessionAuthQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime := Now + EncodeTime(1,0,0,0);
      SessionAuthQuery.Post;
      SessionAuthQuery.Close;
      Response.Content := '<head><title>Portal Home</title>' +
                       '<meta http-equiv="refresh" content="0;URL='+ GetConfigString('ONCREATEACCOUNTURL','/PP')+'"></head>';
      Exit;
   end;

   if PageName = 'VALIDATEAPPLEPAYSESSION' then begin
      ValidateApplePaySession(Response, Request.QueryFields, Request.ContentFields, Request.Host);
      Exit;
   end;
   if PageName = 'PROCESSPAYMENTAPPLEPAY' then begin
      ProcessPaymentApplePay(Response, Request.QueryFields, Request.ContentFields, Request.Host);
      Exit;
   end;

   If PageName = 'RETRIEVERECEIPT' then begin // 2019-3-13 ss DVST-3849
      ProcessLog(ltInfo, 'PageName = RETRIEVERECEIPT', 'BEGIN');
      if (RNSessionID = UpperCase(ValidCharsOnly(Request.QueryFields.Values['SESSIONID'],True,True,'-'))) and ValidateSessionID then begin
         Response.ContentType := 'text/html';
         Response.Content := GetReceiptFromRNSessionIDInURL(Request.QueryFields, Request.ContentFields);
      end;
      ProcessLog(ltInfo, 'PageName = RETRIEVERECEIPT', 'END');
      Exit;
   end;

   if PageName = 'ADDACCOUNTAJAX' then begin
      Response.Content := AddAccountAjax(Request.QueryFields,Request.ContentFields,RNID);
      exit;
   end;
   
   if PageName = 'JSENCRYPT' then begin
      WS := LoadWebFile('CardEventParamsBuilder_min.js');
      Response.Content := WS;
      if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/USEJSENCRYPTCONTENTTYPE', 'FALSE') = 'TRUE' then begin //2016-6-28 jtm
         Response.ContentType := 'application/javascript';
      end;
      Exit;
   end;

   if PageName = 'TEMPUSPAYMENTMANAGERTEST' then begin
      WS := LoadWebFileFromFolder('TempusPaymentManagerApp_PaymentMethods.html', 'TempusPages\TempusPaymentManager\Test App');
      Response.Content := WS;
      Exit;
   end;

   if PageName = 'TEMPUSPAYMENTMANAGER' then begin
      WS := LoadWebFileFromFolder('TempusPaymentManager.js', 'TempusPages\TempusPaymentManager\'+ OpenXMLGetTag('/CONFIGDATA/JSVERSION/TEMPUSPAYMENTMANAGER','current'));
      Response.Content := WS;
      Response.ContentType := 'application/javascript';
      Exit;
   end;

   if PageName = 'TEMPUSJS' then begin
      Response.Content := GetTempusJS(Request.QueryFields,Request.ContentFields);
      Exit;
   end;
   If (PageName = 'TEMPUSIVR') then begin //2017-06-07 jtm: F#1857
      IVRVxml := TIVRVXML.Create(); // ******JLS - could move this???
      if (RNSessionID = UpperCase(ValidCharsOnly(Request.QueryFields.Values['SESSIONID'],True,True,'-'))) and ValidateSessionID then begin
         ProcessLog(ltInfo, 'TEMPUSIVR', 'Valid Session');
         IVRRequest := TIVRRequest.Create(PL.ProcessLog);
         IVRRequest.RNID := RNID;
         IVRRequest.RNCert := OpenXMLGetTag('/CONFIGDATA/APIPARAMS/APICERT');
         IVRRequest.SessionID := RNSessionID;
         PaymentRNID := SessionVarEval.GetValueAsString('PaymentRNID'); //2017-07-19 jtm: F#1820
         IVRRequest.PaymentRNID := PaymentRNID;
         if (PaymentRNID <> '') then begin
            IVRRequest.PaymentRNCert := GetRNCERT(Valu(PaymentRNID));
         end;

         IVRRequest.IVRCalleeType := Request.QueryFields.Values['callee_type'];     // 6/21/2017, JLS

         IVRRequest.IVRPin := SessionVarEval.GetValueAsString('IVRPin');
         IVRRequest.VoiceName := OpenXMLGetTag('/CONFIGDATA/IVRPARAMS/VOICENAME', 'Rich');
         IVRRequest.GatewayURL := OpenXMLGetTag('/CONFIGDATA/IVRPARAMS/GATEWAYURL');
         IVRRequest.ClientResponseURL := OpenXMLGetTag('/CONFIGDATA/IVRPARAMS/CLIENTRESPONSEURL');
         IVRRequest.AVSData := SessionVarEval.GetValueAsString('AVSDATA');

         Try
            IVRActionsXML := TOpenXML.CreateFromString(Nil,'<TRANSACTION>'+SessionVarEval.GetValueAsString('IVRActions')+'</TRANSACTION>');
         except
            On E:Exception do begin
               Processlog(ltWarning, 'OpenXMLLoad Exception processing XML',E.Message);
               If Assigned(IVRActionsXML) then FreeAndNil(IVRActionsXML);
            end;
         end;
         ProcessLog(ltInfo, 'TEMPUSIVR IVRActionsXML', IVRActionsXML.DocumentAsString);
         IVRRequest.RequestXML  := IVRActionsXML;
         IVRRequest.IVRActionsNode := IVRActionsXML.GetNode('/TRANSACTION/IVRACTIONS');
         ProcessLog(ltInfo, 'TEMPUSIVR', 'Create GetSCIVXML');
         WS := IVRVxml.GetSCIVXML(IVRRequest).Text;
         if OpenXMLGetTag('/CONFIGDATA/IVRUSEFILE', 'FALSE') = 'TRUE' then begin
            WS := LoadWebFileFromFolder(OpenXMLGetTag('/CONFIGDATA/IVRFILENAME','TempusIVR.vxml'),'');
            ReplaceString(WS,'%FORMDATA%',IVRVxml.GetPaymentsForm(IVRRequest).Text);
         end;

      end else begin
         WS := LoadWebFileFromFolder('invalid_session.htm',FolderName);
         if WS = '' then begin
            WS := 'Invalid Session';
         end;
         ProcessLog(ltWarning, 'TEMPUSIVR INVALIDSESSIONID QueryField:', ValidCharsOnly(Request.QueryFields.Values['SESSIONID'],True,True,'-'));
      end;
      Response.Content := WS;
      Response.ContentType := 'text/xml';
      FreeAndNil(IVRActionsXML);
      FreeAndNIl(IVRRequest);
      freeandnil(IVRVxml);
      Exit;
   end;

   If PageName = 'AUTHENTICATE' then begin
      Response.Content := PPAuthenticateTempusUser(Request.QueryFields,Request.ContentFields,RNID,RNSessionID);
      exit;
   end;

   If PageName = 'CREATEACCOUNT' then begin
      WS := LoadWebFile('create_account.htm');
      ReplaceString(WS, '%SCHOOLOPTIONS%', GenerateAllSchoolOptions(False, false));
      ReplaceString(WS, '%LOCATIONOPTIONS%', GenerateAllLocationsOptions);
      ReplaceString(WS, '%LOCATIONSTATEOPTIONS%', GenerateAllLocationStateOptions);
      response.Content := WS;
      exit;
   end;

   If PageName = 'GETPORTALSTYLE' then begin
      WS := LoadWebFileFromFolder('PortalStyle.CSS','');
      response.Content :=WS;
      Response.ContentType := 'text/css';
      exit;
   end;

   If PageName = 'GETPORTALJS' then begin
      WS := LoadWebFileFromFolder('portal.JS','');
      response.Content :=WS;
      Response.ContentType := 'text/javascript';
      exit;
   end;
   If (PageName = 'VERIFYCAPTCHA') then begin           //2016-06-13 jtm
      WS := Trim(Request.ContentFields.Values['captchaResponse']);
      WS2 := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/RECAPTCHA/SECRETKEY');
      Response.Content := 'FALSE';
      Response.StatusCode := 401;
      ProcessLog(ltInfo, 'VERIFYCAPTCHA: captchaResponse', WS);
      if (WS <> '') and (WS2 <> '') then begin
         ExternalWebSvc(nil,HTMLResp,'https://www.google.com/recaptcha/api/siteverify?secret='+WS2+'&response=' + ws,'GET','');
         WS2 := '';
         ProcessLog(ltInfo, 'VERIFYCAPTCHA: HTMLResponse', HTMLResp.Text);
         if Pos('true', HTMLResp.Text) > 0 then begin
            Response.Content := 'TRUE';
            Response.StatusCode := 200;
         end;
      end;
      exit;
   end;
   If (PageName = 'EMAILEXISTS') then begin           //10/5/2014 Removed admin so that we can
      ADS := GetCustomerByEmail(RNID, Trim(UpCaseString(Request.ContentFields.Values['EMAILADDRESS'])));
      If (ADS <> NIL) and (ADS.Active) and (ADS.RecordCount > 0) then begin
         Response.Content := 'TRUE';
         ADS.Free;
      end else
         Response.Content := 'FALSE';
      exit;
   end;

   If PageName = 'SAML' then begin
      WS := LoadWebFileFromFolder('saml_error.htm','SAML');
      if OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/EXTERNALINTEGRATIONTYPE') = 'SAML' then begin
         ProcessLog(ltInfo, 'EXTERNALINTEGRATIONTYPE: SAML', 'Begin validation');
         Try
            ProcessLog(ltInfo, 'EXTERNALINTEGRATIONTYPE: SAML', 'write to file ');
            if Request.Content <> '' then
               AppendFileStr('C:\inetpub\wwwroot\SHPDEV\tmp\SAMLRequestContent.txt' , Request.Content);
            if Request.ContentFields.Text <> '' then
               AppendFileStr('C:\inetpub\wwwroot\SHPDEV\tmp\SAMLRequestContentFields.txt' , Request.ContentFields.Text);
            SAML := TttSAML.Create;
            SAML.OnProcessLog := PL.ProcessLog;
            SAML.ValidateSAML(CardUtil.STDBase64Decode(Request.ContentFields.Values['SAMLResponse']));
            if SAML.ValidatedSAML then begin
               ProcessLog(ltInfo, 'EXTERNALINTEGRATIONTYPE: SAML', 'SAML validated');
               SessionVarEval.Vars := SAML.AttrVarEval.Vars;
               WS := LoadWebFileFromFolder('saml_payment.htm','SAML');
            end else begin
               ProcessLog(ltWarning, 'SAML Not Valid: ', '');
            end;

         except
            On E:Exception do begin
               FreeAndNil(SAML);
               response.Content :=WS;
               ProcessLog(ltWarning, 'SAML Error: ', E.Message);
               exit;
            end;
         end
      end;
      FreeAndNil(SAML);
      response.Content :=WS;
      exit;
   end;
   if PageName = 'SAMLFAILURE' then begin
      WS := LoadWebFileFromFolder('samlfailure.htm','');
      if WS = '' then begin
         WS := LoadWebFileFromFolder('employee_login.htm','');
         ReplaceString(WS, '%ERROR%', '<BR><B><font color="red">' + OpenXMLGetTag('/CONFIGDATA/SERVICEPROVIDER/SAMLFAILUREMESSAGE','There was an error logging in.<BR>Please try again.')+'</font></B>');
      end;
      response.Content :=WS;
      exit;
   end;
   if PageName = 'SAMLAUTHFAIL' then begin //2017-06-07 jtm: F#1854
      WS := LoadWebFileFromFolder('samlauthfailure.htm','');
      if WS = '' then begin
         WS := LoadWebFileFromFolder('employee_login.htm','');
         ReplaceString(WS, '%ERROR%', '<BR><B><font color="red">' + OpenXMLGetTag('/CONFIGDATA/SERVICEPROVIDER/SAMLFAILUREMESSAGE','The username provided is not authorized for the portal.<BR>Please try again with another user or contact your administrator to gain access.')+'</font></B>');
      end;
      response.Content :=WS;
      exit;
   end;
   If PageName = 'GUESTPAYFORM' then begin
      WS := LoadWebFileFromFolder('GuestPay.htm','');
      response.Content :=WS;
      exit;
   end;

   If PageName = 'GETCUSTOMERVALIDATION' then begin
      PaymentLocationRNID := SessionVarEval.GetValueAsString('LocationRNID'); //2017-07-19 jtm: F#1820
      if (PaymentLocationRNID <> '') and (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/USELOCATIONRNID') = 'TRUE') then begin //2017-07-19 jtm: F#1820
         ProcessLog(ltInfo,'Location RNID Override: check if RNID is in chain' ,PaymentLocationRNID);
         RNQuery.Close;
         RNQuery.SQL.Text := 'Select * from Store where (SystemCode = ' + NumericOnly(PaymentLocationRNID) + ') and (Chaincode = ' + IntToStr(ChainCode) + ')';
         RNQuery.Open;
         if RNQuery.RecordCount = 1 then begin
            RNID := PaymentLocationRNID;
            SessionVarEval.AddValue('PaymentLocationRNID', PaymentLocationRNID);
            SessionVarEval.AddDSCurrentRecord(RNQuery,'Store');
            ProcessLog(ltInfo,'LocationRNID ' + PaymentLocationRNID + ' in chain: ' + IntToStr(ChainCode),'');
         end else begin
            ProcessLog(ltwarning,'LocationRNID ' + PaymentLocationRNID + ' NOT in chain: ' + IntToStr(ChainCode),'');
         end
      end;
      WS := LoadWebFileFromFolder('CustomerValidationForm.htm','');
      response.Content :=WS;
      exit;
   end;

   If PageName = 'POSTCUSTOMERVALIDATION' then begin




      SessionVarEval.AddValue('FirstName', Request.ContentFields.Values['firstname']);
      SessionVarEval.AddValue('LastName', Request.ContentFields.Values['lastname']);
      SessionVarEval.AddValue('InvoiceNumber', Request.ContentFields.Values['invoicenum']);
      WS := ValidCharsOnly(Request.ContentFields.Values['dob'],false,true,'/-'); //2018-09-12 jtm: DVST-2350
      ReplaceString(WS,'-','/');
      SessionVarEval.AddValue('DOB', ws);

      ProcessLog(ltInfo,'Starting Generic Validate, Integration Type: ' + ' ' + OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/EXTERNALINTEGRATIONTYPE'),InstanceGUID);
      Response.StatusCode := 404;
      If OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/EXTERNALINTEGRATIONTYPE') = 'PRACTICEVELOCITY' then begin
         ProcessLog(ltInfo,'Starting PV Validate',InstanceGUID);
         PVValidateResult := TStringList.Create;
         if PracticeVelocityGetPatientInfo(RNID,
                                               StrToDateTime(WS), //2018-09-12 jtm: DVST-2350
                                               Trim(Request.ContentFields.Values['LastName']),
                                               Request.ContentFields.Values['invoicenum'],
                                               OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/PRACTICEVELOCITY/PVBILLINGINFOURL'),
                                               PVValidateResult) then begin
                WS := '';//200 response says ok
                Email := Trim(UpCaseString(Request.ContentFields.Values['Email']));
                if SessionVarEval.GetValueAsString('PVPatientPractice') <> '' then begin
                   ProcessLog(ltInfo,'PV Validate PVPatientPractice: ' ,SessionVarEval.GetValueAsString('PVPatientPractice'));
                   PVRNID := GetPVPracticeRNID(SessionVarEval.GetValueAsString('PVPatientPractice'));
                   ProcessLog(ltInfo,'PV Validate PVRNID: ' + PVRNID,'RNID: ' + RNID);
                   if PVRNID <> '' then RNID := PVRNID;
                   SessionVarEval.AddValue('PVRNID', PVRNID);
                   ProcessLog(ltInfo,'PVRNID added to session: ' + PVRNID,'RNID: ' + RNID);
                end;
                ADS := GetCustomerByEmail(RNID, Trim(Email));
                If ADS.RecordCount > 0 then begin
                   ADS.Edit;
                   CustGuid := Trim(ADS.FieldByName('CustomerCode').AsString);
                   ProcessLog(ltInfo,'PV Validate POSTCUSTOMERVALIDATION Email Found' + Request.ContentFields.Values['Email'],InstanceGUID);
                end else begin
                   ADS.Insert;
                   CustGUID := GenerateGUID;
                   ADS.FieldByName('ChainCode').AsInteger := ChainCode;
                   ADS.FieldByName('StoreCode').AsString := RNID;
                   ADS.FieldByName('StartDate').AsDateTime := Now;
                   ADS.FieldByName('CustomerCode').AsString := CustGUID;
                   ADS.FieldByName('Email').AsString := Email;
                   ADS.FieldByName('ConfirmGUID').AsString := GenerateGUID;
                   if GetConfigBoolean('REQUIREVALIDATION',True) then begin
                        ADS.FieldByName('ConfirmGUID').AsString := GenerateGUID;
                   end else begin
                        ADS.FieldByName('ConfirmGUID').AsString := 'VALIDATED';
                   end;
                end;

                LastName := ValidCharsOnly(Request.ContentFields.Values['LastName'],True,True,'-'' '); //2018-06-20 bls: F#4834
                FirstName := ValidCharsOnly(Request.ContentFields.Values['FirstName'],True,True,'-'' ');

                ADS.FieldByName('FirstName').AsString := LastName;
                ADS.FieldByName('LastName').AsString := FirstName; //2018-06-20 bls: F#4834
                ADS.FieldByName('AccountNumber').AsString := ValidCharsOnly(Request.ContentFields.Values['invoicenum'], True,True,'- /');
                ADS.FieldByName('DOB').AsDateTime := LStringToDateTime(Request.ContentFields.Values['DOB']);
                ADS.FieldByName('LastWeblogon').AsDateTime := Now;
                ADS.Post;
                SessionVarEval.AddValue('CUSTGUID', CustGUID);
                Response.StatusCode := 200; //all ok
         end else begin
                WS := '';
         end;
         ProcessLog(ltInfo,'PV Validate Result ' , PVValidateResult.Text);
         PVValidateResult.Free;
      end else if OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/EXTERNALINTEGRATIONTYPE') = 'VECNA' then begin
         ProcessLog(ltInfo,'Starting Vecna Validate',InstanceGUID);
         PVValidateResult := TStringList.Create;
         if VencaAccountValidation(RNID,trim(Request.ContentFields.Values['DOB']),Trim(Request.ContentFields.Values['LastFour']),Request.ContentFields.Values['accountnum'],OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/VECNA/ACCOUNTVALIDATIONURL'),PVValidateResult) then begin
                WS := '';//200 response says ok
                Email := Trim(UpCaseString(Request.ContentFields.Values['Email']));
                ADS := GetCustomerByEmail(RNID, Trim(Email));
                If ADS.RecordCount > 0 then begin
                   ADS.Edit;
                   CustGuid := Trim(ADS.FieldByName('CustomerCode').AsString);
                   ProcessLog(ltInfo,'PV Validate POSTCUSTOMERVALIDATION Email Found' + Request.ContentFields.Values['Email'],InstanceGUID);
                end else begin
                   ADS.Insert;
                   CustGUID := GenerateGUID;
                   ADS.FieldByName('ChainCode').AsInteger := ChainCode;
                   ADS.FieldByName('StoreCode').AsString := RNID;
                   ADS.FieldByName('StartDate').AsDateTime := Now;
                   ADS.FieldByName('CustomerCode').AsString := CustGUID;
                   ADS.FieldByName('Email').AsString := Email;
                   ADS.FieldByName('ConfirmGUID').AsString := GenerateGUID;
                   if GetConfigBoolean('REQUIREVALIDATION',True) then begin
                        ADS.FieldByName('ConfirmGUID').AsString := GenerateGUID;
                   end else begin
                        ADS.FieldByName('ConfirmGUID').AsString := 'VALIDATED';
                   end;
                end;
                WS2 := SessionVarEval.GetValueAsString('VecnaPatientName');
                ADS.FieldByName('FirstName').AsString := ParseToChar(WS2,',');
                ADS.FieldByName('LastName').AsString := copy(WS2,Pos(',',WS2),length(WS2));
                ADS.FieldByName('AccountNumber').AsString := SessionVarEval.GetValueAsString('VecnaAccountNumber');
                ADS.FieldByName('DOB').AsDateTime := LStringToDateTime(SessionVarEval.GetValueAsString('dob'));
                ADS.FieldByName('LastWeblogon').AsDateTime := Now;
                ADS.Post;
                SessionVarEval.AddValue('CUSTGUID', CustGUID);
                Response.StatusCode := 200; //all ok
         end else begin
                WS := '';
         end;
         ProcessLog(ltInfo,'Venca Validate Result',PVValidateResult.Text);
         PVValidateResult.Free;
      end;
      If (OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/EXTERNALINTEGRATIONTYPE') = 'NONE') or (OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/EXTERNALINTEGRATIONTYPE') = 'CUSTOM') then begin
         WS := '';//200 response says ok
         Email := Trim(UpCaseString(Request.ContentFields.Values['Email']));

         ADS := GetCustomerByEmail(RNID, Trim(Email));
         If ADS.RecordCount > 0 then begin
            ADS.Edit;
            CustGuid := Trim(ADS.FieldByName('CustomerCode').AsString);
            ProcessLog(ltInfo,'Generic Validate POSTCUSTOMERVALIDATION Email Found' + Request.ContentFields.Values['Email'],InstanceGUID);
         end else begin
            ADS.Insert;
            CustGUID := GenerateGUID;
            ADS.FieldByName('ChainCode').AsInteger := ChainCode;
            ADS.FieldByName('StoreCode').AsString := RNID;
            ADS.FieldByName('StartDate').AsDateTime := Now;
            ADS.FieldByName('CustomerCode').AsString := CustGUID;
            ADS.FieldByName('Email').AsString := Email;
            ADS.FieldByName('ConfirmGUID').AsString := GenerateGUID;
            if GetConfigBoolean('REQUIREVALIDATION',True) then begin
               ADS.FieldByName('ConfirmGUID').AsString := GenerateGUID;
            end else begin
               ADS.FieldByName('ConfirmGUID').AsString := 'VALIDATED';
            end;
         end;

         LastName := ValidCharsOnly(Request.ContentFields.Values['LastName'],True,True,'-'' '); //2018-06-20 bls: F#4834
         FirstName := ValidCharsOnly(Request.ContentFields.Values['FirstName'],True,True,'-'' ');

         ADS.FieldByName('FirstName').AsString := FirstName;
         ADS.FieldByName('LastName').AsString := LastName; //2018-06-20 bls: F#4834
         ADS.FieldByName('AccountNumber').AsString := ValidCharsOnly(Request.ContentFields.Values['invoicenum'], True,True,'- /');//just use SessionVars instead?
         ADS.FieldByName('DOB').AsDateTime := LStringToDateTime(Request.ContentFields.Values['DOB']);
         ADS.FieldByName('LastWeblogon').AsDateTime := Now;
         ADS.Post;
         SessionVarEval.AddValue('CUSTGUID', CustGUID);

         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/USESESSIONAMT','FALSE') = 'TRUE') and ((Trim(SessionVarEval.GetValueAsString('BALANCEDUE')) <> '')) then begin
            SessionVarEval.AddValue('BalanceToPay', Trim(SessionVarEval.GetValueAsString('BALANCEDUE')));
            ProcessLog(ltdebug,'I2P: Use Session AMT', Trim(SessionVarEval.GetValueAsString('BalanceToPay')));
         end else begin
            SessionVarEval.AddValue('BalanceToPay', Trim(StriReal(ValuReal(Request.ContentFields.Values['balanceToPay']),2)));
         end;
         Response.StatusCode := 200; //all ok
      end;
      response.Content :=WS;
      exit;
   end;


   If PageName = 'GETGUESTPAYBALANCE' then begin
      If SessionVarEval.GetValueAsString('PVPatientAccount') <> '' then begin
         WS := LoadWebFileFromFolder('GuestPayBalanceDue.htm','');
      end else begin
         WS := '';
         Response.StatusCode := 401;  //Not authorized
         ProcessLog(ltwarning,'ATTEMPT TO CALL GETGUESTPAYBALNCE with no account in session vars',InstanceGUID);
      end;

      response.Content :=WS;
      exit;

   end;

   If PageName = 'GETGUESTPAYCARDINFO' then begin
      WS := LoadWebFileFromFolder('GuestPayCardInfo.htm','');
      response.Content :=WS;
      exit;
   end;

   If PageName = 'GUESTPAYPROCESSPAYMENT' then begin
      WS := '';
      ProcessLog(ltInfo,'GuestPayProcessPayment ' {+ Request.ContentFields.Text},InstanceGUID);
      If SessionVarEval.GetValueAsString('CUSTGUID') <> '' then begin
         Response.StatusCode := 404;
         VarEvaluator.AddValue('OTPCARDACCT', ValidCharsOnly(Request.ContentFields.Values['cardNumber'],False,True,''));
         VarEvaluator.AddValue('OTPEXPMONTH', ValidCharsOnly(Request.ContentFields.Values['expmonth'],False,True,''));
         VarEvaluator.AddValue('OTPEXPYEAR', ValidCharsOnly(Request.ContentFields.Values['expyear'],False,True,''));
         VarEvaluator.AddValue('OTPCVV', ValidCharsOnly(Request.ContentFields.Values['codeNum'],False,True,''));
         VarEvaluator.AddValue('OTPZIP', ValidCharsOnly(Request.ContentFields.Values['billingZip'],False,True,''));
         VarEvaluator.AddValue('OTPBillingStreet', ValidCharsOnly(Request.ContentFields.Values['billingStreet'],False,True,''));
         If OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/EXTERNALINTEGRATIONTYPE') = 'PRACTICEVELOCITY' then begin
            VarEvaluator.AddValue('TRANIDENT', SessionVarEval.GetValueAsString('PVLastName') + '-' + SessionVarEval.GetValueAsString('PVDOB'));
            VarEvaluator.AddValue('CUSTIDENT', SessionVarEval.GetValueAsString('PVPatientAccount'));
            VarEvaluator.AddValue('CustChild.AccountNumber', SessionVarEval.GetValueAsString('PVPatientAccount')); //These are for compatability with Patient as child
            VarEvaluator.AddValue('CustChild.ExternalCustIdent', SessionVarEval.GetValueAsString('PVPatientID'));
            if SessionVarEval.GetValueAsString('PVRNID') <> '' then begin
                PVRNID := SessionVarEval.GetValueAsString('PVRNID');
                if PVRNID <> '' then RNID := PVRNID;
                ProcessLog(ltInfo,'GuestPayProcessPayment PVRNID: ' + PVRNID,'RNID: ' + RNID);
            end;
         end else begin
            VarEvaluator.AddValue('TRANIDENT', SessionVarEval.GetValueAsString('TRANIDENT'));
            VarEvaluator.AddValue('CUSTIDENT', SessionVarEval.GetValueAsString('CUSTIDENT'));
            if SessionVarEval.GetValueAsString('PaymentLocationRNID') <> '' then begin   //2016-3-28 jtm
                PaymentLocationRNID := SessionVarEval.GetValueAsString('PaymentLocationRNID');
                ProcessLog(ltInfo,'GuestPayProcessPayment PaymentLocationRNID: ' + PaymentLocationRNID,'RNID: ' + RNID);
            end;
         end;
         VarEvaluator.AddValue('PAYMENTAMOUNT',ValidCharsOnly(Request.ContentFields.Values['balanceToPay'],False,True,'.'));
         If (VarEvaluator.GetValueAsString('PAYMENTAMOUNT') = '') then begin
             VarEvaluator.AddValue('PAYMENTAMOUNT',ValidCharsOnly(SessionVarEval.GetValueAsString('BalanceToPay'),False,True,'.'));
         end else if ((OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/USESESSIONAMT','FALSE') = 'TRUE') and (Trim(SessionVarEval.GetValueAsString('BalanceToPay')) <> '')) then begin //2018-05-16 ajs: F#4039
             VarEvaluator.AddValue('PAYMENTAMOUNT', Trim(SessionVarEval.GetValueAsString('BalanceToPay')));
             ProcessLog(ltdebug,'I2P: Session AMT Override', Trim(SessionVarEval.GetValueAsString('BalanceToPay')));
         end;

         if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PVUSESESSIONAMT','FALSE')) then begin //2019-05-15 jtm: DVST-2871
            if (VarEvaluator.GetValueAsCurrency('PAYMENTAMOUNT') >  SessionVarEval.GetValueAsCurrency('PVBalance')) then begin //we want to allow users to pay less than the balance, but they shouldn't be allowed to pay more. this is a double-check for frontend validation that should prevent this
               VarEvaluator.AddValue('PAYMENTAMOUNT', Trim(SessionVarEval.GetValueAsString('PVBalance')));
               ProcessLog(ltdebug,'PV: Session AMT Override', Trim(SessionVarEval.GetValueAsString('PVBalance')));
            end;
         end;

         if(StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/CREATEPOSTICKET','FALSE')))) then begin // 2019-4-17 ss DVST-3651
            VarEvaluator.AddValue('POSRNID',RNID);
            VarEvaluator.AddValue('POSPAYMENTTYPE','CARD');
            VarEvaluator.AddValue('POSACTIVITY', 'CREDITCARDAUTH');
         end;
         If ProcessPortalPayment(RNID,SessionVarEval.GetValueAsString('CUSTGUID'), NIL) then begin
            WS := LoadWebFileFromFolder('GuestPayPaymentSuccess.htm','');
            Response.StatusCode := 200;
         end;
      end else begin
         WS := '';
         Response.StatusCode := 401;  //Not authorized                                                                                                                  
         ProcessLog(ltwarning,'ATTEMPT TO CALL GUESTPAYPROCESSPAYMENT with no CUSTGUID in session vars',InstanceGUID);
     end;
      response.Content :=WS;
      exit;
   end;

   If PageName = 'HOSTEDPAYMENT' then begin
      If (OpenXMLGetTag('/CONFIGDATA/ALLOWHOSTPAY') = 'TRUE') then begin
         FolderName := '';
         if SessionVarEval.GetValueAsString('LocationName') <> '' then FolderName := SessionVarEval.GetValueAsString('LocationName'); //2016-3-28 jtm
         if (RNSessionID = UpperCase(ValidCharsOnly(Request.QueryFields.Values['SESSIONID'],True,True,'-'))) and ValidateSessionID then begin  //2016-6-13 jtm
            WS := LoadWebFileFromFolder('hosted_payment.htm',FolderName);
            if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/ENABLEDCC','FALSE') = 'TRUE') then begin
               SessionVarEval.AddValue('ALLOWDCC','TRUE');
            end;
         end else begin
            WS := LoadWebFileFromFolder('invalid_session.htm',FolderName);
            if WS = '' then begin
               WS := 'Invalid Session';
            end;
            ProcessLog(ltWarning, 'HOSTEDPAYMENT INVALIDSESSIONID QueryField:', ValidCharsOnly(Request.QueryFields.Values['SESSIONID'],True,True,'-'));
         end;
      end else begin
         WS := 'Hosted Payment Not Configured';
      end;

      response.Content := WS;
      exit;
   end;


   If PageName = 'SFPAYMENT' then begin
      WS := '';
      Email := '';
      Email := ValidCharsOnly(Request.ContentFields.Values['email'],True,True,'_.@-');
      AccountNumber := ValidCharsOnly(Request.ContentFields.Values['accountnumber'],true,true,'-/.:_');
      ChildLast := ValidCharsOnly(Request.ContentFields.Values['lastname'],true,false,'-.''' + #39);

      singleQuotePos := ansipos(#39, ChildLast);
      if singleQuotePos <> 0 then begin
         insert(#39, ChildLast, singleQuotePos);
      end;

      SessionVarEval.AddValue('SESSIONID', RNSessionID);
      if (AccountNumber <> '') then begin
         ProcessLog(ltInfo,'ServiceFirst Looking Up Customer', AccountNumber);
         RNQuery.Close;
         RNQuery.SQL.Clear;
         RNQuery.SQL.Add('Select * from Customers where CUSTOMERCODE = '''+ (AccountNumber) + '''');
         RNQuery.SQL.Add(' and STORECODE = ''' + RNID + '''');
         RNQuery.SQL.Add(' and LASTNAME = ''' + ChildLast + '''');
         RNQuery.Open;
         ProcessLog(ltInfo,'ServiceFirst Records Found', IntToStr(RNQuery.RecordCount));

         If RNQuery.RecordCount = 1 then begin
            if (RNQuery.FieldByName('Custom1').AsString <> '') then begin
               LoanTypeExists := true;
            end else begin
               LoanTypeExists := false;
            end;
            if (LoanTypeExists) and (RNQuery.FieldByName('Custom1').AsString <> 'VA') then begin  //CC Allowed Only if not VA & Loan Type Exists
               SessionVarEval.AddValue('ALLOWCC','TRUE');
            end else begin
               SessionVarEval.AddValue('ALLOWCC','FALSE');
            end;
            SessionVarEval.AddValue('ALLOWACH','TRUE'); //ACH Always Allowed
            SessionVarEval.AddValue('EMAIL', Email);
            SessionVarEval.AddValue('BALANCEDUE', Trim(RNQuery.FieldByName('BALANCEDUE').AsString));
            SessionVarEval.AddValue('ACCOUNTNUMBER', AccountNumber);
            SessionVarEval.AddValue('FIRSTNAME', Trim(RNQuery.FieldByName('FIRSTNAME').AsString));
            SessionVarEval.AddValue('LASTNAME', Trim(RNQuery.FieldByName('LASTNAME').AsString));

            SessionVarEval.AddValue('DUEDATE', Trim(RNQuery.FieldByName('Custom2').AsString));
            SessionVarEval.AddValue('ADDRESS', Trim(RNQuery.FieldByName('ADDRESS').AsString));
            SessionVarEval.AddValue('CITY', Trim(RNQuery.FieldByName('CITY').AsString));
            SessionVarEval.AddValue('STATE', Trim(RNQuery.FieldByName('STATE').AsString));
            SessionVarEval.AddValue('ZIP', Trim(RNQuery.FieldByName('ZIP').AsString));
            SessionVarEval.AddValue('Custom1', Trim(RNQuery.FieldByName('Custom1').AsString));
            
            RNQuery.Edit;
            RNQuery.FieldByName('Email').AsString := Email;
            RNQuery.Post;
            RNQuery.Close;

            If (not LoanTypeExists) and (OpenXMLGetTag('/CONFIGDATA/ALLOWPAYMORTGAGE') = 'TRUE') then begin
               WS := LoadWebFileFromFolder('mortgage_payment.htm','');
            end else if (LoanTypeExists) and (OpenXMLGetTag('/CONFIGDATA/ALLOWPAYAPPRAISAL') = 'TRUE') then begin
               WS := LoadWebFileFromFolder('appraisal_payment.htm','');
            end else begin
               ProcessLog(ltInfo, 'ServiceFirst Page Load Error', 'Not Configured for Mortgage or Appraisal');
               WS := '<head><title>Portal Home</title>' +
                     '<meta http-equiv="refresh" content="0;URL=/PP?PAGE=SFERROR"></head>';
            end;
         end else begin
            ProcessLog(ltInfo, 'ServiceFirst Loan Not Found', 'Load Error Page');
            WS := '<head><title>Portal Home</title>' +
                  '<meta http-equiv="refresh" content="0;URL=/PP?PAGE=SFERROR"></head>';
         end;
      end else begin
         ProcessLog(ltInfo, 'ServiceFirst Account Number Not Passed', 'Load Error Page');
         WS := '<head><title>Portal Home</title>' +
               '<meta http-equiv="refresh" content="0;URL=/PP?PAGE=SFERROR"></head>';
      end;

      response.Content := WS;
      exit;
   end;

   If PageName = 'SFERROR' then begin //2018-03-29 ajs: F#3383
      WS := LoadWebFileFromFolder('error.htm','');
      response.Content := WS;
      exit;
   end;


   If PageName = 'GUESTPAY' then begin
      If (OpenXMLGetTag('/CONFIGDATA/ALLOWGUESTPAY') = 'TRUE') then begin
         WS := LoadWebFile('guest_payment.htm')
      end else begin
         WS := '<head><title>Portal Home</title>' +
                     '<meta http-equiv="refresh" content="0;URL=/PP"></head>';
      end;


      response.Content := WS;
      exit;
   end;

   If PageName = 'GUESTPOSTPAY' then begin
      If (OpenXMLGetTag('/CONFIGDATA/ALLOWGUESTPAY') = 'TRUE') then begin
         ProcessLog(ltInfo,'GUESTPOSTPAY',NumericOnly(Request.ContentFields.Values['School']));
         PaymentSuccess := false;
         if (OpenXMLGetTag('/CONFIGDATA/SERVICEFIRSTGUESTPAY','FALSE') = 'TRUE') then begin  //2018-03-29 ajs: F#3383
            If (Trim(SessionVarEval.GetValueAsString('ACCOUNTNUMBER')) <> '') then begin
               CustGUID := Trim(SessionVarEval.GetValueAsString('ACCOUNTNUMBER'));
               OpenCustomerQueryGUID('',CustGUID);
            end else begin
               ProcessLog(ltInfo, 'ServiceFirst Account Number Not stored in session', 'Load Error Page');
               WS := '<head><title>Portal Home</title>' +
                     '<meta http-equiv="refresh" content="0;URL=/PP?PAGE=SFERROR"></head>';
               response.Content := WS;
               exit;
            end;
         end else begin
           ADS := GetCustomerByEmail(RNID, Trim(Request.ContentFields.Values['email']));
           If (ADS <> NIL) and (ADS.RecordCount = 1) then begin
               CustGUID := ADS.FieldByName('CustomerCode').AsString;
               if (NumericOnly(Request.ContentFields.Values['HomeZip']) <> '') then begin
                  ADS.Edit;
                  ADS.FieldByName('ZIP').AsString := NumericOnly(Request.ContentFields.Values['HomeZip']);
                  ADS.Post;
               end;
               OpenCustomerQueryGUID('',CustGUID)
           end;
         end;

         If CustGUID = '' then
            CustGUID := AddCustomer(RNID, GenerateGUID, nil);


         If CustGUID <> '' then begin
            if (OpenXMLGetTag('/CONFIGDATA/GUESTPAYAUTOCREATECHILD') = 'TRUE') then begin
               ProcessLog(ltInfo, 'GUESTPOSTPAY', 'Look for child by values' );
               ChildFirst := ValidCharsOnly(Request.ContentFields.Values['ChildFirst'],true,false,''); //2016-10-19 jtm Def OT# 1270
               ChildLast := ValidCharsOnly(Request.ContentFields.Values['ChildLast'],true,false,'');
               if ChildFirst = '' then ChildFirst := RNQuery.FieldByName('FirstName').AsString;
               if ChildLast = '' then ChildLast := RNQuery.FieldByName('LastName').AsString;
               ADS := GetChildByValues(RNID, CustGUID, Trim(Request.ContentFields.Values['dob']), Trim(ChildFirst), Trim(ChildLast));
               If (ADS.Active) and (ADS.RecordCount >= 1) and (ADS.FindField('ChildGUID') <> nil) then begin    //2017-04-12 jtm: Def #1591
                  ProcessLog(ltInfo, 'GUESTPOSTPAY', 'child found:'+ ADS.FieldByName('ChildGUID').AsString);
                  ChildGUID := ADS.FieldByName('ChildGUID').AsString;
               end else begin
                  ProcessLog(ltInfo, 'GUESTPOSTPAY', 'child NOT found adding now..');
                  AddChildToAccount(CustGUID);
                  ADS := GetChildByValues(RNID, CustGUID, Trim(Request.ContentFields.Values['dob']), Trim(Request.ContentFields.Values['ChildFirst']), Trim(Request.ContentFields.Values['ChildLast']));
                  if (ADS.FindField('ChildGUID') <> nil) then begin
                     ChildGUID := ADS.FieldByName('ChildGUID').AsString;
                     ProcessLog(ltInfo, 'GUESTPOSTPAY','child added: '+ ChildGUID);
                  end else begin
                     ProcessLog(ltInfo, 'GUESTPOSTPAY','child not found after adding');
                  end;
               end;
               if (ADS.FindField('AccountNumber') <> nil) then begin
                  TranIdent := Trim(ADS.FieldByName('AccountNumber').AsString);
               end;
               If TranIdent <> '' then begin
                  TranIdent := TranIdent + '/';
                  TranIdent := TranIdent + Trim(ADS.FieldByName('LastName').AsString) + ' ' + Trim(ADS.FieldByName('FirstName').AsString);
               end;
               OpenCustomerQueryGUID('',CustGUID);///open query again since it was closed by Child look up and add
            end;
            VarEvaluator.AddDSCurrentRecord(RNQuery, 'Customers'); //add customer record to use in receipt email
            ProcessLog(ltInfo,'PROCESS PAYMENT',NumericOnly(Request.ContentFields.Values['School']));

            PaymentLocationRNID := NumericOnly(Request.ContentFields.Values['School']);
            If PaymentLocationRNID = '' then
               PaymentLocationRNID := NumericOnly(Request.ContentFields.Values['PaymentLocation']);
            If PaymentLocationRNID = '' then begin //If this is blank, we're not doing it on behalf of a specific location, use site RNID
               PaymentLocationRNID := RNID;
            end else begin
               If Not ValidateRNID(PaymentLocationRNID) then begin
                  ProcessLog(ltWarning,'Attempt to Process Payment For Invalid Location RNID',NumericOnly(Request.ContentFields.Values['School']));

                  WS := '';
                  if strtobool(OpenXMLGetTag('/CONFIGDATA/GUESTPAY/USEJSONRESP', 'FALSE')) then begin
                     WS := '{ "transuccess": false, "tranrespmessage": "Invalid RNID" }';
                  end else begin
                     WS := '<head><title>Portal Home</title><meta http-equiv="refresh" content="0;URL=/PP"></head>';
                  end;
                  Response.Content := WS;
                  exit;
               end;
               OpenCustomerQuery; // we have to do this again because validaternid closed our query
            end;

            Email := Trim(RNQuery.FieldByName('Email').AsString);
            ParentGUID := Trim(RNQuery.FieldByName('CustomerCode').AsString);


            CustIdent := Trim(RNQuery.FieldByName('FirstName').AsString) + ' ' +Trim(RNQuery.FieldByName('LastName').AsString);
            If Trim(RNQuery.FieldByName('employer').AsString) <> '' then
               CustIdent := CustIdent + '/' +Trim(RNQuery.FieldByName('employer').AsString);

            if (ValidCharsOnly(Request.ContentFields.Values['TranIdent'],True,True,'.-_:/& ') <> '') then begin
               Tranident := ValidCharsOnly(Request.ContentFields.Values['TranIdent'],True,True,'.-_:/& ');
            end;
            if (ValidCharsOnly(Request.ContentFields.Values['CustIdent'],True,True,'.-_:/& ') <> '') then begin
               Custident := ValidCharsOnly(Request.ContentFields.Values['CustIdent'],True,True,'.-_:/& ');
            end;

            AccountNumber := Trim(RNQuery.FieldByName('AccountNumber').AsString);

            WS2 := ValidCharsOnly(Request.ContentFields.Values['custname'],true,true,'/. ');
            If WS2 <> '' then begin
               WS2 := '/' + WS2;
            end;

            If (OpenXMLGetTag('/CONFIGDATA/STORECUSTOMFIELDS','FALSE') = 'TRUE') then begin //2017-09-20 jtm: F#2192
               CustomField1 := ValidCharsOnly(Request.ContentFields.Values['Custom1'],true,true,'/.-&(),:+=_ ');
               CustomField2 := ValidCharsOnly(Request.ContentFields.Values['Custom2'],true,true,'/.-&(),:+=_ ');
               CustomField3 := ValidCharsOnly(Request.ContentFields.Values['Custom3'],true,true,'/.-&(),:+=_ ');
               CustomField4 := ValidCharsOnly(Request.ContentFields.Values['Custom4'],true,true,'/.-&(),:+=_ ');
               CustomField5 := ValidCharsOnly(Request.ContentFields.Values['Custom5'],true,true,'/.-&(),:+=_ ');
               CustomField6 := ValidCharsOnly(Request.ContentFields.Values['Custom6'],true,true,'/.-&(),:+=_ ');
               CustomField7 := ValidCharsOnly(Request.ContentFields.Values['Custom7'],true,true,'/.-&(),:+=_ ');
               CustomField8 := ValidCharsOnly(Request.ContentFields.Values['Custom8'],true,true,'/.-&(),:+=_ ');
               CustomField9 := ValidCharsOnly(Request.ContentFields.Values['Custom9'],true,true,'/.-&(),:+=_ ');
               CustomField10 := ValidCharsOnly(Request.ContentFields.Values['Custom10'],true,true,'/.-&(),:+=_ ');
               if Length(CustomField1) > 200 then CustomField1 := Copy(CustomField1,0,200);
               if Length(CustomField2) > 200 then CustomField2 := Copy(CustomField2,0,200);
               if Length(CustomField3) > 200 then CustomField3 := Copy(CustomField3,0,200);
               if Length(CustomField4) > 200 then CustomField4 := Copy(CustomField4,0,200);
               if Length(CustomField5) > 200 then CustomField5 := Copy(CustomField5,0,200);
               if Length(CustomField6) > 200 then CustomField6 := Copy(CustomField6,0,200);
               if Length(CustomField7) > 200 then CustomField7 := Copy(CustomField7,0,200);
               if Length(CustomField8) > 200 then CustomField8 := Copy(CustomField8,0,200);
               VarEvaluator.AddValue('CustomField1',CustomField1);
               VarEvaluator.AddValue('CustomField2',CustomField2);
               VarEvaluator.AddValue('CustomField3',CustomField3);
               VarEvaluator.AddValue('CustomField4',CustomField4);
               VarEvaluator.AddValue('CustomField5',CustomField5);
               VarEvaluator.AddValue('CustomField6',CustomField6);
               VarEvaluator.AddValue('CustomField7',CustomField7);
               VarEvaluator.AddValue('CustomField8',CustomField8);
               VarEvaluator.AddValue('CustomField9',CustomField9);
               VarEvaluator.AddValue('CustomField10',CustomField10);
            end;

            if (ValidCharsOnly(Request.ContentFields.Values['RefererURL'],true,true,'/.-&(),:+=_ ') <> '') then begin
            RefererURL := ExtractDomain(ValidCharsOnly(Request.ContentFields.Values['RefererURL'],true,true,'/.-&(),:+=_ ')); //2018-12-19 jtm: DVST-126
            end;
            if RefererURL = '' then begin
               RefererURL := DomainHostname;
            end;
            PaymentHistGuid := GenerateGUID;
            RNQuery.Close;
            RNQuery.SQL.Clear;
            RNQuery.SQL.Add('select * from CustPaymentHistory');
            RNQuery.SQL.Add('where (PayHistGUID = '''+PaymentHistGUID + ''')');
            RNQuery.Open;
            RNQuery.Insert;
            RNQuery.FieldByName('SiteRNID').AsString := RNID;
            RNQuery.FieldByName('RNID').AsString := PaymentLocationRNID;
            RNQuery.FieldByName('CustGUID').AsString := ParentGUID;
            if ChildGUID <> '' then
               RNQuery.FieldByName('ChildGUID').AsString := ChildGUID;
            RNQuery.FieldByName('PAYHISTGUID').AsString := PaymentHistGuid;
            RNQuery.FieldByName('PaymentDate').AsDateTime := NOW;

            if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/USESESSIONAMT','FALSE') = 'TRUE') and ((Trim(SessionVarEval.GetValueAsString('BALANCEDUE')) <> '') and (Trim(SessionVarEval.GetValueAsString('BALANCEDUE')) <> '0')) then begin
               PaymentAmount := Trim(SessionVarEval.GetValueAsString('BALANCEDUE'));
               ProcessLog(ltDebug, 'GUESTPOSTPAY using sessionamt:', PaymentAmount);
            end else begin
               PaymentAmount := ValidCharsOnly(Request.ContentFields.Values['amount'],False,True,'.');
               ProcessLog(ltDebug, 'GUESTPOSTPAY using amt passed in:', PaymentAmount);
            end;

            RNQuery.FieldByName('PaymentAmount').AsString := PaymentAmount;
            RNQuery.FieldByName('SplitDetails').AsString := Request.ContentFields.Values['split'];

            If (OpenXMLGetTag('/CONFIGDATA/STORECUSTOMFIELDS','FALSE') = 'TRUE') then begin //2017-09-20 jtm: F#2192
               RNQuery.FieldByName('Custom1').AsString := CustomField1;
               RNQuery.FieldByName('Custom2').AsString := CustomField2;
               RNQuery.FieldByName('Custom3').AsString := CustomField3;
               RNQuery.FieldByName('Custom4').AsString := CustomField4;
               RNQuery.FieldByName('Custom5').AsString := CustomField5;
               RNQuery.FieldByName('Custom6').AsString := CustomField6;
               RNQuery.FieldByName('Custom7').AsString := CustomField7;
               RNQuery.FieldByName('Custom8').AsString := CustomField8;
               RNQuery.FieldByName('Custom9').AsString := CustomField9;
               RNQuery.FieldByName('Custom10').AsString := CustomField10;
            end;

            RNQuery.FieldByName('RefererURL').AsString := RefererURL;       //2018-12-19 jtm: DVST-126
            RNQuery.Post;

            RNProfileDI := TTADODataLayer.Create(RNDB);
            RNProfile := TTProfile.Create(PaymentLocationRNID, false, RNProfileDI);
            
            try
               VarEvaluator.AddValue('PaymentDate', FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', LocalTimeToZoneTime(RNQuery.FieldByName('PaymentDate').AsDateTime, RNProfile.StoreTZ)) + ' ' + RNProfile.StoreTZ);
            except
               on E:Exception do begin
                 response.Content := '{ "tranrespmessage": "Date Conversion Error", "transuccess": false }';
                 exit;
               end;
            end;
            RNProfile.Free;
            RNProfileDI.Free;

            VarEvaluator.AddDSCurrentRecord(RNQuery, 'CustPaymentHistory'); //make this available for custom receipt email
            ReceiptNumber := Trim(PaymentLocationRNID) + '-' +
                             RNQuery.FieldByName('SystemCode').AsString + '-' +
                             FormatDateTime('YYMMDD',date);

            VarEvaluator.AddValue('ReceiptNumber', ReceiptNumber);  //make this available for custom receipt email

            If TranIdent <> '' then begin
            end else if GetConfigString('TRANIDENTTYPE','STD') = 'STD' then begin
               TranIdent := ReceiptNumber;
            end else if (GetConfigString('TRANIDENTTYPE','') = 'OTP') and (ValidCharsOnly(Request.ContentFields.Values['TranIdent'],True,True,'.-_:/& ') <> '') then begin  //2018-12-19 ss: DVST2901 - For guest payments that are OTP(s) the TranIdent is generated at the front and sent to the back end in a TranIdent input element
               TranIdent := ValidCharsOnly(Request.ContentFields.Values['TranIdent'],True,True,'.-_:/& ');
            end else begin
               TranIdent := AccountNumber + '/' + ValidCharsOnly(Request.ContentFields.Values['invoice'],true,true,'.-_:/& ');
               If ValidCharsOnly(Request.ContentFields.Values['dob'],false,true,'/.-') <> '' then
                  TranIdent :=  '(' + ValidCharsOnly(Request.ContentFields.Values['dob'],false,true,'/.-') + ')' + TranIdent;
            end;
            TranAmount := '$' + Trim(StriREal(RNQuery.FieldByName('PaymentAmount').AsFloat,2));

            ProcessLog(ltInfo,'PROCESS PAYMENT CustPaymentHistory inserted',NumericOnly(Request.ContentFields.Values['School']));
            VarEvaluator.AddValue('TranIdent', TranIdent);

            TranIdentExpression := OpenXMLGetTag('/CONFIGDATA/TRANIDENTEXPRESSION');
            If TranIdentExpression <> '' then begin
               TranIdent := VarEvaluator.VarExprEvalAsString('',TranIdentExpression);
            end;
            CustIdentExpression := OpenXMLGetTag('/CONFIGDATA/CUSTIDENTEXPRESSION');
            If CustIdentExpression <> '' then begin
               CustIdent := VarExprEvalAsString('',CustIdentExpression);
            end;

            VarEvaluator.AddValue('TRANIDENT',TranIdent);
            PaymentResponse := '';
            PaymentServiceName := 'CARD';
            If NumericOnly(Request.ContentFields.Values['RetypeNumber']) <> '' then PaymentType := 'CARD';
            If NumericOnly(Request.ContentFields.Values['BankRouting']) <> '' then PaymentType := 'CHECK';
            If PaymentType = 'CARD' then begin
               PaymentServiceName := OpenXMLGetTag('/CONFIGDATA/PAYMENTTYPES/PAYMENTTYPE[@NAME=''CREDIT'']/SERVICENAME');
               if PaymentServiceName = '' then
                  PaymentServiceName := 'CARD';
                ExpDate := EncodeDate(Valu(NumericOnly(Request.ContentFields.Values['EXPYEAR'])),
                            Valu(NumericOnly(Request.ContentFields.Values['EXPMONTH'])),
                            1);
                PaymentRequest := '<TRANSACTION> <RNID>'+RNID+'</RNID>' +
                                  '<TRANSACTIONTYPE>CCAUTH</TRANSACTIONTYPE>'+
                                  '<CCEXP>'+formatDateTime('MM/YY',ExpDate)+'</CCEXP>' +
                                  '<SERVICENAME>'+ PaymentServiceName+'</SERVICENAME>' +
                                  '<CCAVS>'+NumericOnly(Request.ContentFields.Values['Billingzip'])+'</CCAVS>' +
                                  '<CCCVV>' +NumericOnly(Request.ContentFields.Values['CVV'])+'</CCCVV>'+
                                  '<CCACCOUNT>'+NumericOnly(Request.ContentFields.Values['RetypeNumber'])+'</CCACCOUNT>' +
                                  '<CCAUTHTYPE>SALE</CCAUTHTYPE> <CCAMT>'+PaymentAmount+'</CCAMT>' +       //TODO: <CCNAME> add
                                  '<TRANIDENT>'+Tranident+'</TRANIDENT> <CUSTIDENT>'+CustIdent+WS2+'</CUSTIDENT> <STATIONIDENT>WEBSITE</STATIONIDENT>';

                if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then     //2016-9-19 jtm: Feat OT# 1145
                   PaymentRequest := PaymentRequest + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';
                if (OpenXMLGetTag('/CONFIGDATA/INCLUDEEMPTYTAXAMOUNT','FALSE') = 'TRUE') then begin //2017-12-13 jtm D#2146
                   PaymentRequest := PaymentRequest + '<TAXAMOUNT>0</TAXAMOUNT>';
                end;
                PaymentRequest := PaymentRequest + ' </TRANSACTION>'+CRLF;
                XMLResp := TStringList.Create;
                VarEvaluator.AddValue('GatewayRNID',RNID);//2017-05-24 jtm: F#1821
                ProcessPPSAPIXML(PaymentRequest, XMLResp,GetAppServerHost,0);
                IF GetXMLTag(XMLResp,'CCAUTHCODE') <> '' then begin
                   ApprovalCode := GetXMLTag(XMLResp,'CCAUTHCODE');
                   EmailMessage := '<HTML>Thank you for your Payment.<BR>'+//PaymentToken + '/' + PaymentType +  Trim(Request.ContentFields.Values['payment'])+  PaymentREsponse +
                                   'Receipt Number:' + ReceiptNumber + '<BR>' +
                                   'Amount:' + TranAmount+ '<BR>' +
                                   'Date:' + FormatDateTime('MM/DD/YYYY', NOW)+ '<BR>';
                   HTMLEmail := LoadWebFileFromFolder('ReceiptCardApproved.htm','');   //we need to do this here so all of the variables are loaded.
                   If HTMLEmail <> '' then EmailMessage := HTMLEmail;
                   PaymentSuccess := true;
                end else begin
                   NonAuthReason := GetXMLTag(XMLResp,'TRANRESPMESSAGE');
                   VarEvaluator.AddValue('NonAuthReason',NonAuthReason);//2017-10-26 ajs: F#2279
                   EmailMessage := '<HTML>We''re sorry, but your Credit card Payment was not processed.<BR>'+
                                   'Please confirm your account information is correct or call your card issuer for further assistance.<BR>';
                   HTMLEmail := LoadWebFileFromFolder('ReceiptCardDeclined.htm','');   //we need to do this here so all of the variables are loaded.
                   If HTMLEmail <> '' then EmailMessage := HTMLEmail;
                   PaymentSuccess := false;
                end;
                GWSystemCode := GetXMLTag(XMLResp,'CCSYSTEMCODE');
                PaymentResponse := GetXMLTag(XMLResp,'CCAUTHCODE');
                XMLResp.Free;
            end;
            If PaymentType = 'CHECK' then begin    ///TO-DO
               PaymentServiceName := OpenXMLGetTag('/CONFIGDATA/PAYMENTTYPES/PAYMENTTYPE[@NAME=''CHECK'']/SERVICENAME','ICA');
               if (OpenXMLGetTag('/CONFIGDATA/SERVICEFIRSTGUESTPAY','FALSE') = 'TRUE') and (ValidCharsOnly(Request.ContentFields.Values['SERVICENAME'],true,true,'-') = 'ICA-2') then begin
                  PaymentServiceName := 'ICA-2';
               end;

               PaymentRequest := '<TRANSACTION>' +
                                 '   <TRANSACTIONTYPE>TCAUTH</TRANSACTIONTYPE>' +
                                 '   <SERVICENAME>' + PaymentServiceName + '</SERVICENAME>' +
                                 '   <RNID>'+RNID+'</RNID>' +
                                 '   <CHECKTYPE>PERSONAL</CHECKTYPE>' +
                                 '   <CHECKAMT>' + PaymentAmount + '</CHECKAMT>' +
                                 '   <CHECKROUTING>'+NumericOnly(Request.ContentFields.Values['BankRouting'])+'</CHECKROUTING>' +
                                 '   <CHECKACCOUNT>'+NumericOnly(Request.ContentFields.Values['BankNumber'])+'</CHECKACCOUNT>' +
                                 '   <CHECKDL>'+ValidCharsOnly(UpCaseString(Request.ContentFields.Values['driversno']),True,True,'')+'</CHECKDL>' +
                                 '   <CHECKDLSTATE>'+ValidCharsOnly(UpCaseString(Request.ContentFields.Values['driversstate']),True,false,'')+'</CHECKDLSTATE>' +
                                 '   <CHECKNAME>'+CustIdent+WS2+'</CHECKNAME>' +
                                 '   <CUSTIDENT>'+ CustIDent+'</CUSTIDENT>'+
                                 '   <TRANIDENT>'+ TranIdent+'</TRANIDENT>'+
                                 '   <STATIONIDENT>'+ 'WEBSITE'+'</STATIONIDENT>';
               if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then      //2016-9-19 jtm: Feat OT# 1145
                   PaymentRequest := PaymentRequest + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';

               PaymentRequest := PaymentRequest + ' </TRANSACTION>'+CRLF;

               XMLResp := TStringList.Create;
               ProcessPPSAPIXML(PaymentRequest, XMLResp,GetAppServerHost,0);
               GWSystemCode := GetXMLTag(XMLResp,'TCSYSTEMCODE');
               IF GetXMLTag(XMLResp,'TCECASTATUS') = '1' then begin
                  ApprovalCode := GetXMLTag(XMLResp,'TCDISPLAYTEXT');
                  EmailMessage := '<HTML>Thank you for your Payment.<BR>'+//PaymentToken + '/' + PaymentType +  Trim(Request.ContentFields.Values['payment'])+  PaymentREsponse +
                                  'Receipt Number:' + TranIdent + '<BR>' +
                                  'Amount:' + TranAmount+ '<BR>' +
                                  'Date:' + FormatDateTime('MM/DD/YYYY', NOW)+ '<BR>';
                  HTMLEmail := LoadWebFileFromFolder('ReceiptCheckApproved.htm','');   //we need to do this here so all of the variables are loaded.
                  If HTMLEmail <> '' then EmailMessage := HTMLEmail;
                  PaymentSuccess := true;
               end else begin
                  NonAuthReason := GetXMLTag(XMLResp,'TCDISPLAYTEXT');
                  EMailMessage := '<HTML>Your check payment has not been processed.<BR><BR>'+
                                  'We are sorry that we cannot accept your check at this time.  Our decision is based, in whole or in part, on '+
                                  'information provided to us by TeleCheck(r).  We encourage you to call TeleCheck at 1-800-366-2425 or write TeleCheck '+
                                  'Customer Care at P.O. Box 6806, Hagerstown, MD 21741-6806.  TeleCheck can discuss with you the information that led to '+
                                  'our decision not to accept your check at this time.  Please provide TeleCheck your driver''s license number and the '+
                                  'state where it was issued, and the complete banking numbers printed on the bottom of your check. Under the Fair Credit '+
                                  'Reporting Act, you have the right to a free copy of your information held in TeleCheck''s files within 60 days from today. '+
                                  'You may also dispute the accuracy or completeness of any information in TeleCheck''s consumer report.<BR><BR></HTML>';
                  HTMLEmail := LoadWebFileFromFolder('ReceiptCheckDeclined.htm','');   //we need to do this here so all of the variables are loaded.
                  If HTMLEmail <> '' then EmailMessage := HTMLEmail;
                  PaymentSuccess := false;
               end;
               PaymentResponse := GetXMLTag(XMLResp,'TCDISPLAYTEXT');
               XMLResp.Free;

            end;
            RNQuery.Close;
            RNQuery.SQL.Clear;
            RNQuery.SQL.Add('select * from CustPaymentHistory');
            RNQuery.SQL.Add('where (PayHistGUID = '''+PaymentHistGUID + ''')');
            RNQuery.Open;
            RNQuery.Edit;
            RNQuery.FieldByName('ApprovalCode').AsString := ApprovalCode;
            RNQuery.FieldByName('NonAuthReason').AsString := NonAuthReason;
            RNQuery.FieldByName('GWSystemCode').AsInteger := Valu(GWSystemCode);
            If PaymentType = 'CARD' then
               RNQuery.FieldByName('CustHistDesc').AsString :=  MaskCardAcct(Trim(NumericOnly(Request.ContentFields.Values['RetypeNumber'])));
            If PaymentType = 'CHECK' then
               RNQuery.FieldByName('CustHistDesc').AsString :=  MaskStr(NumericOnly(Request.ContentFields.Values['BankNumber']),
                                                                        DigitsToMask(NumericOnly(Request.ContentFields.Values['RetypeNumber'])));
            if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/STORECARDTYPE','FALSE')) and (PaymentType = 'CARD') then begin
               RNQuery.FieldByName('Custom8').AsString := ComputeCardTypeEx(Trim(NumericOnly(Request.ContentFields.Values['RetypeNumber'])));
            end;
            RNQuery.Post;
            ProcessLog(ltDebug, 'GUESTPOSTPAY', 'CustPaymentHistory  PaymentHistGUID = '+PaymentHistGUID); //2019-3-13 ss CHCO troubleshooting
            if strtobool(OpenXMLGetTag('/CONFIGDATA/GUESTPAY/USEJSONRESP', 'FALSE')) then begin
               if not(PaymentSuccess) then begin
                  WS := '{ "tranrespmessage": "Payment unsuccessful", "transuccess": false }';
               end else begin
                  WS := '{ "tranrespmessage": "Payment confirmed", "transuccess": true }';
               end;
            end else begin
               if (OpenXMLGetTag('/CONFIGDATA/GUESTPOSTPAYSHOWDECLINECONFIRMATION','FALSE') = 'TRUE') and not(PaymentSuccess) then begin
                  WS := LoadWebFile('payment_guest_decline.htm');
               end else begin
                  WS := LoadWebFile('payment_guest_confirmation.htm');
               end;
               if (WS = '') then begin
                   WS := LoadWebFile('payment_guest_confirmation.htm');
               end;
            end;

            If RNQuery.FieldByName('SplitDetails').ASString <> '' then begin
               ProcessLog(ltDebug, 'GUESTPOSTPAY', 'SplitDetails = '+RNQuery.FieldByName('SplitDetails').ASString); //2019-3-13 ss CHCO troubleshooting
				   If StrtoBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/CUSTRECEIPT/INCLUDESPLITTABLE', 'TRUE')) then begin
                  EMailMessage := EMailMessage + '<BR>' + GenerateSplitTable(RNQuery.FieldByName('SplitDetails').ASString);
               end;
               ReplaceString(EmailMessage, '%SPLITDETAILTABLE%',GenerateSplitTable(RNQuery.FieldByName('SplitDetails').ASString));
            end;

            If StrtoBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/CUSTRECEIPT/INCLUDECUSTIDENTACCOUNTNUM', 'TRUE'))   then begin //2018-12-19 ss: DVST-2901 - For custom split table, we don't add the custIdent and accountNum
               EmailMessage := EMailMessage + '<BR>' +CustIdent;
               EmailMessage := EMailMessage + '<BR>' +AccountNumber;
            End;

            ReplaceString(WS, '%RECEIPTURL%','/PP?PAGE=PAYMENTRECEIPT&PAYHISTGUID=' + Trim(RNQuery.FieldByName('PAYHISTGUID').AsString));
            ReplaceString(WS, '%PAYMENTSYSTEMCODE%',receiptNumber);
            ReplaceString(EmailMessage, '%APPROVALCODE%', ApprovalCode);

            response.Content := WS;

            clMail.BuildMessage('',EmailMessage);
            clMail.From.FullAddress := '"' + DomainFriendlyName+'"<'+DomainSendAsEmail+'>';
            clMail.ToList.EmailAddresses := Email;
            clMail.BCCList.EmailAddresses := GetConfigString('CONFIRMATIONBCC','');
            If ApprovalCode  = '' then begin
               If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAIL/DECLINEDPAYMENTSUBJECT') <> '' then
                  clMail.Subject := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAIL/DECLINEDPAYMENTSUBJECT') + ' ' + FormatDateTime('MM/DD/YYYY', Date)
               else
                  clMail.Subject := 'Payment Failure Notification ' + FormatDateTime('MM/DD/YYYY', Date);
            end else begin
               If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAIL/APPROVEDPAYMENTSUBJECT') <> '' then
                  clMail.Subject := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAIL/APPROVEDPAYMENTSUBJECT') + ' ' + FormatDateTime('MM/DD/YYYY', Date)
               else
                  clMail.Subject := 'Payment Receipt ' + FormatDateTime('MM/DD/YYYY', Date);
            end;
            clMail.ReplyTo := GetConfigString('CONFIRMATIONREPLYTO','');
            if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAIL/SMTPSEVERIP','') <> '' then begin //2019-02-26 jtm: DVST-4796
               SMTP.Server := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAIL/SMTPSEVERIP','');
            end;
            ProcessLog(ltInfo, 'GUESTPOSTPAY SMTP.Server:', SMTP.Server);
            SMTP.Open();
            try
               SMTP.Send(clMail);
            finally
               SMTP.Close();
            end;
            exit;
         end else begin
            WS := '';
            if strtobool(OpenXMLGetTag('/CONFIGDATA/GUESTPAY/USEJSONRESP', 'FALSE')) then begin
               WS := '{ "tranrespmessage": "Customer not found", "transuccess": false }';
               response.ContentType := 'text/json';
            end else begin
               WS := '<head><title>Portal Home</title><meta http-equiv="refresh" content="0;URL=/PP"></head>';
            end;

            response.Content := WS;
            exit;
         end;
      end else begin
         WS := '';
         if strtobool(OpenXMLGetTag('/CONFIGDATA/GUESTPAY/USEJSONRESP', 'FALSE')) then begin
            WS := '{ "tranrespmessage": "Guest pay not allowed", "transuccess": false }';
            response.ContentType := 'text/json';
         end else begin
            WS := '<head><title>Portal Home</title><meta http-equiv="refresh" content="0;URL=/PP"></head>';
         end;

         response.Content := WS;
         exit;
      end;
   end;


   If PageName = 'USINGSITE' then begin
      WS := LoadWebFile('using_site.htm');
      response.Content := WS;
      exit;
   end;
   If PageName = 'FAQS' then begin
      WS := LoadWebFile('faqs.htm');
      response.Content := WS;
      exit;
   end;
   If PageName = 'CONDITIONS' then begin
      WS := LoadWebFile('conditions.htm');
      response.Content := WS;
      exit;
   end;
   If PageName = 'PRIVACY' then begin
      WS := LoadWebFile('privacy_notice.htm');
      response.Content := WS;
      exit;
   end;
   If PageName = 'EMAILPW' then begin
      WS := LoadWebFile('email_pw.htm');
      response.Content := WS;
      exit;
   end;

   If PageName = 'PROCESSEMAILPW' then begin
      Email := Request.ContentFields.Values['Email'];
      EMail := ValidCharsOnly(Email,True,True,'_.-#@+/');
      ReplaceString(Email,'--','-');

      If Email = '' then begin
         WS := LoadWebFile('default.htm');
         ReplaceString(WS, '%ERROR%', '<BR><B><font color="red">Invalid Email Address</font></B>');
         ReplaceString(WS, '%EMAIL%', '');
         response.Content :=WS;
         exit;
      end;

      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from Customers where (StoreCode = '+RNID + ') and (Email = ''' + email + ''')');
      RNQuery.Open;
      If RNQuery.RecordCount > 0 then begin
         RNQuery.Edit;
         RNQuery.FieldByName('ResetExpires').AsDateTime := NOW + EncodeTime(2,00,0,0);
         RNQuery.FieldByName('ResetGuid').AsString := GenerateGUID;
         RNQuery.Post;

         VarEvaluator.AddDSCurrentRecord(RNQuery, 'Customers');
         SendPWReset(RNQuery);
         WS := LoadWebFile('default.htm');
         ReplaceString(WS, '%ERROR%', '<BR><B><font color="red">Password Reset Sent</font></B>');
         ReplaceString(WS, '%EMAIL%', Email);

         response.Content :=WS;
      end else begin
         WS := LoadWebFile('default.htm');
         ReplaceString(WS, '%ERROR%', '<BR><B><font color="red">Email not on file ' + Email + '</font></B>');
         ReplaceString(WS, '%EMAIL%', Email);

         response.Content :=WS;
      end;
      exit;

   end;



   If PageName = 'GETLOCATIONS' then begin
      WS := AlphaOnly(Trim(UpCaseString(Request.queryfields.Values['STATE'])));

      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from Store where (ChainCode = '+Stri(ChainCode,-1) + ')');
      If (WS <> '') and (Length(WS) =2) then
         RNQuery.SQL.Add('And (STATE='''+WS + ''')');


      If GetConfigString('HIDECHAINRNIDS','') <> '' then begin
         RNQuery.SQL.Add('and (NOT systemcode in (' + GetConfigString('HIDECHAINRNIDS','')+'))');
      end;

      RNQuery.SQL.Add('order by Name');
      RNQuery.Open;

      If Request.queryfields.Values['FORMAT'] = 'HTML' then begin
         WS := '<select id="Locations" name="Locations" >';
         WS := WS + '<option Value="">Select Location</option>';
         While NOT RNQuery.EOF do begin
            if ShowStore(RNQuery.FieldByName('Siblings').AsString) then begin
               if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONFORMAT') = 'NAMEONLY') then begin   //2017-11-16 ajs: F#2282
                  WS := WS + '<option Value="' + Trim(RNQUERY.FieldByName('SystemCode').AsString) + '">' + Trim(RNQUERY.FieldByName('Name').AsString) + '</option>';
               end else begin
                  WS := WS + '<option Value="' + Trim(RNQUERY.FieldByName('SystemCode').AsString) + '">' +
                        Trim(RNQUERY.FieldByName('City').AsString) + ', ' +
                        Trim(RNQUERY.FieldByName('State').AsString)+ ', ';

                  If  GetConfigString('GETLOCATIONTYPE','CORP') = 'LOCATION' then
                     WS := WS + Trim(RNQUERY.FieldByName('Name').AsString)
                  else
                     WS := WS + DomainCompanyName;

                  If  GetConfigBoolean('GETLOCATIONSHOWUNITNUMBER',True) then
                     WS := WS + ' #' + Trim(RNQUERY.FieldByName('StoreID').AsString);

                  WS := WS + ' ' +Trim(RNQUERY.FieldByName('Address1').AsString) +
                  '</option>';
               end;
            end;
            RNQuery.Next;
         end;
         WS := WS + '</select>' + CRLF;


      end else begin
         WS := '<LOCATIONS>';
         While NOT RNQuery.EOF do begin
            if ShowStore(RNQuery.FieldByName('Siblings').AsString) then begin
               WS := WS + ' <LOCATION>' + CRLF;
               WS := WS + '  <RNID>' +Trim(RNQUERY.FieldByName('SystemCode').AsString) + '</RNID>' +  CRLF;
               WS := WS + '  <LOCATIONNAME>' +Trim(RNQUERY.FieldByName('Name').AsString) + '</LOCATIONNAME>' +  CRLF;
               WS := WS + '  <ADDRESS1>' +Trim(RNQUERY.FieldByName('ADDRESS1').AsString) + '</ADDRESS1>' +  CRLF;
               WS := WS + '  <ADDRESS2>' +Trim(RNQUERY.FieldByName('ADDRESS2').AsString) + '</ADDRESS2>' +  CRLF;
               WS := WS + '  <CITY>' +Trim(RNQUERY.FieldByName('CITY').AsString) + '</CITY>' +  CRLF;
               WS := WS + '  <STATE>' +Trim(RNQUERY.FieldByName('STATE').AsString) + '</STATE>' +  CRLF;
               WS := WS + '  <ZIP>' +Trim(RNQUERY.FieldByName('ZIP').AsString) + '</ZIP>' +  CRLF;
               WS := WS + ' </LOCATION>' + CRLF;
            end;
            RNQuery.Next;
         end;
         WS := WS + '</LOCATIONS>' + CRLF;
      end;

      Response.ContentType := 'text/xml';
      Response.Content := WS;

      Exit;
   end;


   If PageName = 'STORELOG' then begin
      WS := LoadWebFile('storelog.htm');

      if OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/AUTHENTICATIONTYPE') = 'AUTHKEY' then begin
          if (Request.queryfields.Values['AUTHKEY'] <> '') and (Request.queryfields.Values['RNID'] <> '') then begin
            ProcessLog(ltInfo,'Start AuthKey:','Authentication');
            if not ValidateAuthKey then
               ProcessLog(ltWarning,'Invalid AuthKey:', ValidCharsOnly(Request.queryfields.Values['AUTHKEY'], true,true,''));
          end;
      end;
      AdminRNID := NumericOnly(Request.queryfields.Values['RNID']);
      ReplaceString(WS, '%RNID%', AdminRNID);
      If (AdminRNID <> '') and (Not ValidateRNID(AdminRNID)) then begin
         Response.Content := 'INVALID RNID';
         exit;
      end;

      AdminRNID :='<H2>' + StoreName + '<BR>' + StoreAddress1 + '<BR>' + StoreCity + ' ' + StoreState + ' ' + StoreZIP + '<BR></H2>';

      ReplaceString(WS, '%STOREDATA%', AdminRNID);
      ReplaceString(WS,'%HOSTNAME%',UpCaseString(Request.Host));


      response.Content := WS;
      exit;
   end;

   If PageName = 'GETUNVALIDATEDACCOUNTS' then begin
      If CustomerMembType = 'ADMIN' then begin
         WS := '';
         RNQuery.Close;
         RNQuery.SQL.Clear;
         RNQuery.SQL.Add('select * from customers where storecode = '''+ RNID + ''' and CONFIRMGUID <> ''VALIDATED''');
         RNQUERY.Open;

         If RNQuery.RecordCount >0  then begin
            WS :='<TABLE class="paymenthist"><TR><Th><B>Name</B></Th><Th><B>EMail</B></Th><Th><B>Address</B></Th><Th><B>Date Added</B></Th><Th><B>Action</B></Th></TR>';

            While Not RNQuery.EOF do begin
                  WS := WS + '<tr><td>' + Trim(RNQuery.FieldByName('FirstName').AsString) + ' ' +Trim(RNQuery.FieldByName('LastName').AsString) + '</td>' +
                                 '<td>' + Trim(RNQuery.FieldByName('Email').AsString)+'</td>' +
                                 '<td>' + Trim(RNQuery.FieldByName('City').AsString)+ ', ' +
                                          Trim(RNQuery.FieldByName('State').AsString)+  ' ' +
                                          Trim(RNQuery.FieldByName('ZIP').AsString)+'</td>' +
                                 '<td>' +FormatDateTime('MM/DD/YYYY',RNQuery.FieldByName('StartDate').AsDateTime)+'</td>' +
                                 '<td>' +'<A HREF="javascript:ValidateUser(''' + Trim(RnQuery.FieldByName('CustomerCode').AsString)+''')">Validate</A></td>';
                  WS := WS + '</tr>';
               RNQuery.Next;
            end;
            WS := WS + '</TABLE>';
         end else begin
            WS := '<B>**No Unvalidated Customers On File**</B>' ;
         end;
      end else begin
         WS := '<B>**Invalid Credentials**</B>' ;
      end;
      Response.Content := WS;
      Exit;
   end;

   If PageName = 'GETLOCKEDACCOUNTS' then begin
      If CustomerMembType = 'ADMIN' then begin
         WS := '';
         RNQuery.Close;
         RNQuery.SQL.Clear;
         RNQuery.SQL.Add('select * from customers where storecode = '''+ RNID + ''' and (lockeduntil >''' + FormatDateTime('MM/DD/YYYY', Date) + ''')');
         RNQUERY.Open;

         If RNQuery.RecordCount >0  then begin
            WS :='<TABLE class="paymenthist"><TR><Th><B>Name</B></Th><Th><B>EMail</B></Th><Th><B>Address</B></Th><Th><B>Locked Until</B></Th><Th><B>Action</B></Th></TR>';

            While Not RNQuery.EOF do begin
                  WS := WS + '<tr><td>' + Trim(RNQuery.FieldByName('FirstName').AsString) + ' ' +Trim(RNQuery.FieldByName('LastName').AsString) + '</td>' +
                                 '<td>' + Trim(RNQuery.FieldByName('Email').AsString)+'</td>' +
                                 '<td>' + Trim(RNQuery.FieldByName('City').AsString)+ ', ' +
                                          Trim(RNQuery.FieldByName('State').AsString)+  ' ' +
                                          Trim(RNQuery.FieldByName('ZIP').AsString)+'</td>' +
                                 '<td>' +FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',RNQuery.FieldByName('LockedUntil').AsDateTime)+' EST</td>' +
                                 '<td>' +'<A HREF="javascript:UnlockUser(''' + Trim(RnQuery.FieldByName('CustomerCode').AsString)+''')">Unlock</A></td>';
                  WS := WS + '</tr>';
               RNQuery.Next;
            end;
            WS := WS + '</TABLE>';
         end else begin
            WS := '<B>**No Locked Customers On File**</B>' ;
         end;
      end else begin
         WS := '<B>**Invalid Credentials**</B>' ;
      end;
      Response.Content := WS;
      Exit;
   end;


   If PageName = 'VALIDATEUSER' then begin
      If CustomerMembType = 'ADMIN' then begin
         WS := '';
         RNQuery.Close;
         RNQuery.SQL.Clear;
         RNQuery.SQL.Add('Select * from Customers where (StoreCode = '+RNID + ') and (CustomerCode = ''' + ValidCharsOnly(Request.queryfields.Values['CUSTIDENT'],TRUE,True,'-') + ''')');
         RNQuery.Open;

         If RNQuery.RecordCount >0  then begin
            RNQuery.Edit;
            RNQuery.FieldByName('ConfirmGUID').AsString := 'VALIDATED';
            RNQuery.Post;
            WS := 'Customer ' + Trim(RNQuery.FieldByName('FirstName').AsString) + ' ' +Trim(RNQuery.FieldByName('LastName').AsString) + ' Validated';
         end else begin
            WS := '**Customer not on File**';
         end;
      end else begin
         WS := '<B>**Invalid Credentials**</B>' ;
      end;
      Response.Content := WS;
      Exit;
   end;

   If PageName = 'UNLOCKUSER' then begin
      ProcessLog(ltDebug, PageName, 'CustomerMembType = '+CustomerMembType+'. RNID = '+RNID+'. Request.Queryfields.CommaText = '+Request.Queryfields.CommaText); // 2019-6-26 ss DVST-5619: Helps during unit testing
      Response.Content := UnlockUserAjax(Request.Queryfields, RNQuery, CustomerMembType, RNID); // 2019-6-26 ss DVST-5619
      Exit;
   end;
   If PageName = 'LOCKUSER' then begin
      ProcessLog(ltDebug, PageName, 'CustomerMembType = '+CustomerMembType+'. RNID = '+RNID+'. Request.Queryfields.CommaText = '+Request.Queryfields.CommaText); // 2019-6-26 ss DVST-5619: Helps during unit testing
      Response.Content := LockUserAjax(Request.Queryfields, RNQuery, CustomerMembType, RNID); // 2019-6-26 ss DVST-5619
      Exit;
   end;

   If (PageName = 'GETCUSTOMERSCHEDULEEDITORAJAX') and (CustomerMembType = 'ADMIN') then begin
      WS2 := ValidCharsOnly(Request.queryfields.Values['CUSTGUID'],true,true,'-');
      PaySchedGUID := GUIDOnly(Request.queryfields.Values['PAYSCHEDGUID']);
      If LoadSchedGUIDToVars(PaySchedGUID,RNID,VarEvaluator) then begin
         if Request.queryfields.Values['HEADERONLY'] = 'TRUE' then begin
             WS := LoadWebFileFromFolder('editScheduledAdminHeader.htm','PPADMIN');
         end else begin
             WS := LoadWebFileFromFolder('editScheduledAdmin.htm','PPADMIN');
         end;
         ReplaceString(WS,'%CUSTGUID%',WS2);
         ReplaceString(WS,'%PAYSCHEDGUID%',PaySchedGUID);

         ReplaceString(WS,'%STATUS%',VarEvaluator.GetValueAsString('CustPaySched.STATUS'));

         ReplaceString(WS,'%TOTAL%',DisplayMoney(VarEvaluator.GetValueAsCurrency('CustPaySched.GrossAmount')));
         ReplaceString(WS,'%PAID%',DisplayMoney(VarEvaluator.GetValueAsCurrency('CustPaySched.AmountPaid')));
         ReplaceString(WS,'%BALANCE%',DisplayMoney(VarEvaluator.GetValueAsCurrency('CustPaySched.GrossAmount') -
                                                   VarEvaluator.GetValueAsCurrency('CustPaySched.AmountPaid')));
         ReplaceString(WS,'%EACHPAY%',DisplayMoney(VarEvaluator.GetValueAsCurrency('CustPaySched.PaymentAmount')));
         ReplaceString(WS,'%PAYMENTOPTIONS%', GeneratePaymentOptions(WS2, 'RECURRING',VarEvaluator.GetValueAsString('CustPaySched.PaymentGUID'), PaymentOptionsCount)); // 2019-4-17 SS DVST-4900: Refactored function
         ReplaceString(WS,'%NEXTPAYMENTDATE%',VarEvaluator.GetValueAsString('CustPaySched.NextPayment'));
         ReplaceString(WS,'%CREATEDDATE%',VarEvaluator.GetValueAsString('CustPaySched.ScheduleAdded'));
         ReplaceString(WS,'%FIRSTPAYMENT%',VarEvaluator.GetValueAsString('CustPaySched.FirstPayment'));
         ReplaceString(WS,'%LOCATIONOPTIONS%', GenerateAllLocationsOptions);

         response.Content := WS;
      end else begin
         response.Content := 'PAYSCHEDGUID NOT FOUND OR INVALID';
      end;
      Exit;
   end;
   If (PageName = 'SETPAYSCHEDPARAMS') and (CustomerMembType = 'ADMIN') then begin
      WS2 := ValidCharsOnly(Request.queryfields.Values['CUSTGUID'],true,true,'-');
      PaySchedGUID := GUIDOnly(Request.queryfields.Values['PAYSCHEDGUID']);
      If LoadSchedGUIDToVars(PaySchedGUID,RNID,VarEvaluator) then begin
         RNQuery.Close;
         RNQuery.SQL.Clear;
         RNQuery.SQL.Add('Select * from CustPaySched where (CustGUID = '''+WS2 + ''') and (PaySchedGUID = ''' + PaySchedGUID + ''')');
         RNQuery.Open;
         RNQuery.Edit;
         If Request.queryfields.Values['NEXTPAYMENT'] <> '' then begin
            Try
               RNQuery.FieldByName('NextPayment').AsString := Request.queryfields.Values['NEXTPAYMENT'];
            except
              on E:Exception do begin
              end;
            end;
         end;
         If Request.queryfields.Values['PAYMENTGUID'] <> '' then begin
            RNQuery.FieldByName('PAYMENTGUID').AsString := GUIDONLY(Request.queryfields.Values['PaymentGUID']);
         end;
         RNquery.Post;

         response.Content := 'Value Updated';
      end else begin
         response.Content := 'PAYSCHEDGUID NOT FOUND OR INVALID';
      end;
      Exit;
   end;

   If (PageName = 'GETCUSTOMERSUBACCOUNTEDITORAJAX') and (CustomerMembType = 'ADMIN') then begin
      if not PaymentPortalCustomerAuthenticate then exit;
      ParentGUID := GUIDOnly(Request.queryfields.Values['CUSTGUID']);
      ChildGUID := GUIDOnly(Request.queryfields.Values['CHILDGUID']);
      If ChildGUID <> '' then begin
         WS := LoadWebFileFromFolder('EditChildAjax.htm','PPADMIN');
         RNQuery.Close;
         RNQuery.SQL.Clear;
         RNQuery.SQL.Add('select distinct RNID,SystemCode, name,city, state, convert(varchar(max),siblings) as siblings,  firstname,lastname,accountnumber, ChildGUID from custchild');
         RNQuery.SQL.Add('left outer join store on systemcode = rnid');
         RNQuery.SQL.Add('where (CustGUID = '''+ParentGUID + ''') and (Hidden =0) and (ChildGUID = '''+ ChildGUID + ''')');
         RNQuery.SQL.Add('order by State, city,Name');
         RNQuery.Open;
         DSSubStrings(WS,'FIRSTNAME,LASTNAME,ACCOUNTNUMBER',RNQuery);
         ReplaceString(WS, '%SCHOOLOPTIONS%', GenerateSchoolOptions(RNQuery));
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/CHILDACCOUNTHIDERNIDS', 'FALSE') = 'TRUE') then begin //2017-11-16 ajs: F#2303
            ReplaceString(WS, '%LOCATIONOPTIONS%', GenerateAllSchoolOptions(False,true));
         end else begin
            ReplaceString(WS, '%LOCATIONOPTIONS%', GenerateAllLocationsOptions);
         end;
         ReplaceString(WS, '%LOCATIONSTATEOPTIONS%', GenerateAllLocationStateOptions);
         ReplaceString(WS, '%CHILDNAMEOPTIONS%', GenerateLocationsWithSelected);
         ReplaceString(WS, '%CHILDGUID%', ChildGUID);
         ReplaceString(WS,'%CUSTGUID%',ParentGUID);
      end else begin
         If ParentGUID <> '' then begin
            WS := LoadWebFileFromFolder('AddChildAjax.htm','PPADMIN');
            RNQuery.Close;
            RNQuery.SQL.Clear;
            RNQuery.SQL.Add('select distinct RNID,SystemCode, name,city, state, convert(varchar(max),siblings) as siblings,  firstname,lastname,accountnumber, ChildGUID from custchild');
            RNQuery.SQL.Add('left outer join store on systemcode = rnid');
            RNQuery.SQL.Add('where (CustGUID = '''+ParentGUID + ''') and (Hidden =0) ');
            RNQuery.SQL.Add('order by State, city,Name');
            RNQuery.Open;
            ReplaceString(WS, '%SCHOOLOPTIONS%', GenerateSchoolOptions(RNQuery));
            if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/CHILDACCOUNTHIDERNIDS', 'FALSE') = 'TRUE') then begin  //2017-11-16 ajs: F#2303
               ReplaceString(WS, '%LOCATIONOPTIONS%', GenerateAllSchoolOptions(false,true));
            end else begin
               ReplaceString(WS, '%LOCATIONOPTIONS%', GenerateAllLocationsOptions);
            end;
            ReplaceString(WS, '%LOCATIONSTATEOPTIONS%', GenerateAllLocationStateOptions);
            ReplaceString(WS, '%CHILDNAMEOPTIONS%', GenerateChildNameOptions(RNQuery, ChildCount)); // 2019-4-17 SS DVST-4900: Refactored Code

            ReplaceString(WS,'%CUSTGUID%',ParentGUID);
         end;
      end;
      Response.Content := WS;
      EXIT;
   end;

   If (PageName = 'GETCUSTOMERPAYMENTSCHEDULEEDITORAJAX') and (CustomerMembType = 'ADMIN') then begin
      if not PaymentPortalCustomerAuthenticate then exit;
      ParentGUID := GuidOnly(Request.queryfields.Values['CUSTGUID']);
      If ParentGUID = '' then exit;
      WS := LoadWebFileFromFolder('AddScheduledAdmin.htm', 'PPADMIN');

      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('select distinct RNID, SystemCode, name, city, state, convert(varchar(max), siblings) as siblings, firstname, lastname, accountnumber, ChildGUID from custchild');
      RNQuery.SQL.Add('left outer join store on systemcode = rnid');
      RNQuery.SQL.Add('where (CustGUID = ''' + ParentGUID + ''') and (Hidden = 0) ');
      RNQuery.SQL.Add('order by State, Name');
      RNQuery.Open;
      ReplaceString(WS, '%SCHOOLOPTIONS%', GenerateSchoolOptions(RNQuery));
      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/CHILDACCOUNTHIDERNIDS', 'FALSE') = 'TRUE') then begin //2017-11-16 ajs: F#2303
         ReplaceString(WS, '%LOCATIONOPTIONS%', GenerateAllSchoolOptions(False, true));
      end else begin
         ReplaceString(WS, '%LOCATIONOPTIONS%', GenerateAllLocationsOptions);
      end;
      ReplaceString(WS, '%LOCATIONSTATEOPTIONS%', GenerateAllLocationStateOptions);
      ReplaceString(WS, '%CHILDNAMEOPTIONS%', GenerateChildNameOptions(RNQuery, ChildCount)); // 2019-4-17 SS DVST-4900: Refactored function
      ReplaceString(WS, '%PAYMENTOPTIONS%', GeneratePaymentOptions(ParentGUID, 'RECURRING', '', PaymentOptionsCount)); // 2019-4-17 SS DVST-4900: Refactored function

      ReplaceString(WS,'%CUSTGUID%', ParentGUID);
      if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/DISPLAYBALANCEDUE','FALSE')) then begin
         if OpenCustomerQuery then begin
            ReplaceString(WS, '%BALANCEDUE%', Trim(Format('%m', [RNQuery.FieldByName('BALANCEDUE').AsFloat])));
         end;
      end;
      Response.Content := WS;
      exit;
   end;

   If (PageName = 'PROCESSOTPAJAX') and (CustomerMembType = 'ADMIN') then begin
      WS2 := ValidCharsOnly(Request.queryfields.Values['CUSTGUID'],true,true,'-');
      VarEvaluator.ClearAll;
      If ProcessPortalPayment(RNID,WS2, nil) then begin
         WS := '<CENTER><B>Payment Approved</B></CENTER><BR>' +
               '<CENTER><B>Approval Code:'+VarEvaluator.GetValueAsString('APPROVALCODE')+'</B></CENTER><BR>' +
               '<CENTER><B>Transaction Identifier:'+VarEvaluator.GetValueAsString('TRANIDENT')+'</B></CENTER><BR>' +
               '<a href="javascript:VTPrintAuthReceiptAJAX('+ VarEvaluator.GetValueAsString('PaymentLocationRNID')+ ',' +
               VarEvaluator.GetValueAsString('GWSC')+',''CARD'');" class="linkBtn">Print Receipt</a>';

      end else begin
         WS := '<BR><BR><CENTER><B>Sorry, this payment was not processed</B></CENTER><BR>' +
               '<CENTER><B>'+ VarEvaluator.GetValueAsString('PR')+'</B></CENTER><BR>';

      end;

      response.Content := WS;
      Exit;
   end;

   If (PageName = 'REMOVEPAYMENTAJAX') and (CustomerMembType = 'ADMIN') then begin
      WS := ValidCharsOnly(Request.queryfields.Values['CUSTGUID'],true,true,'-');
      WS2 := ValidCharsOnly(Request.queryfields.Values['PAYMENTGUID'],true,true,'-');
      ProcessLog(ltInfo,'RemovePayment',WS + ' ' + WS2);

      Response.Content := '';
      If (WS = '') or (WS2='') then exit;
      RemovePayment(WS,WS2);
      response.Content := GenerateCustomerPaymentsOnFileAdmin(WS);
      Exit;
   end;

   If (PageName = 'GETCUSTOMERSCHEDULEDPAYMENTSAJAX') and (CustomerMembType = 'ADMIN') then begin
      CustGUID :=     GuidOnly(Request.queryfields.Values['CUSTGUID']);
      WS := LoadWebFileFromFolder('CustScheduledPaymentsAjax.htm','PPADMIN');
      ReplaceString(WS,'%CUSTGUID%',CustGUID);
      response.Content := WS;
      Exit;
   end;

   If (PageName = 'GETSTORESCHEDULEDPAYMENTS') and (CustomerMembType = 'ADMIN') then begin
      GetStoreScheduledPayments(Response, Request.ContentFields, Request.QueryFields, RNID, ChainCode);
      Exit;
   end;

   If PageName = 'CUSTOMERSEARCH' then begin
      If CustomerMembType = 'ADMIN' then begin
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYCUSTOMERSASGRID', 'FALSE') = 'TRUE') then begin
            Response.ContentType := 'text/xml';
         end;
         Response.Content := CustomerSearch(Request.QueryFields, Request.ContentFields, GetAllowedRNIDs(true)); //2018-08-15 bls: 543
      end else begin
         Response.Content := '<B>**Invalid Credentials**</B>' ;
      end;
      Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'ACTIVATIONSEARCH') then begin      //2015-12-19 jtm
      ProcessLog(ltinfo,'ACTIVATIONSEARCH','Begin Activation Search');
      WS := '';
      UseTechID := false;
      ActPosStart := '0';   //2016-5-10 jtm
      ActCount := '100';
      ActSQLText := '';
      ActOrderBy := '';
      ActOrderDirect := '';

      DisplayFormat := Request.queryfields.Values['DISPLAYFORMAT'];
      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['ACTLOCATION']))) <> '' then begin
          RNID := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['ACTLOCATION'])));
      end;
      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['posStart']))) <> '' then begin    //2016-5-10 jtm
          ActPosStart := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['posStart'])));
      end;
      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['count']))) <> '' then begin
          ActCount := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['count'])));
      end;
      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['orderby']))) <> '' then begin
          ActOrderBy := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['orderby'])));
      end;
      if ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['direct'])),true,false,'') <> '' then begin
          ActOrderDirect := ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['direct'])),true,false,'');
      end;

      ProcessLog(ltinfo,'ACTIVATIONSEARCH','ActPosStart,ActCount,ActOrderBy,ActOrderDirect: '+ActPosStart +';'+ActCount +';'+ActOrderBy+';'+ActOrderDirect+';');
      ProcessLog(ltinfo,'ACTIVATIONSEARCH','DistrictCode,TechId,RNID,ComputerName: '+DistrictCode +';'+TechID +';'+RNID+';'+ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['COMPUTERNAME'])),true,true,' -.'));
      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/SEARCHRULE') = 'TRANIDENTPREFIX') and (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/SEARCHTYPE') = 'SEARS') then begin
         UseTechID := true;  //2016-5-10 jtm
      end;

      ActSQLText := 'SELECT *, ROW_NUMBER() OVER (ORDER BY ';    //2016-5-10 jtm
      ActColList := TStringList.Create;
      if UseTechID then
         ActColList.CommaText := 'DistrictCode,TechID,ActivationCode,ComputerName,ProductName,LastCheckin,CheckinUser,ActivatedDate'
      else
         ActColList.CommaText := 'ActivationCode,ComputerName,ProductName,LastCheckin,CheckinUser,ActivatedDate';

      if (ActOrderBy <> '') and not(StrToInt(ActOrderBy) >= ActColList.Count) then begin
         if (UseTechID) and (StrToInt(ActOrderBy) < 2) then begin
             ActSQLText := ActSQLText + 'CAST(ProfileXML as XML).value(''(/ACTIVATIONPROFILE/TRANIDENTPREFIX/node())[1]'', ''varchar(20)'')';
         end else begin
            ActSQLText := ActSQLText + ActColList[StrToInt(ActOrderBy)];
         end;
      end else begin
         ActSQLText := ActSQLText + 'ComputerName,ProductName';
      end;
      FreeAndNil(ActColList);
      if ActOrderDirect = 'DES' then ActSQLText := ActSQLText + ' desc';

      ActSQLText := ActSQLText + ',SystemCode) as row FROM ProductActivations';
      if Trim(UpCaseString(Request.queryfields.Values['ACTLOCATION'])) = 'ALL' then begin
         RNIDList := TStringList.Create;
         GetChainRNIDs(RNIDList);
         ActSQLText := ActSQLText + ' where RNID in (' + RNIDList.CommaText + ')';
         RNIDList.Free;
      end else begin
         ActSQLText := ActSQLText + ' where RNID = ' + RNID;
      end;

      if ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['COMPUTERNAME'])),true,true,' -.') <> '' then
          ActSQLText := ActSQLText + ' AND ComputerName like ''' + ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['COMPUTERNAME'])),true,true,' -.') + '%''';
      if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/SEARCHRULE') = 'TRANIDENTPREFIX' then begin
         if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/SEARCHTYPE') = 'SEARS' then begin
            DistrictCode := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['DISTRICTCODE'])));
            TechID := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['TECHID'])));
            UseTechID := true;
            if (DistrictCode <> '') and (TechID <> '') then begin
               ActSQLText := ActSQLText + ' and CAST(ProfileXML as XML).value(''(/ACTIVATIONPROFILE/TRANIDENTPREFIX/node())[1]'', ''varchar(20)'') =''' + DistrictCode + TechID + '''';
            end else if (DistrictCode <> '') and (TechID = '') then begin
               ActSQLText := ActSQLText + ' and CAST(ProfileXML as XML).value(''(/ACTIVATIONPROFILE/TRANIDENTPREFIX/node())[1]'', ''varchar(20)'') like''' + DistrictCode + '%''';
            end else if (TechID <> '') then begin
               ActSQLText := ActSQLText + ' and CAST(ProfileXML as XML).value(''(/ACTIVATIONPROFILE/TRANIDENTPREFIX/node())[1]'', ''varchar(20)'') like''%' + TechID + '''';
            end;
         end;
      end;
      if ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['ACTIVATED'])),true,false,'') <> '' then begin
          Activated := ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['ACTIVATED'])),true,false,'');
      end;
      if Activated = 'ALL' then begin
        ActSQLText := ActSQLText + ' and not (ActivatedDate is null and ExpirationDate < ''' + FormatDateTime('MM/DD/YYYY', now) + ''')';
      end else begin
         if Activated = 'TRUE' then begin
             ActSQLText := ActSQLText + ' and ActivatedDate is not null';
         end else if Activated = 'FALSE' then begin
             ActSQLText := ActSQLText + ' and ActivatedDate is null';
             ActSQLText := ActSQLText + ' and ExpirationDate >=''' + FormatDateTime('MM/DD/YYYY', now) + '''';
         end;
         if ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['ENABLED'])),true,false,'') <> '' then begin
             Enabled := ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['ENABLED'])),true,false,'');
         end;
         if Enabled = 'TRUE' then begin
            ActSQLText := ActSQLText + ' and Disabled = 0';
         end else if Enabled = 'FALSE' then begin
            ActSQLText := ActSQLText + ' and Disabled = 1';
         end;
      end;
      if StrToInt(ActPosStart) = 0 then begin
         HDQuery.Close;
         HDQuery.SQL.Clear;
         HDQuery.SQL.Text := ActSQLText;
         HDQuery.Open;
         ActTotalCount := IntToStr(HDQuery.RecordCount);
         SessionVarEval.AddValue('ActTotalCount', ActTotalCount);
         ProcessLog(ltinfo,'ACTIVATIONSEARCH','Query Opened; Total Record Count: '+ActTotalCount);
      end;
      HDQuery.Close;
      HDQuery.SQL.Clear;
      HDQuery.SQL.Add('SET ARITHABORT ON; Declare @StartPos as int; Declare @count as int; Set @StartPos = '+ ActPosStart +'; set @count = '+ ActCount +';');

      if Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/SEARCHTYPE','')) = 'SUNBELT' then begin // 2019-3-13 ss DVST-3445
         HDQuery.SQL.Add('SELECT *, c.ZIP as custZIP, c.STATE as custState FROM (' + ActSQLText);
      end else if ((StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/INCLUDERNID')))) OR (StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/INCLUDELOCATION'))))) then begin // 2019-4-17 ss DVST-3464
         HDQuery.SQL.Add('SELECT *, c.STORENAME as custStoreName, c.STOREID as custStoreID, c.CITY AS custCity, c.STATE AS custState, c.ZIP AS custZIP FROM (' + ActSQLText);
      end else begin
         HDQuery.SQL.Add('SELECT * FROM (' + ActSQLText);
      end;

      if DisplayFormat <> 'XLS' then begin
         if Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/SEARCHTYPE','')) = 'SUNBELT' then begin // 2019-3-13 ss DVST-3445
            HDQuery.SQL.Add(') a INNER JOIN CUSTOMERS c ON a.RNID = c.RETAILNETID where a.row > @StartPos and a.row <= (@StartPos +@count)');
         end else if ((StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/INCLUDERNID')))) OR (StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/INCLUDELOCATION'))))) then begin // 2019-4-17 ss DVST-3464
            HDQuery.SQL.Add(') a INNER JOIN CUSTOMERS c ON a.RNID = c.RETAILNETID where a.row > @StartPos and a.row <= (@StartPos +@count)');
         end else begin
            HDQuery.SQL.Add(') a where a.row > @StartPos and a.row <= (@StartPos +@count)');
         end;
      end else begin
         if Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/SEARCHTYPE','')) = 'SUNBELT' then begin // 2019-3-13 ss DVST-3445
            HDQuery.SQL.Add(') a INNER JOIN CUSTOMERS c On a.RNID = c.RETAILNETID');
         end else if ((StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/INCLUDERNID')))) OR (StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/INCLUDELOCATION'))))) then begin // 2019-4-17 ss DVST-3464
            HDQuery.SQL.Add(') a INNER JOIN CUSTOMERS c ON a.RNID = c.RETAILNETID where a.row > @StartPos and a.row <= (@StartPos +@count)');
         end else begin
            HDQuery.SQL.Add(') a');
         end;
      end;
      ProcessLog(ltinfo,'ACTIVATIONSEARCH','Query : '+HDQuery.SQL.text);
      HDQuery.Open;
      ProcessLog(ltinfo,'ACTIVATIONSEARCH','Query Opened; Partial Record Count: '+IntToStr(HDQuery.RecordCount));

      xExport := TOExport.Create;
      xlsExporter := TOExporterXLT.Create;
      xlsWorkSheet := xExport.AddWorkSheet;
      POSItemJSONResp := TStringList.Create;

      If HDQuery.RecordCount > 0 then begin
         WS :='<table id="ActTable" class="tablesorter"><thead><tr>';
         if UseTechID then begin
            WS := WS +'<th><B>District Code</B></th><th><B>Tech ID</B></th>';
         end;
         If DisplayFormat = 'XLS' then begin
            if ActTotalCount <> '' then begin
               Row := xlsWorkSheet.AddRow;

               if UseTechID then begin
                   Row.AddCellString('District Code');
                   Row.AddCellString('Tech ID');
               end;
               Row.AddCellString('Activation Code').SetCalculateColWidth;
               Row.AddCellString('Computer Name');
               Row.AddCellString('Product Name').SetCalculateColWidth;

               if Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/SEARCHTYPE','')) = 'SUNBELT' then begin // 2019-3-13 ss DVST-3445
                  Row.AddCellString('Device MAC').SetCalculateColWidth;
                  Row.AddCellString('Device IP').SetCalculateColWidth;
                  Row.AddCellString('RNID').SetCalculateColWidth;
                  Row.AddCellString('ZIP').SetCalculateColWidth;
                  Row.AddCellString('State').SetCalculateColWidth;
                  Row.AddCellString('Version Number').SetCalculateColWidth;
               end;

               Row.AddCellString('Last Checkin');
               Row.AddCellString('Checkin User').SetCalculateColWidth;
               Row.AddCellString('Activated Date');

               if(StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/INCLUDERNID')))) then begin // 2019-4-17 ss DVST-3464
                  Row.AddCellString('RNID').SetCalculateColWidth;
               end;
               if(StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/INCLUDELOCATION')))) then begin // 2019-4-17 ss DVST-3464
                  Row.AddCellString('Location').SetCalculateColWidth;
               end;

               Row.AddCellString('Activation Status').SetCalculateColWidth; // 2019-4-17 ss DVST-3464: Making this the last column. If any new columns will need to be added will do it before 'Activation Status'
               For iterator := 0 to Row.Cells.Count - 1 do
               begin
                  Row.Cells.Items[iterator].SetFontColor(clBlack).SetBorder(cbBottom).SetBGColor(TColor($80000000)).SetAlignment(cahCenter);
               end;
            end;
         end else if DisplayFormat = 'JSON' then begin
            if ActTotalCount <> '' then begin
                POSItemJSONResp.Append('[{"Num Lines":"' + ActTotalCount + '"},');
            end;
         end else if DisplayFormat = 'XML' then begin
            TabLine := '<?xml version="1.0" encoding="iso-8859-1"?><rows total_count='''+SessionVarEval.GetValueAsString('ActTotalCount')+''' pos= '''+ActPosStart+'''>';
            TabTextLines.Add(TabLine);
            TabLines := TabLine;
         end;
         if Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/SEARCHTYPE','')) = 'SUNBELT' then begin // 2019-3-13 ss DVST-3445
            WS := WS +'<th><B>Activation Code</B></th><th><B>Computer Name</B></th><th><B>Product Name</B></th>';
            WS := WS +'<th><B>Device MAC</B></th><th><B>Device IP</B></th><th><B>RNID</B></th><th><B>ZIP</B></th><th><B>State</B></th><th><B>Version Number</B></th>';
            WS := WS + '<th><B>Last Checkin</B></th><th><B>Checkin User</B></th><th><B>Activated Date</B></th>'; // 2019-4-17 ss DVST-3464: removed <th><B>Actions</B></th></tr></thead><tbody>, so that we can better control adding new <th> at the end
         end else begin
            WS := WS +'<th><B>Activation Code</B></th><th><B>Computer Name</B></th><th><B>Product Name</B></th><th><B>Last Checkin</B></th><th><B>Checkin User</B></th><th><B>Activated Date</B></th>'; // 2019-4-17 ss DVST-3464: made this generic
         end;
         if(StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/INCLUDERNID')))) then begin // 2019-4-17 ss DVST-3464
            WS := WS + '<th><B>RNID</B></th>';
         end;
         if(StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/INCLUDELOCATION')))) then begin // 2019-4-17 ss DVST-3464
            WS := WS + '<th><B>Location</B></th>';
         end;
         WS := WS + '<th><B>Actions</B></th></tr></thead><tbody>'; // 2019-4-17 ss DVST-3464: this will always be added at the end

         iter := 1;
         TabLine := '';
         While Not HDQuery.EOF do begin
            if UseTechID then begin
               DistrictCode := '';
               TechID := '';
               DistrictCode := GetXMLTagStr(HDQuery.FieldByName('ProfileXML').AsString,'TRANIDENTPREFIX');
               if DistrictCode <> '' then begin
                  TechID := Copy(DistrictCode, 5,length(DistrictCode));
                  DistrictCode := Copy(DistrictCode,1,4);
               end;
            end;
            if(StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/INCLUDELOCATION')))) then begin // 2019-4-17 ss DVST-3464: get the location name once at the begining and use it later wherever needed
               LocationName := '';
               If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONNAMEFORMAT') = 'NAMEONLY' then begin
                  LocationName := Trim(HDQuery.FieldByName('custStoreName').AsString);
               end else if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONNAMEFORMAT') = 'UNITCITYSTATE' then begin
                  LocationName := Trim(HDQuery.FieldByName('custStoreID').AsString) + ', '+ Trim(HDQuery.FieldByName('custCity').AsString)+', '+ Trim(HDQuery.FieldByName('custState').AsString);
               end else begin
                  LocationName := Trim(HDQuery.FieldByName('custState').AsString) + '-' +Trim(HDQuery.FieldByName('custStoreName').AsString);
               end;
            end;
            If (DisplayFormat <> 'XLS') and (DisplayFormat <> 'XML') and (DisplayFormat <> 'JSON') then begin
               If HDQuery.FieldByName('Disabled').AsBoolean then begin
                  WS := WS + '<tr class="disabled">';
               end else if (HDQuery.FieldByName('ActivatedDate').AsString = '') and (HDQuery.FieldByName('ExpirationDate').AsDateTime >= now) then begin
                  WS := WS + '<tr class="pending">';
               end else begin
                 WS := WS + '<tr class="enabled">';
               end;
               if UseTechID then begin
                  WS := WS + '<td>' + DistrictCode +'</td><td>' + TechID +'</td>';
               end;
               WS := WS + '<td><a href="javascript:GetActivationEditLog(''' + Trim(HDQuery.FieldByName('SystemCode').AsString)+''','''+Trim(HDQuery.FieldByName('RNID').AsString)+''')">'+Trim(HDQuery.FieldByName('ActivationCode').AsString)+'</a></td>' +
                              '<td>'+Trim(HDQuery.FieldByName('ComputerName').AsString)+'</td>' +
                              '<td>' + Trim(HDQuery.FieldByName('ProductName').AsString)+'</td>';

                               if Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/SEARCHTYPE','')) = 'SUNBELT' then begin // 2019-3-13 ss DVST-3445
                                 WS := WS + '<td>'+GetXMLTargetNodeValueByXPath(Trim(HDQuery.FieldByName('Devices').AsString),'/DEVICEINFO/DEVICE/MAC')+'</td>';
                                 WS := WS + '<td>'+Trim(HDQuery.FieldByName('CheckInIP').AsString)+'</td>';
                                 WS := WS + '<td>'+Trim(HDQuery.FieldByName('RNID').AsString)+'</td>';
                                 WS := WS + '<td>'+Trim(HDQuery.FieldByName('custZIP').AsString)+'</td>';
                                 WS := WS + '<td>'+Trim(HDQuery.FieldByName('custState').AsString)+'</td>';
                                 WS := WS + '<td>'+Trim(HDQuery.FieldByName('CheckinVersion').AsString)+'</td>';
                               end;

                              if HDQuery.FieldByName('LastCheckin').AsString <> '' then begin
                                 WS := WS +  '<td>' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',HDQuery.FieldByName('LastCheckin').AsDateTime)+' EST</td>';
                              end else begin
                                 WS := WS + '<td></td>';
                              end;
                              WS := WS + '<td>' + Trim(HDQuery.FieldByName('CheckinUser').AsString)+ '</td>';
                              if HDQuery.FieldByName('ActivatedDate').AsString <> '' then begin
                                 WS := WS +  '<td>' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',HDQuery.FieldByName('ActivatedDate').AsDateTime)+' EST</td>';
                              end else begin
                                 WS := WS + '<td></td>';
                              end;

                              if(StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/INCLUDERNID')))) then begin // 2019-4-17 ss DVST-3464
                                 WS := WS + '<td>'+Trim(HDQuery.FieldByName('RNID').AsString)+'</td>';
                              end;
                              if(StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/INCLUDELOCATION')))) then begin // 2019-4-17 ss DVST-3464
                                 WS := WS + '<td>'+LocationName+'</td>';
                              end;

                              WS := WS + '<td>'; // 2019-4-17 ss DVST-3464: Any new column will be added before the 'Actions' column, like RNID and Location is added above.
                              if UseTechID then begin
                                 ws := WS + '<a href="javascript:EditActivation(''' + Trim(HDQuery.FieldByName('SystemCode').AsString)+''','''+Trim(HDQuery.FieldByName('RNID').AsString)+''')">Edit</a>';
                              end;
                              If HDQuery.FieldByName('Disabled').AsBoolean then begin
                                 ws := WS + ' <a href="javascript:EnableActivation(''' + Trim(HDQuery.FieldByName('SystemCode').AsString)+''','''+Trim(HDQuery.FieldByName('RNID').AsString)+''')">Enable</a>';
                              end else begin
                                 ws := WS + ' <a href="javascript:DisableActivation(''' + Trim(HDQuery.FieldByName('SystemCode').AsString)+''','''+Trim(HDQuery.FieldByName('RNID').AsString)+''')">Disable</a>';
                              end;
                              ws := WS + ' <a href="javascript:ReActivate(''' + Trim(HDQuery.FieldByName('SystemCode').AsString)+''','''+Trim(HDQuery.FieldByName('RNID').AsString)+''')">Re-Activate</a>';
               WS := WS + '</td></tr>';
               ProcessLog(ltInfo, 'ACTIVATIONSEARCH', 'Table: '+WS);// 2019-4-17 ss DVST-3464
            end else If DisplayFormat = 'XLS' then begin
               Row := xlsWorkSheet.AddRow;
               if UseTechID then begin
                   Row.AddCellString(DistrictCode);
                   Row.AddCellString(TechID);
               end;
               Row.AddCellString(Trim(HDQuery.FieldByName('ActivationCode').AsString));
               Row.AddCellString(Trim(HDQuery.FieldByName('ComputerName').AsString)).SetCalculateColWidth;
               Row.AddCellString(Trim(HDQuery.FieldByName('ProductName').AsString));

                if Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/SEARCHTYPE','')) = 'SUNBELT' then begin // 2019-3-13 ss DVST-3445
                  Row.AddCellString(GetXMLTargetNodeValueByXPath(Trim(HDQuery.FieldByName('Devices').AsString),'/DEVICEINFO/DEVICE/MAC')).SetCalculateColWidth;
                  Row.AddCellString(Trim(HDQuery.FieldByName('CheckInIP').AsString)).SetCalculateColWidth;
                  Row.AddCellString(Trim(HDQuery.FieldByName('RNID').AsString)).SetCalculateColWidth;
                  Row.AddCellString(Trim(HDQuery.FieldByName('custZIP').AsString)).SetCalculateColWidth;
                  Row.AddCellString(Trim(HDQuery.FieldByName('custState').AsString)).SetCalculateColWidth;
                  Row.AddCellString(Trim(HDQuery.FieldByName('CheckinVersion').AsString)).SetCalculateColWidth;
                end;

               if HDQuery.FieldByName('LastCheckin').AsString <> '' then begin
                  Row.AddCellDateTime(HDQuery.FieldByName('LastCheckin').AsDateTime).SetCalculateColWidth;
               end else begin
                   Row.AddCellString('');
               end;
               Row.AddCellString(Trim(HDQuery.FieldByName('CheckinUser').AsString));

               if HDQuery.FieldByName('ActivatedDate').AsString <> '' then begin
                  Row.AddCellDateTime(HDQuery.FieldByName('ActivatedDate').AsDateTime).SetCalculateColWidth;
               end else begin
                  Row.AddCellString('');
               end;

               if(StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/INCLUDERNID')))) then begin // 2019-4-17 ss DVST-3464
                  Row.AddCellString(Trim(HDQuery.FieldByName('RNID').AsString)).SetCalculateColWidth;
               end;
               if(StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/INCLUDELOCATION')))) then begin // 2019-4-17 ss DVST-3464
                  Row.AddCellString(LocationName).SetCalculateColWidth;
               end;

               If HDQuery.FieldByName('Disabled').AsBoolean then begin
                  Row.AddCellString('Disabled');
               end else if (HDQuery.FieldByName('ActivatedDate').AsString = '') and (HDQuery.FieldByName('ExpirationDate').AsDateTime >= now) then begin
                  Row.AddCellString('Pending');
               end else begin
                 Row.AddCellString('Enabled');
               end;

            end else if DisplayFormat = 'JSON' then begin
               if UseTechID then begin
                   POSItemJSONResp.Append('{"District Code":"' + DistrictCode + '",');
                   POSItemJSONResp.Append('"Tech ID":"' + TechID + '",');
               end else begin
                   POSItemJSONResp.Append('{"District Code":"",');
                   POSItemJSONResp.Append('"Tech ID":"",');
               end;
               POSItemJSONResp.Append('"Activation Code":"' + Trim(HDQuery.FieldByName('ActivationCode').AsString) + '",');
               POSItemJSONResp.Append('"Computer Name":"' + Trim(HDQuery.FieldByName('ComputerName').AsString) + '",');
               POSItemJSONResp.Append('"Product Name":"' + Trim(HDQuery.FieldByName('ProductName').AsString) + '",');

               if Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/SEARCHTYPE','')) = 'SUNBELT' then begin // 2019-3-13 ss DVST-3445
                  POSItemJSONResp.Append('"Device MAC":"' + GetXMLTargetNodeValueByXPath(Trim(HDQuery.FieldByName('Devices').AsString),'/DEVICEINFO/DEVICE/MAC') + '",');
                  POSItemJSONResp.Append('"Device IP":"' + Trim(HDQuery.FieldByName('CheckInIP').AsString) + '",');
                  POSItemJSONResp.Append('"RNID":"' + Trim(HDQuery.FieldByName('RNID').AsString) + '",');
                  POSItemJSONResp.Append('"ZIP":"' + Trim(HDQuery.FieldByName('custZIP').AsString) + '",');
                  POSItemJSONResp.Append('"State":"' + Trim(HDQuery.FieldByName('custState').AsString) + '",');
                  POSItemJSONResp.Append('"Version Number":"' + Trim(HDQuery.FieldByName('CheckinVersion').AsString) + '",');
               end;

               if HDQuery.FieldByName('LastCheckin').AsString <> '' then begin
                  POSItemJSONResp.Append('"Last Check-in":"' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',HDQuery.FieldByName('LastCheckin').AsDateTime) + '",');
               end else begin
                   POSItemJSONResp.Append('"Last Check-in":"",');
               end;
               POSItemJSONResp.Append('"Check-in User":"' + Trim(HDQuery.FieldByName('CheckinUser').AsString) + '",');

               if HDQuery.FieldByName('ActivatedDate').AsString <> '' then begin
                  POSItemJSONResp.Append('"Activated Date":"' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',HDQuery.FieldByName('ActivatedDate').AsDateTime) + '",');
               end else begin
                  POSItemJSONResp.Append('"Activated Date":"",');
               end;

               if(StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/INCLUDERNID')))) then begin // 2019-4-17 ss DVST-3464
                  POSItemJSONResp.Append('"RNID":"' + Trim(HDQuery.FieldByName('RNID').AsString) + '",');
               end;
               if(StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/INCLUDELOCATION')))) then begin // 2019-4-17 ss DVST-3464
                  POSItemJSONResp.Append('"Location":"' + LocationName + '",');
               end;

               If HDQuery.FieldByName('Disabled').AsBoolean then begin
                  POSItemJSONResp.Append('"Activation Status":"Disabled"},');
               end else if (HDQuery.FieldByName('ActivatedDate').AsString = '') and (HDQuery.FieldByName('ExpirationDate').AsDateTime >= now) then begin
                  POSItemJSONResp.Append('"Activation Status":"Pending"},');
               end else begin
                 POSItemJSONResp.Append('"Activation Status":"Enabled"},');
               end;

            end else if DisplayFormat = 'XML' then begin
               If HDQuery.FieldByName('Disabled').AsBoolean then begin
                  TabLine := '<row class="disabled" id="'+ HDQuery.FieldByName('row').AsString +'">';
               end else if (HDQuery.FieldByName('ActivatedDate').AsString = '') and (HDQuery.FieldByName('ExpirationDate').AsDateTime >= now) then begin
                  TabLine := '<row class="pending" id="'+ HDQuery.FieldByName('row').AsString  +'">';
               end else begin
                 TabLine := '<row class="enabled" id="'+ HDQuery.FieldByName('row').AsString  +'">';
               end;
               if UseTechID then begin
                  TabLine := TabLine + '<cell>' + DistrictCode +'</cell><cell>' + TechID +'</cell>';
               end;
               TabLine := TabLine + '<cell><![CDATA[<a href="javascript:GetActivationEditLog(''' + Trim(HDQuery.FieldByName('SystemCode').AsString)+''','''+Trim(HDQuery.FieldByName('RNID').AsString)+''')">'+Trim(HDQuery.FieldByName('ActivationCode').AsString)+'</a>]]></cell>' +
                              '<cell>'+Trim(HDQuery.FieldByName('ComputerName').AsString)+'</cell>' +
                              '<cell>' + Trim(HDQuery.FieldByName('ProductName').AsString)+'</cell>';

              if Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/SEARCHTYPE','')) = 'SUNBELT' then begin // 2019-3-13 ss DVST-3445
               TabLine := TabLine + '<cell>'+GetXMLTargetNodeValueByXPath(Trim(HDQuery.FieldByName('Devices').AsString),'/DEVICEINFO/DEVICE/MAC')+'</cell>';
               TabLine := TabLine + '<cell>'+Trim(HDQuery.FieldByName('CheckInIP').AsString)+'</cell>';
               TabLine := TabLine + '<cell>'+Trim(HDQuery.FieldByName('RNID').AsString)+'</cell>';
               TabLine := TabLine + '<cell>'+Trim(HDQuery.FieldByName('custZIP').AsString)+'</cell>';
               TabLine := TabLine + '<cell>'+Trim(HDQuery.FieldByName('custState').AsString)+'</cell>';
               TabLine := TabLine + '<cell>'+Trim(HDQuery.FieldByName('CheckinVersion').AsString)+'</cell>';
              end;

               if HDQuery.FieldByName('LastCheckin').AsString <> '' then begin
                     TabLine := TabLine +  '<cell>' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',HDQuery.FieldByName('LastCheckin').AsDateTime)+' EST</cell>';
               end else begin
                  TabLine := TabLine + '<cell></cell>';
               end;
               TabLine := TabLine + '<cell>' + Trim(HDQuery.FieldByName('CheckinUser').AsString)+ '</cell>';
               if HDQuery.FieldByName('ActivatedDate').AsString <> '' then begin
                  TabLine := TabLine +  '<cell>' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',HDQuery.FieldByName('ActivatedDate').AsDateTime)+' EST</cell>';
               end else begin
                  TabLine := TabLine + '<cell></cell>';
               end;
               if(StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/INCLUDERNID')))) then begin // 2019-4-17 ss DVST-3464
                  TabLine := TabLine + '<cell>'+Trim(HDQuery.FieldByName('RNID').AsString)+'</cell>';
               end;
               if(StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/INCLUDELOCATION')))) then begin // 2019-4-17 ss DVST-3464
                  TabLine := TabLine + '<cell>'+ToUTF(LocationName)+'</cell>'; // 2015-5-15 SS DVST-5813
               end;
               
               TabLine := TabLine + '<cell><![CDATA[';
               if UseTechID then begin
                  TabLine := TabLine + '<a href="javascript:EditActivation(''' + Trim(HDQuery.FieldByName('SystemCode').AsString)+''','''+Trim(HDQuery.FieldByName('RNID').AsString)+''')">Edit</a>';
               end;
               If HDQuery.FieldByName('Disabled').AsBoolean then begin
                  TabLine := TabLine + ' <a href="javascript:EnableActivation(''' + Trim(HDQuery.FieldByName('SystemCode').AsString)+''','''+Trim(HDQuery.FieldByName('RNID').AsString)+''')">Enable</a>';
               end else begin
                  TabLine := TabLine + ' <a href="javascript:DisableActivation(''' + Trim(HDQuery.FieldByName('SystemCode').AsString)+''','''+Trim(HDQuery.FieldByName('RNID').AsString)+''')">Disable</a>';
               end;
               TabLine := TabLine + ' <a href="javascript:ReActivate(''' + Trim(HDQuery.FieldByName('SystemCode').AsString)+''','''+Trim(HDQuery.FieldByName('RNID').AsString)+''')">Re-Activate</a>';
               TabLine := TabLine + ']]></cell></row>';
               TabLines := TabLines + TabLine;
            end;

            iter := iter + 1;
            HDQuery.Next;
         end;
         WS := WS + '</tbody></table>';
      end else begin
          WS := '<B>**No Activations Found**</B><br>';
          TabLines := '<?xml version="1.0" encoding="iso-8859-1"?><rows total_count="0" pos="0">'; //2016-5-10 jtm
      end;
      WS := WS + '<br><a href="javascript:GetAddNewActivation()" class="linkBtn AddActivation">Add New Activation</A>';
      ProcessLog(ltinfo,'ACTIVATIONSEARCH','End');

      If displayformat = 'XLS' then begin          //2016-1-12 jtm
         xlsFileName := 'attachment; filename=Activations-' + FormatDateTime('YYYYMMDDHHNNSS',now) + '.xls';//changed for 1.1.64.2
         Response.CustomHeaders.Values['Content-Disposition'] := xlsFileName;
         xlsStream := TMemoryStream.Create();

         xExport.SaveToStream(xlsStream, xlsExporter);
         xlsStream.Position := 0;

         Response.ContentStream := xlsStream;
         Response.ContentType := 'application/vnd.ms-excel';

         Response.CustomHeaders.Values['Cache-Control'] := 'private';
         Response.CustomHeaders.Values['Pragma'] := 'private';
         Exit;

      end else if DisplayFormat = 'JSON' then begin
         Response.ContentType := 'application/json';
         jsonText := stringreplace(POSItemJSONResp.Text, #13,'',[rfReplaceAll]); // Sets JSONString equal to all of the text in the JSON String list; Replaces all Carriage Return characters with nothing
         jsonText := stringreplace(jsonText, #10,'',[rfReplaceAll]); // Replaces all Line Feed characters with nothing
         delete(jsonText,length(jsonText),1); // Deletes the trailing comma in the JSONString

         Response.Content := jsonText + ']'; // Sends the complete JSONString back with a closing square bracket
         Response.CustomHeaders.Values['Cache-Control'] := 'private';
         Response.CustomHeaders.Values['Pragma'] := 'private';

         FreeAndNil(POSItemJSONResp);
         Exit;
         
      end else if DisplayFormat = 'XML' then begin
         Response.Content := TabLines + '</rows>';
         Response.ContentType := 'text/xml';
         Response.CustomHeaders.Values['Cache-Control'] := 'private';
         Response.CustomHeaders.Values['Pragma'] := 'private';
         Exit;
      end;
      Response.Content := WS;
      exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'REACTIVATE') then begin  //2015-12-19 jtm
      ProcessLog(ltinfo,'REACTIVATE','Begin Re-Activate');
      WS := '';
      if NumericOnly(Trim(Request.queryfields.Values['ACTIVATIONSC'])) <> '' then begin
         if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['ACTLOCATION']))) <> '' then begin  //2016-1-12 jtm
             RNID := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['ACTLOCATION'])));
         end;
         ProcessLog(ltinfo,'REACTIVATE','ActivationSC: ' + NumericOnly(Trim(Request.queryfields.Values['ACTIVATIONSC'])));
         HDQuery.Close;
         HDQuery.SQL.Clear;
         HDQuery.SQL.Add('SET ARITHABORT ON; Select * from ProductActivations where RNID = ' + RNID);
         HDQuery.SQL.Add('AND SystemCode = ''' + NumericOnly(Trim(Request.queryfields.Values['ACTIVATIONSC'])) + '''');
         HDQuery.Open;

         If HDQuery.RecordCount = 1  then begin
            HDQuery.Edit;
            HDQuery.FieldByName('Disabled').AsBoolean := False;
            HDQuery.FieldByName('ExpirationDate').AsDateTime := Date()+60; // 2019-6-26 ss DVST-3764: distinguish function
            HDQuery.FieldByName('ActivatedDate').Clear;

            ProcessLog(ltDebug, PageName, 'HDQuery.SQL.Text = '+HDQuery.SQL.Text);
            AddProductionActivationChangeLog('HelpDesk', HDQuery, GetUserNameByRNSessionID(RNDB.ConnectionString, RNSessionID), GetRemoteAddress(), HDDB.ConnectionString); // 2019-6-26 ss DVST-3764: need to do this before Post
            HDQuery.Post;

            WS := 'Activation Code ' + Trim(HDQuery.FieldByName('ActivationCode').AsString) +  ' Re-Activated! You can search for it by selecting the Pending radio button on the activation search form.'; // 2019-6-26 ss DVST-3764: making it the same as what we did for DVST-3437
         end else begin
            ProcessLog(ltWarning,'REACTIVATE','No Activation found');
            WS := '**Activation not on File**' ;
         end;
       end else begin
         ProcessLog(ltWarning,'REACTIVATE','No Activation code provided');
         WS := '**No Activation Provided**' ;
       end;
       ProcessLog(ltinfo,'REACTIVATE','End Re-Activate');
       Response.Content := WS;
       Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'ENABLEACT') then begin      //2015-12-19 jtm
      ProcessLog(ltinfo,'ENABLEACT','Begin Enable Activation');
      WS := '';
      if NumericOnly(Trim(Request.queryfields.Values['ACTIVATIONSC'])) <> '' then begin
         if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['ACTLOCATION']))) <> '' then begin  //2016-1-12 jtm
             RNID := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['ACTLOCATION'])));
         end;
         ProcessLog(ltinfo,'ENABLEACT','ActivationSC: ' + NumericOnly(Trim(Request.queryfields.Values['ACTIVATIONSC'])));
         HDQuery.Close;
         HDQuery.SQL.Clear;
         HDQuery.SQL.Add('SET ARITHABORT ON; Select * from ProductActivations where RNID = ' + RNID);
         HDQuery.SQL.Add('AND SystemCode = ''' + NumericOnly(Trim(Request.queryfields.Values['ACTIVATIONSC'])) + '''');
         HDQuery.Open;

         If HDQuery.RecordCount = 1  then begin
            HDQuery.Edit;
            HDQuery.FieldByName('Disabled').AsBoolean := False;

            ProcessLog(ltDebug, PageName, 'HDQuery.SQL.Text = '+HDQuery.SQL.Text); // 2019-6-26 ss DVST-3764: need to do this before post
            AddProductionActivationChangeLog('HelpDesk', HDQuery, GetUserNameByRNSessionID(RNDB.ConnectionString, RNSessionID), GetRemoteAddress(), HDDB.ConnectionString); // 2019-6-26 ss DVST-3764: need to do this before Post
            HDQuery.Post;

            WS := 'Activation Code ' + Trim(HDQuery.FieldByName('ActivationCode').AsString) +  ' Enabled';
         end else begin
            ProcessLog(ltWarning,'ENABLEACT','No Activation found');
            WS := '**Activation not on File**' ;
         end;
       end else begin
         ProcessLog(ltWarning,'ENABLEACT','No Activation code provided');
         WS := '**No Activation Provided**' ;
       end;
       ProcessLog(ltinfo,'ENABLEACT','End Enable Activation');
       Response.Content := WS;
       Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'DISABLEACT') then begin     //2015-12-19 jtm
      ProcessLog(ltinfo,'DISABLEACT','Begin Disable Activation');
      WS := '';
      if NumericOnly(Trim(Request.queryfields.Values['ACTIVATIONSC'])) <> '' then begin
         if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['ACTLOCATION']))) <> '' then begin     //2016-1-12 jtm
             RNID := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['ACTLOCATION'])));
         end;
         ProcessLog(ltinfo,'DISABLEACT','ActivationSC: ' + NumericOnly(Trim(Request.queryfields.Values['ACTIVATIONSC'])));
         HDQuery.Close;
         HDQuery.SQL.Clear;
         HDQuery.SQL.Add('SET ARITHABORT ON; Select * from ProductActivations where RNID = ' + RNID);
         HDQuery.SQL.Add('AND SystemCode = '''+ NumericOnly(Trim(Request.queryfields.Values['ACTIVATIONSC']))+'''');
         HDQuery.Open;

         If HDQuery.RecordCount = 1  then begin
            HDQuery.Edit;
            HDQuery.FieldByName('Disabled').AsBoolean := True;
            HDQuery.FieldByName('DisabledDate').AsDateTime := Now;

            ProcessLog(ltDebug, PageName, 'HDQuery.SQL.Text = '+HDQuery.SQL.Text); // 2019-6-26 ss DVST-3764: need to do this before post
            AddProductionActivationChangeLog('HelpDesk', HDQuery, GetUserNameByRNSessionID(RNDB.ConnectionString, RNSessionID), GetRemoteAddress(), HDDB.ConnectionString); // 2019-6-26 ss DVST-3764: need to do this before Post
            HDQuery.Post;
            WS := 'Activation Code ' + Trim(HDQuery.FieldByName('ActivationCode').AsString) +  ' Disabled';
         end else begin
            ProcessLog(ltWarning,'DISABLEACT','No Activation found');
            WS := '**Activation not on File**' ;
         end;
       end else begin
         ProcessLog(ltWarning,'DISABLEACT','No Activation code provided');
         WS := '**No Activation Provided**' ;
       end;
       ProcessLog(ltinfo,'DISABLEACT','End Disable Activation');
       Response.Content := WS;
       Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'GETACTIVATIONEDITLOG') then begin     //2015-12-19 jtm
      ProcessLog(ltinfo,'GETACTIVATIONEDITLOG','Begin GetActivationEditLog');
      WS := '';

      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['ACTIVATIONSC']))) <> '' then begin
          ActivationSC := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['ACTIVATIONSC'])));
      end;
      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['ACTLOCATION']))) <> '' then begin   //2016-1-12 jtm
          RNID := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['ACTLOCATION'])));
      end;
      ProcessLog(ltinfo,'GETACTIVATIONEDITLOG','ActivationSC: '+ActivationSC +';');
      HDQuery.Close;
      HDQuery.SQL.Clear;
      HDQuery.SQL.Add('Select * from ProductActivationChangeLog where ActivationSC = ' + ActivationSC);
      HDQuery.SQL.Add(' And RNID = ' + RNID);


      HDQuery.SQL.Add('order by DateChanged desc');
      HDQuery.Open;
      ProcessLog(ltinfo,'GETACTIVATIONEDITLOG','Query Opened; Record Count: '+IntToStr(HDQuery.RecordCount));
      If HDQuery.RecordCount > 0 then begin

         WS :='<h4 class="formHeader">Activation Change Log</h4><table id="EditLogActTable" class="tablesorter"><thead><tr>';

         WS := WS +'<th><B>Computer Name</B></th><th><B>Product Name</B></th><th><B>Date Changed</B></th><th><B>Field Changed</B></th><th><B>Old Value</B></th><th><B>New Value</B></th><th><B>Change Made By</B></th></tr></thead><tbody>';
         While Not HDQuery.EOF do begin
            Try
               ChangeXML := TOpenXML.CreateFromString(Nil,FromUTF(HDQuery.FieldByName('ChangeMade').AsString));
            except
               On E:Exception do begin
                  ProcessLog(ltWarning,'GETACTIVATIONEDITLOG','OpenXMLLoad Exception processing XML: ' + E.Message);
                  If Assigned(ChangeXML) then FreeAndNil(ChangeXML);
               end;
            end;
            If Assigned(ChangeXML) then begin
               ChangeXMLNode := ChangeXML.GetNode('/CHGLOG');
               ChangeXMLNode := ChangeXMLNode.FindFirstChildElement;
               while (ChangeXMLNode <> nil) do begin
                  if Trim(ChangeXML.GetContextValueAsWideString(ChangeXMLNode, 'FLDTYPE')) = 'XML' then begin
                     FieldChangeNode := ChangeXML.GetContextNode(ChangeXMLNode, 'FLDS');
                     FieldChangeNode := FieldChangeNode.FindFirstChildElement;
                     while (FieldChangeNode <> nil) do begin
                        try
                           WS := WS + '<tr><td>'+Trim(HDQuery.FieldByName('ComputerName').AsString)+'</td>' +
                              '<td>' + Trim(HDQuery.FieldByName('ProductName').AsString)+'</td>' +
                              '<td>' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',HDQuery.FieldByName('DateChanged').AsDateTime)+' EST</td>';
                           Xpath := Trim(ChangeXML.GetContextValueAsWideString(FieldChangeNode, 'XPATH'));
                           WS := WS + '<td>' + ChangeXML.GetContextValueAsWideString(FieldChangeNode, 'FLDNAME') + '</td>'+
                           '<td>' + ChangeXML.GetContextValueAsWideString(ChangeXMLNode, 'OLD'+Xpath) + '</td>' +
                           '<td>' + ChangeXML.GetContextValueAsWideString(ChangeXMLNode, 'NEW'+Xpath) + '</td>' +
                           '<td>' + Trim(HDQuery.FieldByName('User').AsString)+'</td></tr>';
                        except
                           On E:Exception do begin
                              ProcessLog(ltWarning,'GETACTIVATIONEDITLOG','Exception processing XPATH Log line: '+Xpath +' '+ E.Message);
                              If Assigned(ChangeXML) then FreeAndNil(ChangeXML);
                           end;
                        end;
                        FieldChangeNode := FieldChangeNode.FindNextSiblingElement;
                     end;
                  end else begin
                     WS := WS + '<tr><td>'+Trim(HDQuery.FieldByName('ComputerName').AsString)+'</td>' +
                           '<td>' + Trim(HDQuery.FieldByName('ProductName').AsString)+'</td>' +
                           '<td>' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',HDQuery.FieldByName('DateChanged').AsDateTime)+' EST</td>' +
                           '<td>' + ChangeXML.GetContextValueAsWideString(ChangeXMLNode, 'FLD') + '</td>'+
                           '<td>' + ChangeXML.GetContextValueAsWideString(ChangeXMLNode, 'OLD') + '</td>' +
                           '<td>' + ChangeXML.GetContextValueAsWideString(ChangeXMLNode, 'NEW') + '</td>' +
                           '<td>' + Trim(HDQuery.FieldByName('User').AsString)+'</td></tr>';
                  end;

                  ChangeXMLNode := ChangeXMLNode.FindNextSiblingElement;
               end;
            end else begin
               WS := WS + '<tr><td>'+Trim(HDQuery.FieldByName('ComputerName').AsString)+'</td>' +
                           '<td>' + Trim(HDQuery.FieldByName('ProductName').AsString)+'</td>' +
                           '<td>' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',HDQuery.FieldByName('DateChanged').AsDateTime)+' EST</td><td></td><td></td><td></td>' +
                           '<td>' + Trim(HDQuery.FieldByName('User').AsString)+'</td></tr>';
            end;
            If Assigned(ChangeXML) then FreeAndNil(ChangeXML);
            HDQuery.Next;
         end;
         WS := WS + '</tbody></table>';
      end else begin
          WS := '<B>**No Changes Found**</B><BR>' ;
      end;
      WS := WS + '<br><a href="javascript:ShowByID(''ActivationSearchForm'');ShowActSearch()" class="linkBtn">Back To Activations</A>';
      ProcessLog(ltinfo,'GETACTIVATIONEDITLOG','End');
      Response.Content := WS;
      exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'GETACTIVATIONEDITORAJAX') then begin     //2015-12-19 jtm
      ProcessLog(ltinfo,'GETACTIVATIONEDITORAJAX','Begin');
      WS := '';

      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['ACTIVATIONSC']))) <> '' then begin
          ActivationSC := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['ACTIVATIONSC'])));
      end;
      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['ACTLOCATION']))) <> '' then begin
          RNID := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['ACTLOCATION'])));
      end;
      ProcessLog(ltinfo,'GETACTIVATIONEDITORAJAX','ActivationSC: '+ActivationSC +';');
      HDQuery.Close;
      HDQuery.SQL.Clear;
      HDQuery.SQL.Add('Select * from ProductActivations where SystemCode = ' + ActivationSC);
      HDQuery.SQL.Add(' And RNID = ' + RNID);
      HDQuery.Open;
      ProcessLog(ltinfo,'GETACTIVATIONEDITORAJAX','Query Opened; Record Count: '+IntToStr(HDQuery.RecordCount));
      If HDQuery.RecordCount = 1 then begin
         DistrictCode := '';
         TechID := '';
         DistrictCode := GetXMLTagStr(HDQuery.FieldByName('ProfileXML').AsString,'TRANIDENTPREFIX');
         if DistrictCode <> '' then begin
            TechID := Copy(DistrictCode, 5,length(DistrictCode));
            DistrictCode := Copy(DistrictCode,1,4);
         end;
         SessionVarEval.AddValue('DistrictCode', DistrictCode);
         SessionVarEval.AddValue('TechID', TechID);
         SessionVarEval.AddValue('ActivationSC', ActivationSC);
         SessionVarEval.AddValue('LocRNID', RNID);
         WS := LoadWebFileFromFolder('EditActivation.htm','');
      end else begin
          WS := '<B>**No Activation Found**</B><BR>' ;
      end;
      ProcessLog(ltinfo,'GETACTIVATIONEDITORAJAX','End');
      Response.Content := WS;
      exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'EDITACTIVATIONPOST') then begin        //2015-12-19 jtm
      ProcessLog(ltinfo,'EDITACTIVATIONPOST','Begin');
      WS := '';

      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['ACTIVATIONSC']))) <> '' then begin
          ActivationSC := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['ACTIVATIONSC'])));
      end;
      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['ACTLOCATION']))) <> '' then begin
          RNID := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['ACTLOCATION'])));
      end;
      DistrictCode := NumericOnly(Trim(Request.ContentFields.Values['districtcode']));
      TechID := NumericOnly(Trim(Request.ContentFields.Values['techid']));
      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/TRANIDENTPREFIXDUPECHECK','FALSE') = 'TRUE') then begin
         HDQuery.Close;
         HDQuery.SQL.Clear;
         HDQuery.SQL.Text := 'SET ARITHABORT ON; select * from ProductActivations where Cast(ProfileXML as XML).value(''(/ACTIVATIONPROFILE/TRANIDENTPREFIX/node())[1]'', ''varchar(20)'') = :TranIdentPrefix and rnid = :RNID';
         HDQuery.Parameters.ParamByName('TranIdentPrefix').Value := (DistrictCode + TechID);
         HDQuery.Parameters.ParamByName('RNID').Value := RNID;
         HDQuery.Open;
         ProcessLog(ltDebug, PageName, 'HDQuery.SQL.Text = '+HDQuery.SQL.Text); // 2019-6-26 ss DVST-3764
         ProcessLog(ltDebug, PageName, 'TranIdentPrefix = '+(DistrictCode + TechID)); // 2019-6-26 ss DVST-3764
         ProcessLog(ltDebug, PageName, 'RNID = '+RNID); // 2019-6-26 ss DVST-3764
         If HDQuery.RecordCount > 0 then begin
            ProcessLog(ltinfo,'EDITACTIVATIONPOST','TranIdentPrefix Exists: ' + (DistrictCode + TechID) + ' Exiting');
            Response.Content := '<B>**District Code and Tech ID Combination Already Exist**</B><BR>';
            exit;
         end;
         HDQuery.Close;
      end;
      ProcessLog(ltinfo,'EDITACTIVATIONPOST','ActivationSC: '+ActivationSC +';');
      HDQuery.Close;
      HDQuery.SQL.Clear;
      HDQuery.SQL.Add('Select * from ProductActivations where SystemCode = ' + ActivationSC);
      HDQuery.SQL.Add(' And RNID = ' + RNID);
      HDQuery.Open;
      ProcessLog(ltinfo,'EDITACTIVATIONPOST','Query Opened; Record Count: '+IntToStr(HDQuery.RecordCount));
      If HDQuery.RecordCount = 1 then begin
         XMLString := Trim(HDQuery.FieldByName('ProfileXML').AsString);
         Try
            ChangeXML := TOpenXML.CreateFromString(Nil,XMLString);
         except
            On E:Exception do begin
               ProcessLog(ltWarning,'EDITACTIVATIONPOST','OpenXMLLoad Exception processing XML: ' + E.Message);
               If Assigned(ChangeXML) then FreeAndNil(ChangeXML);
            end;
         end;
         HDQuery.Edit;
         If Assigned(ChangeXML) then begin      //XML exists for this activation
             ChangeXML.EditNodeValue('/ACTIVATIONPROFILE/TRANIDENTPREFIX',DistrictCode + TechID);
             if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/SETRESTRICTEDDAYS','FALSE') = 'TRUE' then begin  //2017-03-22 F#1354
                XMLSetTag(ChangeXML,'/ACTIVATIONPROFILE/RESTRICTEDDAYS','SUNDAY');
             end;
             HDQuery.FieldByName('ProfileXML').AsString := ChangeXML.DocumentAsString;
         end else begin
             HDQuery.FieldByName('ProfileXML').AsString :='<ACTIVATIONPROFILE><TRANIDENTPREFIX>'+             //XML does not exist for this activation...add it
             DistrictCode + TechID + '</TRANIDENTPREFIX></ACTIVATIONPROFILE>';
             if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/SETRESTRICTEDDAYS','FALSE') = 'TRUE' then begin  //2017-03-22 F#1354
                HDQuery.FieldByName('ProfileXML').AsString := '<ACTIVATIONPROFILE><TRANIDENTPREFIX>'+
             DistrictCode + TechID + '</TRANIDENTPREFIX><RESTRICTEDDAYS>SUNDAY</RESTRICTEDDAYS></ACTIVATIONPROFILE>';
             end;
         end;
         ProcessLog(ltDebug, PageName, 'HDQuery.SQL.Text = '+HDQuery.SQL.Text); // 2019-6-26 ss DVST-3764
         AddProductionActivationChangeLog('HelpDesk', HDQuery, GetUserNameByRNSessionID(RNDB.ConnectionString, RNSessionID), GetRemoteAddress(), HDDB.ConnectionString); // 2019-6-26 ss DVST-3764: need to do this before Post
         HDQuery.Post;
         HDQuery.Close;
         If Assigned(ChangeXML) then FreeAndNil(ChangeXML);
      end else begin
          WS := '<B>**No Activation Found**</B><BR>' ;
      end;
      ProcessLog(ltinfo,'EDITACTIVATIONPOST','End');
      Response.Content := WS;
      exit;
   end;

   If (CustomerMembType = 'ADMIN') and (PageName = 'ADDACTIVATIONAJAX') then begin     //2015-12-19 jtm
      ProcessLog(ltinfo,'ADDACTIVATIONAJAX','Begin');
      WS := '';
      ActivationExists := true;
      
      RNID := NumericOnly(Request.ContentFields.Values['ActivationLocation']); // 2019-5-15 SS DVST:210: found sometimes AddActivationAdmin.htm let's a 'Add Activation' click happen when no location is selected.That was causing an exception
      if RNID = '' then begin
         WS:= 'Please select a location and try again.';
         Response.Content := WS;
         ProcessLog(ltInfo,'ADDACTIVATIONAJAX','End. Result -'+WS);
         Exit;
      end;

      DistrictCode := NumericOnly(Trim(Request.ContentFields.Values['districtcode']));
      TechID := NumericOnly(Trim(Request.ContentFields.Values['techid']));
      if RNID <> '' then begin  //2016-5-10 jtm
         HDQuery.Close;
         HDQuery.SQL.Clear;
         HDQuery.SQL.Add('SET ARITHABORT ON; Select * from ProductActivations where RNID = ''' + RNID + '''');
         HDQuery.SQL.Add('and ActivatedDate is null');
         HDQuery.SQL.Add('and ExpirationDate > ''' + FormatDateTime('MM/DD/YYYY', now) + '''');
         if (DistrictCode <> '') and  (TechID <> '') then begin
            HDQuery.SQL.Add(' and CAST(ProfileXML as XML).value(''(/ACTIVATIONPROFILE/TRANIDENTPREFIX/node())[1]'', ''varchar(20)'') =''' + DistrictCode + TechID + '''');
         end else if ValidCharsOnly(Trim(Request.ContentFields.Values['User']),true,true,'') <> '' then begin
            if length(ValidCharsOnly(Trim(Request.ContentFields.Values['User']),true,true,'')) > 30 then begin  //db field is char(30) so we can't allow strings longer
               HDQuery.SQL.Add('and CheckinUser = '''+ Copy(ValidCharsOnly(Trim(Request.ContentFields.Values['User']),true,true,''),1,30) + ''''); //2017-08-24 jtm: D#1873
            end else begin
               HDQuery.SQL.Add('and CheckinUser = '''+ ValidCharsOnly(Trim(Request.ContentFields.Values['User']),true,true,'')+'''');//2017-08-24 jtm: D#1873
            end;
         end;
         HDQuery.SQL.Add('Order by ExpirationDate');
         HDQuery.Open;
         if HDQuery.RecordCount = 0 then ActivationExists := false;
      end;
      if ActivationExists then begin
         WS := 'Activation already exists for this user';
         ProcessLog(ltinfo,'ADDACTIVATIONAJAX','Act already Exists for DistrictCode:' + DistrictCode+ 'TechID:'+TechID+ 'CheckinUser:'+ValidCharsOnly(Trim(Request.ContentFields.Values['User']),true,true,''));
      end else begin
         WS := AddActivationAjax(Request.ContentFields, HDQuery, SessionVarEval); // 2019-4-15 SS DVST-3437, DVST-210: Refactored
            end;
      Response.Content := WS;
      ProcessLog(ltInfo,'ADDACTIVATIONAJAX','End'); // 2019-4-15 SS DVST-3437
      exit;
   end;
   If (PageName = 'GETADDACTIVATIONEDITORAJAX') and (CustomerMembType = 'ADMIN') then begin    //2015-12-19 jtm

      WS := LoadWebFileFromFolder('AddActivationAdmin.htm','PPADMIN');//2017-08-24 jtm: D#1874

      ReplaceString(WS, '%LOCATIONOPTIONS%', GenerateAllSchoolOptions(false, true));//GenerateAllLocationsOptions);

      if(StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/MULTIPLEACTIVATIONS/ENABLED','FALSE'))) then begin // 2019-5-15 SS DVST-210
         ReplaceString(WS, '%NUMOFACTIVATIONOPTIONS%', GenerateActivationOptions(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/MULTIPLEACTIVATIONS/MAXACTIVATIONSALLOWED', '5'))));
      end;

      Response.Content := WS;
      exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'GETCUSTPAYMENTHISTORYAJAX') then begin
      ParentGUID := GuidOnly(Request.queryfields.Values['CUSTGUID']);
      If ParentGUID = '' then exit;
      PaySchedGUID := GUIDOnly(Request.queryfields.Values['PAYSCHEDGUID']);

      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('select * from customers where Customers.CustomerCode = ''' + ParentGUID + ''' and ChainCode = ' + Stri(ChainCode,-1));
      RNQuery.Open;
      If RNQuery.RecordCount = 0 then exit;
      RNQUery.Close;
      WS := LoadWebFileFromFolder('CustPaymentHistoryAjax.htm','PPADMIN');
      ReplaceString(WS, '%PAYMENTHISTORY%', GenerateCustomerPaymentHistory(ParentGUID,PaySchedGUID,False));
      Response.Content := WS;
      exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'GETCUSTPAYMENTOPTIONSAJAX') then begin
      if not PaymentPortalCustomerAuthenticate then exit;
      Response.Content := GetCustPaymentOptionsAjax(Request.QueryFields, RNQuery); //2019-4-17 ss DVST-4900: Refactoring to avoid exception thrown because PP Action API is too long 
      exit;
   end;

   If (CustomerMembType = 'ADMIN') and (PageName = 'GETSTOREPAYMENTHISTORY') then begin
      GetStorePaymentHistory(Response, Request.ContentFields, Request.QueryFields, RNID, HASTOffsetEST, ChainCode);
      Exit;
   end;

   If ((CustomerMembType = 'ADMIN') and (PageName = 'GETTRANSHISTSUBROWGRIDDATAAJAX')) then begin // 2018-12-19 ss: DVST 3056 Get Sub row grid data of trans hist
      ProcessLog(ltDebug, 'GETTRANSHISTSUBROWGRIDDATAAJAX', 'Begin Page GETTRANSHISTSUBROWGRIDDATAAJAX'); // Delete later
      ProcessLog(ltDebug, 'GETTRANSHISTSUBROWGRIDDATAAJAX', 'Request.QueryFields.CommaText = '+Request.QueryFields.CommaText); // Delete later
      Response.Content := GetTransHistSubRowGidDataAsXML(Request.QueryFields.Values['RNID'],
                                                         Request.QueryFields.Values['CustGUID'],
                                                         Request.QueryFields.Values['PayHistGUID']);
      Response.ContentType := 'application/xml';
      ProcessLog(ltDebug, 'GETTRANSHISTSUBROWGRIDDATAAJAX', 'End Page GETTRANSHISTSUBROWGRIDDATAAJAX'); // Delete later
      Exit;
   end;

   If (CustomerMembType = 'ADMIN') and (PageName = 'UPLOADFILEAJAX') then begin
      if not PaymentPortalCustomerAuthenticate then exit;

      If (UserXMLGetTag('/USERPROFILE/ALLOWFILEUPLOAD','FALSE')='TRUE') then begin
         UploadFile := '';
         if (IntToStr(Length(Request.Content)) <> IntToStr(Request.ContentLength)) then begin
            Try
               ProcessLog(ltInfo, 'UPLOADFILEAJAX', 'large request packet, get rest of packet as stream');
               GetRequestDataAsStream;
               RequestString := RequestStream.ReadString(RequestStream.Size);
            except
               On E:Exception do begin
                  ProcessLog(ltWarning, 'Data stream error: ', E.Message);
                  Response.Content := 'FAILED';
                  RequestStream.Free;
                  exit;
               end;
            end;
         end;
         RequestString := Request.Content + RequestString;
         if (RequestString <> '') then begin
            UploadFileSize := GetXMLTagStr(RequestString, 'FILESIZE');
            if (UploadFileSize <> '') and (StrToInt(UploadFileSize) < 2097152) then begin
               ProcessLog(ltdebug,'Admin: UploadFileTab', 'Start File Upload Process');
               UploadFile := GetXMLTagStr(RequestString, 'FILE');
               UploadFileLocation  := '';
               if (UploadFile <> '') then begin
                  FileUploadDateTimeStr := SessionVarEval.GetValueAsString('FileUploadDateTime');
                  FileUploadCount := Valu(SessionVarEval.GetValueAsString('FileUploadCount'));
                  ProcessLog(ltdebug,'Admin: File Upload Count:', IntToStr(FileUploadCount));
                  if (FileUploadDateTimeStr = '') then begin
                     FileUploadDateTimeStr := FormatDateTime('MM/DD/YYYY HH:MM:SS',now);
                     SessionVarEval.AddValue('FileUploadDateTime', FileUploadDateTimeStr);
                  end;
                  if (FileUploadCount = 0) then begin
                     FileUploadCount := 1;
                     SessionVarEval.AddValue('FileUploadCount',IntToStr(FileUploadCount));
                  end else begin
                     Inc(FileUploadCount);
                  end;

                  FileUploadTimeLimit := StrToInt(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINFILEUPLOAD/FILETIMELIMIT','10'));
                  if (FileUploadTimeLimit >= 60) then begin
                     if ((FileUploadTimeLimit mod 60)=0) then begin
                        FileUploadTimeLimit := FileUploadTimeLimit div 60;
                        FileUploadTimeLimitDate := EncodeTime(FileUploadTimeLimit,0,0,0);
                     end else begin
                        FileUploadTimeLimitDate := EncodeTime((FileUploadTimeLimit div 60),(FileUploadTimeLimit mod 60),0,0);
                     end;
                  end else begin
                     FileUploadTimeLimitDate := EncodeTime(0,FileUploadTimeLimit,0,0);
                  end;
                  ProcessLog(ltdebug,'Admin: FileUploadDateTimeStr;now-limt', FileUploadDateTimeStr+ ';'+FormatDateTime('MM/DD/YYYY HH:MM:SS',now-FileUploadTimeLimitDate));
                  FileUploadLimit := StrToInt(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINFILEUPLOAD/FILECOUNTLIMIT','5'));
                  if (FileUploadCount > FileUploadLimit) then begin
                     if (StrToDateTime(FileUploadDateTimeStr)) >  (now - FileUploadTimeLimitDate) then begin
                        ProcessLog(ltdebug,'Admin: UploadFileTab', 'too many files within ten minutes');
                        Response.Content := 'LIMITED';
                        exit;
                     end else begin
                        FileUploadDateTimeStr := FormatDateTime('MM/DD/YYYY HH:MM:SS',now);
                        SessionVarEval.AddValue('FileUploadDateTime', FileUploadDateTimeStr);
                        FileUploadCount := 1;
                     end;
                  end;

                  UploadFileName := FormatDateTime('YYYYMMDDHHMMSS', Now);
                  UploadFileName := UploadFileName + '_' + ValidCharsOnly(GetXMLTagStr(RequestString,'NAME'),True,True,'.');
                  UploadFileLocation := 'C:\Inetpub\wwwroot\'+DomainHostFolder+'\UserFiles\';
                  If not DirectoryExists(UploadFileLocation) then begin
                     ForceDirectories(UploadFileLocation);
                  end;
                  UploadFileLocation := UploadFileLocation + UploadFileName;
                  DecodeToFile(UploadFile, UploadFileLocation);

                  DomainConfigXMLNode := DomainConfigXML.GetNode('/CONFIGDATA/UIPARAMS/ADMINFILEUPLOAD/FILEFIELDSTOPARSE');

                  if (StrToInt(UploadFileSize) = FileByNameSize(UploadFileLocation)) then begin
                     Response.Content := ParseAndUploadFileDataToDB(UploadFileLocation, '', RNID, Stri(ChainCode,-1), RNDB, DomainConfigXMLNode); //2019-2-13 ss DVST-3865
                  end else begin
                     ProcessLog(ltdebug,'Admin: UploadFileTab', 'File Size UploadFileSize: ' + UploadFileSize);
                     ProcessLog(ltdebug,'Admin: UploadFileTab', 'File Size after decode: ' + IntToStr(FileByNameSize(UploadFileLocation)));
                     Response.Content := 'FAILED';
                  end;
                  SessionVarEval.AddValue('FileUploadCount',IntToStr(FileUploadCount));
                  if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINFILEUPLOAD/DELETEFILEAFTERUPLOAD','FALSE') = 'TRUE') then begin
                     DeleteFiles(UploadFileLocation);
                  end;
               end else begin
                  ProcessLog(ltdebug,'Admin: UploadFileTab', 'Missing File In Request');
                  Response.Content := 'FAILED';
               end;
            end else begin
               ProcessLog(ltdebug,'Admin: UploadFileTab', 'Missing FileSize In Request');
               Response.Content := 'FAILED';
            end;
         end else begin
            ProcessLog(ltdebug,'Admin: UploadFileTab', 'No File Data Received');
            Response.Content := 'FAILED';
         end;
      end else begin
         Response.Content := 'NOTALLOWED';
      end;
      exit;
   end;

   If (CustomerMembType = 'ADMIN') and (PageName = 'GETCUSTOMREPORT') then begin
      WS := AlphaOnly(Trim(UpCaseString(Request.queryfields.Values['Name'])));
      AdminRNID := NumericOnly(Request.queryfields.Values['RNID']);
      DisplayFormat := Request.queryfields.Values['DISPLAYFORMAT'];
      
      If AdminRNID = '' then AdminRNID := RNID;

      if Trim(Request.queryfields.Values['RNID'])= 'ALL' then begin
         AdminRNID := 'ALL';  // make it use profileid
      end else begin
         if  (Not ValidateRNID(AdminRNID)) then begin
            Response.Content := 'INVALID RNID';
            exit;
         end;
      end;

      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('select *, customers.dob as CustDob, customers.FirstName as CustFirstName, customers.LastName as CustLastName, customers.AccountNumber as CustAccountNumber, customers.CITY as CustCity, customers.ZIP as CustZip,' +
                      'custchild.dob as ChildDob, custchild.FirstName as ChildFirstName, custchild.LastName as ChildLastName, custchild.AccountNumber as ChildAccountNumber, CustPaymentHistory.PaySchedGUID as CustPaySchedGUID from custpaymenthistory');
      RNQuery.SQL.Add('left outer join customers on (custpaymenthistory.CustGUID = Customers.CustomerCode) and (Customers.ChainCode = ' + Stri(ChainCode,-1) + ')');
      RNQuery.SQL.Add('left outer join Store on (CustPaymentHistory.RNID = Store.SystemCode)');
      RNQuery.SQL.Add('Left Outer Join CustPayment on (CustPaymentHistory.PaymentGUID = CustPayment.PaymentGUID)');
      RNQuery.SQL.Add('left outer join CustChild on (CustChild.CHILDGUID = CustPaymentHistory.ChildGUID)');

      if AdminRNID = 'ALL' then
         RNQuery.SQL.Add('where CustPaymentHistory.siteRNID=' + RNID)
      else
         RNQuery.SQL.Add('where CustPaymentHistory.RNID=' + ADMINRNID);

      If Request.queryfields.Values['FROMDATE'] <> '' then
         RNQuery.SQL.Add('AND PaymentDate>=''' + Request.queryfields.Values['FROMDATE']+'''');
      If Request.queryfields.Values['THRUDATE'] <> '' then
         RNQuery.SQL.Add('AND PaymentDate<''' + FormatDateTime('MM/DD/YYYY',StrToDate(Request.queryfields.Values['THRUDATE']) +1)+'''');
      If Request.queryfields.Values['SUPRESSDECLINES'] = 'TRUE' then
         RNQuery.SQL.Add('AND (ApprovalCode <> '''')');
      if GuidOnly(Request.queryfields.Values['CUSTGUID']) <> '' then begin
         RNQuery.SQL.Add('AND Customers.CustomerCode = ''' + GuidOnly(Request.queryfields.Values['CUSTGUID']) + '''');
      end;
      if ValidCharsOnly(Request.queryfields.Values['CUSTACCOUNTNUMBER'],true,true,'') <> '' then begin
         RNQuery.SQL.Add(' and (Customers.AccountNumber = ''' + ValidCharsOnly(Request.queryfields.Values['CUSTACCOUNTNUMBER'],true,true,'')+ ''')');
      end;

      WS := Trim(AlphaOnly(WS));
      If WS <> '' then begin
         RNQuery.SQL.Add('AND Customers.LastName like ''' + WS + '%''');
      end;

      RNQuery.SQL.Add('order by PaymentDate');
      RNQuery.Open;
      WS := '';
      xExport := TOExport.Create;
      xlsWorkSheet := xExport.AddWorkSheet;

      If RNQuery.RecordCount > 0  then begin
         ReportName := Request.queryfields.Values['REPORTNAME'];
         iter := 1;
         Try
         Row := xlsWorkSheet.AddRow;
            While OpenXMLGetTag('/CONFIGDATA/CUSTOMREPORTS/CUSTOMREPORT[@NAME="'+ ReportName + '"]/FIELDS/FIELD['+ Stri(iter, -1) +']') <> '' do begin
               Row.AddCellString(OpenXMLGetTag('/CONFIGDATA/CUSTOMREPORTS/CUSTOMREPORT[@NAME="'+ ReportName + '"]/FIELDS/FIELD['+ Stri(iter, -1) +']/FIELDDISPLAYNAME'));
               iter := iter + 1;
            end;
            iter := 1;
            RecordTextLines := TStringList.Create;     //2015-12-19 jtm
            While OpenXMLGetTag('/CONFIGDATA/CUSTOMREPORTS/CUSTOMREPORT[@NAME="'+ ReportName + '"]/FIELDS/FIELD['+ Stri(iter, -1) +']') <> '' do begin
               if OpenXMLGetTag('/CONFIGDATA/CUSTOMREPORTS/CUSTOMREPORT[@NAME="'+ ReportName + '"]/FIELDS/FIELD['+ Stri(iter, -1) +']/FIELDNAME') <> '' then begin
                  RecordTextLines.Add(OpenXMLGetTag('/CONFIGDATA/CUSTOMREPORTS/CUSTOMREPORT[@NAME="'+ ReportName + '"]/FIELDS/FIELD['+ Stri(iter, -1) +']/FIELDNAME'));
               end else begin
                  RecordTextLines.Add(OpenXMLGetTag('/CONFIGDATA/CUSTOMREPORTS/CUSTOMREPORT[@NAME="'+ ReportName + '"]/FIELDS/FIELD['+ Stri(iter, -1) +']/FIELDEXPRESSION'));
               end;
               iter := iter +1;
            end;
            While Not RNQuery.EOF do begin
               Row := xlsWorkSheet.AddRow;
               VarEvaluator.ClearAll;
               VarEvaluator.AddDSCurrentRecord(RNQuery, 'CustReport');
               TabLine := '';
               for iter := 0 to(RecordTextLines.Count - 1) do begin
                  if (Pos('GETVAR', RecordTextLines.Strings[iter]) = 0) then begin//not an expression
                     Row.AddCellString(RNQuery.FieldByName(RecordTextLines.Strings[iter]).AsString);
                  end else begin
                     Row.AddCellString(VarEvaluator.VarExprEvalAsString('', RecordTextLines.Strings[iter]));
                  end;
               end;

               RNQuery.Next;
            end;
            FreeAndNil(RecordTextLines);
         except
            On E:Exception do begin
               ProcessLog(ltCritical, 'Custom Report Failed', E.Message);
            end;
         end;
      end;

      If DisplayFormat = 'XLS' then begin
         xlsExporter := TOExporterXLT.Create;

         xlsFileName := 'attachment; filename=' + ReportName + FormatDateTime('YYYYMMDDHHNNSS',now) + '.xls';//changed for 1.1.64.2
         Response.CustomHeaders.Values['Content-Disposition'] := xlsFileName;
         xlsStream := TMemoryStream.Create();

         xExport.SaveToStream(xlsStream, xlsExporter);
         xlsStream.Position := 0;

         Response.ContentStream := xlsStream;
         Response.ContentType := 'application/vnd.ms-excel';
         Response.CustomHeaders.Values['Cache-Control'] := 'private';
         Response.CustomHeaders.Values['Pragma'] := 'private';

         Exit;
      end;
      Response.Content := WS;
      Response.ContentType := 'text/html';
      Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'GETCUSTOMREPORTCHUNK') then begin   //2016-06-22 jtm
      WS := AlphaOnly(Trim(UpCaseString(Request.queryfields.Values['Name'])));
      AdminRNID := NumericOnly(Request.queryfields.Values['RNID']);
      DisplayFormat := Request.queryfields.Values['DISPLAYFORMAT'];
      If AdminRNID = '' then AdminRNID := RNID;

      if Trim(Request.queryfields.Values['RNID'])= 'ALL' then begin
         AdminRNID := 'ALL';  // make it use profileid
      end else begin
         if  (Not ValidateRNID(AdminRNID)) then begin
            Response.Content := 'INVALID RNID';
            exit;
         end;
      end;
      PosStart := '0';
      QueryCount := '100';
      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['posStart']))) <> '' then begin
          PosStart := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['posStart'])));
      end;
      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['count']))) <> '' then begin
          QueryCount := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['count'])));
      end;
      QuerySQLText := 'SELECT ROW_NUMBER() OVER (ORDER BY PaymentDate) as row,';
      QuerySQLText := QuerySQLText + ' customers.dob as CustDob, customers.FirstName as CustFirstName,';
		QuerySQLText := QuerySQLText + ' customers.LastName as CustLastName, customers.AccountNumber as CustAccountNumber, customers.CITY as CustCity, customers.ZIP as CustZip,';
      QuerySQLText := QuerySQLText + '  custchild.dob as ChildDob, custchild.FirstName as ChildFirstName, custchild.LastName as ChildLastName,';
      QuerySQLText := QuerySQLText + '  custchild.AccountNumber as ChildAccountNumber, CustPaymentHistory.PaySchedGUID as CustPaySchedGUID,';
      QuerySQLText := QuerySQLText + '  CustChild.CHILDGUID as CustChildGuid, customers.EMAIL as email, customers.ADDRESS as address, customers.HomeAddress2 as HomeAddress2,';
      QuerySQLText := QuerySQLText + '  customers.HPHONE as hphone, CUSTPAYMENTHISTORY.PAYMENTAMOUNT as paymentamount, CUSTPAYMENTHISTORY.PAYMENTDATE as paymentdate,';
      QuerySQLText := QuerySQLText + '  CUSTPAYMENT.paymentname as paymentname, CUSTPAYMENTHISTORY.custhistdesc as custhistdesc, CUSTPAYMENTHISTORY.APPROVALCODE as approvalcode,';
      QuerySQLText := QuerySQLText + '  CUSTPAYMENTHISTORY.NONAUTHREASON as nonauthreason,CUSTPAYMENTHISTORY.RNID as RNID,CUSTPAYMENTHISTORY.GWSYSTEMCODE as SystemCode,';
      QuerySQLText := QuerySQLText + ' CUSTPAYMENTHISTORY.Custom1 as Custom1,CUSTPAYMENTHISTORY.Custom2 as Custom2,CUSTPAYMENTHISTORY.Custom3 as Custom3,CUSTPAYMENTHISTORY.Custom4 as Custom4,'; //2017-09-20 jtm: F#2192
      QuerySQLText := QuerySQLText + ' CUSTPAYMENTHISTORY.Custom5 as Custom5,CUSTPAYMENTHISTORY.Custom6 as Custom6,CUSTPAYMENTHISTORY.Custom7 as Custom7,CUSTPAYMENTHISTORY.Custom8 as Custom8,';
      QuerySQLText := QuerySQLText + ' CUSTPAYMENTHISTORY.Custom9 as Custom9,CUSTPAYMENTHISTORY.Custom10 as Custom10';
      QuerySQLText := QuerySQLText + '  from custpaymenthistory';
      QuerySQLText := QuerySQLText + '  left outer join customers on (custpaymenthistory.CustGUID = Customers.CustomerCode)';// and (Customers.ChainCode = ' + Stri(ChainCode,-1) + ')'; //2018-06-20 bls: D#4816
      QuerySQLText := QuerySQLText + '  left outer join Store on (CustPaymentHistory.RNID = Store.SystemCode)';
      QuerySQLText := QuerySQLText + '  Left Outer Join CustPayment on (CustPaymentHistory.PaymentGUID = CustPayment.PaymentGUID)';
      QuerySQLText := QuerySQLText + '  left outer join CustChild on (CustChild.CHILDGUID = CustPaymentHistory.ChildGUID)';


      if AdminRNID = 'ALL' then
         QuerySQLText := QuerySQLText + 'where CustPaymentHistory.siteRNID=' + RNID
      else
         QuerySQLText := QuerySQLText + 'where CustPaymentHistory.RNID=' + ADMINRNID;

      If Request.queryfields.Values['FROMDATE'] <> '' then
         QuerySQLText := QuerySQLText + 'AND PaymentDate>=''' + Request.queryfields.Values['FROMDATE']+'''';
      If Request.queryfields.Values['THRUDATE'] <> '' then
         QuerySQLText := QuerySQLText + 'AND PaymentDate<''' + FormatDateTime('MM/DD/YYYY',StrToDate(Request.queryfields.Values['THRUDATE']) +1)+'''';
      If Request.queryfields.Values['SUPRESSDECLINES'] = 'TRUE' then
         QuerySQLText := QuerySQLText + 'AND (ApprovalCode <> '''')';
      if GuidOnly(Request.queryfields.Values['CUSTGUID']) <> '' then begin
         QuerySQLText := QuerySQLText + 'AND Customers.CustomerCode = ''' + GuidOnly(Request.queryfields.Values['CUSTGUID']) + '''';
      end;
      if ValidCharsOnly(Request.queryfields.Values['CUSTACCOUNTNUMBER'],true,true,'') <> '' then begin
         QuerySQLText := QuerySQLText + ' and (Customers.AccountNumber = ''' + ValidCharsOnly(Request.queryfields.Values['CUSTACCOUNTNUMBER'],true,true,'')+ ''')';
      end;

      WS := Trim(AlphaOnly(WS));
      If WS <> '' then begin
         QuerySQLText := QuerySQLText + 'AND Customers.LastName like ''' + WS + '%''';
      end;

      QuerySQLText := QuerySQLText + 'AND (Customers.ChainCode = ' + Stri(ChainCode,-1) + ')'; //2018-06-20 bls: D#4816

      if StrToInt(PosStart) = 0 then begin
         RNQuery.Close;
         RNQuery.SQL.Clear;
         RNQuery.SQL.Text := QuerySQLText;
         RNQuery.Open;
         QueryTotalCount := IntToStr(RNQuery.RecordCount);
         SessionVarEval.AddValue('CustomerTranQueryTotalCount', QueryTotalCount);
         ProcessLog(ltinfo,'GETCUSTOMREPORTCHUNK','Query Opened; Total Record Count: '+QueryTotalCount);
      end;
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('SET ARITHABORT ON; Declare @StartPos as int; Declare @count as int; Set @StartPos = '+ PosStart +'; set @count = '+ QueryCount +';');
      RNQuery.SQL.Add('SELECT * FROM (' + QuerySQLText);
      If DisplayFormat = 'XLS' then begin
         RNQuery.SQL.Add(') a');
      end else if DisplayFormat = 'JSON' then begin
         RNQuery.SQL.Add(') a where a.row > @StartPos and a.row <= (@StartPos +@count)');
      end;
      ProcessLog(ltDebug,'GETCUSTOMREPORTCHUNK RNQuery.SQL.Text',RNQuery.SQL.Text);
      RNQuery.Open;
      WS := '';
      TabTextLines := TStringList.Create;

      If DisplayFormat = 'XLS' then begin
         xExport := TOExport.Create;
         xlsWorksheet := xExport.AddWorkSheet;
      end else if DisplayFormat = 'JSON' then begin
         JSON := TStringList.Create;
      end;

      ProcessLog(ltinfo,'GETCUSTOMREPORTCHUNK','RNQuery opened');
      If RNQuery.RecordCount > 0  then begin
         ReportName := Request.queryfields.Values['REPORTNAME'];
         ProcessLog(ltinfo,'GETCUSTOMREPORTCHUNK','RNQuery count' + IntToStr(RNQuery.RecordCount) + ' REPORTNAME:'+ ReportName);
         iter := 1;
         Try
            If (DisplayFormat = 'JSON') AND (QueryTotalCount <> '') then begin
               JSON.Append('[{"Num Lines":"' + QueryTotalCount + '"},');
            end;
            
            if (DisplayFormat = 'JSON') OR (QueryTotalCount <> '') then begin
               DomainConfigXMLNode := DomainConfigXML.GetNode('/CONFIGDATA/CUSTOMREPORTS/CUSTOMREPORT[@NAME="'+ ReportName + '"]/FIELDS');
               DomainConfigXMLNode := DomainConfigXMLNode.FindFirstChildElement;
               if DisplayFormat = 'XLS' then begin
                  Row := xlsWorksheet.AddRow();
               end;
               while (DomainConfigXMLNode <> nil) do begin
                  TabTextLines.Append(DomainConfigXML.GetContextValueAsWideString(DomainConfigXMLNode,'FIELDDISPLAYNAME'));
                  if DisplayFormat = 'XLS' then begin
                     Row.AddCellString(DomainConfigXML.GetContextValueAsWideString(DomainConfigXMLNode,'FIELDDISPLAYNAME'));
                  end;   
                  DomainConfigXMLNode := DomainConfigXMLNode.FindNextSiblingElement;
               end;
               if DisplayFormat = 'XLS' then begin
                  For iterator := 0 to Row.Cells.Count - 1 do begin
                     Row.Cells.Items[iterator].SetFontColor(clBlack).SetBorder(cbBottom).SetBGColor(TColor($80000000)).SetAlignment(cahCenter);
                  end;
               end;
            end;
            iter := 1;
            RecordTextLines := TStringList.Create;
            DomainConfigXMLNode := DomainConfigXML.GetNode('/CONFIGDATA/CUSTOMREPORTS/CUSTOMREPORT[@NAME="'+ ReportName + '"]/FIELDS');
            DomainConfigXMLNode := DomainConfigXMLNode.FindFirstChildElement;
            while (DomainConfigXMLNode <> nil) do begin
               if DomainConfigXML.GetContextValueAsWideString(DomainConfigXMLNode,'FIELDNAME') <> '' then begin
                  RecordTextLines.Add(DomainConfigXML.GetContextValueAsWideString(DomainConfigXMLNode,'FIELDNAME'));
               end else begin
                  RecordTextLines.Add(DomainConfigXML.GetContextValueAsWideString(DomainConfigXMLNode,'FIELDEXPRESSION'));
               end;
               DomainConfigXMLNode := DomainConfigXMLNode.FindNextSiblingElement;
            end;
            While Not RNQuery.EOF do begin
               VarEvaluator.ClearAll;
               VarEvaluator.AddDSCurrentRecord(RNQuery, 'CustReport');
               If DisplayFormat = 'XLS' then begin
                  Row := xlsWorkSheet.AddRow();
               end else if DisplayFormat = 'JSON' then begin
                  JSON.Append('{');
               end;

               for iter := 0 to(RecordTextLines.Count - 1) do begin
                  if (Pos('GETVAR', RecordTextLines.Strings[iter]) = 0) then begin
                     If DisplayFormat = 'XLS' then begin
                        Row.AddCellString(Trim(RNQuery.FieldByName(RecordTextLines.Strings[iter]).AsString));
                     end else if DisplayFormat = 'JSON' then begin
                        JSON.Append('"' + TabTextLines.Strings[iter] + '":"' + Trim(RNQuery.FieldByName(RecordTextLines.Strings[iter]).AsString) + '",');
                     end;
                  end else begin
                     If DisplayFormat = 'XLS' then begin
                        Row.AddCellString(Trim(VarEvaluator.VarExprEvalAsString('', RecordTextLines.Strings[iter])));
                     end else if DisplayFormat = 'JSON' then begin
                        JSON.Append('"' + TabTextLines.Strings[iter] + '":"' + Trim(VarEvaluator.VarExprEvalAsString('', RecordTextLines.Strings[iter])) + '",');
                     end;
                  end;
               end;
               if DisplayFormat = 'JSON' then begin
                  JSONString := JSON.Strings[JSON.Count - 1];
                  JSON.Delete(JSON.Count - 1);
                  delete(JSONString, length(JSONString), 1);
                  JSON.Append(JSONString + '},');
               end;
               RNQuery.Next;
            end;
            ProcessLog(ltinfo,'GETCUSTOMREPORTCHUNK','RNQuery processed');
            FreeAndNil(RecordTextLines);
         except
            On E:Exception do begin
               ProcessLog(ltCritical, 'Custom Report Failed', E.ClassName + ': ' + E.Message);
            end;
         end;
      end;

      If DisplayFormat = 'XLS' then begin
         xlsExporter := TOExporterXLT.Create;

         xlsFileName :=  'attachment; filename=Transactions-' + FormatDateTime('YYYYMMDD',now) + '-' + FormatDateTime('hhnn', now) + '.xls';
         Response.CustomHeaders.Values['Content-Disposition'] := xlsFileName;
         xlsStream := TMemoryStream.Create();//changed for 1.1.64.2

         xExport.SaveToStream(xlsStream, xlsExporter);
         xlsStream.Position := 0;

         Response.ContentStream := xlsStream;
         Response.ContentType := 'application/vnd.ms-excel';
         Response.CustomHeaders.Values['Cache-Control'] := 'private';
         Response.CustomHeaders.Values['Pragma'] := 'private';
         Exit;
      end else if DisplayFormat = 'JSON' then begin
         JSONString := stringreplace(JSON.Text, #13,'',[rfReplaceAll]);
         JSONString := stringreplace(JSONString, #10,'',[rfReplaceAll]);
         delete(JSONString, length(JSONString), 1);
         Response.Content := JSONString + ']';

         Response.ContentType := 'text/plain';
         Response.CustomHeaders.Values['Cache-Control'] := 'private';
         Response.CustomHeaders.Values['Pragma'] := 'private';
         Exit;
      end;

      Response.ContentType := 'text/html';
      Response.Content := WS;

      Exit;
   end;

   If (CustomerMembType = 'ADMIN') and (PageName = 'GETCUSTOMREPORTSAJAX') then begin //2016-10-19 jtm Feat OT# 1186
      if not PaymentPortalCustomerAuthenticate then exit; //2016-10-19 jtm Feat OT# 1186 do this again to get the User's rnid access info
      WS := LoadWebFileFromFolder('CustomReports.htm','PPADMIN');
      processLog(ltInfo,'GETCUSTOMREPORTSAJAX allowed RNIDs',ExternalXMLGetTag('/EXTERNALXML/ALLOWEDRNIDS'));
      if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CUSTOMREPORTSDISPLAYALLOPTION','FALSE')) then begin //2018-10-10 bls DVST-715
         ReplaceString(WS, '%STOREDATA%', GenerateAllSchoolOptions(True,False));
      end else begin
         ReplaceString(WS, '%STOREDATA%', GenerateAllSchoolOptions(False,True));
      end;
      StoreAttr := TTTStringList.Create;
      if (strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CUSTOMREPORTS/STOREATTRIBUTES/ENABLESTOREATTR1','FALSE'))) then begin
         StoreAttr.Clear;
         ReplaceString(WS, '%STOREATTR1%', GenerateStorAttrList(StoreAttr, '1'));
      end;
      if (strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CUSTOMREPORTS/STOREATTRIBUTES/ENABLESTOREATTR2','FALSE'))) then begin
         StoreAttr.Clear;
         ReplaceString(WS, '%STOREATTR2%', GenerateStorAttrList(StoreAttr, '2'));
      end;
      if (strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CUSTOMREPORTS/STOREATTRIBUTES/ENABLESTOREATTR3','FALSE'))) then begin
         StoreAttr.Clear;
         ReplaceString(WS, '%STOREATTR3%', GenerateStorAttrList(StoreAttr, '3'));
      end;
      if (strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CUSTOMREPORTS/STOREATTRIBUTES/ENABLESTOREATTR4','FALSE'))) then begin
         StoreAttr.Clear;
         ReplaceString(WS, '%STOREATTR4%', GenerateStorAttrList(StoreAttr, '4'));
      end;
      if (strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CUSTOMREPORTS/STOREATTRIBUTES/ENABLESTOREATTR5','FALSE'))) then begin
         StoreAttr.Clear;
         ReplaceString(WS, '%STOREATTR5%', GenerateStorAttrList(StoreAttr, '5'));
      end;
      if (strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CUSTOMREPORTS/STOREATTRIBUTES/ENABLESTOREATTR6','FALSE'))) then begin
         StoreAttr.Clear;
         ReplaceString(WS, '%STOREATTR6%', GenerateStorAttrList(StoreAttr, '6'));
      end;
      ReplaceString(WS, '%CUSTOMREPORTOPTIONS%', GenerateCustomReportOptions);
      response.Content := WS;
      FreeAndNil(StoreAttr);
      Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'GETCUSTOMREPORTSAJAXDOWNLOAD') then begin  //2016-10-19 jtm Feat OT# 1186
      if not PaymentPortalCustomerAuthenticate then exit; //2016-10-19 jtm Feat OT# 1186 do this again to get the User's rnid access info
      ReportName :=  ValidCharsOnly(Request.QueryFields.Values['REPORTNAME'],true,true,'-_');
      DisplayFormat := ValidCharsOnly(Request.QueryFields.Values['DISPLAYFORMAT'],true,true,'');
      RNID := ValidCharsOnly(Request.QueryFields.Values['LOCATIONRNID'], true, true, ''); //2018-10-10 bls DVST-715
      if (RNID = 'ALL') then begin
         RNID := '-1';
      end else if (NumericOnly(RNID) <> RNID) then begin
         RNID := '-2';
      end;
      VarEvaluator.AddValue('ReportRNID', RNID);
      if (ValidCharsOnly(Request.QueryFields.Values['STOREATTR1'],true,true,'_-. ') <> '') then begin
         VarEvaluator.AddValue('STOREATTR1', ValidCharsOnly(Request.QueryFields.Values['STOREATTR1'],true,true,' '));
      end;
      if (ValidCharsOnly(Request.QueryFields.Values['STOREATTR2'],true,true,'_-. ') <> '') then begin
         VarEvaluator.AddValue('STOREATTR2', ValidCharsOnly(Request.QueryFields.Values['STOREATTR2'],true,true,' '));
      end;
      if (ValidCharsOnly(Request.QueryFields.Values['STOREATTR3'],true,true,'_-. ') <> '') then begin
         VarEvaluator.AddValue('STOREATTR3', ValidCharsOnly(Request.QueryFields.Values['STOREATTR3'],true,true,' '));
      end;
      if (ValidCharsOnly(Request.QueryFields.Values['STOREATTR4'],true,true,'_-. ') <> '') then begin
         VarEvaluator.AddValue('STOREATTR4', ValidCharsOnly(Request.QueryFields.Values['STOREATTR4'],true,true,' '));
      end;
      if (ValidCharsOnly(Request.QueryFields.Values['STOREATTR5'],true,true,'_-. ') <> '') then begin
         VarEvaluator.AddValue('STOREATTR5', ValidCharsOnly(Request.QueryFields.Values['STOREATTR5'],true,true,' '));
      end;
      if (ValidCharsOnly(Request.QueryFields.Values['STOREATTR6'],true,true,'_-. ') <> '') then begin
         VarEvaluator.AddValue('STOREATTR6', ValidCharsOnly(Request.QueryFields.Values['STOREATTR6'],true,true,' '));
      end;
      
      If Request.queryfields.Values['FROMDATE'] <> '' then //2017-08-02 jtm: F#2030
         FromDate := StrToDate(Request.queryfields.Values['FROMDATE']);
      If Request.queryfields.Values['THRUDATE'] <> '' then //2017-08-02 jtm: F#2030
         ThruDate := StrToDate(Request.queryfields.Values['THRUDATE']) +1;
      if FromDate > 0 then VarEvaluator.AddValue('BegDate',FormatDateTime('MM/DD/YYYY',FromDate));
      if ThruDate > 0 then VarEvaluator.AddValue('EndDate',FormatDateTime('MM/DD/YYYY',ThruDate));
      if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CUSTOMREPORTS/CUSTOMREPORT[@NAME="'+ ReportName + '"]/DISPLAYNAME','') <> '' then begin
         if DisplayFormat = 'XLS' then begin
            xExport := TOExport.Create;
            xlsExporter := TOExporterXLT.Create;

            WS := GetCustomReport(ReportName,DisplayFormat,'',0,0,xExport);
            xlsStream := TMemoryStream.Create();//changed for 1.1.64.2
            xExport.SaveToStream(xlsStream, xlsExporter);
            xlsStream.Position := 0;

            xlsFileName := 'attachment; filename=' + ReportName + FormatDateTime('YYYYMMDDHHNNSS',now) + '.xls';
            Response.CustomHeaders.Values['Content-Disposition'] := xlsFileName;
            Response.ContentStream := xlsStream;
            Response.ContentType :=  'application/vnd.ms-excel';
            Response.CustomHeaders.Values['Cache-Control'] := 'private';
            Response.CustomHeaders.Values['Pragma'] := 'private';

            xExport.Free;
            xlsExporter.Free;

            Exit;
         end;
         if DisplayFormat = 'JSON' then begin
            WS := GetCustomReport(ReportName,DisplayFormat,'',0,0,nil);
         end;
      end else begin
         WS := 'REPORT NOT FOUND';
         Response.ContentType := 'text/html';
      end;
      response.Content := WS;

      Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'GETCUSTOMREPORTSCHUNKEDAJAXDOWNLOAD') then begin //2017-06-20 jtm: F#1666
      if not PaymentPortalCustomerAuthenticate then exit;
      ReportName :=  ValidCharsOnly(Request.QueryFields.Values['REPORTNAME'],true,true,'-_');
      DisplayFormat := ValidCharsOnly(Request.QueryFields.Values['DISPLAYFORMAT'],true,true,'');
      VarEvaluator.AddValue('ReportRNID',NumericOnly(Request.QueryFields.Values['LOCATIONRNID'])); //2017-07-19 jtm: F#1879
      StartPos := 0;
      QueryCountInt := 100;
      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['posStart']))) <> '' then begin
          StartPos := StrToInt(NumericOnly(Trim(UpCaseString(Request.queryfields.Values['posStart']))));
      end;
      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['count']))) <> '' then begin
          QueryCountInt := StrToInt(NumericOnly(Trim(UpCaseString(Request.queryfields.Values['count']))));
      end;
      If Request.queryfields.Values['FROMDATE'] <> '' then
         FromDate := StrToDate(Request.queryfields.Values['FROMDATE']);
      If Request.queryfields.Values['THRUDATE'] <> '' then
         ThruDate := StrToDate(Request.queryfields.Values['THRUDATE']) +1;

      if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CUSTOMREPORTS/CUSTOMREPORT[@NAME="'+ ReportName + '"]/DISPLAYNAME','') <> '' then begin
         WS := GetCustomReportChunked(StartPos,QueryCountInt,ReportName,DisplayFormat,RNID,FromDate,ThruDate);
         Response.ContentType := 'text/plain';
      end else begin
         WS := 'REPORT NOT FOUND';
         Response.ContentType := 'text/html';
      end;

      response.Content := WS;
      Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'GETSSRNIDGRIDAJAX') then begin
      if not PaymentPortalCustomerAuthenticate then exit;
      Response.ContentType := 'text/xml';
      response.Content := GenerateAllSchoolOptionsDHTMLXGrid(true);
      Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'GETSSREPORTAJAXDOWNLOAD') then begin
      if not PaymentPortalCustomerAuthenticate then exit;
      DisplayFormat := ValidCharsOnly(Request.queryfields.Values['DisplayType'],True,false,'');

      StartPos := 0;
      QueryCountInt := 100;
      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['posStart']))) <> '' then begin
          StartPos := StrToInt(NumericOnly(Trim(UpCaseString(Request.queryfields.Values['posStart']))));
      end;
      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['count']))) <> '' then begin
          QueryCountInt := StrToInt(NumericOnly(Trim(UpCaseString(Request.queryfields.Values['count']))));
      end;
      ttSSReporting := TttSSReporting.Create(PL.ProcessLog,RNDB,DoGetAppServerEvent);
      ttSSReporting.HelpDeskDBConn := HDDB;
      ttSSReporting.ttWebUtility := ttWebUtility;
      ttSSReporting.WebConfigXML := ttSSReporting.ttWebUtility.DomainConfigXML;

      if DisplayFormat = 'XLS' then begin
         WS2 := ttSSReporting.GenerateReportXMLFromRequest(Request.QueryFields); //GenerateReportXMLFromRequestQuery();
      end else begin
         WS2 := ttSSReporting.GenerateReportXMLFromRequest(Request.ContentFields); //GenerateReportXMLFromRequest();
      end;

      ReportFormat := StrToReportFormat(DisplayFormat);
      case ReportFormat of
         ttrpftCSV: Response.ContentType := 'text/html';
         ttrpftXLS: Response.ContentType := 'application/vnd.ms-excel';//'text/html';
         ttrpftHTML: Response.ContentType := 'text/html';
         ttrpftGrid: Response.ContentType := 'text/xml';
         ttrpftJSON: Response.ContentType := 'text/plain';
      end;
      ttSSReporting.HeaderDelimiter := ',';
      ttSSReporting.ChainCode := ChainCode;
      ttSSReporting.SQLwithTZ := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE'));
      ttSSReporting.ReportTZ := GetTimeZoneBiasNameStringByNumber(ValidCharsOnly(Request.ContentFields.Values['ReportTimeZone'],false,true,'-+'));
      if ReportFormat = ttrpftXLS then begin
         xExport := TOExport.Create;
         xlsExporter := TOExporterXLT.Create;

         xlsFileName := 'attachment; filename=xlsReport-' + FormatDateTime('YYYYMMDDHHNNSS', now) + '.xls';//changed for 1.1.64.2
         Response.CustomHeaders.Values['Content-Disposition'] := xlsFileName;
         xlsStream := TMemoryStream.Create();

         xlsFileName := ttSSReporting.GenerateReportData(WS2,ReportFormat,xExport);

         xExport.SaveToStream(xlsStream, xlsExporter);
         xlsStream.Position := 0;

         Response.ContentStream := xlsStream;
         Response.CustomHeaders.Values['Cache-Control'] := 'private';
         Response.CustomHeaders.Values['Pragma'] := 'private';
      end else if ReportFormat = ttrpftJSON then begin
         JSONString := stringreplace(ttSSReporting.GenerateReportData(WS2,ReportFormat, nil), #13,'',[rfReplaceAll]);
         JSONString := stringreplace(JSONString, #10,'',[rfReplaceAll]);
         delete(JSONString, length(JSONString), 1);
         Response.Content := JSONString + ']';

         Response.CustomHeaders.Values['Cache-Control'] := 'private';
         Response.CustomHeaders.Values['Pragma'] := 'private';
      end else begin
         Response.Content := ttSSReporting.GenerateReportData(WS2,ReportFormat,nil);
      end;

      FreeAndNil(ttSSReporting);
      Exit;
   end;

   If (CustomerMembType = 'ADMIN') and (PageName = 'GETSSREPORTHEADERS') then begin
      if not PaymentPortalCustomerAuthenticate then exit;
      Response.ContentType := 'text/xml';
      response.Content := GetSSReportHeaders(Request.QueryFields,Request.ContentFields,RNID);
      Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'GETSSRNIDHEADERS') then begin
      if not PaymentPortalCustomerAuthenticate then exit;
      Response.ContentType := 'text/xml';
      response.Content := GetSSRNIDHeaders(Request.QueryFields,Request.ContentFields,RNID);
      Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'SAVEDREPORTNAMEEXISTS') then begin //2018-08-03 jtm DVST-540
      if not PaymentPortalCustomerAuthenticate then exit;
      response.Content := SavedReportNameExists(Request.QueryFields,Request.ContentFields,RNID);
      Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'GETSSSTOREATTRGRIDAJAX') then begin //2018-01-25 jtm F#2360
      if not PaymentPortalCustomerAuthenticate then exit;
      response.Content := GetSSStoreAttrGridAjax(Request.QueryFields,Request.ContentFields,RNID);
      Response.ContentType := 'text/xml';
      Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'SAVESSREPORTAJAX') then begin //2018-04-11 jtm F#3540
      if not PaymentPortalCustomerAuthenticate then exit;
      Response.Content := SaveSSReportAjax(Request.QueryFields,Request.ContentFields,RNID);
      Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'GETSAVEDSSREPORTAJAX') then begin //2018-04-11 jtm F#3540
      if not PaymentPortalCustomerAuthenticate then exit;
      Response.Content := GetSavedSSReportAjax(Request.QueryFields,Request.ContentFields,RNID);
      Response.ContentType := 'application/xml'; //2018-05-16 bls F#4394
      Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'DELETESSREPORTAJAX') then begin //2018-04-11 jtm F#3540
      if not PaymentPortalCustomerAuthenticate then exit;
      Response.Content := DeleteSSReportAjax(Request.QueryFields,Request.ContentFields,RNID);
      Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'GETSSREPORTGUIDAJAXDOWNLOAD') then begin //2018-04-11 jtm F#3540
      if not PaymentPortalCustomerAuthenticate then exit;
      ReportGUID := GUIDOnly(Request.QueryFields.Values['ReportGUID']);
      DisplayFormat := ValidCharsOnly(Request.queryfields.Values['DisplayType'],True,false,'');
      EmpIdent := '';
      EmployeeGUID := '';
      EmpIdent := SessionVarEval.GetValueAsString('Session.Username');
      if (EmpIdent = '') then begin
         EmpIdent := trim(ExternalXMLGetTag('/EXTERNALXML/USERNAME'));
      end else begin
         EmployeeGUID := GetEmployeeGUIDFromUsername(EmpIdent);
      end;
      ReportFormat := StrToReportFormat(DisplayFormat);
      ttSSReporting := TttSSReporting.Create(PL.ProcessLog,RNDB,DoGetAppServerEvent); //create vannila connection object w/ registry setting. if true set to RNDBDEV
      case ReportFormat of
         ttrpftCSV: Response.ContentType := 'text/html';
         ttrpftXLS: Response.ContentType := 'application/vnd.ms-excel';//'text/html';
         ttrpftHTML: Response.ContentType := 'text/html';
         ttrpftGrid: Response.ContentType := 'text/xml';
         ttrpftJSON: Response.ContentType := 'text/plain';
      end;
      ttSSReporting.HeaderDelimiter := ',';
      ttSSReporting.ChainCode := ChainCode;
      ttSSReporting.SQLwithTZ := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE'));
      ttSSReporting.ReportTZ := GetTimeZoneBiasNameStringByNumber(ValidCharsOnly(Request.QueryFields.Values['ReportTimeZone'],false,true,'-+'));
      ttSSReporting.HelpDeskDBConn := HDDB;
      if ReportFormat = ttrpftXLS then begin
         xExport := TOExport.Create;
         xlsExporter := TOExporterXLT.Create;

         xlsFileName := 'attachment; filename=xlsReport-' + FormatDateTime('YYYYMMDDHHNNSS', now) + '.xls';//changed for 1.1.64.2
         Response.CustomHeaders.Values['Content-Disposition'] := xlsFileName;
         xlsStream := TMemoryStream.Create();

         xlsFileName := ttSSReporting.GenerateSSReportDataFromGUID(ReportGUID,EmpIdent,RNID,ReportFormat,xExport,EmployeeGUID);

         xExport.SaveToStream(xlsStream, xlsExporter);
         xlsStream.Position := 0;

         Response.ContentStream := xlsStream;
         Response.CustomHeaders.Values['Cache-Control'] := 'private';
         Response.CustomHeaders.Values['Pragma'] := 'private';
      end else if ReportFormat = ttrpftJSON then begin
         JSONString := stringreplace(ttSSReporting.GenerateSSReportDataFromGUID(ReportGUID,EmpIdent,RNID,ReportFormat, nil,EmployeeGUID), #13,'',[rfReplaceAll]);
         JSONString := stringreplace(JSONString, #10,'',[rfReplaceAll]);
         delete(JSONString, length(JSONString), 1);
         Response.Content := JSONString + ']';

         Response.CustomHeaders.Values['Cache-Control'] := 'private';
         Response.CustomHeaders.Values['Pragma'] := 'private';
      end else begin
         Response.Content := ttSSReporting.GenerateSSReportDataFromGUID(ReportGUID,EmpIdent,RNID,ReportFormat,nil,EmployeeGUID);
      end;

      FreeAndNil(ttSSReporting);
      Exit;
   end;

   If (CustomerMembType = 'ADMIN') AND (PageName = 'DOWNLOADSSRUN') then begin
      Response.ContentStream := DownloadSSRun(Request.QueryFields, Request.ContentFields, RNID, runFileName);
      Response.ContentType := GetMimeTypeFromFileName(runFileName);
      Response.CustomHeaders.Values['Content-Disposition'] := 'attachment; filename=' + runFileName;
      Response.SendResponse;

      if assigned(Response.ContentStream) then Response.ContentStream.Free;
      Exit;
   end;

   If (CustomerMembType = 'ADMIN') AND (PageName = 'DELETESSRUN') then begin
      Response.Content := DeleteSSRun(Request.QueryFields, Request.ContentFields, RNID);
      Exit;
   end;

   If (CustomerMembType = 'ADMIN') and (PageName = 'GETSSREPORTXMLAJAX') then begin //2018-04-11 jtm F#3540
      if not PaymentPortalCustomerAuthenticate then exit;
      Response.ContentType := 'text/xml';
      Response.Content := GetSSReportXMLAjax(Request.QueryFields,Request.ContentFields,RNID);
      FreeAndNil(ttSSReporting);
      Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'CREATESSREPORTSCHEDAJAX') then begin
      if not PaymentPortalCustomerAuthenticate then exit;
      Response.Content := CreateSSReportSchedAjax(Request.QueryFields,Request.ContentFields,RNID);
      Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'GETSCHEDULEDSSREPORTAJAX') then begin
      if not PaymentPortalCustomerAuthenticate then exit;
      Response.Content := GetScheduledSSReportAjax(Request.QueryFields, Request.ContentFields, RNID);
      Response.ContentType := 'application/xml';
      Exit;
   end;
      If (CustomerMembType = 'ADMIN') and (PageName = 'GETSCHEDULEDSSREPORTRUNSAJAX') then begin
      if not PaymentPortalCustomerAuthenticate then exit;
      Response.Content := GetScheduledSSReportRunsAjax(Request.QueryFields,Request.ContentFields,RNID);
      Response.ContentType := 'application/xml';
      Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'DELETESCHEDULESSREPORTAJAX') then begin
      if not PaymentPortalCustomerAuthenticate then exit;
      Response.Content := DeleteScheduleSSReportAjax(Request.QueryFields,Request.ContentFields,RNID);
      Exit;
   end;
   If PageName = 'CONFIRMACCOUNT' then begin
      Email := Trim(Request.queryfields.Values['EMAIL']);
      EMail := ValidCharsOnly(Email,True,True,'_.-#@+/');
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from Customers where (StoreCode = '+RNID + ') and (Email = ''' + email + ''')');
      RNQuery.Open;
      If RNQuery.RecordCount > 0 then begin
         WS := ValidCharsOnly(Request.queryfields.Values['CONFIRMGUID'],TRUE,True,'-');
         If (Trim(RNQuery.FieldByName('ConfirmGUID').AsString) = WS) or
            (Trim(RNQuery.FieldByName('ConfirmGUID').AsString) = 'VALIDATED') then begin
            RNQuery.EDIT;
            RNQuery.FieldByName('ConfirmGUID').AsString := 'VALIDATED';
            RNQuery.Post;
            response.Content := LoadWebFile('account_verification.htm');
            exit;
         end;

         WS := LoadWebFileFromFolder('welcome.htm','');
         ReplaceString(WS, '%ERROR%', '<BR><B>Account Not Validated</B>');
         response.Content :=WS;
      end else begin
         WS := LoadWebFileFromFolder('welcome.htm','');
         ReplaceString(WS, '%ERROR%', '<BR><B>Account Not Validated</B>');
         response.Content :=WS;

      end;
      exit;
   end;

   If PageName = 'PWRESET' then begin
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from Customers where (StoreCode = '+RNID + ') and (CustomerCode = ''' + ValidCharsOnly(Request.queryfields.Values['CUSTIDENT'],TRUE,True,'-') + ''')');
      RNQuery.Open;
      If (RNQuery.RecordCount > 0) and (Date < RNQuery.FieldByName('ResetExpires').AsDateTime) then begin
         WS := GuidOnly(Request.queryfields.Values['RESETGUID']);
         If (Trim(RNQuery.FieldByName('ResetGUID').AsString) = WS) then begin
            RNQuery.EDIT;
            RNQuery.FieldByName('ResetGUID').AsString := GenerateGUID;
            RNQuery.Post;

            WS := LoadWebFile('reset_login.htm');
            DSSubStrings(WS,'EMAIL',RNQuery);
            ReplaceString(WS,'%ERROR%', '');
            ReplaceString(WS,'%POSTURL%', '/PP?PAGE=PWRESETPOST&RESETGUID='+
                                          Trim(RNQuery.FieldByName('ResetGUID').AsString) +
                                          '&CUSTIDENT='+Trim(RNQuery.FieldByName('CustomerCode').AsString));



            response.Content := WS;
            exit;
         end;

         WS := LoadWebFile('default.htm');
         ReplaceString(WS, '%EMAIL%', '');
         ProcessLog(ltWarning,'Invalid Reset Request','LOCAL:'+Trim(RNQuery.FieldByName('ResetGUID').AsString)+'REMOTE:'+ ValidCharsOnly(Request.queryfields.Values['RESETGUID'],TRUE,True,'-'));
         ReplaceString(WS, '%ERROR%', '<B><font color="red">Invalid Reset Request</font></B>');
         response.Content :=WS;
      end else begin
         WS := LoadWebFile('default.htm');
         ReplaceString(WS, '%EMAIL%', '');

         ReplaceString(WS, '%ERROR%', '<B><font color="red">Invalid Reset Request</font></B>');
         response.Content :=WS;

      end;
      exit;
   end;


   If PageName = 'PWRESETPOST' then begin
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from Customers where (StoreCode = '+RNID + ') and (CustomerCode = ''' + GuidOnly(Request.queryfields.Values['CUSTIDENT']) + ''')');
      RNQuery.Open;
      If (RNQuery.RecordCount > 0) and (Date < RNQuery.FieldByName('ResetExpires').AsDateTime) then begin
         WS := ValidCharsOnly(Request.queryfields.Values['RESETGUID'],TRUE,True,'-');
         If (Trim(RNQuery.FieldByName('ResetGUID').AsString) = WS) then begin
            RNQuery.EDIT;
            RNQuery.FieldByName('ResetGUID').AsString := '';
            RNQuery.FieldByName('PWFailureCount').AsInteger := 0;
            RNQuery.FieldByName('LockedUntil').AsDateTime := 0;

            Password := Request.ContentFields.Values['passwordnew'];
            If OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/CASESENSITIVE', 'FALSE') = 'FALSE' then Password := UpCaseString(Password);

            RNQuery.FieldByName('PasswordHash').AsString := '';
            RNQuery.FieldByName('PasswordBcrypt').AsString := BCryptPassword(Trim(Password),trim(RNQuery.FieldByName('CustomerCode').AsString));
            RNQuery.Post;

            WS := LoadWebFile('Default.htm');
            ReplaceString(WS,'%EMAIL%',Trim(RNQuery.FieldByName('Email').AsString));
            ReplaceString(WS,'%ERROR%', '<B><font color="red">Password Changed, Please log in.</B>');



            response.Content := WS;
            exit;
         end;
         WS := LoadWebFile('default.htm');
         ReplaceString(WS, '%EMAIL%', '');
         ProcessLog(ltWarning,'Invalid Reset Request','LOCAL:'+Trim(RNQuery.FieldByName('ResetGUID').AsString)+'REMOTE:'+ ValidCharsOnly(Request.queryfields.Values['RESETGUID'],TRUE,True,'-'));
         ReplaceString(WS, '%ERROR%', '<B><font color="red">Invalid Reset Request</font></B>');
         response.Content :=WS;
      end else begin
         WS := LoadWebFile('default.htm');
         ReplaceString(WS, '%EMAIL%', '');

         ReplaceString(WS, '%ERROR%', '<B><font color="red">Invalid Reset Request</font></B>');
         response.Content :=WS;

      end;
      exit;
   end;

   If PageName = 'USERPWRESET' then begin      //2016-9-19 jtm: Feat OT# 1054
      UserName := ValidCharsOnly(Request.queryfields.Values['CUSTIDENT'],True,True,'_.-');
      If GetRNUser(Username) then begin
         if (UserXMLGetTag('/USERPROFILE/RESET/EXIRES') <> '') and (Date < StrToDateTime(UserXMLGetTag('/USERPROFILE/RESET/EXIRES'))) then begin
            ResetGUID := ValidCharsOnly(Request.queryfields.Values['RESETGUID'],TRUE,True,'-');
            If (Trim(UserXMLGetTag('/USERPROFILE/RESET/GUID')) = ResetGUID) then begin
               ResetGUID := GenerateGUID;
               UserXMLSetTag('/USERPROFILE/RESET/GUID', ResetGUID);
               WS := LoadWebFile('reset_userlogin.htm');
               ReplaceString(WS,'%USERNAME%', Username);
               ReplaceString(WS,'%ERROR%', '');
               ReplaceString(WS,'%POSTURL%', '/PP?PAGE=USERPWRESETPOST&RESETGUID='+
                                          Trim(ResetGUID) +
                                          '&CUSTIDENT='+Trim(Username));
               SetRNUser(Username);
               response.Content := WS;
               exit;
            end;
            ProcessLog(ltWarning,'Invalid Reset Request','LOCAL:'+Trim(UserXMLGetTag('/USERPROFILE/RESET/GUID'))+'REMOTE:'+ ValidCharsOnly(Request.queryfields.Values['RESETGUID'],TRUE,True,'-'));
         end;
      end;
      WS := LoadWebFile('employee_login.htm');
      ReplaceString(WS, '%ERROR%', '<B><font color="red">Invalid Reset Request</font></B>');
      response.Content :=WS;
      exit;
   end;

   if PageName = 'USERPWRESETPOST' then begin      //2016-9-19 jtm: Feat OT# 1054
      UserName := ValidCharsOnly(Request.queryfields.Values['CUSTIDENT'],True,True,'_.-');
      If GetRNUser(Username) then begin
         if (UserXMLGetTag('/USERPROFILE/RESET/EXIRES') <> '') and (Date < StrToDateTime(UserXMLGetTag('/USERPROFILE/RESET/EXIRES'))) then begin
            ResetGUID := ValidCharsOnly(Request.queryfields.Values['RESETGUID'],TRUE,True,'-');
            If (Trim(UserXMLGetTag('/USERPROFILE/RESET/GUID')) = ResetGUID) then begin

               Password := Request.ContentFields.Values['passwordnew'];
               Password := CardUtil.StringToSHADigestHex(Password);
               PrevPW := TStringList.Create;
               PrevPW.Text := UserQuery.FieldByName('RecentPasswords').AsString;

               If PrevPW.IndexOf(Password) <> -1 then begin
                  WS := LoadWebFile('reset_userlogin.htm');
                  ReplaceString(WS,'%USERNAME%',Trim(Username));
                  ReplaceString(WS,'%ERROR%', 'This password has been used previously, select another.');
                  ReplaceString(WS,'%POSTURL%', '/PP?PAGE=USERPWRESETPOST&RESETGUID='+
                                          Trim(ResetGUID) +
                                          '&CUSTIDENT='+Trim(Username));
                  SetRNUser(Username);
                  response.Content := WS;
                  exit;
               end else begin
                  PrevPW.Insert(0,Password);
                  If PrevPW.Count > 4 then PrevPW.Delete(4);
                  UserQuery.Edit;
                  UserQuery.FieldByName('PasswordHash').AsString := Password;
                  UserQuery.FieldByName('LastPasswordChange').AsDateTime := NOW;
                  UserQuery.FieldByName('RecentPasswords').AsString := PrevPW.Text;
                  UserQuery.FieldByName('LastFailedLogin').AsString := '';
                  UserQuery.FieldByName('FailedLoginCount').AsString := '';
                  UserQuery.FieldByName('LockedOutTill').AsString := '';
                  UserQuery.Post;
                  try
                     EmployeeNode := EmployeeXML.GetNode('/EMPLOYEE/PASSWORDHISTORY');
                     EmployeeNode := EmployeeNode.FindFirstChildElement;
                     For iter := 0 to PrevPW.Count -1 do begin
                        If PrevPW[iter] <> '' then begin
                            if (EmployeeNode <> nil) then begin
                               EmployeeXML.EditContextNodeValue(EmployeeNode,PrevPW[iter]);
                               EmployeeNode := EmployeeNode.FindNextSiblingElement;
                            end else begin
                               EmployeeXML.AddChildNode('/EMPLOYEE/PASSWORDHISTORY','HISTORICALPASSWORDHASH',PrevPW[iter]);
                            end;
                        end;
                     end;
                  except
                     on E:Exception do begin
                         ProcessLog(ltWarning,'Exception setting HISTORICALPASSWORDHASH',e.message);
                     end;
                  end;

                  PrevPW.Free;
                  EmployeeXMLSetTag('/EMPLOYEE/PASSWORDHASH', Password);
                  WS := LoadWebFile('employee_login.htm');
                  UserXMLSetTag('/USERPROFILE/RESET/GUID', '');
                  if UserXMLGetTag('/USERPROFILE/FIRSTLOGIN') = 'TRUE' then begin
                     UserXMLSetTag('/USERPROFILE/FIRSTLOGIN','FALSE');
                  end;
                  ReplaceString(WS,'%ERROR%', '<B><font color="red">Password Changed, Please log in.</font></B>');
                  if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PWCHANGE/SENDEMAIL', 'FALSE') = 'TRUE') and (email <> '') then
                     SendCustomerEmail(email, 'PWChanged.htm', OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PWCHANGE/EMAILSUBJECT','Password Changed'),OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PWCHANGE/EMAILBCC',''),OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PWCHANGE/EMAILREPLYTO',''));

                  SetRNUser(Username);
                  response.Content := WS;
                  exit;
               end;
            end;
            ProcessLog(ltWarning,'Invalid Reset Request','LOCAL:'+Trim(UserXMLGetTag('/USERPROFILE/RESET/GUID'))+'REMOTE:'+ ValidCharsOnly(Request.queryfields.Values['RESETGUID'],TRUE,True,'-'));
         end;
      end;
      WS := LoadWebFile('employee_login.htm');
      ReplaceString(WS, '%ERROR%', '<B><font color="red">Invalid Reset Request</font></B>');
      response.Content :=WS;
      exit;
   end;
   If PageName = 'NOJS' then begin
      WS := LoadWebFile('nojs.htm');
      response.Content := WS;
      exit;
   end;
   If PageName = 'GETBANKNAME' then begin
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from fedach where (Routingnumber = '''+NumericOnly(Request.queryfields.Values['ROUTINGNUM'])+ ''')');
      RNQuery.Open;
      If (RNQuery.RecordCount > 0) then begin
         response.Content := Trim(RNQuery.FieldByName('CustomerName').AsString);
      end else begin
         response.Content := 'BANK NOT FOUND';
      end;
      RNQuery.Close;
      exit;
   end;

   if not PaymentPortalCustomerAuthenticate then exit;

   if PageName = 'GETPROFILEAJAX' then begin
      Response.Content := GetProfileAjax(Request.QueryFields,Request.ContentFields,RNID);
      exit;
   end else if PageName = 'ADDCHILDACCOUNTAJAX' then begin
      Response.Content := AddChildAccountAjax(Request.QueryFields,Request.ContentFields,RNID);
      exit;
   end else if PageName = 'GETCHILDACCOUNTSAJAX' then begin
      Response.Content := GetChildAccountsAjax(Request.QueryFields,Request.ContentFields,RNID);
      exit;
   end else if PageName = 'DELETECHILDACCOUNTAJAX' then begin
      Response.Content := DeleteChildAccountAjax(Request.QueryFields,Request.ContentFields,RNID);
      exit;
   end else if PageName = 'GETPAYMENTMETHODSAJAX' then begin
      Response.Content := GetPaymentMethodsAjax(Request.QueryFields,Request.ContentFields,RNID);
      exit;
   end else if PageName = 'GETPAYMENTHISTORYAJAX' then begin
      Response.Content := GetPaymentHistoryAjax(Request.QueryFields,Request.ContentFields,RNID);
      exit;
   end else if PageName = 'GETAUTOMATEDPAYMENTSAJAX' then begin
      Response.Content := GetAutomatedPaymentsAjax(Request.QueryFields,Request.ContentFields,RNID);
      exit;
   end else if PageName = 'ADDAUTOMATEDPAYMENTAJAX' then begin
      Response.Content := AddAutomatedPaymentAjax(Request.QueryFields,Request.ContentFields,RNID);
      exit;
   end else if PageName = 'DELETEAUTOMATEDPAYMENTAJAX' then begin
      Response.Content := DeleteAutomatedPaymentAjax(Request.QueryFields,Request.ContentFields,RNID);
      exit;
   end else if PageName = 'GETBILLINGINFORMATIONAJAX' then begin
      Response.Content := GetBillingInformationAjax(Request.QueryFields,Request.ContentFields,RNID);
      exit;
   end else if PageName = 'GETACCOUNTINFORMATIONAJAX' then begin
      Response.Content := GetAccountInformationAjax(Request.QueryFields,Request.ContentFields,RNID);
      exit;
   end else if PageName = 'EDITACCOUNTINFORMATIONAJAX' then begin
      Response.Content := EditAccountInformationAjax(Request.QueryFields,Request.ContentFields,RNID);
      exit;
   end else if PageName = 'EDITACCOUNTPWAJAX' then begin
      Response.Content := EditAccountPWAjax(Request.QueryFields,Request.ContentFields,RNID);
      exit;
   end else if PageName = 'UPDATEACCOUNTAJAX' then begin
      Response.Content := UpdateAccountAjax(Request.QueryFields,Request.ContentFields,RNID);
      exit;
   end else if PageName = 'PROCESSPAYMENTAJAX' then begin
      Response.Content := ProcessPaymentAjax(Request.QueryFields,Request.ContentFields,RNID);
      exit;
   end;

   If (PageName = 'GETSERVICENAMESAJAX') and (CustomerMembType = 'ADMIN') then begin  //2017-05-10 jtm F#1565
      WS2 := NumericOnly(Request.queryfields.Values['LOCATIONRNID']);
      ProcessLog(ltInfo,'GETSERVICENAMESAJAX LocationRNID:', WS2);
      if (Not ValidateRNID(WS2)) then begin
         Response.Content := 'INVALID RNID';
         exit;
      end;
      if GuidOnly(Request.QueryFields.Values['USERGUID']) <> '' then begin //2017-05-24 jtm: F#1568
         ProcessLog(ltInfo,'GETSERVICENAMESAJAX UserGUID:', GuidOnly(Request.QueryFields.Values['USERGUID']));
         WS := GetServiceNamesByUser(WS2,'',ValidCharsOnly(Request.queryfields.Values['DISPLAYFORMAT'],true,true,''),GuidOnly(Request.QueryFields.Values['USERGUID']));
      end else begin
         if (ValidCharsOnly(Request.queryfields.Values['REPORT'],true,false,'')='TRUE') then begin //2017-09-25 jtm: D#1963
            WS := GetServiceNamesDropDown(WS2,'',ValidCharsOnly(Request.queryfields.Values['ID'],true,true,''),(ValidCharsOnly(Request.queryfields.Values['ALL'],true,false,'')='TRUE'),(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/NOREADONLYLOCATIONS','FALSE') = 'TRUE'));
         end else begin
            WS := GetServiceNamesDropDown(WS2,'',ValidCharsOnly(Request.queryfields.Values['ID'],true,true,''),(ValidCharsOnly(Request.queryfields.Values['ALL'],true,false,'')='TRUE'),(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/NOREADONLYLOCATIONS','FALSE') = 'TRUE'));
         end;
      end;
      Response.Content := WS;
      Exit;
   end;
   If (PageName = 'GETVTTRANTYPEAJAX') and (CustomerMembType = 'ADMIN') then begin  //2018-03-01 ajs: D#3923
      Response.Content := GetVTTranTypeAjax(Request.QueryFields, Request.ContentFields);
      Exit;
   end;
   If (PageName = 'GETCUSTOMERPAYMENTSONFILE') and (CustomerMembType = 'ADMIN') then begin
      WS := GuidOnly(Request.queryfields.Values['CUSTGUID']);
      if WS <> '' then begin
         response.Content := GenerateCustomerPaymentsOnFileAdmin(WS);
      end else begin
         response.Content := '<B>* No Customer Payments on File *</B>';
      end;
      Exit;
   end;
   If (PageName = 'GETCUSTOMERSUBACCOUNTS') and (CustomerMembType = 'ADMIN') then begin
      ParentGUID := GuidOnly(Request.queryfields.Values['CUSTGUID']);
      if ParentGuid <> '' then begin
         WS := LoadWebFileFromFolder('SubAccountsOnFileAjax.htm','PPADMIN');
         ReplaceString(WS,'%CHILDGRID%',GenerateSubAccountsOnFileAdmin(ParentGUID)); //2016-10-27 jtm: Feat OT# 1220
         response.Content := WS;
      end else begin
         response.Content := '<B>* No accounts on File *</B>';
      end;
      Exit;
   end;
   If (PageName = 'REMOVESUBACCOUNTAJAX') and (CustomerMembType = 'ADMIN') then begin      //2016-10-27 jtm: Feat OT# 1220
      ParentGUID := GUIDOnly(Request.queryfields.Values['CUSTGUID']);
      WS2 := GUIDOnly(Request.queryfields.Values['CHILDGUID']);
      ProcessLog(ltInfo,'REMOVESUBACCOUNT',ParentGUID + ' ' + WS2);

      Response.Content := '';
      If (ParentGUID = '') or (WS2='') then exit;
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Update CustChild set hidden = 1 where (CustGUID = '''+ParentGUID + ''') and (ChildGUID = ''' + WS2 + ''')');
      RNQuery.ExecSQL;

      response.Content := GenerateSubAccountsOnFileAdmin(ParentGUID);
      Exit;
   end;


   If (PageName = 'GETCUSTOMERCARDEDITORAJAX') and (CustomerMembType = 'ADMIN') then begin
      WS2 := ValidCharsOnly(Request.queryfields.Values['CUSTGUID'],true,true,'-');
      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERPROFILE/PAYMENTSONFILE/USEMAGTEK','FALSE') = 'TRUE') or (UserXMLGetTag('/USERPROFILE/USEMAGTEK','FALSE') = 'TRUE') then begin
         WS := LoadWebFileFromFolder('add_cardMagtek.htm','PPADMIN')
      end else if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERPROFILE/PAYMENTSONFILE/USEIDTECH','FALSE') = 'TRUE') or (UserXMLGetTag('/USERPROFILE/USEIDTECH','FALSE') = 'TRUE') then begin //2017-08-02 jtm: F#2035
         WS := LoadWebFileFromFolder('add_cardIDTech.htm','PPADMIN')      //2017-07-28 jtm: F#2035
      end else if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERPROFILE/PAYMENTSONFILE/USETATOKEN','FALSE') = 'TRUE') or (UserXMLGetTag('/USERPROFILE/USETATOKEN','FALSE') = 'TRUE') then begin //2017-10-04 ajs: F#2213
         WS := LoadWebFileFromFolder('add_cardTAToken.htm','PPADMIN')      //2017-10-26 ajs: F#2213
      end else begin
         WS := LoadWebFileFromFolder('add_card.htm','PPADMIN');
      end;
      ReplaceString(WS,'%CUSTGUID%',WS2);
      response.Content := WS;
      Exit;
   end;
   If (PageName = 'GETCUSTOMERCHECKEDITORAJAX') and (CustomerMembType = 'ADMIN') then begin
      WS2 := ValidCharsOnly(Request.queryfields.Values['CUSTGUID'],true,true,'-');
      WS := LoadWebFileFromFolder('add_check.htm','PPADMIN');
      ReplaceString(WS,'%CUSTGUID%',WS2);
      response.Content := WS;
      Exit;
   end;
   
   If (PageName = 'EMAILCUSTOMERRECEIPT') and (CustomerMembType = 'ADMIN') then begin //2018-09-12 ajs: DVST-1235
      if Not ValidateRNID(NumericOnly(Request.queryfields.Values['LOCATIONRNID'])) then exit;
      Response.Content :=  EmailReceipt(Request.queryfields.Values['CUSTEMAIL'],NumericOnly(Request.queryfields.Values['LOCATIONRNID']),NumericOnly(Request.queryfields.Values['CCSYSTEMCODE']),GUIDOnly(Request.queryfields.Values['TICKETGUID']),Request.queryfields.Values['TRANTYPE']);
      Exit;
   end;

   If (PageName = 'GETVTCARDAUTHRECEIPTAJAX') and (CustomerMembType = 'ADMIN') then begin
      if Not ValidateRNID(NumericOnly(Request.queryfields.Values['LOCATIONRNID'])) then exit;
      Response.Content := RetrieveReceipt(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),NumericOnly(Request.queryfields.Values['CCSYSTEMCODE']),GUIDOnly(Request.queryfields.Values['TICKETGUID']),'CCRECEIPTRETRIEVE');
      Exit;
   end;
   If (PageName = 'GETVTRECEIPTAJAX') and (CustomerMembType = 'ADMIN') then begin
      if Not ValidateRNID(NumericOnly(Request.queryfields.Values['LOCATIONRNID'])) then exit;
      ws2 := uppercase(alphaonly(Request.queryfields.Values['TYPE']));
      if (ws2='CARD') then begin
         WS := RetrieveReceipt(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),NumericOnly(Request.queryfields.Values['SYSTEMCODE']),ValidCharsOnly(Request.queryfields.Values['TICKETGUID'],true,true,'-'),'CCRECEIPTRETRIEVE');
      end else if (ws2='CHECK') then begin
         WS := RetrieveReceipt(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),NumericOnly(Request.queryfields.Values['SYSTEMCODE']),ValidCharsOnly(Request.queryfields.Values['TICKETGUID'],true,true,'-'),'TCBATCHDETAIL');
      end else if (ws2='CASH') then begin
         WS := RetrieveReceipt(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),NumericOnly(Request.queryfields.Values['SYSTEMCODE']),ValidCharsOnly(Request.queryfields.Values['TICKETGUID'],true,true,'-'),'CASHBATCHDETAIL');
      end;
      Response.Content := ws;
      Exit;
   end;

   If (PageName = 'GETVTCARDBATCHAJAX') and (CustomerMembType = 'ADMIN') then begin
      DisplayFormat := ValidCharsOnly(Request.queryfields.Values['FORMAT'],true,false,'');
      VarEvaluator.AddValue('ServiceName',UpperCase(ValidCharsOnly(Request.queryfields.Values['SERVICENAME'],true,true,'-'))); //2017-05-10 jtm F#1564
      VarEvaluator.AddValue('GatewayRNID', NumericOnly(Request.queryfields.Values['LOCATIONRNID'])); //2018-07-18 bls: F#5061
      EmpIdent := Request.QueryFields.Values['EmpIdent'];

      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USENEWBATCHFUNCTIONS', 'TRUE') <> 'TRUE') AND NOT (DisplayFormat = 'GRID') then begin
         If GetCCBatch(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),'', true) then begin
            if (BatchOXML = NIL) OR (BatchOXML.GetValueAsWideString('/TRANRESP/TRANSUCCESS') <> 'TRUE') then begin //2016-9-19 jtm: Def OT# 1242
               Response.Content := 'There was a problem retrieving the data you requested.';
               Exit;
            end;
         end else begin
            Response.Content := 'There was a problem retrieving the data you requested.';
            Exit;
         end;
      end;

      If DisplayFormat = 'GRID' then begin //2018-06-20 bls: F#840
         try
            if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SHOWCARDDETAILS', 'FALSE') = 'TRUE' then begin //2018-07-18 bls: F#5098
               Response.Content := GetBatchToGRID(true, EmpIdent);
            end else begin
               Response.Content := GetBatchToGRID(Not UserIs('READONLY',NumericOnly(Request.queryfields.Values['LOCATIONRNID'])), EmpIdent);
            end;
         except
            on E: Exception do begin
               Response.Content := 'There was a problem retrieving the data you requested.';
               ProcessLog(ltWarning, 'GETVTCARDBATCHAJAX', E.ClassName + ': ' + E.Message);
            end;
         end;
         if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEJSONFORGRIDS','TRUE') = 'TRUE' then begin //2018-07-18 bls: F#4978
            Response.ContentType := 'application/json';
         end else begin
            Response.ContentType := 'application/xml';
         end;
      end else if DisplayFormat = 'XLS' then begin //2018-06-20 bls: F#2227
         ProcessLog(ltInfo,'Starting Batch XML to XLS', InstanceGUID);

         xExport := TOExport.Create;
         xlsExporter := TOExporterXLT.Create;

         xlsFileName := 'attachment; filename=CardBatch-' + FormatDateTime('YYYYMMDDHHNN',now) + '.xls';
         Response.CustomHeaders.Values['Content-Disposition'] := xlsFileName;
         xlsStream := TMemoryStream.Create();//changed for 1.1.64.2

         if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USENEWBATCHFUNCTIONS', 'TRUE') = 'TRUE' then begin
            xlsFileName := GetBatchToXLS(xExport, DisplayFormat, EmpIdent);
         end else begin
            xlsFileName := BatchXMLToXLS(xExport, DisplayFormat, NumericOnly(Request.queryfields.Values['LOCATIONRNID']));
         end;

         xExport.SaveToStream(xlsStream, xlsExporter);
         xlsStream.Position := 0;

         Response.ContentStream := xlsStream;
         Response.ContentType := 'application/vnd.ms-excel';
         Response.CustomHeaders.Values['Cache-Control'] := 'private';
         Response.CustomHeaders.Values['Pragma'] := 'private';

         xExport.Free;
         xlsExporter.Free;
      end else if DisplayFormat = 'JSON' then begin //2018-06-20 bls: F#2227
         ProcessLog(ltInfo,'Starting Batch XML to JSON', InstanceGUID);

         if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USENEWBATCHFUNCTIONS', 'TRUE') = 'TRUE' then begin
            Response.Content := GetBatchToXLS(nil, DisplayFormat, EmpIdent);
         end else begin
            Response.Content := BatchXMLToXLS(nil, DisplayFormat, NumericOnly(Request.queryfields.Values['LOCATIONRNID']));
         end;

         Response.ContentType := 'application/json';
         Response.CustomHeaders.Values['Cache-Control'] := 'private';
         Response.CustomHeaders.Values['Pragma'] := 'private';
      end else begin //2018-06-20 bls: F#2227
         try
            if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USENEWBATCHFUNCTIONS', 'TRUE') = 'TRUE' then begin
               if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SHOWCARDDETAILS', 'FALSE') = 'TRUE' then begin  //2017-03-22 jtm:  F#1267
                  Response.Content := GetBatchToHTML(true, EmpIdent);
               end else begin
                  Response.Content := GetBatchToHTML(Not UserIs('READONLY',NumericOnly(Request.queryfields.Values['LOCATIONRNID'])), EmpIdent);
               end;
            end else begin
               if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SHOWCARDDETAILS', 'FALSE') = 'TRUE' then begin  //2017-03-22 jtm:  F#1267
                  Response.Content := BatchXMLToHTML(true, NumericOnly(Request.queryfields.Values['LOCATIONRNID']));
               end else begin
                  Response.Content := BatchXMLToHTML(Not UserIs('READONLY',NumericOnly(Request.queryfields.Values['LOCATIONRNID'])), NumericOnly(Request.queryfields.Values['LOCATIONRNID']));
               end;
            end;
         except
            on E:Exception do begin
               Response.Content := 'There was a problem retrieving the data you requested.';
               ProcessLog(ltWarning,'GETVTCARDBATCHAJAX html', E.ClassName + ': ' + E.Message);
            end;
         end;
      end;
      Exit;
   end;

   If (PageName = 'GETVTCHECKBATCHAJAX') and (CustomerMembType = 'ADMIN') then begin    //2016-5-25 jtm
      DisplayFormat := ValidCharsOnly(Request.queryfields.Values['FORMAT'],true,false,'');
      VarEvaluator.AddValue('GatewayRNID', NumericOnly(Request.queryfields.Values['LOCATIONRNID'])); //2018-07-18 bls: F#5061
      EmpIdent := Request.QueryFields.Values['EmpIdent'];

      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USENEWBATCHFUNCTIONS', 'TRUE') <> 'TRUE') AND NOT (DisplayFormat = 'GRID') then begin
         if GetTCBatch(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),'', true) then begin
            if (BatchOXML = NIL) OR (BatchOXML.GetValueAsWideString('/TRANRESP/TRANSUCCESS') <> 'TRUE') then begin
               Response.Content := 'There was a problem retrieving the data you requested.';
               Exit;
            end;
         end else begin
            Response.Content := 'There was a problem retrieving the data you requested.';
            Exit;
         end;
      end;

      If DisplayFormat = 'GRID' then begin //2018-06-20 bls: F#840
         try
            Response.Content := GetCheckBatchToGRID((OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINRECEIPTS/ALLOWCHECKRECEIPTS', 'FALSE')='TRUE'), NumericOnly(Request.queryfields.Values['LOCATIONRNID']), EmpIdent);
         except
            on E: Exception do begin
               Response.Content := 'There was a problem retrieving the data you requested.';
               ProcessLog(ltWarning, 'GETVTCHECKBATCHAJAX Error', E.ClassName + ': ' + E.Message);
            end;
         end;
         if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEJSONFORGRIDS','TRUE') = 'TRUE' then begin //2018-07-18 bls: F#4978
            Response.ContentType := 'application/json';
         end else begin
            Response.ContentType := 'application/xml';
         end;   
      end else if DisplayFormat = 'XLS' then begin //2018-06-20 bls: F#2227
         ProcessLog(ltInfo,'Starting Check Batch XML to XLS',InstanceGUID);

         xExport := TOExport.Create;
         xlsExporter := TOExporterXLT.Create;

         xlsFileName := 'attachment; filename=CheckBatch-' + FormatDateTime('YYYYMMDDHHNN',now) + '.xls';
         Response.CustomHeaders.Values['Content-Disposition'] := xlsFileName;
         xlsStream := TMemoryStream.Create();//changed for 1.1.64.2

         if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USENEWBATCHFUNCTIONS', 'TRUE') = 'TRUE' then begin
            xlsFileName := GetCheckBatchToXLS(xExport, NumericOnly(Request.queryfields.Values['LOCATIONRNID']), DisplayFormat, EmpIdent);
         end else begin
            xlsFileName := CheckBatchXMLToXLS(NumericOnly(Request.queryfields.Values['LOCATIONRNID']), xExport, DisplayFormat);
         end;

         xExport.SaveToStream(xlsStream, xlsExporter);
         xlsStream.Position := 0;

         Response.ContentStream := xlsStream;
         Response.ContentType := 'application/vnd.ms-excel';
         Response.CustomHeaders.Values['Cache-Control'] := 'private';
         Response.CustomHeaders.Values['Pragma'] := 'private';

         xExport.Free;
         xlsExporter.Free;
      end else if DisplayFormat = 'JSON' then begin //2018-06-20 bls: F#2227
         if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USENEWBATCHFUNCTIONS', 'TRUE') = 'TRUE' then begin
            Response.Content := GetCheckBatchToXLS(xExport, NumericOnly(Request.queryfields.Values['LOCATIONRNID']), DisplayFormat, EmpIdent);
         end else begin
            Response.Content := CheckBatchXMLToXLS(NumericOnly(Request.queryfields.Values['LOCATIONRNID']), xExport, DisplayFormat);
         end;   

         Response.ContentType := 'application/json';
         Response.CustomHeaders.Values['Cache-Control'] := 'private';
         Response.CustomHeaders.Values['Pragma'] := 'private';
      end else begin //2018-06-20 bls: F#2227
         ProcessLog(ltInfo,'Starting Check Batch XML to HTML',InstanceGUID);
         try
            if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USENEWBATCHFUNCTIONS', 'TRUE') = 'TRUE' then begin
               Response.Content := GetCheckBatchToHTML((OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINRECEIPTS/ALLOWCHECKRECEIPTS', 'FALSE')='TRUE'),NumericOnly(Request.queryfields.Values['LOCATIONRNID']), EmpIdent);
            end else begin
               Response.Content := CheckBatchXMLToHTML((OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINRECEIPTS/ALLOWCHECKRECEIPTS', 'FALSE')='TRUE'),NumericOnly(Request.queryfields.Values['LOCATIONRNID']));
            end;
         except
            on E: Exception do begin
               Response.Content := E.ClassName + ': ' + E.Message;
            end;
         end;
      end;
      Exit;
   end;

   If (PageName = 'GETVTCASHBATCHAJAX') and (CustomerMembType = 'ADMIN') then begin    //2016-5-25 jtm
      DisplayFormat := ValidCharsOnly(Request.queryfields.Values['FORMAT'],true,false,'');
      VarEvaluator.AddValue('GatewayRNID', NumericOnly(Request.queryfields.Values['LOCATIONRNID'])); //2018-07-18 bls: F#4978
      EmpIdent := Request.QueryFields.Values['EmpIdent'];

      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USENEWBATCHFUNCTIONS', 'TRUE') <> 'TRUE') AND NOT (DisplayFormat = 'GRID') then begin
         If GetCashBatch(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),'', False) then begin
            if (BatchOXML = NIL) OR (BatchOXML.GetValueAsWideString('/TRANRESP/TRANSUCCESS') <> 'TRUE') then begin
               Response.Content := 'There was a problem retrieving the data you requested.';
               Exit;
            end;
         end else begin
            Response.Content := 'There was a problem retrieving the data you requested.';
            Exit;
         end;
      end;

      If DisplayFormat = 'GRID' then begin //2018-06-20 bls: F#840
         try
            Response.Content := GetCashBatchToGRID(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINRECEIPTS/ALLOWCASHRECEIPTS', 'FALSE')='TRUE', EmpIdent);
         except
            on E: Exception do begin
               Response.Content := 'There was a problem retrieving the data you requested.';
               ProcessLog(ltWarning, 'GETVTCASHBATCHAJAX Error', E.ClassName + ': ' + E.Message);
            end;
         end;
         Response.ContentType := 'application/xml';
         Exit;
      end else if DisplayFormat = 'XLS' then begin //2018-06-20 bls: F#2227
         ProcessLog(ltInfo,'Starting Cash Batch XML to XLS',InstanceGUID);

         xExport := TOExport.Create;
         xlsExporter := TOExporterXLT.Create;

         xlsFileName := 'attachment; filename=CashBatch-' + FormatDateTime('YYYYMMDDHHNN',now) + '.xls';
         Response.CustomHeaders.Values['Content-Disposition'] := xlsFileName;
         xlsStream := TMemoryStream.Create();//changed for 1.1.64.2

         if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USENEWBATCHFUNCTIONS', 'TRUE') = 'TRUE' then begin
            xlsFileName := GetCashBatchToXLS(xExport, DisplayFormat, EmpIdent);
         end else begin
            xlsFileName := CashBatchXMLToXLS(xExport, DisplayFormat);
         end;

         xExport.SaveToStream(xlsStream, xlsExporter);
         xlsStream.Position := 0;

         Response.ContentStream := xlsStream;
         Response.ContentType := 'application/vnd.ms-excel';
         Response.CustomHeaders.Values['Cache-Control'] := 'private';
         Response.CustomHeaders.Values['Pragma'] := 'private';

         xExport.Free;
         xlsExporter.Free;
      end else if DisplayFormat = 'JSON' then begin //2018-06-20 bls: F#2227
         if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USENEWBATCHFUNCTIONS', 'TRUE') = 'TRUE' then begin
            Response.Content := GetCashBatchToXLS(xExport, DisplayFormat, EmpIdent);
         end else begin
            Response.Content := CashBatchXMLToXLS(xExport, DisplayFormat);
         end;   

         Response.ContentType := 'application/json';
         Response.CustomHeaders.Values['Cache-Control'] := 'private';
         Response.CustomHeaders.Values['Pragma'] := 'private';
      end else begin //2018-06-20 bls: F#2227
         ProcessLog(ltInfo,'Starting CashBatch XML to HTML',InstanceGUID);

         if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USENEWBATCHFUNCTIONS', 'TRUE') = 'TRUE' then begin
            Response.Content := GetCashBatchToHTML(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINRECEIPTS/ALLOWCASHRECEIPTS', 'FALSE')='TRUE', EmpIdent);
         end else begin
            Response.Content := CashBatchXMLToHTML(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINRECEIPTS/ALLOWCASHRECEIPTS', 'FALSE')='TRUE');
         end;   
      end;
      Exit;
   end;

   If (PageName = 'GETCARDSIGIMAGE') and (CustomerMembType = 'ADMIN') then begin
      WS := GetCCAuthSig(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),NumericOnly(Request.queryfields.Values['CCSYSTEMCODE']));
      Response.ContentType := 'image/jpeg';
      Response.Content := WS;
      Exit;
   end;

   If (PageName = 'GETVTCARDDETAILAJAX') and (CustomerMembType = 'ADMIN') then begin
      Response.Content := GetVTCardDetailAjax(Request.QueryFields, Request.ContentFields);
            Exit;
      end;

   If (PageName = 'CARDFORCEAUTH') and (CustomerMembType = 'ADMIN') then begin //DVST-161
      Response.Content := CardForceAuth(Request.QueryFields, Request.ContentFields);
         Exit;
      end;

   If (PageName = 'VTVOIDCARDAJAX') and (CustomerMembType = 'ADMIN') then begin
      ProcessLog(ltInfo,'Starting VTVOIDCARDAJAX',InstanceGUID);

      Response.Content :=  VoidCC(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),NumericOnly(Request.queryfields.Values['CCSYSTEMCODE']));
      Exit;
   end;
   If (PageName = 'VTREVERSECARDAJAX') and (CustomerMembType = 'ADMIN') then begin
      ProcessLog(ltInfo,'Starting VTREVERSECARDAJAX',InstanceGUID);
      Response.Content :=  ReverseCC(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),NumericOnly(Request.queryfields.Values['CCSYSTEMCODE']));
      Exit;
   end;

   If (PageName = 'VTCARDAJAXPOSTREVERSAL') AND (CustomerMembType = 'ADMIN') then begin //2018-06-20 bls: F#2076
      Response.Content := VTCardAjaxPostReversal(Request.queryfields.Values['LOCATIONRNID'], Request.queryfields.Values['CCSYSTEMCODE']);
      Exit;
   end;

   If (PageName = 'VTISSUECREDITTOSYSTEMCODE') and (CustomerMembType = 'ADMIN') then begin
      VarEvaluator.AddValue('GatewayRNID', NumericOnly(Request.queryfields.Values['LOCATIONRNID'])); //2018-07-18 bls: D#5061
      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEBATCHFIELDSEARCH','FALSE') = 'TRUE') then begin
         BatchFieldNames := TStringList.Create();
         BatchFieldNames.CommaText := ('TRANCUSTOMERCODE,TRANIDENT,CARDNAME,CCSERVICENAME');
         if GetCCBatchFields(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),NumericOnly(Request.queryfields.Values['CCSYSTEMCODE']),BatchFieldNames) then begin
            ProcessLog(ltInfo,'Starting VTISSUECREDITTOSYSTEMCODE',InstanceGUID);
            response.Content := IssueCreditCC(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),NumericOnly(Request.queryfields.Values['CCSYSTEMCODE']), ValuReal(Request.queryfields.Values['AMOUNT']), (Request.queryfields.Values['TRANIDENT']));
            Exit;
         end else begin
            response.Content := 'Credit could not be issued.';
         end;
      end else if GetCCBatch(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),NumericOnly(Request.queryfields.Values['CCSYSTEMCODE']), True) then begin
         ProcessLog(ltInfo,'Starting VTISSUECREDITTOSYSTEMCODE',InstanceGUID);
         response.Content := IssueCreditCC(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),NumericOnly(Request.queryfields.Values['CCSYSTEMCODE']), ValuReal(Request.queryfields.Values['AMOUNT']), (Request.queryfields.Values['TRANIDENT']));
         Exit;
      end else begin
         response.Content := 'Credit could not be issued.';
      end;
      Exit;
   end;

   If (PageName = 'VTISSUEREFUNDTOSYSTEMCODE') and (CustomerMembType = 'ADMIN') then begin //2019-02-14 jtm: DVST-3122
      response.Content := VTIssueRefundToSystemcode(Request.queryfields,Request.ContentFields,RNID);
      Exit;
   end;
   If (PageName = 'VTCHARGEAGAINSYSTEMCODE') and (CustomerMembType = 'ADMIN') then begin
      Response.Content := VTChargeAgainSystemcode(Request.QueryFields, Request.ContentFields);
      Exit;
   end;

   If (PageName = 'VTCARDAJAXPOSTSUCCESS') and (CustomerMembType = 'ADMIN') then begin //2018-06-20 bls: F#2076
      Response.Content := VTCardAjaxPostSuccess(Request.QueryFields);
      Exit;
   end;

   If (PageName = 'VTCARDAJAXPOST') and (CustomerMembType = 'ADMIN') then begin
      response.Content := VTCardAjaxPost(RNID);
      Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'CALCULATESURCHARGE') then begin // DVST-1944
      response.Content := CalculateSurcharge(Request.QueryFields, Request.ContentFields);
      exit;
   end;

   If (PageName = 'GETVTCARDAJAX') and (CustomerMembType = 'ADMIN') then begin
      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/USEMAGTEK','FALSE') = 'TRUE') or (UserXMLGetTag('/USERPROFILE/USEMAGTEK','FALSE') = 'TRUE') then begin
         WS := LoadWebFileFromFolder('CardVTMagtek.htm','PPADMIN')      //2016-8-22 jtm: Feat OT#1053
      end else if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/USEIDTECH','FALSE') = 'TRUE') or (UserXMLGetTag('/USERPROFILE/USEIDTECH','FALSE') = 'TRUE') then begin
         WS := LoadWebFileFromFolder('CardVTIDTech.htm','PPADMIN')      //2017-07-28 jtm: F#2035
      end else if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/USETATOKEN','FALSE') = 'TRUE') or (UserXMLGetTag('/USERPROFILE/USETATOKEN','FALSE') = 'TRUE') then begin //2017-10-04 ajs: F#2213
         WS := LoadWebFileFromFolder('CardVTTAToken.htm','PPADMIN')      //2017-10-26 ajs: F#2213
      end else if (StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/USETATOKENORIDTECH','FALSE'))) then begin //2019-2-13 ss DVST:3129
         WS := LoadWebFileFromFolder('CardVTChooseTATokenOrIDTech.htm','PPADMIN');
      end else begin
         WS := LoadWebFileFromFolder('CardVT.htm','PPADMIN');
      end;

      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/NOREADONLYLOCATIONS', 'FALSE') = 'TRUE') then begin //2017-05-24 jtm: F#1554
         ReplaceString(WS, '%STOREDATA%', GenerateAllLocationReadOnlyOptions(false,true))
      end else begin
         ReplaceString(WS, '%STOREDATA%', GenerateAllSchoolOptions(False,true));
      end;

      response.Content := WS;

      Exit;
   end;
   If (PageName = 'GETVTCHECKDETAILAJAX') and (CustomerMembType = 'ADMIN') then begin
      response.Content := GetVTCheckDetailAjax(Request.QueryFields, Request.ContentFields);
      Exit;
   end;
   If (PageName = 'GETCHECKIMAGE') and (CustomerMembType = 'ADMIN') then begin
      if NumericOnly(Request.queryfields.Values['CHECKCODE']) <> '' then begin
         GetCheckImage;
      end else begin
         response.Content := 'There was a problem retrieving the data you requested.';
      end;

      Exit;
   end;
   If (PageName = 'GETOPENBATCHCHECKIMAGE') and (CustomerMembType = 'ADMIN') then begin
      if NumericOnly(Request.queryfields.Values['CHECKCODE']) <> '' then begin
         GetOpenBatchCheckImage;
      end else begin
         response.Content := 'There was a problem retrieving the data you requested.';
      end;

      Exit;
   end;
   If (PageName = 'GETVTCASHDETAILAJAX') and (CustomerMembType = 'ADMIN') then begin
      VarEvaluator.AddValue('GatewayRNID', NumericOnly(Request.queryfields.Values['LOCATIONRNID'])); //2018-07-18 bls: D#5061
      If (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEBATCHFIELDSEARCH','FALSE') = 'TRUE') then begin
         BatchFieldNames := TStringList.Create();
         BatchFieldNames.CommaText := 'PROFILE,SYSTEMCODE,TICKETGUID,TRANDATE,VOIDED,VOIDEDDATE,TRANAMT,CURRENCYTYPE,TRANTYPE,TRANIDENT,BATCHCODE,CASHSERVICENAME,STATIONIDENT';

         if GetCashBatchFields(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),NumericOnly(Request.queryfields.Values['SYSTEMCODE']), BatchFieldNames) then begin
         ProcessLog(ltInfo,'Starting Cash Batch XML to HTML',InstanceGUID);
         WS := LoadWebFileFromFolder('CashAuthDetails.htm','PPADMIN');
            ReplaceString(WS, '%AUTHDETAIL%', SingleCashBatchXMLToTableHTML);
            ReplaceString(WS, '%LOCATIONRNID%', NumericOnly(Request.queryfields.Values['LOCATIONRNID']));
            ReplaceString(WS, '%SYSTEMCODE%', NumericOnly(Request.queryfields.Values['SYSTEMCODE']));
            response.Content := WS;
            Exit;
         end else begin
            response.Content := 'There was a problem retrieving the data you requested.';
         end;

      end else if GetCashBatch(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),NumericOnly(Request.queryfields.Values['SYSTEMCODE']), True) then begin
         ProcessLog(ltInfo,'Starting Cash Batch XML to HTML',InstanceGUID);
         WS := LoadWebFileFromFolder('CashAuthDetails.htm','PPADMIN');
         ReplaceString(WS, '%AUTHDETAIL%', SingleCashBatchXMLToTableHTML);
         ReplaceString(WS, '%LOCATIONRNID%', NumericOnly(Request.queryfields.Values['LOCATIONRNID']));
         ReplaceString(WS, '%SYSTEMCODE%', NumericOnly(Request.queryfields.Values['SYSTEMCODE']));
         response.Content := WS;
         Exit;
      end else begin
         response.Content := 'There was a problem retrieving the data you requested.';
      end;

      Exit;
   end;
   If PageName = 'STORELOGALL' then begin
      If (CustomerMembType <> 'ADMIN') then begin
         WS := LoadWebFile('default.htm');
         ReplaceString(WS,'%ERROR%', '<B><font color="red">Invalid Admin Credentials</font></B>');
         ReplaceString(WS,'%EMAIL%', '');

         Response.Content := WS;
         Exit;
      end;
      WS := LoadWebFile('storelogAll.htm');

      AdminRNID := NumericOnly(Request.queryfields.Values['RNID']);
      ReplaceString(WS, '%RNID%', AdminRNID);
      If (AdminRNID <> '') and (Not ValidateRNID(AdminRNID)) then begin
         Response.Content := 'INVALID RNID';
         exit;
      end;

      AdminRNID :='<H2>' + StoreName + '<BR>' + StoreAddress1 + '<BR>' + StoreCity + ' ' + StoreState + ' ' + StoreZIP + '<BR></H2>';

      ReplaceString(WS, '%STOREDATA%', GenerateAllSchoolOptions(True, false));
      ReplaceString(WS, '%LOCATIONDATA%', GenerateAllSchoolOptions(false, true)); //2017-03-22 jtm:  D#1461
      ReplaceString(WS,'%HOSTNAME%',UpCaseString(Request.Host));
      If Pos('%HJSCHOOLS%',WS) >0 then begin
         ReplaceString(WS,'%HJSCHOOLS%',GetHJSchoolSelector('',true));
      end;
      If Pos('%CHAINDATA%',WS) >0 then begin     //2016-11-03 jtm Feat OT# 1247
         ReplaceString(WS,'%CHAINDATA%',GenerateChainOptions);
      end;
      If Pos('%REPORTCONFIG%',WS) >0 then begin //2017-10-26 jtm: F#2241
         WS2 := GenerateReportConfigXML();
         ReplaceString(WS,'%REPORTCONFIG%',WS2);
      end;

      response.Content := WS;
      exit;
   end;

   If (PageName = 'ADDCUSTOMERPAYMENTCHEDULEAJAX') and (CustomerMembType = 'ADMIN') then begin

      ParentGUID := GuidOnly(Request.queryfields.Values['CUSTGUID']);
      If ParentGUID = '' then exit;
      AddCustomerPaymentSchedule(RNID,ParentGUID);
      Response.Content := '';
      Exit;
   end;


   If (PageName = 'ADDCUSTOMERSUBACCOUNTAJAX') and (CustomerMembType = 'ADMIN') then begin

      ParentGUID := GuidOnly(Request.queryfields.Values['CUSTGUID']);
      If ParentGUID = '' then exit;
      AddChildToAccount(ParentGUID);

      Response.Content := '';
      Exit;
   end;
   
   If (PageName = 'EDITCUSTOMERSUBACCOUNTAJAX') and (CustomerMembType = 'ADMIN') then begin
      ParentGUID := GuidOnly(Request.queryfields.Values['CUSTGUID']);
      ChildGUID := GuidOnly(Request.queryfields.Values['CHILDGUID']);
      If (ParentGUID = '') and (ChildGUID = '') then exit;
      SaveChildToAccount(ParentGUID, ChildGUID);
      Response.Content := '';
      Exit;
   end;


   If PageName = 'PAYMENTRECEIPT' then begin
      If OpenCustomerQuery then begin
         WS := 'text/html';
         Response.Content := PaymentReceipt(Request.QueryFields, Request.ContentFields, RNID, WS);
         Response.ContentType := WS;
      end;
      Exit;
   end;

    If (CustomerMembType = 'ADMIN') and (PageName = 'GETPORTALCONFIG') then begin
      if not PaymentPortalCustomerAuthenticate then exit;
      Response.Content := GetPortalConfig(Request.QueryFields, Request.ContentFields, RNID);
      Response.ContentType := 'text/xml';
      exit;
   end;

   If (CustomerMembType = 'ADMIN') and (PageName = 'GETDHTMLXFORM') then begin
      if not PaymentPortalCustomerAuthenticate then exit;
      Response.Content := GetDHTMLXForm(Request.QueryFields, Request.ContentFields, RNID);
      Response.ContentType := 'text/javascript';
      exit;
   end;

   If (CustomerMembType = 'ADMIN') and (PageName = 'GETCUSTOMERPROFILE') then begin
      WS2 := GUIDOnly(Request.queryfields.Values['CUSTOMERGUID']);
      If OpenCustomerQueryGUID('',WS2) then begin //Don't pass RNID so that we use chaincode
         WS := LoadWebFileFromFolder('CustomerProfile.htm','PPADMIN');
         DSSubStrings(WS,'FIRSTNAME,LASTNAME,ADDRESS,CITY,ZIP,HPHONE,WPHONE,MOBILEPHONE,EMAIL,HOMEADDRESS2,EMPLOYER,WORKADDRESS1,'+
                      'WORKADDRESS2,WORKCITY,WORKZIP,WORKEXTENSION,ACCOUNTNUMBER,STATE,WORKSTATE,CUSTOM1,CUSTOM2,CUSTOM3,CUSTOM4,CUSTOM5,CUSTOM6,CUSTOM7,CUSTOM8,CUSTOM9,CUSTOM10',RNQuery);

         ReplaceString(WS,'%BALANCEDUE%',Trim(Format('%m',[RNQuery.FieldByName('BALANCEDUE').AsFloat])));
         ReplaceString(WS,'%CUSTGUID%',WS2);
         response.Content := WS;
      end else begin
         Response.Content := 'Customer Account Not Found';
      end;
      Exit;
   end;

   If (CustomerMembType = 'ADMIN') and (PageName = 'GETCUSTOMEREMAILEDITORAJAX') then begin
      WS := LoadWebFileFromFolder('SetCustomerEmailAddress.htm','PPADMIN');
      Response.Content := WS;
      exit;
   end;


   If (CustomerMembType = 'ADMIN') and (PageName = 'SETCUSTEMAIL') then begin
      WS2 := GUIDONLY(Request.queryfields.Values['CUSTGUID']);
      If OpenCustomerQueryGUID('',WS2) then begin
         RNQuery.Edit;
         RNQuery.FieldByName('EMail').AsString := Trim(UpCaseString(Request.ContentFields.Values['EMAILADDRESS']));
         RNQUery.Post;
         Response.Content := 'TRUE';
      end else begin
      end;
      exit;
   end;

   If (CustomerMembType = 'ADMIN') and (PageName = 'GETCUSTOMERPROFILEEDITORAJAX') then begin
      WS2 := ValidCharsOnly(Request.queryfields.Values['CUSTOMERGUID'],true,true,'-');
      If OpenCustomerQueryGUID('',WS2) then begin
         WS := LoadWebFileFromFolder('EditCustomer.htm','PPADMIN');
         DSSubStrings(WS,'FIRSTNAME,LASTNAME,ADDRESS,CITY,ZIP,HPHONE,WPHONE,MOBILEPHONE,EMAIL,HOMEADDRESS2,EMPLOYER,WORKADDRESS1,'+
                      'WORKADDRESS2,WORKCITY,WORKZIP,WORKEXTENSION,ACCOUNTNUMBER,CUSTOM1,CUSTOM2,CUSTOM3,CUSTOM4,CUSTOM5,CUSTOM6,CUSTOM7,CUSTOM8,CUSTOM9,CUSTOM10',RNQuery);

         If Pos('%LOCATIONOPTIONS%',WS) >0 then begin    //2018-08-15 bls: 543
            ReplaceString(WS, '%LOCATIONOPTIONS%', GenerateAllSchoolOptionsWithSelected(false, false, RNQuery.FieldByName('STORECODE').AsInteger));
         end;
         ReplaceString(WS,'%STATE%',HTMLOptionsStateSelected(RNQuery.FieldByName('State').AsString));
         ReplaceString(WS,'%WORKSTATE%',HTMLOptionsStateSelected(RNQuery.FieldByName('WorkState').AsString));
         ReplaceString(WS,'%CUSTGUID%',WS2);
         If Pos('%HJSCHOOLS%',WS) >0 then begin
            ReplaceString(WS,'%HJSCHOOLS%',GetHJSchoolSelector(Trim(RNQuery.FieldByName('AccountNumber').AsString),false));
         end;
         response.Content := WS;
      end else begin
         WS := LoadWebFileFromFolder('Addcustomer.htm','PPADMIN'); //If the customer guid doesn't exist, we're adding
         ReplaceString(WS,'%CUSTGUID%',GenerateGUID);
         If Pos('%HJSCHOOLS%',WS) >0 then begin
            ReplaceString(WS,'%HJSCHOOLS%',GetHJSchoolSelector('',false));
         end;
         If Pos('%LOCATIONOPTIONS%',WS) >0 then begin    //2016-8-22 jtm: Feat OT#1083
            ReplaceString(WS, '%LOCATIONOPTIONS%', GenerateAllSchoolOptions(false, false));
         end;
         Response.Content := WS;

      end;
      Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'GETTRANHISTAJAX') then begin
      WS2 := SetLocationRNIDOrAll(Request.QueryFields);
      VarEvaluator.AddValue('LASTFOUR', NumericOnly(Request.queryfields.Values['LASTFOUR']));
      VarEvaluator.AddValue('ServiceName', UpperCase(ValidCharsOnly(Request.queryfields.Values['SERVICENAME'], true, true, '-')));//2017-05-10 jtm F#1565
      if WS2 = '' then exit;
      if NOT strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/ALLOWALLSEARCH', 'FALSE')) or (WS2 <> 'ALL') then begin //2016-5-25 jtm
         if Not ValidateRNID(WS2) then exit;
      end;

      WS := ValidCharsonly(Request.queryfields.Values['TRANHISTTYPE'], True, False, '');
      If Not ((WS = 'SALE') or (WS = 'AUTH') or (WS = 'VOID') or (WS = 'DEBIT') or (WS = 'CREDIT') or (WS = 'PAYOUT') or (WS = 'CRVOID')) then WS := '';

      ProcessLog(ltinfo,'GETTRANHISTAJAX','Begin GetCardQueryTable RNID: ' + WS2);
      DisplayFormat := Request.queryfields.Values['FORMAT'];

      try
         if DisplayFormat = 'XLS' then begin
            xlsFileName :=  'attachment; filename=TransactionHistory-' + FormatDateTime('YYYYMMDDHHNNSS',now) + '.xls';
            Response.CustomHeaders.Values['Content-Disposition'] := xlsFileName;

            Response.ContentType := 'application/vnd.ms-excel';
            Response.CustomHeaders.Values['Cache-Control'] := 'private';
            Response.CustomHeaders.Values['Pragma'] := 'private';

            if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEOLDXLSFORMAT', 'FALSE')) OR
               strtobool(RNReg.RegGetValAsString('PMACCESS.USEOLDXLSFORMAT','FALSE')) then begin

               Response.Content := GetCardQueryTable(WS2,
                               QueryDate('TranHistFrom'),
                               QueryDate('TranHistThru'),
                               0,
                               '',
                               WS,
                               '',
                               'XLS',
                               Request.queryfields.Values['TRANHISTSETTLEMENTSTATUS'] = 'SETTLED', false, false, xExport, false, false, false);


            end else begin
               OExportUseCompressedCache := True;
               xExport := TOExport.Create;
               xlsExporter := TOExporterXLT.Create;
               xlsStream := TMemoryStream.Create();//changed for 1.1.64.2

               GetCardQueryTable(WS2,
                                  QueryDate('TranHistFrom'),
                                  QueryDate('TranHistThru'),
                                  0,
                                  '',
                                  WS,
                                  '',
                                  'XLS',
                                  Request.queryfields.Values['TRANHISTSETTLEMENTSTATUS'] = 'SETTLED', false, false, xExport, false, false, false);

               xExport.SaveToStream(xlsStream, xlsExporter);
               xlsStream.Position := 0;

               Response.ContentStream := xlsStream;

               xExport.Free;
               xlsExporter.Free;
               OExportUseCompressedCache := False;
            end;
         end else if DisplayFormat = 'JSON' then begin
            Response.Content := GetCardQueryTable(WS2,
                               QueryDate('TranHistFrom'),
                               QueryDate('TranHistThru'),
                               0,
                               '',
                               WS,
                               '',
                               'JSON',
                               Request.queryfields.Values['TRANHISTSETTLEMENTSTATUS'] = 'SETTLED', false, false, nil, false, false, false);


            Response.ContentType := 'application/json';
            Response.CustomHeaders.Values['Cache-Control'] := 'private';
            Response.CustomHeaders.Values['Pragma'] := 'private';
         end else if DisplayFormat = 'XML' then begin
           Response.Content := '<?xml version="1.0" encoding="utf-8"?><TRANHISTORY>' +
                               GetCardQueryTable(WS2,
                               QueryDate('TranHistFrom'),
                               QueryDate('TranHistThru'),
                               0,
                               '',
                               WS,
                               '',
                               'XML',
                               Request.queryfields.Values['TRANHISTSETTLEMENTSTATUS'] = 'SETTLED', false, false, nil, false, false, false) +    //2017-05-10 jtm F#1564
                               '</TRANHISTORY>';

            Response.ContentType := 'text/xml';
            Response.CustomHeaders.Values['Cache-Control'] := 'private';
            Response.CustomHeaders.Values['Pragma'] := 'private';
         end else if DisplayFormat = 'GRID' then begin
            if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SHOWCARDDETAILS', 'FALSE')) then begin //2018-07-18 bls: F#5098
            Response.Content := GetCardQueryTable(WS2,
                               QueryDate('TranHistFrom'),
                               QueryDate('TranHistThru'),
                               0,
                               '',
                               WS,
                               '',
                               'GRID',
                               Request.queryfields.Values['TRANHISTSETTLEMENTSTATUS'] = 'SETTLED', true, false, nil, false, false, false);
            end else begin
               Response.Content := GetCardQueryTable(WS2,
                                  QueryDate('TranHistFrom'),
                                  QueryDate('TranHistThru'),
                                  0,
                                  '',
                                  WS,
                                  '',
                                  'GRID',
                                  Request.queryfields.Values['TRANHISTSETTLEMENTSTATUS'] = 'SETTLED', Not UserIs('READONLY', WS2), false, nil, false, false, false);
            end;

            if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEJSONFORGRIDS','TRUE')) then begin //2018-07-18 bls: F#4978
               Response.ContentType := 'application/json';
            end else begin
               Response.ContentType := 'text/xml';
            end;
         end else begin

            if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SHOWCARDDETAILS', 'FALSE')) then begin    //2017-03-22 jtm: F#1267
               Response.Content := GetCardQueryTable(WS2, QueryDate('TranHistFrom'), QueryDate('TranHistThru'), 0, '', WS, '', 'AJAX', Request.queryfields.Values['TRANHISTSETTLEMENTSTATUS'] = 'SETTLED', true, false, nil, false, false, false); //2017-05-10 jtm F#1564
            end else begin
               Response.Content := GetCardQueryTable(WS2,
                                  QueryDate('TranHistFrom'),
                                  QueryDate('TranHistThru'),
                                  0,
                                  '',
                                  WS,
                                  '',
                                  'AJAX',
                                  Request.queryfields.Values['TRANHISTSETTLEMENTSTATUS'] = 'SETTLED', Not UserIs('READONLY', WS2), false, nil, false, false, false); //2017-05-10 jtm F#1564
            end;
         end;
      except
         on E: Exception do begin
            Response.Content := 'Error retrieving data';
            ProcessLog(ltWarning, 'Exception on GETTRANHISTAJAX', E.Message);
         end;
      end;
      Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'GETTRANHISTXMLAJAX') then begin
      WS2 := NumericOnly(Request.queryfields.Values['LOCATIONRNID']);

      VarEvaluator.AddValue('LASTFOUR', NumericOnly(Request.queryfields.Values['LASTFOUR']));
      if WS2 = '' then exit;
      if Not ValidateRNID(WS2) then exit;
      WS := ValidCharsonly(Request.queryfields.Values['TRANHISTTYPE'],True,False,'');
      If Not ((WS = 'SALE') or (WS='AUTH') or (WS='VOID') or (WS='DEBIT') or (WS='CREDIT')) then
         WS := '';

      if Request.queryfields.Values['FORMAT'] = 'XLS' then begin
        Response.Content := GetCardQueryTableXML(WS2,
                            QueryDate('TranHistFrom'),
                            QueryDate('TranHistThru'),
                            0,
                            '',
                            WS,
                            '',
                            'XLS',
                            Request.queryfields.Values['TRANHISTSETTLEMENTSTATUS'] = 'SETTLED',false);

         Response.ContentType := 'text/csv';
         Response.CustomHeaders.Values['Cache-Control'] := 'private';
         Response.CustomHeaders.Values['Pragma'] := 'private';
         Exit;
      end else if Request.queryfields.Values['FORMAT'] = 'XML' then begin
        Response.Content := GetCardQueryTableXML(WS2,
                            QueryDate('TranHistFrom'),
                            QueryDate('TranHistThru'),
                            0,
                            '',
                            WS,
                            '',
                            'XML',
                            Request.queryfields.Values['TRANHISTSETTLEMENTSTATUS'] = 'SETTLED',false);

         Response.ContentType := 'text/xml';
         Response.CustomHeaders.Values['Cache-Control'] := 'private';
         Response.CustomHeaders.Values['Pragma'] := 'private';
         Exit;
      end;

      Response.Content := 'Test';
      Exit;
   end;


   If (CustomerMembType = 'ADMIN') and (PageName = 'GETCHECKHISTAJAX') then begin
      WS2 := SetLocationRNIDOrAll(Request.QueryFields);
      if WS2 = '' then exit;
      if NOT strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/ALLOWALLSEARCH', 'FALSE')) or (WS2 <> 'ALL') then begin  //2016-5-25 jtm
         if Not ValidateRNID(WS2) then exit;
      end;

      WS := ValidCharsonly(Request.queryfields.Values['CHECKHISTTYPE'], True, true, '');
      If Not ((WS = '0') or (WS = '1') or (WS = '34') or (WS = '01') or (WS = 'VOID')) then WS := '';

      VarEvaluator.AddValue('CHECKHISTTYPE', WS);

      WS := ValidCharsonly(Request.queryfields.Values['TRANHISTTYPE'], True, False, '');
      If Not ((WS = 'SALE') or (WS = 'AUTH') or (WS = 'VOID') or (WS = 'DEBIT') or (WS = 'CREDIT')) then WS := '';

      DisplayFormat := Request.queryfields.Values['FORMAT'];
      if DisplayFormat = '' then DisplayFormat := 'AJAX';

      ProcessLog(ltinfo, 'GETCHECKHISTAJAX', 'Begin GetCheckQueryTable RNID: ' + WS2);

      try
         if (DisplayFormat = 'XLS') OR (DisplayFormat = 'JSON') OR (DisplayFormat = 'XML') then begin
            if DisplayFormat = 'XLS' then begin
               xExport := TOExport.Create;
               xlsExporter := TOExporterXLT.Create;
            end;

            showTheLinks := false;

            Response.CustomHeaders.Values['Cache-Control'] := 'private';
            Response.CustomHeaders.Values['Pragma'] := 'private';
         end else begin
            showTheLinks := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CHECKHISTORYSHOWLINKS', 'TRUE')); //look into what sites need this to be true so we can have it off by default
         end;

         If Request.queryfields.Values['SHOWALL'] = 'TRUE' then begin
            Res := GetCheckQueryTable(WS2,
                       QueryDate('TranHistFrom'),
                       QueryDate('TranHistThru'),
                       0,
                       Trim(Request.queryfields.Values['STATIONIDENT']),
                       Trim(Request.queryfields.Values['SERVICENAME']),
                       DisplayFormat, showTheLinks, Request, xExport, false, true, true);
         end else begin
            Res := GetCheckQueryTable(WS2,
                       QueryDate('TranHistFrom'),
                       QueryDate('TranHistThru'),
                       0,
                       Trim(Request.queryfields.Values['STATIONIDENT']),
                       Trim(Request.queryfields.Values['SERVICENAME']),
                       DisplayFormat, showTheLinks, Request, xExport, false);
         end;

         if DisplayFormat <> 'XLS' then begin
            Response.Content := Res;
         end else begin
            xlsFileName :=  'attachment; filename=CheckHistory-' + FormatDateTime('YYYYMMDDHHNNSS', now) + '.xls';
            Response.CustomHeaders.Values['Content-Disposition'] := xlsFileName;
            Response.ContentType := 'application/vnd.ms-excel';

            if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEOLDXLSFORMAT', 'FALSE')) OR
               strtobool(RNReg.RegGetValAsString('PMACCESS.USEOLDXLSFORMAT', 'FALSE')) then begin

               Response.Content := Res;
            end else begin
               xlsStream := TMemoryStream.Create(); //changed for 1.1.64.2

               xExport.SaveToStream(xlsStream, xlsExporter);
               xlsStream.Position := 0;

               Response.ContentStream := xlsStream;

               xExport.Free;
               xlsExporter.Free;
            end;
         end;

         if DisplayFormat = 'JSON' then begin
            Response.ContentType := 'application/json';
         end else if DisplayFormat = 'GRID' then begin
            Response.ContentType := 'application/xml';
         end else if DisplayFormat = 'XML' then begin
            Response.ContentType := 'text/xml';
         end;
      except
         on E:Exception do begin
            Response.Content := 'Error retrieving data';
            ProcessLog(ltWarning, 'Exception on GETCHECKHISTAJAX', E.Message);
         end;
      end;
      Exit;
   end;

   If (CustomerMembType = 'ADMIN') and (PageName = 'GETCASHHISTAJAX') then begin  //2016-8-22 jtm: Feat OT#1028
      WS2 := SetLocationRNIDOrAll(Request.QueryFields);
      if WS2 = '' then exit;
      if NOT strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/ALLOWALLSEARCH', 'FALSE')) or (WS2 <> 'ALL') then begin
         if Not ValidateRNID(WS2) then exit;
      end;

      WS := ValidCharsonly(Request.queryfields.Values['CASHCURTYPE'], True, false, '');
      If Not ((WS = 'CASH') or (WS='VOUCHER')) then WS := '';
      VarEvaluator.AddValue('CASHCURTYPE', WS);

      WS := ValidCharsonly(Request.queryfields.Values['CASHHISTTYPE'], True, False, '');
      If Not ((WS = 'SALE') or (WS='REFUND') or (WS = 'VOID')) then WS := '';

      ProcessLog(ltinfo,'GETCASHHISTAJAX', 'Begin GetCashQueryTable RNID: ' + WS2);

      DisplayFormat := Request.queryfields.Values['FORMAT'];
      if DisplayFormat = '' then DisplayFormat := 'AJAX';

      try
         if (DisplayFormat = 'GRID') OR (DisplayFormat = 'HTML') OR (DisplayFormat = 'AJAX') then begin
            Response.Content := GetCashQueryTable(WS2, QueryDate('TranHistFrom'), QueryDate('TranHistThru'), 0, '', WS, '',
                                                            DisplayFormat,
                                                            strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CASHHISTORYSHOWLINKS', 'FALSE')), nil);
         end else begin
            if DisplayFormat = 'XLS' then begin
               xExport := TOExport.Create;
            end;

            Response.Content := GetCashQueryTable(WS2, QueryDate('TranHistFrom'), QueryDate('TranHistThru'), 0, '', WS, '', DisplayFormat, false, xExport); //Test this!!!
            Response.CustomHeaders.Values['Cache-Control'] := 'private';
            Response.CustomHeaders.Values['Pragma'] := 'private';
         end;

         if DisplayFormat = 'XLS' then begin
            xlsExporter := TOExporterXLT.Create;

            xlsFileName := 'attachment; filename=CashHistory-' + FormatDateTime('YYYYMMDDHHNNSS',now) + '.xls';
            Response.CustomHeaders.Values['Content-Disposition'] := xlsFileName;
            xlsStream := TMemoryStream.Create();//changed for 1.1.64.2

            xExport.SaveToStream(xlsStream, xlsExporter);
            xlsStream.Position := 0;

            Response.ContentStream := xlsStream;
            Response.ContentType := 'application/vnd.ms-excel';

            xExport.Free;
            xlsExporter.Free;
         end else if DisplayFormat = 'JSON' then begin
            Response.ContentType := 'application/json';
         end else if DisplayFormat = 'GRID' then begin
            Response.ContentType := 'application/json';
         end;

         ProcessLog(ltinfo,'GETCASHHISTAJAX','End GetCashQueryTable RNID: ' + WS2);
      except
         on E:Exception do begin
            Response.Content := 'Error retrieving data';
            ProcessLog(ltWarning, 'Exception on GETCASHHISTAJAX', E.Message);
         end;
      end;
      Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'GETDRAWERHISTAJAX') then begin    //2016-5-25 jtm
      WS2 := NumericOnly(Request.queryfields.Values['LOCATIONRNID']);

      if (WS2 = '') and (Request.queryfields.Values['LOCATIONRNID'] ='ALL') then WS2 := 'ALL';   //2016-06-22 jtm
      if WS2 = '' then exit;
      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/ALLOWALLSEARCH', 'FALSE') = 'TRUE') and (WS2 = 'ALL') then begin  //2016-06-22 jtm
      end else begin
         if Not ValidateRNID(WS2) then exit;
      end;
      if Request.queryfields.Values['DISPLAYFORMAT'] = 'XML' then begin
         WS := GetDrawerQueryTable(WS2,QueryDate('DrawerHistFrom'),QueryDate('DrawerHistThru'),'XML');
         Response.ContentType := 'text/xml';
         Response.CustomHeaders.Values['Cache-Control'] := 'private';
         Response.CustomHeaders.Values['Pragma'] := 'private';
      end;


      Response.Content := WS;
      Exit;
    end;
    If (CustomerMembType = 'ADMIN') and (PageName = 'DOWNLOADDRAWERREPORT') then begin
      WS2 := NumericOnly(Request.queryfields.Values['LOCATIONRNID']);

      if WS2 = '' then exit;
      if Not ValidateRNID(WS2) then exit;
      Try
         ProfileXML := TTProfileXML.Create(StrToInt(WS2), HDQuery);
      except
         on E:Exception do begin
            WS := 'Exception loading RNPROFILES '+E.Message;
         end;
      end;

      WS := GetEODShiftReport(WS2,NumericOnly(Request.queryfields.Values['DRAWIDENT']));

      Response.ContentType := 'text/html';
      Response.CustomHeaders.Values['Cache-Control'] := 'private';
      Response.CustomHeaders.Values['Pragma'] := 'private';
      Response.Content := WS;
      Exit;
    end;
    If (CustomerMembType = 'ADMIN') and (PageName = 'GETDRAWERPROFILE') then begin
      WS2 := NumericOnly(Request.queryfields.Values['LOCATIONRNID']);

      if WS2 = '' then exit;
      if Not ValidateRNID(WS2) then exit;
      Try
         ProfileXML := TTProfileXML.Create(StrToInt(WS2), HDQuery);
      except
         on E:Exception do begin
            WS := 'Exception loading RNPROFILES '+E.Message;
         end;
      end;

      WS := GetDrawerProfile('HTML');

      Response.Content := WS;
      Exit;
    end;
    If (CustomerMembType = 'ADMIN') and (PageName = 'GETDRAWERVARIANCEAPPROVAL') then begin  //2017-11-17 jtm: F#2264
      WS2 := NumericOnly(Request.queryfields.Values['LOCATIONRNID']);

      if WS2 = '' then exit;
      if Not ValidateRNID(WS2) then exit;
      Try
         ProfileXML := TTProfileXML.Create(StrToInt(WS2), HDQuery);
      except
         on E:Exception do begin
            WS := 'Exception loading RNPROFILES '+E.Message;
         end;
      end;

      WS := LoadWebFileFromFolder('AdminApproveDrawer.htm','PPADMIN');
      WS2 := GetDrawerXMLbyDrawerIdent(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),NumericOnly(Request.queryfields.Values['DRAWIDENT']));
      ReplaceString(WS,'%SUBNOTES%', GetXMLTagStr(WS2,'SUBMITTERVARIANCENOTES'));
      WS2 := GetDrawerVarianceReasons('HTML',GetXMLTagStr(WS2,'VARIANCEREASON'));
      ReplaceString(WS,'%VARIANCEREASONS%',WS2);
      ReplaceString(WS,'%DRAWERIDENT%',NumericOnly(Request.queryfields.Values['DRAWIDENT']));
      ReplaceString(WS,'%LOCATIONRNID%',NumericOnly(Request.queryfields.Values['LOCATIONRNID']));


      Response.Content := WS;
      Exit;
    end;
    If (CustomerMembType = 'ADMIN') and (PageName = 'ADMINAPPROVEDRAWAERAJAX') then begin  //2017-11-17 jtm: F#2264
      WS2 := NumericOnly(Request.ContentFields.Values['LOCATIONRNID']);

      if WS2 = '' then exit;
      if (Not ValidateRNID(WS2)) or (NumericOnly(Request.ContentFields.Values['DRAWERIDENT']) = '') then begin
         Response.Content := 'Drawer Not Approved';
         exit;
      end;
      try
         ConnectionString := FRegistry.ReadString('RetailNet ChainCodes', 'DBConn', '');
         if (ConnectionString = '') then begin
            DrawerAPI := TDrawerAPI.Create(RNDB, ProcessLog, WS2, InstanceGUID, ChainCode);
         end else begin
            DrawerAPIDB := TADOConnection.Create(nil);
            DrawerAPIDB.Connected := false;
            DrawerAPIDB.LoginPrompt := false;
            DrawerAPIDB.ConnectionString := ConnectionString;
            DrawerAPIDB.IsolationLevel := ilReadUncommitted;
            DrawerAPI := TDrawerAPI.Create(DrawerAPIDB, ProcessLog, '', InstanceGUID, ChainCode);
         end;
      Except
         on E:Exception do begin
            ProcessLog(ltWarning,'Exception on DrawerAPI.Create ' + E.Message,InstanceGUID);
         end;
      end;

      EmpIdent := '';
      EmpIdent := SessionVarEval.GetValueAsString('Session.Username');
      if (EmpIdent = '') then EmpIdent := trim(ExternalXMLGetTag('/EXTERNALXML/USERNAME'));
      WS2 := GenerateApproveDrawerXML(NumericOnly(Request.ContentFields.Values['LOCATIONRNID']),EmpIdent,NumericOnly(Request.ContentFields.Values['DRAWERIDENT']),ValidCharsOnly(Request.ContentFields.Values['aprrovalnotes'],true,true,' _-,.()&'),ValidCharsOnly(Request.ContentFields.Values['VARIANCEREASONS'],true,true,' _-,.()&'));
      DrawerAPI.GenerateDrawerResponse(WS2, 'DRAWERCLOSE');
      WS2 := DrawerAPI.XMLResp.Text;
      if (GetXMLTagStr(WS2,'TRANSUCCESS') = 'TRUE') then begin
         WS := 'Drawer Approved';
      end else begin
         WS := 'Drawer Not Approved';
      end;
      Response.Content := WS;
      Exit;
    end;
      If (CustomerMembType = 'ADMIN') and  (PageName = 'EDITCUSTOMERPOST') then begin
         WS2 := GuidOnly(Request.queryfields.Values['CUSTGUID']);
         If OpenCustomerQueryGUID('',WS2) then begin // editing customers
            RNQuery.Edit;
            LoadCustomerFormData(RNQUERY);
            If Request.ContentFields.Values['Email'] <> '' then begin
               RNQuery.FieldByName('Email').AsString := ValidCharsOnly(Request.ContentFields.Values['email'],True,True,'_.-#@+/');
            end;   

            If Trim(NumericOnly(Request.ContentFields.Values['Locations'])) <> '' then begin //2018-08-15 bls: 543
               RNQuery.FieldByName('Storecode').AsString := Trim(NumericOnly(Request.ContentFields.Values['Locations']));
            end;
            Try
               RNQuery.Post;
            except
               ON E:Exception do begin
                  ProcessLog(ltWarning, 'EDITCUSTOMERPOST Exception', E.ClassName + ': ' + E.Message);
               end;
            end;
            RNQuery.Close;

            response.Content := GenerateCustomerProfile(RNID,WS2);
         end else begin  // adding customers
            RNQuery.Insert;
            RNQuery.FieldByName('CustomerCode').AsString := WS2;
            If UserXMLGetTag('/USERPROFILE/PORTALRNID') <> '' then begin
               RNQuery.FieldByName('Storecode').AsString := UserXMLGetTag('/USERPROFILE/PORTALRNID');
            end else if Trim(NumericOnly(Request.ContentFields.Values['Locations'])) <> '' then begin
               RNQuery.FieldByName('Storecode').AsString := Trim(NumericOnly(Request.ContentFields.Values['Locations'])); //2016-8-22 jtm: Feat OT#1083
            end else begin
               RNQuery.FieldByName('Storecode').AsString := RNID;
            end;
            RNQuery.FieldByName('ChainCode').AsInteger := ChainCode;
            RNQuery.FieldByName('StartDate').AsDateTime := Now;
            RNQuery.FieldByName('LastWeblogon').AsDateTime := Now;
            RNQuery.FieldByName('Email').AsString := Trim(UpCaseString(Request.ContentFields.Values['Email']));
            if GetConfigBoolean('REQUIREVALIDATION',True) then begin
                RNQuery.FieldByName('ConfirmGUID').AsString := GenerateGUID;
            end else begin
                RNQuery.FieldByName('ConfirmGUID').AsString := 'VALIDATED';
            end;
            LoadCustomerFormData(RNQUERY);
            Try
               RNQuery.Post;
            except
               ON E:Exception do begin
               end;
            end;
            RNQuery.Close;

            response.Content := GenerateCustomerProfile(RNID,WS2);
         end;
         Exit;
      end;


   if (CustomerMembType = 'ADMIN') and (PageName = 'FETCHPOSITEMLIST') then begin
      ProcessLog(ltinfo,'FETCHPOSITEMLIST','Fetching all items for a given group');
      POSItemXMLReq := TStringList.Create;
      POSItemXMLResp := TStringList.Create;
      POSItemInfo := TStringList.Create;
      POSItemJSONResp := TStringList.Create;
      
      POSItemXMLReq.Append('<TRANSACTION>');
      POSItemXMLReq.Append('   <TRANSACTIONTYPE>GETPOSITEMLIST</TRANSACTIONTYPE>');

      POSItemXMLReq.Append('   <POSITEMGROUPGUID>' + OpenXMLGetTag('/CONFIGDATA/POSITEMSCONFIG/POSITEMGROUPGUID') + '</POSITEMGROUPGUID>');
      POSItemXMLReq.Append('</TRANSACTION>');

      POSTicketAPI.GeneratePOSResponse(POSItemXMLReq.Text, 'GETPOSITEMLIST');
      POSItemXMLResp := POSTicketAPI.XMLResp;

      Response.ContentType := 'application/json';
      Response.CustomHeaders.Values['Cache-Control'] := 'private';
      Response.CustomHeaders.Values['Pragma'] := 'private';

      POSItemJSONResp.Append('{"rows":[');

      POSItemCount := 1;
      POSItemInfo.Text := GetNXMLTagStr(POSItemXMLResp.Text, 'ITEM', POSItemCount);
      while POSItemInfo.Text <> '' do begin
         inc(POSItemCount);

         POSItemJSONResp.Append('{"id":"' + GetXMLTagStr(POSItemInfo.Text,'POSITEMGUID') + '", ' +
                                 '"data":["","' + GetXMLTagStr(POSItemInfo.Text,'SKU') +
                                 '","' + GetXMLTagStr(POSItemInfo.Text,'ALTERNATESKU') +
                                 '","' + GetXMLTagStr(POSItemInfo.Text,'ITEMNAME') +
                                 '","' + GetXMLTagStr(POSItemInfo.Text,'ITEMMANUFACTURER') + '"]}');

         POSItemInfo.Text := GetNXMLTagStr(POSItemXMLResp.Text, 'ITEM', POSItemCount);
         if (POSItemInfo.Text <> '') then begin
             POSItemJSONResp.Append(',');
         end;
      end;

      POSItemJSONResp.Append(']}');

      Response.Content := POSItemJSONResp.Text;

      FreeAndNil(POSItemXMLReq);
      FreeAndNil(POSItemXMLResp);
      FreeAndNil(POSItemInfo);
      FreeAndNil(POSItemJSONResp);
      Exit;
   end;

   if (CustomerMembType = 'ADMIN') and (PageName = 'FETCHPOSITEM') then begin
      ProcessLog(ltinfo,'FETCHPOSITEM','Fetching specific item for a given group');
      POSItemXMLReq := TStringList.Create;
      POSItemXMLResp := TStringList.Create;
      POSItemJSONResp := TStringList.Create;

      POSItemXMLReq.Append('<TRANSACTION>');
      POSItemXMLReq.Append('   <TRANSACTIONTYPE>GETPOSITEM</TRANSACTIONTYPE>');
      POSItemXMLReq.Append('   <POSITEMGROUPGUID>' + OpenXMLGetTag('/CONFIGDATA/POSITEMSCONFIG/POSITEMGROUPGUID') + '</POSITEMGROUPGUID>');
      POSItemXMLReq.Append('   <POSITEMGUID>' + Request.QueryFields.Values['guid'] + '</POSITEMGUID>');
      POSItemXMLReq.Append('</TRANSACTION>');

      POSTicketAPI.GeneratePOSResponse(POSItemXMLReq.Text, 'GETPOSITEM');
      POSItemXMLResp := POSTicketAPI.XMLResp;

      Response.ContentType := 'application/json';
      Response.CustomHeaders.Values['Cache-Control'] := 'private';
      Response.CustomHeaders.Values['Pragma'] := 'private';

      POSItemTaxRateStr := '';
      if (GetXMLTagStr(POSItemXMLResp.Text,'DEFAULTTAXRATE') <> '') then begin
         POSItemTaxRate := ValuReal(GetXMLTagStr(POSItemXMLResp.Text,'DEFAULTTAXRATE')) * 100;
         POSItemTaxRateStr := FloatToStr(POSItemTaxRate);                  
      end;

      POSItemJSONResp.Append('{"item": {"name": "' + EscapeJSONTokens(GetXMLTagStr(POSItemXMLResp.Text,'ITEMNAME')) + '",' +
                                       '"manufacturer": "' + EscapeJSONTokens(GetXMLTagStr(POSItemXMLResp.Text,'ITEMMANUFACTURER')) + '",' +
                                       '"description": "' + EscapeJSONTokens(GetXMLTagStr(POSItemXMLResp.Text,'ITEMDESCRIPTION')) +'",' +
                                       '"defaultCost": "' + GetXMLTagStr(POSItemXMLResp.Text,'DEFAULTCOST') + '",' +
                                       '"defaultRetailPrice": "' + GetXMLTagStr(POSItemXMLResp.Text,'DEFAULTRETAILPRICE') + '",' +
                                       '"defaultTaxable": "' + GetXMLTagStr(POSItemXMLResp.Text,'DEFAULTTAXABLE') + '",' +
                                       '"defaultTaxRate":"' + POSItemTaxRateStr + '",' +
                                       '"glIdent": "' + EscapeJSONTokens(GetXMLTagStr(POSItemXMLResp.Text,'GLIDENT')) + '",' +
                                       '"manufacturerPartNumber": "' + EscapeJSONTokens(GetXMLTagStr(POSItemXMLResp.Text,'MANUFACTURERPARTNUMBER')) + '",' +
                                       '"stockKeepingUnit": "' + GetXMLTagStr(POSItemXMLResp.Text,'SKU') + '",' +
                                       '"altStockKeepingUnit":"' + GetXMLTagStr(POSItemXMLResp.Text,'ALTERNATESKU') + '",' +
                                       '"category": "' + EscapeJSONTokens(GetXMLTagStr(POSItemXMLResp.Text,'CATEGORY')) + '",' +
                                       '"subCategory": "' + EscapeJSONTokens(GetXMLTagStr(POSItemXMLResp.Text,'SUBCATEGORY')) + '",' +
                                       '"binLocation": "' + EscapeJSONTokens(GetXMLTagStr(POSItemXMLResp.Text,'BINLOCATION')) + '",' +
                                       '"department": "' + EscapeJSONTokens(GetXMLTagStr(POSItemXMLResp.Text,'DEPARTMENT')) + '",' +
                                       '"createdBy": "' + EscapeJSONTokens(GetXMLTagStr(POSItemXMLResp.Text,'CREATEDBY')) + '",' +
                                       '"createdOn": "' + EscapeJSONTokens(GetXMLTagStr(POSItemXMLResp.Text,'CREATEDON')) + '",' +
                                       '"updatedBy": "' + EscapeJSONTokens(GetXMLTagStr(POSItemXMLResp.Text,'UPDATEDBY')) + '",' +
                                       '"updatedOn": "' + EscapeJSONTokens(GetXMLTagStr(POSItemXMLResp.Text,'UPDATEDON')) + '"}}');

      Response.Content := POSItemJSONResp.Text;

      FreeAndNil(POSItemXMLReq);
      FreeAndNil(POSItemXMLResp);
      FreeAndNil(POSItemJSONResp);
      Exit;                           
   end;

   if (CustomerMembType = 'ADMIN') and (PageName = 'ADDPOSITEM') then begin
      ProcessLog(ltinfo,'ADDPOSITEM','Adding new item to POSItems');
      POSItemXMLReq := TStringList.Create;
      POSItemXMLResp := TStringList.Create;
      POSItemJSONResp := TStringList.Create;

      POSItemXMLReq.Append('<TRANSACTION>');
      POSItemXMLReq.Append('   <TRANSACTIONTYPE>ADDPOSITEM</TRANSACTIONTYPE>');
      POSItemXMLReq.Append('   <POSITEMGROUPGUID>' + OpenXMLGetTag('/CONFIGDATA/POSITEMSCONFIG/POSITEMGROUPGUID') + '</POSITEMGROUPGUID>');
      POSItemXMLReq.Append('   <ITEMNAME>' + Request.ContentFields.Values['itemName'] + '</ITEMNAME>');
      POSItemXMLReq.Append('   <ITEMMANUFACTURER>' + Request.ContentFields.Values['itemManufacturer'] + '</ITEMMANUFACTURER>');
      POSItemXMLReq.Append('   <ITEMDESCRIPTION>' + Request.ContentFields.Values['itemDescription'] + '</ITEMDESCRIPTION>');
      POSItemXMLReq.Append('   <DEFAULTCOST>' + Request.ContentFields.Values['defaultCost'] + '</DEFAULTCOST>');
      POSItemXMLReq.Append('   <DEFAULTRETAILPRICE>' + Request.ContentFields.Values['defaultRetailPrice'] + '</DEFAULTRETAILPRICE>');
      POSItemXMLReq.Append('   <DEFAULTTAXABLE>' + Request.ContentFields.Values['defaultTaxable'] + '</DEFAULTTAXABLE>');
      POSItemXMLReq.Append('   <DEFAULTTAXRATE>' + Request.ContentFields.Values['defaultTaxRate'] + '</DEFAULTTAXRATE>');
      POSItemXMLReq.Append('   <GLIDENT>' + Request.ContentFields.Values['glIdent'] + '</GLIDENT>');
      POSItemXMLReq.Append('   <MANUFACTURERPARTNUMBER>' + Request.ContentFields.Values['manufacturerPartNumber'] + '</MANUFACTURERPARTNUMBER>');
      POSItemXMLReq.Append('   <SKU>' + Request.ContentFields.Values['sku'] + '</SKU>');
      POSItemXMLReq.Append('   <ALTERNATESKU>' + Request.ContentFields.Values['altSku'] + '</ALTERNATESKU>');
      POSItemXMLReq.Append('   <CATEGORY>' + Request.ContentFields.Values['category'] + '</CATEGORY>');
      POSItemXMLReq.Append('   <SUBCATEGORY>' + Request.ContentFields.Values['subCategory'] + '</SUBCATEGORY>');
      POSItemXMLReq.Append('   <BINLOCATION>' + Request.ContentFields.Values['binLocation'] + '</BINLOCATION>');
      POSItemXMLReq.Append('   <DEPARTMENT>' + Request.ContentFields.Values['department'] + '</DEPARTMENT>');
      POSItemXMLReq.Append('   <EMPIDENT>' + VarEvaluator.GetValueAsString('Session.Username') + '</EMPIDENT>');
      POSItemXMLReq.Append('</TRANSACTION>');

      POSTicketAPI.GeneratePOSResponse(POSItemXMLReq.Text, 'ADDPOSITEM');
      POSItemXMLResp := POSTicketAPI.XMLResp;

      Response.ContentType := 'application/json';
      Response.CustomHeaders.Values['Cache-Control'] := 'private';
      Response.CustomHeaders.Values['Pragma'] := 'private';
      
      if (GetXMLTagStr(POSItemXMLResp.Text, 'TRANSUCCESS') = 'TRUE') then begin
         POSItemJSONResp.Append('{"rows":[{"id":"' + GetXMLTagStr(POSItemXMLResp.Text,'POSITEMGUID') + '", ' +
                                          '"data":["","' + GetXMLTagStr(POSItemXMLResp.Text,'SKU') +
                                          '","' + GetXMLTagStr(POSItemXMLResp.Text,'ALTERNATESKU') +
                                          '","' + GetXMLTagStr(POSItemXMLResp.Text,'ITEMNAME') +
                                          '","' + GetXMLTagStr(POSItemXMLResp.Text,'ITEMMANUFACTURER') + '"]}],"tranSuccess":"true"}');
      end else begin
         POSItemJSONResp.Append('{"item": {"name": "' + EscapeJSONTokens(Request.ContentFields.Values['itemName']) + '",' +
                                          '"manufacturer": "' + EscapeJSONTokens(Request.ContentFields.Values['itemManufacturer']) + '",' +
                                          '"description": "' + EscapeJSONTokens(Request.ContentFields.Values['itemDescription']) +'",' +
                                          '"defaultCost": "' +  Request.ContentFields.Values['defaultCost'] + '",' +
                                          '"defaultRetailPrice": "' +  Request.ContentFields.Values['defaultRetailPrice'] + '",' +
                                          '"defaultTaxable": "' +  Request.ContentFields.Values['defaultTaxable'] + '",' +
                                          '"defaultTaxRate":"' +  Request.ContentFields.Values['defaultTaxRate'] + '",' +
                                          '"glIdent": "' +  EscapeJSONTokens(Request.ContentFields.Values['glIdent']) + '",' +
                                          '"manufacturerPartNumber": "' +  EscapeJSONTokens(Request.ContentFields.Values['manufacturerPartNumber']) + '",' +
                                          '"stockKeepingUnit": "' +  Request.ContentFields.Values['sku'] + '",' +
                                          '"altStockKeepingUnit":"' +  Request.ContentFields.Values['altSku'] + '",' +
                                          '"category": "' +  EscapeJSONTokens(Request.ContentFields.Values['category']) + '",' +
                                          '"subCategory": "' +  EscapeJSONTokens(Request.ContentFields.Values['subCategory']) + '",' +
                                          '"binLocation": "' +  EscapeJSONTokens(Request.ContentFields.Values['binLocation']) + '",' +
                                          '"department": "' +  EscapeJSONTokens(Request.ContentFields.Values['department']) + '"}, "tranSuccess":"false"}');
      end;

      Response.Content := POSItemJSONResp.Text;

      FreeAndNil(POSItemXMLReq);
      FreeAndNil(POSItemXMLResp);
      FreeAndNil(POSItemJSONResp);
      Exit;
   end;

   if (CustomerMembType = 'ADMIN') and (PageName = 'EDITPOSITEM') then begin
      ProcessLog(ltinfo,'EDITPOSITEM','Editing a specific item for a given group');
      POSItemXMLReq := TStringList.Create;
      POSItemXMLResp := TStringList.Create;
      POSItemJSONResp := TStringList.Create;

      POSItemXMLReq.Append('<TRANSACTION>');
      POSItemXMLReq.Append('   <TRANSACTIONTYPE>UPDATEPOSITEM</TRANSACTIONTYPE>');
      POSItemXMLReq.Append('   <POSITEMGROUPGUID>' + OpenXMLGetTag('/CONFIGDATA/POSITEMSCONFIG/POSITEMGROUPGUID') + '</POSITEMGROUPGUID>');
      POSItemXMLReq.Append('   <POSITEMGUID>' + Request.QueryFields.Values['guid'] + '</POSITEMGUID>');
      POSItemXMLReq.Append('   <ITEMNAME>' + Request.ContentFields.Values['itemName'] + '</ITEMNAME>');
      POSItemXMLReq.Append('   <ITEMMANUFACTURER>' + Request.ContentFields.Values['itemManufacturer'] + '</ITEMMANUFACTURER>');
      POSItemXMLReq.Append('   <ITEMDESCRIPTION>' + Request.ContentFields.Values['itemDescription'] + '</ITEMDESCRIPTION>');
      POSItemXMLReq.Append('   <DEFAULTCOST>' + Request.ContentFields.Values['defaultCost'] + '</DEFAULTCOST>');
      POSItemXMLReq.Append('   <DEFAULTRETAILPRICE>' + Request.ContentFields.Values['defaultRetailPrice'] + '</DEFAULTRETAILPRICE>');
      POSItemXMLReq.Append('   <DEFAULTTAXABLE>' + Request.ContentFields.Values['defaultTaxable'] + '</DEFAULTTAXABLE>');
      POSItemXMLReq.Append('   <DEFAULTTAXRATE>' + Request.ContentFields.Values['defaultTaxRate'] + '</DEFAULTTAXRATE>');
      POSItemXMLReq.Append('   <GLIDENT>' + Request.ContentFields.Values['glIdent'] + '</GLIDENT>');
      POSItemXMLReq.Append('   <MANUFACTURERPARTNUMBER>' + Request.ContentFields.Values['manufacturerPartNumber'] + '</MANUFACTURERPARTNUMBER>');
      POSItemXMLReq.Append('   <SKU>' + Request.ContentFields.Values['sku'] + '</SKU>');
      POSItemXMLReq.Append('   <ALTERNATESKU>' + Request.ContentFields.Values['altSku'] + '</ALTERNATESKU>');
      POSItemXMLReq.Append('   <CATEGORY>' + Request.ContentFields.Values['category'] + '</CATEGORY>');
      POSItemXMLReq.Append('   <SUBCATEGORY>' + Request.ContentFields.Values['subCategory'] + '</SUBCATEGORY>');
      POSItemXMLReq.Append('   <BINLOCATION>' + Request.ContentFields.Values['binLocation'] + '</BINLOCATION>');
      POSItemXMLReq.Append('   <DEPARTMENT>' + Request.ContentFields.Values['department'] + '</DEPARTMENT>');
      POSItemXMLReq.Append('   <EMPIDENT>' + VarEvaluator.GetValueAsString('Session.Username') + '</EMPIDENT>');
      POSItemXMLReq.Append('</TRANSACTION>');

      POSTicketAPI.GeneratePOSResponse(POSItemXMLReq.Text, 'UPDATEPOSITEM');
      POSItemXMLResp := POSTicketAPI.XMLResp;

      Response.ContentType := 'application/json';
      Response.CustomHeaders.Values['Cache-Control'] := 'private';
      Response.CustomHeaders.Values['Pragma'] := 'private';

      if (GetXMLTagStr(POSItemXMLResp.Text, 'TRANSUCCESS') = 'TRUE') then begin
         POSItemJSONResp.Append('{"rows":[{"id":"' + GetXMLTagStr(POSItemXMLResp.Text,'POSITEMGUID') + '", ' +
                                          '"data":["","' + GetXMLTagStr(POSItemXMLResp.Text,'SKU') +
                                          '","' + GetXMLTagStr(POSItemXMLResp.Text,'ALTERNATESKU') +
                                          '","' + GetXMLTagStr(POSItemXMLResp.Text,'ITEMNAME') +
                                          '","' + GetXMLTagStr(POSItemXMLResp.Text,'ITEMMANUFACTURER') + '"]}],"tranSuccess":"true"}');
      end else begin
         POSItemJSONResp.Append('{"item": {"guid":"' + Request.QueryFields.Values['guid'] + '",' +
                                          '"name": "' + EscapeJSONTokens(Request.ContentFields.Values['itemName']) + '",' +
                                          '"manufacturer": "' + EscapeJSONTokens(Request.ContentFields.Values['itemManufacturer']) + '",' +
                                          '"description": "' + EscapeJSONTokens(Request.ContentFields.Values['itemDescription']) +'",' +
                                          '"defaultCost": "' +  Request.ContentFields.Values['defaultCost'] + '",' +
                                          '"defaultRetailPrice": "' +  Request.ContentFields.Values['defaultRetailPrice'] + '",' +
                                          '"defaultTaxable": "' +  Request.ContentFields.Values['defaultTaxable'] + '",' +
                                          '"defaultTaxRate":"' +  Request.ContentFields.Values['defaultTaxRate'] + '",' +
                                          '"glIdent": "' +  EscapeJSONTokens(Request.ContentFields.Values['glIdent']) + '",' +
                                          '"manufacturerPartNumber": "' +  EscapeJSONTokens(Request.ContentFields.Values['manufacturerPartNumber']) + '",' +
                                          '"stockKeepingUnit": "' +  Request.ContentFields.Values['sku'] + '",' +
                                          '"altStockKeepingUnit":"' +  Request.ContentFields.Values['altSku'] + '",' +
                                          '"category": "' +  EscapeJSONTokens(Request.ContentFields.Values['category']) + '",' +
                                          '"subCategory": "' +  EscapeJSONTokens(Request.ContentFields.Values['subCategory']) + '",' +
                                          '"binLocation": "' +  EscapeJSONTokens(Request.ContentFields.Values['binLocation']) + '",' +
                                          '"department": "' +  EscapeJSONTokens(Request.ContentFields.Values['department']) + '"}, "tranSuccess":"false"}');
      end;

      Response.Content := POSItemJSONResp.Text;

      FreeAndNil(POSItemXMLReq);
      FreeAndNil(POSItemXMLResp);
      FreeAndNil(POSItemInfo);
      FreeAndNil(POSItemJSONResp);
      Exit;
   end;

   if (CustomerMembType = 'ADMIN') and (PageName = 'DELETEPOSITEM') then begin
      ProcessLog(ltinfo,'EDITPOSITEM','Editing a specific item for a given group');
      POSItemXMLReq := TStringList.Create;
      POSItemXMLResp := TStringList.Create;
      POSItemJSONResp := TStringList.Create;

      POSItemXMLReq.Append('<TRANSACTION>');
      POSItemXMLReq.Append('   <TRANSACTIONTYPE>DELETEPOSITEM</TRANSACTIONTYPE>');
      POSItemXMLReq.Append('   <POSITEMGROUPGUID>' + OpenXMLGetTag('/CONFIGDATA/POSITEMSCONFIG/POSITEMGROUPGUID') + '</POSITEMGROUPGUID>');
      POSItemXMLReq.Append('   <POSITEMGUID>' + Request.ContentFields.Values['guid'] + '</POSITEMGUID>');
      POSItemXMLReq.Append('</TRANSACTION>');

      POSTicketAPI.GeneratePOSResponse(POSItemXMLReq.Text, 'DELETEPOSITEM');
      POSItemXMLResp := POSTicketAPI.XMLResp;

      Response.ContentType := 'application/json';
      Response.CustomHeaders.Values['Cache-Control'] := 'private';
      Response.CustomHeaders.Values['Pragma'] := 'private';

      if (GetXMLTagStr(POSItemXMLResp.Text, 'TRANSUCCESS') = 'TRUE') then begin
         POSItemJSONResp.Append('{"tranSuccess":"true"}');
      end else begin
         POSItemJSONResp.Append('{"tranSuccess":"false"}');
      end;

      Response.Content := POSItemJSONResp.Text;

      FreeAndNil(POSItemXMLReq);
      FreeAndNil(POSItemXMLResp);
      FreeAndNil(POSItemInfo);
      FreeAndNil(POSItemJSONResp);
      Exit;
   end;

   If PageName = 'LOGOUT' then begin

      SessionAuthQuery.Close;
      SessionAuthQuery.SQL.Clear;
      SessionAuthQuery.SQL.Add('Select * from WWWSession where RNSessionID = ''' + RnSessionID + '''');
      SessionAuthQuery.Open;
      SessionAuthQuery.Edit;
      SessionAuthQuery.FieldByName('CustomerSC').AsInteger := 0;
      SessionAuthQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime := 0;
      SessionAuthQuery.FieldByName('MembType').AsString := '';
      SessionAuthQuery.Post;
      SessionAuthQuery.Close;
      If OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/AUTHENTICATIONTYPE') = 'CAS' then begin
         Response.Content := '<head><title>Portal Home</title>' +
                          '<meta http-equiv="refresh" content="0;URL='+OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/CASLOGOUTURL')+'"></head>';
      end else begin
         Response.Content := '<head><title>Portal Home</title>' +
                          '<meta http-equiv="refresh" content="0;URL=/PP"></head>';
      end;
      exit;
   end;

   If PageName = 'ADDCHILD' then begin
      WS := LoadWebFile('add_child.htm');
      ReplaceString(WS, '%SCHOOLOPTIONS%', GenerateAllSchoolOptions(False,false));
      ReplaceString(WS, '%LOCATIONOPTIONS%', GenerateAllLocationsOptions);
      ReplaceString(WS, '%LOCATIONSTATEOPTIONS%', GenerateAllLocationStateOptions);

      response.Content := WS;
      exit;
   end;


   If PageName = 'EDITPROFILE' then begin // TODO: SS DVST-3838 
      If OpenCustomerQuery then begin
         WS := LoadWebFile('edit_account.htm');
         DSSubStrings(WS,'FIRSTNAME,LASTNAME,ADDRESS,CITY,ZIP,HPHONE,WPHONE,MOBILEPHONE,EMAIL,HOMEADDRESS2,EMPLOYER,WORKADDRESS1,'+
                      'WORKADDRESS2,WORKCITY,WORKZIP,WORKEXTENSION,ACCOUNTNUMBER',RNQuery);

         ReplaceString(WS,'%STATE%',HTMLOptionsStateSelected(RNQuery.FieldByName('State').AsString));
         ReplaceString(WS,'%WORKSTATE%',HTMLOptionsStateSelected(RNQuery.FieldByName('WorkState').AsString));
         response.Content := WS;
      end;
      exit;
   end;

   If PageName = 'EDITLOGIN' then begin
      If OpenCustomerQuery then begin
         if((RNQuery.FieldByName('MEMBTYPECODE').AsInteger = 0) And (StrToBool(OpenXMLGetTag('/CONFIGDATA/CHECKEXTCUSTOMERFIRSTLOGON','FALSE')))) then begin // 2019-2-13 ss: DVST-3838
            WS := LoadWebFile('edit_firstLogin.htm');
         end else begin
            WS := LoadWebFile('edit_login.htm');
         end;
         DSSubStrings(WS,'EMAIL',RNQuery);
         ReplaceString(WS,'%ERROR%', '');
         response.Content := WS;
      end;
      exit;
   end;

   If PageName = 'POSTEDITLOGIN' then begin
      ProcessLog(ltDebug, 'PageName = ''POSTEDITLOGIN''', '1');
      Password := Request.ContentFields.Values['passwordold'];
      WS := LoadWebFile('edit_login.htm');
      If OpenCustomerQuery then begin
         ProcessLog(ltDebug, 'PageName = ''POSTEDITLOGIN''', '2');
         DSSubStrings(WS,'EMAIL',RNQuery);
         ProcessLog(ltDebug, 'PageName = ''POSTEDITLOGIN''', '3');
         ParentGUID := Trim(RNQuery.FieldByName('CustomerCode').AsString);
         If OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/CASESENSITIVE', 'FALSE') = 'FALSE' then Password := UpCaseString(Password);

         If (Trim(RNQuery.FieldByName('PasswordBcrypt').asString) = '') and  (Trim(RNQuery.FieldByName('PasswordHash').asString) = StringToSHADigestHex('u.G&ONy@=NYWoKaiJ+_npPv.%Gj' + Trim(Password))) then begin
            ProcessLog(ltDebug, 'PageName = ''POSTEDITLOGIN''', '4');
            Password := Request.ContentFields.Values['passwordnew'];
            If OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/CASESENSITIVE', 'FALSE') = 'FALSE' then Password := UpCaseString(Password);
            RNQuery.Edit;
            RNQuery.FieldByName('PasswordHash').AsString := '';
            RNQuery.FieldByName('PasswordBcrypt').AsString := BCryptPassword(Trim(Password),trim(RNQuery.FieldByName('CustomerCode').AsString));

            if((RNQuery.FieldByName('MEMBTYPECODE').AsInteger = 0) And (StrToBool(OpenXMLGetTag('/CONFIGDATA/CHECKEXTCUSTOMERFIRSTLOGON','FALSE')))) then begin // 2019-2-13 ss: DVST-3838
               RNQuery.FieldByName('MEMBTYPECODE').AsInteger := 1; //after changing the password change this value to so that next time the user is not forced to change passward after first login
               SessionVarEval.AddValue('MEMBTYPECODE',Trim(RNQuery.FieldByName('MEMBTYPECODE').AsString));
            end;
            RNQuery.Post;

            ParentGUID := Trim(RNQuery.FieldByName('CustomerCode').AsString);
            WS := LoadWebFile('profile.htm');
            ReplaceString(WS, '%ERROR%', '<BR><B><font color="red">Password Changed</font></B>');

            DSSubStrings(WS,'EMAIL,FIRSTNAME,LASTNAME,ADDRESS,HOMEADDRESS2,CITY,STATE,ZIP,HPHONE,WPHONE,MOBILEPHONE,EMPLOYER,WORKADDRESS1,WORKADDRESS2,WORKCITY,WORKSTATE,WORKZIP,WORKEXTENSION,ACCOUNTNUMBER',RNQuery);
            ReplaceString(WS,'%CHILDGRID%',GenerateChildGrid(ParentGUID,True));
            ReplaceString(WS,'%PAYMENTGRID%',GeneratePaymentGrid);
            response.Content := WS;
         end else if CheckBCryptPassword(Trim(Password),trim(RNQuery.FieldByName('CustomerCode').AsString),Trim(RNQuery.FieldByName('PasswordBcrypt').asString)) then begin
            ProcessLog(ltDebug, 'PageName = ''POSTEDITLOGIN''', '5');
            Password := Request.ContentFields.Values['passwordnew'];
            If OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/CASESENSITIVE', 'FALSE') = 'FALSE' then Password := UpCaseString(Password);
            RNQuery.Edit;
            RNQuery.FieldByName('PasswordHash').AsString := '';
            RNQuery.FieldByName('PasswordBcrypt').AsString := BCryptPassword(Trim(Password),trim(RNQuery.FieldByName('CustomerCode').AsString));

            if((RNQuery.FieldByName('MEMBTYPECODE').AsInteger = 0) And (StrToBool(OpenXMLGetTag('/CONFIGDATA/CHECKEXTCUSTOMERFIRSTLOGON','FALSE')))) then begin // 2019-2-13 ss: DVST-3838
               RNQuery.FieldByName('MEMBTYPECODE').AsInteger := 1; // after changing the password change this value to so that next time the user is not forced to change passward after first login
               SessionVarEval.AddValue('MEMBTYPECODE',Trim(RNQuery.FieldByName('MEMBTYPECODE').AsString));
            end;
            RNQuery.Post;

            ParentGUID := Trim(RNQuery.FieldByName('CustomerCode').AsString);
            WS := LoadWebFile('profile.htm');
            ReplaceString(WS, '%ERROR%', '<BR><B><font color="red">Password Changed</font></B>');

            DSSubStrings(WS,'EMAIL,FIRSTNAME,LASTNAME,ADDRESS,HOMEADDRESS2,CITY,STATE,ZIP,HPHONE,WPHONE,MOBILEPHONE,EMPLOYER,WORKADDRESS1,WORKADDRESS2,WORKCITY,WORKSTATE,WORKZIP,WORKEXTENSION,ACCOUNTNUMBER',RNQuery);
            ReplaceString(WS,'%CHILDGRID%',GenerateChildGrid(ParentGUID,True));
            ReplaceString(WS,'%PAYMENTGRID%',GeneratePaymentGrid);
            response.Content := WS;
         end else begin
            ProcessLog(ltDebug, 'PageName = ''POSTEDITLOGIN''', '6');
            ReplaceString(WS,'%ERROR%', 'The CURRENT password is not valid.');
            Response.Content := WS;
            exit;
         end;
      end;
      ProcessLog(ltDebug, 'PageName = ''POSTEDITLOGIN''', '7');
      Exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'EDITUSERLOGIN') then begin   //2016-9-19 jtm: Feat OT# 1054
      if UserXMLGetTag('/USERPROFILE/FIRSTLOGIN') = 'TRUE' then
         WS := LoadWebFile('edit_userlogin.htm')
      else
         WS := LoadWebFileFromFolder('EditUserLoginAjax.htm','PPADMIN');
      ReplaceString(WS,'%USERNAME%', Trim(VarEvaluator.GetValueAsString('Session.Username')));
      ReplaceString(WS,'%ERROR%', '');
      response.Content := WS;
      exit;
   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'POSTEDITUSERLOGIN') then begin       //2016-9-19 jtm: Feat OT# 1054
      Password := Request.ContentFields.Values['passwordold'];
      WS := LoadWebFile('edit_userlogin.htm');
      If GetRNUser(Trim(VarEvaluator.GetValueAsString('Session.Username'))) then begin
         if UserXMLGetTag('/USERPROFILE/FIRSTLOGIN') = 'TRUE' then
            WS := LoadWebFile('edit_userlogin.htm')
         else
            WS := LoadWebFileFromFolder('EditUserLoginAjax.htm','PPADMIN');
         ReplaceString(WS,'%USERNAME%', Trim(VarEvaluator.GetValueAsString('Session.Username')));

         If Trim(EmployeeXMLGetTag('/EMPLOYEE/PASSWORDHASH')) = CardUtil.StringToSHADigestHex(Trim(Password)) then begin
            Password := Request.ContentFields.Values['passwordnew'];
            Password := CardUtil.StringToSHADigestHex(Password);
            PrevPW := TStringList.Create;
            PrevPW.Text := UserQuery.FieldByName('RecentPasswords').AsString;
            email := UserQuery.FieldByName('Email').AsString;
            If PrevPW.IndexOf(Password) <> -1 then begin
               ReplaceString(WS,'%ERROR%', 'This password has been used previously, select another.');
               SetRNUser(Trim(VarEvaluator.GetValueAsString('Session.Username')));
               response.Content := WS;
               exit;
            end else begin
               PrevPW.Insert(0,Password);
               If PrevPW.Count > 4 then PrevPW.Delete(4);
               UserQuery.Edit;
               UserQuery.FieldByName('PasswordHash').AsString := Password;
               UserQuery.FieldByName('LastPasswordChange').AsDateTime := NOW;
               UserQuery.FieldByName('RecentPasswords').AsString := PrevPW.Text;
               UserQuery.FieldByName('LastFailedLogin').AsString := '';
               UserQuery.FieldByName('FailedLoginCount').AsString := '';
               UserQuery.FieldByName('LockedOutTill').AsString := '';
               UserQuery.Post;

               try
                  EmployeeNode := EmployeeXML.GetNode('/EMPLOYEE/PASSWORDHISTORY');
                  EmployeeNode := EmployeeNode.FindFirstChildElement;
                  For iter := 0 to PrevPW.Count -1 do begin
                     If PrevPW[iter] <> '' then begin
                         if (EmployeeNode <> nil) then begin
                            EmployeeXML.EditContextNodeValue(EmployeeNode,PrevPW[iter]);
                            EmployeeNode := EmployeeNode.FindNextSiblingElement;
                         end else begin
                            EmployeeXML.AddChildNode('/EMPLOYEE/PASSWORDHISTORY','HISTORICALPASSWORDHASH',PrevPW[iter]);
                         end;
                     end;
                  end;
               except
                  on E:Exception do begin
                      ProcessLog(ltWarning,'Exception setting HISTORICALPASSWORDHASH',e.message);
                  end;
               end;

               PrevPW.Free;
               EmployeeXMLSetTag('/EMPLOYEE/PASSWORDHASH', Password);
               if UserXMLGetTag('/USERPROFILE/FIRSTLOGIN') = 'TRUE' then begin
                   UserXMLSetTag('/USERPROFILE/FIRSTLOGIN','FALSE');
                   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOGINURL') <> '' then
                      WS := '<head><title>Portal Logon</title>' +
                          '<meta http-equiv="refresh" content="0;URL=' + OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOGINURL')+'"></head>';
               end;
               ReplaceString(WS,'%ERROR%', '<B><font color="red">Password Changed!</font></B>');
               if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PWCHANGE/SENDEMAIL', 'FALSE') = 'TRUE') and (email <> '') then
                  SendCustomerEmail(email, 'PWChanged.htm', OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PWCHANGE/EMAILSUBJECT','Password Changed'),OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PWCHANGE/EMAILBCC',''),OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PWCHANGE/EMAILREPLYTO',''));
               SetRNUser(Trim(VarEvaluator.GetValueAsString('Session.Username')));
               response.Content := WS;
               exit;
            end;
         end else begin
            ReplaceString(WS,'%ERROR%', '<font color="red">The CURRENT password is not valid.</font>');

            ProcessLog(ltInfo,'POSTEDITUSERLOGIN','CURRENT password is not valid. Local:' + Trim(EmployeeXMLGetTag('/EMPLOYEE/PASSWORDHASH'))+ ' Remote:'+ CardUtil.StringToSHADigestHex(Trim(Password)));
            Response.Content := WS;
            exit;
         end;
      end else begin
         ReplaceString(WS,'%ERROR%', 'The username is not valid.');
      end;
      Exit;

   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'PROCESSUSERPW') then begin
      Username := ValidCharsOnly(Request.ContentFields.Values['VTUsername'],True,True,'_.-');

      If Username = '' then begin
         response.Content :='<BR><B><font color="red">Invalid Username</font></B>';
         exit;
      end;
      if (UserXMLGetTag('/USERPROFILE/ALLOWADMINPWRESET','FALSE')='TRUE') then begin
         if GetRNUser(Username) then begin
            Email := UserQuery.FieldByName('Email').AsString;
            if Email <> '' then begin
               ResetGUID := GenerateGUID;
               UserXMLSetTag('/USERPROFILE/RESET/GUID',ResetGUID);
               UserXMLSetTag('/USERPROFILE/RESET/EXIRES',DateTimeToStr(NOW + EncodeTime(2,00,0,0)));
               VarEvaluator.AddValue('Username',Username);
               VarEvaluator.AddValue('PostURL','https://'+UpCaseString(Request.Host)+'/PP?PAGE=USERPWRESET&RESETGUID='+ Trim(ResetGUID) + '&CUSTIDENT='+Trim(Username));

               SendCustomerEmail(email, 'UserPWReset.htm', OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PWRESET/EMAILSUBJECT','Password Reset'),OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PWCHANGE/EMAILBCC',''),OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PWCHANGE/EMAILREPLYTO',''));
               SetRNUser(Username);
               response.Content :='<BR><B><font color="red">Password Reset Sent</font></B>';
            end else begin
               response.Content := '<BR><B><font color="red">No Email address on file</font></B>';
            end;
         end else begin
            response.Content := '<BR><B><font color="red">Username not on file</font></B>';
         end;
      end else begin
         response.Content := '<BR><B><font color="red">Username not on file</font></B>';
      end;
      exit;

   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'ACTIVATEUSERPOST') then begin
      if (UserXMLGetTag('/USERPROFILE/ALLOWADMINUSERMANAGEMENT','FALSE')='TRUE') then begin
         EmployeeGUID := GuidOnly(Request.QueryFields.Values['USERGUID']);
         if OpenUserQueryGUID(EmployeeGUID) then begin
            try
               if RNQuery.FieldByName('UserProfile').AsString <> '' then begin
                  SingleUserXMLStr := '<?xml version="1.0" encoding="ISO-8859-1"?><USERPROFILE>' + GetXMLTagStr(RNQuery.FieldByName('UserProfile').AsString,'USERPROFILE') + '</USERPROFILE>';
               end else begin
                  SingleUserXMLStr := '<?xml version="1.0" encoding="ISO-8859-1"?><USERPROFILE></USERPROFILE>';
               end;
               SingleUserXML := TOpenXML.CreateFromString(Nil,SingleUserXMLStr);
            except
               On E:Exception do begin
                  Processlog(ltWarning, 'OpenXMLLoad Exception processing SingleUserXML, User=' +Trim(RNQuery.FieldByName('Username').AsString),E.Message);
                  If Assigned(SingleUserXML) then FreeAndNil(SingleUserXML);
               end;
            end;
            if SingleUserXML <> nil then begin
                XMLSetTag(SingleUserXML,'/USERPROFILE/DEACTIVATED','FALSE');
                RNQuery.Edit;
                RNQuery.FieldByName('UserProfile').AsString := SingleUserXML.DocumentAsString;
                RNQuery.Post;
                WS := 'SUCCESS';
            end else begin
                WS := 'FAILED';
            end;
         end else begin
            WS := 'FAILED';
         end;
         Response.Content := WS;
         Exit;
      end else begin
         response.Content := '<BR><B><font color="red">Unauthorized Access</font></B>';
      end;
      exit;

   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'DEACTIVATEUSERPOST') then begin
      if (UserXMLGetTag('/USERPROFILE/ALLOWADMINUSERMANAGEMENT','FALSE')='TRUE') then begin
         EmployeeGUID := GuidOnly(Request.QueryFields.Values['USERGUID']);
         if OpenUserQueryGUID(EmployeeGUID) then begin
            try
               if RNQuery.FieldByName('UserProfile').AsString <> '' then begin
                  SingleUserXMLStr := '<?xml version="1.0" encoding="ISO-8859-1"?><USERPROFILE>' + GetXMLTagStr(RNQuery.FieldByName('UserProfile').AsString,'USERPROFILE') + '</USERPROFILE>';
               end else begin
                  SingleUserXMLStr := '<?xml version="1.0" encoding="ISO-8859-1"?><USERPROFILE></USERPROFILE>';
               end;
               SingleUserXML := TOpenXML.CreateFromString(Nil,SingleUserXMLStr);
            except
               On E:Exception do begin
                  Processlog(ltWarning, 'OpenXMLLoad Exception processing SingleUserXML, User=' +Trim(RNQuery.FieldByName('Username').AsString),E.Message);
                  If Assigned(SingleUserXML) then FreeAndNil(SingleUserXML);
               end;
            end;
            if SingleUserXML <> nil then begin
                XMLSetTag(SingleUserXML,'/USERPROFILE/DEACTIVATED','TRUE');
                RNQuery.Edit;
                RNQuery.FieldByName('UserProfile').AsString := SingleUserXML.DocumentAsString;
                RNQuery.Post;
                WS := 'SUCCESS';
            end else begin
                WS := 'FAILED';
            end;
         end else begin
            WS := 'FAILED';
         end;
         Response.Content := WS;
         Exit;
      end else begin
         response.Content := '<BR><B><font color="red">Unauthorized Access</font></B>';
      end;
      exit;

    end;
    If (CustomerMembType = 'ADMIN') and (PageName = 'GETUSERSAJAX') then begin
      WS := GetUsersAjax(Request.QueryFields, Request.ContentFields, WS2); // 2019-5-15 SS DVST-702: WS2 = will serve as the var for ContentType in GetUsersAjax
      Response.Content := WS;
      Response.ContentType := WS2;
            Response.CustomHeaders.Values['Cache-Control'] := 'private';
            Response.CustomHeaders.Values['Pragma'] := 'private';
      exit;
         end;

   If (CustomerMembType = 'ADMIN') and (PageName = 'EDITUSERPOST') then begin
      if (UserXMLGetTag('/USERPROFILE/ALLOWADMINUSERMANAGEMENT','FALSE')='TRUE') then begin
         Processlog(ltInfo, 'EDITUSERPOST','Begin');
         Username := UpCaseString(ValidCharsOnly(Request.ContentFields.Values['userName'],True,True,'_.-'));
         EmployeeGUID := GuidOnly(Request.QueryFields.Values['USERGUID']);
         Processlog(ltInfo, 'EDITUSERPOST','Username:'+Username+';EmployeeGUID:'+EmployeeGUID);
         if (EmployeeGUID <> 'ADD') and (EmployeeGUID <> '') and (OpenUserQueryGUID(EmployeeGUID)) then begin
            Processlog(ltInfo, 'EDITUSERPOST','Begin Edit User');
            if (UpCaseString(trim(RNQuery.FieldByName('Username').AsString)) <> trim(Username)) then begin
               Processlog(ltInfo, 'EDITUSERPOST username different check to see if new username exists; DB username;ProvidedUsername', UpCaseString(trim(RNQuery.FieldByName('Username').AsString))+';'+trim(Username));
                if UserNameExists(Username) then begin
                    Response.Content := 'USER EXISTS';
                    Exit;
                end;
            end;
            RNQuery.Edit;
            LoadUserFormData(RNQUERY,Username);
            Try
               RNQuery.Post;
            except
               ON E:Exception do begin
                   Processlog(ltWarning, 'EDITUSERPOST Edit RNQuery.Post Exception , User=' +Username,E.Message);
               end;
            end;
            RNQuery.Close;
            Processlog(ltInfo, 'EDITUSERPOST','End Edit User');
            response.Content := 'USER UPDATED';
         end else if (EmployeeGUID = 'ADD') then begin
            Processlog(ltInfo, 'EDITUSERPOST','Begin Add User');
            if UserNameExists(Username) then begin
               Response.Content := 'USER EXISTS';
               Exit;
            end;
            EmployeeGUID := GenerateGUID;
            if not OpenUserQueryGUID(EmployeeGUID) then begin
               RNQuery.Insert;
               RNQuery.FieldByName('ChainCode').AsInteger := ChainCode;
               RNQuery.FieldByName('EmployeeGUID').AsString := EmployeeGUID;
               Password := Request.ContentFields.Values['userPW'];
               if Password = '' then Password := GenerateGUID;
               RNQuery.FieldByName('PasswordHash').AsString  := CardUtil.StringToSHADigestHex(Password);
               LoadUserFormData(RNQUERY,Username);

               Try
                  RNQuery.Post;
               except
                  ON E:Exception do begin
                     Processlog(ltWarning, 'EDITUSERPOST Add RNQuery.Post Exception , User=' +Username,E.Message);
                  end;
               end;
               if OpenUserQueryGUID(EmployeeGUID) then begin
                  RNQuery.Edit;
                  RNQuery.FieldByName('EmployeeXML').AsString := BuildEmployeeXML(RNQuery);
                  RNQuery.Post;
                  Processlog(ltInfo, 'EDITUSERPOST','End Add User');
                  Response.Content := 'USER ADDED';
               end else begin
                  Response.Content := 'USERADD FAIL';
                  Processlog(ltWarning, 'EDITUSERPOST USER ADD fail on second OpenUserQueryGUID, EmployeeGUID=',EmployeeGUID);
               end;
            end else begin
               Response.Content := 'USER ADD FAIL';
               Processlog(ltWarning, 'EDITUSERPOST USER ADD FAIL, EmployeeGUID=',EmployeeGUID);
            end;
         end else begin
            Response.Content := 'USER ADD/UPDATE FAIL';
         end;
      end else begin
         response.Content := 'UNAUTHORIZED ACCESS';
      end;
      exit;

   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'DELETEUSERACCESSPOST') then begin   //2016-10-06 jtm: Feat OT#1055
      if (UserXMLGetTag('/USERPROFILE/ALLOWADMINUSERMANAGEMENT','FALSE')='TRUE') then begin
         EmployeeGUID := GuidOnly(Request.QueryFields.Values['USERGUID']);
         if Request.Content <> '' then begin
            if OpenUserQueryGUID(EmployeeGUID) then begin
               if RemoveUserRNIDAccess(RNQuery,Request.Content) then
                  WS := 'SUCCESS'
               else
                  WS := 'FAILED';
            end else begin
               WS := 'FAILED';
            end;
         end else begin
            WS := 'FAILED';
         end;
         Response.Content := WS;
         Exit;
      end else begin
         response.Content := '<BR><B><font color="red">Unauthorized Access</font></B>';
      end;
      exit;

   end;
   If (CustomerMembType = 'ADMIN') and (PageName = 'DELETEUSERCHAINPOST') then begin   //2016-11-03 jtm: Feat OT#1247
      if (UserXMLGetTag('/USERPROFILE/ALLOWADMINUSERMANAGEMENT','FALSE')='TRUE') then begin
         EmployeeGUID := GuidOnly(Request.QueryFields.Values['USERGUID']);
         if Request.Content <> '' then begin
            if OpenUserQueryGUID(EmployeeGUID) then begin
               if RemoveUserChainAccess(RNQuery,Request.Content) then
                  WS := 'SUCCESS'
               else
                  WS := 'FAILED';
            end else begin
               WS := 'FAILED';
            end;
         end else begin
            WS := 'FAILED';
         end;
         Response.Content := WS;
         Exit;
      end else begin
         response.Content := '<BR><B><font color="red">Unauthorized Access</font></B>';
      end;
      exit;

   end;



   If PageName = 'ADDCHECKING' then begin
      WS := LoadWebFile('add_check.htm');
      response.Content := WS;
      exit;
   end;


   If PageName = 'ADDCARD' then begin
      WS := LoadWebFile('add_card.htm');
      response.Content := WS;
      exit;
   end;
   If PageName = 'POSTADDCHECK' then begin
      If OpenCustomerQuery then begin
         ParentGUID := Trim(RNQuery.FieldByName('CustomerCode').AsString);
         WS2 := GuidOnly(Request.queryfields.Values['CUSTGUID']);
         If (CustomerMembType = 'ADMIN') and (WS2<>'') then begin
            ParentGUID := WS2; //This is for Ajax admin portal.   If this is an admin and there's a specified Customer GUID, add it, but don't let normal users do this
         end;

         AddCheckToAccount;
      end;

      Response.Content := '<head><title>Portal Home</title>' +
                       '<meta http-equiv="refresh" content="0;URL='+ GetConfigString('ONPOSTADDCHECKURL','/PP?PAGE=PROFILE')+'"></head>';

      exit;
   end;

   If PageName = 'ADDCARD' then begin
      WS := LoadWebFile('add_card.htm');
      response.Content := WS;
      exit;
   end;

   If PageName = 'PAYMENTHISTORY' then begin
      If OpenCustomerQuery then begin
         ParentGUID := Trim(RNQuery.FieldByName('CustomerCode').AsString);
         WS := LoadWebFile('payment_history.htm');
         ReplaceString(WS, '%PAYMENTHISTORY%', GenerateCustomerPaymentHistory(ParentGUID,'',True));
         response.Content := WS;
      end;
      exit;
   end;


   If PageName = 'MAKEPAYMENT' then begin
      If OpenCustomerQuery then begin
         If Trim(RNQuery.FieldByName('ConfirmGUID').AsString) <> 'VALIDATED' then begin
            WS := LoadWebFile('AccountNotVerified.htm');
            ReplaceString(WS, '%EMAIL%', Trim(RNQuery.FieldByName('Email').AsString));
            response.Content := WS;
            exit;
         end else begin
            ParentGUID := Trim(RNQuery.FieldByName('CustomerCode').AsString);
            WS := LoadWebFile('make_payment.htm');

            if(StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/DISPLAYBALANCEDUE','FALSE'))) then begin // 2019-2-13 ss DVST-3841 for injecting balance due
               ReplaceString(WS,'%BALANCEDUE%',Trim(Format('%m',[RNQuery.FieldByName('BALANCEDUE').AsFloat])));
            end;

            RNQuery.Close;
            RNQuery.SQL.Clear;
            RNQuery.SQL.Add('select distinct RNID,SystemCode, name,city, state, convert(varchar(max),siblings) as siblings, firstname,lastname,accountnumber,ChildGuid from custchild');
            RNQuery.SQL.Add('left outer join store on systemcode = rnid');
            RNQuery.SQL.Add('where (CustGUID = '''+ParentGUID + ''') and (Hidden =0)');
            RNQuery.SQL.Add('order by State,Name');
            RNQuery.Open;
            ReplaceString(WS, '%SCHOOLOPTIONS%', GenerateSchoolOptions(RNQuery));
            ReplaceString(WS, '%LOCATIONOPTIONS%', GenerateAllLocationsOptions);
            ReplaceString(WS, '%LOCATIONSTATEOPTIONS%', GenerateAllLocationStateOptions);
            ReplaceString(WS, '%CHILDNAMEOPTIONS%', GenerateChildNameOptions(RNQuery, ChildCount)); // 2019-4-17 SS DVST-4900: Refactored function
            ReplaceString(WS, '%PAYMENTOPTIONS%', GeneratePaymentOptions(ParentGUID, 'RECURRING','', PaymentOptionsCount)); // 2019-4-17 SS DVST-4900: Refactored function
            ReplaceString(WS, '%SCHEDULEDPAYMENTS%', GenerateScheduledPayments);
         end;

         response.Content := WS;
         If (ChildCount = 0) and (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/REQUIRECHILD') = 'TRUE') then begin
            Response.Content := '<head><title>Payment Profile</title><meta http-equiv="refresh" content="0;URL=/PP?PAGE=PROFILE&RESULT=CHILDREQUIRED#CHILDGRID"></head>';
         end;

         If (PaymentOptionsCount = 0) and (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/REQUIREPAYMENT', 'TRUE') = 'TRUE') then begin
            Response.Content := '<head><title>Payment Profile</title><meta http-equiv="refresh" content="0;URL='+ GetConfigString('ONOTPNOPAYMENTOPTIONS','/PP?PAGE=PROFILE&RESULT=PAYMENTERROR#PAYMENTGRID')+'"></head>';
         end;

      end;
      exit;
   end;

   If PageName = 'ONETIMEPAY' then begin
      If OpenCustomerQuery then begin
         ParentGUID := Trim(RNQuery.FieldByName('CustomerCode').AsString);
         WS := LoadWebFile('one_time_Payment.htm');
         if(StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/DISPLAYBALANCEDUE','FALSE'))) then begin // 2019-2-13 ss DVST-3840
            ReplaceString(WS,'%BALANCEDUE%',Trim(Format('%m',[RNQuery.FieldByName('BALANCEDUE').AsFloat])));
         end;
         RNQuery.Close;
         RNQuery.SQL.Clear;
         RNQuery.SQL.Add('select distinct RNID,SystemCode, name,city, state, convert(varchar(max),siblings) as siblings, firstname,lastname,accountnumber, ChildGUID from custchild');
         RNQuery.SQL.Add('left outer join store on systemcode = rnid');
         RNQuery.SQL.Add('where (CustGUID = '''+ParentGUID + ''') and (Hidden =0)');
         RNQuery.SQL.Add('order by State,Name');
         RNQuery.Open;
         ReplaceString(WS, '%SCHOOLOPTIONS%', GenerateSchoolOptions(RNQuery));
         ReplaceString(WS, '%LOCATIONOPTIONS%', GenerateAllLocationsOptions);
         ReplaceString(WS, '%LOCATIONSTATEOPTIONS%', GenerateAllLocationStateOptions);
         ReplaceString(WS, '%CHILDNAMEOPTIONS%', GenerateChildNameOptions(RNQuery,ChildCount)); // 2019-4-17 SS DVST-4900: Refactored function
         ReplaceString(WS, '%PAYMENTOPTIONS%', GeneratePaymentOptions(ParentGUID, 'ONETIME','', PaymentOptionsCount)); // 2019-4-17 SS DVST-4900: Refactored function

         response.Content := WS;
         ProcessLog(ltInfo, 'PageName = ONETIMEPAY', 'CHILDCOUNT AND PAYMENTOPTIONSCOUNT AFTER REFACTORED METHOD CALL: ChildCount = '+Stri(ChildCount,-1)+' . PaymentOptionsCount = '+Stri(PaymentOptionsCount,-1)); // 2019-4-17 SS DVST-4900: Checking ChildCount and PaymentOptionsCount after refactored method call

         If (ChildCount = 0) and (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/REQUIRECHILD') = 'TRUE') then begin
            Response.Content := '<head><title>Payment Profile</title><meta http-equiv="refresh" content="0;URL=/PP?PAGE=PROFILE&RESULT=CHILDREQUIRED#CHILDGRID"></head>';
         end;
         If (PaymentOptionsCount = 0) then begin
            Response.Content := '<head><title>Payment Profile</title><meta http-equiv="refresh" content="0;URL='+ GetConfigString('ONOTPNOPAYMENTOPTIONS','/PP?PAGE=PROFILE&RESULT=PAYMENTERROR#PAYMENTGRID')+'"></head>';
         end;

      end;
      exit;
   end;

   If PageName = 'DCCQUOTEAJAX' then begin //2018-06-20 ajs: F#2221
      FolderName := '';
      if SessionVarEval.GetValueAsString('LocationName') <> '' then FolderName := SessionVarEval.GetValueAsString('LocationName');
      VarEvaluator.ClearAll;
      WS2 := '';
      ProcessLog(ltInfo,'Start DCC Quote', FolderName);
      if Trim(UpCaseString(Request.queryfields.Values['SERVICENAME'])) <> '' then begin
         WS2 := '<SERVICENAME>' + Trim(UpCaseString(Request.queryfields.Values['SERVICENAME'])) + '</SERVICENAME>';
      end;
      if Trim(UpCaseString(Request.queryfields.Values['AMOUNT'])) <> '' then begin
         WS2 := WS2 + '<CCAMT>' + Trim(UpCaseString(Request.queryfields.Values['AMOUNT'])) + '</CCAMT>';
      end;
      if Trim(UpCaseString(Request.queryfields.Values['BINNUMBER'])) <> '' then begin
         WS2 := WS2 + '<BINNUMBER>' + Trim(UpCaseString(Request.queryfields.Values['BINNUMBER'])) + '</BINNUMBER>';
      end;
      ProcessLog(ltInfo,'Get DCC Quote Info', WS2);
      If GetDCCQuote(RNID, WS2) then begin
         WS := LoadWebFileFromFolder('DCCDiv.htm',FolderName);
      end else begin
         WS := 'DCCUNAVAILABLE';
      end;    
      response.Content := WS;
      Exit;
   end;

   If PageName = 'PROCESSPAYMENT' then begin
      VarEvaluator.ClearAll;
      If Not OpenCustomerQuery then exit;
      ParentGUID := Trim(RNQuery.FieldByName('CustomerCode').AsString);
      ProcessPortalPayment(RNID,ParentGUID,nil);
      exit;
   end;

   If PageName = 'REMOVESCHEDULEDPAYMENT' then begin
      If OpenCustomerQuery then begin
         WS := GuidOnly(Request.queryfields.Values['PAYSCHEDGUID']);
         ParentGUID := Trim(RNQuery.FieldByName('CustomerCode').AsString);
         RNQuery.Close;
         RNQuery.SQL.Clear;
         If CustomerMembType = 'ADMIN' then begin  //allow admins to remove any scheduled payment
            RNQuery.SQL.Add('Select * from CustPaySched where (siternid = '''+RNID + ''') and (PaySchedGUID = ''' + WS + ''')');
         end else begin
            RNQuery.SQL.Add('Select * from CustPaySched where (CustGUID = '''+ParentGUID + ''') and (PaySchedGUID = ''' + WS + ''')');
         end;
         RNQuery.Open;
         If RNQuery.RecordCount = 1 then
            RNQuery.Delete;
         RNQuery.Close;
      end;
      Response.Content := '<head><title>Portal Logon</title>' +
                          '<meta http-equiv="refresh" content="0;URL=/PP?PAGE=MAKEPAYMENT"></head>';
      exit;
   end;


   If PageName = 'POSTADDCARD' then begin
      If OpenCustomerQuery then begin
         ParentGUID := Trim(RNQuery.FieldByName('CustomerCode').AsString);

         WS2 := GuidOnly(Request.queryfields.Values['CUSTGUID']);
         If (CustomerMembType = 'ADMIN') and (WS2<>'') then begin
            ParentGUID := WS2; //This is for Ajax admin portal.   If this is an admin and there's a specified Customer GUID, add it, but don't let normal users do this
         end;
         if not AddCardToAccount(ParentGUID,RNID,nil) then processLog(ltinfo, 'POSTADDCARD', 'Card failed'); //2017-08-02 jtm: F#2035
      end else begin
         ProcessLog(ltWarning,'POSTADDCARD, unable to find customer',PageName);
      end;
      If (CustomerMembType = 'ADMIN') and (WS2<>'') then begin
         Response.Content := 'CARD ADDED';
      end else begin
         Response.Content := '<head><title>Portal Home</title>' +
                       '<meta http-equiv="refresh" content="0;URL='+ GetConfigString('ONPOSTADDCARDURL','/PP')+'"></head>';
      end;

      exit;
   end;
   If PageName = 'ADDSCHEDULEDPAYMENT' then begin
      If OpenCustomerQuery then begin
         ProcessLog(ltDebug, 'ADDSCHEDULEDPAYMENT', 'Request.QueryFields.Text '+Request.QueryFields.Text);
         ProcessLog(ltDebug, 'ADDSCHEDULEDPAYMENT', 'Request.ContentFields.Text '+Request.ContentFields.Text);

         ParentGUID := Trim(RNQuery.FieldByName('CustomerCode').AsString);
         if (ValuReal(Request.ContentFields.Values['Amount']) <= 0) and (ValuReal(Request.ContentFields.Values['Balance']) <= 0) then begin
            ProcessLog(ltWarning,'Attempt to add scheduled payment with no amount',numericonly(Request.ContentFields.Values['Amount']));
         end else begin
            AddScheduledPayment;
         end;
      end;
      Response.Content := '<head><title>Portal Logon</title>' +
                          '<meta http-equiv="refresh" content="0;URL=/PP?PAGE=MAKEPAYMENT"></head>';
      exit;
   end;


   If PageName = 'UPDATEPROFILE' then begin
      If OpenCustomerQuery then begin
         RNQuery.Edit;
         LoadCustomerFormData(RNQUERY);
         Try
            RNQuery.Post;
         except
            ON E:Exception do begin
            end;
         end;
         RNQuery.Close;

      end;
      Response.Content := '<head><title>Portal Logon</title>' +
                          '<meta http-equiv="refresh" content="0;URL=/PP?PAGE=PROFILE"></head>';
      exit;
   end;


   If PageName = 'ADDCHILDPOST' then begin


      If ValidateAddChildPost then begin
         If OpenCustomerQuery then begin
            ParentGUID := Trim(RNQuery.FieldByName('CustomerCode').AsString);
            AddChildToAccount(ParentGuid);
         end;
         Response.Content := '<head><title>Portal Logon</title>' +
                             '<meta http-equiv="refresh" content="0;URL=/PP?PAGE=PROFILE#CHILDGRID"></head>';
      end else begin
         Response.Content := '<head><title>Portal Logon</title>' +
                             '<meta http-equiv="refresh" content="0;URL=/PP?PAGE=PROFILE&RESULT=ADDERROR#CHILDGRID"></head>';
      end;
      exit;
   end;

   If PageName = 'REMOVECHILD' then begin
      If OpenCustomerQuery then begin
         WS := ValidCharsOnly(Request.queryfields.Values['CHILDGUID'],TRUE,True,'-');
         ParentGUID := Trim(RNQuery.FieldByName('CustomerCode').AsString);
         RNQuery.Close;
         RNQuery.SQL.Clear;
         RNQuery.SQL.Add('Update CustChild set hidden = 1 where (CustGUID = '''+ParentGUID + ''') and (ChildGUID = ''' + WS + ''')');
         RNQuery.ExecSQL;
      end;
      Response.Content := '<head><title>Portal Logon</title>' +
                          '<meta http-equiv="refresh" content="0;URL=/PP?PAGE=PROFILE"></head>';
      exit;
   end;

   If PageName = 'REMOVEPAYMENT' then begin
      If OpenCustomerQuery then begin
         WS := ValidCharsOnly(Request.queryfields.Values['PAYMENTGUID'],TRUE,True,'-');
         ParentGUID := Trim(RNQuery.FieldByName('CustomerCode').AsString);
         RNQuery.Close;
         RNQuery.SQL.Clear;
         RNQuery.SQL.Add('update CustPayment set hidden = 1 where (CustGUID = '''+ParentGUID + ''') and (PaymentGUID = ''' + WS + ''')');
         RNQuery.ExecSQL;
      end;
      Response.Content := '<head><title>Portal Logon</title>' +
                          '<meta http-equiv="refresh" content="0;URL=/PP?PAGE=PROFILE"></head>';
      exit;
   end;


   If PageName = 'RESENDCONFIM' then begin
      If OpenCustomerQuery then begin
         SendValidation(RNQuery);
      end;
      WS := LoadWebFileFromFolder('welcome.htm','');
      ReplaceString(WS,'%ERROR%', '<BR><B><font color="red">Confirmation Email re-sent.</font></B>');
      response.Content :=WS;

      exit;
   end;

   If PageName = 'CHECKAPPROVED' then begin
      WS := LoadWebFile('telecheck_approved.htm');
      response.Content :=WS;
      exit;
   end;


   If PageName = 'CHECKDECLINED' then begin
      WS := LoadWebFile('telecheck_Declined.htm');
      response.Content :=WS;
      exit;
   end;


   If PageName = 'ERRORGEN' then begin
      EncodeDate(11,15,15);
      exit;
   end;

   If PageName = 'VERSION' then begin
      WS := LoadWebFileFromFolder('welcome.htm','');
      ReplaceString(WS, '%ERROR%', '<BR><B><font color="red">'+GetFileVersion(aFileVersionLong)+'</font></B>' );
      response.Content :=WS;
      exit;
   end;

   If PageName = 'PROFILE' then begin
      if not PaymentPortalCustomerAuthenticate then begin
         Response.Content := 'Unable to authenticate customer , RNSESSIONID = ' + RnSessionID;
         exit;
      end;
      If OpenCustomerQuery then begin
         ParentGUID := Trim(RNQuery.FieldByName('CustomerCode').AsString);
         WS := LoadWebFile('profile.htm');
         ReplaceString(WS, '%ERROR%', '');

         DSSubStrings(WS,'EMAIL,FIRSTNAME,LASTNAME,ADDRESS,HOMEADDRESS2,CITY,STATE,ZIP,HPHONE,WPHONE,MOBILEPHONE,EMPLOYER,WORKADDRESS1,WORKADDRESS2,WORKCITY,WORKSTATE,WORKZIP,WORKEXTENSION,ACCOUNTNUMBER',RNQuery);
         ReplaceString(WS,'%CHILDGRID%',GenerateChildGrid(ParentGUID,True));
         ReplaceString(WS,'%PAYMENTGRID%',GeneratePaymentGrid);
         response.Content := WS;
      end else begin
         Response.Content := 'Unable to load customer account, CustomerSC = ' + Stri(CustomerSC,-1) + ', RNSESSIONID=' + RnSessionID;
      end;
       Response.Content := 'Down to the end';
   end else begin
      If OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/AUTHENTICATIONTYPE') = 'USER' then begin
         ws := LoadWebFileFromFolder('employee_login.htm','');
         if (StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/USERDEFAULTTOSTORELOGALL', 'FALSE'))) then begin // 2018-12-19 SS DVST-3660
            ws := '<head><title>Portal Logon</title>' +
                  '<meta http-equiv="refresh" content="0;URL=/PP?PAGE=STORELOGALL"></head>';
         end;
      end else begin
         if((Trim(SessionVarEval.GetValueAsString('MEMBTYPECODE')) = '0') And (StrToBool(OpenXMLGetTag('/CONFIGDATA/CHECKEXTCUSTOMERFIRSTLOGON','FALSE')))) then begin // 2019-2-13 ss DVST-3838
            WS := '<head><title>Portal Logon</title>' +
            '<meta http-equiv="refresh" content="0;URL=/PP?PAGE=EDITLOGIN"></head>';
         end else begin
            WS := LoadWebFileFromFolder('welcome.htm','');
         end;
      end;
      ReplaceString(WS, '%ERROR%', '');
      response.Content :=WS;
   end;
except
   on E:Exception do begin
      ProcessPortalException(E.Message);
    end;
end;

end;


Function TCustomerInfoModule.ValidateSessionID : Boolean;
const
   METHOD_NAME = 'ValidateSessionID()'; // 2019-3-13 ss DVST-3849
var
   UnitExpTime : String; // 2019-3-13 ss DVST-3849
   ExpTime : Integer; // 2019-3-13 ss DVST-3849
begin
   try
      Result := False;
      GetSessionID;
      SessionAuthQuery.Close;
      SessionAuthQuery.SQL.Clear;
      SessionAuthQuery.SQL.Add('Select * from WWWSession where RNSessionID = ''' + RnSessionID + '''');
      SessionAuthQuery.Open;

      If SessionAuthQuery.RecordCount = 1 then begin
         If SessionAuthQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime > NOW then begin
            Result := True;
         end else if trim(SessionAuthQuery.FieldByName('CustomerAuthenticatedTill').AsString) = '' then begin
            SessionAuthQuery.Edit;
            if (StrToBool(OpenXMLGetTag('/CONFIGDATA/SETSESSIONEXPIRETIME/ENABLED'))) then begin // 2019-3-13 ss DVST-3849
               UnitExpTime := Trim(OpenXMLGetTag('/CONFIGDATA/SETSESSIONEXPIRETIME/UNIT'));
               ExpTime := Valu(Trim(OpenXMLGetTag('/CONFIGDATA/SETSESSIONEXPIRETIME/VALUE')));
               SessionAuthQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime := ChangeNowByTargetTimeUnitAndValue(UnitExpTime, ExpTime);
            end else begin
               SessionAuthQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime := NOW + EncodeTime(0,30,0,0); //add 30 mins
            end;
            SessionAuthQuery.Post;
            Result := True;
         end else begin
            if ((SessionVarEval.GetValueAsString('SESSIONFAILTIME') <> '') and (SessionVarEval.GetValueAsString('SESSIONFAILREASON') <> '')) then begin
               Result := False;
            end else begin
               SessionVarEval.AddValue('SESSIONFAILTIME', DateTimeToStr(NOW));
               SessionVarEval.AddValue('SESSIONFAILREASON', 'SessionID Expired');
               ProcessLog(ltInfo,'ValidateSessionID Failure','Failure Time: ' + SessionVarEval.GetValueAsString('SESSIONFAILTIME') + ' Failure Reason:' + SessionVarEval.GetValueAsString('SESSIONFAILREASON'));
               Result := False;
         end;
      end;
      end else begin
         if ((SessionVarEval.GetValueAsString('SESSIONFAILTIME') <> '') and (SessionVarEval.GetValueAsString('SESSIONFAILREASON') <> '')) then begin
            Result := False;
         end else begin
            SessionVarEval.AddValue('SESSIONFAILTIME', DateTimeToStr(NOW));
            SessionVarEval.AddValue('SESSIONFAILREASON', 'SessionID not Found');
            ProcessLog(ltInfo,'ValidateSessionID Failure','Failure Time: ' + SessionVarEval.GetValueAsString('SESSIONFAILTIME') + ' Failure Reason:' + SessionVarEval.GetValueAsString('SESSIONFAILREASON'));
            Result := False;
         end;
      end;
   except
    On E:Exception do begin
       ProcessPortalException(E.Message);
    end;
   end;
end;
Function TCustomerInfoModule.GenerateSplitTable(SplitXML: String): String;
var
   I : Integer;
   WS : String;
   SD : String;
Begin
   Result :='';
   If SplitXML = '' then exit;
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SPLITTABLE/ENABLED', 'FALSE') = 'TRUE') then begin // 2018-12-19 ss: DVST-2091 - create custom split table
      WS := MakeCustomSplitTable(SplitXML);
   end else begin
   WS := '<TABLE><TR><TH>Invoice Number</TH><TH>Amount</TH></TR>';
   I := 1;
   SD := Utility.GetNXMLTagStr(SplitXML,'SPLITDETAIL',I);
   If SD = '' then exit;
   While SD <> '' do begin
      WS := WS + '<TR><TD align="RIGHT">'+ GetXMLTagStr(SD,'TRANIDENT')+'</TD><TD align="RIGHT">$'+Trim(StriReal(ValuReal(GetXMLTagStr(SD,'AMOUNT')),2)) +'</TD></TR>';
      inc(I);
      SD := Utility.GetNXMLTagStr(SplitXML,'SPLITDETAIL',I);
   end;
   WS := WS + '</TABLE>';
   end;
   Result := WS;
end;
Function TCustomerInfoModule.PaymentPortalCustomerAuthenticate : Boolean;
var
   WS: String;
   Dest : String;
Begin
 Try
   Result := False;
   GetSessionID;
   SessionAuthQuery.Close;
   SessionAuthQuery.SQL.Clear;
   SessionAuthQuery.SQL.Add('Select * from WWWSession where RNSessionID = ''' + RnSessionID + '''');
   SessionAuthQuery.Open;

   If SessionAuthQuery.RecordCount = 1 then begin
      If SessionAuthQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime > NOW then begin
         SessionAuthQuery.Edit;
         SessionAuthQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime := NOW + EncodeTime(1,0,0,0); //extend another 60 mins
         SessionAuthQuery.Post;
         If (Trim(SessionAuthQuery.FieldByName('username').AsString) <> '') then begin
            GetRNUser(Trim(SessionAuthQuery.FieldByName('username').AsString));  ///take this out once ttWebUtility is more widely used
            ttWebUtility.GetRNUser(Trim(SessionAuthQuery.FieldByName('username').AsString));
         end else if (Trim(SessionAuthQuery.FieldByName('MembType').AsString) = 'ADMIN') and (GUIDOnly(SessionVarEval.GetValueAsString('RNEmployeeGUID'))<>'') then begin
            GetRNUserByGUID(GUIDOnly(SessionVarEval.GetValueAsString('RNEmployeeGUID')));  //2018-10-10 jtm: DVST-545
         end;
         Result := True;
         LoadSessionVars(SessionAuthQuery);
      end else begin
         Dest := Request.pathInfo;
         If Request.Query <> '' then
            Dest := Dest + '?' + Request.Query;
          Dest := '/PP';
         SessionAuthQuery.Edit;
         SessionAuthQuery.FieldByName('Dest').AsString := Dest;
         SessionAuthQuery.Post;

         Response.ContentType := 'text/html';
         If OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/AUTHENTICATIONTYPE') = 'CAS' then begin
            WS := OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/CASURL');
            WS := '<head><title>Authentication Server Redirect</title>' +
                        '<meta http-equiv="refresh" content="0;URL=' + WS+'"></head>';
         end else begin
            If OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/AUTHENTICATIONTYPE') = 'USER' then begin
               WS := LoadWebFileFromFolder('employee_login.htm','');
               if (Request.queryfields.Values['PAGE'] <> '') then begin //2016-09-20 jtm: D#1948
                  WS := '<head><title>Authentication</title>' +
                        '<meta http-equiv="refresh" content="0;URL=/PP"></head>';
               end;
            end else begin
               WS := LoadWebFileFromFolder('default.htm','');
            end;
            ReplaceString(WS,'%ERROR%', '');
            ReplaceString(WS,'%EMAIL%', '');
         end;
         Response.Content := WS;


      end;
   end;
 except
    On E:Exception do begin
      ProcessLog(ltInfo, 'Exception PaymentPortalCustomerAuthenticate:', E.Message);
      if ((ExceptionIsMultiUserInterference(SessionAuthQuery)) or (ExceptionIsPrimaryKeyConstraint(SessionAuthQuery))) and (RecursionDepth < 5) then begin //2018-02-02 jtm: F#3765
         Inc(RecursionDepth);
         ProcessLog(ltInfo, 'Exception PaymentPortalCustomerAuthenticate:', 'start recursion:' + IntToStr(RecursionDepth));
         result := PaymentPortalCustomerAuthenticate;
         RecursionDepth := 0;
      end else begin
         ProcessLog(ltWarning, 'Exception PaymentPortalCustomerAuthenticate error number:', IntToStr(RNQuery2.Connection.Errors.Item[0].Number));
         result := false;
         ProcessPortalException(E.Message);
      end;
    end;
 end;

end;


procedure TCustomerInfoModule.CustomerInfoModuleWebReferAction(
  Sender: TObject; Request: TWebRequest; Response: TWebResponse;
  var Handled: Boolean);
var
   RNID : String;
   PaymentRNID : String;     //2015-10-06 jtm
   PaymentLocationRNID : String; //2015-12-19 jtm
   Operation : String;
   PaymentRequest : String;
   XMLResp : TStringList;
   URL : String;
   RNC : String;
   Hash : String;
   WS : String;
   OurHash : String;
   CCAuthType : String;
   CardEventParms : string;  //2016-06-22 jtm
   ReferURL : string;   //2016-10-19 jtm Feat OT# 1201
   PacketSuccess : boolean;  //2016-10-27 jtm: Def OT# 1284
   ClientTxnGUID : string;
   ContentFieldsLog : string;
   ContentFieldsLogInt : integer;
   i : integer;
   StationIdent : string; //2017-05-10 jtm: F#1606
   ServiceName : string; //2017-09-20 jtm: F#2150
   EpicTransactionType : string;
   RepToken : string;
   Amount : string;
   TranType : integer;
   ResponseXML : TOpenXML;
   ResponseXMLNode : TOpenXMLNode;
   ErrorMessage : string;
   EpicResult : integer;
   EpicDeclineType : integer;
   TranDate : TDateTime;
   TranDateStr : string;
   PaymentsAVS : string;
   BankAccountType : string;
   expyear : string;
   IDTechDecrypt: TIDTechDecrypt; //2018-02-13 ajs: Feat OT#3506
   OurFirstHash : String;
   AppServerSI: String; // 2019-05-15 bls: DVST-5231
   CardDetails: TStringList;
begin
   Response.ContentType := 'text/html';
   StationIdent := 'WEBREFER';
   RNID := RNLoadHostName;
   ClientTxnGUID := GenerateGUID;
   PL.AddAppValue('CLIENTTXNGUID',ClientTxnGUID);
   PL.AddAppValue('SESSIONID',GUIDOnly(Request.QueryFields.Values['SESSIONID']));
   RNC := trim(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/APICERT',''));
   PacketSuccess := false;
   EpicResult := 0; ///0 = Error; 1 = Accepted; 2 = Decline
   EpicDeclineType := 0; //0 Unknown; 1 Insufficient funds; 2 Expired card; 3 Invalid card number; 4 Invalid CVV; 5 Invalid billing address; 6 Additional verification required; 7 Potential fraud
   IF RNID = '' then begin
      Response.Content := 'Invalid HostName';
      exit;
   end;
   If RNC = '' then begin
      RNC := GetRNCERT(Valu(RNID));
      if RNC = '' then begin
         Response.Content := 'Account Not Configured';
         exit;
      end;
   end;
   RNReg.ChainCode := ChainCode;

   Operation := Trim(UpperCase(AlphaNumericOnly(Request.ContentFields.Values['TRANSACTIONTYPE'])));
   ReferURL := Request.ContentFields.Values['REFERURL'];  //2016-10-19 jtm Feat OT# 1201
   if ValidCharsOnly(Request.ContentFields.Values['STATIONIDENT'],true,true,'-._') <> '' then begin //2017-05-10 jtm F#1606
      StationIdent := ValidCharsOnly(Request.ContentFields.Values['STATIONIDENT'],true,true,'-._');
   end;
   if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/VALIDATESESSIONID', '') = 'TRUE') then begin   //2016-11-03 jtm Feat OT# 1248
      if ((ValidCharsOnly(Request.CookieFields.Values['RNSESSIONID'],True,True,'-') = '') and (ValidCharsOnly(Request.QueryFields.Values['SESSIONID'],True,True,'-')= '')) or not ValidateSessionID then begin
          ProcessLog(ltWarning, 'WEBREFER INVALIDSESSIONID Operation:', Operation + 'CookieField: ' + ValidCharsOnly(Request.CookieFields.Values['RNSESSIONID'],True,True,'-') + 'QueryField: '+ ValidCharsOnly(Request.QueryFields.Values['SESSIONID'],True,True,'-'));
          URL := ReferURL + '?TRANSUCCESS=FALSE&TRANRESPMESSAGE=INVALIDSESSIONID';
          Operation := '';
      end;
   end;
   if ValidCharsOnly(Request.ContentFields.Values['SERVICENAME'],true,true,'-._') <> '' then begin //2017-09-20 jtm F#2150
      ServiceName := ValidCharsOnly(Request.ContentFields.Values['SERVICENAME'],true,true,'-._');
   end;

   XMLResp := TStringList.Create;
   ProcessLog(ltInfo, 'WEBREFER Operation:', Operation);
   If Operation = 'CREDITAUTH' then begin
      if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/USESHA1','FALSE') = 'TRUE') then begin
         OurHash := StringToSHADigestHex(RNID + RNC + Request.ContentFields.Values['CUSTIDENT'] +
                                              Request.ContentFields.Values['TRANIDENT'] +
                                              Request.ContentFields.Values['CREDITAMT']);
      end else begin
         OurHash := AnsiUpperCase(AWSAPI.CalcSHA256ToHex(RNID + RNC + Request.ContentFields.Values['CUSTIDENT'] +
                                              Request.ContentFields.Values['TRANIDENT'] +
                                              Request.ContentFields.Values['CREDITAMT']));
      end;
      If OurHash = Trim(Request.ContentFields.Values['TXNAUTH']) then begin

         CCAuthType := 'SALE';

         if ValidCharsOnly(Trim(Request.ContentFields.Values['CCAUTHTYPE']),True,False,'') = 'AVS' then begin
             CCAuthType := 'AVS';
         end else if (ValidCharsOnly(Trim(Request.ContentFields.Values['CCAUTHTYPE']),True,False,'') = 'AUTH') and (OpenXMLGetTag('/CONFIGDATA/WEBREFERALLOWAUTH', '') = 'TRUE') then begin
             CCAuthType := 'AUTH';  //2016-11-03 jtm Feat OT# 1240
         end else if (ValidCharsOnly(Trim(Request.ContentFields.Values['CCAUTHTYPE']),True,False,'') = 'CVV') and (OpenXMLGetTag('/CONFIGDATA/WEBREFERALLOWCVV', '') = 'TRUE') then begin //2017-09-25 jtm: F#2204
             CCAuthType := 'CVV';
         end;

         PaymentRNID := RNID;
         PaymentLocationRNID := NumericOnly(Request.ContentFields.Values['PAYMENTLOCATION']);
         if PaymentLocationRNID <> '' then begin
             RNQuery.Close;
             RNQuery.SQL.Text := 'Select * from Store where (SystemCode = ' + NumericOnly(PaymentLocationRNID) + ') and (Chaincode = ' + IntToStr(ChainCode) + ')';
             RNQuery.Open;
             if RNQuery.RecordCount = 1 then PaymentRNID := PaymentLocationRNID;
         end;
         ProcessLog(ltInfo, 'RNID: ' + RNID, 'PaymentRNID: ' + PaymentRNID);
         PaymentRequest := '<TRANSACTION>'+
                           '   <RNID>'+PaymentRNID+'</RNID>' +
                           '   <TRANSACTIONTYPE>CCAUTH</TRANSACTIONTYPE>'+
                           '   <CCAUTHTYPE>' + CCAuthType+'</CCAUTHTYPE>'+
                           '   <CLIENTTXNGUID>' + ClientTxnGUID+'</CLIENTTXNGUID>'+
                           '   <CCAMT>'+Trim(StriReal(ValuReal(Request.ContentFields.Values['CREDITAMT']),2))+'</CCAMT>' +
                           '   <TRANIDENT>'+ValidCharsOnly(Request.ContentFields.Values['TRANIDENT'],True,True,'.-_:/& ')+'</TRANIDENT>' + //2017-05-10 jtm D#1605
                           '   <CUSTIDENT>'+ValidCharsOnly(Request.ContentFields.Values['CUSTIDENT'],True,True,'.-_:/& ')+'</CUSTIDENT>';  //2017-05-10 jtm D#1605
         if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/USECARDEVENTPARAMS', '') = 'TRUE') then begin   //2016-06-22 jtm
             CardEventParms := ValidCharsOnly(Trim(Request.ContentFields.Values['CARDEVENTPARAMS']),True,True,'-.<>/+=%^?;*: ');
             if (CardEventParms <> '') and (NumericOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCDEVICETYPE'))) = '3') then begin //2018-02-13 ajs: Feat OT#3506
                 ProcessLog(ltInfo,'WEBREFER-CREDITAUTH','Using IDTECH');
                 IDTechDecrypt := TIDTechDecrypt.Create(Trim(GetXMLTagStr(CardEventParms,'ENCDVCENCRYPTEDBLOCK')), PL.ProcessLog);
                 PaymentRequest := PaymentRequest + IDTechDecrypt.GenerateCardEventParmsXML;
				 FreeAndNil(IDTechDecrypt);
                 PacketSuccess := true;
             end else if (CardEventParms <> '') and (ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'MTKSN')),True,True,'') <> '') then begin
                 ProcessLog(ltInfo,'WEBREFER-CREDITAUTH','Using MAGTEK');
                 PaymentRequest := PaymentRequest +  '<CARDEVENTPARAMS>'+
                                    '<MTKSN>'+ ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'MTKSN')),True,True,'') +'</MTKSN>'+
                                    '<MTSESSIONID>' + Trim(GetXMLTagStr(CardEventParms,'MTSESSIONID')) + '</MTSESSIONID>'+
                                    '<MTENCRYPTEDTRACK1>' + Trim(GetXMLTagStr(CardEventParms,'MTENCRYPTEDTRACK1')) + '</MTENCRYPTEDTRACK1>'+
                                    '<MTENCRYPTEDTRACK2>' + Trim(GetXMLTagStr(CardEventParms,'MTENCRYPTEDTRACK2')) + '</MTENCRYPTEDTRACK2>'+
                                    '<MTDEVICESERIAL>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'MTDEVICESERIAL')),True,True,'') + '</MTDEVICESERIAL>'+
                                    '<MTMPDATA>' + Trim(GetXMLTagStr(CardEventParms,'MTMPDATA')) + '</MTMPDATA>'+
                                    '<MTMPSTATUS>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'MTMPSTATUS')),True,True,'') + '</MTMPSTATUS>'+
                                 '</CARDEVENTPARAMS>';
                 PacketSuccess := true;
             end else if (CardEventParms <> '') and (ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCENCTYPE')),True,True,'') <> '') then begin  //2016-10-19 jtm Def OT# 1284
                 ProcessLog(ltInfo,'WEBREFER-CREDITAUTH','Using CARDEVENTPARAMS');
                 PaymentRequest := PaymentRequest +  '<CARDEVENTPARAMS>' +
                         '<ENCDVCDEVICETYPE>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCDEVICETYPE')),True,True,'') + '</ENCDVCDEVICETYPE>'+
                         '<ENCDVCKSN>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCKSN')),True,True,'') + '</ENCDVCKSN>'+
                         '<ENCDVCENCTYPE>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCENCTYPE')),True,True,'') + '</ENCDVCENCTYPE>'+
                         '<ENCDVCENCOAEPPADDED>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCENCOAEPPADDED')),True,True,'') + '</ENCDVCENCOAEPPADDED>'+
                         '<ENCDVCCARDDATASOURCE>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCCARDDATASOURCE')),True,True,'') + '</ENCDVCCARDDATASOURCE>'+
                         '<ENCDVCENCRYPTEDPAN>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCENCRYPTEDPAN')),True,True,'+=/') + '</ENCDVCENCRYPTEDPAN>'+
                         '   <ENCDVCCCEXP>'+ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCCCEXP')),True,True,'')+'</ENCDVCCCEXP>' +
                         '   <ENCDVCCCCVV>'+ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCCCCVV')),True,True,'')+'</ENCDVCCCCVV>' +
                         '   <ENCDVCCCAVS>'+NumericOnly(Request.ContentFields.Values['AVSDATA'])+'</ENCDVCCCAVS>' +
                         '</CARDEVENTPARAMS>';
                  PaymentRequest := PaymentRequest + '   <CCACCOUNT>'+NumericOnly(Request.ContentFields.Values['ACCOUNTNUMBER'])+'</CCACCOUNT>';
                  PacketSuccess := true;
             end else begin
                 URL := Request.ContentFields.Values['REFERURL'] + '?TRANSUCCESS=FALSE';
                 PacketSuccess := false;
                 ProcessLog(ltWarning,'WEBREFER-CREDITAUTH Failure','Empty CARDEVENTPARAMS');
                 ProcessLog(ltWarning,'Empty CARDEVENTPARAMS',CardEventParms);
             end;
         end else begin
            ProcessLog(ltInfo,'WEBREFER-CREDITAUTH','Using CCACCOUNT');
            PaymentRequest := PaymentRequest + '   <CCAVS>'+NumericOnly(Request.ContentFields.Values['AVSDATA'])+'</CCAVS>' +
                           '   <CCEXP>'+NumericOnly(Request.ContentFields.Values['ACCOUNTEXP'])+'</CCEXP>' +
                           '   <CCCVV>'+NumericOnly(Request.ContentFields.Values['CCCVV'])+'</CCCVV>' +
                           '   <CCACCOUNT>'+NumericOnly(Request.ContentFields.Values['ACCOUNTNUMBER'])+'</CCACCOUNT>';
            PacketSuccess := true;
         end;
         if ValidCharsOnly(Trim(Request.ContentFields.Values['CCNAME']),True,False,'/ ') <> '' then begin
              PaymentRequest := PaymentRequest + '   <CCNAME>'+ValidCharsOnly(Trim(Request.ContentFields.Values['CCNAME']),True,False,'/ ')+'</CCNAME>';
         end;
         if (ServiceName <> '') and (OpenXMLGetTag('/CONFIGDATA/WEBREFER/INCLUDESERVICENAME', '') = 'TRUE') then begin //2017-09-20 jtm: F#2150
             PaymentRequest := PaymentRequest +  '<SERVICENAME>'+ServiceName+'</SERVICENAME>';
         end;
         if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then       //2016-9-19 jtm: Feat OT# 1145
            PaymentRequest := PaymentRequest + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';
         if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/INCLUDESTATIONIDENT', '') = 'TRUE') then
            PaymentRequest := PaymentRequest +  '<STATIONIDENT>'+StationIdent+'</STATIONIDENT>';
         if ValidCharsOnly(Request.ContentFields.Values['EMPIDENT'],true,true,'.-_/') <> '' then //2017-05-10 jtm: F#1606
            PaymentRequest := PaymentRequest +  '<EMPIDENT>'+ValidCharsOnly(Request.ContentFields.Values['EMPIDENT'],true,true,'.-_/')+'</EMPIDENT>';
         if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/SENDSESSIONIDTRANIDENTGUID', '') = 'TRUE') then //2017-08-24 jtm:F#2120
            PaymentRequest := PaymentRequest +  '<TRANIDENTGUID>'+ValidCharsOnly(Request.QueryFields.Values['SESSIONID'],True,True,'-')+'</TRANIDENTGUID>';
         if (GuidOnly(Request.ContentFields.Values['DCCGuid']) <> '') then begin //AJS DCC
            PaymentRequest := PaymentRequest +  '<DCCGUID>' +GuidOnly(Request.ContentFields.Values['DCCGuid'])+'</DCCGUID>';
         end;
         if (ValidCharsOnly(Request.ContentFields.Values['DCCOPTIN'],true,false,'') <> '') then begin //AJS DCC
            PaymentRequest := PaymentRequest +  '<DCCOPTIN>' +ValidCharsOnly(Request.ContentFields.Values['DCCOPTIN'],true,false,'')+'</DCCOPTIN>';
         end;
         PaymentRequest := PaymentRequest + '</TRANSACTION>'+CRLF;
         if PacketSuccess then begin
            VarEvaluator.AddValue('GatewayRNID',PaymentRNID);//2017-05-24 jtm: F#1821
            if DomainPlatform = 'DEV' then
               ProcessPPSAPIXML(PaymentRequest, XMLResp,GetAppServerHost,0)
            else
               ProcessPPSAPIXML(PaymentRequest, XMLResp,GetAppServerHost,0);
               if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/USESHA1','FALSE') = 'TRUE') then begin
                  Hash := StringToSHADigestHex(RNID + RNC + GetXMLTag(XMLResp,'TRANSUCCESS') + Request.ContentFields.Values['TRANIDENT'] + GetXMLTag(XMLResp,'CCSYSTEMCODE'));
               end else begin
                  Hash := AnsiUpperCase(AWSAPI.CalcSHA256ToHex(RNID + RNC + GetXMLTag(XMLResp,'TRANSUCCESS') + Request.ContentFields.Values['TRANIDENT'] + GetXMLTag(XMLResp,'CCSYSTEMCODE')));
               end;

            IF GetXMLTag(XMLResp,'CCAUTHCODE') <> '' then begin

               URL := Request.ContentFields.Values['REFERURL'] + '?' +
                      'APPROVALCODE=' + GetXMLTag(XMLResp,'CCAUTHCODE') +
                      '&CCSYSTEMCODE=' + GetXMLTag(XMLResp,'CCSYSTEMCODE') +
                      '&TRANSUCCESS=' + GetXMLTag(XMLResp,'TRANSUCCESS') +
                      '&CCAVSRESP=' + GetXMLTag(XMLResp,'CCAVSRESP') +
                      '&TRANIDENT=' + ValidCharsOnly(Request.ContentFields.Values['TRANIDENT'],True,True,'.-_:/& ') +  //2017-05-10 jtm D#1605
                      '&TXNAUTH=' + Hash;
               if (OpenXMLGetTag('/CONFIGDATA/WEBREFERSUCCESS/SHOWCARDDATA', '') = 'TRUE') and
               ((GetXMLTag(XMLResp,'CCACCOUNT') <> '') and (GetXMLTag(XMLResp,'CCCARDTYPE') <> '')) then begin
                   URL := URL + '&CCACCOUNT=' + NumericOnly(GetXMLTag(XMLResp,'CCACCOUNT')) +
                       '&CCCARDTYPE=' +  GetXMLTag(XMLResp,'CCCARDTYPE');
               end;
               if (OpenXMLGetTag('/CONFIGDATA/WEBREFERSUCCESS/SHOWTRANSARMORTOKEN', '') = 'TRUE') and (GetXMLTag(XMLResp,'TRANSARMORTOKEN') <> '') then begin
                   URL := URL + '&TRANSARMORTOKEN=' + NumericOnly(GetXMLTag(XMLResp,'TRANSARMORTOKEN')) +   //2016-8-22 jtm: Feat OT#1063
                           '&TRANSARMORTOKENPROVIDERID=' + NumericOnly(GetXMLTag(XMLResp,'TRANSARMORPROVIDER')) +
                           '&CCEXP=' + NumericOnly(GetXMLTag(XMLResp,'CCEXP'));
               end;
               if (OpenXMLGetTag('/CONFIGDATA/WEBREFERSUCCESS/SHOWDUPETRANCHECK', '') = 'TRUE') and (GetXMLTag(XMLResp,'DUPETRANCHECK') <> '') then begin
                   URL := URL + '&DUPETRANCHECK=' + trim(GetXMLTag(XMLResp,'DUPETRANCHECK'));  //2016-11-03 jtm: Feat OT#1241
               end;
               if (OpenXMLGetTag('/CONFIGDATA/WEBREFERSUCCESS/SHOWAVSDATA', '') = 'TRUE') then begin //2017-09-20 jtm: F#2193
                   URL := URL + '&AVSDATA=' + trim(NumericOnly(Request.ContentFields.Values['AVSDATA']));  
               end;
            end else if (GetXMLTag(XMLResp,'TRANSUCCESS') = 'TRUE') and (OpenXMLGetTag('/CONFIGDATA/WEBREFER/SHOWSUCCESSONEMPTYAUTHCODE', '') = 'TRUE') then begin //2017-11-16 jtm: D#2087; AVS check will return TRUE, but no AUTHCODE
               URL := Request.ContentFields.Values['REFERURL'] + '?' +
                      'CCSYSTEMCODE=' + GetXMLTag(XMLResp,'CCSYSTEMCODE') +
                      '&TRANSUCCESS=' + GetXMLTag(XMLResp,'TRANSUCCESS') +
                      '&TRANRESPMESSAGE=' + Trim(GetXMLTag(XMLResp,'TRANRESPMESSAGE')) +
                      '&TRANIDENT=' + ValidCharsOnly(Request.ContentFields.Values['TRANIDENT'],True,True,'.-_:/& ') +
                      '&TXNAUTH=' + Hash;
               if (OpenXMLGetTag('/CONFIGDATA/WEBREFERSUCCESS/SHOWTRANSARMORTOKEN', '') = 'TRUE') and (GetXMLTag(XMLResp,'TRANSARMORTOKEN') <> '') then begin
                   URL := URL + '&TRANSARMORTOKEN=' + NumericOnly(GetXMLTag(XMLResp,'TRANSARMORTOKEN')) +
                           '&TRANSARMORTOKENPROVIDERID=' + NumericOnly(GetXMLTag(XMLResp,'TRANSARMORPROVIDER')) +
                           '&CCEXP=' + NumericOnly(GetXMLTag(XMLResp,'CCEXP'));
               end;
               if (OpenXMLGetTag('/CONFIGDATA/WEBREFERSUCCESS/SHOWDUPETRANCHECK', '') = 'TRUE') and (GetXMLTag(XMLResp,'DUPETRANCHECK') <> '') then begin
                   URL := URL + '&DUPETRANCHECK=' + trim(GetXMLTag(XMLResp,'DUPETRANCHECK'));
               end;
               if (OpenXMLGetTag('/CONFIGDATA/WEBREFERSUCCESS/SHOWAVSDATA', '') = 'TRUE') then begin
                   URL := URL + '&AVSDATA=' + trim(NumericOnly(Request.ContentFields.Values['AVSDATA']));  
               end;
            end else begin
               URL := Request.ContentFields.Values['REFERURL'] + '?' +
                      'CCSYSTEMCODE=' + GetXMLTag(XMLResp,'CCSYSTEMCODE') +
                      '&TRANSUCCESS=' + GetXMLTag(XMLResp,'TRANSUCCESS') +
                      '&NONAUTHREASON=' + Trim(GetXMLTag(XMLResp,'TRANRESPMESSAGE')) +
                      '&TRANIDENT=' + ValidCharsOnly(Request.ContentFields.Values['TRANIDENT'],True,True,'.-_:/& ') +  //2017-05-10 jtm D#1605
                      '&TXNAUTH=' + Hash;
               if (OpenXMLGetTag('/CONFIGDATA/WEBREFERFAILURE/SHOWTRANSARMORTOKEN', '') = 'TRUE') and    //2018-01-25 jtm //2018-01-25 jtm F#3566
               ((GetXMLTag(XMLResp,'TRANSARMORTOKEN') <> '')) then begin
                    URL := URL + '&TRANSARMORTOKEN=' + NumericOnly(GetXMLTag(XMLResp,'TRANSARMORTOKEN')) +
                           '&TRANSARMORTOKENPROVIDERID=' + NumericOnly(GetXMLTag(XMLResp,'TRANSARMORPROVIDER')) +
                           '&CCEXP=' + NumericOnly(GetXMLTag(XMLResp,'CCEXP'));
               end;
               if (OpenXMLGetTag('/CONFIGDATA/WEBREFERFAILURE/SHOWAUTHRESPERROR', '') = 'TRUE') and    //2016-06-22 jtm
               ((GetXMLTag(XMLResp,'CCAUTHRESPERRORCODE') <> '')) then begin
                   URL := URL + '&ERRORCODE=' +  GetXMLTag(XMLResp,'CCAUTHRESPERRORCODE');
               end;
            end;
            if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/RETURNSESSIONID', '') = 'TRUE') then begin
               URL := URL + '&SESSIONID=' + ValidCharsOnly(Request.QueryFields.Values['SESSIONID'],True,True,'-');
            end;
            if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/SHOWCUSTOM', '') = 'TRUE') then begin //2017-09-20 jtm: F#2194
                URL := URL + '&CUSTOM=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM'],True,True,'/-%+=-.');
                if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM2'],True,True,'/-%+=') <> '') then begin
                  URL := URL + '&CUSTOM2=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM2'],True,True,'/-%+=-.');
                end;
                if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM3'],True,True,'/-%+=') <> '') then begin
                  URL := URL + '&CUSTOM3=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM3'],True,True,'/-%+=-.');
                end;
                if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM4'],True,True,'/-%+=') <> '') then begin
                  URL := URL + '&CUSTOM4=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM4'],True,True,'/-%+=-.');
                end;
                if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM5'],True,True,'/-%+=') <> '') then begin
                  URL := URL + '&CUSTOM5=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM5'],True,True,'/-%+=-.');
                end;
                if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM6'],True,True,'/-%+=') <> '') then begin
                  URL := URL + '&CUSTOM6=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM6'],True,True,'/-%+=-.');
                end;
            end;
            if (OpenXMLGetTag('/CONFIGDATA/WEBREFERALLOWCVV', '') = 'TRUE') and (GetXMLTag(XMLResp,'CVVRESP') <> '') then begin //AJS: F#2382
                URL := URL + '&CVVRESP=' + (GetXMLTag(XMLResp,'CVVRESP'));
            end;
         end;
      end else begin
         URL := Request.ContentFields.Values['REFERURL'] + '?TRANSUCCESS=FALSE';
         ProcessLog(ltWarning,'WEBREFER-CREDITAUTH Failure','RNID=' + RNID + ', ' +
                                                              'CUSTIDENT=' + Request.ContentFields.Values['CUSTIDENT'] + ', ' +
                                                              'TRANIDENT=' + Request.ContentFields.Values['TRANIDENT'] + ', ' +
                                                              'CREDITAMT=' + Request.ContentFields.Values['CREDITAMT'] + ', ' +
                                                              'LOCALTXNAUTH=' + OurHash + ', ' +
                                                              'REMOTETXNAUTH=' + Trim(Request.ContentFields.Values['TXNAUTH']));

      end;

   end;
   If Operation = 'CHECKAUTH' then begin
      if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/USESHA1','FALSE') = 'TRUE') then begin
         OurHash := StringToSHADigestHex(RNID + RNC + Request.ContentFields.Values['CUSTIDENT'] +
                                           Request.ContentFields.Values['TRANIDENT'] +
                                           Request.ContentFields.Values['CHECKAMT']);
      end else begin
         OurHash := AnsiUpperCase(AWSAPI.CalcSHA256ToHex(RNID + RNC + Request.ContentFields.Values['CUSTIDENT'] +
                                              Request.ContentFields.Values['TRANIDENT'] +
                                              Request.ContentFields.Values['CHECKAMT']));
      end;
      If  OurHash=Trim(Request.ContentFields.Values['TXNAUTH']) then begin

         PaymentRNID := RNID; //2017-05-24 jtm F#1822
         PaymentLocationRNID := NumericOnly(Request.ContentFields.Values['PAYMENTLOCATION']);
         if PaymentLocationRNID <> '' then begin
             RNQuery.Close;                         //check for chain code as well
             RNQuery.SQL.Text := 'Select * from Store where (SystemCode = ' + NumericOnly(PaymentLocationRNID) + ') and (Chaincode = ' + IntToStr(ChainCode) + ')';
             RNQuery.Open;
             if RNQuery.RecordCount = 1 then PaymentRNID := PaymentLocationRNID;
         end;
         ProcessLog(ltInfo, 'RNID: ' + RNID, 'PaymentRNID: ' + PaymentRNID);
         if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/INCLUDESERVICENAME', '') <> 'TRUE') then begin //2017-09-20 jtm: F#2150
            ServiceName := 'ICA'; //default to ICA
         end;
         if ServiceName = '' then ServiceName := 'ICA'; //default to ICA
         PaymentRequest := '<TRANSACTION>'+
                           '   <RNID>'+PaymentRNID+'</RNID>' +
                           '   <TRANSACTIONTYPE>TCAUTH</TRANSACTIONTYPE>'+
                           '   <SERVICENAME>'+ServiceName+'</SERVICENAME>'+
                           '   <CLIENTTXNGUID>' + ClientTxnGUID+'</CLIENTTXNGUID>'+
                           '   <CHECKROUTING>'+NumericOnly(Request.ContentFields.Values['CHECKROUTING'])+'</CHECKROUTING>' +
                           '   <CHECKACCOUNT>'+NumericOnly(Request.ContentFields.Values['CHECKACCOUNT'])+'</CHECKACCOUNT>' +
                           '   <TRANIDENT>'+ValidCharsOnly(Request.ContentFields.Values['TRANIDENT'],True,True,'.-_:/& ')+'</TRANIDENT>' +   //2017-05-10 jtm D#1605
                           '   <CUSTIDENT>'+ValidCharsOnly(Request.ContentFields.Values['CUSTIDENT'],True,True,'.-_:/& ')+'</CUSTIDENT>' +   //2017-05-10 jtm D#1605
                           '   <CHECKTYPE>PERSONAL</CHECKTYPE>' +
                           '   <CHECKAMT>'+Trim(StriReal(ValuReal(Request.ContentFields.Values['CHECKAMT']),2))+'</CHECKAMT>' +
                           '   <CHECKDL>'+ValidCharsOnly(Request.ContentFields.Values['CHECKDL'],True,True,'*')+'</CHECKDL>' +
                           '   <CHECKDLSTATE>'+ValidCharsOnly(Request.ContentFields.Values['CHECKDLSTATE'],True,False,'')+'</CHECKDLSTATE>' +
                           '   <CHECKZIP>' +  ValidCharsOnly(Request.ContentFields.Values['CHECKZIP'],False,True,'-')+  '</CHECKZIP>' +
                           '   <CHECKNAME>' + ValidCharsOnly(Request.ContentFields.Values['CHECKNAME'],True,True,'-. ')+   '</CHECKNAME>' +
                           '   <CHECKFIRSTNAME>' + ValidCharsOnly(Request.ContentFields.Values['CHECKFIRSTNAME'],True,True,'-. ')+  '</CHECKFIRSTNAME>' +
                           '   <CHECKADDRESS>' + ValidCharsOnly(Request.ContentFields.Values['CHECKADDRESS'],True,True,' .-/')+ '</CHECKADDRESS>' +
                           '   <CHECKCITY>' + ValidCharsOnly(Request.ContentFields.Values['CHECKCITY'],True,True,' .-')+    '</CHECKCITY>' +
                           '   <CHECKSTATE>' + ValidCharsOnly(Request.ContentFields.Values['CHECKSTATE'],True,False,'')+    '</CHECKSTATE>' +
                           '   <CHECKPHONE>' + ValidCharsOnly(Request.ContentFields.Values['CHECKPHONE'],False,True,'()-')+  '</CHECKPHONE>' +
                           '   <CHECKNUMBER>' + ValidCharsOnly(Request.ContentFields.Values['CHECKNUMBER'],True,True,' -.')+ '</CHECKNUMBER>' +
                           '   <TRANIDENTGUID>' +ValidCharsOnly(Request.ContentFields.Values['TRANIDENTGUID'],True,True,'-')+   '</TRANIDENTGUID>' +
                           '   <STATIONIDENT>WEB-REFER</STATIONIDENT>';
               if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then    //2016-9-19 jtm: Feat OT# 1145
                   PaymentRequest := PaymentRequest + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';

               PaymentRequest := PaymentRequest + '</TRANSACTION>'+CRLF;
               VarEvaluator.AddValue('GatewayRNID',PaymentRNID);//2017-05-24 jtm: F#1821
               if DomainPlatform = 'DEV' then
                  ProcessPPSAPIXML(PaymentRequest, XMLResp,GetAppServerHost,0)
               else
                  ProcessPPSAPIXML(PaymentRequest, XMLResp,GetAppServerHost,0);
                  if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/USESHA1','FALSE') = 'TRUE') then begin
                     Hash := StringToSHADigestHex(RNID + RNC + GetXMLTag(XMLResp,'TRANSUCCESS') + GetXMLTag(XMLResp,'TCECASTATUS') + Request.ContentFields.Values['TRANIDENT'] + GetXMLTag(XMLResp,'TCSYSTEMCODE'));
                  end else begin
                     Hash := AnsiUpperCase(AWSAPI.CalcSHA256ToHex(RNID + RNC + GetXMLTag(XMLResp,'TRANSUCCESS') + GetXMLTag(XMLResp,'TCECASTATUS') + Request.ContentFields.Values['TRANIDENT'] + GetXMLTag(XMLResp,'TCSYSTEMCODE')));
                  end;

               IF GetXMLTag(XMLResp,'TCAPPROVALCODE') <> '' then begin

                  URL := Request.ContentFields.Values['REFERURL'] + '?' +
                         'APPROVALCODE=' + GetXMLTag(XMLResp,'TCAPPROVALCODE') +
                         '&TCSYSTEMCODE=' + GetXMLTag(XMLResp,'TCSYSTEMCODE') +
                         '&TRANSUCCESS=' + GetXMLTag(XMLResp,'TRANSUCCESS') +
                         '&TCECASTATUS=' + GetXMLTag(XMLResp,'TCECASTATUS') +
                         '&TRANIDENT=' + ValidCharsOnly(Request.ContentFields.Values['TRANIDENT'],True,True,'.-_:/& ') +   //2017-05-10 jtm D#1605
                         '&TXNAUTH=' + Hash;

               end else begin
                  URL := Request.ContentFields.Values['REFERURL'] + '?' +
                         'TCSYSTEMCODE=' + GetXMLTag(XMLResp,'TCSYSTEMCODE') +
                         '&TRANSUCCESS=' + GetXMLTag(XMLResp,'TRANSUCCESS') +
                         '&NONAUTHREASON=' + Trim(GetXMLTag(XMLResp,'TRANRESPMESSAGE')) +
                         '&TRANIDENT=' + ValidCharsOnly(Request.ContentFields.Values['TRANIDENT'],True,True,'.-_:/& ') + //2017-05-10 jtm D#1605
                         '&TXNAUTH=' + Hash;
               end;
               if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/SHOWCUSTOM', '') = 'TRUE') then begin //2017-09-20 jtm: F#2194
                   URL := URL + '&CUSTOM=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM'],True,True,'/-%+=-.');
                   if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM2'],True,True,'/-%+=') <> '') then begin
                     URL := URL + '&CUSTOM2=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM2'],True,True,'/-%+=-.');
                   end;
                   if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM3'],True,True,'/-%+=') <> '') then begin
                     URL := URL + '&CUSTOM3=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM3'],True,True,'/-%+=-.');
                   end;
                   if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM4'],True,True,'/-%+=') <> '') then begin
                     URL := URL + '&CUSTOM4=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM4'],True,True,'/-%+=-.');
                   end;
                   if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM5'],True,True,'/-%+=') <> '') then begin
                     URL := URL + '&CUSTOM5=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM5'],True,True,'/-%+=-.');
                   end;
                   if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM6'],True,True,'/-%+=') <> '') then begin
                     URL := URL + '&CUSTOM6=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM6'],True,True,'/-%+=-.');
                   end;
               end;
      end else begin
         URL := Request.ContentFields.Values['REFERURL'] + '?TRANSUCCESS=FALSE';
         ProcessLog(ltWarning,'WEBREFER-CHECKAUTH Failure','RNID=' + RNID + ', ' +
                                                             'CUSTIDENT=' + Request.ContentFields.Values['CUSTIDENT'] + ', ' +
                                                             'TRANIDENT=' + Request.ContentFields.Values['TRANIDENT'] + ', ' +
                                                             'CHECKAMT=' + Request.ContentFields.Values['CHECKAMT'] + ', ' +
                                                             'LOCALTXNAUTH=' + OurHash + ', ' +
                                                             'REMOTETXNAUTH=' + Trim(Request.ContentFields.Values['TXNAUTH']));
      end;
   end;
   If Operation = 'REPADDDATA' then begin
      if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/USESHA1','FALSE') = 'TRUE') then begin //2018-05-16 ajs: F#4000
         OurHash := StringToSHADigestHex(RNID + RNC + Request.ContentFields.Values['REPCUSTIDENT'] + FormatDateTime('YYYYMMDD', NOW));
      end else begin
         OurHash := AnsiUpperCase(AWSAPI.CalcSHA256ToHex(RNID + RNC + Request.ContentFields.Values['REPCUSTIDENT'] + FormatDateTime('YYYYMMDD', NOW)));
      end;

      If OurHash <> Trim(Request.ContentFields.Values['TXNAUTH']) then begin
         OurFirstHash := OurHash;
         if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/USESHA1','FALSE') = 'TRUE') then begin
            OurHash := StringToSHADigestHex(RNID + RNC + Request.ContentFields.Values['REPCUSTIDENT'] + FormatDateTime('YYYYMMDD', NOW-1));
         end else begin
            OurHash := AnsiUpperCase(AWSAPI.CalcSHA256ToHex(RNID + RNC + Request.ContentFields.Values['REPCUSTIDENT'] + FormatDateTime('YYYYMMDD', NOW-1)));
         end;
      end;

      If OurHash = Trim(Request.ContentFields.Values['TXNAUTH']) then begin
         CardEventParms := ValidCharsOnly(Trim(Request.ContentFields.Values['CARDEVENTPARAMS']),True,True,'-.<>/+=%^?;*: ');
         AppServerSI := trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', ''));
         
         If strtobool(OpenXMLGetTag('/CONFIGDATA/WEBREFER/CHECKIFCARDISDISPERSIBLE[@operation="REPADDDATA"]', 'FALSE')) then begin   // 2019-05-15 bls: DVST-5231
            PaymentRNID := RNID;
            PaymentLocationRNID := NumericOnly(Request.ContentFields.Values['PAYMENTLOCATION']);
            if PaymentLocationRNID <> '' then begin
                RNQuery.Close;
                RNQuery.SQL.Text := 'Select SystemCode, ChainCode from Store where (SystemCode = ' + NumericOnly(PaymentLocationRNID) + ') and (Chaincode = ' + IntToStr(ChainCode) + ')';
                RNQuery.Open;
                if RNQuery.RecordCount = 1 then PaymentRNID := PaymentLocationRNID;
            end;

            CardDetails := TStringList.Create;
            CardDetails.Values['CEP'] := CardEventParms;
            CardDetails.Values['AVS'] := NumericOnly(Request.ContentFields.Values['REPACCOUNTAVS']);
            CardDetails.Values['CCACCOUNT'] := NumericOnly(Request.ContentFields.Values['REPACCOUNTNUMBER']);
            if ServiceName = '' then ServiceName := OpenXMLGetTag('/CONFIGDATA/WEBREFER/PAYSECURESERVICENAME', 'CARD');
            If CheckIfCardIsDisbursable(CardDetails, PaymentRNID, false, ServiceName, ClientTxnGUID, AppServerSI) then begin
               ProcessLog(ltInfo, 'WEBREFER-CHECKDISPERSEMENT', 'User''s card is dispersible.');
            end else begin
               ProcessLog(ltInfo, 'WEBREFER-CHECKDISPERSEMENT', 'User''s card is not dispersible. Check CardEventParams if card is supposed to be dispersible.');
               If strtobool(OpenXMLGetTag('/CONFIGDATA/WEBREFER/HALTOPERATIONIFCARDISNOTDISBURSIBLE[@operation="REPADDDATA"]', 'FALSE')) then begin
                  If strtobool(OpenXMLGetTag('/CONFIGDATA/WEBREFER/USEJSONRESPONSE[@operation="REPADDDATA"]', 'TRUE')) then begin
                     Response.Content := '{ "TRANSUCCESS": false, "TRANRESPMESSAGE": "Card is not dispersible", "REFERURL": "' + ToUTF(ReferURL) + '" }';
                  end else begin
                     Response.Content := ReferURL + '?TRANSUCCESS=FALSE&ISDISBURSABLE=FALSE';
                     if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/SHOWCUSTOM', '') = 'TRUE') then begin //2017-09-20 jtm: F#2194
                        Response.Content := Response.Content + '&CUSTOM=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM'],True,True,'/-%+=-.');
                        if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM2'],True,True,'/-%+=') <> '') then begin
                           Response.Content := Response.Content + '&CUSTOM2=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM2'],True,True,'/-%+=-.');
                        end;
                        if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM3'],True,True,'/-%+=') <> '') then begin
                           Response.Content := Response.Content + '&CUSTOM3=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM3'],True,True,'/-%+=-.');
                        end;
                        if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM4'],True,True,'/-%+=') <> '') then begin
                           Response.Content := Response.Content + '&CUSTOM4=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM4'],True,True,'/-%+=-.');
                        end;
                        if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM5'],True,True,'/-%+=') <> '') then begin
                           Response.Content := Response.Content + '&CUSTOM5=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM5'],True,True,'/-%+=-.');
                        end;
                        if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM6'],True,True,'/-%+=') <> '') then begin
                           Response.Content := Response.Content + '&CUSTOM6=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM6'],True,True,'/-%+=-.');
                        end;
                     end;
                  end;

                  exit;
               end;
            end;
            FreeAndNil(CardDetails);
         end;

         PaymentRequest := '<TRANSACTION>' +
                              ' <RNID>'+RNID +'</RNID>' +
                              ' <TRANSACTIONTYPE>REPADDDATA</TRANSACTIONTYPE>';

         PaymentRequest := PaymentRequest + '   <CLIENTTXNGUID>' + ClientTxnGUID+'</CLIENTTXNGUID>';
         PaymentRequest := PaymentRequest + ' <REPCUSTIDENT>'+ValidCharsOnly(Request.ContentFields.Values['REPCUSTIDENT'],True,True,'/')+'</REPCUSTIDENT>';

         if (AppServerSI <> '') then begin      //2016-9-19 jtm: Feat OT# 1145
            PaymentRequest := PaymentRequest + '<SOLUTIONIDENT>' + AppServerSI + '</SOLUTIONIDENT>';
         end;

         if (CardEventParms <> '') and strtobool(OpenXMLGetTag('/CONFIGDATA/WEBREFER/USECARDEVENTPARAMS', '')) then begin   //2018-12-19 jtm
            if (NumericOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCDEVICETYPE'))) = '3') then begin
              ProcessLog(ltInfo,'WEBREFER-REPADDDATA','Using IDTECH');
              IDTechDecrypt := TIDTechDecrypt.Create(Trim(GetXMLTagStr(CardEventParms,'ENCDVCENCRYPTEDBLOCK')), PL.ProcessLog);
              PaymentRequest := PaymentRequest + IDTechDecrypt.GenerateCardEventParmsXML;
              FreeAndNil(IDTechDecrypt);
              PacketSuccess := true;
            end else if (ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'MTKSN')),True,True,'') <> '') then begin
              ProcessLog(ltInfo,'WEBREFER-REPADDDATA','Using MAGTEK');
              PaymentRequest := PaymentRequest +  '<CARDEVENTPARAMS>'+
                                 '<MTKSN>'+ ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'MTKSN')),True,True,'') +'</MTKSN>'+
                                 '<MTSESSIONID>' + Trim(GetXMLTagStr(CardEventParms,'MTSESSIONID')) + '</MTSESSIONID>'+
                                 '<MTENCRYPTEDTRACK1>' + Trim(GetXMLTagStr(CardEventParms,'MTENCRYPTEDTRACK1')) + '</MTENCRYPTEDTRACK1>'+
                                 '<MTENCRYPTEDTRACK2>' + Trim(GetXMLTagStr(CardEventParms,'MTENCRYPTEDTRACK2')) + '</MTENCRYPTEDTRACK2>'+
                                 '<MTDEVICESERIAL>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'MTDEVICESERIAL')),True,True,'') + '</MTDEVICESERIAL>'+
                                 '<MTMPDATA>' + Trim(GetXMLTagStr(CardEventParms,'MTMPDATA')) + '</MTMPDATA>'+
                                 '<MTMPSTATUS>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'MTMPSTATUS')),True,True,'') + '</MTMPSTATUS>'+
                              '</CARDEVENTPARAMS>';
              PacketSuccess := true;
            end else if (ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCENCTYPE')),True,True,'') <> '') then begin
              ProcessLog(ltInfo,'WEBREFER-REPADDDATA','Using CARDEVENTPARAMS');
              PaymentRequest := PaymentRequest +  '<CARDEVENTPARAMS>' +
                      '<ENCDVCDEVICETYPE>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCDEVICETYPE')),True,True,'') + '</ENCDVCDEVICETYPE>'+
                      '<ENCDVCKSN>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCKSN')),True,True,'') + '</ENCDVCKSN>'+
                      '<ENCDVCENCTYPE>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCENCTYPE')),True,True,'') + '</ENCDVCENCTYPE>'+
                      '<ENCDVCENCOAEPPADDED>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCENCOAEPPADDED')),True,True,'') + '</ENCDVCENCOAEPPADDED>'+
                      '<ENCDVCCARDDATASOURCE>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCCARDDATASOURCE')),True,True,'') + '</ENCDVCCARDDATASOURCE>'+
                      '<ENCDVCENCRYPTEDPAN>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCENCRYPTEDPAN')),True,True,'+=/') + '</ENCDVCENCRYPTEDPAN>'+
                      '   <ENCDVCCCCVV>'+ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCCCCVV')),True,True,'')+'</ENCDVCCCCVV>' +
                      '</CARDEVENTPARAMS>';

               WS := NumericOnly(Request.ContentFields.Values['REPACCOUNTAVS']);//2019-04-05 jtm: DVST-5493
               If WS <> '' then PaymentRequest := PaymentRequest + ' <REPACCOUNTAVS>'+WS+'</REPACCOUNTAVS>';  //need to add the AVS in this tag

               WS := ValidCharsOnly(Request.ContentFields.Values['REPACCOUNTEXP'],False,True,'/');//2019-04-05 jtm: DVST-5493
               If WS <> '' then PaymentRequest := PaymentRequest + ' <REPACCOUNTEXP>'+WS+'</REPACCOUNTEXP>'; //need to add the exp in this tag
               
               PacketSuccess := true;
            end else begin
              URL := Request.ContentFields.Values['REFERURL'] + '?TRANSUCCESS=FALSE';
              PacketSuccess := false;
              ProcessLog(ltWarning,'WEBREFER-REPADDDATA Failure','Unsupported or empty CARDEVENTPARAMS; ENCDVCENCTYPE:'+ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCENCTYPE')),True,True,''));
              ProcessLog(ltWarning,'Empty CARDEVENTPARAMS',CardEventParms);
            end;
         end else begin
            WS := NumericOnly(Request.ContentFields.Values['REPACCOUNTAVS']);
            If WS <> '' then PaymentRequest := PaymentRequest + ' <REPACCOUNTAVS>'+WS+'</REPACCOUNTAVS>';

            WS := NumericOnly(Request.ContentFields.Values['REPACCOUNTNUMBER']);
            If WS <> '' then PaymentRequest := PaymentRequest + ' <REPACCOUNTNUMBER>'+WS+'</REPACCOUNTNUMBER>';

            WS := ValidCharsOnly(Request.ContentFields.Values['REPACCOUNTEXP'],False,True,'/');
            If WS <> '' then PaymentRequest := PaymentRequest + ' <REPACCOUNTEXP>'+WS+'</REPACCOUNTEXP>';

            WS := NumericOnly(Request.ContentFields.Values['REPCHECKROUTING']);
            If WS <> '' then PaymentRequest := PaymentRequest + ' <REPCHECKROUTING>'+WS+'</REPCHECKROUTING>';

            WS := NumericOnly(Request.ContentFields.Values['REPCHECKACCOUNT']);
            If WS <> '' then PaymentRequest := PaymentRequest + ' <REPCHECKACCOUNT>'+WS+'</REPCHECKACCOUNT>';

            WS := ValidCharsOnly(Request.ContentFields.Values['REPLICENSE'],True,True,'*');
            If WS <> '' then PaymentRequest := PaymentRequest + ' <REPLICENSE>'+WS+'</REPLICENSE>';

            WS := ValidCharsOnly(Request.ContentFields.Values['REPLICENSESTATE'], True,False,'');
            If WS <> '' then PaymentRequest := PaymentRequest + ' <REPLICENSESTATE>'+WS+'</REPLICENSESTATE>';
            PacketSuccess := true;
         end;
         PaymentRequest := PaymentRequest + ' </TRANSACTION>'+CRLF;
         if PacketSuccess then begin
         VarEvaluator.AddValue('GatewayRNID',RNID);//2017-05-24 jtm: F#1821
         if DomainPlatform = 'DEV' then
            ProcessPPSAPIXML(PaymentRequest, XMLResp,GetAppServerHost,0)
         else
            ProcessPPSAPIXML(PaymentRequest, XMLResp,GetAppServerHost,0);

         if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/USESHA1','FALSE') = 'TRUE') then begin
            Hash := StringToSHADigestHex(RNID + RNC + GetXMLTag(XMLResp,'TRANSUCCESS') +  GetXMLTag(XMLResp,'REPTOKEN'));
         end else begin
            Hash := AnsiUpperCase(AWSAPI.CalcSHA256ToHex(RNID + RNC + GetXMLTag(XMLResp,'TRANSUCCESS') +  GetXMLTag(XMLResp,'REPTOKEN')));
         end;

         URL := Request.ContentFields.Values['REFERURL'] + '?' +
                      'REPTOKEN=' + GetXMLTag(XMLResp,'REPTOKEN') +
                      '&TRANSUCCESS=' + GetXMLTag(XMLResp,'TRANSUCCESS') +
                      '&TXNAUTH=' + Hash;
         end;
         if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/SHOWCUSTOM', '') = 'TRUE') then begin //2017-09-20 jtm: F#2194
             URL := URL + '&CUSTOM=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM'],True,True,'/-%+=-.');
                if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM2'],True,True,'/-%+=') <> '') then begin
               URL := URL + '&CUSTOM2=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM2'],True,True,'/-%+=-.');
                end;
                if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM3'],True,True,'/-%+=') <> '') then begin
               URL := URL + '&CUSTOM3=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM3'],True,True,'/-%+=-.');
                end;
                if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM4'],True,True,'/-%+=') <> '') then begin
               URL := URL + '&CUSTOM4=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM4'],True,True,'/-%+=-.');
                end;
                if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM5'],True,True,'/-%+=') <> '') then begin
               URL := URL + '&CUSTOM5=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM5'],True,True,'/-%+=-.');
                end;
                if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM6'],True,True,'/-%+=') <> '') then begin
               URL := URL + '&CUSTOM6=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM6'],True,True,'/-%+=-.');
                end;
            end;
      end else begin
         URL := Request.ContentFields.Values['REFERURL'] + '?TRANSUCCESS=FALSE';
         ProcessLog(ltWarning,'WEBREFER-REPADDDATA Failure','RNID=' + RNID + ', ' +
                                                              'REPCUSTIDENT=' + Request.ContentFields.Values['REPCUSTIDENT'] + ', ' +
                                                              'LOCALDATE=' + FormatDateTime('YYYYMMDD', NOW) + ', ' +
                                                              'FIRSTLOCALTXNAUTH=' + OurFirstHash + ', ' +
                                                              'LOCALTXNAUTH=' + OurHash + ', ' +
                                                              'REMOTETXNAUTH=' + Trim(Request.ContentFields.Values['TXNAUTH']));
         if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/SHOWCUSTOM', '') = 'TRUE') then begin //2017-09-20 jtm: F#2150
             URL := URL + '&CUSTOM=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM'],True,True,'/-%+=-.');
             if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM2'],True,True,'/-%+=') <> '') then begin
               URL := URL + '&CUSTOM2=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM2'],True,True,'/-%+=-.');
             end;
             if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM3'],True,True,'/-%+=') <> '') then begin
               URL := URL + '&CUSTOM3=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM3'],True,True,'/-%+=-.');
             end;
             if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM4'],True,True,'/-%+=') <> '') then begin
               URL := URL + '&CUSTOM4=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM4'],True,True,'/-%+=-.');
             end;
             if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM5'],True,True,'/-%+=') <> '') then begin
               URL := URL + '&CUSTOM5=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM5'],True,True,'/-%+=-.');
             end;
             if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM6'],True,True,'/-%+=') <> '') then begin
               URL := URL + '&CUSTOM6=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM6'],True,True,'/-%+=-.');
             end;
         end;
      end;
   end;
   If Operation = 'CCTATOKENIZE' then begin   //2016-9-19 jtm: Feat OT# 1128

      if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/USESHA1','FALSE') = 'TRUE') then begin
         OurHash := StringToSHADigestHex(RNID + RNC + Request.ContentFields.Values['REPCUSTIDENT'] + FormatDateTime('YYYYMMDD', NOW));
      end else begin
         OurHash := AnsiUpperCase(AWSAPI.CalcSHA256ToHex(RNID + RNC + Request.ContentFields.Values['REPCUSTIDENT'] + FormatDateTime('YYYYMMDD', NOW)));
      end;

      If OurHash <> Trim(Request.ContentFields.Values['TXNAUTH']) then begin
         OurFirstHash := OurHash;
         if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/USESHA1','FALSE') = 'TRUE') then begin
            OurHash := StringToSHADigestHex(RNID + RNC + Request.ContentFields.Values['REPCUSTIDENT'] + FormatDateTime('YYYYMMDD', NOW-1));
         end else begin
            OurHash := AnsiUpperCase(AWSAPI.CalcSHA256ToHex(RNID + RNC + Request.ContentFields.Values['REPCUSTIDENT'] + FormatDateTime('YYYYMMDD', NOW-1)));
         end;
      end;

      If OurHash = Trim(Request.ContentFields.Values['TXNAUTH']) then begin


         PaymentRNID := RNID;  //2016-09-29 jtm Feat OT# 1151
         PaymentLocationRNID := NumericOnly(Request.ContentFields.Values['LOCATIONRNID']);
         if PaymentLocationRNID <> '' then begin
             RNQuery.Close;
             RNQuery.SQL.Text := 'Select * from Store where (SystemCode = ' + NumericOnly(PaymentLocationRNID) + ') and (Chaincode = ' + IntToStr(ChainCode) + ')';
             RNQuery.Open;
             if RNQuery.RecordCount = 1 then PaymentRNID := PaymentLocationRNID;
         end;
         ProcessLog(ltInfo, 'RNID: ' + RNID, 'LocationRNID: ' + PaymentRNID);
         PaymentRequest := '<TRANSACTION>' +
                              ' <RNID>'+PaymentRNID +'</RNID>' +
                              ' <TRANSACTIONTYPE>CCTATOKENIZE</TRANSACTIONTYPE>';


         if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/USECARDEVENTPARAMS', '') = 'TRUE') then begin
             CardEventParms := ValidCharsOnly(Trim(Request.ContentFields.Values['CARDEVENTPARAMS']),True,True,'-.<>/+=%^?;* ');
             if (CardEventParms <> '') and (ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCENCTYPE')),True,True,'') <> '')  then begin  //2017-01-20 jtm Def OT# 1284
                 ProcessLog(ltInfo,'WEBREFER-CCTATOKENIZE','Using CARDEVENTPARAMS');
                 PaymentRequest := PaymentRequest +  '<CARDEVENTPARAMS>' +
                         '<ENCDVCDEVICETYPE>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCDEVICETYPE')),True,True,'') + '</ENCDVCDEVICETYPE>'+
                         '<ENCDVCKSN>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCKSN')),True,True,'') + '</ENCDVCKSN>'+
                         '<ENCDVCENCTYPE>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCENCTYPE')),True,True,'') + '</ENCDVCENCTYPE>'+
                         '<ENCDVCENCOAEPPADDED>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCENCOAEPPADDED')),True,True,'') + '</ENCDVCENCOAEPPADDED>'+
                         '<ENCDVCCARDDATASOURCE>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCCARDDATASOURCE')),True,True,'') + '</ENCDVCCARDDATASOURCE>'+
                         '<ENCDVCENCRYPTEDPAN>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCENCRYPTEDPAN')),True,True,'+=/') + '</ENCDVCENCRYPTEDPAN>'+
                         '   <ENCDVCCCEXP>'+ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCCCEXP')),True,True,'')+'</ENCDVCCCEXP>' +
                         '   <ENCDVCCCCVV>'+ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCCCCVV')),True,True,'')+'</ENCDVCCCCVV>' +
                         '   <ENCDVCCCAVS>'+NumericOnly(Request.ContentFields.Values['AVSDATA'])+'</ENCDVCCCAVS>' +
                         '</CARDEVENTPARAMS>';
                  PaymentRequest := PaymentRequest + '   <CCACCOUNT>'+NumericOnly(Request.ContentFields.Values['ACCOUNTNUMBER'])+'</CCACCOUNT>';
                  PacketSuccess := true;
             end else begin
                 URL := Request.ContentFields.Values['REFERURL'] + '?TRANSUCCESS=FALSE';
                 ProcessLog(ltWarning,'WEBREFER-CCTATOKENIZE Failure','Empty CARDEVENTPARAMS');
                 ProcessLog(ltWarning,'Empty CARDEVENTPARAMS',CardEventParms);
             end;
         end else begin
            ProcessLog(ltInfo,'WEBREFER-CCTATOKENIZE','Using CCACCOUNT');
            PaymentRequest := PaymentRequest + '   <CCAVS>'+NumericOnly(Request.ContentFields.Values['AVSDATA'])+'</CCAVS>' +
                           '   <CCEXP>'+NumericOnly(Request.ContentFields.Values['ACCOUNTEXP'])+'</CCEXP>' +
                           '   <CCCVV>'+NumericOnly(Request.ContentFields.Values['CCCVV'])+'</CCCVV>' +
                           '   <CCACCOUNT>'+NumericOnly(Request.ContentFields.Values['ACCOUNTNUMBER'])+'</CCACCOUNT>';
            PacketSuccess  := true;
         end;
         if (ServiceName <> '') and (OpenXMLGetTag('/CONFIGDATA/WEBREFER/INCLUDESERVICENAME', '') = 'TRUE') then begin //2017-09-20 jtm: F#2150
             PaymentRequest := PaymentRequest +  '<SERVICENAME>'+ServiceName+'</SERVICENAME>';
         end;
         PaymentRequest := PaymentRequest + ' <REPCUSTIDENT>'+ValidCharsOnly(Request.ContentFields.Values['REPCUSTIDENT'],True,True,'/')+'</REPCUSTIDENT>';
         PaymentRequest := PaymentRequest + '   <CLIENTTXNGUID>' + ClientTxnGUID+'</CLIENTTXNGUID>';
         if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then  //2016-9-19 jtm: Feat OT# 1145
            PaymentRequest := PaymentRequest + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';

         PaymentRequest := PaymentRequest + ' </TRANSACTION>'+CRLF;
         if PacketSuccess then begin
            VarEvaluator.AddValue('GatewayRNID',PaymentRNID);//2017-05-24 jtm: F#1821
            if DomainPlatform = 'DEV' then
               ProcessPPSAPIXML(PaymentRequest, XMLResp,GetAppServerHost,0)
            else
               ProcessPPSAPIXML(PaymentRequest, XMLResp,GetAppServerHost,0);
            if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/USESHA1','FALSE') = 'TRUE') then begin
               Hash := StringToSHADigestHex(RNID + RNC + GetXMLTag(XMLResp,'TRANSUCCESS') +  GetXMLTag(XMLResp,'TRANSARMORTOKEN'));
            end else begin
               Hash := AnsiUpperCase(AWSAPI.CalcSHA256ToHex(RNID + RNC + GetXMLTag(XMLResp,'TRANSUCCESS') +  GetXMLTag(XMLResp,'TRANSARMORTOKEN')));
            end;
            
            URL := Request.ContentFields.Values['REFERURL'] + '?' +
                         'TRANSUCCESS=' + GetXMLTag(XMLResp,'TRANSUCCESS') +
                         '&TXNAUTH=' + Hash +
                         '&TRANSARMORTOKEN=' + NumericOnly(GetXMLTag(XMLResp,'TRANSARMORTOKEN')) +
                         '&TRANSARMORTOKENPROVIDERID=' + NumericOnly(GetXMLTag(XMLResp,'TRANSARMORPROVIDER')) +
                         '&CCEXP=' + NumericOnly(GetXMLTag(XMLResp,'CCEXP'));

            ProcessLog(ltInfo,'Show Custom',OpenXMLGetTag('/CONFIGDATA/WEBREFER/SHOWCUSTOM', ''));
            if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/SHOWCUSTOM', '') = 'TRUE') then begin //2017-09-20 jtm: F#2194
                URL := URL + '&CUSTOM=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM'],True,True,'/-%+=-.');
                if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM2'],True,True,'/-%+=') <> '') then begin
                  URL := URL + '&CUSTOM2=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM2'],True,True,'/-%+=-.');
                end;
                if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM3'],True,True,'/-%+=') <> '') then begin
                  URL := URL + '&CUSTOM3=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM3'],True,True,'/-%+=-.');
                end;
                if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM4'],True,True,'/-%+=') <> '') then begin
                  URL := URL + '&CUSTOM4=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM4'],True,True,'/-%+=-.');
                end;
                if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM5'],True,True,'/-%+=') <> '') then begin
                  URL := URL + '&CUSTOM5=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM5'],True,True,'/-%+=-.');
                end;
                if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM6'],True,True,'/-%+=') <> '') then begin
                  URL := URL + '&CUSTOM6=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM6'],True,True,'/-%+=-.');
                end;
            end;
            if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/RETURNSESSIONID', '') = 'TRUE') then begin
               URL := URL + '&SESSIONID=' + ValidCharsOnly(Request.QueryFields.Values['SESSIONID'],True,True,'-');
            end;
            if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/ADDSESSIONVALUES', '') = 'TRUE') then begin //2017-01-06 jtm F#1307
               if ((ValidCharsOnly(Request.CookieFields.Values['RNSESSIONID'],True,True,'-') <> '') or (ValidCharsOnly(Request.QueryFields.Values['SESSIONID'],True,True,'-') <> '')) and ValidateSessionID then begin
                   SessionVarEval.AddValue('TRANSARMORTOKEN',NumericOnly(GetXMLTag(XMLResp,'TRANSARMORTOKEN')));
                   SessionVarEval.AddValue('TRANSARMORTOKENPROVIDERID',NumericOnly(GetXMLTag(XMLResp,'TRANSARMORPROVIDER')));
                   SessionVarEval.AddValue('CCEXP',NumericOnly(GetXMLTag(XMLResp,'CCEXP')));
               end;
            end;
            if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/SUPPRESSRESPONSEVALUES', '') = 'TRUE') then begin   //2017-01-20 jtm F#1401
               URL := Request.ContentFields.Values['REFERURL'] + '?' + 'TRANSUCCESS=' + GetXMLTag(XMLResp,'TRANSUCCESS') +
                       '&TXNAUTH=' + Hash +
                       '&SESSIONID=' + ValidCharsOnly(Request.QueryFields.Values['SESSIONID'],True,True,'-');
            end;
            if (OpenXMLGetTag('/CONFIGDATA/WEBREFERSUCCESS/SHOWAVSDATA', '') = 'TRUE') then begin //2017-09-20 jtm: F#2193
                URL := URL + '&AVSDATA=' + trim(NumericOnly(Request.ContentFields.Values['AVSDATA']));
            end;
            if ((GetXMLTag(XMLResp,'TRANSUCCESS') = 'FALSE') and (OpenXMLGetTag('/CONFIGDATA/WEBREFER/SHOWTOKENIZEERRORS', '') = 'TRUE'))then begin //2017-09-20 jtm: F#2195
               URL := URL + '&TRANRESPMESSAGE=' + Trim(GetXMLTag(XMLResp,'TRANRESPMESSAGE')) +
                      '&CCNONAUTHRESP=' + Trim(GetXMLTag(XMLResp,'CCNONAUTHRESP')) +
                      '&TRANRESPERRORCODE=' + Trim(GetXMLTag(XMLResp,'TRANRESPERRORCODE'));
            end;
         end;
      end else begin
         URL := Request.ContentFields.Values['REFERURL'] + '?TRANSUCCESS=FALSE';
         ProcessLog(ltWarning,'WEBREFER-CCTATOKENIZE Failure','RNID=' + RNID + ', ' +
                                                              'REPCUSTIDENT=' + Request.ContentFields.Values['REPCUSTIDENT'] + ', ' +
                                                              'LOCALDATE=' + FormatDateTime('YYYYMMDD', NOW) + ', ' +
                                                              'FIRSTLOCALTXNAUTH=' + OurFirstHash + ', ' +
                                                              'LOCALTXNAUTH=' + OurHash + ', ' +
                                                              'REMOTETXNAUTH=' + Trim(Request.ContentFields.Values['TXNAUTH']));
         if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/SHOWCUSTOM', '') = 'TRUE') then begin //2017-09-20 jtm: F#2194
             URL := URL + '&CUSTOM=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM'],True,True,'/-%+=-.');
             if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM2'],True,True,'/-%+=') <> '') then begin
               URL := URL + '&CUSTOM2=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM2'],True,True,'/-%+=-.');
             end;
             if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM3'],True,True,'/-%+=') <> '') then begin
               URL := URL + '&CUSTOM3=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM3'],True,True,'/-%+=-.');
             end;
             if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM4'],True,True,'/-%+=') <> '') then begin
               URL := URL + '&CUSTOM4=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM4'],True,True,'/-%+=-.');
             end;
             if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM5'],True,True,'/-%+=') <> '') then begin
               URL := URL + '&CUSTOM5=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM5'],True,True,'/-%+=-.');
             end;
             if (ValidCharsOnly(Request.ContentFields.Values['CUSTOM6'],True,True,'/-%+=') <> '') then begin
               URL := URL + '&CUSTOM6=' + ValidCharsOnly(Request.ContentFields.Values['CUSTOM6'],True,True,'/-%+=-.');
             end;
         end;
      end;
   end;
   If (Operation = 'EPICEXTERNALPAGE') then begin   //2017-12-08 jtm: F#2210
      try
         ErrorMessage := '';
         Amount := Trim(StriReal(ValuReal(Request.ContentFields.Values['AMOUNT']),2));
         if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/USESHA1','FALSE') = 'TRUE') then begin
            OurHash := StringToSHADigestHex(RNID + RNC + Request.ContentFields.Values['CUSTIDENT'] + Amount+ FormatDateTime('YYYYMMDD', NOW));
         end else begin
            OurHash := AnsiUpperCase(AWSAPI.CalcSHA256ToHex(RNID + RNC + Request.ContentFields.Values['CUSTIDENT'] + Amount+ FormatDateTime('YYYYMMDD', NOW)));
         end;
         If OurHash <> Trim(Request.ContentFields.Values['TXNAUTH']) then begin
            OurFirstHash := OurHash;
            if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/USESHA1','FALSE') = 'TRUE') then begin
               OurHash := StringToSHADigestHex(RNID + RNC + Request.ContentFields.Values['CUSTIDENT'] + Amount+ FormatDateTime('YYYYMMDD', NOW-1));
            end else begin
               OurHash := AnsiUpperCase(AWSAPI.CalcSHA256ToHex(RNID + RNC + Request.ContentFields.Values['CUSTIDENT'] + Amount+ FormatDateTime('YYYYMMDD', NOW-1)));
            end;
         end;


         If (OurHash = Trim(Request.ContentFields.Values['TXNAUTH'])) then begin

            if (RNSessionID = '') then begin
               if ((ValidCharsOnly(Request.CookieFields.Values['RNSESSIONID'],True,True,'-') = '') and (ValidCharsOnly(Request.QueryFields.Values['SESSIONID'],True,True,'-')= '')) or not ValidateSessionID then begin
                   ProcessLog(ltWarning, 'WEBREFER INVALIDSESSIONID Operation:', Operation + 'CookieField: ' + ValidCharsOnly(Request.CookieFields.Values['RNSESSIONID'],True,True,'-') + 'QueryField: '+ ValidCharsOnly(Request.QueryFields.Values['SESSIONID'],True,True,'-'));
                   ErrorMessage := 'INVALIDSESSIONID';
                   Operation := '';
               end else begin
                  ProcessLog(ltInfo, 'WEBREFER RNSessionID', RNSessionID);
               end
            end else begin
               ProcessLog(ltInfo, 'WEBREFER RNSessionID', RNSessionID);
            end;
            TranType := 0; //card
            if (NumericOnly(Request.ContentFields.Values['TRANTYPE']) = '1') then begin
               TranType := 1;//check
            end;
            BankAccountType := NumericOnly(Request.ContentFields.Values['BankAccountType']);
            if ((BankAccountType = '1') or (BankAccountType = '2'))  then begin
               SessionVarEval.AddValue('BankAccountType',BankAccountType);
            end else begin
               SessionVarEval.AddValue('BankAccountType','0');
            end;

            SessionVarEval.AddValue('PaymentMethod',IntToStr(TranType));

            PaymentsAVS := NumericOnly(Request.ContentFields.Values['AVSDATA']);
            PaymentRNID := RNID;
            PaymentLocationRNID := NumericOnly(Request.ContentFields.Values['PAYMENTLOCATION']);
            if PaymentLocationRNID <> '' then begin
                RNQuery.Close;
                RNQuery.SQL.Text := 'Select * from Store where (SystemCode = ' + NumericOnly(PaymentLocationRNID) + ') and (Chaincode = ' + IntToStr(ChainCode) + ')';
                RNQuery.Open;
                if RNQuery.RecordCount = 1 then PaymentRNID := PaymentLocationRNID;
            end;
            ProcessLog(ltInfo, 'RNID: ' + RNID, 'LocationRNID: ' + PaymentRNID);

            PaymentRequest := '<TRANSACTION>' +
                                 ' <RNID>'+RNID +'</RNID>' +
                                 ' <TRANSACTIONTYPE>REPADDDATA</TRANSACTIONTYPE>'+
                                 '<ENCODING>UTF-8</ENCODING>';
            if (TranType = 0) then begin
               if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/USECARDEVENTPARAMS', '') = 'TRUE') then begin
                   CardEventParms := ValidCharsOnly(Trim(Request.ContentFields.Values['CARDEVENTPARAMS']),True,True,'-.<>/+=%^?;* ');
                   if (CardEventParms <> '') and (ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCENCTYPE')),True,True,'') <> '')  then begin
                       ProcessLog(ltInfo,'WEBREFER-EPICEXTERNALPAGE','Using CARDEVENTPARAMS');
                       PaymentRequest := PaymentRequest +  '<CARDEVENTPARAMS>' +
                               '<ENCDVCDEVICETYPE>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCDEVICETYPE')),True,True,'') + '</ENCDVCDEVICETYPE>'+
                               '<ENCDVCKSN>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCKSN')),True,True,'') + '</ENCDVCKSN>'+
                               '<ENCDVCENCTYPE>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCENCTYPE')),True,True,'') + '</ENCDVCENCTYPE>'+
                               '<ENCDVCENCOAEPPADDED>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCENCOAEPPADDED')),True,True,'') + '</ENCDVCENCOAEPPADDED>'+
                               '<ENCDVCCARDDATASOURCE>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCCARDDATASOURCE')),True,True,'') + '</ENCDVCCARDDATASOURCE>'+
                               '<ENCDVCENCRYPTEDPAN>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCENCRYPTEDPAN')),True,True,'+=/') + '</ENCDVCENCRYPTEDPAN>'+
                               '   <ENCDVCCCEXP>'+ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCCCEXP')),True,True,'')+'</ENCDVCCCEXP>' +
                               '   <ENCDVCCCCVV>'+ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCCCCVV')),True,True,'')+'</ENCDVCCCCVV>' +
                               '   <ENCDVCCCAVS>'+PaymentsAVS+'</ENCDVCCCAVS>' +
                               '</CARDEVENTPARAMS>';
                        PaymentRequest := PaymentRequest + '   <REPACCOUNTNUMBER>'+NumericOnly(Request.ContentFields.Values['ACCOUNTNUMBER'])+'</REPACCOUNTNUMBER>';
                        PaymentRequest := PaymentRequest + '   <REPACCOUNTEXP>'+NumericOnly(Request.ContentFields.Values['EXPMO'])+'/'+NumericOnly(Request.ContentFields.Values['EXPYR'])+'</REPACCOUNTEXP>';//2018-02-14 jtm: D#3861
                        SessionVarEval.AddValue('CardLastFour',RightStr(NumericOnly(Request.ContentFields.Values['ACCOUNTNUMBER']),4));
                        PacketSuccess := true;
                   end else begin
                       ErrorMessage := 'Empty CARDEVENTPARAMS';
                       ProcessLog(ltWarning,'WEBREFER-EPICEXTERNALPAGE Failure','Empty CARDEVENTPARAMS');
                       ProcessLog(ltWarning,'Empty CARDEVENTPARAMS',CardEventParms);
                   end;
               end else begin
                  ProcessLog(ltInfo,'WEBREFER-EPICEXTERNALPAGE','Using CCACCOUNT');
                  PaymentRequest := PaymentRequest + ' <REPACCOUNTNUMBER>'+NumericOnly(Request.ContentFields.Values['ACCOUNTNUMBER'])+'</REPACCOUNTNUMBER>';
                  SessionVarEval.AddValue('CardLastFour',RightStr(WS,4));
                  PaymentRequest := PaymentRequest + ' <REPACCOUNTEXP>'+NumericOnly(Request.ContentFields.Values['EXPMO'])+'/'+NumericOnly(Request.ContentFields.Values['EXPYR'])+'</REPACCOUNTEXP>';

                  PacketSuccess  := true;
               end;
            end else begin
               WS := NumericOnly(Request.ContentFields.Values['CHECKROUTING']);
               If (WS <> '') then begin
                  PaymentRequest := PaymentRequest + ' <REPCHECKROUTING>'+WS+'</REPCHECKROUTING>';
                  SessionVarEval.AddValue('RoutingNumber',WS);
               end;

               WS := NumericOnly(Request.ContentFields.Values['CHECKACCOUNT']);
               If WS <> '' then PaymentRequest := PaymentRequest + ' <REPCHECKACCOUNT>'+WS+'</REPCHECKACCOUNT>';
               SessionVarEval.AddValue('BankLastFour',RightStr(WS,4));

               WS := ValidCharsOnly(Request.ContentFields.Values['CHECKDL'],True,True,'*');
               If WS <> '' then PaymentRequest := PaymentRequest + ' <REPLICENSE>'+WS+'</REPLICENSE>';

               WS := ValidCharsOnly(Request.ContentFields.Values['CHECKDLSTATE'], True,False,'');
               If WS <> '' then PaymentRequest := PaymentRequest + ' <REPLICENSESTATE>'+WS+'</REPLICENSESTATE>';

               WS := ValidCharsOnly(Request.ContentFields.Values['CHECKNAME'],True,True,'-. ');
               If WS <> '' then PaymentRequest := PaymentRequest + ' <CHECKNAME>'+WS+'</CHECKNAME>';
               WS := ValidCharsOnly(Request.ContentFields.Values['CHECKFIRSTNAME'],True,True,'-. ');
               If WS <> '' then PaymentRequest := PaymentRequest + ' <CHECKFIRSTNAME>'+WS+'</CHECKFIRSTNAME>';

               PacketSuccess  := true;
            end;
            PaymentRequest := PaymentRequest + '   <CLIENTTXNGUID>' + ClientTxnGUID+'</CLIENTTXNGUID>';
            PaymentRequest := PaymentRequest + ' <REPCUSTIDENT>'+ValidCharsOnly(Request.ContentFields.Values['CUSTIDENT'],True,True,'/-')+'</REPCUSTIDENT>';
            PaymentRequest := PaymentRequest + '<INCLUDECCBINDETAIL>TRUE</INCLUDECCBINDETAIL>';
            if (PaymentsAVS <> '') then begin
               PaymentRequest := PaymentRequest + ' <REPACCOUNTAVS>'+PaymentsAVS+'</REPACCOUNTAVS>';
            end;
            if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then begin
               PaymentRequest := PaymentRequest + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';
            end;

            PaymentRequest := PaymentRequest + ' </TRANSACTION>'+CRLF;

            if (PacketSuccess) then begin
               PacketSuccess := false;
               VarEvaluator.AddValue('GatewayRNID',PaymentRNID);
               ProcessPPSAPIXML(PaymentRequest, XMLResp,GetAppServerHost,0);

               if (GetXMLTag(XMLResp,'TRANSUCCESS') = 'TRUE') then begin
                  EpicTransactionType := NumericOnly(Request.ContentFields.Values['EpicTransactionType']); //get from session instead
                  RepToken := GetXMLTag(XMLResp,'REPTOKEN');

                  SessionVarEval.AddValue('PaymentNickname',ValidCharsOnly(Request.ContentFields.Values['PAYMENTNICKNAME'],True,True,' '));


                  if (UpperCase(Request.ContentFields.Values['SAVETOKEN']) = 'TRUE') then begin
                     SessionVarEval.AddValue('SAVETOKEN','true');
                  end else begin
                     SessionVarEval.AddValue('SAVETOKEN','false');
                  end;

                  SessionVarEval.AddValue('RepToken',RepToken);
                  SessionVarEval.AddValue('CardType',GetXMLTag(XMLResp,'CCCARDTYPEEX'));
                  SessionVarEval.AddValue('CardIssueType',GetXMLTag(XMLResp,'CARDISSUETYPE'));
                  SessionVarEval.AddValue('CardTypeDesc',GetXMLTag(XMLResp,'CARDTYPEDESC'));
                  SessionVarEval.AddValue('CardCountryCode',GetXMLTag(XMLResp,'COUNTRYCODE'));
                  SessionVarEval.AddValue('CardBankName',GetXMLTag(XMLResp,'BANKNAME'));
                  SessionVarEval.AddValue('CardCommercial',GetXMLTag(XMLResp,'COMMERCIAL'));
                  SessionVarEval.AddValue('CardExpires',GetXMLTag(XMLResp,'REPACCOUNTEXP'));
                  SessionVarEval.AddValue('CardBrand',IntToStr(CardTypeToEpicCardType(GetXMLTag(XMLResp,'CCCARDTYPEEX'))));

                  PaymentRequest := '<TRANSACTION>'+
                              '   <RNID>'+PaymentRNID+'</RNID>' +
                              '   <CLIENTTXNGUID>' + ClientTxnGUID+'</CLIENTTXNGUID>'+
                              '<ENCODING>UTF-8</ENCODING>'+
                              '   <TRANIDENT>'+ValidCharsOnly(Request.ContentFields.Values['TRANIDENT'],True,True,'.-_:/& ')+'</TRANIDENT>' +
                              '   <CUSTIDENT>'+ValidCharsOnly(Request.ContentFields.Values['CUSTIDENT'],True,True,'.-_:/& ')+'</CUSTIDENT>';

                  if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then begin
                     PaymentRequest := PaymentRequest + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';
                  end;

                  if (EpicTransactionType = '1') then begin //Pre-authorize
                     PaymentRequest := PaymentRequest + '   <TRANSACTIONTYPE>CCAUTH</TRANSACTIONTYPE>'+
                                                      '   <CCAUTHTYPE>AUTH</CCAUTHTYPE>'+
                                                      '   <CCAMT>'+Amount+'</CCAMT>'+
                                                      '   <CCCVV>'+NumericOnly(Request.ContentFields.Values['CCCVV'])+'</CCCVV>'; //2018-02-14 jtm: D#3861
                     if (PaymentsAVS <> '') then begin
                        PaymentRequest := PaymentRequest + '<CCAVS>'+PaymentsAVS+'</CCAVS>';
                     end;
                     PaymentRequest := PaymentRequest + '<REPTOKEN>'+RepToken+'</REPTOKEN>' +
                     '   <CCNAME>' + ValidCharsOnly(Request.ContentFields.Values['CCNAME'],True,True,'.- ')+'</CCNAME>';
                     PacketSuccess := true;
                  end else if (EpicTransactionType = '3') then begin //Charge
                     if (TranType = 0) then begin
                        PaymentRequest := PaymentRequest + '   <TRANSACTIONTYPE>CCAUTH</TRANSACTIONTYPE>'+
                                                      '   <CCAUTHTYPE>SALE</CCAUTHTYPE>'+
                                                      '   <CCAMT>'+Amount+'</CCAMT>'+
                                                      '   <CCCVV>'+NumericOnly(Request.ContentFields.Values['CCCVV'])+'</CCCVV>'; //2018-02-14 jtm: D#3861
                        if PaymentsAVS <> '' then
                        PaymentRequest := PaymentRequest + '<CCAVS>'+PaymentsAVS+'</CCAVS>' +
                        '   <CCNAME>' + ValidCharsOnly(Request.ContentFields.Values['CCNAME'],True,True,'.- ')+'</CCNAME>';
                     end else if (TranType = 1) then begin
                        if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/INCLUDESERVICENAME', '') <> 'TRUE') then begin
                           ServiceName := 'ICA'; //default to ICA
                        end;
                        if (ServiceName = '') then ServiceName := 'ICA'; //default to ICA
                        PaymentRequest := PaymentRequest + '   <TRANSACTIONTYPE>TCAUTH</TRANSACTIONTYPE>' +
                                                        '   <CHECKTYPE>PERSONAL</CHECKTYPE>' +
                                                        '   <SERVICENAME>'+ServiceName+'</SERVICENAME>'+
                                                        '   <CHECKAMT>' + Amount + '</CHECKAMT>' +
                                                        '   <TCCHECKNUMBER>' +NumericOnly(Request.ContentFields.Values['CHECKNUMBER']) + '</TCCHECKNUMBER>';
                        if (PaymentsAVS <> '') then begin
                           PaymentRequest := PaymentRequest + '<CHECKZIP>'+PaymentsAVS+'</CHECKZIP>';
                        end;
                     end;
                     PaymentRequest := PaymentRequest + '<REPTOKEN>'+RepToken+'</REPTOKEN>';
                     PacketSuccess := true;
                  end else if (EpicTransactionType = '6') then begin //Tokenization
                     PacketSuccess := false;
                     EpicResult := 1;
                     TranDate := StrToDateTime(GetXMLTag(XMLResp,'SERVERDATE')+' '+GetXMLTag(XMLResp,'SERVERTIME'));
                  end else begin
                     PacketSuccess := false;
                     ErrorMessage := 'Empty/Incorrect EpicTransactionType';
                     EpicResult := 0;
                  end;

                  if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then begin
                     PaymentRequest := PaymentRequest + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';
                  end;
                  PaymentRequest := PaymentRequest + ' </TRANSACTION>'+CRLF;

                  if (PacketSuccess) then begin
                     XMLResp.Clear;

                     ProcessPPSAPIXML(PaymentRequest, XMLResp,GetAppServerHost,0);
                     Try
                        ResponseXML := TOpenXML.CreateFromString(Nil,XMLResp.Text);
                     except
                        On E:Exception do begin
                           ProcessLog(ltWarning, 'Exception ResponseXML error: ', E.Message);
                           ProcessLog(ltWarning, 'Exception ResponseXML: ', XMLResp.Text);
                        end;
                     end;
                     Try
                        ResponseXMLNode := ResponseXML.GetNode('/TRANRESP');
                        ResponseXMLNode := ResponseXMLNode.FindFirstChildElement;
                        while ResponseXMLNode <> nil do begin
                           VarEvaluator.AddValue(ResponseXMLNode.NodeName,ResponseXMLNode.TextContent);
                           ResponseXMLNode := ResponseXMLNode.FindNextSiblingElement;
                        end;
                        ProcessLog(ltInfo, 'VarEvaluator after ResponseXMLNode loop: ', VarEvaluator.Vars.Text);
                     except
                        On E:Exception do begin
                           ProcessLog(ltWarning, 'Exception ResponseXMLNode loop: ', E.Message);
                        end;
                     end;
                     if (TranType = 0) then begin
                        TranDate := StrToDateTime(GetXMLTag(XMLResp,'SERVERDATE')+' '+GetXMLTag(XMLResp,'SERVERTIME'));
                     end else if (TranType = 1) then begin
                        TranDate := StrToDateTime(GetXMLTag(XMLResp,'AUTHDATE'));
                     end;
                     if (GetXMLTag(XMLResp,'TRANSUCCESS') = 'TRUE') then begin
                        EpicResult := 1;
                        SessionVarEval.AddValue('AuthCode',GetXMLTag(XMLResp,'CCAUTHCODE'));
                        SessionVarEval.AddValue('CardBrand',IntToStr(CardTypeToEpicCardType(GetXMLTag(XMLResp,'CCCARDTYPEEX'))));
                        SessionVarEval.AddValue('EpicDeclineType','');
                     end else begin
                        EpicResult := 2;
                        EpicDeclineType := CCAuthRespErrorCodeToEpicDeclineType(GetXMLTag(XMLResp,'CCAUTHRESPERRORCODE'));
                        ErrorMessage := GetXMLTag(XMLResp,'CCNONAUTHRESP');
                        SessionVarEval.AddValue('EpicDeclineType',IntToStr(EpicDeclineType));
                        ProcessLog(ltInfo,'WEBREFER-EPICEXTERNALPAGE EpicDecline TempusDecline',IntToStr(EpicDeclineType)+' ' + GetXMLTag(XMLResp,'CCAUTHRESPERRORCODE'));
                     end;

                  end;
               end else begin
                  ErrorMessage := 'repadddata failure';
               end;
           end else begin
              ErrorMessage := 'packet creation failure';
           end;
         end else begin
             ProcessLog(ltWarning,'WEBREFER-EPICEXTERNALPAGE Failure','RNID=' + RNID + ', ' + 'CUSTIDENT=' + Request.ContentFields.Values['CUSTIDENT'] + ', ' +
                                                                 'LOCALDATE=' + FormatDateTime('YYYYMMDD', NOW) + ', ' +
                                                                 'LOCALTXNAUTH=' + OurHash + ', ' +
                                                                 'FIRSTLOCALTXNAUTH=' + OurFirstHash + ', ' +
                                                                 'AMOUNT='+ Amount + ',' +
                                                                 'REMOTETXNAUTH=' + Trim(Request.ContentFields.Values['TXNAUTH']));
            ErrorMessage := 'Hash failure';
         end;
         SessionVarEval.AddValue('EXPMO',NumericOnly(Request.ContentFields.Values['EXPMO']));
         expyear := NumericOnly(Request.ContentFields.Values['EXPYR']);
         if (expyear <> '') then begin
            expyear := '20' + expyear;
         end;
         SessionVarEval.AddValue('EXPYR',expyear);
         SessionVarEval.AddValue('EpicResult',IntToStr(EpicResult));
         SessionVarEval.AddValue('BANKACCOUNTTYPE',NumericOnly(Request.ContentFields.Values['BANKACCOUNTTYPE']));

         SessionVarEval.AddValue('ErrorMessage',ErrorMessage);
         RNProfileDI := TTADODataLayer.Create(RNDB);
         RNProfile := TTProfile.Create(PaymentRNID,false, RNProfileDI);
         TranDateStr := FormatDateTime('YYYY-MM-DD',TranDate) + 'T' + FormatDateTime('HH:NN:SS',TranDate) +GetTimeZoneBiasByNameString(RNProfile.StoreTZ)+':00';
         SessionVarEval.AddValue('TranDate',TranDateStr);
         if (EpicPostTransactionResult()) then begin
            ErrorMessage := '';
         end else begin
            ErrorMessage := 'error updating Epic';
            if (((EpicTransactionType = '1') or (EpicTransactionType = '3')) and (EpicResult = 1)) then begin  //if we have a successful transaction but can't update epic, we need to reverse the tran
               PaymentRequest := '';
               if (TranType = 0) then begin
                  PaymentRequest := '<TRANSACTION>'+
                              '<RNID>'+PaymentRNID+'</RNID>' +
                              '<CLIENTTXNGUID>' + ClientTxnGUID+'</CLIENTTXNGUID>'+
                              '<ENCODING>UTF-8</ENCODING>'+
                              '<TRANSACTIONTYPE>CCREVERSE</TRANSACTIONTYPE>' +
                              '<CCSYSTEMCODE>'+GetXMLTag(XMLResp,'CCSYSTEMCODE')+'</CCSYSTEMCODE>'+
                              '</TRANSACTION>';
               end else if (TranType = 1) then begin
                  PaymentRequest := '<TRANSACTION>'+
                              '<RNID>'+PaymentRNID+'</RNID>' +
                              '<CLIENTTXNGUID>' + ClientTxnGUID+'</CLIENTTXNGUID>'+
                              '<ENCODING>UTF-8</ENCODING>'+
                              '<TRANSACTIONTYPE>TCECAVOID</TRANSACTIONTYPE>' +
                              '<TCSYSTEMCODE>'+GetXMLTag(XMLResp,'TCSYSTEMCODE')+'</TCSYSTEMCODE>'+
                              '</TRANSACTION>';
               end;
               if (PaymentRequest <> '') then begin
                  XMLResp.Clear;
                  ProcessPPSAPIXML(PaymentRequest, XMLResp,GetAppServerHost,0);
                  ProcessLog(ltInfo,'WEBREFER-EPICEXTERNALPAGE Tempus reverse/void',GetXMLTag(XMLResp,'TRANSUCCESS')+':'+ GetXMLTag(XMLResp,'CCSYSTEMCODE')+GetXMLTag(XMLResp,'TCSYSTEMCODE')+':'+GetXMLTag(XMLResp,'TRANRESPMESSAGE'));
               end;
            end;
         end;
         if (ErrorMessage = '') then begin
            Response.Content := 'SUCCESS';
         end else begin
            Response.Content := 'FAILURE: '+ErrorMessage;
         end;
         if (assigned(ResponseXML)) then begin
            FreeAndNil(ResponseXML);
         end;
         XMLResp.Free;
         exit;
      except
         on E:Exception do begin
            ProcessPortalException(E.Message);
            Response.Content := 'FAILURE: '+ErrorMessage;
            exit;
          end;
      end;
   end;
   try
      for i:=0 to Request.ContentFields.Count-1 do begin
         ContentFieldsLogInt := ContentFieldsLogInt + Length(Request.ContentFields[i]) +1;
      end;
   except
      on E:Exception do begin
         ProcessLog(ltWarning, 'ContentFieldsLogInt exception:', E.Message);
      end;
   end;
   ProcessLog(ltInfo,'WEBREFER CONTENT','ContentLength:'+ IntToStr(Request.ContentLength) + ' ContentFieldsLengthLog:' + IntToStr(ContentFieldsLogInt));
   ProcessLog(ltInfo,'WEBREFER CONTENT','ContentLength:' + IntToStr(Request.ContentLength) + ' LengthOfContent:' +  IntToStr(Length(Request.Content)));
   If URL <> '' then begin
      Response.Content := '<head><title>'+ GetConfigString('REFERRALREDIRECTTITLE','Payment Redirect')+'</title>' +
                          '<meta http-equiv="refresh" content="0;URL=' + URL+'"></head>';
      ProcessLog(ltInfo,'WEBREFER REFERURL=',URL);
      try
         for i:=0 to Request.ContentFields.Count-1 do begin
            ContentFieldsLog := ContentFieldsLog + ' ' + Request.ContentFields.Names[i];
         end;
      except
         on E:Exception do begin
            ProcessLog(ltWarning, 'ContentFieldsLog exception:', E.Message);
         end;
      end;
      ProcessLog(ltInfo,'WEBREFER SUCCESS','Operation:' + Operation + ' ContentFieldsLog:' + ContentFieldsLog);
   end else begin
      Response.Content := 'INVALID REQUEST';
      try
         for i:=0 to Request.ContentFields.Count-1 do begin
            ContentFieldsLog := ContentFieldsLog + ' ' + Request.ContentFields.Names[i];
         end;
      except
         on E:Exception do begin
            ProcessLog(ltWarning, 'ContentFieldsLog exception:', E.Message);
         end;
      end;
      ProcessLog(ltInfo,'WEBREFER INVALID REQUEST','Operation:' + Operation + ' ContentFieldsLog:' + ContentFieldsLog);
   end;

   XMLResp.Free;
end;

Function TCustomerInfoModule.AddCustomer(RNID : STRING; CustGUID : String; InputXML : TOpenXML) :String;

var
   email : String;
   password : string;
Begin
      Result := '';

      If InputXML <> NIL then begin
         EMail := InputXML.GetValueAsWideString('/TRANSACTION/EMAIL');
         password := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/PASSWORD'),True,True, '+/=');
         if (Password <> '') and (CustGUID = '') then Password := CardUtil.STDBase64Decode(Password);
      end else begin
         Email := Trim(Request.ContentFields.Values['email']);
         password := trim(Request.ContentFields.Values['password']);
      end;



      EMail := ValidCharsOnly(Email,True,True,'_.-#@+/');
      ReplaceString(Email,'--','-');

      If CustGUID = '' then  CustGUID := GenerateGUID;

      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from Customers where (StoreCode = '+RNID + ') and (CustomerCode = ''' + CustGUID + ''')'); //This will return an empty ds
      RNQuery.Open;
      if RNQuery.RecordCount = 0 then begin

         RNQuery.Insert;
         ProcessLog(ltinfo,'AddingCustomerAccount',CustGUID);
         RNQuery.FieldByName('CustomerCode').AsString := Custguid;
         RNQuery.FieldByName('Storecode').AsString := RNID;
         RNQuery.FieldByName('ChainCode').AsInteger := ChainCode;
         RNQuery.FieldByName('StartDate').AsDateTime := Now;
         RNQuery.FieldByName('LastWeblogon').AsDateTime := Now;
         RNQuery.FieldByName('Email').AsString := Trim(UpCaseString(Email));
         RNQuery.FieldByName('ConfirmGUID').AsString := GenerateGUID;

         if GetConfigBoolean('REQUIREVALIDATION',True) then begin
            RNQuery.FieldByName('ConfirmGUID').AsString := GenerateGUID;
         end else begin
            RNQuery.FieldByName('ConfirmGUID').AsString := 'VALIDATED';
         end;


         If InputXML <> NIL then
            LoadCustomerXMLData(RNQuery, InputXML)
         else
            LoadCustomerFormData(RNQUERY);
         if Password = '' then Password := Generateguid;
         If OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/CASESENSITIVE', 'FALSE') = 'FALSE' then Password := UpCaseString(Password);

         RNQuery.FieldByName('PasswordBcrypt').AsString := BCryptPassword(Password, trim(custguid));

         ProcessLog(ltinfo,'AddingCustomerAccount before post',RNQuery.FieldByName('SystemCode').AsString);
         RNQuery.Post;
         RNQuery.Close;
         RNQuery.SQL.Clear;
         RNQuery.SQL.Add('Select * from Customers where (StoreCode = '+RNID + ') and (Customercode = ''' + Custguid + ''')');
         RNQuery.Open;

         CustomerSC :=RNQuery.FieldByName('SystemCode').AsInteger;
         ProcessLog(ltinfo,'AddingCustomerAccount',Stri(CustomerSC,-1));
      end else begin
         If InputXML <> NIL then begin
            RNQuery.Edit;
            UpdateCustomerXMLData(RNQuery, InputXML);
            RNQuery.Post;
            RNQuery.Close;
            RNQuery.SQL.Clear;
            RNQuery.SQL.Add('Select * from Customers where (StoreCode = '+RNID + ') and (Customercode = ''' + Custguid + ''')');
            RNQuery.Open;
            ProcessLog(ltinfo,'UpdatingCustomerAccount',Custguid);
         end;
         Custguid := RNQuery.FieldByName('CustomerCode').AsString;
         CustomerSC := RNQuery.FieldByName('SystemCode').AsInteger;
      end;

      Result := Custguid;
end;

Procedure TCustomerInfoModule.UpdateCustomerXMLData(ADS : TDataSet; InputXML : TOpenXML);
var
   LastName, FirstName : string;

Begin
   If InputXML.GetValueAsWideString('/TRANSACTION/LASTNAME') <> '' then begin
      LastName := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/LASTNAME'),True,True,'-'' '); //2018-06-20 bls: F#4834
      ADS.FieldByName('LastName').AsString := LastName; //2018-06-20 bls: F#4834
   end;

   If InputXML.GetValueAsWideString('/TRANSACTION/FIRSTNAME') <> '' then begin
      FirstName := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/FIRSTNAME'),True,True,'-'' '); //2018-06-20 bls: F#4834
      ADS.FieldByName('FirstName').AsString := FirstName;
   end;

   If InputXML.GetValueAsWideString('/TRANSACTION/ADDRESS') <> '' then
      ADS.FieldByName('Address').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/ADDRESS') , True, True, ' ');

   If InputXML.GetValueAsWideString('/TRANSACTION/ADDRESS2') <> '' then
      ADS.FieldByName('HomeAddress2').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/ADDRESS2') , True, True, ' ');

   If InputXML.GetValueAsWideString('/TRANSACTION/CITY') <> '' then
      ADS.FieldByName('City').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/CITY') , True, True, ' ');

   If InputXML.GetValueAsWideString('/TRANSACTION/STATE') <> '' then
      ADS.FieldByName('State').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/STATE') , True, False, ' ');

   If InputXML.GetValueAsWideString('/TRANSACTION/ZIP') <> '' then
      ADS.FieldByName('ZIP').AsString := NumericOnly(InputXML.GetValueAsWideString('/TRANSACTION/ZIP') );

   If InputXML.GetValueAsWideString('/TRANSACTION/PHONE') <> '' then
      ADS.FieldByName('HPhone').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/PHONE') , False, True, '-');

   If InputXML.GetValueAsWideString('/TRANSACTION/MOBILEPHONE') <> '' then
      ADS.FieldByName('MobilePhone').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/MOBILEPHONE') , False, True, '-');

   If InputXML.GetValueAsWideString('/TRANSACTION/TITLE') <> '' then
      ADS.FieldByName('Salutation').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/TITLE') , True, False, '');

   If InputXML.GetValueAsWideString('/TRANSACTION/COMPANYNAME') <> '' then
      ADS.FieldByName('Employer').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/COMPANYNAME') , True, True, ' ');

   If InputXML.GetValueAsWideString('/TRANSACTION/COMPANYADDRESS') <> '' then
      ADS.FieldByName('WorkAddress1').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/COMPANYADDRESS') , True, True, ' ');

   If InputXML.GetValueAsWideString('/TRANSACTION/COMPANYADDRESS2') <> '' then
      ADS.FieldByName('WorkAddress2').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/COMPANYADDRESS2') , True, True, ' ');

   If InputXML.GetValueAsWideString('/TRANSACTION/COMPANYCITY') <> '' then
      ADS.FieldByName('WorkCity').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/COMPANYCITY') , True, True, ' ');

   If InputXML.GetValueAsWideString('/TRANSACTION/COMPANYSTATE') <> '' then
      ADS.FieldByName('WorkState').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/COMPANYSTATE'), True, False, '');

   If InputXML.GetValueAsWideString('/TRANSACTION/COMPANYZIP') <> '' then
      ADS.FieldByName('WorkZip').AsString := NumericOnly(InputXML.GetValueAsWideString('/TRANSACTION/COMPANYZIP'));

   If InputXML.GetValueAsWideString('/TRANSACTION/ACCOUNTNUMBER') <> '' then
      ADS.FieldByName('AccountNumber').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/ACCOUNTNUMBER'),True,True,' /.-');

   If InputXML.GetValueAsWideString('/TRANSACTION/COMPANYPHONE') <> '' then
      ADS.FieldByName('WPhone').AsString := NumericOnly(InputXML.GetValueAsWideString('/TRANSACTION/COMPANYPHONE'));

   If InputXML.GetValueAsWideString('/TRANSACTION/COMPANYEXTENSION') <> '' then
      ADS.FieldByName('WorkExtension').AsString := NumericOnly(InputXML.GetValueAsWideString('/TRANSACTION/COMPANYEXTENSION'));

end;

Procedure TCustomerInfoModule.LoadCustomerXMLData(ADS : TDataSet; InputXML : TOpenXML);
var
   LastName, FirstName : string;

Begin

   If InputXML.GetValueAsWideString('/TRANSACTION/LASTNAME') <> '' then begin
      LastName := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/LASTNAME'),True,True,'-'' '); //2018-06-20 bls: F#4834
      ADS.FieldByName('LastName').AsString := LastName; //2018-06-20 bls: F#4834
   end;

   If InputXML.GetValueAsWideString('/TRANSACTION/FIRSTNAME') <> '' then begin
      FirstName := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/FIRSTNAME'),True,True,'-'' ');
      ADS.FieldByName('FirstName').AsString := FirstName;
   end;

   ADS.FieldByName('Address').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/ADDRESS') , True, True, ' ');
   ADS.FieldByName('HomeAddress2').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/ADDRESS2') , True, True, ' ');
   ADS.FieldByName('City').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/CITY') , True, True, ' ');
   ADS.FieldByName('State').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/STATE') , True, False, ' ');

   ADS.FieldByName('ZIP').AsString := NumericOnly(InputXML.GetValueAsWideString('/TRANSACTION/ZIP') );

   ADS.FieldByName('HPhone').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/PHONE') , False, True, '-');
   ADS.FieldByName('MobilePhone').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/MOBILEPHONE') , False, True, '-');
   ADS.FieldByName('Salutation').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/TITLE') , True, False, '');


   ADS.FieldByName('Employer').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/COMPANYNAME') , True, True, ' ');
   ADS.FieldByName('WorkAddress1').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/COMPANYADDRESS') , True, True, ' ');
   ADS.FieldByName('WorkAddress2').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/COMPANYADDRESS2') , True, True, ' ');

   ADS.FieldByName('WorkCity').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/COMPANYCITY') , True, True, ' ');
   ADS.FieldByName('WorkState').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/COMPANYSTATE'), True, False, '');
   ADS.FieldByName('WorkZip').AsString := NumericOnly(InputXML.GetValueAsWideString('/TRANSACTION/COMPANYZIP'));

   ADS.FieldByName('AccountNumber').AsString := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/ACCOUNTNUMBER'),True,True,' /.-');


   ADS.FieldByName('WPhone').AsString := NumericOnly(InputXML.GetValueAsWideString('/TRANSACTION/COMPANYPHONE'));
   ADS.FieldByName('WorkExtension').AsString := NumericOnly(InputXML.GetValueAsWideString('/TRANSACTION/COMPANYEXTENSION'));

end;

Procedure TCustomerInfoModule.LoadCustomerFormData(ADS : TDataSet);
var
   LastName, FirstName : string;

Begin
   If Request.ContentFields.Values['lastname'] <> '' then begin
      LastName := ValidCharsOnly(Request.ContentFields.Values['lastname'],True,True,'-'' '); //2018-06-20 bls: F#4834
      ADS.FieldByName('LastName').AsString := LastName;
   end else begin
      LastName := ValidCharsOnly(Request.ContentFields.Values['ParentLast'],True,True,'-'' '); //2018-06-20 bls: F#4834
      ADS.FieldByName('LastName').AsString := LastName; //2018-06-20 bls: F#4834
   end;

   If Request.ContentFields.Values['firstname'] <> '' then begin
      FirstName := ValidCharsOnly(Request.ContentFields.Values['firstname'],True,True,'-'' ');
      ADS.FieldByName('FirstName').AsString := FirstName;
   end else begin
      FirstName := ValidCharsOnly(Request.ContentFields.Values['ParentFirst'],True,True,'-'' ');
      ADS.FieldByName('FirstName').AsString := FirstName;
   end;

   If Request.ContentFields.Values['parentdob'] <> '' then begin
      Try
         ADS.FieldByName('DOB').AsString := Request.ContentFields.Values['parentdob'];
      except
         on E:Exception do begin
         ProcessLog(ltWarning, 'Attempting date as string:', E.Message);
         end;
      end;
      Try
         ADS.FieldByName('DOB').AsDateTime := StrToDate(Request.ContentFields.Values['parentdob']);
      except
         On E:Exception do begin
         ProcessLog(ltInfo, 'Attempting date as datetime:', E.Message);
         end;
      end;
   end;
   
   ADS.FieldByName('Address').AsString := ValidCharsOnly(Request.ContentFields.Values['HomeAddress'], True, True, '/- ');
   ADS.FieldByName('HomeAddress2').AsString := ValidCharsOnly(Request.ContentFields.Values['HomeAddress2'], True, True, '/- ');
   ADS.FieldByName('City').AsString := ValidCharsOnly(Request.ContentFields.Values['HomeCity'], True, True, ' ');
   ADS.FieldByName('State').AsString := ValidCharsOnly(Request.ContentFields.Values['HomeState'], True, False, ' ');
   ADS.FieldByName('ZIP').AsString := NumericOnly(Request.ContentFields.Values['HomeZip']);

   ADS.FieldByName('HPhone').AsString := ValidCharsOnly(Request.ContentFields.Values['HomePhone'], False, True, '-');
   ADS.FieldByName('MobilePhone').AsString := ValidCharsOnly(Request.ContentFields.Values['HomeMobile'], False, True, '-');
   ADS.FieldByName('Salutation').AsString := ValidCharsOnly(Request.ContentFields.Values['ParentTitle'], True, False, '');

   ADS.FieldByName('Employer').AsString := ValidCharsOnly(Request.ContentFields.Values['WorkName'], True, True, ' ');
   ADS.FieldByName('WorkAddress1').AsString := ValidCharsOnly(Request.ContentFields.Values['workaddress'], True, True, '/- ');
   ADS.FieldByName('WorkAddress2').AsString := ValidCharsOnly(Request.ContentFields.Values['workaddress2'], True, True, '/- ');

   ADS.FieldByName('WorkCity').AsString := ValidCharsOnly(Request.ContentFields.Values['WorkCity'], True, True, ' ');
   ADS.FieldByName('WorkState').AsString := ValidCharsOnly(Request.ContentFields.Values['WorkState'], True, False, '');
   ADS.FieldByName('WorkZip').AsString := NumericOnly(Request.ContentFields.Values['WorkZip']);

   ADS.FieldByName('AccountNumber').AsString := ValidCharsOnly(Request.ContentFields.Values['accountnumber'],True,True,' /.-');


   ADS.FieldByName('WPhone').AsString := NumericOnly(Request.ContentFields.Values['workPhone']);
   ADS.FieldByName('WorkExtension').AsString := NumericOnly(Request.ContentFields.Values['Workext']);

   ADS.FieldByName('CUSTOM1').AsString := ValidCharsOnly(Request.ContentFields.Values['CUSTOM1'], True, True, ' .,-/;');
   ADS.FieldByName('CUSTOM2').AsString := ValidCharsOnly(Request.ContentFields.Values['CUSTOM2'], True, True, ' .,-/;');
   ADS.FieldByName('CUSTOM3').AsString := ValidCharsOnly(Request.ContentFields.Values['CUSTOM3'], True, True, ' .,-/;');
   ADS.FieldByName('CUSTOM4').AsString := ValidCharsOnly(Request.ContentFields.Values['CUSTOM4'], True, True, ' .,-/;');
   ADS.FieldByName('CUSTOM5').AsString := ValidCharsOnly(Request.ContentFields.Values['CUSTOM5'], True, True, ' .,-/;');
   ADS.FieldByName('CUSTOM6').AsString := ValidCharsOnly(Request.ContentFields.Values['CUSTOM6'], True, True, ' .,-/;');
   ADS.FieldByName('CUSTOM7').AsString := ValidCharsOnly(Request.ContentFields.Values['CUSTOM7'], True, True, ' .,-/;');
   ADS.FieldByName('CUSTOM8').AsString := ValidCharsOnly(Request.ContentFields.Values['CUSTOM8'], True, True, ' .,-/;');
   ADS.FieldByName('CUSTOM9').AsString := ValidCharsOnly(Request.ContentFields.Values['CUSTOM9'], True, True, ' .,-/;');
   ADS.FieldByName('CUSTOM10').AsString := ValidCharsOnly(Request.ContentFields.Values['CUSTOM10'], True, True, ' .,-/;');
end;

procedure TCustomerInfoModule.LoadCustomerFormData(ADS: TDataSet; const AQueryFields, AContentFields: TStrings);
var
   LastName, FirstName,AccountNum : string;
Begin
   if (AContentFields.Values['lastname'] <> '') then begin
      LastName := ValidCharsOnly(AContentFields.Values['lastname'],True,True,'-'' '); //2018-06-20 bls: F#4834
   end else if (AContentFields.Values['ParentLast'] <> '') then begin
      LastName := ValidCharsOnly(AContentFields.Values['ParentLast'],True,True,'-'' '); //2018-06-20 bls: F#4834
   end;
   if (LastName <> '') then ADS.FieldByName('LastName').AsString := LastName; //2018-06-20 bls: F#4834
   if (AContentFields.Values['firstname'] <> '') then begin
      FirstName := ValidCharsOnly(AContentFields.Values['firstname'],True,True,'-'' ');
   end else if (AContentFields.Values['ParentFirst'] <> '') then begin
      FirstName := ValidCharsOnly(AContentFields.Values['ParentFirst'],True,True,'-'' ');
   end;
   if (FirstName <> '') then ADS.FieldByName('FirstName').AsString := FirstName;

   if (AContentFields.Values['middlename'] <> '') then begin
      ADS.FieldByName('middlename').AsString := ValidCharsOnly(AContentFields.Values['middlename'],True,True,'-'' '); //2018-06-20 bls: F#4834
   end;

   if (AContentFields.Values['parentdob'] <> '') then begin
      try
         ADS.FieldByName('DOB').AsString := AContentFields.Values['parentdob'];
      except
         on E:Exception do begin
         ProcessLog(ltWarning, 'Attempting date as string:', E.Message);
         end;
      end;
      try
         ADS.FieldByName('DOB').AsDateTime := StrToDate(AContentFields.Values['parentdob']);
      except
         On E:Exception do begin
         ProcessLog(ltInfo, 'Attempting date as datetime:', E.Message);
         end;
      end;
   end;

   if (ValidCharsOnly(AContentFields.Values['HomeAddress'], True, True, '/- ') <> '') then ADS.FieldByName('Address').AsString := ValidCharsOnly(AContentFields.Values['HomeAddress'], True, True, '/- ');
   ADS.FieldByName('HomeAddress2').AsString := ValidCharsOnly(AContentFields.Values['HomeAddress2'], True, True, '/- ');
   if (ValidCharsOnly(AContentFields.Values['HomeCity'], True, True, ' ') <> '') then ADS.FieldByName('City').AsString := ValidCharsOnly(AContentFields.Values['HomeCity'], True, True, ' ');
   if (ValidCharsOnly(AContentFields.Values['HomeState'], True, False, ' ') <> '') then ADS.FieldByName('State').AsString := ValidCharsOnly(AContentFields.Values['HomeState'], True, False, ' ');
   if (NumericOnly(AContentFields.Values['HomeZip']) <> '') then ADS.FieldByName('ZIP').AsString := NumericOnly(AContentFields.Values['HomeZip']);
   if (ValidCharsOnly(AContentFields.Values['country'], True, False, '- ') <> '') then ADS.FieldByName('country').AsString := ValidCharsOnly(AContentFields.Values['country'], True, False, '- ');
   if (ValidCharsOnly(AContentFields.Values['HomePhone'], False, True, '-') <> '') then ADS.FieldByName('HPhone').AsString := ValidCharsOnly(AContentFields.Values['HomePhone'], False, True, '-');
   ADS.FieldByName('MobilePhone').AsString := ValidCharsOnly(AContentFields.Values['HomeMobile'], False, True, '-');
   ADS.FieldByName('Salutation').AsString := ValidCharsOnly(AContentFields.Values['ParentTitle'], True, False, '');

   ADS.FieldByName('Employer').AsString := ValidCharsOnly(AContentFields.Values['WorkName'], True, True, ' ');
   ADS.FieldByName('WorkAddress1').AsString := ValidCharsOnly(AContentFields.Values['workaddress'], True, True, '/- ');
   ADS.FieldByName('WorkAddress2').AsString := ValidCharsOnly(AContentFields.Values['workaddress2'], True, True, '/- ');

   ADS.FieldByName('WorkCity').AsString := ValidCharsOnly(AContentFields.Values['WorkCity'], True, True, ' ');
   ADS.FieldByName('WorkState').AsString := ValidCharsOnly(AContentFields.Values['WorkState'], True, False, '');
   ADS.FieldByName('WorkZip').AsString := NumericOnly(AContentFields.Values['WorkZip']);

   AccountNum := '';
   if (AContentFields.Values['accountnumber'] <> '') then begin
      AccountNum:= ValidCharsOnly(AContentFields.Values['accountnumber'],True,True,' /.-');
   end else if (AContentFields.Values['parentaccountnumber'] <> '') then begin
      AccountNum:= ValidCharsOnly(AContentFields.Values['parentaccountnumber'],True,True,' /.-');
   end else if (AContentFields.Values['memberID'] <> '') then begin
      AccountNum := ValidCharsOnly(AContentFields.Values['memberID'],True,True,' /.-');
   end else if (AContentFields.Values['ApplicantID'] <> '') then begin
      AccountNum := ValidCharsOnly(AContentFields.Values['ApplicantID'],True,True,' /.-');
   end else if (AContentFields.Values['EmployerAccountID'] <> '') then begin
      AccountNum := ValidCharsOnly(AContentFields.Values['EmployerAccountID'],True,True,' /.-');
   end;
   if (AccountNum <> '') then ADS.FieldByName('AccountNumber').AsString :=  AccountNum;
   ADS.FieldByName('WPhone').AsString := NumericOnly(AContentFields.Values['workPhone']);
   ADS.FieldByName('WorkExtension').AsString := NumericOnly(AContentFields.Values['Workext']);

   ADS.FieldByName('CUSTOM1').AsString := ValidCharsOnly(AContentFields.Values['CUSTOM1'], True, True, ' .,-/;');
   ADS.FieldByName('CUSTOM2').AsString := ValidCharsOnly(AContentFields.Values['CUSTOM2'], True, True, ' .,-/;');
   ADS.FieldByName('CUSTOM3').AsString := ValidCharsOnly(AContentFields.Values['CUSTOM3'], True, True, ' .,-/;');
   ADS.FieldByName('CUSTOM4').AsString := ValidCharsOnly(AContentFields.Values['CUSTOM4'], True, True, ' .,-/;');
   ADS.FieldByName('CUSTOM5').AsString := ValidCharsOnly(AContentFields.Values['CUSTOM5'], True, True, ' .,-/;');
   ADS.FieldByName('CUSTOM6').AsString := ValidCharsOnly(AContentFields.Values['CUSTOM6'], True, True, ' .,-/;');
   ADS.FieldByName('CUSTOM7').AsString := ValidCharsOnly(AContentFields.Values['CUSTOM7'], True, True, ' .,-/;');
   ADS.FieldByName('CUSTOM8').AsString := ValidCharsOnly(AContentFields.Values['CUSTOM8'], True, True, ' .,-/;');
   ADS.FieldByName('CUSTOM9').AsString := ValidCharsOnly(AContentFields.Values['CUSTOM9'], True, True, ' .,-/;');
   ADS.FieldByName('CUSTOM10').AsString := ValidCharsOnly(AContentFields.Values['CUSTOM10'], True, True, ' .,-/;');

end;

Function TCustomerInfoModule.OpenCustomerQuery : boolean;
const
   METHOD_NAME = 'TCustomerInfoModule.OpenCustomerQuery(...)'; // 2019-4-17 ss DVST-3126
var
   CustGUID : String;
Begin
   CustGUID := GuidOnly(Request.queryfields.Values['CUSTGUID']);
   Result := False;
   If (customersc = -1) and  (CustomerMembType = 'ADMIN') and (CustGUID <> '') then begin //if we're admin, and there is a cust guid, use it
      Result := OpenCustomerQueryGUID('',CustGUID)
   end else begin
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from Customers where (SystemCode = '+Stri(CustomerSC,-1) + ')');
      RNQuery.Open;
      Result := RNQuery.RecordCount = 1;
   end;
   ProcessLog(ltDebug,METHOD_NAME,'RNQuery.SQL.Text = '+RNQuery.SQL.Text);// 2019-4-17 ss DVST-3126
   ProcessLog(ltDebug,METHOD_NAME,'Result = '+BoolToStr(Result));// 2019-4-17 ss DVST-3126
end;
function TCustomerInfoModule.OpenCustomerQuery(AQueryFields: TStrings): boolean;
var
   CustGUID : String;
Begin
   CustGUID := GuidOnly(AQueryFields.Values['CUSTGUID']);
   Result := False;

   If (customersc = -1) and  (CustomerMembType = 'ADMIN') and (CustGUID <> '') then begin //if we're admin, and there is a cust guid, use it
      Result := OpenCustomerQueryGUID('',CustGUID)
   end else begin
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from Customers where (SystemCode = '+Stri(CustomerSC,-1) + ')');
      RNQuery.Open;
      Result := RNQuery.RecordCount = 1;
   end;

end;
Function TCustomerInfoModule.OpenCustomerQueryGUID(RNID : String; CustGUID : String) : boolean;
const
   METHOD_NAME = 'TCustomerInfoModule.OpenCustomerQueryGUID(...)';//2019-4-17 ss DVST-3126
Begin
   Result := False;
   CustGUID := GuidONly(CustGUID);
   If CustGUID = '' then exit;
   RNQuery.Close;
   RNQuery.SQL.Clear;
   If RNID = '' then
      RNQuery.SQL.Add('Select * from Customers where (ChainCode =  ' + Stri(ChainCode,-1) + ') and (CustomerCode=''' + CustGUID + ''')')
   else
      RNQuery.SQL.Add('Select * from Customers where (Storecode =  ' + RNID + ') and (CustomerCode=''' + CustGUID + ''')');
   RNQuery.Open;
   
   Result := RNQuery.RecordCount = 1;
   ProcessLog(ltInfo, METHOD_NAME, 'Result = '+BoolToStr(Result));//2019-4-17 ss DVST-3126
end;

Function TCustomerInfoModule.GenerateCustomerProfile(RNID : String; CustGUID : String) : String;
var
   WS : String;
Begin
   Result := '';
   If not OpenCustomerQueryGUID(RNID,CustGUID) then exit;
   WS := LoadWebFileFromFolder('CustomerProfile.htm', 'PPADMIN');
   ReplaceString(WS, '%ERROR%', '');
   DSSubStrings(WS,'EMAIL,FIRSTNAME,LASTNAME,ADDRESS,CITY,STATE,ZIP,HPHONE,WPHONE,MOBILEPHONE,EMPLOYER,WORKADDRESS1,WORKADDRESS2,WORKCITY,WORKSTATE,WORKZIP,WORKEXTENSION,ACCOUNTNUMBER,CUSTOM1,CUSTOM2,CUSTOM3,CUSTOM4,CUSTOM5,CUSTOM6,CUSTOM7,CUSTOM8,CUSTOM9,CUSTOM10,BALANCEDUE',RNQuery); // 2019-2-13 SS DVST-93: Add BALANCEDUE
   ReplaceString(WS,'%PAYMENTGRID%',GenerateCustomerPaymentsOnFileAdmin(CustGUID));
   ReplaceString(WS,'%CUSTGUID%',CustGUID);
   Result := WS;
end;
Function TCustomerInfoModule.AddCheckToAccount(const CustGUID, RNID : String; InputXML : TOpenXML) : String;
Var
  XMLResp : TStringList;
  WS : String;
  ATARouting    : String;
  ATAAccount    : String;
  ATADL         : String;
  ATADLState    : String;
  ATABankName   : String;  //RNQuery.FieldByName('PaymentName').AsString
  PaymentName   : String; //2014-09-26 bah:

  PaymentAddress : String;
  PaymentCity : String;
  PaymentState : String;
  PaymentZip : String;
begin
   If InputXML <> nil then begin
        ATARouting     := NumericOnly(InputXML.GetValueAsWideString('/TRANSACTION/BANKROUTING'));
        ATAAccount     := NumericOnly(InputXML.GetValueAsWideString('/TRANSACTION/BANKACCOUNTNUMBER'));
        ATADL          := ValidCharsOnly(UpCaseString(InputXML.GetValueAsWideString('/TRANSACTION/CHECKWRITERDL')),True,True,'*');
        ATADLState     := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/CHECKWRITERDLSTATE'),True,True,'');
        PaymentName    := ValidCharsOnly(UpCaseString(Trim(InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTNAME'))),True, True, ' -');    //2014-09-26 bah:
        ATABankName    := '';
        PaymentAddress := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/ACCOUNTADDRESS'), True, True, ' -.');
        PaymentCity    := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/ACCOUNTCITY'), True, False, ' ');
        PaymentState   := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/ACCOUNTSTATE'), True, False, ' ');
        PaymentZip     := NumericOnly(InputXML.GetValueAsWideString('/TRANSACTION/ACCOUNTZIP'));
   end else begin
        ATARouting    := NumericOnly(Request.ContentFields.Values['BankRouting']);
        ATAAccount    := NumericOnly(Request.ContentFields.Values['BankNumber']);
        ATADL         := ValidCharsOnly(UpCaseString(Request.ContentFields.Values['driversno']),True,True,'*');
        ATADLState    := ValidCharsOnly(Request.ContentFields.Values['driversstate'],True,True,'');
        ATABankName   := ValidCharsOnly(Request.ContentFields.Values['BankName'], True,true, ' ');
        PaymentName   := '';
   end;

   if (PaymentName = '') then begin                     //2014-09-26 bah:
       PaymentName := 'Bank Account ' + MaskStr(ATAAccount,DigitsToMask(ATAAccount));
   end;

   RNQuery.Close;
   RNQuery.SQL.Clear;
   RNQuery.SQL.Add('Select * from CustPayment where (CustGUID = '''+GuidOnly(CustGUID) + ''')');
   RNQuery.Open;
   RNQuery.Insert;
   RNQuery.FieldByName('CustGUID').AsString := CustGUID;
   RNQuery.FieldByName('PaymentGUID').AsString := GenerateGUID;
   RNQuery.FieldByName('PaymentType').AsString := 'CHECK';
   RNQuery.FieldByName('ServiceName').AsString := 'ICA';
   RNQuery.FieldByName('CheckRouting').AsString := ATARouting;
   RNQuery.FieldByName('CheckAccount').AsString := MaskStr(ATAAccount,DigitsToMask(ATAAccount));
   RNQuery.FieldByName('PaymentName').AsString := PaymentName;
   RNQuery.FieldByName('LicenseNum').AsString := ATADL;
   RNQuery.FieldByName('LicenseState').AsString :=  ATADLstate;
   RNQuery.FieldByName('CheckBN').AsString := ATABankName;
   RNQuery.FieldByName('DateAdded').AsDateTime := Now;

   if PaymentAddress <> '' then begin
      RNQuery.FieldByName('PAYMENTADDRESS').AsString := PaymentAddress;
   end;
   if PaymentCity <> '' then begin
      RNQuery.FieldByName('PAYMENTCITY').AsString := PaymentCity;
   end;
   if PaymentState <> '' then begin
      RNQuery.FieldByName('PAYMENTSTATE').AsString := PaymentState;
   end;
   if PaymentZip <> '' then begin
      RNQuery.FieldByName('PAYMENTZIP').AsString := PaymentZip;
   end;

   XMLResp := TStringList.Create;
   WS := '<TRANSACTION>' +
         ' <RNID>'+RNID +'</RNID>' +
         ' <TRANSACTIONTYPE>REPADDDATA</TRANSACTIONTYPE>' +
         ' <REPCHECKROUTING>'+ ATARouting+'</REPCHECKROUTING>' +
         ' <REPCHECKACCOUNT>'+ATAAccount+'</REPCHECKACCOUNT>'+
         ' <REPCUSTIDENT>'+Trim(RNQuery.FieldByName('PaymentGUID').AsString)+'</REPCUSTIDENT>'+
         ' <REPLICENSE>'+ATADL+'</REPLICENSE>'+
         ' <REPLICENSESTATE>'+ATADLstate+'</REPLICENSESTATE>';

   if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then     //2016-9-19 jtm: Feat OT# 1145
      WS := WS + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';

   WS := WS + ' </TRANSACTION>'+CRLF;
   VarEvaluator.AddValue('GatewayRNID',RNID);//2017-05-24 jtm: F#1821
   ProcessPPSAPIXML(WS, XMLResp,GetAppServerHost,0);

   RNQuery.FieldByName('PaymentToken').AsString := GetXMLTag(XMLResp,'REPTOKEN');
   Result := GetXMLTag(XMLResp,'REPTOKEN');
   XMLResp.Free;
   RNQuery.Post;

end;


Function TCustomerInfoModule.GetCustomerActivePaymentCount(CustGUID : String):Integer;
Begin
   RNQuery.Close;
   RNQuery.SQL.Clear;
   RNQuery.SQL.Add('Select * from CustPayment where (CustPayment.CustGUID = '''+CustGUID + ''') and (Hidden = 0)');
   RNQuery.Open;
   Result := RNQuery.RecordCount;
   RNQuery.Close;
end;

Function TCustomerInfoModule.GenerateCustomerPaymentsOnFileAdmin(CustGUID : String) : String;
var
  CG : String;
  SchedCnt : Integer;
Begin
   RNQuery.Close;
   RNQuery.SQL.Clear;
   RNQuery.SQL.Clear;
   RNQuery.SQL.Add('declare @CustGuid as char(40);');
   RNQuery.SQL.Add('set @CustGuid = :CustGUID;');
   RNQuery.SQL.Add('Select cp.* from CustPayment cp ');
   RNQuery.SQL.Add('where cp.CUSTGUID = @CustGuid and cp.HIDDEN = 0');
   RNQuery.Parameters.ParamByName('CustGUID').Value := GuidOnly(CustGUID);
   RNQuery.Open;
   CG := '<table class="paymenthist"><TR><Th><B>Payment Type</B></Th><Th><B>Description</B></Th><Th><B>Action</B></Th></TR>';

   If RNQuery.RecordCount >0  then begin
      While Not RNQuery.EOF do begin
         SchedCnt := ComputeCustomerSchedulesUsedByPaymentGUID(CustGUID,(RNQuery.FieldByName('PaymentGUID').AsString));

         if Trim(RNQuery.FieldByName('PaymentType').AsString) = 'CHECK' then begin
            CG := CG + '<tr><td>CHECK</TD><td>' + Trim(RNQuery.FieldByName('PaymentName').AsString)+'</td>';
         If SchedCnt > 0 then
               CG := CG + '<TD>Cancel scheduled payments to remove</TD></TR>'
            else
               CG := CG + '<TD><a href="" title="Remove Payment" onclick="RemoveCustomerPayment('''+CustGUID+''','''+Trim(RNQuery.FieldByName('PAYMENTGUID').AsString)+'''); return false;" class="mdbutton">Remove Bank Account</a></td></tr>';
         end;
         if Trim(RNQuery.FieldByName('PaymentType').AsString) = 'CARD' then begin
            CG := CG + '<tr><td>CARD</TD><td>' + Trim(RNQuery.FieldByName('PaymentName').AsString)+ ' Expires ' + FormatDateTime('MM/YY', RNquery.FieldByName('CardExpires').asDateTime) + '</td>';
            If SchedCnt > 0 then
               CG := CG + '<TD>Cancel scheduled payments to remove</TD></TR>'
            else
               CG := CG + '<TD><a href="" title="Remove Payment" onclick="RemoveCustomerPayment('''+CustGUID+''','''+Trim(RNQuery.FieldByName('PAYMENTGUID').AsString)+'''); return false;" class="mdbutton">Remove Credit Card</a></td></tr>';
         end;

         RNQuery.Next;
      end;
   end else begin
      CG := CG + '<TR><TD><B>**NO PAYMENT METHODS ON FILE**</B></TD></TR>';
   end;
   Result := cg + '</TABLE>' + '<BR>';

end;

Function TCustomerInfoModule.RemovePayment(CustGUID : String; PaymentGUID : String) : Boolean;
Begin
   RNQuery.Close;
   RNQuery.SQL.Clear;
   RNQuery.SQL.Add('update CustPayment set hidden = 1 where (CustGUID = '''+CustGUID + ''') and (PaymentGUID = ''' + PaymentGUID + ''')');
   Result := RNQuery.ExecSQL = 1;
end;

Function TCustomerInfoModule.LoadWebFileFromFolder(FN : String;FolderName : String) : String;
var
   WS : String;
   INCL : String;
   FilePath : String;
   includeEatEndIfOnInclude : boolean;



   Procedure GetFileNameToLoad(FN : String);
   Begin
      ProcessLog(ltInfo,'Looking for file ' + FN + ' ' + Foldername,InstanceGUID);

      FilePath := 'C:\Inetpub\wwwroot\'+DomainHostFolder+'\';  //First look in the domain host folder
      If FileExists(FilePath + FN) then begin
         ProcessLog(ltInfo,'Found ' + FN + ' in ' + DomainHostFolder,InstanceGUID);
         Exit;                    //if it's not there, look in the default template folder
      end;

      If FolderName <> '' then begin
         FilePath := 'C:\Inetpub\wwwroot\'+DomainHostFolder+'\'+FolderName+'\';  //First look in the domain host folder and foldername    //2016-3-28 jtm
         If FileExists(FilePath + FN) then begin
            ProcessLog(ltInfo,'Found ' + FN + ' in ' + DomainHostFolder +'\'+FolderName,InstanceGUID);
            Exit;
         end;
         FilePath := 'C:\Inetpub\wwwroot\'+FolderName+'\';  //If there is a specified foldername, look nowhere else
         If FileExists(FilePath + FN) then begin
            ProcessLog(ltInfo,'Found ' + FN + ' in ' + FolderName,InstanceGUID);
            Exit;                    //if it's not there, look in the default template folder
         end;
      end;

      If (FolderName = '') AND (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SEARCHFOLDER') <> '') then begin
         ProcessLog(ltInfo,'Looking for ' + FN + ' in SEARCHFOLDER ' + OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SEARCHFOLDER') + ' ' + Foldername,InstanceGUID);
         FilePath := 'C:\Inetpub\wwwroot\'+OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SEARCHFOLDER')+'\';  //If there is a specified foldername, look nowhere else
         If FileExists(FilePath + FN) then Exit;                    //if it's not there, look in the default template folder
      end;

      FilePath := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/INDUSTRYTEMPLATEFOLDER');
      If (FilePath <> '') then begin //if the folder exists but the file doesn't  then use default
         ProcessLog(ltInfo,'Looking for ' + FN + ' in INDUSTRYTEMPLATEFOLDER ' + OpenXMLGetTag('/CONFIGDATA/UIPARAMS/INDUSTRYTEMPLATEFOLDER') + ' ' + Foldername,InstanceGUID);
         If FileExists(FilePath + FN) then Exit;
      end;

      FilePath := 'C:\Inetpub\wwwroot\DefaultTemplate\';
   end;
   Function ReplaceXMLEscapeInclude(Var AStr : String; OpenTag, CloseTag : String) : Boolean;
   var
      FirstPart : String;
      Params : String;
      IncPos : Integer;
      XMLStr : String;
      XMLTag : String;
      DefaultValue : String;
      XMLValue :String;
   Begin
      XMLStr := Astr;
      IncPos := Pos(OpenTag,XMLStr);
      Result := False;
      If IncPOS > 0 then begin
         Result := True;
         FirstPart := Copy(XMLStr,1,IncPos-1);
         Delete(XMLStr,1,IncPos-1 + Length(OpenTag));
         IncPos := Pos(CloseTag,XMLStr);
         If IncPOS = 0 then exit; //No close tag
         Params := Copy(XMLStr,1,IncPos -1);
         Delete(XMLStr,1, IncPos -1 + length(CloseTag));
         ParseToChar(Params, ''''); //Strip leading quote
         XMLTag := ParseToChar(Params, ''''); //Strip leading quote
         ParseToChar(Params, ''''); //Strip leading quote
         DefaultValue := ParseToChar(Params, ''''); //Strip leading quote
         XMLValue := '';
         Try
            If OpenTag = '<!--getxmltag(' then begin
               XMLValue := OpenXMLGetTag(XMLTag);
            end else begin // Injects the document with the entirety of the content in the XMLTag
               DomainConfigXMLNode := DomainConfigXML.GetNode(XMLTag);
               XMLValue := DomainConfigXML.GetContextNodeAsXMLString(DomainConfigXMLNode,true);

               ReplaceString(XMLValue,#13,''); // Replaces a carriage return character '\r' with an empty character
               ReplaceString(XMLValue,#10,''); // Replaces a line feed return character '\n' with an empty character
               ReplaceString(XMLValue,#9,''); // Replaces a horizontal tab character '\t' with an empty character 
               ReplaceString(XMLValue,'      ',''); // Replaces 6 spaces in a row with nothing //2018-06-20 bls: F#4898
            end
         except
            On E:Exception do begin
            end;
         end;
         If XMLValue = '' then XMLValue := DefaultValue;
         AStr := FirstPart + XMLValue + XMLStr;
      end;
   end;
   Function ReplaceExpressionEscapeInclude(Var AStr : String; OpenTag, CloseTag : String) : Boolean;
   var
      FirstPart : String;
      Params : String;
      IncPos : Integer;
      ExprStr : String;
      Expr : String;
      DefaultValue : String;
      EXPRValue :String;
   Begin
      ExprStr := Astr;
      IncPos := Pos(OpenTag,ExprStr);
      Result := False;
      If IncPOS > 0 then begin
         Result := True;
         FirstPart := Copy(ExprStr,1,IncPos-1);
         Delete(ExprStr,1,IncPos-1 + Length(OpenTag));
         IncPos := Pos(CloseTag,ExprStr);
         If IncPOS = 0 then exit; //No close tag
         Params := Copy(ExprStr,1,IncPos -1);
         Delete(ExprStr,1, IncPos -1 + length(CloseTag));
         EXPRValue := '';
         Try
            EXPRValue := VarExprEvalAsString('',Params);
         except
            On E:Exception do begin
            end;
         end;

         AStr := FirstPart + ExprValue + ExprStr;
      end;
   end;

   Function ReplaceIf(Var AStr : String) : Boolean;
   var
      FirstPart : String;
      IncPos : Integer;
      NPos : Integer;
      XMLStr : String;
      XMLTag : String;
      DefaultValue : String;
      XMLValue :String;
      Expression : String;
      ExprResult : String;
      OpenTag : String;
      CloseTag : String;

   Begin
      OpenTag := '<!--if(';
      CloseTag := ')-->';
      XMLStr := Astr;
      IncPos := Pos(OpenTag,XMLStr);
      Result := False;
      If IncPOS > 0 then begin
         Result := True;
         FirstPart := Copy(XMLStr,1,IncPos-1); // Copies original text just before <!--if(
         Delete(XMLStr,1,IncPos-1 + Length(OpenTag)); // Deletes original test and <!--if(

         IncPos := Pos(CloseTag,XMLStr); // Finds the location of the next closest )-->
         If IncPOS = 0 then exit; //No close tag
         Expression := Copy(XMLStr,1,IncPos -1); // Copies the Expression just before )-->
         Delete(XMLStr,1, IncPos -1 + length(CloseTag)); // Deletes Expression text along with )-->

         Try
            ExprResult := VarExprEvalAsString('',Expression); // Checks to see if the expression in the tags is true or not
         except
            On E:Exception do begin
            end;
         end;
         incPos := Pos('<!--endif-->',XMLStr); // Finds the position of the next closest <!--endif-->
         NPos := Pos(OpenTag,XMLStr); // Finds the position of the next closest open tag
         If ExprResult = 'TRUE' then begin
            while (NPos > 0) AND (NPos < incPos) do begin //2018-06-20 bls: F#4654
               ReplaceIf(XMLStr); // If the next closest open tag is closer than the <!--endif--> then replaceif again
         incPos := Pos('<!--endif-->',XMLStr);
         NPos := Pos(OpenTag,XMLStr);
            end;
            Utility.SReplaceString(XmlStr,'<!--endif-->',''); // Replaces the closest remaining <!--endif--> with nothing
         end else begin
            while (NPos > 0) AND (NPos < incPos) do begin //2018-06-20 bls: F#4654
               ReplaceIf(XMLStr);
               incPos := Pos('<!--endif-->',XMLStr);
               NPos := Pos(OpenTag, XMLStr);
            end;
            If IncPos > 0 then begin
                Delete(XMLStr,1,IncPos -1 + Length('<!--endif-->'));
            end;
         end;
         If XMLValue = '' then XMLValue := DefaultValue;
         AStr := FirstPart + {'-->' + Expression + '<--'+} XMLStr;
      end;
   end;
   Function ReplaceInclude(Var AStr : String) : Boolean;
   var
      FirstPart : String;
      IncPos : Integer;
      XMLStr : String;
      XMLTag : String;
      DefaultValue : String;
      XMLValue :String;
      Expression : String;
      ExprResult : String;
      OpenTag : String;
      CloseTag : String;

   Begin
      OpenTag := '<!--include('; // Open Tag
      CloseTag := ')-->'; // Closing Tag
      XMLStr := Astr; // XMLStr is the loaded in html
      IncPos := Pos(OpenTag,XMLStr); // Find the position of the open tag
      Result := False; // Default to false
      If IncPOS > 0 then begin // If the open tag is found
         Result := True;  // We can keep searching for more
         FirstPart := Copy(XMLStr,1,IncPos-1); // Copy everything up to the open tag
         Delete(XMLStr,1,IncPos-1 + Length(OpenTag)); // Delete everything before and including the open tag

         IncPos := Pos(CloseTag,XMLStr); // Find the position of the close tag
         If IncPOS = 0 then exit; //No close tag then exit
         Expression := Copy(XMLStr,1,IncPos -1); // Grab the expression to evaluate
         Delete(XMLStr,1, IncPos -1 + length(CloseTag)); // Delete everything up to and including the close tag

         Try
            ExprResult := LoadWebFileFromFolder(Expression,FolderName); // Load the file and perform a bunch of checks
         except
            On E:Exception do begin
            end;
         end;
         if(includeEatEndIfOnInclude) then begin
            incPos := Pos('<!--endif-->',XMLStr); // Find the position of endif?????
            If IncPos > 0 then begin // If it is found
                Delete(XMLStr,1,IncPos -1 + Length('<!--endif-->')); // Delete everything up to and including it
            end;
         end;
         AStr := FirstPart + ExprResult +  XMLStr; // Formulate the new html
      end;
   end;

Begin
   inc(LoadFileRecursionDepth);
   If LoadFileRecursionDepth > 5 then exit;

   GetFileNameToLoad(FN);
   ProcessLog(ltInfo,'Loading ' + FN + ' from ' + FilePath,InstanceGUID);
   WS := LoadFileToStr(FilePath  + FN);

   If POS('<!--#include file="include_header.html"-->', WS) <> 0 then begin
      Incl := LoadWebFileFromFolder('include_header.htm', FolderName);
      ReplaceString(WS,'<!--#include file="include_header.html"-->', incl);
   end;
   If POS('<!--#include file="include_footer.html"-->', WS) <> 0 then begin
      Incl := LoadWebFileFromFolder('include_footer.htm', FolderName);
      ReplaceString(WS,'<!--#include file="include_footer.html"-->', incl);
   end;
   If POS('<!--#include file="include_header_newuser.html"-->', WS) <> 0 then begin
      Incl := LoadWebFileFromFolder('include_header_newuser.htm', FolderName);
      ReplaceString(WS,'<!--#include file="include_header_newuser.html"-->', incl);
   end;
   If POS('<!--#include file="include_header_for_first_login.html"-->', WS) <> 0 then begin // 2019-2-13 ss DVST-3838

      Incl := LoadWebFileFromFolder('include_header_for_first_login.htm', FolderName);
      ReplaceString(WS,'<!--#include file="include_header_for_first_login.html"-->', incl);

   end;

   ReplaceString(WS,'%HOSTFOLDER%', DomainHostFolder);
   ReplaceString(WS,'%APPVERSION%', GetFileVersion(aFileVersionLong));//2017-08-24 jtm: F#2122
   ReplaceString(WS, '%HOSTNAME%', DomainHostname);

   includeEatEndIfOnInclude := strtobool(OpenXMLGetTag('/CONFIGDATA/LEGACYSUPPORT/ALLOWINCLUDETOEATENDIF', 'FALSE'));

   While ReplaceInclude(WS) do begin end;
   While ReplaceXMLEscapeInclude(WS,'<!--getxmltag(',')-->') do begin end;
   While ReplaceXMLEscapeInclude(WS,'<!--injectxml(',')-->')do begin end;
   While ReplaceExpressionEscapeInclude(WS,'<!--TSCRIPT(',')-->') do begin end;
   While ReplaceIf(WS) do begin end;

   if (CustomerMembType = 'ADMIN') then begin
      ReplaceString(WS,'%ADMINLINK%', '<BR><a href="/PP?PAGE=STORELOGALL" class="linkBtn">Admin Access</a>');
   end else begin
      ReplaceString(WS,'%ADMINLINK%', '');
   end;

   Dec(LoadFileRecursionDepth);
   Result := WS;
End;

procedure TCustomerInfoModule.WebModuleBeforeDispatch(Sender: TObject;
  Request: TWebRequest; Response: TWebResponse; var Handled: Boolean);
begin
InitVars;
PL.ProcessLog(ltinfo, 'APPSTART','Before Dispatch');

end;
procedure TCustomerInfoModule.WebModuleAfterDispatch(Sender: TObject;
  Request: TWebRequest; Response: TWebResponse; var Handled: Boolean);
begin
   PL.AddAppValue('BYTESTX', Stri(Length(Response.Content),-1));
   PL.SendTerm;
   SaveSessionVarEval;
end;

Function TCustomerInfoModule.GetAppServerHost : String;
var
   ConfigHost : String;
   AppServerXML : TOpenXML;
   AppServerNode : TOpenXMLNode;
   RNPRIMARYURL,RNURL : string;
   port : string;
   cname : string;
   portloc :integer;
   firstpart,lastpart : string;
begin
   if DomainPlatform = 'DEV' then    //2017-03-22 jtm: OT F#1508
      Result := 'HTTPS://172.20.28.4:20000/PPSAPI'
   else
      Result := 'HTTPS://172.20.28.4:25001/PPSAPI';

   ConfigHost := GetConfigString('APPSERVERHOST','');
   if (VarEvaluator.GetValueAsString('GatewayRNID') <> '') then begin //2017-05-24 jtm: F#1821
      if (OpenXMLGetTag('/CONFIGDATA/USERNAPPSERVERHOST','FALSE') = 'TRUE') then begin //2017-12-20 jtm: F#1839
         if (assigned(RNProfileDI)) then begin
            FreeAndNil(RNProfileDI);
         end;
         if (assigned(RNProfile)) then begin
            FreeAndNil(RNProfile);
         end;
         RNProfileDI := TTADODataLayer.Create(RNDB);
         RNProfile := TTProfile.Create(VarEvaluator.GetValueAsString('GatewayRNID'),false, RNProfileDI);
         RNPRIMARYURL := Uppercase(RNProfile.PMEPRIMARYURL);
         try
            AppServerXML := TOpenXML.CreateFromFile(nil,'c:\inetpub\wwwroot\AppServerHost.xml');
         except
             On E:Exception do begin
               Processlog(ltWarning, 'AppServerXML Exception processing XML',E.Message);
               If Assigned(AppServerXML) then FreeAndNil(AppServerXML);
               exit;
             end;
         end;

         RNURL := Copy(RNPRIMARYURL,0,Pos('/PPSAPI',RNPRIMARYURL)+length('/PPSAPI')-1);
         AppServerNode := AppServerXML.GetNode('/APPSERVERS/APPSERVER[@URL=''' + trim(RNURL) + ''']');
         if (AppServerNode <> nil) then begin
             port := AppServerXML.GetContextValueAsWideString(AppServerNode,'PORT');
             cname := AppServerXML.GetContextValueAsWideString(AppServerNode,'CNAME');
             if (cname <> '') then begin
               RNPRIMARYURL := cname;
             end;
             portloc := PosI('/',RNPRIMARYURL,length('HTTPS://')+1);
             firstpart := Copy(RNPRIMARYURL,0,portloc-1);
             lastpart :=  Copy(RNPRIMARYURL,portloc,length(RNPRIMARYURL));
             ConfigHost :=  firstpart + ':' + port + lastpart;
         end;
      end else begin
         If OpenXMLGetTag('/CONFIGDATA/APPSERVERHOST[@RNID=''' + trim(VarEvaluator.GetValueAsString('GatewayRNID')) + ''']') <> '' then begin
            ConfigHost := OpenXMLGetTag('/CONFIGDATA/APPSERVERHOST[@RNID=''' + trim(VarEvaluator.GetValueAsString('GatewayRNID')) + ''']');
            ProcessLog(ltInfo,'GetAppServerHost retrieved from config;GatewayRNID:', confighost +';' + trim(VarEvaluator.GetValueAsString('GatewayRNID')));
         end;
      end;
   end;
   If ConfigHost = '' then begin
      ConfigHost := FRegistry.ReadString('RetailNet PMAPPSVR',Trim(UpCaseString(Request.Host)),'');
   end;
   If ConfigHost <> '' then begin
      Result := confighost;
      ProcessLog(ltInfo,'GetAppServerHost retrieved from config:', confighost);
   end else begin
      ProcessLog(ltInfo,'GetAppServerHost defaulted to:', result);
   end;
   If Assigned(AppServerXML) then FreeAndNil(AppServerXML);
end;

Function TCustomerInfoModule.GetBinDetails(AQuery : TADOQuery;BinNumber : String;WSResp:TstringList;var WSMessage : String):Boolean;
var
   BinStart : String;
   BinEnd : String;
   PinEnabled : Boolean;
Begin
   BinStart := BinNumber;
   While Length(BinStart) < 12 do
      BinStart := BinStart + '9';

   BinEnd := BinNumber;
   While Length(BinEnd) < 12 do
      BinEnd := BinEnd + '0';



   If BINNumber = '' then begin
      Result := False;
      WSMessage := 'BINNUMBER EXPECTED';
      ProcessLog(ltWarning,'BIN NUMBER EXPECTED','GetBinDetails');
   end else begin
      WSQuery.Close;
      WSQuery.SQL.Text := 'select * from CCFullBIN where (BINSTART <= ''' + BinStart + ''') and (BINEND >= ''' + BinEnd + ''')';
      WSQuery.Open;
      If WSQuery.RecordCount > 0 then begin
         WSResp.ADD('   <BINDETAIL>');
         WSResp.ADD('      <BINNUMBER>'+BINNumber+'</BINNUMBER>');
         WSResp.ADD('      <CARDLENGTH>'+WSQuery.FieldByName('CardLength').AsString+'</CARDLENGTH>');
         WSResp.ADD('      <COUNTRYCODE>'+Trim(WSQuery.FieldByName('CountryCode').AsString)+'</COUNTRYCODE>');
         WSResp.ADD('      <CARDPRODUCT>'+Trim(WSQuery.FieldByName('CARDPROD').AsString)+'</CARDPRODUCT>');
         WSResp.ADD('      <CARDISSUETYPE>'+Trim(WSQuery.FieldByName('CARDISSUETYPE').AsString)+'</CARDISSUETYPE>');
         WSResp.ADD('      <CARDINDICATOR>'+Trim(WSQuery.FieldByName('CARDIND').AsString)+'</CARDINDICATOR>');
         If (WSQuery.RecordCount > 1) then begin
            WSResp.ADD('      <CARDINDICATORDESCRIPTION>MULTIPLE RECORDS</CARDINDICATORDESCRIPTION>');
            ProcessLog(ltInfo,'BIN NUMBER MULTIPLE RECORDS','GetBinDetails');
         end else begin
            WSResp.ADD('      <CARDINDICATORDESCRIPTION>'+Trim(WSQuery.FieldByName('CARDINDDESC').AsString)+'</CARDINDICATORDESCRIPTION>');
         end;

         WSResp.ADD('      <BANKNAME>'+Trim(WSQuery.FieldByName('BankName').AsString)+'</BANKNAME>');
         WSResp.ADD('      <CARDTYPE>'+Trim(WSQuery.FieldByName('CARDTYPE').AsString)+'</CARDTYPE>');
         WSResp.ADD('      <CARDTYPEDESC>'+Trim(WSQuery.FieldByName('CARDTYPEDESC').AsString)+'</CARDTYPEDESC>');
         WSResp.ADD('      <EBTSTATE>'+Trim(WSQuery.FieldByName('EBTSTATE').AsString)+'</EBTSTATE>');
         If Trim(WSQuery.FieldByName('FSAIndicator').AsString) <> '' then
            WSResp.ADD('      <FSA>TRUE</FSA>')
         else
            WSResp.ADD('      <FSA>FALSE</FSA>');

         If WSQuery.FieldByName('Commercial').AsBoolean  then
            WSResp.ADD('      <COMMERCIAL>TRUE</COMMERCIAL>')
         else
            WSResp.ADD('      <COMMERCIAL>FALSE</COMMERCIAL>');

         PinEnabled := False;
         Repeat
            If WSQuery.FieldByName('PINENABLED').AsBoolean then begin
               PinEnabled := True;
               Break;
            end;
            WSQuery.Next;
         until WSQuery.Eof;

         If PinEnabled  then
            WSResp.ADD('      <PINENABLED>TRUE</PINENABLED>')
         else
            WSResp.ADD('      <PINENABLED>FALSE</PINENABLED>');
         WSResp.ADD('   </BINDETAIL>');

         Result := True;
         WSMessage := '';
      end else begin
         Result := False;
         WSMessage := 'BIN NOT FOUND';
      end;
   end;
end;

Function TCustomerInfoModule.OpenXMLLoad : Boolean;
Begin
   Result := False;
   If Assigned(DomainConfigXML) then
      FreeAndNil(DomainConfigXML);

   If Trim(DomainConfig) = '' then exit;
   Try
      DomainConfigXML := TOpenXML.CreateFromString(Nil,DomainConfig);

      Result := True;
   except
      On E:Exception do begin
         Processlog(ltWarning, 'OpenXMLLoad Exception processing XML',E.Message);
         If Assigned(DomainConfigXML) then FreeAndNil(DomainConfigXML);
         Result := False;
      end;
   end;
end;

Function TCustomerInfoModule.OpenXMLGetTag(TagName : String) : String;
Begin
   Result := '';
   If not Assigned(DomainConfigXML) then exit;
   Try
      Result := DomainConfigXML.GetValueAsWideString(TagName);
   except
      On E:Exception do begin
      end;
   end;
end;

Function TCustomerInfoModule.OpenXMLGetTag(TagName : String; Default : String) : String;
Begin
   Result := OpenXMLGetTag(TagName);
   If Result = '' then Result := Default;
end;

Function TCustomerInfoModule.ExternalXMLGetTag(TagName : String) : String;
Begin
   Result := '';
   If not Assigned(ExternalXML) then exit;
   Try
      Result := ExternalXML.GetValueAsWideString(TagName);
   except
      On E:Exception do begin
      end;
   end;
end;


Function TCustomerInfoModule.UserXMLGetTag(TagName : String) : String;
begin
   Result := '';
   If not Assigned(UserXML) then exit;
   Try
      Result := UserXML.GetValueAsWideString(TagName);
   except
      On E:Exception do begin
      end;
   end;
end;
Function TCustomerInfoModule.UserXMLGetTag(TagName : String; Default : String) : String;
begin
   Result := UserXMLGetTag(TagName);
   If Result = '' then Result := Default;
end;
procedure TCustomerInfoModule.UserXMLSetTag(TagName : String; Value : String);
var
NewNodeName :string;
XpathExp : string;
posit : integer;
NewNodeAtt : string;
NewNodeAttVal : string;
NewNode : TOpenXMLNode;
begin
   if not Assigned(UserXML) then exit;
   XMLSetTag(UserXML,TagName,Value);
   end;
function TCustomerInfoModule.AttributesXMLGetTag(TagName: String): String;
begin
   Result := '';
   If not Assigned(AttributesXML) then exit;
   Try
      Result := AttributesXML.GetValueAsWideString(TagName);
   except
      On E:Exception do begin
      end;
   end;
end;

function TCustomerInfoModule.AttributesXMLGetTag(TagName, Default: String): String;
begin
   Result := AttributesXMLGetTag(TagName);
   If Result = '' then Result := Default;
end;

procedure TCustomerInfoModule.AttributesXMLSetTag(TagName, Value: String);
begin
   if not Assigned(AttributesXML) then exit;
   XMLSetTag(AttributesXML,TagName,Value);
end;


Procedure TCustomerInfoModule.ProcessPortalException(EMessage : String);
var
   WS : String;
Begin
   WS := LoadWebFileFromFolder('Default.htm','');
   ReplaceString(WS, '%ERROR%', '<BR><B><font color="red">There was an error processing your request.<BR>We''ve made a note of it and apologize for the inconvenience.</font></B>');
   ReplaceString(WS, '%EMAIL%', '');
   response.Content :=WS;
   WS := FOrmatDateTime('YYYY/MM/DD HH:NN:SS', NOW) + #9 + Request.RemoteHost + #9 + RNSessionID + #9 +Request.queryfields.Values['PAGE']  + #9 + Trim(UpCaseString(Request.Host)) + #9 + EMEssage;
   AppendFileStr('c:\PPError.txt',WS);
   ProcessLog(ltWarning,'Portal Exception:' + WS,Request.queryfields.Values['PAGE']+ #9 + EMEssage);
end;

function TCustomerInfoModule.VarIDFunc(const Identifier: String; ParameterList: TParameterList): TExpression;
VAR
   WorkStr,WorkStr2        : String;
   WorkInt: integer;
   WorkFloat : double;
begin
   Result := NIL;

   If (Identifier = 'GETVAR') then begin
      if Assigned(ParameterList) and (ParameterList.Count = 1) then begin
         WorkStr := ParameterList.AsString[0];
         result := TStringLiteral.Create( VarEvaluator.GetValueAsString(WorkStr));
         ParameterList.Free;
      end else begin
        raise EExpression.CreateFmt('Invalid Parameters to %s', [Identifier]);
      end;
      exit;
   end;

   If (Identifier = 'GETSESSIONVAR') then begin
      if Assigned(ParameterList) and (ParameterList.Count = 1) then begin
         WorkStr := ParameterList.AsString[0];
         result := TStringLiteral.Create( SessionVarEval.GetValueAsString(WorkStr));
         ParameterList.Free;
      end else begin
        raise EExpression.CreateFmt('Invalid Parameters to %s', [Identifier]);
      end;
      exit;
   end;

   If (Identifier = 'GETSESSIONVARCHAR') then begin
      if Assigned(ParameterList) and (ParameterList.Count = 2) then begin
         WorkStr := ParameterList.AsString[0];
         WorkInt := ParameterList.AsInteger[1];
         result := TStringLiteral.Create( SessionVarEval.GetValueAsString(WorkStr)[WorkInt]);
         ParameterList.Free;
      end else begin
        raise EExpression.CreateFmt('Invalid Parameters to %s', [Identifier]);
      end;
      exit;
   end;

   If (Identifier = 'QUERYSTRING') then begin
      if Assigned(ParameterList) and (ParameterList.Count = 1) then begin
         WorkStr := ParameterList.AsString[0];
         result := TStringLiteral.Create(Request.queryfields.Values[WorkStr]);
         ParameterList.Free;
      end else begin
        raise EExpression.CreateFmt('Invalid Parameters to %s', [Identifier]);
      end;
      exit;
   end;

   If (Identifier = 'GETXPATH') then begin
      if Assigned(ParameterList) and (ParameterList.Count = 1) then begin
         WorkStr := ParameterList.AsString[0];
         result := TStringLiteral.Create(OpenXMLGetTag(WorkStr));
         ParameterList.Free;
      end else if Assigned(ParameterList) and (ParameterList.Count = 2) then begin  //Overload, if there are 2 params, use the second one as a default value
         WorkStr := ParameterList.AsString[0];
         WorkStr := OpenXMLGetTag(WorkStr);
         If Workstr = '' then  //If there is no result, use the second param as the default value
            WorkStr := ParameterList.AsString[1];
         result := TStringLiteral.Create(WorkStr);
         ParameterList.Free;
      end else begin
        raise EExpression.CreateFmt('Invalid Parameters to %s', [Identifier]);
      end;
      exit;
   end;
   If (Identifier = 'GETUSERXPATH') then begin     //2016-9-19 jtm: Feat OT# 1148
      if Assigned(ParameterList) and (ParameterList.Count = 1) then begin
         WorkStr := ParameterList.AsString[0];
         result := TStringLiteral.Create(UserXMLGetTag(WorkStr));
         ParameterList.Free;
      end else if Assigned(ParameterList) and (ParameterList.Count = 2) then begin  //Overload, if there are 2 params, use the second one as a default value
         WorkStr := ParameterList.AsString[0];
         WorkStr := UserXMLGetTag(WorkStr);
         If Workstr = '' then  //If there is no result, use the second param as the default value
            WorkStr := ParameterList.AsString[1];
         result := TStringLiteral.Create(WorkStr);
         ParameterList.Free;
      end else begin
        raise EExpression.CreateFmt('Invalid Parameters to %s', [Identifier]);
      end;
      exit;
   end;
   If (Identifier = 'INCMONTH') then begin    //2016-10-19 jtm Feat OT# 1186
      if Assigned(ParameterList) and (ParameterList.Count = 2) then begin
         Try
            WorkFloat := ParameterList.AsFloat[0];
            WorkStr := ParameterList.AsString[1];
            result := TFloatLiteral.Create(IncMonth(WorkFloat,StrToInt(WorkStr)));
         except
            On E:Exception do begin
            ProcessLog(ltWarning, 'Exception INCMONTH Attempting date as datetime:', E.Message);
            end;
         end;
         ParameterList.Free;
      end else begin
        raise EExpression.CreateFmt('Invalid Parameters to %s', [Identifier]);
      end;
      exit;
   end;
   If (Identifier = 'INCMONTHSTR') then begin    //2017-08-02 jtm: F#2030
      if Assigned(ParameterList) and (ParameterList.Count = 2) then begin
         Try
            WorkStr := ParameterList.AsString[0];
            WorkStr2 := ParameterList.AsString[1];
            result := TFloatLiteral.Create(IncMonth(StrToDate(WorkStr),StrToInt(WorkStr2)));
         except
            On E:Exception do begin
            ProcessLog(ltWarning, 'Exception INCMONTH Attempting date as datetime:', E.Message);
            end;
         end;
         ParameterList.Free;
      end else begin
        raise EExpression.CreateFmt('Invalid Parameters to %s', [Identifier]);
      end;
      exit;
   end;
   If (Identifier = 'USERIS') then begin    //2017-03-22 jtm
      if Assigned(ParameterList) and (ParameterList.Count = 2) then begin
         Try
            WorkStr := ParameterList.AsString[0];
            WorkStr2 := ParameterList.AsString[1];
            result := TBooleanLiteral.Create(UserIs(WorkStr,WorkStr2));
         except
            On E:Exception do begin
            ProcessLog(ltWarning, 'Exception on Identifier USERIS:', E.Message);
            end;
         end;
         ParameterList.Free;
      end else begin
        raise EExpression.CreateFmt('Invalid Parameters to %s', [Identifier]);
      end;
      exit;
   end;
   If (Identifier = 'NUMERICONLY') then begin    //2017-10-04 jtm: F#2239
      if Assigned(ParameterList) and (ParameterList.Count = 1) then begin
         Try
            WorkStr := ParameterList.AsString[0];
            result := TStringLiteral.Create(NumericOnly(WorkStr));
         except
            On E:Exception do begin
            ProcessLog(ltWarning, 'Exception on Identifier NUMERICONLY:', E.Message);
            end;
         end;
         ParameterList.Free;
      end else begin
        raise EExpression.CreateFmt('Invalid Parameters to %s', [Identifier]);
      end;
      exit;
   end;
   If (Identifier = 'LASTFOUR') then begin
      if Assigned(ParameterList) and (ParameterList.Count = 1) then begin
         WorkStr := ParameterList.AsString[0];
         result := TStringLiteral.Create(RightStr(WorkStr,4));   //TODO
         ParameterList.Free;
      end else begin
        raise EExpression.CreateFmt('Invalid Parameters to %s', [Identifier]);
      end;
      exit;
   end;
   If Trim(UpCaseString(Identifier)) = 'INSTR' then begin
     Result := TStringLiteral.Create(VarExprEvalStr);
     Exit;
   end;

   If Identifier <> '' then begin
      Result := fExprEval.VarIDFunc(Identifier,parameterList);
      exit;
   end;

end;


Function TCustomerInfoModule.VarExprEvalAsString(AInStr : String;AnExpr : String) : String;
var
   E: TExpression;
Begin
   VarExprEvalStr := AInStr;
   Result := '';
   E:= CreateExpression(AnExpr, VarIDFunc);
   if Assigned(E) then
    try
       Result := E.AsString
    finally
     E.Free;
    end;
end;
Function TCustomerInfoModule.GetDCCQuote(RNID : String; AXMLStr : String) : Boolean;
var
   DCCRequest : String;
   XMLResp : TStringList;
Begin
   Result := False;
   If AXMLStr <> '' then begin
      DCCRequest := '<TRANSACTION>' +
                    '  <RNID>'+RNID+'</RNID>' +
                    '  <TRANSACTIONTYPE>DCCQUOTE</TRANSACTIONTYPE>' +
                    '  <SENDFLAGIMAGE>TRUE</SENDGLAGIMAGE>';
      DCCRequest := DCCRequest + AXMLStr + '</TRANSACTION>' + CRLF;
      XMLResp := TStringList.Create;
      ProcessLog(ltInfo,'Send DCC Quote Request', DCCRequest);
      ProcessPPSAPIXML(DCCRequest, XMLResp,GetAppServerHost,0);
      VarEvaluator.AddValue('DCCTRANSUCCESS', GetXMLTag(XMLResp,'TRANSUCCESS'));
      If (GetXMLTag(XMLResp,'TRANSUCCESS') = 'TRUE') then begin
         ProcessLog(ltInfo,'DCC Quote Success', 'TRUE');
         VarEvaluator.AddValue('DCCGUID', GetXMLTag(XMLResp,'DCCGUID'));
         VarEvaluator.AddValue('CCDCCAMT', GetXMLTag(XMLResp,'CCDCCAMT'));
         VarEvaluator.AddValue('DCCALPHACODE', GetXMLTag(XMLResp,'DCCCURRENCYCODEALPHA'));
         VarEvaluator.AddValue('DCCRATE', GetXMLTag(XMLResp,'DCCEXCHANGERATE'));
         VarEvaluator.AddValue('DCCRATEPERCENT', GetXMLTag(XMLResp,'DCCMARGINRATEPERCENTAGE'));
         VarEvaluator.AddValue('DCCFLAG', GetXMLTag(XMLResp,'DCCFLAGIMAGE'));
         VarEvaluator.AddValue('DCCVERBIAGE', GetXMLTag(XMLResp,'DCCVERBIAGE'));
         Result := True;
      end else begin
         ProcessLog(ltInfo,'DCC Quote Success', 'FALSE');
      end;
   end else begin
      exit;
   end;
end;
Function TCustomerInfoModule.ProcessPortalPayment(RNID : String; CustGUID : String; InPutXML : TOpenXML) : Boolean;
const
   METHOD_NAME = 'TCustomerInfoModule.ProcessPortalPayment(...)';// 2019-4-17 ss DVST-3651
var
   PaymentLocationRNID : String;
   Email : String;
   WS : String;
   WS2: String;
   CustIdent : String;
   TranIdent : String;
   StationIdent : String;
   AccountNumber : String;
   ChildGUID : String;
   PaymentRNID :String;
   PaymentHistGuid : String;
   PaymentGUID : String;
   PaymentAmount  :String;
   ReceiptNumber : String;
   TranAMount : String;

   PaymentResponse : String;
   PaymentRequest : String;
   PaymentToken : String;
   PaymentType : String;
   PaymentCardName : string; //2017-01-06 jtm F#1290
   PaymentServiceName : String;
   PaymentsAVS : string;
   XMLResp : TStringList;
   ApprovalCode : String;
   EmailMessage : String;
   NonAuthReason : String;
   GWSystemCode : String;
   TranIdentExpression : String;
   Offline : Boolean;
   SupressReceipt : Boolean;
   SchedGUID : String;
   SchedQuery : TAdoQuery;
   IsPlanPayment : Boolean;
   IsOffline : Boolean;
   SchedAmountDue : Currency;
   HTMLTemplate : String;
   HTMLEmail : String;
   OTPCardAcct : String;
   OTPCardExp : String;
   OTPCVV : String;
   OTPTAToken : String; //2017-10-26 ajs: F#2213
   OTPTACardExp : String; //2017-10-26 ajs: F#2213
   OTPTATokenType : String; //2017-10-26 ajs: F#2213
   ReceiptEmail : string;
   BillingZip : string;  //2016-3-28 jtm
   BillingStreet : string;
   OTPAVS : String;
   CardEventParms : string; //2016-8-22 jtm: Feat OT#1053
   EmpIdent : string;
   CustIdentExpression : String; //2016-10-27 jtm: Feat OT# 1228
   PaymentTransactionType : String; //2017-05-24 jtm F#1577
   UserName : string;
   IDTechDecrypt: TIDTechDecrypt;//2017-08-16 jtm: F#2082
   CustomField1 : string; //2017-09-20 jtm: F#2192
   CustomField2 : string;
   CustomField3 : string;
   CustomField4 : string;
   CustomField5 : string;
   CustomField6 : string;
   CustomField7 : string;
   CustomField8 : string;
   CustomField9 : string;
   CustomField10 : string;

   PromptForFraudReversal : boolean; //2018-06-20 bls: F#2076
   FraudAutoReversal : string; //2018-06-20 bls: F#2076
   ReceiptToCustEmail : boolean; //2018-09-12 ajs: DVST-1235
   CustEmail : string; //2018-09-12 ajs: DVST-1235
   RequestPaymentTransactionType : string;
   CCAuthType : string;
   RefererURL : string;
   memberType : string;
   ErrorMessage : string;
   totalAmountDue : boolean;
   currentAmountDue : boolean;
   fixedAmountDue : boolean;

   StationIdentExpression: String; //2019-3-13 ss DVST-3178
   I2PayError: String; //2019-4-17 ss DVST-3651
   CardEventParamsXPath: String; //2019-5-15 SS DVST-572
   transuccess : boolean;
Begin
   Result := False;
   Offline := False;
   SupressReceipt := False;
   isOffline := False;
   HTMLTemplate := '';
   TranIdent := '';
   StationIdent := 'WEBSITE';
   PromptForFraudReversal := false;
   FraudAutoReversal := '';
   ReceiptToCustEmail := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ALLOWEMAILRECEIPT','FALSE')); //2018-09-12 ajs: DVST-1235

   ProcessLog(ltDebug, 'ProcessPortalPayment CustGUID', CustGUID);
   if SessionVarEval.GetValueAsString('StationIdent') <> '' then
      StationIdent :=  SessionVarEval.GetValueAsString('StationIdent');
   If (CustGUID = 'NONE') or OpenCustomerQueryGUID('',CustGUID) then begin
      ProcessLog(ltInfo,'PROCESS PAYMENT',NumericOnly(Request.ContentFields.Values['School']));

      If InputXML <> Nil then begin
         SchedGUID := GuidOnly(InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTSCHEDGUID'));
      end else begin
         SchedGUID := GuidOnly(Request.ContentFields.Values['PAYSCHEDGUID']);
         if SchedGUID = '' then
            SchedGUID := GuidOnly(Request.QueryFields.Values['PAYSCHEDGUID']);
         ProcessLog(ltInfo,'PROCESS PAYMENT',SchedGUID);

      end;

      IsPlanPayment := False;
      If InputXML <> Nil then
         IsPlanPayment := UpCaseString(InputXML.GetValueAsWideString('/TRANSACTION/PLANPAYMENT')) = 'TRUE';


      If SchedGUID <> '' then begin
         if LoadSchedGUIDToVars(SchedGUID, RNID, VarEvaluator) then begin
            VarEvaluator.AddValue('PAYMENTSCHEDGUID', SchedGUID);
            PaymentGUID := VarEvaluator.GetValueAsString('CustPaySched.PaymentGUID');//Set this if it exists
            PaymentLocationRNID  := VarEvaluator.GetValueAsString('CustPaySched.RNID');//Set this if it exists
            ProcessLog(ltInfo,'Schedule Guid  found:' + PaymentLocationRNID + ':' + SchedGUID,PaymentLocationRNID);
            ProcessLog(ltInfo,'CusGUID:' + PaymentLocationRNID + ':' + CustGUID,PaymentLocationRNID);

         end else begin
            ProcessLog(ltWarning,'Schedule Guid not found',PaymentLocationRNID);

         end;
      end;

      If PaymentLocationRNID = '' then begin
         If InputXML <> Nil then begin
            If InputXML.GetValueAsWideString('/TRANSACTION/LOCATIONRNID') <> '' then
               PaymentLocationRNID := GuidOnly(InputXML.GetValueAsWideString('/TRANSACTION/LOCATIONRNID'));
         end else begin
            PaymentLocationRNID := NumericOnly(Request.ContentFields.Values['PaymentLocation']);
            If PaymentLocationRNID = '' then
               PaymentLocationRNID := NumericOnly(Request.ContentFields.Values['School']);
         end;
      end;

      If VarEvaluator.GetValueAsString('CustPaySched.RNID') <> '' then  //If a custpaysched has been passed in we need to use this
         PaymentLocationRNID := VarEvaluator.GetValueAsString('CustPaySched.RNID');
      if (PaymentLocationRNID = '') and (SessionVarEval.GetValueAsString('PaymentLocationRNID') <> '') then begin   //2017-07-19 jtm: F#1820
          PaymentLocationRNID := SessionVarEval.GetValueAsString('PaymentLocationRNID');
      end;
      If PaymentLocationRNID = '' then begin //If this is blank, we're not doing it on behalf of a specific location, use site RNID
         PaymentLocationRNID := RNID; //default to this site
      end else begin
         If Not ValidateRNID(PaymentLocationRNID) then begin
            ProcessLog(ltWarning,'Attempt to Process Payment For Invalid Location RNID',NumericOnly(Request.ContentFields.Values['School']));
            Response.Content := '<head><title>Make a Payment</title><meta http-equiv="refresh" content="0;URL=/PP"></head>';
            exit;
         end;
         OpenCustomerQueryGUID('',CustGUID); // we have to do this again because validaternid closed our query
      end;


      VarEvaluator.AddDSCurrentRecord(RNQuery, 'Customers');
      ProcessLog(ltInfo, 'PROCESS PAYMENT', PaymentLocationRNID);

      IF inputXML = NIL then begin
         PaymentGUID := GuidOnly(Request.ContentFields.Values['payment']);  //First assign it to the form field
         If Request.ContentFields.Values['payment'] = 'CASH' then begin
            PaymentGUID := 'CASH';
            IsOffline := True;
         end;
         If Request.ContentFields.Values['payment'] = 'CHECK' then begin
            PaymentGUID := 'CHECK';
            IsOffline := True;
         end;

         If Request.ContentFields.Values['payment'] = 'CARD' then begin
            PaymentGUID := 'CARD';
            IsOffline := True;
         end;

         If Request.ContentFields.Values['payment'] = 'REFUND' then begin
            PaymentGUID := 'REFUND';
            IsOffline := True;
         end;


      end;
      If (InputXML <> Nil) and (Trim(InputXML.GetValueAsWideString('/TRANSACTION/TRANIDENT')) <> '') then  //2017-08-16 jtm: F#2071
         TranIdent := Trim(InputXML.GetValueAsWideString('/TRANSACTION/TRANIDENT'));
      If (InputXML <> Nil) and (Trim(InputXML.GetValueAsWideString('/TRANSACTION/CUSTIDENT')) <> '') then  //2017-08-16 jtm: F#2071
         CustIdent := Trim(InputXML.GetValueAsWideString('/TRANSACTION/CUSTIDENT'));

      If (SchedGUID <> '') and (PaymentGuid = '')  then
         PaymentGuid := VarEvaluator.GetValueAsString('CustPaySched.PaymentGUID'); //If there is a scheduled payment that has a payment GUID assigned, use that

      If (InputXML <> Nil) and (Trim(InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTGUID')) <> '') then begin
         PaymentGUID := GuidOnly(InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTGUID')); //If we're processing XML, assign it that way
         If InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTGUID') = 'CASH' then begin
           PaymentGUID := 'CASH';
           IsOffline := True;
         end;
         If InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTGUID') = 'CHECK' then begin
           PaymentGUID := 'CHECK';
           IsOffline := True;
         end;
         If InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTGUID') = 'CARD' then begin
           PaymentGUID := 'CARD';
           IsOffline := True;
         end;
         If InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTGUID') = 'REFUND' then begin
           PaymentGUID := 'REFUND';
           IsOffline := True;
         end;

      end;

      if (PaymentGUID = '') and (NumericOnly(Request.ContentFields.Values['retypeNumber']) <> '') then begin
         OTPCardAcct := NumericOnly(Request.ContentFields.Values['retypeNumber']);
         OTPCardExp := FormatDateTime('MM/YY', ValidateExp(NumericOnly(Request.ContentFields.Values['expMonth']) +'/' +  NumericOnly(Request.ContentFields.Values['expYear']), true));
         OTPCVV := NumericOnly(Request.ContentFields.Values['cvv']);
         PaymentGUID := 'CARD KEYED';
         PaymentServiceName := 'CARD';
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/SHOWSERVICENAME','FALSE') = 'TRUE') and (ValidCharsOnly(Request.ContentFields.Values['VTCardServiceName'],True,True,'-') <> '')  //2017-05-24 jtm F#1568
            and (UpperCase(ValidCharsOnly(Request.ContentFields.Values['VTCardServiceName'],True,True,'-')) <> 'ALL')  then begin
            PaymentServiceName := ValidCharsOnly(Request.ContentFields.Values['VTCardServiceName'],True,True,'-');
            ProcessLog(ltInfo,'VTCardServiceName:',PaymentServiceName);
         end;

         Tranident := ValidCharsOnly(Request.ContentFields.Values['TranIdent'],True,True,'.-_:/& ');  //2017-05-10 jtm D#1605
         Custident := ValidCharsOnly(Request.ContentFields.Values['CustIdent'],True,True,'.-_:/& ');  //2017-05-10 jtm D#1605
         BillingZip := ValidCharsOnly(Request.ContentFields.Values['billingZip'],False,True,'');   //2016-3-28 jtm
         BillingStreet := ValidCharsOnly(Request.ContentFields.Values['billingStreet'],True,True,'');
         if (Length(BillingZip) >= 5) and (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ZIPREQUIRED','FALSE')='TRUE') then begin
            if BillingStreet = '' then begin
                if (Length(BillingZip) = 5) or (Length(BillingZip) = 9) then OTPAVS := BillingZip;
            end else begin
               if Length(BillingStreet) > 20 then BillingStreet := Copy(BillingStreet,0,20);
               if Length(BillingZip) = 5  then begin
                  OTPAVS := BillingZip + '0000' + BillingStreet;
               end else if Length(BillingZip) = 9 then begin
                  OTPAVS := BillingZip + BillingStreet;
               end;
            end;
            if Length(OTPAVS) > 29 then OTPAVS := Copy(OTPAVS,0,29);
         end else begin
            OTPAVS := '';
         end;
      end;

      if (PaymentGUID = '') and (NumericOnly(VarEvaluator.GetValueAsString('OTPCARDACCT')) <> '') then begin
         OTPCardAcct := NumericOnly(VarEvaluator.GetValueAsString('OTPCARDACCT'));
         OTPCardExp := FormatDateTime('MM/YY', ValidateExp(NumericOnly(VarEvaluator.GetValueAsString('OTPEXPMONTH')) +'/' +  NumericOnly(VarEvaluator.GetValueAsString('OTPEXPYEAR')), true));
         OTPCVV := NumericOnly(VarEvaluator.GetValueAsString('OTPCVV'));
         PaymentGUID := 'CARD KEYED';
         PaymentServiceName := 'CARD';
         If VarEvaluator.GetValueAsString('PAYMENTSERVICENAME') = '' then
            PaymentServiceName := 'CARD';
         Tranident := ValidCharsOnly(VarEvaluator.GetValueAsString('TRANIDENT'),True,True,'.-_:/& '); //2017-05-10 jtm D#1605
         Custident := ValidCharsOnly(VarEvaluator.GetValueAsString('CUSTIDENT'),True,True,'.-_:/& '); //2017-05-10 jtm D#1605
         BillingZip := ValidCharsOnly(VarEvaluator.GetValueAsString('OTPZIP'),False,True,'');   ////2017-08-02 jtm: F#2035
         BillingStreet := ValidCharsOnly(VarEvaluator.GetValueAsString('OTPBillingStreet'),True,True,'');
         if (Length(BillingZip) >= 5) then begin
            if BillingStreet = '' then begin
                if (Length(BillingZip) = 5) or (Length(BillingZip) = 9) then OTPAVS := BillingZip;
            end else begin
               if Length(BillingStreet) > 20 then BillingStreet := Copy(BillingStreet,0,20);
               if Length(BillingZip) = 5  then begin
                  OTPAVS := BillingZip + '0000' + BillingStreet;
               end else if Length(BillingZip) = 9 then begin
                  OTPAVS := BillingZip + BillingStreet;
               end;
            end;
            if Length(OTPAVS) > 29 then OTPAVS := Copy(OTPAVS,0,29);
         end else begin
            OTPAVS := '';
         end;
      end;

      CardEventParms := Trim(Request.ContentFields.Values['CARDEVENTPARAMS']); //2016-8-22 jtm: Feat OT#1053
      if (PaymentGUID = '') and (CardEventParms <> '') then begin
         PaymentGUID := 'CARD KEYED';
         PaymentServiceName := 'CARD';
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/SHOWSERVICENAME','FALSE') = 'TRUE') and (ValidCharsOnly(Request.ContentFields.Values['VTCardServiceName'],True,True,'-') <> '')  //2017-05-24 jtm F#1568
            and (UpperCase(ValidCharsOnly(Request.ContentFields.Values['VTCardServiceName'],True,True,'-')) <> 'ALL')  then begin
            PaymentServiceName := ValidCharsOnly(Request.ContentFields.Values['VTCardServiceName'],True,True,'-');
            ProcessLog(ltInfo,'VTCardServiceName:',PaymentServiceName);
         end;
         Tranident := ValidCharsOnly(Request.ContentFields.Values['TranIdent'],True,True,'.-_:/& '); //2017-05-10 jtm D#1605
         Custident := ValidCharsOnly(Request.ContentFields.Values['CustIdent'],True,True,'.-_:/& '); //2017-05-10 jtm D#1605
         BillingZip := ValidCharsOnly(Request.ContentFields.Values['billingZip'],False,True,'');
         BillingStreet := ValidCharsOnly(Request.ContentFields.Values['billingStreet'],True,True,'');
         if (Length(BillingZip) >= 5) and (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ZIPREQUIRED','FALSE')='TRUE') then begin
            if BillingStreet = '' then begin
                if (Length(BillingZip) = 5) or (Length(BillingZip) = 9) then OTPAVS := BillingZip;
            end else begin
               if Length(BillingStreet) > 20 then BillingStreet := Copy(BillingStreet,0,20);
               if Length(BillingZip) = 5  then begin
                  OTPAVS := BillingZip + '0000' + BillingStreet;
               end else if Length(BillingZip) = 9 then begin
                  OTPAVS := BillingZip + BillingStreet;
               end;
            end;
            if Length(OTPAVS) > 29 then OTPAVS := Copy(OTPAVS,0,29);
         end else begin
            OTPAVS := '';
         end;
      end;

      if (PaymentGUID = '') and (NumericOnly(Request.ContentFields.Values['VTTokenNumber']) <> '') then begin  //2017-10-26 ajs: F#2213
         OTPTAToken := NumericOnly(Request.ContentFields.Values['VTTokenNumber']);
         OTPTACardExp := FormatDateTime('MM/YY', ValidateExp(NumericOnly(Request.ContentFields.Values['expMonth']) +'/' +  NumericOnly(Request.ContentFields.Values['expYear']), true));
         OTPTATokenType := NumericOnly(Request.ContentFields.Values['providerID']);
         PaymentGUID := 'CARD KEYED';
         PaymentServiceName := 'CARD';
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/SHOWSERVICENAME','FALSE') = 'TRUE') and (ValidCharsOnly(Request.ContentFields.Values['VTCardServiceName'],True,True,'-') <> '')  //2017-05-24 jtm F#1568
            and (UpperCase(ValidCharsOnly(Request.ContentFields.Values['VTCardServiceName'],True,True,'-')) <> 'ALL')  then begin
            PaymentServiceName := ValidCharsOnly(Request.ContentFields.Values['VTCardServiceName'],True,True,'-');
            ProcessLog(ltInfo,'VTCardServiceName:',PaymentServiceName);
         end;

         Tranident := ValidCharsOnly(Request.ContentFields.Values['TranIdent'],True,True,'.-_:/& ');  //2017-05-10 jtm D#1605
         Custident := ValidCharsOnly(Request.ContentFields.Values['CustIdent'],True,True,'.-_:/& ');  //2017-05-10 jtm D#1605
         BillingZip := ValidCharsOnly(Request.ContentFields.Values['billingZip'],False,True,'');   //2016-3-28 jtm
         BillingStreet := ValidCharsOnly(Request.ContentFields.Values['billingStreet'],True,True,'');
         if (Length(BillingZip) >= 5) and (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ZIPREQUIRED','FALSE')='TRUE') then begin
            if BillingStreet = '' then begin
                if (Length(BillingZip) = 5) or (Length(BillingZip) = 9) then OTPAVS := BillingZip;
            end else begin
               if Length(BillingStreet) > 20 then BillingStreet := Copy(BillingStreet,0,20);
               if Length(BillingZip) = 5  then begin
                  OTPAVS := BillingZip + '0000' + BillingStreet;
               end else if Length(BillingZip) = 9 then begin
                  OTPAVS := BillingZip + BillingStreet;
               end;
            end;
            if Length(OTPAVS) > 29 then OTPAVS := Copy(OTPAVS,0,29);
         end else begin
            OTPAVS := '';
         end;
      end;

      If PaymentGUID = '' then begin
         ProcessLog(ltWarning,'Attempt to Process Payment For Blank Payment GUID',NumericOnly(Request.ContentFields.Values['School']));
         Response.Content := '<head><title>Make a Payment</title><meta http-equiv="refresh" content="0;URL=/PP?PAGE=MAKEPAYMENT"></head>';
         exit;
      end;

      if (RNQuery.FindField('Email') <> nil) then begin
         Email := Trim(RNQuery.FieldByName('Email').AsString);
      end;
      EMail := ValidCharsOnly(Email,True,True,'_.-#@+/');
      SessionVarEval.AddValue('CUSTOMEREMAIL', Email); //2018-06-20 bls: F#2076
      WS := LoadWebFileFromFolder('payment_confirmation.htm','');
      if (ReceiptToCustEmail AND (Request.ContentFields.Values['CustEmail'] <> '')) then begin
         CustEmail := '';
         CustEmail := Trim(Request.ContentFields.Values['CustEmail']);
         CustEmail := ValidCharsOnly(CustEmail,True,True,'_.-#@+/');
         SessionVarEval.AddValue('CUSTRECEIPTEMAIL', CustEmail);
      end;

      If CustIdent = '' then begin
         if (RNQuery.FindField('FirstName') <> nil) then begin
            CustIdent := Trim(RNQuery.FieldByName('FirstName').AsString);
         end;
         if (RNQuery.FindField('LastName') <> nil) then begin
            CustIdent := CustIdent + ' ' +Trim(RNQuery.FieldByName('LastName').AsString);
         end;
         if (RNQuery.FindField('employer') <> nil) then begin
            If Trim(RNQuery.FieldByName('employer').AsString) <> '' then begin
             CustIdent := CustIdent + '/' +Trim(RNQuery.FieldByName('employer').AsString);
            end;
         end;
      end;
      if (RNQuery.FindField('AccountNumber') <> nil) then begin
         AccountNumber := Trim(RNQuery.FieldByName('AccountNumber').AsString);
      end;
         WS2 := ValidCharsOnly(Request.ContentFields.Values['custname'],true,true,'/. ');
         If WS2 <> '' then begin
            WS2 := '/' + WS2;
         end;


         ChildGUID := GuidOnly(Request.ContentFields.Values['nameandacct']);
         If (InputXML <> Nil) and (Trim(InputXML.GetValueAsWideString('/TRANSACTION/CHILDGUID')) <> '') then
            ChildGUID := InputXML.GetValueAsWideString('/TRANSACTION/CHILDGUID'); //If we're processing XML, assign it that way
         If (SchedGUID <> '')  and (VarEvaluator.GetValueAsString('CustPaySched.ChildGUID') <> '' ) then
            ChildGUID := GuidOnly(VarEvaluator.GetValueAsString('CustPaySched.ChildGUID')); //If there is a scheduled payment that has a Child GUID assigned, use that

         If ChildGUID <> '' then begin
            RNQuery.Close;
            RNQuery.SQL.Clear;
            RNQuery.SQL.Add('select * from CustChild');
            RNQuery.SQL.Add('where (ChildGUID = '''+ChildGUID + ''')');
            RNQuery.SQL.Add('And (CustGUID = '''+CustGUID + ''')');
            RNQuery.Open;
            If RnQuery.RecordCount = 0 then begin
               ProcessLog(ltWarning,'Attempt to process payment with invalid child guid ' + ChildGUID + '/' + CustGUID,NumericOnly(Request.ContentFields.Values['School']));
            end else begin
               VarEvaluator.AddDSCurrentRecord(RNQuery, 'CustChild');
               if VarEvaluator.GetValueAsString('CustPaySched.RNID') = '' then //The schedule RNID takes precidence over the child if it exists
                  PaymentLocationRNID := Trim(RNquery.FieldByName('RNID').AsString);
               If (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINADDSCHEDULE/ALLOWTRANIDENT','FALSE')='TRUE') then begin //2018-02-13 ajs: Feat OT#3756
                  TranIdent := VarEvaluator.GetValueAsString('CustPaySched.Custom1');
               end else begin
                  TranIdent := Trim(RNquery.FieldByName('AccountNumber').AsString);
                  If TranIdent <> '' then
                     TranIdent := TranIdent + '/';
                  TranIdent := TranIdent + Trim(RNquery.FieldByName('LastName').AsString) + ' ' + Trim(RNquery.FieldByName('FirstName').AsString);
               end;
               If (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINADDSCHEDULE/ALLOWCUSTIDENT','FALSE')='TRUE') then begin //2018-05-16 ajs: D#4048
                  CustIdent := VarEvaluator.GetValueAsString('CustPaySched.Custom2');
                  ProcessLog(ltDebug,'ADMINADDSCHEDULE/ALLOWCUSTIDENT Custident',CustIdent);
               end;
               if (strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SCHEDPAY/EXTERNALINTEGRATION','FALSE')) and (VarEvaluator.GetValueAsString('PAYMENTSCHEDGUID')<> '') and (VarEvaluator.GetValueAsString('CustPaySched.Custom3') = '') and (VarEvaluator.GetValueAsString('CustPaySched.ExternalIntegration') <> '')) or
                  ((OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/HE') <>'') and (VarEvaluator.GetValueAsString('Customers.CUSTOMERCODE') <> '')) then begin
                  PaymentAmount := '0';
                  memberType := VarEvaluator.GetValueAsString('Customers.MEMBSTATUS');
                  VarEvaluator.AddValue('memberType',memberType);
                  fixedAmountDue := strtobool(ValidCharsOnly(Request.ContentFields.Values['fixedAmountDue'],true,true,''));
                  totalAmountDue := strtobool(ValidCharsOnly(Request.ContentFields.Values['totalAmountDue'],true,true,''));
                  currentAmountDue := strtobool(ValidCharsOnly(Request.ContentFields.Values['currentAmountDue'],true,true,''));

                  if (VarEvaluator.GetValueAsString('CustPaySched.Custom4') <> '') then begin
                     ProcessLog(ltInfo,'ProcessPortalPaymentEx CustPaySched.Custom4',VarEvaluator.GetValueAsString('CustPaySched.Custom4'));
                     if (VarEvaluator.GetValueAsString('CustPaySched.Custom4') = 'fixedAmountDue') then begin
                        fixedAmountDue := true;
                         totalAmountDue := false;
                        currentAmountDue := false;
                     end else if (VarEvaluator.GetValueAsString('CustPaySched.Custom4') = 'totalAmountDue') then begin
                        fixedAmountDue := false;
                        totalAmountDue := true;
                        currentAmountDue := false;
                     end else if (VarEvaluator.GetValueAsString('CustPaySched.Custom4') = 'currentAmountDue') then begin
                        fixedAmountDue := false;
                        totalAmountDue := false;
                         currentAmountDue := true;
                     end;
                  end;

                  if fixedAmountDue then begin
                     PaymentAmount := ValidCharsOnly(Request.ContentFields.Values['fixedamount'],False,True,'.'); //if it's a schedule then this will be empty and we'll pick up the amount later on
                     ProcessLog(ltInfo,'ProcessPortalPaymentEx using fixedAmount',PaymentAmount);
                  end else begin

                     if (memberType = 'Member') or (memberType = 'Guest') or (memberType = 'Employer') then begin
                        ErrorMessage :='';
                        if (VarEvaluator.GetValueAsString('CustPaySched.ExternalIntegration') <> '') then begin
                           VarEvaluator.AddValue('subscriptionId',VarEvaluator.GetValueAsString('CustPaySched.ExternalIntegration'));
                        end else begin
                           VarEvaluator.AddValue('subscriptionId',RNQuery.FieldByName('ExternalIntegration').AsString);
                        end;
                        if (memberType = 'Member') or (memberType = 'Guest') then begin
                           SessionVarEval.AddValue('MemberHCCID',RNQuery.FieldByName('AccountNumber').AsString);
                           VarEvaluator.AddValue('MemberHCCID',RNQuery.FieldByName('AccountNumber').AsString);
                        end else if (memberType = 'Employer') then begin
                           SessionVarEval.AddValue('EmployerAccountID',RNQuery.FieldByName('AccountNumber').AsString);
                           SessionVarEval.AddValue('TaxID',RNQuery.FieldByName('ExternalCustIdent').AsString);
                           VarEvaluator.AddValue('EmployerAccountID',RNQuery.FieldByName('AccountNumber').AsString);
                           VarEvaluator.AddValue('TaxID',RNQuery.FieldByName('ExternalCustIdent').AsString);
                        end;
                        if ValidateHEUser(memberType,ErrorMessage) then begin
                           ProcessLog(ltInfo,'ProcessPortalPayment ValidateHEUser','success');
                              if HEGetBills(ErrorMessage) then begin
                                 if totalAmountDue then begin
                                    PaymentAmount := ValidCharsOnly(GetXMLTagStr(VarEvaluator.GetValueAsString('billXML'),'totalAmountDue'),false,true,'().');
                                 end else if currentAmountDue then begin
                                    PaymentAmount := ValidCharsOnly(GetXMLTagStr(VarEvaluator.GetValueAsString('billXML'),'currentAmountDue'),false,true,'().');
                                 end;
                                 if (Pos('(',PaymentAmount)>0) then begin
                                    ProcessLog(ltInfo,'ProcessPortalPaymentEx PaymentAmount is negative',PaymentAmount);
                                    PaymentAmount := '-1';  //set the payment amount to negative so it fails later
                                 end;
                                 ProcessLog(ltInfo,'ProcessPortalPayment HEGetBills success; PaymentAmount',PaymentAmount);
                                 ErrorMessage := '';
                              end else begin
                                 ErrorMessage := 'Bill Failed to load';
                              end;
                           end;
                        try
                           if (ErrorMessage <> '') or (StrToCurr(PaymentAmount) <= 0) then begin
                           ProcessLog(ltWarning,'Failed Process Payment For External Integration',ErrorMessage);
                           Response.Content := '<head><title>Make a Payment</title><meta http-equiv="refresh" content="0;URL=/PP?PAGE=MAKEPAYMENT"></head>';
                           exit;
                        end;
                        except
                           on e:exception do begin
                              ProcessLog(ltWarning,'Failed Process Payment For External Integration',ErrorMessage);
                              ProcessLog(ltWarning,'Exception converting Payment Amount to currency',e.message);
                              Response.Content := '<head><title>Make a Payment</title><meta http-equiv="refresh" content="0;URL=/PP?PAGE=MAKEPAYMENT"></head>';
                              exit;
                           end;
                        end;

                        try
                           if (StrToCurr(PaymentAmount) > 8000) then begin  //if payment amount greater than 8k, check the payment method to make sure it's not a check
                              RNQuery.Close;
                              RNQuery.SQL.Clear;
                              RNQuery.SQL.Add('select * from custpayment where PaymentGUID =''' + PaymentGUID +'''');
                              RNQuery.Open;
                              if RNQuery.RecordCount > 0 then begin
                                  if (trim(RNQuery.FieldByName('PAYMENTTYPE').AsString) = 'CHECK') then begin
                                    PaymentAmount := '8000';
                                 end;
                              end;
                           end;
                        except
                           on e:exception do begin
                              ProcessLog(ltWarning,'Failed Process Payment For External Integration',ErrorMessage);
                              ProcessLog(ltWarning,'Exception converting Payment Amount to currency',e.message);
                              Response.Content := '<head><title>Make a Payment</title><meta http-equiv="refresh" content="0;URL=/PP?PAGE=MAKEPAYMENT"></head>';
                              exit;
                           end;
                        end;
                     end;
                  end;
               end;
            end;
            RNQuery.Close;
         end;

         PaymentRNID := RNID;
         if GetConfigString('GATEWAYRNID','') = 'LOCATION' then begin //This is to bill to the location of the multi-tennant
            PaymentRNID := PaymentLocationRNID;
            ProcessLog(ltInfo,'Location Payment',PaymentRNID);
         end;
         ProcessLog(ltInfo,'PaymentLocationRNID:' + PaymentLocationRNID,PaymentRNID);

         If OpenXMLGetTag('/CONFIGDATA/GATEWAYRNIDOVERRIDES/GATEWAYRNID[@RNID=''' + PaymentLocationRNID + ''']') <> '' then begin
            PaymentRNID := OpenXMLGetTag('/CONFIGDATA/GATEWAYRNIDOVERRIDES/GATEWAYRNID[@RNID=''' + PaymentLocationRNID + ''']');
            ProcessLog(ltInfo,'Gateway RNID Override:' + PaymentRNID + '/' + PaymentLocationRNID,PaymentRNID);
         end;
         If (OpenXMLGetTag('/CONFIGDATA/STORECUSTOMFIELDS','FALSE') = 'TRUE') then begin //2017-09-20 jtm: F#2192
            if (SchedGUID = '') then begin
               CustomField1 := ValidCharsOnly(Request.ContentFields.Values['Custom1'],true,true,'/.-&(),:+=_ ');
               CustomField2 := ValidCharsOnly(Request.ContentFields.Values['Custom2'],true,true,'/.-&(),:+=_ ');
               CustomField3 := ValidCharsOnly(Request.ContentFields.Values['Custom3'],true,true,'/.-&(),:+=_ ');
               CustomField4 := ValidCharsOnly(Request.ContentFields.Values['Custom4'],true,true,'/.-&(),:+=_ ');
               CustomField5 := ValidCharsOnly(Request.ContentFields.Values['Custom5'],true,true,'/.-&(),:+=_ ');
               CustomField6 := ValidCharsOnly(Request.ContentFields.Values['Custom6'],true,true,'/.-&(),:+=_ ');
               CustomField7 := ValidCharsOnly(Request.ContentFields.Values['Custom7'],true,true,'/.-&(),:+=_ ');
               CustomField8 := ValidCharsOnly(Request.ContentFields.Values['Custom8'],true,true,'/.-&(),:+=_ ');
               CustomField9 := ValidCharsOnly(Request.ContentFields.Values['Custom9'],true,true,'/.-&(),:+=_ ');
               CustomField10 := ValidCharsOnly(Request.ContentFields.Values['Custom10'],true,true,'/.-&(),:+=_ ');
               if Length(CustomField1) > 200 then CustomField1 := Copy(CustomField1,0,200);
               if Length(CustomField2) > 200 then CustomField2 := Copy(CustomField2,0,200);
               if Length(CustomField3) > 200 then CustomField3 := Copy(CustomField3,0,200);
               if Length(CustomField4) > 200 then CustomField4 := Copy(CustomField4,0,200);
               if Length(CustomField5) > 200 then CustomField5 := Copy(CustomField5,0,200);
               if Length(CustomField6) > 200 then CustomField6 := Copy(CustomField6,0,200);
               if Length(CustomField7) > 200 then CustomField7 := Copy(CustomField7,0,200);
               if Length(CustomField8) > 200 then CustomField8 := Copy(CustomField8,0,200);
            end else begin
               CustomField1 := VarEvaluator.GetValueAsString('CustPaySched.Custom1');
               CustomField2 := VarEvaluator.GetValueAsString('CustPaySched.Custom2');
               CustomField3 := VarEvaluator.GetValueAsString('CustPaySched.Custom3');
               CustomField4 := VarEvaluator.GetValueAsString('CustPaySched.Custom4');
               CustomField5 := VarEvaluator.GetValueAsString('CustPaySched.Custom5');
               CustomField6 := VarEvaluator.GetValueAsString('CustPaySched.Custom6');
               CustomField7 := VarEvaluator.GetValueAsString('CustPaySched.Custom7');
               CustomField8 := VarEvaluator.GetValueAsString('CustPaySched.Custom8');
               CustomField9 := VarEvaluator.GetValueAsString('CustPaySched.Custom9');
               CustomField10 := VarEvaluator.GetValueAsString('CustPaySched.Custom10');
            end;
            VarEvaluator.AddValue('CustomField1',CustomField1);
            VarEvaluator.AddValue('CustomField2',CustomField2);
            VarEvaluator.AddValue('CustomField3',CustomField3);
            VarEvaluator.AddValue('CustomField4',CustomField4);
            VarEvaluator.AddValue('CustomField5',CustomField5);
            VarEvaluator.AddValue('CustomField6',CustomField6);
            VarEvaluator.AddValue('CustomField7',CustomField7);
            VarEvaluator.AddValue('CustomField8',CustomField8);
            VarEvaluator.AddValue('CustomField9',CustomField9);
            VarEvaluator.AddValue('CustomField10',CustomField10);
         end;
         if (ValidCharsOnly(Request.ContentFields.Values['RefererURL'],true,true,'/.-&(),:+=_ ') <> '') then begin
            RefererURL := ExtractDomain(ValidCharsOnly(Request.ContentFields.Values['RefererURL'],true,true,'/.-&(),:+=_ ')); //2018-12-19 jtm: DVST-126
         end;
         if RefererURL = '' then begin
            RefererURL := DomainHostname;
         end;
         LoadRNIDToVars(PaymentLocationRNID,VarEvaluator);
         VarEvaluator.AddValue('PaymentLocationRNID', PaymentLocationRNID);

         PaymentHistGuid := GenerateGUID;
         VarEvaluator.AddValue('PAYMENTGUID', PaymentHistGuid);

         RNQuery.Close;
         RNQuery.SQL.Clear;
         RNQuery.SQL.Add('select * from CustPaymentHistory');
         RNQuery.SQL.Add('where (PayHistGUID = '''+PaymentHistGUID + ''')');
         RNQuery.Open;
         RNQuery.Insert;
         RNQuery.FieldByName('SiteRNID').AsString := RNID;
         RNQuery.FieldByName('ChildGUID').AsString := ChildGUID;
         RNQuery.FieldByName('RNID').AsString := PaymentLocationRNID;
         RNQuery.FieldByName('CustGUID').AsString := CustGUID;
         RNQuery.FieldByName('PAYHISTGUID').AsString := PaymentHistGuid;
         RNQuery.FieldByName('PaySchedGUID').AsString := SchedGUID;
         RNQuery.FieldByName('PAYMENTGUID').AsString := PaymentGUID; //Request.ContentFields.Values['payment'];
         RNQuery.FieldByName('PaymentDate').AsDateTime := NOW;
         If (OpenXMLGetTag('/CONFIGDATA/STORECUSTOMFIELDS','FALSE') = 'TRUE') then begin //2017-09-20 jtm: F#2192
            RNQuery.FieldByName('Custom1').AsString := CustomField1;
            RNQuery.FieldByName('Custom2').AsString := CustomField2;
            RNQuery.FieldByName('Custom3').AsString := CustomField3;
            RNQuery.FieldByName('Custom4').AsString := CustomField4;
            RNQuery.FieldByName('Custom5').AsString := CustomField5;
            RNQuery.FieldByName('Custom6').AsString := CustomField6;
            RNQuery.FieldByName('Custom7').AsString := CustomField7;
            RNQuery.FieldByName('Custom8').AsString := CustomField8;
            RNQuery.FieldByName('Custom9').AsString := CustomField9;
            RNQuery.FieldByName('Custom10').AsString := CustomField10;
         end;
         RNQuery.FieldByName('RefererURL').AsString := RefererURL;
         If Trim(PaymentAmount) = '' then PaymentAmount := ValidCharsOnly(Request.ContentFields.Values['otamount'],False,True,'.');
         If Trim(PaymentAmount) = '' then PaymentAmount := ValidCharsOnly(Request.ContentFields.Values['amount'],False,True,'.');

         If Trim(PaymentAmount) = '' then PaymentAmount := ValidCharsOnly(VarEvaluator.GetValueAsString('PAYMENTAMOUNT'),False,True,'.');

         If (InputXML <> Nil) then begin
            if strtobool(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/CHECKPAYMENTAMOUNT','FALSE')) then begin
               if (ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTAMOUNT'),False,True,'.') <> '') then begin
                  PaymentAmount := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTAMOUNT'),False,True,'.');
               end;
            end else begin
               PaymentAmount := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTAMOUNT'),False,True,'.'); //If we're processing XML, assign it that way
            end;
         end;
         If PaymentAmount = '' then begin
            PaymentAmount := VarEvaluator.GetValueAsString('CustPaySched.PaymentAmount');
         end;
         ProcessLog(ltDebug,'ProcessPortalPayment PaymentAmount after CustPaySched.PaymentAmount',PaymentAmount);


         ProcessLog(ltInfo,VarEvaluator.GetValueAsString('CustPaySched.GrossAmount') + '/' +
                       VarEvaluator.GetValueAsString('CustPaySched.AmountPaid') + '/' +
                       VarEvaluator.GetValueAsString('CustPaySched.GrossAmount') + '/' ,NumericOnly(Request.ContentFields.Values['School']));
         If VarEvaluator.GetValueAsCurrency('CustPaySched.GrossAmount') > 0 then begin
            SchedAmountDue := VarEvaluator.GetValueAsCurrency('CustPaySched.GrossAmount') -
                              VarEvaluator.GetValueAsCurrency('CustPaySched.AmountPaid');
            If (SchedAmountDue < ValuReal(PaymentAmount)) and (NOT IsOffline) then begin
               PaymentAmount := Trim(StriReal(SchedAmountDue,2));
            end;
         end;


         If (PaymentGUID = 'REFUND') then begin
            PaymentAmount := Trim(StriReal(0-(ABS(ValuReal(PaymentAMount))),2));
         end;

         if( (StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/DISPLAYBALANCEDUE','FALSE'))) And (Trim(VarEvaluator.GetValueAsString('CustPaySched.Custom4')) = 'balanceDue'))then begin // 2019-2-13 ss DVST-3841
            PaymentAmount := Trim(VarEvaluator.GetValueAsString('CUSTOMERS.BALANCEDUE'));
         end;

         RNQuery.FieldByName('PaymentAmount').AsString := PaymentAmount;
         RNQuery.FieldByName('SplitDetails').AsString := Request.ContentFields.Values['split'];
         If (InputXML <> Nil) then
            RNQuery.FieldByName('SplitDetails').AsString := InputXML.GetValueAsWideString('/TRANSACTION/SPLIT');

         RNQuery.Post;
         VarEvaluator.AddDSCurrentRecord(RNQuery, 'CustPaymentHistory');
         VarEvaluator.AddValue('PaymentAmount', PaymentAmount);

         ReceiptNumber := Trim(PaymentLocationRNID) + '-' +
                         RNQuery.FieldByName('SystemCode').AsString + '-' +
                         FormatDateTime('YYMMDD',date);

         VarEvaluator.AddValue('ReceiptNumber', ReceiptNumber);  //make this available for custom receipt email
         VarEvaluator.AddValue('InputTranIdent',ValidCharsOnly(Request.ContentFields.Values['TranIdent'],True,True,'.-_:/& '));  //2017-12-20 jtm D#3416

         If TranIdent <> '' then begin
         end else if GetConfigString('TRANIDENTTYPE','STD') = 'STD' then begin
            TranIdent := ReceiptNumber;
         end else if (GetConfigString('TRANIDENTTYPE','') = 'OTP') and (ValidCharsOnly(Request.ContentFields.Values['TranIdent'],True,True,'.-_:/& ') <> '') then begin  //2017-05-10 jtm D#1605
            TranIdent := ValidCharsOnly(Request.ContentFields.Values['TranIdent'],True,True,'.-_:/& ');  //2017-05-10 jtm D#1605
         end else begin
            TranIdent := AccountNumber + '/' + ValidCharsOnly(Request.ContentFields.Values['invoice'],true,true,'.-_:/& '); //2017-05-10 jtm D#1605
            If ValidCharsOnly(Request.ContentFields.Values['dob'],false,true,'/.-') <> '' then
               TranIdent :=  '(' + ValidCharsOnly(Request.ContentFields.Values['dob'],false,true,'/.-') + ')' + TranIdent;
         end;
         TranAmount := '$' + Trim(StriReal(RNQuery.FieldByName('PaymentAmount').AsFloat,2));

         ProcessLog(ltInfo,'PROCESS PAYMENT CustPaymentHistory inserted',NumericOnly(Request.ContentFields.Values['School']));

         If (PaymentGUID = 'CASH') or
            (PaymentGUID = 'CHECK') or
            (PaymentGUID = 'CARD') or
            (PaymentGUID = 'REFUND')  then begin
            Offline := True;
            GWSystemCode := '99999';
            PaymentResponse := 'Offline OK';
            ApprovalCode := 'OFFLINE';
            PaymentType := 'OFFLINE';
            PaymentToken := 'OFFLINE';
            SupressReceipt := True;
            Result := True;
         end else if (PaymentGUID = 'CARD KEYED') then begin
            PaymentType := 'CARD';
         end else begin
            RNQuery.Close;
            RNQuery.SQL.Clear;
            RNQuery.SQL.Add('select * from custpayment where PaymentGUID =''' + PaymentGUID +'''');
            RNQuery.Open;

            ProcessLog(ltInfo,'PROCESS PAYMENT custpayment open',NumericOnly(Request.ContentFields.Values['School']));

            If RNQuery.RecordCount = 0 then begin
               ProcessLog(ltWarning,'Attempt to Process Payment, Payment GUID not found',PaymentGUID);
               Response.Content := '<head><title>Make a Payment</title><meta http-equiv="refresh" content="0;URL=/PP?PAGE=MAKEPAYMENT"></head>';
               RNQuery.Close;
               exit;
            end;
            VarEvaluator.AddDSCurrentRecord(RNQuery, 'CustPayment');
            If RnQuery.FieldByName('CardExpires').AsString <> '' then
               VarEvaluator.AddValue('CARDEXP',FormatDateTime('M/YY', RnQuery.FieldByName('CardExpires').AsDateTime));

            PaymentToken := Trim(RNQuery.FieldByName('PaymentToken').AsString);
            PaymentType := Trim(RNQuery.FieldByName('PaymentType').AsString);
            PaymentServiceName := Trim(RNQuery.FieldByName('ServiceName').AsString);
            PaymentCardName := Trim(RNQuery.FieldByName('CardAccountHolder').AsString); //2017-01-06 jtm F#1290
            BillingZip := ValidCharsOnly(Trim(RNQuery.FieldByName('PaymentZip').AsString),False,True,'');   //2016-3-28 jtm
            BillingStreet := ValidCharsOnly(Trim(RNQuery.FieldByName('PaymentAddress').AsString),True,True,'');
            if (Length(BillingZip) >= 5) then begin
               if BillingStreet = '' then begin
                   if (Length(BillingZip) = 5) or (Length(BillingZip) = 9) then PaymentsAVS := BillingZip;
               end else begin
                  if Length(BillingStreet) > 20 then BillingStreet := Copy(BillingStreet,0,20);
                  if Length(BillingZip) = 5  then begin
                     PaymentsAVS := BillingZip + '0000' + BillingStreet;
                  end else if Length(BillingZip) = 9 then begin
                     PaymentsAVS := BillingZip + BillingStreet;
                  end;
               end;
               if Length(PaymentsAVS) > 29 then PaymentsAVS := Copy(PaymentsAVS,0,29);
            end else begin
               PaymentsAVS := '';
            end;
         end;

         EmpIdent := '';
         if ((OpenXMLGetTag('/CONFIGDATA/SENDEMPIDENT', '') = 'TRUE') and
         ((SessionVarEval.GetValueAsString('Session.Username') <> '') or (ExternalXMLGetTag('/EXTERNALXML/USERNAME') <> ''))) then begin
            EmpIdent := SessionVarEval.GetValueAsString('Session.Username');
            if EmpIdent = '' then EmpIdent := trim(ExternalXMLGetTag('/EXTERNALXML/USERNAME'));
            ProcessLog(ltInfo,'ProcessPortalPayment EmpIdent', EmpIdent);
         end;
         VarEvaluator.AddValue('EmpIdent',EmpIdent); // 2019-3-13 ss DVST-3178

         if not (OpenXMLGetTag('/CONFIGDATA/SENDCARDNAME', '') = 'TRUE') then begin  //2017-01-06 jtm F#1290
            PaymentCardName := '';
         end;

         UserName := VarEvaluator.GetValueAsString('Session.Username');
         if UserName = '' then UserName := trim(ExternalXMLGetTag('/EXTERNALXML/USERNAME'));
         PaymentTransactionType := 'CCAUTH';
         CCAuthType := 'SALE';
         if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/DISPLAYAUTHTYPES', 'FALSE')) and (CustomerMembType = 'ADMIN') then begin  //2017-05-24 jtm F#1577
            RequestPaymentTransactionType := ValidCharsOnly(Request.ContentFields.Values['PaymentTransactionType'], true, false, '');
            if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ALLOWISSUECREDIT', 'FALSE')) AND (RequestPaymentTransactionType = 'CCCREDIT') then begin  // DVST-148
               if Not UserIs('READONLY', PaymentRNID) then begin
                  PaymentTransactionType := 'CCCREDIT';
                  CCAuthType := '';
                  ProcessLog(ltInfo,'PaymentTransactionType; changed by;', PaymentTransactionType + ' ' + UserName);
               end;
            end else if RequestPaymentTransactionType = 'CCAUTH' then begin
               CCAuthType := 'AUTH';
            end;
         end;


         PaymentResponse := '';

         TranIdentExpression := OpenXMLGetTag('/CONFIGDATA/TRANIDENTEXPRESSION');
         If TranIdentExpression <> '' then begin
            TranIdent := VarEvaluator.VarExprEvalAsString('',TranIdentExpression);
         end;
         CustIdentExpression := OpenXMLGetTag('/CONFIGDATA/CUSTIDENTEXPRESSION');
         If CustIdentExpression <> '' then begin
            CustIdent := VarExprEvalAsString('',CustIdentExpression);
         end;
         StationIdentExpression := OpenXMLGetTag('/CONFIGDATA/STATIONIDENTEXPRESSION');// 2019-3-13 ss DVST-3178
         if(StationIdentExpression <> '') then begin
            ProcessLog(ltDebug, 'ProcessPortalPayment', 'StationIdentExpression = '+StationIdentExpression);
            StationIdent := VarExprEvalAsString('',StationIdentExpression);
         end;
         VarEvaluator.AddValue('StationIdent',StationIdent); // 2019-3-13 ss DVST-3178
         ProcessLog(ltDebug, 'ProcessPortalPayment', 'StationIdent = '+StationIdent);// 2019-4-17 ss DVST-5369

         VarEvaluator.AddValue('TRANIDENT',TranIdent);
         VarEvaluator.AddValue('PAYMENTTYPE',PAYMENTTYPE);
         VarEvaluator.AddValue('CUSTIDENT',CustIdent); //2018-06-20 bls: F#2076

         If PaymentType = 'CARD' then begin
            if(StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/CREATEPOSTICKET','FALSE')))) then begin // 2019-4-17 ss DVST-3651
               if(Not(IsPOSTicketOpen(SessionVarEval, VarEvaluator))) then begin
                  Result := False;
                  Exit; // Error meesage is logged in 'I2PAYERROR' and put inside VarEvaluator. ProcesssLog is called inside IsPOSTicketOpen to log other messages.
               end;
               if(Not(IsPOSTicketAdd(SessionVarEval, VarEvaluator))) then begin
                  Result := False;
                  Exit;
               end;
            end;

            PaymentRequest := '<TRANSACTION> <RNID>'+PaymentRNID+'</RNID>' +
                              '<TRANSACTIONTYPE>'+PaymentTransactionType+'</TRANSACTIONTYPE>';
            if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/DISPLAYAUTHTYPES', 'FALSE')) and (CCAuthType <> '') and (PaymentTransactionType = 'CCAUTH') then begin
               PaymentRequest := PaymentRequest + '<CCAUTHTYPE>' + CCAuthType + '</CCAUTHTYPE>';
            end;
            ProcessLog(ltInfo,'PaymentTransactionType', PaymentTransactionType);
            if OpenXMLGetTag('/CONFIGDATA/PAYMENTTYPES/PAYMENTTYPE[@NAME=''CREDIT'']/SERVICENAME') <> '' then
                  PaymentServiceName := OpenXMLGetTag('/CONFIGDATA/PAYMENTTYPES/PAYMENTTYPE[@NAME=''CREDIT'']/SERVICENAME');
            if PaymentServiceName = '' then
               PaymentServiceName := 'CARD';
            PaymentRequest := PaymentRequest + '<SERVICENAME>'+ PaymentServiceName+'</SERVICENAME>';
            ProcessLog(ltInfo,'PaymentServiceName', PaymentServiceName);
            if OTPCardAcct <> '' then begin
               PaymentRequest := PaymentRequest + '<CCACCOUNT>'+OTPCardAcct+'</CCACCOUNT>';
               PaymentRequest := PaymentRequest + '<CCEXP>'+OTPCardExp+'</CCEXP>';
               if OTPCVV <> '' then
                  PaymentRequest := PaymentRequest + '<CCCVV>'+OTPCVV+'</CCCVV>';
               if OTPAVS <> '' then
                  PaymentRequest := PaymentRequest + '<CCAVS>'+OTPAVS+'</CCAVS>';  //2016-3-28 jtm

            end else if CardEventParms <> '' then begin     //2016-8-22 jtm: Feat OT#1053
               CardEventParamsXPath := '/CARDEVENTPARAMS'; // 2019-5-15 SS DVST-572
               if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ENABLESURCHARGESANDFEES', 'FALSE')) then begin
                  PaymentRequest := PaymentRequest + '<SURCHARGEAMT>' + ValidCharsOnly(Request.ContentFields.Values['SURCHARGEAMT'], false, true, '.') + '</SURCHARGEAMT>' +
                                    '<SURCHARGELEGAL>' + ValidCharsOnly(Request.ContentFields.Values['SURCHARGELEGAL'], true, true, '!?'';-.,()*": ') + '</SURCHARGELEGAL>';
               end;
               if NumericOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCDEVICETYPE'))) = '3' then begin //2017-08-02 jtm: F#2035
                 IDTechDecrypt := TIDTechDecrypt.Create(Trim(GetXMLTagStr(CardEventParms,'ENCDVCENCRYPTEDBLOCK')), PL.ProcessLog);
                  CardEventParms := AddDeviceCapabilities(IDTechDecrypt.GenerateCardEventParmsXML, CardEventParamsXPath, ['MKEY', 'MSR']); // 2019-5-15 SS DVST-572
                  PaymentRequest := PaymentRequest + CardEventParms; // 2019-5-15 SS DVST-572
               end else if NumericOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCDEVICETYPE'))) = '6' then begin //2018-11-14 bls: DVST-1944
                  PaymentRequest := PaymentRequest + CardEventParms;
               end else begin
                  CardEventParms := '<CARDEVENTPARAMS>'+ // 2019-5-15 SS DVST-572
                                    '<MTKSN>'+ ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'MTKSN')),True,True,'') +'</MTKSN>'+
                                    '<MTSESSIONID>' + Trim(GetXMLTagStr(CardEventParms,'MTSESSIONID')) + '</MTSESSIONID>'+
                                    '<MTENCRYPTEDTRACK1>' + Trim(GetXMLTagStr(CardEventParms,'MTENCRYPTEDTRACK1')) + '</MTENCRYPTEDTRACK1>'+
                                    '<MTENCRYPTEDTRACK2>' + Trim(GetXMLTagStr(CardEventParms,'MTENCRYPTEDTRACK2')) + '</MTENCRYPTEDTRACK2>'+
                                    '<MTDEVICESERIAL>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'MTDEVICESERIAL')),True,True,'') + '</MTDEVICESERIAL>'+
                                    '<MTMPDATA>' + Trim(GetXMLTagStr(CardEventParms,'MTMPDATA')) + '</MTMPDATA>'+
                                    '<MTMPSTATUS>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'MTMPSTATUS')),True,True,'') + '</MTMPSTATUS>'+
                                 '</CARDEVENTPARAMS>';
                  PaymentRequest := PaymentRequest + AddDeviceCapabilities(CardEventParms, CardEventParamsXPath, ['MKEY', 'MSR']); // 2019-5-15 SS DVST-572
               end;
               ProcessLog(ltInfo,'CardEventParms', CardEventParms);
                 if OTPAVS <> '' then
                     PaymentRequest := PaymentRequest + '<CCAVS>'+OTPAVS+'</CCAVS>';
            end else if OTPTAToken <> '' then begin
               PaymentRequest := PaymentRequest + '<TRANSARMORTOKEN>'+OTPTAToken+'</TRANSARMORTOKEN>';
               PaymentRequest := PaymentRequest + '<CCEXP>'+OTPTACardExp+'</CCEXP>';
               PaymentRequest := PaymentRequest + '<TRANSARMORTOKENPROVIDERID>'+OTPTATokenType+'</TRANSARMORTOKENPROVIDERID>';
               if OTPAVS <> '' then
                  PaymentRequest := PaymentRequest + '<CCAVS>'+OTPAVS+'</CCAVS>';  

            end else begin
               if PaymentsAVS <> '' then
                  PaymentRequest := PaymentRequest + '<CCAVS>'+PaymentsAVS+'</CCAVS>';

               PaymentRequest := PaymentRequest + '<REPTOKEN>'+PaymentToken+'</REPTOKEN>';
            end;
            if EmpIdent <> '' then
               PaymentRequest := PaymentRequest + '<EMPIDENT>'+EmpIdent+'</EMPIDENT>'; //2016-8-22 jtm: Feat OT#915
            if PaymentCardName <> '' then begin
               PaymentRequest := PaymentRequest + '<CCNAME>'+PaymentCardName+'</CCNAME>'; //2017-01-06 jtm F#1290
            end;
            if (OpenXMLGetTag('/CONFIGDATA/INCLUDEEMPTYTAXAMOUNT','FALSE') = 'TRUE') then begin  //2017-12-13 jtm D#2146
               PaymentRequest := PaymentRequest + '<TAXAMOUNT>0</TAXAMOUNT>';
            end;
            PaymentRequest := PaymentRequest + '<CCAUTHTYPE>SALE</CCAUTHTYPE> <CCAMT>'+PaymentAmount+'</CCAMT>' +
                                               '<TRANIDENT>'+Tranident+'</TRANIDENT> <CUSTIDENT>'+CustIdent+WS2+'</CUSTIDENT> <STATIONIDENT>'+StationIdent+'</STATIONIDENT>';
            if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then    //2016-9-19 jtm: Feat OT# 1145
               PaymentRequest := PaymentRequest + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';

            if(StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/CREATEPOSTICKET','FALSE')))) then begin // 2019-4-17 ss DVST-3651
               PaymentRequest := PaymentRequest + '<TICKETGUID>'+VarEvaluator.GetValueAsString('POSTICKETGUID')+'</TICKETGUID>';
            end;


            PaymentRequest := PaymentRequest + ' </TRANSACTION>'+CRLF;
            XMLResp := TStringList.Create;
            VarEvaluator.AddValue('GatewayRNID',PaymentRNID);//2017-05-24 jtm: F#1821
            ProcessPPSAPIXML(PaymentRequest, XMLResp,GetAppServerHost,0);

            PromptForFraudReversal := strtobool(GetXMLTag(XMLResp, 'PROMPTFORFRAUDREVERSAL')); //2018-06-20 bls: F#2076
            FraudAutoReversal := GetXMLTag(XMLResp, 'REVERSALREASON'); //2018-06-20 bls: F#2076
            transuccess := strtobool(GetXMLTag(XMLResp,'TRANSUCCESS'));

            if (GetXMLTag(XMLResp,'CCAUTHCODE') <> '') then begin
               ApprovalCode := GetXMLTag(XMLResp,'CCAUTHCODE');
               if (NOT PromptForFraudReversal) and (FraudAutoReversal = '') then begin //2018-06-06 bls: F#2076

                  HTMLTemplate := 'ReceiptCardApproved.htm';

                  EmailMessage := '<HTML>Thank you for your Payment.<BR>'+//PaymentToken + '/' + PaymentType +  Trim(Request.ContentFields.Values['payment'])+  PaymentREsponse +
                                  'Receipt Number:' + ReceiptNumber + '<BR>' +
                                  'Amount:' + TranAmount+ '<BR>' +
                                  'Date:' + FormatDateTime('MM/DD/YYYY', NOW)+ '<BR>';
                  EmailMessage := EMailMessage + '<BR>' +CustIdent;
                  EmailMessage := EMailMessage + '<BR>' +AccountNumber;

                  If strtobool(OpenXMLGetTag('/CONFIGDATA/EMAILPAYMENTMATERECEIPT')) then begin
                     ProcessLog(ltInfo,'Retrieving PaymentMate Receipt', 'PaymentLocationRNID:'+ VarEvaluator.GetValueAsString('PaymentLocationRNID') + ' CCSYSTEMCODE:'+ GetXMLTag(XMLResp,'CCSYSTEMCODE'));
                     ReceiptEmail := RetrieveReceipt(VarEvaluator.GetValueAsString('PaymentLocationRNID'),GetXMLTag(XMLResp,'CCSYSTEMCODE'),GetXMLTag(XMLResp,'TICKETGUID'),'CCRECEIPTRETRIEVE');
                     if ReceiptEmail <> '' then begin
                        ProcessLog(ltInfo,'PaymentMate Receipt found:', 'Adding it to Email');
                        EmailMessage := ReceiptEmail;
                     end;
                  end;
                  if (ReceiptToCustEmail AND (CustEmail <> '')) then begin
                     ReceiptEmail := EmailReceipt(CustEmail,VarEvaluator.GetValueAsString('PaymentLocationRNID'),GetXMLTag(XMLResp,'CCSYSTEMCODE'),GetXMLTag(XMLResp,'TICKETGUID'),'CARD');
                     ProcessLog(ltInfo,'PaymentMate Receipt to Customer:', ReceiptEmail);
                  end;

                  If OpenXMLGetTag('/CONFIGDATA/APPROVEDEMAILEXPRESSION') <> '' then begin
                     EmailMessage := VarEvaluator.VarExprEvalAsString('',OpenXMLGetTag('/CONFIGDATA/APPROVEDEMAILEXPRESSION'));
                  end;

                  if(StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/DISPLAYBALANCEDUE','FALSE'))) then begin // 2019-2-13 ss DVST-3840
                     ProcessLog(ltDebug, 'ProcessPortalPayment()', 'Calling  AdjustPaymetByCustGUIDAndPaymentAmount(). The PaymentAmount is: '+ValidCharsOnly(Request.ContentFields.Values['amount'],False,True,'.'));
                     AdjustPaymetByCustGUIDAndPaymentAmount(CustGUID, PaymentAmount);
                  end;

               end else if (FraudAutoReversal <> '') then begin
                  ProcessLog(ltInfo, METHOD_NAME, 'FraudAutoReversal is: ' + FraudAutoReversal);
                  HTMLTemplate := 'ReceiptCardDeclined.htm';
                  EmailMessage := '<HTML>Your Credit card Payment was automatically reversed based on fraud detection settings.';
                  if (StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/FRAUDAUTOREVERSALRETURNFALSE','FALSE'))) then begin
                     Result := False;
                     Exit;
                  end;
               end;
               VarEvaluator.AddValue('CVVRespText', GetXMLTag(XMLResp, 'CVVRESPTEXT')); //2018-06-20 bls: F#2076
               VarEvaluator.AddValue('AVSRespText', GetXMLTag(XMLResp, 'AVSRESPTEXT')); //2018-06-20 bls: F#2076
               VarEvaluator.AddValue('CCSystemCode', GetXMLTag(XMLResp, 'CCSYSTEMCODE')); //2018-06-20 bls: F#2076
               VarEvaluator.AddValue('AccountNumber', AccountNumber); //2018-06-20 bls: F#2076
               VarEvaluator.AddValue('TranAmount', Request.ContentFields.Values['amount']); //2018-06-20 bls: F#2076
               
               Result := True;

               if(StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/CREATEPOSTICKET','FALSE')))) then begin // 2019-4-17 ss DVST-3651
                  if(Not(IsPOSTicketUpdate(SessionVarEval, VarEvaluator, XMLResp))) then begin
                     Result := False;
                     Exit;
                  end;
               end;
            end else begin
               NonAuthReason := GetXMLTag(XMLResp,'TRANRESPMESSAGE');
               HTMLTemplate := 'ReceiptCardDeclined.htm';

               EmailMessage := '<HTML>We''re sorry, but your Credit card Payment was not processed.<BR>'+
                               'Please confirm your account information is correct or call your card issuer for further assistance.<BR>';
               EmailMessage := EMailMessage + '<BR>' +CustIdent;
               EmailMessage := EMailMessage + '<BR>' +AccountNumber;

               if(StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/CREATEPOSTICKET','FALSE')))) then begin // 2019-4-17 ss DVST-3651
                  if(Not(IsPOSTicketDelete(SessionVarEval, VarEvaluator, XMLResp))) then begin
                     Result := False;
                     Exit;
                  end;
               end;
            end;
            if PaymentTransactionType = 'CCCREDIT' then begin  //2017-05-24 jtm F#1577
               if GetXMLTag(XMLResp,'TRANSUCCESS') = 'TRUE' then begin
                  HTMLTemplate := 'ReceiptCardApproved.htm';

                  EmailMessage := '<HTML>Credit Issued.<BR>'+
                                  'Receipt Number:' + ReceiptNumber + '<BR>' +
                                  'Amount:' + TranAmount+ '<BR>' +
                                  'Date:' + FormatDateTime('MM/DD/YYYY', NOW)+ '<BR>';
                  EmailMessage := EMailMessage + '<BR>' +CustIdent;
                  EmailMessage := EMailMessage + '<BR>' +AccountNumber;

                  If OpenXMLGetTag('/CONFIGDATA/EMAILPAYMENTMATERECEIPT') = 'TRUE' then begin
                     ProcessLog(ltInfo,'Retrieving PaymentMate Receipt', 'PaymentLocationRNID:'+ VarEvaluator.GetValueAsString('PaymentLocationRNID') + ' CCSYSTEMCODE:'+ GetXMLTag(XMLResp,'CCSYSTEMCODE'));
                     ReceiptEmail := RetrieveReceipt(VarEvaluator.GetValueAsString('PaymentLocationRNID'),GetXMLTag(XMLResp,'CCSYSTEMCODE'),GetXMLTag(XMLResp,'TICKETGUID'),'CCRECEIPTRETRIEVE');
                     if ReceiptEmail <> '' then begin
                        ProcessLog(ltInfo,'PaymentMate Receipt found:', 'Adding it to Email');
                        EmailMessage := ReceiptEmail;
                     end;
                  end;
                  If OpenXMLGetTag('/CONFIGDATA/APPROVEDEMAILEXPRESSION') <> '' then
                     EmailMessage := VarEvaluator.VarExprEvalAsString('',OpenXMLGetTag('/CONFIGDATA/APPROVEDEMAILEXPRESSION'));

                  Result := True;
               end else begin
                  NonAuthReason := GetXMLTag(XMLResp,'TRANRESPMESSAGE');
                  HTMLTemplate := 'ReceiptCardDeclined.htm';

                  EmailMessage := '<HTML>We''re sorry, but your credit was not issued.<BR>'+
                                  'Please confirm your account information is correct or call your card issuer for further assistance.<BR>';
                  EmailMessage := EMailMessage + '<BR>' +CustIdent;
                  EmailMessage := EMailMessage + '<BR>' +AccountNumber;
               end;
            end;
            GWSystemCode := GetXMLTag(XMLResp,'CCSYSTEMCODE');

            PaymentResponse := GetXMLTag(XMLResp,'CCAUTHCODE');
            VarEvaluator.AddValue('CardType',GetXMLTag(XMLResp,'CCCARDTYPEEX')); //2017-10-04 jtm: F#2224
            XMLResp.Free;

         end;
         If PaymentType = 'CHECK' then begin
            PaymentRequest := '<TRANSACTION>' +
                              '   <TRANSACTIONTYPE>TCAUTH</TRANSACTIONTYPE>' +
                              '   <SERVICENAME>ICA</SERVICENAME>' +
                              '   <RNID>'+PaymentRNID+'</RNID>' +
                              '   <CHECKTYPE>PERSONAL</CHECKTYPE>' +
                              '   <CHECKAMT>' + PaymentAmount + '</CHECKAMT>';

            ProcessLog(ltDebug,METHOD_NAME, 'CheckAccount POS of *;'+IntToStr(Pos('*',Trim(RNQuery.FieldByName('CheckAccount').AsString))));
            if (Pos('*',Trim(RNQuery.FieldByName('CheckAccount').AsString)) > 0) then begin
               PaymentRequest := PaymentRequest + '<REPTOKEN>'+PaymentToken+'</REPTOKEN>';
               ProcessLog(ltInfo,METHOD_NAME, 'Processing check with REPTOKEN');
            end else begin
               PaymentRequest := PaymentRequest + '   <CHECKROUTING>'+Trim(RNQuery.FieldByName('CheckRouting').AsString)+'</CHECKROUTING>' +
                              '   <CHECKACCOUNT>'+Trim(RNQuery.FieldByName('CheckAccount').AsString)+'</CHECKACCOUNT>';
               if (OpenXMLGetTag('/CONFIGDATA/SENDCHECKDL', 'TRUE') = 'TRUE') then begin  //2017-04-06 jtm Feat #1650 don't send for clients who have waivers
                  PaymentRequest := PaymentRequest + '   <CHECKDL>'+Trim(RNQuery.FieldByName('LicenseNum').AsString)+'</CHECKDL>' +
                                 '   <CHECKDLSTATE>'+Trim(RNQuery.FieldByName('LicenseState').AsString)+'</CHECKDLSTATE>';
               end;
            end;
            PaymentRequest := PaymentRequest + '   <CHECKNAME>'+CustIdent+WS2+'</CHECKNAME>' +
                              '   <CUSTIDENT>'+ CustIDent+'</CUSTIDENT>'+
                              '   <TRANIDENT>'+ TranIdent+'</TRANIDENT>'+
                              '   <STATIONIDENT>'+ StationIdent+'</STATIONIDENT>';

            XMLResp := TStringList.Create;
            if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then      //2016-9-19 jtm: Feat OT# 1145
               PaymentRequest := PaymentRequest + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';

            PaymentRequest := PaymentRequest + ' </TRANSACTION>'+CRLF;
            VarEvaluator.AddValue('GatewayRNID',PaymentRNID);//2017-05-24 jtm: F#1821
            ProcessPPSAPIXML(PaymentRequest, XMLResp,GetAppServerHost,0);

            GWSystemCode := GetXMLTag(XMLResp,'TCSYSTEMCODE');
            IF GetXMLTag(XMLResp,'TCECASTATUS') = '1' then begin
               ApprovalCode := GetXMLTag(XMLResp,'TCDISPLAYTEXT');
               HTMLTemplate := 'ReceiptCheckApproved.htm'; //2017-09-20 jtm: F#2196
               EmailMessage := '<HTML>Thank you for your Payment.<BR>'+//PaymentToken + '/' + PaymentType +  Trim(Request.ContentFields.Values['payment'])+  PaymentREsponse +
                               'Receipt Number:' + TranIdent + '<BR>' +
                               'Amount:' + TranAmount+ '<BR>' +
                               'Date:' + FormatDateTime('MM/DD/YYYY', NOW)+ '<BR>';
               EmailMessage := EMailMessage + '<BR>' +CustIdent;
               EmailMessage := EMailMessage + '<BR>' +AccountNumber;

               If OpenXMLGetTag('/CONFIGDATA/APPROVEDEMAILEXPRESSION') <> '' then
                  EmailMessage := VarEvaluator.VarExprEvalAsString('',OpenXMLGetTag('/CONFIGDATA/APPROVEDEMAILEXPRESSION'));

               if(StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/DISPLAYBALANCEDUE','FALSE'))) then begin // 2019-2-13 ss DVST-3840
                  ProcessLog(ltDebug, 'ProcessPortalPayment()', 'Calling  AdjustPaymetByCustGUIDAndPaymentAmount(). The PaymentAmount is: '+ValidCharsOnly(Request.ContentFields.Values['amount'],False,True,'.'));
                  AdjustPaymetByCustGUIDAndPaymentAmount(CustGUID, PaymentAmount);
               end;

               Result := True;
            end else begin
               NonAuthReason := GetXMLTag(XMLResp,'TCDISPLAYTEXT');
               HTMLTemplate := 'ReceiptCheckDeclined.htm'; //2017-09-20 jtm: F#2196
               EMailMessage := '<HTML>Your check payment has not been processed.<BR><BR>'+
                               'We are sorry that we cannot accept your check at this time.  Our decision is based, in whole or in part, on '+
                               'information provided to us by TeleCheck(r).  We encourage you to call TeleCheck at 1-800-366-2425 or write TeleCheck '+
                               'Customer Care at P.O. Box 6806, Hagerstown, MD 21741-6806.  TeleCheck can discuss with you the information that led to '+
                               'our decision not to accept your check at this time.  Please provide TeleCheck your driver''s license number and the '+
                               'state where it was issued, and the complete banking numbers printed on the bottom of your check. Under the Fair Credit '+
                               'Reporting Act, you have the right to a free copy of your information held in TeleCheck''s files within 60 days from today. '+
                               'You may also dispute the accuracy or completeness of any information in TeleCheck''s consumer report.<BR><BR></HTML>';
               EmailMessage := EMailMessage + '<BR>' +CustIdent;
               EmailMessage := EMailMessage + '<BR>' +AccountNumber;
            end;
            PaymentResponse := GetXMLTag(XMLResp,'TCDISPLAYTEXT');


            XMLResp.Free;


         end;
         VarEvaluator.AddValue('PR',PaymentResponse);
         VarEvaluator.AddValue('GWSC',GWSystemCode);
         VarEvaluator.AddValue('ApprovalCode',ApprovalCode);
         VarEvaluator.AddValue('NonAuthReason',NonAuthReason);
         VarEvaluator.AddValue('PromptForFraudReversal', booltostr(PromptForFraudReversal)); //2018-06-20 bls: F#2076
         VarEvaluator.AddValue('FraudAutoReversal', FraudAutoReversal); //2018-06-20 bls: F#2076

         RNQuery.Close;
         RNQuery.SQL.Clear;
         RNQuery.SQL.Add('select * from CustPaymentHistory');
         RNQuery.SQL.Add('where (PayHistGUID = '''+PaymentHistGUID + ''')');
         RNQuery.Open;
         RNQuery.Edit;
         RNQuery.FieldByName('ApprovalCode').AsString := ApprovalCode;
         RNQuery.FieldByName('NonAuthReason').AsString := NonAuthReason;
         RNQuery.FieldByName('GWSystemCode').AsInteger := Valu(GWSystemCode);

         if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/STORECARDTYPE','FALSE')) then begin
            RNQuery.FieldByName('Custom8').AsString := VarEvaluator.GetValueAsString('CardType');
         end;

         RNQuery.Post;

         If SchedGUID <> '' then begin
            ComputeSchedule(SchedGUID,RNID,IsPlanPayment,Email);
         end;

         If ApprovalCode <> '' then begin
            ProcessExternalPaymentPosts(PaymentLocationRNID); //process any external payments if necessary
         end;

         if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAIL/INCLUDESPILT') = 'TRUE' then begin
            If RNQuery.FieldByName('SplitDetails').ASString <> '' then
               EMailMessage := EMailMessage + '<BR>' + GenerateSplitTable(RNQuery.FieldByName('SplitDetails').ASString);
         end;

         ReplaceString(WS, '%RECEIPTURL%','/PP?PAGE=PAYMENTRECEIPT&PAYHISTGUID=' + Trim(RNQuery.FieldByName('PAYHISTGUID').AsString));
         ReplaceString(WS, '%PAYMENTSYSTEMCODE%',receiptNumber);
         response.Content := WS;

         ProcessLog(ltDebug, 'ProcessPortalPayment: Check VarEvaluator', VarEvaluator.ToJSON);
      If ValuReal(PaymentAmount) = 0 then SupressReceipt := True;

      If (NOT (SupressReceipt) and (Email <> '') AND (NOT PromptForFraudReversal)) then begin
         if ((FraudAutoReversal <> '') AND (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/FRAUDAUTOREVERSALSENDEMAIL', 'FALSE')='FALSE')) then begin //2018-06-20 bls: F#2076
         end else begin
            If HTMLTemplate <> '' then begin
               HTMLEmail := LoadWebFileFromFolder(HTMLTemplate,'');   //we need to do this here so all of the variables are loaded.
               If HTMLEmail <> '' then EmailMessage := HTMLEmail;
            end;

            clMail.BuildMessage('',EmailMessage);
            clMail.From.FullAddress := '"' + DomainFriendlyName+'"<'+DomainSendAsEmail+'>';
            clMail.ToList.EmailAddresses := Email;
            clMail.BCCList.EmailAddresses := GetConfigString('CONFIRMATIONBCC','');
            if SessionVarEval.GetValueAsString('BCCEMAIL') <> '' then
               clMail.BCCList.EmailAddresses := clMail.BCCList.EmailAddresses + ',' + SessionVarEval.GetValueAsString('BCCEMAIL');
            if SessionVarEval.GetValueAsString('EmployeeEmail') <> '' then     //2016-8-08 jtm: Feat OT#979
               clMail.BCCList.EmailAddresses := clMail.BCCList.EmailAddresses + ',' + SessionVarEval.GetValueAsString('EmployeeEmail');

            ProcessLog(ltInfo,'bccemails', clMail.BCCList.EmailAddresses);
            If ApprovalCode  = '' then begin
               If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAIL/DECLINEDPAYMENTSUBJECT') <> '' then
                  clMail.Subject := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAIL/DECLINEDPAYMENTSUBJECT') + ' ' + FormatDateTime('MM/DD/YYYY', Date)
               else
                  clMail.Subject := 'Payment Failure Notification ' + FormatDateTime('MM/DD/YYYY', Date);
            end else begin
               If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAIL/APPROVEDPAYMENTSUBJECT') <> '' then
                  clMail.Subject := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAIL/APPROVEDPAYMENTSUBJECT') + ' ' + FormatDateTime('MM/DD/YYYY', Date)
               else
                  clMail.Subject := 'Payment Receipt ' + FormatDateTime('MM/DD/YYYY', Date);
            end;
               If ((OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/REPLYTOEMPLOYEE','FALSE') = 'TRUE') and (SessionVarEval.GetValueAsString('EmployeeEmail') <> '')) then begin
                  clMail.ReplyTo := SessionVarEval.GetValueAsString('EmployeeEmail');
               end else begin
            clMail.ReplyTo := GetConfigString('CONFIRMATIONREPLYTO','');
               end;
            SMTP.Open();
            try
               try
                  SMTP.Send(clMail);
               except  //2017-08-16 jtm: D#1857
                 On E:Exception do begin
                     ProcessLog(ltWarning,'Exception on Sending Email ', E.Message);
                 end;
               end;
            finally
               SMTP.Close();
            end;
         end;
      end;

   end else begin
      ProcessLog(ltWarning,'PROCESS Portal PAYMENT Customer GUID not found ' + CustGUID,'');
   end;

end;



Function TCustomerInfoModule.AddCustomerPaymentSchedule(RNID : String; CustGUID : String) : Boolean;
Var
  FREQ : String;
  SchedPayLoc : String;
  ChildGUID : String;
  PayAmt : Currency; //2017-01-06 jtm F#1291
  GrossAmt : Currency;
  NumberOfPayments : Integer;
  CustomField1 : string; //2017-09-20 jtm: F#2192
  CustomField2 : string;
  CustomField3 : string;
  CustomField4 : string;
  CustomField5 : string;
  CustomField6 : string;
  CustomField7 : string;
  CustomField8 : string;
  CustomField9 : string;
  CustomField10 : string;
begin
   SchedPayLoc := NumericOnly(Request.ContentFields.Values['School']);
   If SchedPayLoc = '' then
      SchedPayLoc := NumericOnly(Request.ContentFields.Values['Location']);

   If SchedPayLoc <> '' then begin
      Result := ValidateRNID(SchedPayLoc);
      If not Result then begin
         ProcessLog(ltWarning,'Attempt to add scheduled payment from Invalid Location RNID',NumericOnly(Request.ContentFields.Values['School']));
         exit;
      end;
   end;

   ChildGUID := GuidOnly(Request.ContentFields.Values['nameandacct']);
   If ChildGUID <> '' then begin
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('select * from CustChild');
      RNQuery.SQL.Add('where (ChildGUID = '''+ChildGUID + ''')');
      RNQuery.SQL.Add('And (CustGUID = '''+CustGUID + ''')');
      RNQuery.Open;
      If RnQuery.RecordCount = 0 then begin
        ProcessLog(ltWarning,'Attempt to process payment with invalid child guid ' + ChildGUID + '/' + CustGUID,NumericOnly(Request.ContentFields.Values['School']));
      end else begin
         SchedPayLoc := Trim(RNquery.FieldByName('RNID').AsString);
      end;
      RNQuery.Close;
   end;

   ProcessLog(ltInfo,'Adding Schedule:' + SchedPayLoc + '/' +UserXMLGetTag('/USERPROFILE/PORTALRNID') + '/'+ CustGUID,NumericOnly(Request.ContentFields.Values['School']));

   If Valu(SchedPayLoc) = 0 then begin
      If UserXMLGetTag('/USERPROFILE/PORTALRNID') <> '' then
         SchedPayLoc := UserXMLGetTag('/USERPROFILE/PORTALRNID')
      else
         SchedPayLoc := RNID;
   end;
   RNQuery.Close;
   RNQuery.SQL.Clear;
   RNQuery.SQL.Add('Select * from CustPaySched where (CustGUID = '''+CustGUID + ''')');
   RNQuery.Open;
   RNQuery.Insert;
   RNQuery.FieldByName('SiteRNID').AsString := RNID;
   RNQuery.FieldByName('RNID').AsString := SchedPayLoc;
   RNQuery.FieldByName('CustGUID').AsString := CustGUID;
   RNQuery.FieldByName('ChildGUID').AsString := ChildGUID;

   RNQuery.FieldByName('PAYSCHEDGUID').AsString := GenerateGUID;
   RNQuery.FieldByName('PAYMENTGUID').AsString := GUIDOnly(Request.ContentFields.Values['payment']);
   RNQuery.FieldByName('GrossAmount').AsCurrency := ValuReal(Request.ContentFields.Values['Balance']);
   FREQ := Request.ContentFields.Values['Frequency'];
   RNQuery.FieldByName('PaymentAmount').AsString := Request.ContentFields.Values['Amount'];
   RNQuery.FieldByName('Status').AsString := 'ACTIVE';
   RNQuery.FieldByName('ScheduleAdded').AsDateTime := Now;
   RNQuery.FieldByName('NumberOfPayments').AsInteger := Valu(Request.ContentFields.Values['NumberOfPayments']);
   RNQuery.FieldByName('PaymentsRemaining').AsInteger := RNQuery.FieldByName('NumberOfPayments').AsInteger;
   RNQuery.FieldByName('PaymentsMade').AsInteger := 0;
   If UpCaseString(FREQ)='MONTHLY' then begin
      RNQuery.FieldByName('FirstPayment').AsString := Request.ContentFields.Values['dateMonthly1'];
      RNQuery.FieldByName('Frequency').AsString := 'Monthly';
   end;
   If UpCaseString(FREQ)='BIMONTHLY' then begin
      RNQuery.FieldByName('FirstPayment').AsString := Request.ContentFields.Values['DateBimonthly'];
      RNQuery.FieldByName('Frequency').AsString := 'Bimonthly';
   end;
   If UpCaseString(FREQ)='ANNUALLY' then begin
      RNQuery.FieldByName('FirstPayment').AsString := Request.ContentFields.Values['DateAnnually'];
      RNQuery.FieldByName('Frequency').AsString := 'Annually';
   end;
   If UpCaseString(FREQ)='QUARTERLY' then begin
      RNQuery.FieldByName('FirstPayment').AsString := Request.ContentFields.Values['DateQuarterly'];
      RNQuery.FieldByName('Frequency').AsString := 'Quarterly';
   end;
   If Trim(UpCaseString(FREQ))='BIWEEKLY' then begin //2017-09-25 jtm: F#2203
      RNQuery.FieldByName('FirstPayment').AsString := Request.ContentFields.Values['DateBiweekly'];
      RNQuery.FieldByName('Frequency').AsString := FREQ;
   end;
   If UpCaseString(FREQ)='WEEKLY' then begin
      RNQuery.FieldByName('FirstPayment').AsString := Request.ContentFields.Values['DateWeekly'];
      RNQuery.FieldByName('Frequency').AsString := 'Weekly';
   end;
   RNQuery.FieldByName('NextPayment').AsDateTime := RNQuery.FieldByName('FirstPayment').AsDateTime;

   PayAmt := RNQuery.FieldByName('PaymentAmount').AsCurrency;
   GrossAmt := RNQuery.FieldByName('GrossAmount').AsCurrency;
   NumberOfPayments := RNQuery.FieldByName('NumberOfPayments').AsInteger;
   If (GrossAmt> 0) and (NumberOfPayments > 0) and (PayAmt=0) then begin  //only calculate the PaymentAmount if it is not present
      PayAmt := GrossAmt / NumberOfPayments * 100;
      If Frac(PayAmt) > 0 then PayAmt := Trunc(PayAmt + 1);
      PayAmt := PayAmt / 100;
      RNQuery.FieldByName('PaymentAmount').AsCurrency := PayAmt;
   end else if (GrossAmt= 0) and (NumberOfPayments > 0) and (PayAmt > 0) then begin  //only calculate the GrossAmount if it is not present
      GrossAmt := PayAmt * NumberOfPayments;
      RNQuery.FieldByName('GrossAmount').AsCurrency := GrossAmt;
   end;

   If (OpenXMLGetTag('/CONFIGDATA/STORECUSTOMFIELDS','FALSE') = 'TRUE') then begin //2017-09-20 jtm: F#2192
      CustomField1 := ValidCharsOnly(Request.ContentFields.Values['Custom1'],true,true,'/.-&(),:+=_ ');
      CustomField2 := ValidCharsOnly(Request.ContentFields.Values['Custom2'],true,true,'/.-&(),:+=_ ');
      CustomField3 := ValidCharsOnly(Request.ContentFields.Values['Custom3'],true,true,'/.-&(),:+=_ ');
      CustomField4 := ValidCharsOnly(Request.ContentFields.Values['Custom4'],true,true,'/.-&(),:+=_ ');
      CustomField5 := ValidCharsOnly(Request.ContentFields.Values['Custom5'],true,true,'/.-&(),:+=_ ');
      CustomField6 := ValidCharsOnly(Request.ContentFields.Values['Custom6'],true,true,'/.-&(),:+=_ ');
      CustomField7 := ValidCharsOnly(Request.ContentFields.Values['Custom7'],true,true,'/.-&(),:+=_ ');
      CustomField8 := ValidCharsOnly(Request.ContentFields.Values['Custom8'],true,true,'/.-&(),:+=_ ');
      CustomField9 := ValidCharsOnly(Request.ContentFields.Values['Custom9'],true,true,'/.-&(),:+=_ ');
      CustomField10 := ValidCharsOnly(Request.ContentFields.Values['Custom10'],true,true,'/.-&(),:+=_ ');
      if Length(CustomField1) > 200 then CustomField1 := Copy(CustomField1,0,200);
      if Length(CustomField2) > 200 then CustomField2 := Copy(CustomField2,0,200);
      if Length(CustomField3) > 200 then CustomField3 := Copy(CustomField3,0,200);
      if Length(CustomField4) > 200 then CustomField4 := Copy(CustomField4,0,200);
      if Length(CustomField5) > 200 then CustomField5 := Copy(CustomField5,0,200);
      if Length(CustomField6) > 200 then CustomField6 := Copy(CustomField6,0,200);
      if Length(CustomField7) > 200 then CustomField7 := Copy(CustomField7,0,200);
      if Length(CustomField8) > 200 then CustomField8 := Copy(CustomField8,0,200);

      RNQuery.FieldByName('Custom1').AsString := CustomField1;
      RNQuery.FieldByName('Custom2').AsString := CustomField2;
      RNQuery.FieldByName('Custom3').AsString := CustomField3;
      RNQuery.FieldByName('Custom4').AsString := CustomField4;
      RNQuery.FieldByName('Custom5').AsString := CustomField5;
      RNQuery.FieldByName('Custom6').AsString := CustomField6;
      RNQuery.FieldByName('Custom7').AsString := CustomField7;
      RNQuery.FieldByName('Custom8').AsString := CustomField8;
      RNQuery.FieldByName('Custom9').AsString := CustomField9;
      RNQuery.FieldByName('Custom10').AsString := CustomField10;
   end;

   if((StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/DISPLAYBALANCEDUE','FALSE'))) AND  (Trim(Request.ContentFields.Values['balanceType']) = 'balanceDue')) then begin // 2019-2-13 ss DVST-3842 balanceType - name of radio button
      RNQuery.FieldByName('Custom4').AsString := 'balanceDue';
      RNQuery.FieldByName('PaymentAmount').AsCurrency := 0;
      RNQuery.FieldByName('GrossAmount').AsCurrency := 0;
   end;

   RNQuery.Post;
   RNQuery.Close;

end;

Function TCustomerInfoModule.ExternalWebSvc(Input : TStringList; Output : TStringList; URL :String; Action : String;SoapAction : string) : integer;
var
   OutStr : String;
   SOAP : TclSoapMessage;
   HTTP : TclHttp;
   InputText : string;
   ExUserName: string;
   ExPW : string;
   Proxy : string;
begin
try
   Result := -1;
   If Input <> NIL then
      InputText := Input.Text;

   ProcessLog(ltInfo,'Starting External Web Service: ' + Action + ' TO URL:' + URL, InputText);

   HTTP := TclHTTP.Create(Nil);
   SOAP := TCLSoapMessage.Create(nil);
   HTTP.Request := SOAP;
   HTTP.AllowCaching := False;
   HTTP.KeepConnection := False;

   If OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION') <> '' then begin
      ExUserName := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/WEBAPIUN');
      ExPW := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/WEBAPIPW');
      if OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/WEBAPIUSEAUTH') = 'TRUE' then begin
         HTTP.UserName := ExUserName;
         HTTP.Password := FromUTF(ExPW);
         HTTP.AuthenticationType := atBasic;
         ProcessLog(ltinfo,'ExternalWebSvc Using External Auth: ',' Username: ' + ExUserName);
      end;
      if OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/WEBAPICONTENTTYPE') <> '' then begin
         SOAP.Header.ContentType := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/WEBAPICONTENTTYPE');
      end else begin
         SOAP.Header.ContentType := 'text/xml; charset=utf-8';
      end;
   end;

   Http.ProxySettings.Server := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/PROXYSERVER', 'PORTALPROXY.TEMPUS.LOCAL');
   Http.ProxySettings.Port := StrToInt(OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/PROXYPORT', '8080'));
   Http.ProxySettings.UserName := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/PROXYUN', '');
   Http.ProxySettings.Password := FromUTF(OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/PROXYPW', ''));
   ProcessLog(ltinfo,'ExternalWebSvc Using Proxy: ' + Http.ProxySettings.Server, ' Port: ' + IntToStr(Http.ProxySettings.Port));


   HTTP.TimeOut := 30 * 1000;
   if SoapAction = '' then begin
      SoapAction := '""';
   end;
   PL.StartTimer;
   Try
     Application.ProcessMessages;
     HTTP.Close;

     If action = 'POST' then begin
        If Input <> NIL then
           Soap.BuildSoapMessage(Input.Text, SoapAction);
        Http.Post(URL, Output);
     end else begin
        HTTP.Get(URL,Output);
     end;

     PL.StopTimer;
     PL.AddMessageValue('RESOURCE',URL);
     PL.AddMessageValue('HTTPSTATUS',Stri(HTTP.StatusCode,-1));
     PL.SetLogIdentGUID('95914DB9-3D5C-4358-A364-7D5BBE4449B0');
     ProcessLog(ltInfo,'External Web Service Request Complete, status: ' + Stri(HTTP.StatusCode,-1),'');

   except
      On E:EclHttpError do begin
         PL.StopTimer;
         ProcessLog(0,ltwarning,'Exception on External Web Service: ' + E.Message + ' TO URL:' + URL,InstanceGUID,'',0,'');
         Output.Text := e.ResponseText;
      end;
   end;
 except
   on E:Exception do begin
      ProcessLog(0,ltwarning,'External Web Service Exception: ' + E.Message + ' TO URL:' + URL,InstanceGUID,'',0,'');
      ProcessLog(ltDebug, 'External Web Service Exception statuscode', IntToStr(http.StatusCode));
   end;
 end;
   Result := http.StatusCode;
   SOAP.Free;
   HTTP.Free;
end;

Function TCustomerInfoModule.SendPaymentInvite(SessionID : String; Email : String; EmailTemplate : String; DestinationURL : String; FileName : String; ClientURL : string) : String;
const
   METHOD_NAME = 'TCustomerInfoModule.SendPaymentInvite(...)'; //2019-5-15 SS DVST-4670: Keeping it, can be used later
var
    HTMLEmail : String;
    LinkURL : String;
    Attachments : TStrings;
    Images : TStrings;
begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN'); //2019-5-15 SS DVST-4670: keeping the begin and end, helps with the log
   try
      Attachments := TStringList.Create;
      Images := TStringList.Create;

      if DestinationURL <> '' then
         LinkURL := DestinationURL + '&SESSIONID=' + SessionID
      else
         LinkURL := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/PAYMENTINVITEURL') + '&SESSIONID=' + SessionID;

      if (ClientURL <> '') then begin  //2017-12-20 jtm: F#2235
         LinkURL := ClientURL + LoadWebFileFromFolder('PaymentInviteParams.htm','DEFAULTTEMPLATE');
         EmailTemplate := Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/CLIENTURLALTEMAILTEMPLATE',''));//2019-5-15 SS DVST-4670
      end;

      if EmailTemplate <> '' then
         HTMLEmail := LoadWebFileFromFolder(EmailTemplate,'')
      else
         HTMLEmail := LoadWebFileFromFolder('PaymentInvite.htm','');

      if HTMLEmail = '' then LoadWebFileFromFolder('PaymentInvite.htm','DEFAULTTEMPLATE');

      if FileName <> '' then
         Attachments.Add(FileName);

      ReplaceString(HTMLEmail, '%LINKURL%', LinkURL);
      ProcessLog(ltInfo, 'SendEmail: FileName', FileName);
      clMail.BuildMessage('',HTMLEmail,Images,Attachments);

      clMail.From.FullAddress := '"' + DomainFriendlyName+'"<'+DomainSendAsEmail+'>';

      clMail.ToList.EmailAddresses := Email;
      ProcessLog(ltInfo, 'SendEmail: Email', Email);
      ProcessLog(ltInfo, 'SendEmail: BCCEmails',  OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/CONFIRMATIONBCC',''));
      clMail.BCCList.EmailAddresses := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/CONFIRMATIONBCC','');
      If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/EMAILSUBJECT') <> '' then
         clMail.Subject := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/EMAILSUBJECT')
      else
         clMail.Subject := 'Payment Request from '  + DomainFriendlyName;

      If ((OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/REPLYTOEMPLOYEE','FALSE') = 'TRUE') and (SessionVarEval.GetValueAsString('EmployeeEmail') <> '')) then begin
         clMail.ReplyTo := SessionVarEval.GetValueAsString('EmployeeEmail');
      end else begin
      clMail.ReplyTo := GetConfigString('CONFIRMATIONREPLYTO','');
      end;

      SMTP.Open();
      try
         SMTP.Send(clMail);
      finally
         SMTP.Close();
      end;
      Images.Free;
      Attachments.Free;
      if FileName <> '' then
         DeleteFiles(FileName);
      Result := 'TRUE';
   except
      On E:Exception do begin
         Result := 'FALSE';
         ProcessLog(ltWarning,'Exception on SendEmail', E.Message);
      end;
   end;
   ProcessLog(ltInfo, METHOD_NAME, 'END'); //2019-5-15 SS DVST-4670
end;


Function TCustomerInfoModule.PracticeVelocityGetPatientInfo(ClinicRNID : String; DOB : TDateTime; LastName : String;PatientAccount : String; URL : String;ResultXML : TStringList) : Boolean;
var
   PVRequest : TStringList;
   HTTPStatus : Integer;
   RequestFN : String;
begin
   result := false;
   PVRequest := TStringList.Create;
   SessionVarEval.AddValue('PVPatientDOB', FormatDateTime('YYYY-MM-DD',DOB) +'T00:00:00');
   SessionVarEval.AddValue('PVPatientLastName', LastName);
   SessionVarEval.AddValue('PVPatientAccount',  PatientAccount);
   SessionVarEval.AddValue('PVPatientPractice', GetPVPracticeID(ClinicRNID));

   RequestFN := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/PRACTICEVELOCITY/BILLINGFILE', 'BillingInformation.xml');
   PVRequest.Add(LoadWebFileFromFolder(RequestFN, 'PV'));
   ProcessLog(ltInfo,'PV Get Patient Info' ,PVRequest.Text);

   HTTPStatus := ExternalWebSvc(PVRequest,ResultXML,URL,'POST','');
   Result :=  HTTPStatus = 200;
   If HTTPStatus = 200 then begin
      VarEvaluator.AddValue('ExternalCustIdent', GetXMLTag(ResultXML,'PatientID'));
      SessionVarEval.AddValue('PVGetPatientInfoResp', ResultXML.Text);
      SessionVarEval.AddValue('PVPatientID', GetXMLTag(ResultXML,'PatientID'));
      SessionVarEval.AddValue('PVBalance', GetXMLTag(ResultXML,'Balance'));
      if GetXMLTag(ResultXML,'PatientPractice') <> '' then SessionVarEval.AddValue('PVPatientPractice', GetXMLTag(ResultXML,'PatientPractice'));

   end;

end;


Function TCustomerInfoModule.GetPVPracticeID(RNID : String) : String;
Begin
   Result := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/PRACTICEVELOCITY/PRACTICEID');
   If OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/PRACTICEVELOCITY/PRACTICEIDOVERRIDES/PRACTICEID[@RNID=''' + RNID + ''']') <> '' then
      Result := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/PRACTICEVELOCITY/PRACTICEIDOVERRIDES/PRACTICEID[@RNID=''' + RNID + ''']');
end;

Function TCustomerInfoModule.GetPVPracticeRNID(PracticeID : String) : String;
Begin
   Result := '';
   ProcessLog(ltInfo,'GetPVPracticeRNID check for override:' + PracticeID ,InstanceGUID);
   If OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/PRACTICEVELOCITY/PRACTICEIDOVERRIDES/PRACTICERNID[@ID=''' + PracticeID + ''']') <> '' then begin
      ProcessLog(ltInfo,'GetPVPracticeRNID override' + PracticeID ,InstanceGUID);
      Result := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/PRACTICEVELOCITY/PRACTICEIDOVERRIDES/PRACTICERNID[@ID=''' + PracticeID + ''']');
   end;
end;


Function TCustomerInfoModule.GetHJSchoolsByRepID(RepID : String) : String;
var
   HTTPStatus : Integer;
   URL : String;
   AppID : String;
   WSPassword :String;
   HJXML : TstringList;
begin
   HJXML := TStringList.create;
   Result := '';

   AppID := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/HERFFJONES/WEBAPIAPPID');
   WSPassword := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/HERFFJONES/WEBAPIPASSWORD');

   URL := 'https://'+OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/HERFFJONES/WEBAPIHOSTNAME')+'/corporate/CustomerService.cfc?method=getCustomersByRep&request=' +
             '<serviceRequest>' +
               '<auth><ApplicationID>'+AppID+'</ApplicationID><wsPassword>'+WSPassword+'</wsPassword></auth>'+
               '<request><repNumber>'+REPID+'</repNumber><customerTypes>'+OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/HERFFJONES/WEBAPICUSTOMERTYPES')+'</customerTypes><productTypes>301</productTypes><pad>0</pad></request>'+
             '</serviceRequest>';

   ProcessLog(ltInfo,'Get HJ Schools API=' + URL,InstanceGUID);

   HTTPStatus := ExternalWebSvc(nil,HJXML,URL,'GET','');
   result := HJXML.text;

   HJXML.Free;

end;
function TCustomerInfoModule.GetHJSchoolSelector(SelectedAR : String;IncludeAll : Boolean) : String;
var
   WS : String;
   elementNum : integer;
   selected : String;
Begin
   ws := '';
   ElementNum := 1;
   ws := WS + '<option value="">All Schools</option>';
   While ExternalXMLGetTag('/response/result/customers/Customer[' + Stri(ElementNum,-1) + ']/name') <> '' do begin
      Selected := '';
      If (SelectedAR <> '') and (ExternalXMLGetTag('/response/result/customers/Customer[' + Stri(ElementNum,-1) + ']/arNumbers') = SelectedAR) then
         Selected := ' selected';
      WS := WS + '<option value="'+ExternalXMLGetTag('/response/result/customers/Customer[' + Stri(ElementNum,-1) + ']/arNumbers')+'"'+selected+'>'+
      ExternalXMLGetTag('/response/result/customers/Customer[' + Stri(ElementNum,-1) + ']/arNumbers') + ':' +
      ExternalXMLGetTag('/response/result/customers/Customer[' + Stri(ElementNum,-1) + ']/name') + ', ' +
      ExternalXMLGetTag('/response/result/customers/Customer[' + Stri(ElementNum,-1) + ']/cityName') + ', ' +
      ExternalXMLGetTag('/response/result/customers/Customer[' + Stri(ElementNum,-1) + ']/stateAbbr') +'</option>';
      inc(ElementNum);
   end;
   Result := WS;
end;
function TCustomerInfoModule.GetHJSchoolName(SelectedAR : String) : String;
var
   WS : String;
   elementNum : integer;
   selected : String;
Begin
   ws := '<select name="AccountNumber" id="AccountNumber">';
   ElementNum := 1;
   While ExternalXMLGetTag('/response/result/customers/Customer[' + Stri(ElementNum,-1) + ']/name') <> '' do begin
      Selected := '';
      If (SelectedAR <> '') and (ExternalXMLGetTag('/response/result/customers/Customer[' + Stri(ElementNum,-1) + ']/arNumbers') = SelectedAR) then
         Selected := ' selected';
      WS := WS + '<option value="'+ExternalXMLGetTag('/response/result/customers/Customer[' + Stri(ElementNum,-1) + ']/arNumbers')+'"'+selected+'>'+
      ExternalXMLGetTag('/response/result/customers/Customer[' + Stri(ElementNum,-1) + ']/arNumbers') + ':' +
      ExternalXMLGetTag('/response/result/customers/Customer[' + Stri(ElementNum,-1) + ']/name') + ', ' +
      ExternalXMLGetTag('/response/result/customers/Customer[' + Stri(ElementNum,-1) + ']/cityName') + ', ' +
      ExternalXMLGetTag('/response/result/customers/Customer[' + Stri(ElementNum,-1) + ']/stateAbbr') +'</option>';
      inc(ElementNum);
   end;
   ws := ws + '</select>';
   Result := WS;
end;

Function TCustomerInfoModule.ValidateAddChildPost : Boolean;
Var
  PVValidateResult : TStringList;
Begin
   Result := True;
      ProcessLog(ltInfo,'Starting Generic Validate, External: ' + OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/EXTERNALINTEGRATIONTYPE'),InstanceGUID);

   If OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/EXTERNALINTEGRATIONTYPE') = 'PRACTICEVELOCITY' then begin
   ProcessLog(ltInfo,'Starting PV Validate',InstanceGUID);
      PVValidateResult := TStringList.Create;
      Result := PracticeVelocityGetPatientInfo(NumericOnly(Request.ContentFields.Values['Locations']),
                                               StrToDateTime(Request.ContentFields.Values['DOB']),
                                               Trim(Request.ContentFields.Values['ChildLast']),
                                               Request.ContentFields.Values['AccountNumber'],
                                               OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/PRACTICEVELOCITY/PVBILLINGINFOURL'),
                                               PVValidateResult);
   ProcessLog(ltInfo,'PV Validate Result ValidateAddChildPost' ,PVValidateResult.Text);

      PVValidateResult.Free;

   end;

end;
function TCustomerInfoModule.ProcessExternalPaymentPosts(PaymentRNID : String):string;
var
   EPRequest : TStringList;
   EPResult : TStringList;
   HTTPStatus : Integer;
   RequestFN : String;
   SubLog: String; //2015-09-08 jtm
   HTTP : TclHttp;
   ExUserName :String;
   ExPW :String;
   MyRequest : TclHttpRequest;
Begin
   EPRequest := TStringList.Create;
   EPResult := TStringList.Create;
   Result := '';
   If OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/EXTERNALINTEGRATIONTYPE') = 'PRACTICEVELOCITY' then begin
      SubLog := '';
      if SessionVarEval.GetValueAsString('PVPatientPractice') <> '' then begin
         sublog := Sublog + 'PVPatientPractice,';
      end;
      if VarEvaluator.GetValueAsString('CustChild.AccountNumber') <> '' then begin
         sublog := Sublog + 'AccountNumber,';
      end;
      if VarEvaluator.GetValueAsString('APPROVALCODE') <> '' then begin
         sublog := Sublog + 'APPROVALCODE,';
      end;
      if VarEvaluator.GetValueAsString('CustChild.ExternalCustIdent') <> '' then begin
         sublog := Sublog + 'ExternalCustIdent,';
      end;
      if VarEvaluator.GetValueAsString('PaymentAmount') <> '' then begin
         sublog := Sublog + 'PaymentAmount,';
      end;

      ProcessLog(ltInfo,'Starting PV PaymentPost',InstanceGUID);
      if SessionVarEval.GetValueAsString('PVPatientPractice') = '' then begin //2015-09-08 jtm
         SessionVarEval.AddValue('PVPatientPractice', GetPVPracticeID(PaymentRNID));
         ProcessLog(ltInfo,'PVPatientPractice empty. Get Practice ID from webconfig XML: ' + SessionVarEval.GetValueAsString('PVPatientPractice'),InstanceGUID);
      end;
      RequestFN := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/PRACTICEVELOCITY/ACCOUNTFILE', 'AccountPayment.xml');
      EPRequest.Add(LoadWebFileFromFolder(RequestFN, 'PV'));

      HTTPStatus := ExternalWebSvc(EPRequest,EPResult,OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/PRACTICEVELOCITY/PVACCOUNTPAYMENTURL'),'POST','');
      ProcessLog(ltInfo,'PV Post Payment Complete',InstanceGUID);
      ProcessLog(ltInfo,'PV Post SubLog=' + SubLog,InstanceGUID);
      Result := EPResult.Text;
   end else if OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/EXTERNALINTEGRATIONTYPE') = 'CUSTOM' then begin
      RequestFN := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/WEBAPIFILE', 'ExternalAPI.xml');
      EPRequest.Add(LoadWebFileFromFolder(RequestFN, ''));
      if (OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/USESOAP','FALSE')='TRUE') then begin
         HTTPStatus := ExternalWebSvc(EPRequest,EPResult,OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/WEBAPIURL'),'POST','');
      end else begin //2017-10-09 jtm: F#2265
         HTTPStatus := ExternalWebSvcEx(EPRequest,EPResult,OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/WEBAPIURL'),'POST','','');
      end;
      Result := EPResult.Text;
   end;

   EPRequest.Free;
   EPResult.Free;
end;


procedure TCustomerInfoModule.CustomerInfoModulePPAPIAction(
  Sender: TObject; Request: TWebRequest; Response: TWebResponse;
  var Handled: Boolean);
var
   APIRNID : String;
   TranSuccess : Boolean;
   TranMessage : String;
   XMLResp : TStringList;
   APITime : TDateTime;
   APIXML : TOpenXML;
   CustGUID : String;
   ChildGUID : String;
   ClientTxnGUID : String;
   TransactionType : String;
   PaymentsSchedGUID : String;
   Frequency : String;
   WS :String;
   RequestStream: TStringStream;
   RequestString: String;
   CustUpdated : boolean;
   PaymentGUID : String;
   LocationRNID : String;
   RefererURL : string;
   ConfigStr : string;
   Procedure FinalizeXMLRespAndFree;
   Begin
      XMLResp.Add(' <SERVERDATE>'+FormatDateTime('MM/DD/YYYY', APITime)+'</SERVERDATE>');
      XMLResp.Add(' <SERVERTIME>'+FormatDateTime('HH:NN:SS', APITime)+'</SERVERTIME>');
      XMLResp.Add(' <TRANRESPMESSAGE>'+TranMessage+'</TRANRESPMESSAGE>');
      XMLResp.Add(' <PROFILE>'+APIRNID+'</PROFILE>');
      If TranSuccess then
         XMLResp.Add(' <TRANSUCCESS>TRUE</TRANSUCCESS>')
      else
         XMLResp.Add(' <TRANSUCCESS>FALSE</TRANSUCCESS>');
      XMLResp.Add('</TRANRESP>');
      ProcessLog(ltInfo,'PPAPI FinalizeXMLRespAndFree TranMessage',TranMessage);
      Response.Content := XMLResp.Text;
      XMLResp.Free;
      If APIXML<> NIL  then APIXML.Free;
   end;

   Function ValidateCustGUID(ACustGUID : String) : Boolean;
   Begin
      Result := False;
      ACustGUID := GuidOnly(ACustGUID);
      IF Trim(ACustGUID) = '' then begin
         TranMessage := 'CUSTGUID EXPECTED';
         TranSuccess := False;
         exit;
      end;

      If NOT OpenCustomerQueryGUID('',ACustGUID) then begin //passing no RNID so that it looks in the whole chain
         TranMessage := 'INVALID CUSTGUID';
         TranSuccess := False;
         exit;

      end;
      VarEvaluator.AddDSCurrentRecord(RNQuery, 'Customers');
      Result := True;
   end;
   Function ValidatePaymentSchedGUID(PaymentSchedGUID : String) : Boolean;
   Begin
      Result := False;
      PaymentSchedGUID := GuidOnly(PaymentSchedGUID);
      IF Trim(PaymentSchedGUID) = '' then begin
         TranMessage := 'PAYMENTSCHEDGUID EXPECTED';
         exit;
      end;

      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from custPaySched where (siteRNID = ' + APIRNID + ')');
      RNQuery.SQL.Add('and (PaySchedGuid = ''' + PaymentSchedGUID + ''')');
      RNQuery.Open;
      If RNQuery.RecordCount = 1 then begin
         VarEvaluator.AddDSCurrentRecord(RNQuery, 'CustPaySched');
         Result := True;
      end else begin
         TranMessage := 'INVALID PAYMENTSCHEDGUID';
      end;

   end;
   Function ValidateChildGUID(ChildGUID : String) : Boolean;
   Begin
      Result := False;
      ChildGUID := GuidOnly(ChildGUID);
      IF Trim(ChildGUID) = '' then begin
         TranMessage := 'CHILDGUID EXPECTED';
         exit;
      end;

      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from CustChild where (ChildGUID = ''' + ChildGUID + ''')');
      RNQuery.Open;
      If RNQuery.RecordCount = 1 then begin
         ChildGUID := Trim(RNQuery.FieldByName('ChildGUID').AsString);
         VarEvaluator.AddDSCurrentRecord(RNQuery, 'CustChild');
         Result := True;
      end else begin
         TranMessage := 'INVALID CHILDGUID';
      end;

   end;

   Function ValidatePaymentGUID(PaymentGUID : String) : Boolean;
   Begin
      Result := False;
      PaymentGUID := GuidOnly(PaymentGUID);
      IF Trim(PaymentGUID) = '' then begin
         TranMessage := 'PAYMENTGUID EXPECTED';
         exit;
      end;

      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from CustPayment where (PaymentGUID = ''' + PaymentGUID + ''')');
      RNQuery.Open;
      If RNQuery.RecordCount = 1 then begin
         CustGUID := Trim(RNQuery.FieldByName('CustGUID').AsString);
         VarEvaluator.AddDSCurrentRecord(RNQuery, 'CustPayment');
         Result := True;
      end else begin
         TranMessage := 'INVALID PAYMENTGUID';
      end;

   end;

   Procedure CustPaymentDSToXML(ADS : TDataSet);
   var
      paymentType : string;
   Begin
      paymentType := Trim(ADS.FieldByName('PAYMENTTYPE').AsString);

      XMLResp.Add('   <CUSTPAYMENT>');
      XMLResp.Add('    <PAYMENTGUID>' + Trim(ADS.FieldByName('PaymentGUID').AsString) + '</PAYMENTGUID>');
      XMLResp.Add('    <REPTOKEN>' + Trim(ADS.FieldByName('PaymentToken').AsString) + '</REPTOKEN>');
      XMLResp.Add('    <PAYMENTNAME>' + Trim(ADS.FieldByName('PaymentName').AsString) + '</PAYMENTNAME>');
      XMLResp.Add('    <PAYMENTTYPE>' + Trim(ADS.FieldByName('PAYMENTTYPE').AsString) + '</PAYMENTTYPE>');
      If paymentType = 'CARD' then begin
         XMLResp.Add('    <CCACCOUNT>' + Trim(ADS.FieldByName('CardAccount').AsString) + '</CCACCOUNT>');
         XMLResp.Add('    <CCEXP>' + FormatDateTime('MM/YY',ADS.FieldByName('CardExpires').AsDateTime) + '</CCEXP>');
         XMLResp.Add('    <CARDNAME>' + Trim(ADS.FieldByName('CardACcountHolder').AsString) + '</CARDNAME>');
         XMLResp.Add('    <CCBILLCITY>' + Trim(ADS.FieldByName('PaymentCity').AsString) + '</CCBILLCITY>');
         XMLResp.Add('    <CCBILLSTATE>' + Trim(ADS.FieldByName('PaymentState').AsString) + '</CCBILLSTATE>');
         XMLResp.Add('    <CCBILLZIP>' + Trim(ADS.FieldByName('PaymentZip').AsString) + '</CCBILLZIP>');
         XMLResp.Add('    <CCBILLADDRESS>' + Trim(ADS.FieldByName('PAYMENTADDRESS').AsString) + '</CCBILLADDRESS>');
      end else if paymentType = 'CHECK' then begin
         XMLResp.Add('    <TCACCOUNT>' + Trim(ADS.FieldByName('CHECKACCOUNT').AsString) + '</TCACCOUNT>');
         XMLResp.Add('    <TCROUTING>' + Trim(ADS.FieldByName('CHECKROUTING').AsString) + '</TCROUTING>');
         XMLResp.Add('    <TCLICENSENUM>' + Trim(ADS.FieldByName('LICENSENUM').AsString) + '</TCLICENSENUM>');
         XMLResp.Add('    <TCLICENSESTATE>' + Trim(ADS.FieldByName('LICENSESTATE').AsString) + '</TCLICENSESTATE>');
         XMLResp.Add('    <TCBILLADDRESS>' + Trim(ADS.FieldByName('PAYMENTADDRESS').AsString) + '</TCBILLADDRESS>');
         XMLResp.Add('    <TCBILLCITY>' + Trim(ADS.FieldByName('PAYMENTCITY').AsString) + '</TCBILLCITY>');
         XMLResp.Add('    <TCBILLSTATE>' + Trim(ADS.FieldByName('PAYMENTSTATE').AsString) + '</TCBILLSTATE>');
         XMLResp.Add('    <TCBILLZIP>' + Trim(ADS.FieldByName('PAYMENTZIP').AsString) + '</TCBILLZIP>');
      end;
      XMLResp.Add('   </CUSTPAYMENT>');
   end;
   Procedure CustPaymentSchedDSToXML(ADS : TDataSet);
   Begin
      XMLResp.Add('   <PAYSCHED>');
      XMLResp.Add('    <STATUS>'+Trim(ADS.FieldByName('STATUS').AsString)+'</STATUS>');
      XMLResp.Add('    <DATEADDED>'+FormatDateTime('MM/DD/YYYY',ADS.FieldByName('ScheduleAdded').AsDateTime)+'</DATEADDED>');
      XMLResp.Add('    <FIRSTPAYMENT>'+FormatDateTime('MM/DD/YYYY',ADS.FieldByName('FirstPayment').AsDateTime)+'</FIRSTPAYMENT>');
      XMLResp.Add('    <NEXTPAYMENT>'+FormatDateTime('MM/DD/YYYY',ADS.FieldByName('NextPayment').AsDateTime)+'</NEXTPAYMENT>');
      XMLResp.Add('    <PAYMENTSCHEDGUID>'+Trim(ADS.FieldByName('PaySchedGUID').AsString)+'</PAYMENTSCHEDGUID>');
      XMLResp.Add('    <PAYMENTGUID>'+Trim(ADS.FieldByName('PAYMENTGUID').AsString)+'</PAYMENTGUID>');
      XMLResp.Add('    <CUSTGUID>'+Trim(ADS.FieldByName('CUSTGUID').AsString)+'</CUSTGUID>');

      XMLResp.Add('    <PAYMENTSMADE>'+ADS.FieldByName('PaymentsMade').AsString+'</PAYMENTSMADE>');
      XMLResp.Add('    <PAYMENTAMOUNT>'+Trim(StriReal(ADS.FieldByName('PaymentAmount').AsCurrency,2))+'</PAYMENTAMOUNT>');
      XMLResp.Add('    <GROSSAMOUNT>'+Trim(StriReal(ADS.FieldByName('GROSSAMOUNT').AsCurrency,2))+'</GROSSAMOUNT>');
      XMLResp.Add('    <AMOUNTPAID>'+Trim(StriReal(ADS.FieldByName('AMOUNTPAID').AsCurrency,2))+'</AMOUNTPAID>');
      XMLResp.Add('    <PAYMENTFAILURECOUNT>'+ADS.FieldByName('FailedPaymentCount').AsString+'</PAYMENTFAILURECOUNT>');
      XMLResp.Add('    <PAYMENTFREQUENCY>'+Trim(UpCaseString(ADS.FieldByName('Frequency').AsString))+'</PAYMENTFREQUENCY>');
      XMLResp.Add('   </PAYSCHED>');
   end;
   Procedure PaymentHistoryDetailDSToXML(ADS : TDataSet);
   Begin
      XMLResp.Add('   <PAYMENTHISTORYDETAIL>');
      XMLResp.Add('    <CUSTGUID>'+Trim(ADS.FieldByName('CUSTGUID').AsString)+'</CUSTGUID>');
      XMLResp.Add('    <PAYMENTSCHEDGUID>'+Trim(ADS.FieldByName('PaySchedGUID').AsString)+'</PAYMENTSCHEDGUID>');
      XMLResp.Add('    <PAYHISTGUID>'+Trim(ADS.FieldByName('PAYHISTGUID').AsString)+'</PAYHISTGUID>');
      XMLResp.Add('    <PAYMENTGUID>'+Trim(ADS.FieldByName('PAYMENTGUID').AsString)+'</PAYMENTGUID>');
      XMLResp.Add('    <PAYMENTDATE>'+FormatDateTime('MM/DD/YYYY', ADS.FieldByName('PaymentDate').AsDateTime)+'</PAYMENTDATE>');
      XMLResp.Add('    <PAYMENTTIME>'+FormatDateTime('HH:NN:SS', ADS.FieldByName('PaymentDate').AsDateTime)+'</PAYMENTTIME>');
      XMLResp.Add('    <GWSYSTEMCODE>'+ADS.FieldByName('GWSystemCode').AsString+'</GWSYSTEMCODE>');
      XMLResp.Add('    <NONAUTHREASON>'+Trim(ADS.FieldByName('NONAUTHREASON').AsString)+'</NONAUTHREASON>');
      XMLResp.Add('    <APPROVALCODE>'+Trim(ADS.FieldByName('APPROVALCODE').AsString)+'</APPROVALCODE>');
      XMLResp.Add('    <LOCATIONRNID>'+ADS.FieldByName('RNID').AsString+'</LOCATIONRNID>');
      XMLResp.Add('    <PAYMENTAMOUNT>'+Trim(StriReal(ADS.FieldByName('PaymentAmount').AsFloat,2))+'</PAYMENTAMOUNT>');

      If (Trim(ADS.FieldByName('APPROVALCODE').AsString) <> '')  then
         XMLResp.Add('    <PAYMENTAPPROVED>TRUE</PAYMENTAPPROVED>')
      else
         XMLResp.Add('    <PAYMENTAPPROVED>FALSE</PAYMENTAPPROVED>');
      XMLResp.Add('   </PAYMENTHISTORYDETAIL>');

   end;

   Procedure CustChildDSToXML(ADS : TDataSet);
   Begin
      XMLResp.Add('   <CUSTCHILD>');
      XMLResp.Add('    <CUSTGUID>'+Trim(ADS.FieldByName('CUSTGUID').AsString)+'</CUSTGUID>');
      XMLResp.Add('    <CHILDGUID>'+Trim(ADS.FieldByName('CHILDGUID').AsString)+'</CHILDGUID>');
      XMLResp.Add('    <LOCATIONRNID>'+Trim(ADS.FieldByName('RNID').AsString)+'</LOCATIONRNID>');
      XMLResp.Add('    <CHILDFIRSTNAME>'+Trim(ADS.FieldByName('FirstName').AsString)+'</CHILDFIRSTNAME>');
      XMLResp.Add('    <CHILDLASTNAME>'+Trim(ADS.FieldByName('LastName').AsString)+'</CHILDLASTNAME>');
      if ADS.FieldByName('DOB').AsDateTime > 0 then
         XMLResp.Add('    <CHILDDOB>'+FormatDateTime('MM/DD/YYYY',ADS.FieldByName('DOB').AsDateTime) +'</CHILDDOB>');
      XMLResp.Add('    <ACCOUNTNUMBER>'+Trim(ADS.FieldByName('ACCOUNTNUMBER').AsString)+'</ACCOUNTNUMBER>');
      XMLResp.Add('    <EXTERNALCUSTIDENT>'+Trim(ADS.FieldByName('EXTERNALCUSTIDENT').AsString)+'</EXTERNALCUSTIDENT>');
      XMLResp.Add('   </CUSTCHILD>');
   end;

   Procedure PPGetCustPaymentMethods;
   var
      transactionCustGuid : string;
   Begin
      XMLResp.Add(' <RESPTYPE>'+TransactionType + 'RESP</RESPTYPE>');

      transactionCustGuid := GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/CUSTGUID'));
      if (transactionCustGuid <> '') then begin
         CustGUID := transactionCustGuid;
      end;

      If Not ValidateCustGUID(CustGUID) then exit;

      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from CustPayment where (CustGUID = ''' + CustGUID + ''') and (Hidden = 0)');

      if strtobool(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/ORDERBYDATEADDED', 'FALSE')) then begin
         RNQuery.SQL.Add(' ORDER BY DATEADDED DESC');
      end;

      RNQuery.Open;
      XMLResp.Add('  <CUSTPAYMENTS>');
      While Not RNQuery.EOF do begin
         CustPaymentDSToXML(RNQuery);
         RNQuery.Next;
      end;
      TranSuccess := True;
      XMLResp.Add('  </CUSTPAYMENTS>');
   end;
   Procedure PPCustCancelSchedule;
   Begin
      XMLResp.Add(' <RESPTYPE>'+TransactionType + 'RESP'+'</RESPTYPE>');
      PaymentsSchedGUID := GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/PAYMENTSCHEDGUID'));
      If NOT ValidatePaymentSchedGUID(PaymentsSchedGUID) then exit;
      Try
         RNQuery.Edit;
         RNQuery.FieldByName('Status').AsString := 'CANCELLED';
         RNQuery.Post;
         CustPaymentSchedDSToXML(RNQUERY);
         TranSuccess := True;
         TranMessage := 'PAYMENT SCHEDULE CANCELLED';
      except
         On E:Exception do begin
            TranMessage := 'EXCEPTION CANCELLING PAYMENT SCHEDULE';
         end;
      end;


   end;
   Procedure PPDeletePaymentMethod;
   var
      transactionCustGuid: string;
   Begin
      XMLResp.Add('<RESPTYPE>'+TransactionType + 'RESP</RESPTYPE>');
      PaymentGUID := GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/PAYMENTGUID'));
      If NOT ValidatePaymentGUID(PaymentGUID) then exit;
      Try
         CustPaymentDSToXML(RNQuery);

         TranSuccess := False;
         TranMessage := 'UNABLE TO DELETE PAYMENT';
         if DeletePaymentMethod(CustGUID, APIRNID, APIXML) then begin
            TranSuccess := True;
            TranMessage := 'PAYMENT DELETED';
         end;
      except
         On E:Exception do begin
            TranMessage := 'EXCEPTION DELETING PAYMENT SCHEDULE';
         end;
      end;
   end;
   Procedure PPGetCustPaySched;
   Begin
      XMLResp.Add(' <RESPTYPE>'+TransactionType + 'RESP'+'</RESPTYPE>');
      CustGUID := GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/CUSTGUID'));
      If Not ValidateCustGUID(CustGUID) then exit;
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from CustPaySched where (CustGUID = '''+CustGUID + ''') ');
      RNQuery.SQL.Add('and (SiteRNID = '+APIRNID+')');
      RNQuery.Open;
      XMLResp.Add('  <PAYSCHEDS>');
      While Not RNQuery.EOF do begin
         CustPaymentSchedDSToXML(RNQuery);
         RNQuery.Next;
      end;
      TranSuccess := True;
      XMLResp.Add('  </PAYSCHEDS>');
   end;
   Procedure PPGetCustPaySchedDetail;
   Begin
      XMLResp.Add(' <RESPTYPE>'+TransactionType + 'RESP'+'</RESPTYPE>');
      PaymentsSchedGUID := GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/PAYMENTSCHEDGUID'));
      If PaymentsSchedGuid = '' then begin
         TranMessage := 'PAYMENTSCHEDGUID REQUIRED';
         exit;
      end;
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from CustPaySched where (PaySchedGUID = '''+PaymentsSchedGUID + ''') ');
      RNQuery.SQL.Add('and (SiteRNID = '+APIRNID+')');
      RNQuery.Open;
      XMLResp.Add('  <PAYSCHEDS>');
      While Not RNQuery.EOF do begin
         CustPaymentSchedDSToXML(RNQuery);
         RNQuery.Next;
      end;
      TranSuccess := True;
      XMLResp.Add('  </PAYSCHEDS>');
   end;

   Procedure PPGetCustChildren;
   Begin
      XMLResp.Add(' <RESPTYPE>'+TransactionType + 'RESP'+'</RESPTYPE>');
      CustGUID := GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/CUSTGUID'));
      If Not ValidateCustGUID(CustGUID) then exit;
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from CustChild where (CustGUID = '''+CustGUID + ''') ');
      RNQuery.Open;
      XMLResp.Add('  <CUSTCHILDREN>');
      While Not RNQuery.EOF do begin
         CustChildDSToXML(RNQuery);
         RNQuery.Next;
      end;
      TranSuccess := True;
      XMLResp.Add('  </CUSTCHILDREN>');
   end;

   Procedure PPCustAddChild;
   var
      LastName, FirstName : string;
   Begin
      XMLResp.Add(' <RESPTYPE>'+TransactionType + 'RESP'+'</RESPTYPE>');
      CustGUID := GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/CUSTGUID'));
      If Not ValidateCustGUID(CustGUID) then exit;

      LocationRNID := NumericOnly(APIXML.GetValueAsWideString('/TRANSACTION/LOCATIONRNID'));
      If Trim(LocationRNID) = '' then LocationRNID := APIRNID;
      If not ValidateRNID(LocationRNID) then begin
         TranMessage := 'INVALID LOCATIONRNID';
         exit;
      end;
      VarEvaluator.AddDSCurrentRecord(RNQuery, 'STORE'); //Loaded from ValidateRNID

      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from CustChild where (CustGUID = '''+CustGUID + ''') ');
      RNQuery.Open;
      RNQuery.Insert;
      RNQuery.FieldByName('CustGUID').AsString := CustGUID;
      RNQuery.FieldByName('ChildGUID').AsString := GenerateGUID;
      RNQuery.FieldByName('RNID').AsString := LocationRNID;

      LastName := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/CHILDLASTNAME'),True,True,'-'' '); //2018-06-20 bls: F#4834
      FirstName := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/CHILDFIRSTNAME'),True,True,'-'' ');

      RNQuery.FieldByName('FirstName').AsString := FirstName;
      RNQuery.FieldByName('LastName').AsString := LastName; // 2018-06-20 bls: F#4834
      Try
         RNQuery.FieldByName('DOB').AsString := ValidcharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/DOB'),False, True, '/');
      except
         On E:Exception do begin
         end;
      end;
      RNQuery.FieldByName('DateAdded').AsDateTime := Now;
      RNQuery.FieldByName('Hidden').AsBoolean := False;
      RNQuery.FieldByName('AccountNumber').AsString := ValidcharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/ACCOUNTNUMBER'),True, True, ' -');
      RNQuery.FieldByName('ExternalCustIdent').AsString := ValidcharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/EXTERNALCUSTIDENT'),True, True, ' -');
      RNQuery.Post;
      CustChildDSToXML(RNQuery);
      TranSuccess := True;
      TranMessage := 'CHILD ADDED';
   end;

   Procedure PPCustAddPaymentCard;
   const
      METHOD_NAME = 'PPCustAddPaymentCard';
      IS_DISBURSABLE = 'ISDISBURSABLE';
   var
      transactionCustGuid, binDetailRNID, binDetailServiceName: string;
      CardDetails: TStringList;
   Begin
      XMLResp.Add(' <RESPTYPE>' + TransactionType + 'RESP</RESPTYPE>');

      transactionCustGuid := GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/CUSTGUID'));
      if (transactionCustGuid <> '') then begin
         CustGUID := transactionCustGuid;
      end;   

      If Not ValidateCustGUID(CustGUID) then exit;

      if APIXML.GetValueAsWideString('/TRANSACTION/REPTOKEN') = '' then begin
         if NOT strtobool(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/USEJSENCRYPTEWALLET', 'FALSE')) then begin
            If NOT IsValidCardNum(NumericOnly(APIXML.GetValueAsWideString('/TRANSACTION/CCACCOUNT'))) then begin
               TranMessage := 'INVALID CARD NUM';
               Exit;
            end;

            If ExpMMslashYYToDateTime(APIXML.GetValueAsWideString('/TRANSACTION/CCEXP')) < NOW then begin
               TranMessage := 'CARD EXPIRED';
               Exit;
            end;
         end;
      end;

      CardDetails := TStringList.Create;

      if AddCardToAccount(CustGUID, APIRNID, APIXML, CardDetails) then begin
         CustPaymentDSToXML(RNQuery);
         TranSuccess := True;
         TranMessage := 'CARD ADDED';
      end else begin
         TranMessage := 'CARD ADD FAILED';
      end;
      FreeAndNil(CardDetails);
   end;

   Procedure PPCustAddPaymentCheck;
   var
      transactionCustGuid : string;
   Begin

      XMLResp.Add(' <RESPTYPE>'+TransactionType + 'RESP</RESPTYPE>');

      transactionCustGuid := GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/CUSTGUID'));
      if (transactionCustGuid <> '') then begin
         CustGUID := transactionCustGuid;
      end;   

      If Not ValidateCustGUID(CustGUID) then exit;

      If NumericOnly(APIXML.GetValueAsWideString('/TRANSACTION/BANKROUTING')) = '' then begin
         TranMessage := 'ROUTING REQUIRED';
         Exit;
      end;

      If NumericOnly(APIXML.GetValueAsWideString('/TRANSACTION/BANKACCOUNTNUMBER')) = '' then begin
         TranMessage := 'ROUTING REQUIRED';
         Exit;
      end;

      If NOT IsValidRouting(NumericOnly(APIXML.GetValueAsWideString('/TRANSACTION/BANKROUTING'))) then begin
         TranMessage := 'INVALID ROUTING';
         Exit;
      end;

      AddCheckToAccount(CustGUID, APIRNID, APIXML);
      CustPaymentDSToXML(RNQuery);
      TranSuccess := True;
      TranMessage := 'CHECK ADDED';
   end;


   Procedure PPCUSTADDUPDATE;
   Begin
      CustUpdated := false;
      XMLResp.Add(' <RESPTYPE>'+TransactionType + 'RESP'+'</RESPTYPE>');
      CustGUID := GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/CUSTGUID'));
      If CustGUID <> '' then begin
         ProcessLog(ltinfo,'CustGuid Passed in. Validating:',Custguid);
         If Not ValidateCustGUID(CustGUID) then exit;
         ProcessLog(ltinfo,'CustGuid Valid:',Custguid);
         CustUpdated := true;
      end;
      LocationRNID := NumericOnly(APIXML.GetValueAsWideString('/TRANSACTION/LOCATIONRNID'));
      If (Trim(LocationRNID) <> '') and (not ValidateRNID(LocationRNID)) then begin
         TranMessage := 'INVALID LOCATIONRNID';
         exit;
      end;
      If LocationRNID = '' then LocationRNID := APIRNID;

      if not CustUpdated then ProcessLog(ltinfo,'Add new Customer for RNID:',LocationRNID);
      ProcessLog(ltinfo,'Add new Customer for RNID:',LocationRNID);
      CustGUID := AddCustomer(LocationRNID, CustGUID, APIXML); //Sets customersc, returns with cust guid

      XMLResp.Add(' <CUSTGUID>'+CustGUID+'</CUSTGUID>');

      TranSuccess := True;
      TranMessage := 'CUSTOMER ADDED';
      if CustUpdated then begin
         TranMessage := 'CUSTOMER UPDATED';
      end else begin
         TranMessage := 'CUSTOMER ADDED';
      end;  


   end;

   Procedure PPCUSTMAKEPAYMENT;
   Begin
      XMLResp.Add(' <RESPTYPE>'+TransactionType + 'RESP'+'</RESPTYPE>');
      CustGUID := GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/CUSTGUID'));
      If CustGUID <> '' then begin  //If they send us a custguid, it better be valid
         If Not ValidateCustGUID(CustGUID) then exit;
      end;

      ProcessPortalPayment(apirnid,CustGUID,APIXML);
      XMLResp.Add(' <CUSTGUID>'+CustGUID+'</CUSTGUID>');
      XMLResp.Add(' <PAYMENTRESPONSE>'+VarEvaluator.GetValueAsString('PR')+'</PAYMENTRESPONSE>');
      XMLResp.Add(' <GWSYSTEMCODE>'+VarEvaluator.GetValueAsString('GWSC')+'</GWSYSTEMCODE>');
      XMLResp.Add(' <APPROVALCODE>'+VarEvaluator.GetValueAsString('APPROVALCODE')+'</APPROVALCODE>');
      XMLResp.Add(' <PAYMENTTYPE>'+VarEvaluator.GetValueAsString('PAYMENTTYPE')+'</PAYMENTTYPE>');
      XMLResp.Add(' <NONAUTHREASON>'+VarEvaluator.GetValueAsString('NONAUTHREASON')+'</NONAUTHREASON>');
      XMLResp.Add(' <PAYMENTAMOUNT>'+VarEvaluator.GetValueAsString('PAYMENTAMOUNT')+'</PAYMENTAMOUNT>');
      XMLResp.Add(' <PAYMENTLOCATIONRNID>'+VarEvaluator.GetValueAsString('PAYMENTLOCATIONRNID')+'</PAYMENTLOCATIONRNID>');
      XMLResp.Add(' <PAYMENTGUID>'+VarEvaluator.GetValueAsString('PAYMENTGUID')+'</PAYMENTGUID>');
      XMLResp.Add(' <PAYMENTSCHEDGUID>'+VarEvaluator.GetValueAsString('PAYMENTSCHEDGUID')+'</PAYMENTSCHEDGUID>');

      TranSuccess := True;
      TranMessage := 'PAYMENT COMPLETE';

   end;
   Procedure PPGETPAYMENTHISTORY;
   var
     AQuery : TADOQuery;
     FromDate : TDateTime;
     ThruDate : TDateTime;
   Begin
      XMLResp.Add(' <RESPTYPE>'+TransactionType + 'RESP'+'</RESPTYPE>');
      CustGUID := GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/CUSTGUID'));
      If CustGUID <> '' then begin  //If they send us a custguid, it better be valid
         If Not ValidateCustGUID(CustGUID) then exit;
      end;
      FromDate := 0;
      ThruDate := 0;


      PaymentsSchedGUID := GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/PAYMENTSCHEDGUID'));
      If PaymentsSchedGUID <> '' then begin
         If NOT ValidatePaymentSchedGUID(PaymentsSchedGUID) then exit;
      end;

      If APIXML.GetValueAsWideString('/TRANSACTION/PAYMENTDATEFROM') <> '' then begin
         Try
            FromDate := StrToDate(APIXML.GetValueAsWideString('/TRANSACTION/PAYMENTDATEFROM'));
         except
            On E:Exception do begin
               TranMessage := 'INVALID PAYMENTDATEFROM';
               TranSuccess := False;
               exit;
            end;
         end;
      end;


      If APIXML.GetValueAsWideString('/TRANSACTION/PAYMENTDATETHRU') <> '' then begin
         Try
            ThruDate := StrToDate(APIXML.GetValueAsWideString('/TRANSACTION/PAYMENTDATETHRU'));
         except
            On E:Exception do begin
               TranMessage := 'INVALID PAYMENTDATETHRU';
               TranSuccess := False;
               exit;
            end;
         end;
      end;


      WS := '';
      If CustGUID <> '' then
         WS := WS + '   And (CustGUID =''' + CustGUID + ''')' + CRLF;
      If PaymentsSchedGUID <> '' then
         WS := WS + '   And (PaySchedGUID =''' + PaymentsSchedGUID + ''')' + CRLF;
      If FromDate <> 0 then
         WS := WS + '   And (PaymentDate >''' + FormatDateTime('MM/DD/YYYY',FromDate) + ''')' + CRLF;
      If ThruDate <> 0 then
         WS := WS + '   And (PaymentDate <''' + FormatDateTime('MM/DD/YYYY',ThruDate +1) + ''')' + CRLF;
      If Trim(UpCaseString(APIXML.GetValueAsWideString('/TRANSACTION/PAYMENTAPPROVED')))= 'TRUE' then
         WS := WS + '   And (ApprovalCode <> '''')' + CRLF;

      If WS = '' then begin
         TranMessage := 'INSUFFICIENT PARAMETERS';
         TranSuccess := False;
         exit;
      end;

      If Trim(UpCaseString(APIXML.GetValueAsWideString('/TRANSACTION/PAYMENTAPPROVED')))= 'TRUE' then
         WS := WS + '   And (ApprovalCode <> '''')' + CRLF;

      AQuery := NewAdoQuery;
      AQuery.SQL.Add('Select * from custpaymenthistory where SiteRNID = ' + APIRNID);
      AQuery.SQL.add(WS);
      AQuery.Open;
      XMLResp.Add(' <PAYMENTHISTORY>');
      While Not AQuery.EOF do begin
         PaymentHistoryDetailDSToXML(AQuery);
         AQuery.Next;
      end;
      XMLResp.Add(' </PAYMENTHISTORY>');
      TranSuccess := True;


   end;
   Procedure PPCustAddSchedule;
   var
      PayAmt : Currency;
      GrossAmt : Currency;
      NumberOfPayments : Integer;
   Begin

      XMLResp.Add(' <RESPTYPE>'+TransactionType + 'RESP'+'</RESPTYPE>');
      CustGUID := GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/CUSTGUID'));
      If Not ValidateCustGUID(CustGUID) then exit;

      ProcessLog(ltInfo,'Validate Payment GUID',InstanceGUID);

      PaymentGUID := GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/PAYMENTGUID'));
      If NOT ValidatePaymentGUID(PaymentGUID) Then exit;
      If CustGUID <> GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/CUSTGUID')) then begin
         TranMessage := 'INVALID PAYMENTGUID FOR CUSTGUID';
         exit;
      end;

      ProcessLog(ltInfo,'Location',InstanceGUID);

      LocationRNID := NumericOnly(APIXML.GetValueAsWideString('/TRANSACTION/LOCATIONRNID'));
      If Trim(LocationRNID) = '' then LocationRNID := APIRNID;
      If not ValidateRNID(LocationRNID) then begin
         TranMessage := 'INVALID LOCATIONRNID';
         exit;
      end;

      ProcessLog(ltInfo,'Child validate',InstanceGUID);


      ChildGUID := GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/CHILDGUID'));
      If ChildGUID <> '' then begin
         If NOT ValidateChildGUID(ChildGUID) Then exit;
         If CustGUID <> GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/CUSTGUID')) then begin
            TranMessage := 'INVALID CHILDGUID FOR CUSTGUID';
            exit;
         end;
      end;

      ProcessLog(ltInfo,'Opencustpaysched',InstanceGUID);


      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from CustPaySched where (CustGUID = '''+CustGUID + ''')');
      RNQuery.Open;
      RNQuery.Insert;
      RNQuery.FieldByName('SiteRNID').AsString := APIRNID;
      RNQuery.FieldByName('RNID').AsString := LocationRNID;
      RNQuery.FieldByName('CustGUID').AsString := CustGUID;
      RNQuery.FieldByName('ChildGUID').AsString := ChildGUID;

      RNQuery.FieldByName('PAYSCHEDGUID').AsString := GenerateGUID;
      RNQuery.FieldByName('PAYMENTGUID').AsString := PaymentGUID;
      Frequency := Trim(UpCaseString(APIXML.GetValueAsWideString('/TRANSACTION/PAYMENTFREQUENCY')));
      PayAmt := ValuReal(APIXML.GetValueAsWideString('/TRANSACTION/PAYMENTAMOUNT'));
      RNQuery.FieldByName('PaymentAmount').AsCurrency := PayAmt;
      GrossAmt := ValuReal(APIXML.GetValueAsWideString('/TRANSACTION/BALANCEDUE'));
      RNQuery.FieldByName('GrossAmount').AsCurrency := GrossAmt;




      RNQuery.FieldByName('Status').AsString := 'ACTIVE';
      RNQuery.FieldByName('ScheduleAdded').AsDateTime := Now;
      NumberOfPayments := Valu(APIXML.GetValueAsWideString('/TRANSACTION/NUMBEROFPAYMENTS'));
      RNQuery.FieldByName('NumberOfPayments').AsInteger :=NumberOfPayments;
      RNQuery.FieldByName('PaymentsRemaining').AsInteger :=NumberOfPayments;
      RNQuery.FieldByName('PaymentsMade').AsInteger := 0;

      RNQuery.FieldByName('FirstPayment').AsString := APIXML.GetValueAsWideString('/TRANSACTION/FIRSTPAYMENT');

      If (GrossAmt> 0) and (NumberOfPayments > 0)  then begin
         PayAmt := GrossAmt / NumberOfPayments * 100;
         If Frac(PayAmt) > 0 then PayAmt := Trunc(PayAmt + 1);
         PayAmt := PayAmt / 100;
         RNQuery.FieldByName('PaymentAmount').AsCurrency := PayAmt;
      end else if (NumberOfPayments > 0) and (PayAmt > 0) then begin
         GrossAmt := PayAmt * NumberOfPayments;
         RNQuery.FieldByName('GrossAmount').AsCurrency := GrossAmt;
      end;
      RNQuery.FieldByName('PaymentAmount').AsCurrency := PayAmt;


      If Frequency='MONTHLY' then begin
         RNQuery.FieldByName('Frequency').AsString := Frequency;
      end;
      If Frequency='BIMONTHLY' then begin
         RNQuery.FieldByName('Frequency').AsString := Frequency;
      end;
      If Frequency='WEEKLY' then begin
         RNQuery.FieldByName('Frequency').AsString := Frequency;
      end;
      If Frequency='BIWEEKLY' then begin //2017-09-25 jtm: F#2203
         RNQuery.FieldByName('Frequency').AsString := Frequency;
      end;
      If Frequency='QUARTERLY' then begin
         RNQuery.FieldByName('Frequency').AsString := Frequency;
      end;
      If Frequency='ANNUALLY' then begin
         RNQuery.FieldByName('Frequency').AsString := Frequency;
      end;
      RNQuery.FieldByName('NextPayment').AsDateTime := RNQuery.FieldByName('FirstPayment').AsDateTime;

      RNQuery.Post;
      CustPaymentSchedDSToXML(RNQuery);
      RNQuery.Close;

      TranSuccess := True;
      TranMessage := 'SCHEDULE ADDED';
   end;

   Procedure PPReportGetSchedules;
   var
      PPReportDS : TDataSet;
      SchedStatus : String;
      LastName :String;
      AccountNum : String;
      DisplayFormat : String;
   Begin

      XMLResp.Add(' <RESPTYPE>'+TransactionType + 'RESP'+'</RESPTYPE>');
      DisplayFormat := APIXML.GetValueAsWideString('/TRANSACTION/FORMAT');
      If DisplayFormat = '' then DisplayFormat := 'XML';
      CustGUID := GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/CUSTGUID'));
      LocationRNID := NumericOnly(APIXML.GetValueAsWideString('/TRANSACTION/LOCATIONRNID'));
      LastName := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/LASTNAME'),True,True, ' ');
      SchedStatus := APIXML.GetValueAsWideString('/TRANSACTION/STATUS');
      AccountNum := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/ACCOUNTNUMBER'),True,True,'');
      If SchedStatus <> 'ACTIVE' then
         SchedStatus := '';  //Only active for now

      If CustGUID <> '' then begin
         If Not ValidateCustGUID(CustGUID) then exit;
      end;
      PPReportDS := OpenScheduledPaymentReportQuery(APIRNID,
                                                    LocationRNID,
                                                    SchedStatus,
                                                    CustGUID,
                                                    LastName,
                                                    AccountNum);
      If PPReportDS.Active then begin

         TranSuccess := False;
         TranMessage := Stri(PPreportDS.RecordCount,-1) + ' RECORDS FOUND';

         HTMLResp.Add('<html xmlns="http://www.w3.org/1999/xhtml"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type" />');
         HTMLResp.Add(LoadWebFileFromFolder('Style.PortalGrid.CSS','DEFAULTSTYLE'));
         HTMLResp.Add('</head><body>');
         GenerateScheduledPaymentReport(PPReportDS, DisplayFormat,False,false);
         HTMLResp.Add('</body></html>');

         Response.Content := HTMLResp.Text;

         Response.ContentType := 'text/html';
         If APIXML.GetValueAsWideString('/TRANSACTION/EMAIL') <> '' then
            DeliverHTMLEmail(DomainFriendlyName + ' Scheduled Payments Report', APIXML.GetValueAsWideString('/TRANSACTION/EMAIL'));

         XMLResp.Free;
         If APIXML<> NIL  then APIXML.Free;

      end else begin
         TranSuccess := False;
         TranMessage := 'UNABLE TO OPEN QUERY';
         FinalizeXMLRespAndFree;
      end;

   end;
   Procedure CreateSession(ReturnList: TStringList);
   const
      METHOD_NAME = 'CreateSession()';
      ADD_REGISTRY_VALUE = 'INSERT INTO REGISTRY (CHAINCODE, STORECODE, KEYNAME, SUBKEY1, SUBKEY2, KEYVALUE, OPTIONS) ' +
         'VALUES (:ChainCode, :PPAPIRNID, ''MERCHANTSESSIONID'', :MerchantSessionID, ''SESSIONGUID'', :RNSessionID, :ExpDate) ';
      CREATE_SESSION = 'Insert Into WWWSession (RNSessionID, DateAdded, AccessCount, RemoteAddress, WWWDomain) ' +
         'values (:RNSessionID, :DateAdded, :AccessCount, :RemoteAddress, :WWWDomain)';
      GET_SESSION = 'Select * from WWWSession where RNSessionID = :RNSessionID';
   var
      PPAPIRNID, RNSessionID, TranIdent, CustIdent, OriginalTranIdent, OriginalCustIdent, ClientURL, OriginalReferURL, ReferURL, Email, AuthenticatedTill, SendEmail, AvsData,
         PhoneNumber, Base64File, UserData, BillingZip, IVRActionID, IVRActionCallType, IVRPin, IVRPhoneNoToCall, IVRActions, ReturnPhoneNumber, SessionType, Language,
         CCAuthType, FileLocation, FileName, POSTranIdentGUID, TicketIdent, ExpDateStr, MerchantSessionID, AuthTillDateIncType: string;

      RedirectToClientURL: boolean;
      AuthTillAmount: integer;
      ExpDate: TDateTime;
   begin
      XMLResp.Add(' <RESPTYPE>' + TransactionType + 'RESP</RESPTYPE>');

      if NOT assigned(ReturnList) then begin
         ReturnList := TStringList.Create();
      end;

      MerchantSessionID := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/MERCHANTSESSIONID'), True, True, '- ');

      PPAPIRNID := NumericOnly(APIXML.GetValueAsWideString('/TRANSACTION/RNID'));
      ReturnList.Values['PPAPIRNID'] := PPAPIRNID;

      OriginalTranIdent := trim(APIXML.GetValueAsWideString('/TRANSACTION/TRANIDENT'));
      TranIdent := ValidCharsOnly(OriginalTranIdent, True, True, '.-_:/& ');

      OriginalCustIdent := trim(APIXML.GetValueAsWideString('/TRANSACTION/CUSTIDENT'));
      CustIdent := ValidCharsOnly(OriginalCustIdent, True, True, '.-_:/& ');
      ReturnList.Values['CustIdent'] := CustIdent;

      OriginalReferURL := trim(APIXML.GetValueAsWideString('/TRANSACTION/REFERURL'));
      ReferURL := ValidCharsOnly(OriginalReferURL, True, True, './:?&=-_%');

      if strtobool(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/PPREQUESTPAYMENTCHECKVALUES', 'FALSE')) then begin //2016-10-06 jtm: Defect OT#1269
         TranMessage := '';
         if TranIdent <> OriginalTranIdent then TranMessage := 'INVALID CHAR: TRANIDENT';
         if CustIdent <> OriginalCustIdent then TranMessage := 'INVALID CHAR: CUSTIDENT';
         if ReferURL <> OriginalReferURL then TranMessage := 'INVALID CHAR: REFERURL';
         if TranMessage <> '' then begin
             TranSuccess := false;
             ProcessLog(ltInfo, METHOD_NAME, TranMessage);
             exit;
         end;
      end;

      AuthenticatedTill := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/AUTHENTICATETILL'), True, True, '/-:. ');
      ExpDate := Now;
      if AuthenticatedTill <> '' then begin
         Try
            if Pos('Z', AuthenticatedTill) > 0 then begin //2017-01-20 jtm F#1402
               ExpDate := ZTimeToLocalTimeWithDST(AuthenticatedTill);
            end else begin
               ExpDate := StrToDateTime(AuthenticatedTill); //2016-5-10 jtm
            end;
         except
            On E: Exception do begin
               ProcessLog(ltWarning, 'Exception Attempting date as datetime:', E.ClassName + ': ' + E.Message);
            end;
         end;
      end else if strtobool(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/CREATESESSION/AUTHENTICATETILL/ENABLE', 'FALSE')) then begin
         ProcessLog(ltInfo, METHOD_NAME, 'Authenticate Till tag is enabled');
         AuthTillDateIncType := UpperCase(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/CREATESESSION/AUTHENTICATETILL/TIMETOEXPIRATION/@type', 'MINUTE'));
         try
            AuthTillAmount := strtoint(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/CREATESESSION/AUTHENTICATETILL/TIMETOEXPIRATION', '10'));
         except
            on E: Exception do begin
               ProcessLog(ltWarning, METHOD_NAME + ' Exception converting timetotimeout to integer', E.ClassName + ': ' + E.Message);
               AuthTillAmount := 10;
            end;
         end;
         if AuthTillDateIncType = 'YEAR' then ExpDate := IncYear(ExpDate, AuthTillAmount)
         else if AuthTillDateIncType = 'MONTH' then ExpDate := IncMonth(ExpDate, AuthTillAmount)
         else if AuthTillDateIncType = 'DAY' then ExpDate := IncDay(ExpDate, AuthTillAmount)
         else if AuthTillDateIncType = 'MINUTE' then ExpDate := IncMinute(ExpDate, AuthTillAmount)
         else if AuthTillDateIncType = 'SECOND' then ExpDate := IncSecond(ExpDate, AuthTillAmount)
         else if AuthTillDateIncType = 'MILLISECOND' then ExpDate := IncMillisecond(ExpDate, AuthTillAmount);
      end;

      RNSessionID := GenerateGUID;
      ReturnList.Values['RNSessionID'] := RNSessionID;

      if strtobool(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/CREATESESSION/USEMERCHANTSESSIONID', 'FALSE')) AND (MerchantSessionID <> '') then begin
         LookupRegistryFromMerchantSessionID(RNQuery, PPAPIRNID, MerchantSessionID);
         if RNQuery.RecordCount <> 1 then begin
            ProcessLog(ltInfo, METHOD_NAME, 'No Registry records exist or duplicates exist');
            ProcessLog(ltInfo, METHOD_NAME, 'Num records: ' + inttostr(RNQuery.RecordCount));
            try // Create new Registry record
               RNQuery.Close();
               RNQuery.SQL.Clear();
               RNQuery.SQL.Add(ADD_REGISTRY_VALUE);
               RNQuery.Parameters.ParamByName('ChainCode').Value := inttostr(ChainCode);
               RNQuery.Parameters.ParamByName('PPAPIRNID').Value := PPAPIRNID;
               RNQuery.Parameters.ParamByName('MerchantSessionID').Value := MerchantSessionID;
               RNQuery.Parameters.ParamByName('RNSessionID').Value := RNSessionID;
               RNQuery.Parameters.ParamByName('ExpDate').Value := DateTimeToStr(ExpDate);
               RNQuery.ExecSQL();
            except
               on E:Exception do begin
                  ProcessLog(ltWarning, METHOD_NAME, E.ClassName + ': ' + E.Message);
               end;
            end;
         end else begin
            ProcessLog(ltInfo, METHOD_NAME, 'Registry records exist');

            if Now < RNQuery.FieldByName('AUTHENTICATEDTILL').AsDateTime then begin  // valid session exists
               ProcessLog(ltInfo, METHOD_NAME, 'A valid session exists');
               tranMessage := 'A valid session already exists';
               transuccess := false;
               exit;
            end else begin // expired or non-existent session
               ProcessLog(ltInfo, METHOD_NAME, 'The associated session has expired or is non-existent');
               RNQuery.Edit();
               RNQuery.FieldByName('KEYVALUE').AsString := RNSessionID;
               RNQuery.FieldByName('OPTIONS').AsDateTime := ExpDate;
               RNQuery.Post();
            end;
         end;
      end;

      ClientURL := '';
      RedirectToClientURL := false;
      if strtobool(ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/REDIRECTTOCLIENTURL'), True, false, '')) then begin //2018-01-25 jtm: F#2235
          RedirectToClientURL := true;
          ClientURL := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/CLIENTURL'), True, True, './:?&=-_%');
          if ClientURL = '' then begin
            ClientURL := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/CLIENTURL', '');
          end;
      end;
      ReturnList.Values['ClientURL'] := ClientURL;

      UserData := APIXML.GetXPathNodeAsXMLString('/TRANSACTION/USERDATA', false);
      ReplaceString(UserData, CRLF, '');
      if GetXMLTagStr(UserData, 'USERDATA') = '' then begin // 2019-4-17 ss DVST:5434
         UserData := ''; // if <USERDATA> has no child tags or is empty then store ''
      end;

      IVRActions :=  APIXML.GetXPathNodeAsXMLString('/TRANSACTION/IVRACTIONS', false);
      ReplaceString(IVRActions, CRLF, '');

      AvsData := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/AVSDATA'), True, True, '');
      BillingZip := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/BILLINGZIP'), False, True, ' -');
      if (AvsData = '') and (BillingZip <> '') then begin
          AvsData := BillingZip;
      end;

      FileLocation  := '';
      Base64File := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/FILE/BASE64FILE'), True, True, '+/=');
      if Base64File <> '' then begin
         FileName := GenerateGUID + '.pdf';
         FileLocation := 'C:\Inetpub\wwwroot\' + DomainHostFolder + '\' + FileName;
         DecodeToFile(Base64File, FileLocation);
      end;
      ReturnList.Values['FileLocation'] := FileLocation;

      Email := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/EMAIL'), True, True, '_.-#@+/');
      ReturnList.Values['Email'] := Email;

      LocationRNID := NumericOnly(APIXML.GetValueAsWideString('/TRANSACTION/LOCATIONIDENT'));
      ReturnList.Values['LocationRNID'] := LocationRNID;

      PhoneNumber := NumericOnly(APIXML.GetValueAsWideString('/TRANSACTION/PHONENO'));
      ReturnList.Values['PhoneNumber'] := NumericOnly(APIXML.GetValueAsWideString('/TRANSACTION/PHONENO'));

      ProcessLog(ltInfo, METHOD_NAME, 'XML processed');
      ProcessLog(ltInfo, METHOD_NAME, 'ClientTxnGUID: ' + ClientTxnGUID);

      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add(CREATE_SESSION);
      RNQuery.Parameters.ParamByName('RNSessionID').Value := RNSessionID;
      RNQuery.Parameters.ParamByName('DateAdded').Value := FormatDateTime('MM/DD/YYYY HH:NN:SS', now);
      RNQuery.Parameters.ParamByName('AccessCount').Value := 1;
      RNQuery.Parameters.ParamByName('RemoteAddress').Value := GetRemoteAddress;
      RNQuery.Parameters.ParamByName('WWWDomain').Value := trim(Request.Host);
      RNQuery.ExecSQL;

      ProcessLog(ltInfo, METHOD_NAME, 'session created');

      XMLResp.Add(' <SESSIONID>' + RNSessionID + '</SESSIONID>');

      SessionVarEval.AddValue('SessionID', RNSessionID);
      SessionVarEval.AddValue('FirstName', ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/FIRSTNAME'), True, True, ' '));
      SessionVarEval.AddValue('LastName', ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/LASTNAME'), True, True, '- '));
      SessionVarEval.AddValue('TRANIDENT', TranIdent);
      SessionVarEval.AddValue('StationIdent', ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/STATIONIDENT'), True, True, '-. '));
      SessionVarEval.AddValue('CUSTIDENT', CustIdent);
      SessionVarEval.AddValue('Hash', ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/TXNAUTH'), True, True, ''));
      SessionVarEval.AddValue('AVSDATA', AvsData);
      SessionVarEval.AddValue('CCNAME', ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/CCNAME'), True, True, '-. '));
      SessionVarEval.AddValue('ReferURL', ReferURL);

      SessionVarEval.AddValue('AccountNum', ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/ACCOUNTNUMBER'), True, True, ''));
      SessionVarEval.AddValue('Email', Email);
      SessionVarEval.AddValue('BCCEmail', ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/BCCEMAIL'), True, True, '_.-#@+/'));

      SessionVarEval.AddValue('BalanceDue', Trim(StriReal(ValuReal(APIXML.GetValueAsWideString('/TRANSACTION/BALANCEDUE')), 2)));

      SessionVarEval.AddValue('BillingName', ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/BILLINGNAME'), True, False, ' -'));
      SessionVarEval.AddValue('BillingAddress', ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/BILLINGADDRESS'), True, True, ' .,'));
      SessionVarEval.AddValue('BillingCity', ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/BILLINGCITY'), True, True, ' .,'));
      SessionVarEval.AddValue('BillingState', ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/BILLINGSTATE'), True, False, ''));
      SessionVarEval.AddValue('BillingZip', BillingZip);

      SessionVarEval.AddValue('PaymentRNID', ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/PAYMENTRNID'), False, True, ''));
      SessionVarEval.AddValue('LocationName', ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/LOCATIONNAME'), True, True, ''));
      SessionVarEval.AddValue('LocationRNID', LocationRNID);
      SessionVarEval.AddValue('UserData', UserData);
      SessionVarEval.AddValue('EmployeeName', ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/EMPLOYEENAME'), True, True, '- '));
      SessionVarEval.AddValue('EmployeeEmail', ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/EMPLOYEEEMAIL'), True, True, '_.-#@+/'));
      SessionVarEval.AddValue('EmpIdent', ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/EMPIDENT'), True, True, '.-_/'));
      SessionVarEval.AddValue('ServiceName', ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/SERVICENAME'), True, True, '-'));
      SessionVarEval.AddValue('Custom', APIXML.GetValueAsWideString('/TRANSACTION/CUSTOM'));
      SessionVarEval.AddValue('Custom2', APIXML.GetValueAsWideString('/TRANSACTION/CUSTOM2'));
      SessionVarEval.AddValue('Custom3', APIXML.GetValueAsWideString('/TRANSACTION/CUSTOM3'));
      SessionVarEval.AddValue('Custom4', APIXML.GetValueAsWideString('/TRANSACTION/CUSTOM4'));
      SessionVarEval.AddValue('Custom5', APIXML.GetValueAsWideString('/TRANSACTION/CUSTOM5'));
      SessionVarEval.AddValue('Custom6', APIXML.GetValueAsWideString('/TRANSACTION/CUSTOM6'));

      SessionVarEval.AddValue('PhoneNumber', PhoneNumber);
      SessionVarEval.AddValue('ClientURL', ClientURL);

      IVRActionID := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/IVRACTIONID'), True, True, '.-_/');
      IVRActionCallType := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/IVRACTIONCALLTYPE'), True, True, '.-_/');
      IVRPin := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/IVRPIN'), True, True, '.-_/');
      IVRPhoneNoToCall := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/IVRPHONENOTOCALL'), True, True, '.-_/');
      ReturnPhoneNumber := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/RETURNPHONENUMBER'), True, True, '.-_/');
      SessionType := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/SESSIONTYPE'), True, True, '');
      CCAuthType := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/CCAUTHTYPE'), True, False, '');
      Language := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/LANGUAGE'), True, True, '');

      if IVRActionID <> '' then SessionVarEval.AddValue('IVRActionID', IVRActionID); //2017-06-07 jtm: F#1857
      if IVRActionCallType <> '' then SessionVarEval.AddValue('IVRActionCallType', IVRActionCallType);
      if IVRPin <> '' then SessionVarEval.AddValue('IVRPin', IVRPin);
      if IVRPhoneNoToCall <> '' then SessionVarEval.AddValue('IVRPhoneNoToCall', IVRPhoneNoToCall);
      if IVRActions <> '' then SessionVarEval.AddValue('IVRActions', IVRActions);
      if ReturnPhoneNumber <> '' then SessionVarEval.AddValue('ReturnPhoneNumber', ReturnPhoneNumber);
      if SessionType <> '' then SessionVarEval.AddValue('SessionType', SessionType);
      if CCAuthType <> '' then SessionVarEval.AddValue('CCAuthType', CCAuthType);
      if Language <> '' then SessionVarEval.AddValue('Language', Language);

      POSTranIdentGUID := Trim(APIXML.GetValueAsWideString('/TRANSACTION/POSTRANIDENTGUID')); //2019-4-17 ss DVST-3651
      TicketIdent := Trim(APIXML.GetValueAsWideString('/TRANSACTION/TICKETIDENT')); //2019-4-17 ss DVST-3651
      
      if POSTranIdentGUID <> '' then SessionVarEval.AddValue('POSTRANIDENTGUID', POSTranIdentGUID); //2019-4-17 ss DVST-3651
      if TicketIdent <> '' then SessionVarEval.AddValue('TICKETIDENT', TicketIdent); //2019-4-17 ss DVST-3651

      ProcessLog(ltInfo, METHOD_NAME, 'sessionvareval values added');

      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add(GET_SESSION);
      RNQuery.Parameters.ParamByName('RNSessionID').Value := RNSessionID;
      RNQuery.Open;
      RNQuery.Edit;
      RNQuery.FieldByName('SessionVars').AsString := SessionVarEval.Vars.Text;
      RNQuery.FieldByName('ChainCode').AsInteger := ChainCode;
      RNQuery.FieldByName('RNID').AsString := PPAPIRNID;

      if strtobool(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/PPREQUESTPAYMENT/RETURNSC', 'FALSE')) then begin //2018-10-10 jtm: DVST-2469
         XMLResp.Add(' <SYSTEMCODE>' + trim(RNQuery.FieldByName('SystemCode').AsString) + '</SYSTEMCODE>');
      end;

      if (AuthenticatedTill <> '') OR strtobool(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/CREATESESSION/AUTHENTICATETILL/ENABLE', 'FALSE')) then begin
         try
            RNQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime := ExpDate;
         except
            on E:Exception do begin
               ProcessLog(ltWarning, 'Exception Attempting date as datetime:', E.ClassName + ': ' + E.Message);
            end;
         end;
      end;

      if strtobool(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/PPREQUESTPAYMENT/RETURNSESSIONEXP', 'FALSE')) then begin //2018-10-10 jtm: DVST-2510
         if assigned(RNProfileDI) then begin
            FreeAndNil(RNProfileDI);
         end;
         if assigned(RNProfile) then begin
            FreeAndNil(RNProfile);
         end;
         RNProfileDI := TTADODataLayer.Create(RNDB);
         RNProfile := TTProfile.Create(PPAPIRNID, false, RNProfileDI);
         if trim(SessionAuthQuery.FieldByName('CustomerAuthenticatedTill').AsString) = '' then begin
            ExpDate := LocalTimeToZoneTime(NOW + EncodeTime(0, 30, 0, 0), RNProfile.StoreTZ);
         end else begin
            ExpDate := LocalTimeToZoneTime(RNQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime, RNProfile.StoreTZ);
         end;
         ExpDateStr := FormatDateTime('YYYY-MM-DD', ExpDate) + 'T' + FormatDateTime('HH:NN:SS', ExpDate) + GetTimeZoneBiasByNameString(RNProfile.StoreTZ) + ':00';
         XMLResp.Add(' <AUTHENTICATETILL>'+ trim(ExpDateStr) + '</AUTHENTICATETILL>');      //this probably needs to match better with what we're accepting, maybe return z time instead

         FreeAndNil(RNProfileDI);
         FreeAndNil(RNProfile);
      end;

      RNQuery.Post;

      TranSuccess := True;
   end;

   Procedure PPRequestPayment;
   const
      METHOD_NAME = 'PPRequestPayment()'; // 2019-4-17 ss DVST:5434
   var
      PPAPIRNID, RNSessionID, Email, FileLocation, ClientURL, PhoneNumber, LocationRNID, CustIdent, SendEmail, SendSMS, EmailTemplate, DestinationURL, SMSRNID, SMSCustIdent: string;

      ReturnList: TStringList;
   Begin
      ProcessLog(ltInfo, 'PPRequestPayment', 'begin processing');

      ReturnList := TStringList.Create;
      CreateSession(ReturnList);

      PPAPIRNID := ReturnList.Values['PPAPIRNID'];
      RNSessionID := ReturnList.Values['RNSessionID'];
      Email := ReturnList.Values['Email'];
      FileLocation := ReturnList.Values['FileLocation'];
      ClientURL := ReturnList.Values['ClientURL'];
      PhoneNumber := ReturnList.Values['PhoneNumber'];
      LocationRNID := ReturnList.Values['LocationRNID'];
      CustIdent := ReturnList.Values['CustIdent'];

      SendEmail := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/SENDEMAIL'), True, False,'');
      SendSMS := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/SENDSMS'), True, False, '');
      EmailTemplate := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/EMAILTEMPLATE'), True, True, '.');
      DestinationURL := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/DESTINATIONURL'), True, True, './:?&=-');

      if strtobool(SendEmail) then begin
         ProcessLog(ltInfo, 'PPRequestPayment', 'Sending email to: ' + Email);
         XMLResp.Add(' <EMAILSENT>' + SendPaymentInvite(RNSessionID, Email, EmailTemplate, DestinationURL, FileLocation, ClientURL) + '</EMAILSENT>');
      end;
      if strtobool(SendSMS) and strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/ALLOWSMS', 'FALSE')) then begin //2018-01-25 jtm: F#2080
         ProcessLog(ltInfo, 'PPRequestPayment', 'Sending SMS to: ' + PhoneNumber);
         if LocationRNID <> '' then begin
            SMSRNID := LocationRNID;
         end else begin
            SMSRNID := PPAPIRNID;
         end;

         if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/SMSCUSTIDENTEXP', '') <> '' then begin
            SMSCustIdent := VarExprEvalAsString('', OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/SMSCUSTIDENTEXP'));
         end else begin
            SMSCustIdent := CustIdent;
         end;
         XMLResp.Add(' <SMSSENT>' + SendPaymentInviteSMS(RNSessionID, PhoneNumber, DestinationURL, FileLocation, ClientURL, SMSRNID, SMSCustIdent) + '</SMSSENT>');
      end;
      TranSuccess := True;
      ProcessLog(ltDebug, 'PPRequestPayment', 'SessionVarEval as XML = ' + SessionVarEval.ToXML()); // 2019-4-17 ss DVST-5434
      ProcessLog(ltInfo, 'PPRequestPayment', 'End of pprequestpayment');
   end;

   Procedure PPRequestPaymentOld;
   const
      METHOD_NAME = 'PPRequestPayment()'; // 2019-4-17 ss DVST:5434
   var
      ImportDir : String;
      PPAPIRNID : string;  //2016-3-28 jtm
      LocationRNID : String;
      FirstName :String;
      LastName :String;
      TranIdent : String;
      StationIdent : String;
      CustIdent : String;
      AccountNum : String;
      Hash : String;
      AvsData : String;
      CCName : String;
      ReferURL : String;
      Email : String;
      BCCEmail : String;
      BalanceDue : String;
      PhoneNumber : string;

      AuthenticatedTill : string;
      SendEmail : string;
      SendSMS : string;
      EmailTemplate : string;
      DestinationURL : string;
      FileName : string;
      Base64File : AnsiString;
      BillingName : string;
      BillingAddress : string;
      BillingCity : string;
      BillingState : string;
      BillingZip : string;
      FileLocation : String;
      UserData : String;

      PaymentRNID : string;     //2015-10-06 jtm
      LocationName : string;
      EmployeeName : string;  //2016-8-08 jtm: Feat OT#979
      EmployeeEmail : string;
      AdditionalExpiration : integer;
      Expiration : TDateTime;
      EmpIdent : string; //2017-05-10 jtm: F#1606
      IVRActionID : string; //2017-06-07 jtm: F#1857
      IVRActionCallType : string;
      IVRPin : string;
      IVRPhoneNoToCall : string;
      IVRActions : string;
      ServiceName : string;  //2017-09-20 jtm: F#2150
      CustomField1 : string; //2017-09-20 jtm: F#2194
      CustomField2 : string;
      CustomField3 : string;
      CustomField4 : string;
      CustomField5 : string;
      CustomField6 : string;
      ClientURL : string; //2017-12-20 jtm: F#2235
      RedirectToClientURL : boolean; //2018-01-25 jtm F#2235
      SMSRNID : string; //2018-01-25 jtm F#2080
      SMSCustIdent : string; //2018-01-25 jtm F#2080
      ReturnPhoneNumber : string; //2018-10-10 jtm: DVST-2469
      SystemCode : string; //2018-10-10 jtm: DVST-2469
      ExpDate : TDateTime; //2018-10-10 jtm: DVST-2510
      ExpDateStr : string; //2018-10-10 jtm: DVST-2510
      SessionType : string;
      CCAuthType : string;
      POSTranIdentGUID, TicketIdent: String; //2019-4-17 ss DVST-3651
      Language : string; //2019-5-15 jtm DVST-5740
   Begin

      ProcessLog(ltInfo, 'PPRequestPayment', 'begin processing');
      XMLResp.Add(' <RESPTYPE>'+TransactionType + 'RESP'+'</RESPTYPE>');
      PPAPIRNID := NumericOnly(APIXML.GetValueAsWideString('/TRANSACTION/RNID'));
      LocationRNID := NumericOnly(APIXML.GetValueAsWideString('/TRANSACTION/LOCATIONIDENT')); //2016-3-28 jtm

      FirstName := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/FIRSTNAME'),True,True, ' ');
      LastName := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/LASTNAME'),True,True, '- ');

      TranIdent := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/TRANIDENT'),True,True,'.-_:/& '); //2017-05-10 jtm D#1605
      CustIdent := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/CUSTIDENT'),True,True,'.-_:/& '); //2017-05-10 jtm D#1605
      ReferURL := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/REFERURL'),True,True,'./:?&=-_%'); //2016-09-29 jtm Defect OT# 1263


      ClientURL := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/CLIENTURL'),True,True,'./:?&=-_%'); //2018-01-25 jtm: F#2235
      if (UpperCase(ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/REDIRECTTOCLIENTURL'),True,false,''))='TRUE') then begin //2018-01-25 jtm: F#2235
          RedirectToClientURL := true;
          if (ClientURL = '') then begin
            ClientURL := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/CLIENTURL', '');
          end;
      end else begin
          RedirectToClientURL := false;
          ClientURL := '';
      end;

      if OpenXMLGetTag('/CONFIGDATA/APIPARAMS/PPREQUESTPAYMENTCHECKVALUES', 'FALSE') = 'TRUE' then begin //2016-10-06 jtm: Defect OT#1269
         TranMessage := '';
         if TranIdent <> trim(APIXML.GetValueAsWideString('/TRANSACTION/TRANIDENT')) then TranMessage := 'INVALID CHAR: TRANIDENT';
         if CustIdent <> trim(APIXML.GetValueAsWideString('/TRANSACTION/CUSTIDENT')) then TranMessage := 'INVALID CHAR: CUSTIDENT';
         if ReferURL <> trim(APIXML.GetValueAsWideString('/TRANSACTION/REFERURL')) then TranMessage := 'INVALID CHAR: REFERURL';
         if TranMessage <> '' then begin
             TranSuccess := false;
             ProcessLog(ltInfo, 'PPRequestPayment failure', TranMessage);
             exit;
         end;
      end;

      StationIdent := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/STATIONIDENT'),True,True,'-. ');
      Hash := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/TXNAUTH'),True,True,'');
      AvsData := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/AVSDATA'),true,True,'');//2017-09-20 jtm: F#2193
      CCName := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/CCNAME'),True,True,'-. ');


      AccountNum := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/ACCOUNTNUMBER'),True,True,'');
      Email := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/EMAIL'),True,True, '_.-#@+/');
      BCCEmail := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/BCCEMAIL'),True,True, '_.-#@+/');

      BalanceDue := Trim(StriReal(ValuReal(APIXML.GetValueAsWideString('/TRANSACTION/BALANCEDUE')),2));
      AuthenticatedTill := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/AUTHENTICATETILL'),True,True,'/-:. ');
      SendEmail := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/SENDEMAIL'),True,False,'');
      SendSMS := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/SENDSMS'),True,False,'');
      PhoneNumber := NumericOnly(APIXML.GetValueAsWideString('/TRANSACTION/PHONENO'));

      EmailTemplate := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/EMAILTEMPLATE'),True,True,'.');
      DestinationURL := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/DESTINATIONURL'),True,True,'./:?&=-'); //2018-08-21 bls: 2047

      Base64File := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/FILE/BASE64FILE'),True, True, '+/=');

      PaymentRNID := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/PAYMENTRNID'),false, True, '');
      LocationName := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/LOCATIONNAME'),true, True, '');

      UserData :=  APIXML.GetXPathNodeAsXMLString('/TRANSACTION/USERDATA', false);
      ReplaceString(UserData, CRLF, '');
      if(GetXMLTagStr(UserData, 'USERDATA') = '') then begin // 2019-4-17 ss DVST:5434
         UserData := ''; // if <USERDATA> has no child tags or is empty then store ''
      end;
      
      BillingName := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/BILLINGNAME'),True,False, ' -');
      BillingAddress := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/BILLINGADDRESS'),True,True, ' .,');
      BillingCity := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/BILLINGCITY'),True,True, ' .,');
      BillingState := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/BILLINGSTATE'),True,False, '');
      BillingZip :=  ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/BILLINGZIP'),False,True, ' -');

      EmployeeName := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/EMPLOYEENAME'),True,True, '- ');
      EmployeeEmail := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/EMPLOYEEEMAIL'),True,True, '_.-#@+/');

      EmpIdent := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/EMPIDENT'),True,True, '.-_/'); //2017-05-10 jtm: F#1606

      IVRActionID := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/IVRACTIONID'),True,True, '.-_/'); //2017-06-07 jtm: F#1857
      IVRActionCallType := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/IVRACTIONCALLTYPE'),True,True, '.-_/');
      IVRPin := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/IVRPIN'),True,True, '.-_/');
      IVRPhoneNoToCall := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/IVRPHONENOTOCALL'),True,True, '.-_/');
      IVRActions :=  APIXML.GetXPathNodeAsXMLString('/TRANSACTION/IVRACTIONS', false);
      ReplaceString(IVRActions, CRLF, '');
      ReturnPhoneNumber := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/RETURNPHONENUMBER'),True,True, '.-_/'); //2018-10-10 jtm: DVST-2469
      SessionType := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/SESSIONTYPE'),True,True,''); //2018-10-10 jtm: DVST-2469
      Language := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/LANGUAGE'),True,True,''); //2019-5-15 jtm DVST-5740

      ServiceName :=  ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/SERVICENAME'),true, True,'-'); //2017-09-20 jtm: F#2150
      CCAuthType := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/CCAUTHTYPE'),true, false,''); //2018-10-10 jtm: DVST-2469
      CustomField1 := APIXML.GetValueAsWideString('/TRANSACTION/CUSTOM'); //2017-09-20 jtm: F#2194
      CustomField2 := APIXML.GetValueAsWideString('/TRANSACTION/CUSTOM2');
      CustomField3 := APIXML.GetValueAsWideString('/TRANSACTION/CUSTOM3');
      CustomField4 := APIXML.GetValueAsWideString('/TRANSACTION/CUSTOM4');
      CustomField5 := APIXML.GetValueAsWideString('/TRANSACTION/CUSTOM5');
      CustomField6 := APIXML.GetValueAsWideString('/TRANSACTION/CUSTOM6');
      if (AvsData = '') and (BillingZip <> '') then begin
          AvsData := BillingZip;
      end;

      FileLocation  := '';
      if (Base64File <> '') then begin
         FileName := GenerateGUID + '.pdf';
         FileLocation := 'C:\Inetpub\wwwroot\'+DomainHostFolder+'\' + FileName;
         DecodeToFile(Base64File, FileLocation);
      end;
      ProcessLog(ltInfo, 'PPRequestPayment', 'XML processed');
      ProcessLog(ltInfo, 'PPRequestPayment', 'ClientTxnGUID: '+ClientTxnGUID);

      POSTranIdentGUID := Trim(APIXML.GetValueAsWideString('/TRANSACTION/POSTRANIDENTGUID')); //2019-4-17 ss DVST-3651
      TicketIdent:= Trim(APIXML.GetValueAsWideString('/TRANSACTION/TICKETIDENT')); //2019-4-17 ss DVST-3651

      RNSessionID := GenerateGUID;
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Insert Into WWWSession (RNSessionID, DateAdded, AccessCount,RemoteAddress,WWWDomain) values (''' + //2017-11-16 jtm: D#2067
                       RNSessionID + ''',''' +
                       FormatDateTime('MM/DD/YYYY HH:NN:SS',now) + ''',1,'''+GetRemoteAddress + ''','''+trim(Request.Host)+''')');
      RNQuery.ExecSQL;

      ProcessLog(ltInfo, 'PPRequestPayment', 'session created');
      XMLResp.Add(' <SESSIONID>'+RNSessionID + '</SESSIONID>');

      SessionVarEval.AddValue('SessionID', RNSessionID);
      SessionVarEval.AddValue('FirstName', FirstName);
      SessionVarEval.AddValue('LastName', LastName);
      SessionVarEval.AddValue('TRANIDENT', TranIdent);
      SessionVarEval.AddValue('StationIdent', StationIdent);
      SessionVarEval.AddValue('CUSTIDENT', CustIdent);
      SessionVarEval.AddValue('Hash', Hash);
      SessionVarEval.AddValue('AVSDATA', AvsData);
      SessionVarEval.AddValue('CCNAME', CCName);
      SessionVarEval.AddValue('ReferURL', ReferURL);

      SessionVarEval.AddValue('AccountNum', AccountNum);
      SessionVarEval.AddValue('Email', Email);
      SessionVarEval.AddValue('BCCEmail', BCCEmail);

      SessionVarEval.AddValue('BalanceDue', BalanceDue);

      SessionVarEval.AddValue('BillingName', BillingName);
      SessionVarEval.AddValue('BillingAddress', BillingAddress);
      SessionVarEval.AddValue('BillingCity', BillingCity);
      SessionVarEval.AddValue('BillingState', BillingState);
      SessionVarEval.AddValue('BillingZip', BillingZip);

      SessionVarEval.AddValue('PaymentRNID', PaymentRNID); //2015-10-06 jtm
      SessionVarEval.AddValue('LocationName', LocationName);
      SessionVarEval.AddValue('LocationRNID', LocationRNID);
      SessionVarEval.AddValue('UserData', UserData);
      SessionVarEval.AddValue('EmployeeName', EmployeeName);
      SessionVarEval.AddValue('EmployeeEmail', EmployeeEmail);
      SessionVarEval.AddValue('EmpIdent', EmpIdent); //2017-05-10 jtm: F#1606
      SessionVarEval.AddValue('ServiceName', ServiceName); //2017-09-20 jtm: F#2150
      SessionVarEval.AddValue('Custom', CustomField1); //2017-09-20 jtm: F#2194
      SessionVarEval.AddValue('Custom2', CustomField2);
      SessionVarEval.AddValue('Custom3', CustomField3);
      SessionVarEval.AddValue('Custom4', CustomField4);
      SessionVarEval.AddValue('Custom5', CustomField5);
      SessionVarEval.AddValue('Custom6', CustomField6);

      SessionVarEval.AddValue('PhoneNumber', PhoneNumber);
      SessionVarEval.AddValue('ClientURL', ClientURL);


      if IVRActionID <> '' then SessionVarEval.AddValue('IVRActionID', IVRActionID); //2017-06-07 jtm: F#1857
      if IVRActionCallType <> '' then SessionVarEval.AddValue('IVRActionCallType', IVRActionCallType);
      if IVRPin <> '' then SessionVarEval.AddValue('IVRPin', IVRPin);
      if IVRPhoneNoToCall <> '' then SessionVarEval.AddValue('IVRPhoneNoToCall', IVRPhoneNoToCall);
      if IVRActions <> '' then SessionVarEval.AddValue('IVRActions', IVRActions);
      if ReturnPhoneNumber <> '' then SessionVarEval.AddValue('ReturnPhoneNumber', ReturnPhoneNumber);
      if SessionType <> '' then SessionVarEval.AddValue('SessionType', SessionType);
      if CCAuthType <> '' then SessionVarEval.AddValue('CCAuthType', CCAuthType);
      if Language <> '' then SessionVarEval.AddValue('Language', Language);

      if POSTranIdentGUID <> '' then SessionVarEval.AddValue('POSTRANIDENTGUID', POSTranIdentGUID); //2019-4-17 ss DVST-3651
      if TicketIdent <> '' then SessionVarEval.AddValue('TICKETIDENT', TicketIdent); //2019-4-17 ss DVST-3651

      ProcessLog(ltInfo, 'PPRequestPayment', 'sessionvareval values added');

      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from WWWSession where RNSessionID = ''' + RnSessionID + '''');
      RNQuery.Open;
      RNQuery.Edit;
      RNQuery.FieldByName('SessionVars').AsString := SessionVarEval.Vars.Text;
      RNQuery.FieldByName('ChainCode').AsInteger := ChainCode;
      RNQuery.FieldByName('RNID').AsString := PPAPIRNID;

      if strtobool(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/PPREQUESTPAYMENT/RETURNSC', 'FALSE')) then begin //2018-10-10 jtm: DVST-2469
         XMLResp.Add(' <SYSTEMCODE>'+ trim(RNQuery.FieldByName('SystemCode').AsString) + '</SYSTEMCODE>');
      end;

      if AuthenticatedTill <> '' then begin
         Try
            if Pos('Z',AuthenticatedTill)> 0 then begin //2017-01-20 jtm F#1402
               RNQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime := ZTimeToLocalTimeWithDST(AuthenticatedTill);
            end else begin
               RNQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime := StrToDateTime(AuthenticatedTill); //2016-5-10 jtm
            end;
         except
            On E:Exception do begin
            ProcessLog(ltWarning, 'Exception Attempting date as datetime:', E.Message);
            end;
         end;
      end;
      if strtobool(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/PPREQUESTPAYMENT/RETURNSESSIONEXP', 'FALSE')) then begin //2018-10-10 jtm: DVST-2510
         if (assigned(RNProfileDI)) then begin
            FreeAndNil(RNProfileDI);
         end;
         if (assigned(RNProfile)) then begin
            FreeAndNil(RNProfile);
         end;
         RNProfileDI := TTADODataLayer.Create(RNDB);
         RNProfile := TTProfile.Create(PPAPIRNID,false, RNProfileDI);
         if trim(SessionAuthQuery.FieldByName('CustomerAuthenticatedTill').AsString) = '' then begin
            ExpDate := LocalTimeToZoneTime(NOW + EncodeTime(0,30,0,0),RNProfile.StoreTZ);
         end else begin
            ExpDate := LocalTimeToZoneTime(RNQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime,RNProfile.StoreTZ);
         end;
         ExpDateStr := FormatDateTime('YYYY-MM-DD',ExpDate) + 'T' + FormatDateTime('HH:NN:SS',ExpDate) +GetTimeZoneBiasByNameString(RNProfile.StoreTZ)+':00';
         XMLResp.Add(' <AUTHENTICATETILL>'+ trim(ExpDateStr) + '</AUTHENTICATETILL>');      //this probably needs to match better with what we're accepting, maybe return z time instead

         FreeAndNil(RNProfileDI);
         FreeAndNil(RNProfile);
      end;
      RNQuery.Post;

      if SendEmail = 'TRUE' then begin
         ProcessLog(ltInfo, 'PPRequestPayment', 'Sending email to: ' + Email);
         XMLResp.Add(' <EMAILSENT>'+ SendPaymentInvite(RNSessionID, Email, EmailTemplate, DestinationURL, FileLocation,ClientURL) + '</EMAILSENT>');
      end;
      if (SendSMS = 'TRUE') and (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/ALLOWSMS','FALSE') = 'TRUE') then begin //2018-01-25 jtm: F#2080
         ProcessLog(ltInfo, 'PPRequestPayment', 'Sending SMS to: ' + PhoneNumber);
         if (LocationRNID <> '') then begin
            SMSRNID := LocationRNID;
         end else begin
            SMSRNID := PPAPIRNID;
         end;

         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/SMSCUSTIDENTEXP','') <> '') then begin
            SMSCustIdent := VarExprEvalAsString('',OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/SMSCUSTIDENTEXP'));
         end else begin
            SMSCustIdent := CustIdent;
         end;
         XMLResp.Add(' <SMSSENT>'+ SendPaymentInviteSMS(RNSessionID, PhoneNumber, DestinationURL, FileLocation,ClientURL,SMSRNID,SMSCustIdent) + '</SMSSENT>');
      end;
      TranSuccess := True;
      ProcessLog(ltInfo, 'PPRequestPayment', 'End of pprequestpayment');

   end;
   procedure PPAuthenticateUser;
   var
      Email : String;
      Password : string;
   Begin
      TranSuccess := False;
      ProcessLog(ltInfo, 'PPAuthenticateUser', 'begin authentication');
      XMLResp.Add(' <RESPTYPE>'+TransactionType + 'RESP'+'</RESPTYPE>');
      LocationRNID := NumericOnly(APIXML.GetValueAsWideString('/TRANSACTION/RNID'));


      Email := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/EMAIL'),True,True, '_.-#@+/');
      Password := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/PASSWORD'),True,True, '+/=');
      if Password <> '' then Password := CardUtil.STDBase64Decode(Password);

      ProcessLog(ltInfo, 'PPAuthenticateUser', 'ClientTxnGUID: '+ClientTxnGUID);

      if Email = '' then begin
         TranSuccess := False;
         TranMessage := 'NO EMAIL SENT';
      end else if Password = '' then begin
         TranSuccess := False;
         TranMessage := 'NO PASSWORD SENT';
      end else begin
         RNQuery.Close;
         RNQuery.SQL.Clear;
         RNQuery.SQL.Clear;
         RNQuery.SQL.Add('Select * from Customers where (StoreCode = '+ LocationRNID + ') and (Email = ''' + email + ''')');
         RNQuery.Open;

         If OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/CASESENSITIVE', 'FALSE') = 'FALSE' then Password := UpCaseString(Password);

         If RNQuery.RecordCount = 1 then begin
            ProcessLog(ltInfo,'PPAuthenticateUser Email Found',email);
            if (Trim(RNQuery.FieldByName('PasswordBcrypt').asString) = '') and (Trim(RNQuery.FieldByName('PasswordHash').asString) = StringToSHADigestHex('u.G&ONy@=NYWoKaiJ+_npPv.%Gj' + Trim(Password))) then begin
               ProcessLog(ltInfo,'PPAuthenticateUser new password hash added for:',email);
               RNQuery.Edit;
               RNQuery.FieldByName('PasswordHash').AsString := '';
               RNQuery.FieldByName('PasswordBcrypt').AsString := BCryptPassword(Trim(Password),trim(RNQuery.FieldByName('CustomerCode').AsString));
               RNQuery.FieldByName('LastWebLogon').AsDateTime := Now;
               RNQuery.FieldByName('PWFailureCount').AsInteger := 0;

               XMLResp.Add(' <CUSTGUID>'+Trim(RNQuery.FieldByName('CUSTOMERCODE').AsString) + '</CUSTGUID>');
               TranSuccess := true;
               RNQuery.Post;

            end else If (CheckBCryptPassword(Trim(Password),trim(RNQuery.FieldByName('CustomerCode').AsString),Trim(RNQuery.FieldByName('PasswordBcrypt').asString))) AND (RNQuery.FieldByName('LockedUntil').AsDateTime < NOW) then begin
               RNQuery.Edit;
               RNQuery.FieldByName('LastWebLogon').AsDateTime := Now;
               RNQuery.FieldByName('PWFailureCount').AsInteger := 0;

               XMLResp.Add(' <CUSTGUID>'+Trim(RNQuery.FieldByName('CUSTOMERCODE').AsString) + '</CUSTGUID>');
               TranSuccess := true;
               RNQuery.Post;
            end else begin
               ProcessLog(ltWarning,'PPAuthenticateUser Password failure:',email);

               RNQuery.Edit;
               RNQuery.FieldByName('PWFailureCount').AsInteger := RNQuery.FieldByName('PWFailureCount').AsInteger+1;
               RNQuery.Post;
               TranMessage := 'INVALID PASSWORD';
               If RNQuery.FieldByName('PWFailureCount').AsInteger > 5 then begin
                  RNQuery.Edit;
                  RNQuery.FieldByName('LockedUntil').AsDateTime := NOW + EncodeTime(0,30,0,0);
                  RNQuery.Post;
               end;

               If RNQuery.FieldByName('LockedUntil').AsDateTime > NOW then begin
                  TranSuccess := False;
                  TranMessage := 'ACCOUNT LOCKED';
                  ProcessLog(ltWarning,'PPAuthenticateUser ACCOUNT LOCKED:',email);

               end else If RNQuery.FieldByName('PWFailureCount').AsInteger = 4 then begin
                  RNQuery.Edit;
                  RNQuery.FieldByName('ResetExpires').AsDateTime := NOW + EncodeTime(2,00,0,0);
                  RNQuery.FieldByName('ResetGuid').AsString := GenerateGUID;
                  RNQuery.Post;
                  VarEvaluator.AddDSCurrentRecord(RNQuery, 'Customers');

                  if DomainSendAsEmail = '' then DomainSendAsEmail := 'payments@tempustechnologies.com';

                  WS := '<HTML>Thank you for your login request.<BR>If you are having difficulty accessing your account, click <A HREF="https://'+UpCaseString(Request.Host)+'/PP?PAGE=PWRESET&RESETGUID='+
                        Trim(RNquery.FieldByName('ResetGUID').AsString) +'&CUSTIDENT='+Trim(RNquery.FieldByName('CustomerCode').AsString)+'">here</A> to Reset your password.<BR>Thank you.';
                  clMail.BuildMessage('',WS);
                  clMail.From.FullAddress := '"' + DomainFriendlyName+'"<'+DomainSendAsEmail+'>';
                  clMail.ToList.EmailAddresses := Trim(RNquery.FieldByName('Email').AsString);
                  clMail.Subject := 'Password Reset Request from ' + DomainFriendlyName;
                  SMTP.Open();
                  try
                     SMTP.Send(clMail);
                  finally
                     SMTP.Close();
                  end;

                  TranSuccess := False;
                  TranMessage := 'PASSWORD RESET REQUEST SENT';
               end;
           end;
         end else begin
            TranSuccess := False;
            TranMessage := 'EMAIL NOT FOUND';
         end;
      end;
      RNQuery.Close;

      ProcessLog(ltInfo, 'PPAuthenticateUser', 'End of PPAuthenticateUser');

   end;

   procedure PPSendNotification;  //2016-8-08 jtm: Feat OT#1030
   var
      Email,EmailTemplate,BCCList,ReplyTo,EmailSubject : String;
      NotificationName : string;
   begin
      TranSuccess := False;
      ProcessLog(ltInfo, 'PPSendNotification', 'begin');
      XMLResp.Add(' <RESPTYPE>'+TransactionType + 'RESP'+'</RESPTYPE>');

      CustGUID := GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/CUSTGUID'));
      NotificationName := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/NOTIFICATIONNAME'),True,True, '+/=');
      PaymentsSchedGUID := GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/PAYMENTSCHEDGUID'));
      ChildGUID := GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/CHILDGUID'));
      PaymentGUID := GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/PAYMENTGUID'));
      If (CustGUID <> '') and (NotificationName <> '') then begin
         EmailTemplate := OpenXMLGetTag('/CONFIGDATA/NOTIFICATIONSSECTION/NOTIFICATIONS/NOTIFICATION[NAME='''+ NotificationName+''']/EMAILTEMPLATE');
         BCCList := OpenXMLGetTag('/CONFIGDATA/NOTIFICATIONSSECTION/NOTIFICATIONS/NOTIFICATION[NAME='''+ NotificationName+''']/EMAILBCC');
         ReplyTo := OpenXMLGetTag('/CONFIGDATA/NOTIFICATIONSSECTION/NOTIFICATIONS/NOTIFICATION[NAME='''+ NotificationName+''']/EMAILREPLYTO');
         EmailSubject := OpenXMLGetTag('/CONFIGDATA/NOTIFICATIONSSECTION/NOTIFICATIONS/NOTIFICATION[NAME='''+ NotificationName+''']/EMAILSUBJECT');
         If Not ValidateCustGUID(CustGUID) then exit;
         Email := VarEvaluator.GetValueAsString('Customers.Email');
         if Email = '' then begin
            TranMessage := 'NO EMAIL ON FILE';
         end else if (EmailTemplate <> '') then begin
            if PaymentsSchedGUID <> '' then begin
                if NOT ValidatePaymentSchedGUID(PaymentsSchedGUID) then exit;
            end;
            if ChildGUID <> '' then begin
                if NOT ValidateChildGUID(ChildGUID) then exit;
            end;
            if PaymentGUID <> '' then begin
                if NOT ValidatePaymentGUID(PaymentGUID) then exit;
            end;
            TranSuccess := SendCustomerEmail(Email, EmailTemplate,EmailSubject,BCCList,ReplyTo);
            XMLResp.Add(' <EMAILSENT>'+ BoolToStr(TranSuccess) + '</EMAILSENT>');
            XMLResp.Add(' <EMAIL>'+ Email + '</EMAIL>');
            ProcessLog(ltInfo, 'PPSendNotification', 'Email sent:' + BoolToStr(TranSuccess));
         end else begin
            TranMessage := 'NO EMAIL TEMPLATE SET';
         end;
      end else begin
         TranMessage := 'NO CUSTGUID OR NOTIFICATIONNAME';
      end;

      ProcessLog(ltInfo, 'PPSendNotification', 'End of PPSendNotification');
   end;

   procedure PPGetSessionValues;  //2016-11-22  F#1306
   const
      METHOD_NAME = 'PPGetSessionValues()'; // 2019-4-17 ss DVST-5434
   var
      SessionVarList : TStringList;
      SessionID, SystemCode, SQL, MerchantSessionID, PPAPIRNID: string;
      i, AdditionalExpiration: integer;
      Expiration : TDateTime;
      UsingMerchantSessionID: boolean;
   begin
      TranSuccess := False;
      ProcessLog(ltInfo, 'PPGetSessionValues', 'begin');
      XMLResp.Add(' <RESPTYPE>' + TransactionType + 'RESP</RESPTYPE>');
      RNSessionID := Trim(GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/SESSIONID'))); // 2019-3-13 ss DVST-3483
      SystemCode := Trim(APIXML.GetValueAsWideString('/TRANSACTION/SYSTEMCODE')); // 2019-3-13 ss DVST-3483
      ProcessLog(ltInfo, METHOD_NAME, 'RNSessionID = ' + RNSessionID); // 2019-4-17 ss DVST-5434
      ProcessLog(ltInfo, METHOD_NAME, 'SystemCode = ' + SystemCode); // 2019-4-17 ss DVST-5434

      UsingMerchantSessionID := strtobool(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/CREATESESSION/USEMERCHANTSESSIONID', 'FALSE'));
      MerchantSessionID := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/MERCHANTSESSIONID'), true, true, '- ');
      PPAPIRNID := NumericOnly(APIXML.GetValueAsWideString('/TRANSACTION/RNID'));

      if UsingMerchantSessionID AND (MerchantSessionID <> '') then begin
         LookupRegistryFromMerchantSessionID(SessionAuthQuery, PPAPIRNID, MerchantSessionID);
      end else begin
         if((SystemCode = '') And (RNSessionID = '')) then begin // 2019-3-13 ss DVST-3483
            TranMessage := 'EMPTY SYSTEMCODE AND SESSIONID';
            Exit;
         end;
         SessionAuthQuery.Close;
         SessionAuthQuery.SQL.Clear;
         SQL := GetPPSQLBySysCodeSessionIDRNID(XMLResp, APIRNID, SystemCode, RNSessionID);

         if(SQL = 'INTERNALERROR') then begin
            TranMessage := 'INTERNALERROR'; // generic error message
            ProcessLog(ltWarning, 'PPGetSessionValues', 'INTERNALERROR @ GetPPSQLBySysCodeSessionIDRNID()');
            Exit;
         end else begin
            SessionAuthQuery.SQL.Add(SQL);
         end;
         SessionAuthQuery.Open;
      end;
         
      If SessionAuthQuery.RecordCount = 1 then begin
         if OpenXMLGetTag('/CONFIGDATA/APIPARAMS/VALIDATESESSIONID')= 'TRUE' then begin
            AdditionalExpiration := StrToInt(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/VALIDATESESSIONIDEXP','0'));
            if (AdditionalExpiration >= 60) and ((AdditionalExpiration mod 60)=0) then begin
               AdditionalExpiration := AdditionalExpiration div 60;
               Expiration := SessionAuthQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime + EncodeTime(AdditionalExpiration,0,0,0); //2017-01-20 jtm D#1387
            end else begin
               Expiration := SessionAuthQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime + EncodeTime(0,AdditionalExpiration,0,0);
            end;
            If Expiration < NOW then begin
               TranMessage := 'SESSION EXPIRED';
               exit;
            end;
         end;
         SessionVarEval.Vars.Text := SessionAuthQuery.FieldByName('SessionVars').AsString;
         if OpenXMLGetTag('/CONFIGDATA/APIPARAMS/RETURNSESSIONVALUES') <> '' then begin
            SessionVarList := TStringList.Create;
            SessionVarList.CommaText := Trim(UpCaseString(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/RETURNSESSIONVALUES'))); //2017-01-12 Def # //2019-3-13 ss DVST-3483: Caps locking the config's RETURNSESSIONVALUES. Because the passed request will have tags that are caps locked. This will help in case-sensitive search. Also Reponse will have all tags in caps lock. Otherwise it was being return with lower case.
            for i := 0 to SessionVarList.Count-1 do begin
               if GetXMLTagStr(SessionVarEval.GetValueAsString(SessionVarList[i]),SessionVarList[i]) <> '' then begin //2017-06-07 jtm: D#1715
                  XMLResp.Add(SessionVarEval.GetValueAsString(SessionVarList[i]));
               end else begin
                  XMLResp.Add(' <'+SessionVarList[i]+'>'+ trim(SessionVarEval.GetValueAsString(SessionVarList[i])) +'</'+SessionVarList[i]+'>');
               end;
            end;
            TranSuccess := True;
            SessionVarList.Free;
         end else begin
            TranMessage := 'EMPTY SESSIONVALUES';
         end;
      end else begin
         TranMessage := 'SESSION NOT FOUND'; //2019-3-13 ss DVST-3483
      end;
      ProcessLog(ltInfo, 'PPGetSessionValues', 'End of PPGetSessionValues');
   end;

   procedure IVRAction; //2017-06-07 jtm: F#1857
   var
      IVRRequest : TIVRRequest;
      IVRRequestStr : string;
      IVRVXML : TIVRVXML;
      IVRRepsonse : string;
   begin
      PPRequestPayment; //create a session
      ProcessLog(ltInfo,'IVRACTION','Session Created:'+RNSessionID);
      XMLResp.Clear;
      XMLResp.Add('<TRANRESP>');
      IVRRequest := TIVRRequest.Create(PL.ProcessLog);
      IVRRequest.xmlRequest := APIXML;
      try
         IVRRequestStr := '';
         XMLResp.Add(' <RESPTYPE>' + TransactionType + 'RESP'+'</RESPTYPE>');
         if (IVRRequest.HasRequiredFields) then
            begin
               XMLResp.Add(' <RNID>' + IVRRequest.RNID + '</RNID>');
               IVRRequest.SessionID := RNSessionID;
               if (IVRRequest.SessionID <> '') then begin
                     XMLResp.Add(' <SESSION>' + IVRRequest.SessionID + '</SESSION>');
                     ProcessLog(ltInfo,'IVRACTION','InitiateOutboundCall');
                     IVRRepsonse := IVRRequest.InitiateOutboundCall(OpenXMLGetTag('/CONFIGDATA/IVR/STARTURL', 'https://'+ Request.Host + '/PPDEV?Page=TEMPUSIVR&SessionID=' + IVRRequest.SessionID), 'jason.smoker@tempustechnologies.com', '93175205').Text;
                     ProcessLog(ltInfo,'IVRACTION IVRRepsonse',IVRRepsonse);
               end else begin
                     TranSuccess := False;
                     TranMessage := 'OUTBOUND CALL NOT SUCCESSFUL.';
               end;


            end
         else
            begin
               TranSuccess := False;
               TranMessage := 'MISSING TAGS.';
            end;
      except
         On E:Exception do begin
            TranSuccess := False;
            TranMessage := 'OUTBOUND CALL NOT SUCCESSFUL.';
         end;
      end;

      FreeAndNil(IVRRequest);
   end;
   procedure PPExternalRequest;
   var
      ExternalRequestXML : TOpenXML;
      ExternalRequestNode : TOpenXMLNode;
      XMLFile,RequestXML,ExResponseXML,SoapAction,APIFilename,RequestURL  : string;
      ExRequest,ExResult : TStringList;
      HTTPStatus : integer;
   begin
      TranSuccess := False;
      ExRequest := TStringList.Create;
      ExResult := TStringList.Create;
      ExternalRequestNode := APIXML.GetNode('/TRANSACTION/REQUESTDATA');
      ExternalRequestNode := ExternalRequestNode.FindFirstChildElement;
      while ExternalRequestNode <> nil do begin
         VarEvaluator.AddValue(ExternalRequestNode.NodeName,ExternalRequestNode.TextContent);
         ExternalRequestNode := ExternalRequestNode.FindNextSiblingElement;
      end;
      ProcessLog(ltInfo,'PPExternalRequest VarEvaluator',VarEvaluator.Vars.Text);

      APIFilename := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/REQUESTNAME'),true,true,'-');
      XMLFile := LoadWebFileFromFolder(APIFilename+'.xml','');
      If Trim(XMLFile) = '' then begin
         TranMessage := 'NO EXTERNAL REQUEST FOUND';
         exit;
      end;
      Try
         ExternalRequestXML := TOpenXML.CreateFromString(Nil,XMLFile);
      except
         On E:Exception do begin
            Processlog(ltWarning, 'OpenXMLLoad Exception processing ExternalRequestXML',E.Message);
            If Assigned(ExternalRequestXML) then FreeAndNil(ExternalRequestXML);
            TranMessage := 'Exception Processing Request XML';
            exit;
         end;
      end;
      RequestURL := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/WEBAPIURL');
      SoapAction  := ExternalRequestXML.GetValueAsWideString('/EXTERNALREQUEST/SOAPACTION');
      RequestXML := ExternalRequestXML.GetXPathNodeAsXMLString('/EXTERNALREQUEST/REQUEST',false);
      DeleteXMLTag(RequestXML, 'REQUEST');
      ExRequest.Add(RequestXML);

      HTTPStatus := ExternalWebSvc(ExRequest,ExResult,RequestURL,'POST',SoapAction);
      ExResponseXML := ExResult.Text;
      ProcessLog(ltInfo,'PPExternalRequest Response: ', ExResponseXML);
      TranSuccess := True;
      if (ExResponseXML = '') then begin
         ExResponseXML := ExternalRequestXML.GetXPathNodeAsXMLString('/EXTERNALREQUEST/EXTERNALERROR',false);
         DeleteXMLTag(ExResponseXML, 'EXTERNALERROR');
         ProcessLog(ltWarning,'ExternalIntegration Failure','HTTPStatus:'+ IntToStr(HTTPStatus) + ' ExResponseXML:'+ExResponseXML);
         TranSuccess := false;
         TranMessage := 'EXTERNAL ERROR';
      end;

      XMLResp.Add(' <RESPTYPE>' + TransactionType + 'RESP'+'</RESPTYPE>');
      XMLResp.Add(' <RESPONSEDATA>' + ExResponseXML +'</RESPONSEDATA>');
      ExRequest.Free;
      ExResult.Free;
      FreeAndNil(ExternalRequestXML);

   end;
   Procedure PPGetCustomer;
   var
   email : string;
   AccountNum : string;
   CustRNID,CustGUID : string;
   Begin
      XMLResp.Add(' <RESPTYPE>'+TransactionType + 'RESP'+'</RESPTYPE>');
      Email := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/EMAIL'),True,True, '_.-#@+/');
      AccountNum := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/ACCOUNTNUMBER'),True,True,'_.-#/');
      CustRNID := NumericOnly(APIXML.GetValueAsWideString('/TRANSACTION/CUSTOMERRNID'));
      RNQuery.Close;
      RNQuery.SQL.Clear;
      If CustRNID = '' then
         RNQuery.SQL.Add('Select * from Customers where (ChainCode =  ' + Stri(ChainCode,-1) + ')')
      else
         RNQuery.SQL.Add('Select * from Customers where (Storecode =  ' + CustRNID + ')');

      if AccountNum <> '' then begin
         RNQuery.SQL.Add('and (AccountNumber =  ''' + AccountNum + ''')');
      end;
      if Email <> '' then begin
         RNQuery.SQL.Add('and (Email =  ''' + Email + ''')');
      end;
      RNQuery.Open;
      if RNQuery.RecordCount = 1 then begin
         CustGUID := Trim(RNQuery.FieldByName('CustomerCode').AsString);
         XMLResp.Add(' <CUSTGUID>'+CustGUID+ '</CUSTGUID>');
         RNQuery2.Close;
         RNQuery2.SQL.Clear;
         RNQuery2.SQL.Add('Select * from CustPayment where (CustGUID = '''+CustGUID + ''') and (Hidden = 0)');
         RNQuery2.Open;
         XMLResp.Add('  <CUSTPAYMENTS>');
         While Not RNQuery2.EOF do begin
            CustPaymentDSToXML(RNQuery2);
            RNQuery2.Next;
         end;
         TranSuccess := True;
         XMLResp.Add('  </CUSTPAYMENTS>');
      end else begin
         TranSuccess := false;
         TranMessage := 'CUSTOMER NOT FOUND';
      end;

   end;
   Procedure PPExternalAPITest;
   var
   APIXMLNode : TOpenXMLNode;
   returnvalue: string;
   Begin
      XMLResp.Add(' <RESPTYPE>'+TransactionType + 'RESP'+'</RESPTYPE>');

      APIXMLNode := APIXML.GetNode('/TRANSACTION').FindFirstChildElement;

      while (APIXMLNode <> nil) do begin
         VarEvaluator.AddValue(APIXMLNode.NodeName, APIXMLNode.TextContent);
         APIXMLNode := APIXMLNode.FindNextSiblingElement;
      end;
      ProcessLog(ltInfo, 'PPExternalAPITest VarEvaluator', VarEvaluator.Vars.Text);
      returnvalue := ProcessExternalPaymentPosts('');
      if (returnvalue <> '') then begin
         XMLResp.Add(' <RETURNVALUE>'+returnvalue + '</RETURNVALUE>');
         TranSuccess := True;
      end else begin
         TranSuccess := false;
         TranMessage := 'NOTHING RETURNED';
      end;

   end;
   Procedure PPExternalAuth;
   var
   AccessToken : string;
   LocationRNID : string;
   begin
      XMLResp.Add(' <RESPTYPE>'+TransactionType + 'RESP'+'</RESPTYPE>');
      TranSuccess := false;
      ProcessLog(ltInfo, 'PPExternalAuth xml', APIXML.DocumentAsString);
      AccessToken := trim(APIXML.GetValueAsWideString('/TRANSACTION/ACCESSTOKEN'));
      if (AccessToken <> '') then begin
         LocationRNID := NumericOnly(APIXML.GetValueAsWideString('/TRANSACTION/LOCIDENT'));
         if (LocationRNID = '') or (not (ValidateRNID(LocationRNID))) then begin
            LocationRNID := APIRNID;
         end;
         if strtobool(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/ALLOWOKTAEXTAUTH','FALSE')) then begin
            GetSessionID;
            if (AuthenticateOktaUser(AccessToken,LocationRNID)) then begin
               XMLResp.Add(' <SESSIONID>'+ RNSessionID + '</SESSIONID>');
               XMLResp.Add(' <CUSTGUID>'+ SessionVarEval.GetValueAsString('CUSTOMERS.CUSTOMERCODE') + '</CUSTGUID>');
               TranSuccess := True;
            end else begin
               TranMessage := 'AUTHENTICATION FAILED';
            end;
         end else begin
            TranMessage := 'EXTERNAL AUTH NOT ENABLED';
         end;
      end else begin
         TranMessage := 'ACCESSTOKEN EMPTY';
      end;
   end;
   procedure GetRequestDataAsStream;
   var
      BytesRead, ContentLength: Integer;
      Buffer: array[0..1023] of Byte;
   begin
      RequestStream := TStringStream.Create(RequestString);
      ContentLength := Request.ContentLength;
      ProcessLog(ltInfo, 'GetRequestDataAsStream', 'Begin while loop');
      while ContentLength > Length(Request.Content) do begin
         BytesRead := Request.ReadClient(Buffer[0], Min(ContentLength, SizeOf(Buffer)));
         if BytesRead < 1 then break;
         RequestStream.Write(Buffer[0], BytesRead);
         Dec(ContentLength, BytesRead);
      end;
      ProcessLog(ltInfo, 'GetRequestDataAsStream', 'Finish while loop');
      RequestStream.Position:= 0;
   end;

   procedure PPUpdateSession(); //2019-2-13 ss DVST-3483
   const
      METHOD_NAME = 'PPUpdateSession()'; // 2019-4-17 ss DVST-5434
   var
      SystemCode, SessionID, SQL, UpdateErrorMsg, MerchantSessionID, PPAPIRNID: String;
      UpdateTagList: TStringList;
      RecordCount: Integer;

      UsingMerchantSessionID, ForceExpire: boolean;
      ExpDate: TDateTime;
   begin
      try
         ProcessLog(ltInfo, 'PPUpdateSession', 'begin');
         XMLResp.Add(' <RESPTYPE>' + TransactionType + 'RESP</RESPTYPE>');
         TranSuccess := False;
         UpdateErrorMsg := '';
         RNSessionID := Trim(GuidOnly(APIXML.GetValueAsWideString('/TRANSACTION/SESSIONID')));
         SystemCode := Trim(APIXML.GetValueAsWideString('/TRANSACTION/SYSTEMCODE'));
         ProcessLog(ltInfo, METHOD_NAME, 'RNSessionID = ' + RNSessionID); // 2019-4-17 ss DVST-5434
         ProcessLog(ltInfo, METHOD_NAME, 'SystemCode = ' + SystemCode); // 2019-4-17 ss DVST-5434

         UsingMerchantSessionID := strtobool(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/CREATESESSION/USEMERCHANTSESSIONID', 'FALSE'));
         MerchantSessionID := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/MERCHANTSESSIONID'), true, true, '- ');
         PPAPIRNID := NumericOnly(APIXML.GetValueAsWideString('/TRANSACTION/RNID'));
         ForceExpire := strtobool(APIXML.GetValueAsWideString('/TRANSACTION/FORCEEXPIRE'));

         if UsingMerchantSessionID AND (MerchantSessionID <> '') then begin
            LookupRegistryFromMerchantSessionID(SessionAuthQuery, PPAPIRNID, MerchantSessionID);
         end else begin
            if((SystemCode = '') And (RNSessionID = '')) then begin
               TranMessage := 'EMPTY SYSTEMCODE AND SESSIONID';
               Exit;
            end;

            SessionAuthQuery.Close;
            SessionAuthQuery.SQL.Clear;
            SQL := GetPPSQLBySysCodeSessionIDRNID(XMLResp, APIRNID, SystemCode, RNSessionID);

         if(SQL = 'INTERNALERROR') then begin
               TranMessage := 'INTERNALERROR'; // generic error message
               ProcessLog(ltWarning, 'PPUpdateSession', 'INTERNALERROR @ GetPPSQLBySysCodeSessionIDRNID()');
               Exit;
            end else begin
               SessionAuthQuery.SQL.Add(SQL);
            end;
            SessionAuthQuery.Open;
         end;

         RecordCount := SessionAuthQuery.RecordCount;
         if RecordCount = 1 then begin // Since the combination of RNSessionID,  SYSTEMCODE and RNID are unique values in the record, there is no possibility of having multiple records, so not checking for RecordCount > 1. It should always be 1. If somehow there are more than one record or zero record, SESSION NOT FOUND is rturned.

            if ForceExpire AND UsingMerchantSessionID then begin
               ProcessLog(ltInfo, METHOD_NAME, 'Forcing Expiration of Session');
               ExpDate := Now;
               with SessionAuthQuery do begin
                  Edit();
                  FieldByName('OPTIONS').AsDateTime := ExpDate;
                  FieldByName('AUTHENTICATEDTILL').AsDateTime := ExpDate;
                  Post();
               end;
            end;

            if Trim(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/UPDATESESSIONVALUES')) <> '' then begin
               UpdateErrorMsg := UpdateSessionVarsByConfig(SessionAuthQuery, APIXML, Trim(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/UPDATESESSIONVALUES')));
            end else begin
               UpdateTagList := TStringList.Create();
               SetCurrentUpdateTagList(UpdateTagList); // since we are passing the address, it will be get filled through this function call
               if(UpdateTagList.Count > 0) then begin
                  UpdateErrorMsg := UpdateSessionVarsByUpdateTagList(SessionAuthQuery, APIXML, UpdateTagList);
               end else begin
                  UpdateErrorMsg := 'INTERNALERROR';
                  ProcessLog(ltWarning,'PPUpdateSession','UpdateTagList.Count = 0. No tags to update. Check SetCurrentUpdateTagList()');// this should never happen in prod. Developer notes: make sure SetCurrentUpdateTagList() is updating the passed stringlist. And there are tags being added to the passed TStringList.
               end;
               FreeAndNil(UpdateTagList);
            end;
         end else begin
            UpdateErrorMsg := 'SESSION NOT FOUND';
         end;
         if(UpdateErrorMsg = '') then begin
            TranSuccess := True;
            TranMessage := 'SESSION UPDATED';
         end else begin
            TranSuccess := False;
            TranMessage := UpdateErrorMsg;
         end;
         ProcessLog(ltInfo, 'PPUpdateSession', 'end'); // 2019-4-17 ss DVST-5434
      except
         on E: Exception do begin
            TranSuccess := False;
            TranMessage := 'INTERNALERROR';
            ProcessLog(ltWarning, 'PPUpdateSession','INTERNALERROR @ PPUpdateSession():'+E.Message);
         end;
      end;
   end;

begin
Try
   APITime := Now;
   TranSuccess := False;
   TranMessage := '';
   RequestString := '';
   Response.ContentType := 'text/XML';
   Response.Expires := -1;
   Response.CustomHeaders.Values['Cache-Control'] := 'no-cache';
      VarEvaluator.ClearAll;
   APIXML := nil;
   XMLResp := TStringList.Create;
   XMLResp.Add('<TRANRESP>');

     APIRNID := VarEvaluator.GetValueAsString('PPAPIRNID');
      APIRNID := RNLoadHostName;
   If APIRNID = '' then begin
      TranMessage := 'INVALID HOSTNAME';
      FinalizeXMLRespAndFree;
      Exit;
   end;

   If OpenXMLGetTag('/CONFIGDATA/APIPARAMS/APIENABLED') <> 'TRUE' then begin
      TranMessage := 'API NOT ENABLED FOR THIS DOMAIN';
      FinalizeXMLRespAndFree;
      exit;
   end;

   If strtobool(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/CORSENABLED','FALSE')) then begin
      ProcessLog(ltInfo, 'PPAPI CORSENABLED; RefererURL before trim', Request.Referer);
      RefererURL := ExtractDomainWithScheme(Request.Referer);
      ProcessLog(ltInfo, 'PPAPI CORSENABLED; RefererURL', RefererURL);
      ConfigStr := '/CONFIGDATA/APIPARAMS/CORSSITES/SITE[URL="' + trim(RefererURL) + '"]/ENABLED';
      ProcessLog(ltInfo, 'PPAPI CORSENABLED; configstr', ConfigStr);
      if strtobool(OpenXMLGetTag(ConfigStr,'FALSE')) then begin
         ProcessLog(ltInfo, 'PPAPI CORSENABLED; RefererURL ' +RefererURL+ ' found','adding headers');
         Response.CustomHeaders.Values['Access-Control-Allow-Origin'] := RefererURL;
         Response.CustomHeaders.Values['Access-Control-Allow-Credentials'] := 'true';
         Response.CustomHeaders.Values['Access-Control-Allow-Methods'] := 'GET, POST, PUT, DELETE, OPTIONS';
      end;
   end;

   PL.AddAppValue('RNID',APIRNID);
   ProcessLog(ltInfo, 'content length:', IntToStr(Request.ContentLength));
   ProcessLog(ltInfo, 'content string length:', IntToStr(Length(Request.Content)));
   if (IntToStr(Length(Request.Content)) <> IntToStr(Request.ContentLength)) then begin
      Try
         ProcessLog(ltInfo, 'PPAPI', 'large request packet, get rest of packet as stream');
         GetRequestDataAsStream;
         RequestString := RequestStream.ReadString(RequestStream.Size);
      except
         On E:Exception do begin
            ProcessLog(ltWarning, 'Data stream error: ', E.Message);
            TranMessage := 'DATA STREAM ERROR';
            RequestStream.Free;
            FinalizeXMLRespAndFree;
            exit;
         end;
      end;
   end;

   Try
      APIXML := TOpenXML.CreateFromString(Nil,Request.Content + RequestString);
   except
      On E:Exception do begin
         ProcessLog(ltWarning, 'XML Error: ', E.Message);
         TranMessage := 'XML PARSE ERROR';
         FinalizeXMLRespAndFree;
         exit;
      end;
   end;

   TransactionType := APIXML.GetValueAsWideString('/TRANSACTION/TRANSACTIONTYPE');

   PL.AddAppValue('TRANSACTIONTYPE',TransactionType);
   if (TransactionType = 'PPEXTERNALAUTH') then begin //2018-09-12 jtm: DVST-1392
      ProcessLog(ltInfo,'Starting PPEXTERNALAUTH',InstanceGUID);
      PPExternalAuth;
      FinalizeXMLRespAndFree;
      exit;
   end else if (strtobool(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/USESESSIONAUTH','FALSE')) and (APIXML.GetValueAsWideString('/TRANSACTION/RNCERT')=''))  then begin  //2018-09-12 jtm: DVST-1392
      if (GuidOnly(Request.QueryFields.Values['SESSIONID'])= '') or not ValidateSessionID then begin
         TranMessage := 'INVALID SESSION';
         FinalizeXMLRespAndFree;
         exit;
      end else begin
         if (SessionVarEval.GetValueAsString('APIRNID') <> '') then begin
            APIRNID := SessionVarEval.GetValueAsString('APIRNID');
         end;
         CUSTGUID := SessionVarEval.GetValueAsString('CUSTOMERS.CUSTOMERCODE');
         processlog(ltinfo, 'Session authenticated ppapi custguid: ', CUSTGUID);
      end;
   end else begin
      If APIXML.GetValueAsWideString('/TRANSACTION/RNID')= '' then begin
         TranMessage := 'RNID EXPECTED';
         FinalizeXMLRespAndFree;
         exit;
      end;

      if strtobool(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/ALLOWMULTIRNIDAUTH','FALSE')) then begin //2018-09-12 jtm: DVST-100
         if not ValidateCert(APIXML.DocumentAsString,TranSuccess,TranMessage) then begin
            ProcessLog(ltWarning, 'INVALID RNCERT', APIXML.GetValueAsWideString('/TRANSACTION/RNID'));
            FinalizeXMLRespAndFree;
            exit;
         end else begin
            if (APIXML.GetValueAsBoolean('/TRANSACTION/USEAUTHRNID')) then begin
               APIRNID := APIXML.GetValueAsWideString('/TRANSACTION/RNID');
            end;
         end;
      end else begin
         If APIXML.GetValueAsWideString('/TRANSACTION/RNID') <> APIRNID  then begin
            TranMessage := 'RNID MISMATCH';
            ProcessLog(ltWarning, 'PPAPI RNID MISMATCH', APIXML.GetValueAsWideString('/TRANSACTION/RNID'));
            FinalizeXMLRespAndFree;
            exit;
         end;

         If APIXML.GetValueAsWideString('/TRANSACTION/RNCERT') <> OpenXMLGetTag('/CONFIGDATA/APIPARAMS/APICERT')  then begin
            TranMessage := 'INVALID RNCERT';
            FinalizeXMLRespAndFree;
            exit;
         end;
      end;
   end;

   ClientTxnGUID := ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/TXNAUTH'),True,True,' -');
   if ClientTxnGUID = '' then ClientTxnGUID := GenerateGUID;

   PL.AddAppValue('CLIENTTXNGUID',ClientTxnGUID);

   If TransactionType = 'PPGETCUSTPAYMENTMETHODS' then Begin
      ProcessLog(ltInfo,'Starting PPGETCUSTPAYMENTMETHODS',InstanceGUID);
      PPGetCustPaymentMethods;
      FinalizeXMLRespAndFree;
      exit;
   end;

   If TransactionType = 'PPCUSTCANCELSCHEDULE' then Begin
      ProcessLog(ltInfo,'Starting PPCUSTCANCELSCHEDULE',InstanceGUID);
      PPCustCancelSchedule;
      FinalizeXMLRespAndFree;
      exit;
   end;

   If TransactionType = 'PPDELETEPAYMENTMETHOD' then Begin
      ProcessLog(ltInfo,'Starting PPDELETEPAYMENTMETHOD',InstanceGUID);
      PPDeletePaymentMethod;
      FinalizeXMLRespAndFree;
      exit;
   end;

   If TransactionType = 'PPGETCUSTPAYSCHED' then begin
      ProcessLog(ltInfo,'Starting PPGETCUSTPAYSCHED',InstanceGUID);
      PPGetCustPaySched;
      FinalizeXMLRespAndFree;
      exit;
   end;
   If TransactionType = 'PPGETCUSTPAYSCHEDDETAIL' then begin
      ProcessLog(ltInfo,'Starting PPGETCUSTPAYSCHEDDETAIL',InstanceGUID);
      PPGetCustPaySchedDetail;
      FinalizeXMLRespAndFree;
      exit;
   end;


   If TransactionType = 'PPCUSTADDCHILD' then begin
      ProcessLog(ltInfo,'Starting PPCUSTADDCHILD',InstanceGUID);
      PPCustAddChild;
      FinalizeXMLRespAndFree;
      exit;
   end;

   If TransactionType = 'PPGETCUSTCHILDREN' then begin
      ProcessLog(ltInfo,'Starting PPGETCUSTCHILDREN',InstanceGUID);
      PPGetCustChildren;
      FinalizeXMLRespAndFree;
      exit;
   end;

   If TransactionType = 'PPCUSTADDPAYMENTCARD' then begin
      ProcessLog(ltInfo,'Starting PPCUSTADDPAYMENTCARD',InstanceGUID);
      PPCustAddPaymentCard;
      FinalizeXMLRespAndFree;
      exit;
   end;

   If TransactionType = 'PPCUSTADDPAYMENTCHECK' then begin
      ProcessLog(ltInfo,'Starting PPCUSTADDPAYMENTCHECK',InstanceGUID);
      PPCustAddPaymentCheck;
      FinalizeXMLRespAndFree;
      exit;
   end;

   If TransactionType = 'PPCUSTADDUPDATE' then begin
      ProcessLog(ltInfo,'Starting PPCUSTADDUPDATE',InstanceGUID);
      PPCUSTADDUPDATE;
      FinalizeXMLRespAndFree;
      exit;
   end;

   If TransactionType = 'PPCUSTADDSCHEDULE' then begin
      ProcessLog(ltInfo,'Starting PPCUSTADDSCHEDULE',InstanceGUID);
      PPCUSTADDSCHEDULE;
      FinalizeXMLRespAndFree;
      exit;
   end;
   If TransactionType = 'PPCUSTMAKEPAYMENT' then begin
      ProcessLog(ltInfo,'Starting PPCUSTMAKEPAYMENT',InstanceGUID);
      PPCUSTMAKEPAYMENT;
      FinalizeXMLRespAndFree;
      exit;
   end;

   If TransactionType = 'PPGETPAYMENTHISTORY' then begin
      ProcessLog(ltInfo,'Starting PPGETPAYMENTHISTORY',InstanceGUID);
      PPGETPAYMENTHISTORY;
      FinalizeXMLRespAndFree;
      exit;
   end;

   If TransactionType = 'PPREPORTGETSCHEDULES' then begin
      ProcessLog(ltInfo,'Starting PPREPORTGETSCHEDULES',InstanceGUID);
      PPReportGetSchedules;
      exit;
   end;

   If TransactionType = 'PPREQUESTPAYMENT' then begin
      ProcessLog(ltInfo, 'Starting PPREQUESTPAYMENT', InstanceGUID);
      if strtobool(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/PPREQUESTPAYMENT/USEOLDFUNCTION', 'FALSE')) then begin
         PPRequestPayment();
      end else begin
         PPRequestPaymentOld(); // TODO: remove once above function is confirmed as working in production
      end;
      FinalizeXMLRespAndFree;
      exit;
   end;
   If TransactionType = 'CREATESESSION' then begin
      ProcessLog(ltInfo,'Starting CREATESESSION', InstanceGUID);
      CreateSession(nil);
      FinalizeXMLRespAndFree;
      exit;
   end;
   If TransactionType = 'PPAUTHENTICATEUSER' then begin
      ProcessLog(ltInfo,'Starting PPAUTHENTICATEUSER',InstanceGUID);
      PPAuthenticateUser;
      FinalizeXMLRespAndFree;
      exit;
   end;
   If TransactionType = 'PPSENDNOTIFICATION' then begin
      ProcessLog(ltInfo,'Starting PPSENDNOTIFICATION',InstanceGUID);
      PPSendNotification;
      FinalizeXMLRespAndFree;
      exit;
   end;
   If TransactionType = 'PPGETSESSIONVALUES' then begin
      ProcessLog(ltInfo,'Starting PPGETSESSIONVALUES',InstanceGUID);
      PPGetSessionValues;
      FinalizeXMLRespAndFree;
      exit;
   end;
   If TransactionType = 'IVRACTION' then begin //2017-06-07 jtm: F#1857
      ProcessLog(ltInfo,'Starting IVRACTION',InstanceGUID);
      IVRAction;
      FinalizeXMLRespAndFree;
      exit;
   end;
   If (TransactionType = 'PPEXTERNALREQUEST') and (OpenXMLGetTag('/CONFIGDATA/APIPARAMS/ALLOWEXTERNALREQUESTS','FALSE')='TRUE')then begin //2017-06-07 jtm: F#1857
      ProcessLog(ltInfo,'Starting IVRACTION',InstanceGUID);
      PPExternalRequest;
      FinalizeXMLRespAndFree;
      exit;
   end;
   If TransactionType = 'PPGETCUSTOMER' then begin //2017-08-16 jtm: F##1921
      ProcessLog(ltInfo,'Starting PPGETCUSTOMER',InstanceGUID);
      PPGetCustomer;
      FinalizeXMLRespAndFree;
      exit;
   end;
   if TransactionType = 'PPEXTERNALAPITEST' then begin
      ProcessLog(ltInfo,'Starting EXTERNALAPITEST',InstanceGUID);
      PPExternalAPITest;
      FinalizeXMLRespAndFree;
      exit;
   end;
   if TransactionType = 'PPUPDATESESSION' then begin // 2019-3-13 ss DVST-3483
      ProcessLog(ltInfo,'Starting ',InstanceGUID);
      PPUpdateSession;
      FinalizeXMLRespAndFree;
      exit;
   end;

   FinalizeXMLRespAndFree;

Except
   ON E:EXception do begin
      processLog(ltWarning, 'PPAPI Exception', E.ClassName + ': ' + E.Message);
      TranMessage := E.Message;
      FinalizeXMLRespAndFree;
   end;
end;

end;

procedure TCustomerInfoModule.findPaymentMethodByCustomerAndPaymentMethod(const CustGUID, PaymentGUID : string);
const
   CHECK_PAYMENT_TOKEN = 'SELECT TOP 1 CUSTGUID, PAYMENTGUID, HIDDEN, PAYMENTTOKEN FROM CustPayment WHERE CUSTGUID = :custGUID AND PAYMENTGUID = :paymentGUID';
var
   CheckedCustGUID, CheckedPaymentGUID: string;
begin
   CheckedCustGUID := GuidOnly(CustGUID);
   CheckedPaymentGUID := GuidOnly(PaymentGUID);

   RNQuery.Close;
   RNQuery.SQL.Clear;
   RNQuery.SQL.Add(CHECK_PAYMENT_TOKEN);
   RNQuery.Parameters.ParamByName('custGUID').Value := CheckedCustGUID;
   RNQuery.Parameters.ParamByName('paymentGUID').Value := CheckedPaymentGUID;
   RNQuery.Prepared := True;
   RNQuery.Open;
end;

Function TCustomerInfoModule.DeletePaymentMethod(const CustGUID, RNID : String; InputXML : TOpenXML) : boolean;
var
   paymentToken, paymentGUID, custGUIDL, appServerSI, responseStr: String;
   appServerSIIsConfigured, deleteWasSuccessful: boolean;
   ResponseXML: TOpenXML;
   Gateway: TPPSAPIWeb;
begin
   Result := False;
   paymentGUID := GuidOnly(InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTGUID'));

   findPaymentMethodByCustomerAndPaymentMethod(CustGUID, paymentGUID);
   if RNQuery.RecordCount = 1 then begin
      if strtobool(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/USEREPDELETE', 'FALSE')) then begin
         paymentToken := RNQuery.FieldByName('PAYMENTTOKEN').AsString;
         appServerSI := trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', ''));

         Gateway := TPPSAPIWeb.Create(ProcessPPSAPIXML, ProcessLog, GetAppServerHost, RNID, appServerSI);
         responseStr := Gateway.Repdelete(paymentToken);
         try
            ResponseXML := TOpenXML.CreateFromString(nil, responseStr);
         except
            on E: Exception do begin
               ProcessLog(ltWarning, 'TCustomerInfoModule.DeletePaymentMethod', 'Invalid Response XML');
               exit;
            end;
         end;
         deleteWasSuccessful := strtobool(ResponseXML.GetValueAsWideString('/TRANRESP/TRANSUCCESS'));
      end else begin
         deleteWasSuccessful := true;
      end;

      if deleteWasSuccessful then begin
         RNQuery.Edit;
         RNQuery.FieldByName('hidden').AsBoolean := True;
         RNQuery.Post;
      end else begin
         ProcessLog(ltWarning, 'TCustomerInfoModule.DeletePaymentMethod Deletion Error', ResponseXML.GetValueAsWideString('/TRANRESP/TRANRESPMESSAGE'));
      end;

      Result := deleteWasSuccessful;
      FreeAndNil(ResponseXML);
      FreeAndNil(Gateway);
   end;
end;

Function TCustomerInfoModule.AddCardToAccount(const CustGUID, RNID : String; InputXML : TOpenXML; CardDetails: TStringList = nil) : boolean;
Var
  ExpDate : TDateTime;
  CNum : String;
  XMLResp :TStringList;
  BinResp : TStringList;
  WS : String;
  BinRespDesc : String;
  RepToken : String;
  PaymentName: String;          //2014-09-26 bah:
  CardType : string;
  CardEventParms : string; //2017-08-02 jtm: F#2035
  IDTechDecrypt : TIDTechDecrypt; //2017-08-16 jtm: F#2082
  TATokenNumber : String; //2017-10-26 ajs: F#2213
  TATokenProviderId : String; //2017-10-26 ajs: F#2213
begin
   Result := False;    
   RNQuery.Close;
   RNQuery.SQL.Clear;
   RNQuery.SQL.Add('Select * from CustPayment where (CustGUID = '''+CustGUID + ''')');
   RNQuery.Open;
   RNQuery.Insert;
   RNQuery.FieldByName('CustGUID').AsString := CustGUID;
   RNQuery.FieldByName('PaymentGUID').AsString := GenerateGUID;
   RNQuery.FieldByName('PaymentType').AsString := 'CARD';
   RNQuery.FieldByName('ServiceName').AsString := 'CARD';
   RepToken := '';
   CardEventParms := '';
   TATokenNumber := '';
   TATokenProviderId := '';
   ExpDate := 0;
   If InputXML <> NIL then begin
      RNQuery.FieldByName('CardAccountHolder').AsString := ValidCharsOnly(UpCaseString(Trim(InputXML.GetValueAsWideString('/TRANSACTION/CARDNAME'))),True, True, ' ');
      CNum := NumericOnly(InputXML.GetValueAsWideString('/TRANSACTION/CCACCOUNT'));
      RNQuery.FieldByName('CardAccount').AsString := MaskStr(CNum,DigitsToMask(CNum));
      ExpDate := ExpMMslashYYToDateTime(InputXML.GetValueAsWideString('/TRANSACTION/CCEXP'));
      RNQuery.FieldByName('CardExpires').AsDateTime := ExpDate;
      RNQuery.FieldByName('PaymentAddress').AsString := ValidCharsOnly(UpCaseString(Trim(InputXML.GetValueAsWideString('/TRANSACTION/CCBILLADDRESS'))),True, True, ' ');
      RNQuery.FieldByName('PaymentCity').AsString := ValidCharsOnly(UpCaseString(Trim(InputXML.GetValueAsWideString('/TRANSACTION/CCBILLCITY'))),True, True, ' ');
      RNQuery.FieldByName('PaymentState').AsString := ValidCharsOnly(UpCaseString(Trim(InputXML.GetValueAsWideString('/TRANSACTION/CCBILLSTATE'))),True,False,'');
      RNQuery.FieldByName('PaymentZip').AsString := NumericOnly(Trim(InputXML.GetValueAsWideString('/TRANSACTION/CCBILLZIP')));
      PaymentName := ValidCharsOnly(UpCaseString(Trim(InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTNAME'))),True, True, ' -');    //2014-09-26 bah:
      RepToken := AlphaNumericOnly(Trim(InputXML.GetValueAsWideString('/TRANSACTION/REPTOKEN')));
      CardEventParms := Trim(InputXML.GetXPathNodeAsXMLString('/TRANSACTION/CARDEVENTPARAMS',false));
      TATokenNumber := Trim(InputXML.GetValueAsWideString('/TRANSACTION/REPTRANSARMORTOKEN'));
      TATokenProviderId := Trim(InputXML.GetValueAsWideString('/TRANSACTION/REPTRANSARMORTOKENPROVIDERID'));
   end else begin
      RNQuery.FieldByName('CardAccountHolder').AsString := ValidCharsOnly(UpCaseString(Trim(Request.ContentFields.Values['CardName'])),True, True, ' ');
      CardEventParms := Trim(Request.ContentFields.Values['CARDEVENTPARAMS']);
      CNum := NumericOnly(Request.ContentFields.Values['RetypeNumber']);
      TATokenNumber := NumericOnly(Request.ContentFields.Values['VTTokenNumber']); //2017-10-26 ajs: F#2213
      TATokenProviderId := NumericOnly(Request.ContentFields.Values['providerId']); //2017-10-26 ajs: F#2213
      RNQuery.FieldByName('CardAccount').AsString := MaskStr(CNum,DigitsToMask(CNum));
      if CardEventParms = '' then begin
         ExpDate := EncodeDate(Valu(NumericOnly(Request.ContentFields.Values['EXPYEAR'])),Valu(NumericOnly(Request.ContentFields.Values['EXPMONTH'])),1);
         RNQuery.FieldByName('CardExpires').AsDateTime := ExpDate;
      end;
      RNQuery.FieldByName('PaymentAddress').AsString := ValidCharsOnly(UpCaseString(Trim(Request.ContentFields.Values['CCBillAddress'])),True, True, ' ');
      RNQuery.FieldByName('PaymentCity').AsString := ValidCharsOnly(UpCaseString(Trim(Request.ContentFields.Values['CCBillCity'])),True, True, ' ');
      RNQuery.FieldByName('PaymentState').AsString := ValidCharsOnly(UpCaseString(Trim(Request.ContentFields.Values['CCBillState'])),True,False,'');
      RNQuery.FieldByName('PaymentZip').AsString := NumericOnly(Trim(Request.ContentFields.Values['CCBillZip']));
      PaymentName := '';
   end;

   CardType := ComputeCardTypeEx(Cnum);
   RNQuery.FieldByName('CardType').AsString := CardType;  //2017-03-22 F#1599
   if (PaymentName = '') then begin     //2014-09-26 bah:
        if CNum = '' then begin //2018-04-13 F#4364 bls
            CardType := ComputeCardTypeEx('',TATokenProviderId);
            PaymentName := CardType + ' ' + MaskStr(TATokenNumber,DigitsToMask(TATokenNumber));
        end else begin
            PaymentName := CardType + ' ' + MaskStr(CNum,DigitsToMask(CNum));
        end;
   end;
   RNQuery.FieldByName('PaymentName').AsString := PaymentName;
   RNQuery.FieldByName('DateAdded').AsDateTime := Now;

   if Reptoken = '' then begin
      XMLResp := TStringList.Create;
      WS := '<TRANSACTION>' +
                           ' <RNID>'+RNID +'</RNID>' +
                           ' <TRANSACTIONTYPE>REPADDDATA</TRANSACTIONTYPE>' +
                           ' <REPACCOUNTAVS>'+Trim(Request.ContentFields.Values['CCBillZip'])+'</REPACCOUNTAVS>' +
                           ' <REPCUSTIDENT>'+Trim(RNQuery.FieldByName('PaymentGUID').AsString)+'</REPCUSTIDENT>';
      if CardEventParms <> '' then begin //2017-08-02 jtm: F#2035
         WS := WS + '<INCLUDECCBINDETAIL>TRUE</INCLUDECCBINDETAIL>';
         if NumericOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCDEVICETYPE'))) = '3' then begin
            IDTechDecrypt := TIDTechDecrypt.Create(Trim(GetXMLTagStr(CardEventParms,'ENCDVCENCRYPTEDBLOCK')), PL.ProcessLog);
            WS := WS + IDTechDecrypt.GenerateCardEventParmsXML;
         end else if NumericOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCDEVICETYPE'))) = '6' then begin
            WS := WS + CardEventParms;
         end else begin
           WS := WS +  '<CARDEVENTPARAMS>'+
                        '<MTKSN>'+ ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'MTKSN')),True,True,'') +'</MTKSN>'+
                        '<MTSESSIONID>' + Trim(GetXMLTagStr(CardEventParms,'MTSESSIONID')) + '</MTSESSIONID>'+
                        '<MTENCRYPTEDTRACK1>' + Trim(GetXMLTagStr(CardEventParms,'MTENCRYPTEDTRACK1')) + '</MTENCRYPTEDTRACK1>'+
                        '<MTENCRYPTEDTRACK2>' + Trim(GetXMLTagStr(CardEventParms,'MTENCRYPTEDTRACK2')) + '</MTENCRYPTEDTRACK2>'+
                        '<MTDEVICESERIAL>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'MTDEVICESERIAL')),True,True,'') + '</MTDEVICESERIAL>'+
                        '<MTMPDATA>' + Trim(GetXMLTagStr(CardEventParms,'MTMPDATA')) + '</MTMPDATA>'+
                        '<MTMPSTATUS>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'MTMPSTATUS')),True,True,'') + '</MTMPSTATUS>'+
                     '</CARDEVENTPARAMS>';
         end;
      end else if TATokenNumber <> '' then begin //2017-10-26 ajs: F#2213
         WS := WS + ' <REPTRANSARMORTOKEN>'+TATokenNumber+'</REPTRANSARMORTOKEN>' +
                    ' <REPTRANSARMORTOKENPROVIDERID>'+TATokenProviderId+'</REPTRANSARMORTOKENPROVIDERID>' +
                    ' <REPACCOUNTEXP>'+formatDateTime('MM/YY',ExpDate)+'</REPACCOUNTEXP>';
      end else begin
         WS := WS +' <REPACCOUNTNUMBER>'+CNUM+'</REPACCOUNTNUMBER>'+
                   ' <REPACCOUNTEXP>'+formatDateTime('MM/YY',ExpDate)+'</REPACCOUNTEXP>';
      end;

      if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then    //2016-9-19 jtm: Feat OT# 1145
         WS := WS + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';

      WS := WS + ' </TRANSACTION>'+CRLF;
      VarEvaluator.AddValue('GatewayRNID',RNID);//2017-05-24 jtm: F#1821
      ProcessPPSAPIXML(WS, XMLResp,GetAppServerHost,0);

      if (strtobool(GetXMLTag(XMLResp, 'TRANSUCCESS'))) then begin
         RNQuery.FieldByName('PaymentToken').AsString := GetXMLTag(XMLResp,'REPTOKEN');
         BinResp :=TStringList.Create;
         if CardEventParms <> '' then begin //2017-08-02 jtm: F#2035
            RNQuery.FieldByName('CardAccount').AsString := GetXMLTag(XMLResp,'REPACCOUNTNUMBER');
            CardType := GetXMLTag(XMLResp,'CCCARDTYPEEX');
            RNQuery.FieldByName('PaymentName').AsString := CardType+ ' ' + GetXMLTag(XMLResp,'REPACCOUNTNUMBER');
            RNQuery.FieldByName('CardType').AsString := CardType;
            if (GetXMLTag(XMLResp,'REPACCOUNTEXP') <> '') and (length(GetXMLTag(XMLResp,'REPACCOUNTEXP'))=5) then
               ExpDate := EncodeDate(Valu('20'+NumericOnly(RightStr(GetXMLTag(XMLResp,'REPACCOUNTEXP'),2))),Valu(NumericOnly(LeftStr(GetXMLTag(XMLResp,'REPACCOUNTEXP'),2))),1);
            RNQuery.FieldByName('CardExpires').AsDateTime := ExpDate;
            RNQuery.FieldByName('CardIssueType').AsString := GetXMLTag(XMLResp,'CARDISSUETYPE');
            RNQuery.FieldByName('CardTypeDesc').AsString := GetXMLTag(XMLResp,'CARDTYPEDESC');
            RNQuery.FieldByName('CardCountryCode').AsString := GetXMLTag(XMLResp,'COUNTRYCODE');
            RNQuery.FieldByName('CardBankName').AsString := GetXMLTag(XMLResp,'BANKNAME');
            RNQuery.FieldByName('CardCommercial').AsBoolean := GetXMLTag(XMLResp,'COMMERCIAL') = 'TRUE';
         end else if (TATokenNumber <> '') then begin //2017-10-26 ajs: F#2213
            CardType := ComputeCardTypeEx('', TATokenProviderId);
            RNQuery.FieldByName('PaymentName').AsString := CardType+ ' ' + MaskStr(GetXMLTag(XMLResp,'TRANSARMORTOKEN'), DigitsToMask(GetXMLTag(XMLResp,'TRANSARMORTOKEN')));
            RNQuery.FieldByName('CardType').AsString := CardType;
            if (GetXMLTag(XMLResp,'REPACCOUNTEXP') <> '') and (length(GetXMLTag(XMLResp,'REPACCOUNTEXP'))=5) then
               ExpDate := EncodeDate(Valu('20'+NumericOnly(RightStr(GetXMLTag(XMLResp,'REPACCOUNTEXP'),2))),Valu(NumericOnly(LeftStr(GetXMLTag(XMLResp,'REPACCOUNTEXP'),2))),1);
            RNQuery.FieldByName('CardExpires').AsDateTime := ExpDate;
         end else if GetBinDetails(RNQuery2,CNum,BINResp,BinRespDesc) then begin
            RNQuery.FieldByName('CardIssueType').AsString := GetXMLTag(BINResp,'CARDISSUETYPE');
            RNQuery.FieldByName('CardTypeDesc').AsString := GetXMLTag(BINResp,'CARDTYPEDESC');
            RNQuery.FieldByName('CardCountryCode').AsString := GetXMLTag(BINResp,'COUNTRYCODE');
            RNQuery.FieldByName('CardBankName').AsString := GetXMLTag(BINResp,'BANKNAME');
            RNQuery.FieldByName('CardCommercial').AsBoolean := GetXMLTag(BINResp,'COMMERCIAL') = 'TRUE';
         end;
         BinResp.Free;
         XMLResp.Free;
      end else begin
         Result := False;
         exit;
      end;
   end else begin
      RNQuery.FieldByName('PaymentToken').AsString := Reptoken;
   end;

   VarEvaluator.AddDSCurrentRecord(RNQuery, 'CustPayment');

   RNQuery.Post;
   Result := TRUE;
end;


Function TCustomerInfoModule.LoadSchedGUIDToVars(AScheduleGUID : String; SiteRNID : String; LoadVars : TVarEval) : boolean;
var
   AQuery : TADOQuery;
begin
   Result := False;
   AScheduleGUID := GuidOnly(AScheduleGUID);
   If AScheduleGUID = '' then exit;
   AQuery := NewADOQuery;
   if(StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE'))) then begin // 2019-1-30 SS DVST:3951
      AQuery.SQL.Text := buildCustPaySchedTablsDateColsPerCustTimeZone(AScheduleGUID, SiteRNID);
   end else begin
      AQuery.SQL.Add('Select * from custPaySched where (siteRNID = ' + SiteRNID + ')');
      AQuery.SQL.Add('and (PaySchedGuid = ''' + AScheduleGUID + ''')');
   end;
   AQuery.Open;
   Result :=AQuery.RecordCount = 1;
   LoadVars.AddDSCurrentRecord(AQuery, 'CustPaySched');
   AQuery.Close;
   AQUery.Free;
end;

Function TCustomerInfoModule.LoadCustGUIDToVars(CustGUID : String; LoadVars : TVarEval) : boolean;
var
   AQuery : TADOQuery;
begin
   Result := False;
   CustGUID := GuidOnly(CustGUID);
   If CustGUID = '' then exit;
   AQuery := NewADOQuery;
   AQuery.SQL.Add('Select * from Customers where (ChainCode = ' + Stri(ChainCode,-1) + ')');
   AQuery.SQL.Add('and (CustomerCode = ''' + CustGUID + ''')');
   AQuery.Open;
   Result :=AQuery.RecordCount = 1;
   LoadVars.AddDSCurrentRecord(AQuery, 'Customers');
   AQuery.Close;
   AQUery.Free;
end;

Function TCustomerInfoModule.LoadRNIDToVars(ARNID: String; LoadVars: TVarEval): boolean;
var
   AQuery : TADOQuery;
begin
   Result := False;
   ARNID := NumericOnly(ARNID);
   If ARNID = '' then exit;
   AQuery := NewADOQuery;
   AQuery.SQL.Add('Select * from store where systemcode = ' + ARNID);
   AQuery.Open;
   Result := AQuery.RecordCount = 1;
   LoadVars.AddDSCurrentRecord(AQuery, 'Location');
   AQuery.Close;
   AQUery.Free;
end;


Function TCustomerInfoModule.NewAdoQuery : TADOQuery;
var
   AQuery : TADOQuery;
Begin
   AQuery := TADOQuery.Create(Nil);
   AQuery.Connection := RNDB;
   AQuery.CursorType :=  ctKeySet;
   AQuery.CursorLocation := clUseClient;

   Result := AQuery;

end;


Function TCustomerInfoModule.ComputeSchedule(AScheduleGUID : String; RNID : String;Increment : Boolean;Email : string) : Integer;
var
   AQuery : TADOQuery;
   PaymentCount : Integer;
   AmountPaid : Currency;
   SchedQuery : TAdoQuery;
   PaymentsRemaining : Real;
   AmountOwed : Currency;
   year,month,Day : Word; //2017-09-25 jtm: D#1501
   PaymentsRemaining2 : integer;
Begin
   AQuery := NewADOQuery;
   AQuery.SQL.Clear;
   AQuery.SQL.Add('Select Count(*) as PaymentCount, Sum(PaymentAmount) as AmountPaid from CustPaymentHistory');
   AQuery.SQL.Add('Where (SiteRNID =' + NumericOnly(RNID) + ') and (PaySchedGUID = ''' + GuidOnly(AscheduleGUID) + ''')');
   AQuery.SQL.Add('and (ApprovalCode <> '''')');
   AQuery.Open;
   PaymentCount := AQuery.FieldByName('PaymentCount').AsInteger;
   AmountPaid := AQuery.FieldByName('AmountPaid').AsCurrency;
   AQuery.Close;
   AQuery.Free;

   SchedQuery := NewADOQuery;
   SchedQuery.SQL.Add('Select * from CustPaySched where (SiteRNID =' + NumericOnly(RNID) + ') and (PaySchedGUID = ''' + GuidOnly(AscheduleGUID) + ''')');
   SchedQuery.Open;
   If SchedQuery.RecordCount = 1 then begin
      SchedQuery.Edit;
      SchedQuery.FieldByName('AmountPaid').AsCurrency := AmountPaid;
      SchedQuery.FieldByName('PaymentsMade').AsInteger := PaymentCount;
      PaymentsRemaining2 := SchedQuery.FieldByName('PaymentsRemaining').AsInteger;
      dec(PaymentsRemaining2);
      if (SchedQuery.FieldByName('GrossAmount').AsCurrency <> 0) and (SchedQuery.FieldByName('GrossAmount').AsCurrency <= SchedQuery.FieldByName('AmountPaid').AsCurrency) then begin
         SchedQuery.FieldByName('Status').AsString := 'COMPLETED';
         SchedQuery.FieldByName('PaymentsRemaining').AsInteger := 0;
         SchedQuery.FieldByName('CompletedDate').AsDateTime := Now;
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SCHEDPAY/SENDCOMPLETEEMAIL') = 'TRUE') and (Email <> '') then begin   //2016-8-08 jtm: Feat OT#1015
            SendCustomerEmail(Email, 'ScheduleComplete.htm',OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SCHEDPAY/COMPLETEEMAILSUBJECT','Scheduled Payments Completed'),OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAILBCC',''),OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAILREPLYTO',''));
         end;
      end else if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SCHEDPAY/COMPLETEONREMAINING','FALSE')) and (PaymentsRemaining2 <= 0) then begin //2018-12-19 jtm: DVST-2396
         SchedQuery.FieldByName('Status').AsString := 'COMPLETED';
         SchedQuery.FieldByName('PaymentsRemaining').AsInteger := 0;
         SchedQuery.FieldByName('CompletedDate').AsDateTime := Now;
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SCHEDPAY/SENDCOMPLETEEMAIL') = 'TRUE') and (Email <> '') then begin
            SendCustomerEmail(Email, 'ScheduleComplete.htm',OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SCHEDPAY/COMPLETEEMAILSUBJECT','Scheduled Payments Completed'),OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAILBCC',''),OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAILREPLYTO',''));
         end;
      end else if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SCHEDPAY/COMPLETEONENDDATE','FALSE')) and (SchedQuery.FieldByName('EndDate').AsDateTime <= now) then begin //2018-12-19 jtm: DVST-2396
         SchedQuery.FieldByName('Status').AsString := 'COMPLETED';
         SchedQuery.FieldByName('PaymentsRemaining').AsInteger := 0;
         SchedQuery.FieldByName('CompletedDate').AsDateTime := Now;
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SCHEDPAY/SENDCOMPLETEEMAIL') = 'TRUE') and (Email <> '') then begin
            SendCustomerEmail(Email, 'ScheduleComplete.htm',OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SCHEDPAY/COMPLETEEMAILSUBJECT','Scheduled Payments Completed'),OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAILBCC',''),OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAILREPLYTO',''));
         end;
      end;

      AmountOwed := SchedQuery.FieldByName('GrossAmount').AsCurrency - SchedQuery.FieldByName('AmountPaid').AsCurrency;
      if (SchedQuery.FieldByName('GrossAmount').AsCurrency <> 0) and
         (SchedQuery.FieldByName('PaymentAmount').AsCurrency <> 0) and
         (AmountOwed > 0) then begin
         PaymentsRemaining :=AmountOwed / SchedQuery.FieldByName('PaymentAmount').AsCurrency;

         SchedQuery.FieldByName('PaymentsRemaining').AsInteger := Trunc(PaymentsRemaining);
         If Trunc(PaymentsRemaining) <> PaymentsRemaining then
            SchedQuery.FieldByName('PaymentsRemaining').AsInteger := SchedQuery.FieldByName('PaymentsRemaining').AsInteger +1;
      end else if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SCHEDPAY/COMPLETEONREMAINING','FALSE')) or strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SCHEDPAY/COMPLETEONENDDATE','FALSE')) then begin
         if (VarEvaluator.GetValueAsString('ApprovalCode') <> '') then begin   //2019-04-05 jtm: DVST-5486
            SchedQuery.FieldByName('PaymentsRemaining').AsInteger := PaymentsRemaining2;
         end;
      end;

      If VarEvaluator.GetValueAsString('NonAuthReason') <> '' then begin
         SchedQuery.FieldByName('FailedPaymentCount').AsInteger := SchedQuery.FieldByName('FailedPaymentCount').AsInteger +1;
         If SchedQuery.FieldByName('FailedPaymentCount').AsInteger = 3 then begin
            SchedQuery.FieldByName('Status').AsString := 'SUSPENDED';
         end;
      end;
      If VarEvaluator.GetValueAsString('ApprovalCode') <> '' then begin
         If PaymentCount =1 then
            SchedQuery.FieldByName('FirstPayment').AsDateTime := Date;

         SchedQuery.FieldByName('FailedPaymentCount').AsInteger := 0;
         If (Trim(SchedQuery.FieldByName('Status').AsString) = 'SUSPENDED') and (AmountOwed > 0) then
            SchedQuery.FieldByName('Status').AsString := 'ACTIVE';

         If Increment then begin
            If Trim(UpCaseString(SchedQuery.FieldByName('Frequency').AsString)) = 'WEEKLY' then begin
               SchedQuery.FieldByName('NextPayment').AsDateTime := SchedQuery.FieldByName('NextPayment').AsDateTime + 7;
               if SchedQuery.FieldByName('NextPayment').AsDateTime < Date then begin
                  Repeat
                      SchedQuery.FieldByName('NextPayment').AsDateTime := SchedQuery.FieldByName('NextPayment').AsDateTime +7;
                  until SchedQuery.FieldByName('NextPayment').AsDateTime > Date;
               end;
            end;
            If Trim(UpCaseString(SchedQuery.FieldByName('Frequency').AsString)) = 'BIWEEKLY' then begin //2017-09-25 jtm: F#2203
               SchedQuery.FieldByName('NextPayment').AsDateTime := SchedQuery.FieldByName('NextPayment').AsDateTime + 14;
               if SchedQuery.FieldByName('NextPayment').AsDateTime < Date then begin
                  Repeat
                      SchedQuery.FieldByName('NextPayment').AsDateTime := SchedQuery.FieldByName('NextPayment').AsDateTime +14;
                  until SchedQuery.FieldByName('NextPayment').AsDateTime > Date;
               end;
            end;
            If Trim(UpCaseString(SchedQuery.FieldByName('Frequency').AsString)) = 'BIMONTHLY' then begin //2017-09-25 jtm: D#1501
               DecodeDate(SchedQuery.FieldByName('NextPayment').AsDateTime,Year,Month,Day);
               if (day = 15) then begin
                  if (month = 12) then begin
                    Year := Year+1;
                    month := 1;
                  end else begin
                    month := month+1;
                  end;
                  day := 1;
               end else if (day = 1) then begin
                  day := 15;
               end;
               SchedQuery.FieldByName('NextPayment').AsDateTime := EncodeDate(Year,Month,day);
               if SchedQuery.FieldByName('NextPayment').AsDateTime < Date then begin
                  Repeat
                     if (day = 15) then begin
                        if (month = 12) then begin
                          Year := Year+1;
                          month := 1;
                        end else begin
                          month := month+1;
                        end;
                        day := 1;
                     end else if (day = 1) then begin
                        day := 15;
                     end;
                     SchedQuery.FieldByName('NextPayment').AsDateTime := EncodeDate(Year,Month,day);
                  until SchedQuery.FieldByName('NextPayment').AsDateTime > Date;
               end;
            end;
            If Trim(UpCaseString(SchedQuery.FieldByName('Frequency').AsString)) = 'MONTHLY' then begin
               SchedQuery.FieldByName('NextPayment').AsDateTime := IncMonth(SchedQuery.FieldByName('NextPayment').AsDateTime,1);
               if SchedQuery.FieldByName('NextPayment').AsDateTime < Date then begin
                  Repeat
                     SchedQuery.FieldByName('NextPayment').AsDateTime := IncMonth(SchedQuery.FieldByName('NextPayment').AsDateTime,1);
                  until SchedQuery.FieldByName('NextPayment').AsDateTime > Date;
               end;
            end;
            If Trim(UpCaseString(SchedQuery.FieldByName('Frequency').AsString)) = 'QUARTERLY' then begin
               SchedQuery.FieldByName('NextPayment').AsDateTime := IncMonth(SchedQuery.FieldByName('NextPayment').AsDateTime,3);
               if SchedQuery.FieldByName('NextPayment').AsDateTime < Date then begin
                  Repeat
                     SchedQuery.FieldByName('NextPayment').AsDateTime := IncMonth(SchedQuery.FieldByName('NextPayment').AsDateTime,3);
                  until SchedQuery.FieldByName('NextPayment').AsDateTime > Date;
               end;
            end;
            If Trim(UpCaseString(SchedQuery.FieldByName('Frequency').AsString)) = 'ANNUALLY' then begin
               SchedQuery.FieldByName('NextPayment').AsDateTime := IncYear(SchedQuery.FieldByName('NextPayment').AsDateTime,1);
               if SchedQuery.FieldByName('NextPayment').AsDateTime < Date then begin
                  Repeat
                     SchedQuery.FieldByName('NextPayment').AsDateTime := IncYear(SchedQuery.FieldByName('NextPayment').AsDateTime,1);
                  until SchedQuery.FieldByName('NextPayment').AsDateTime > Date;
               end;
            end;

         end;
      end;
      VarEvaluator.AddValue('SCHEDULESTATUS',Trim(SchedQuery.FieldByName('Status').AsString));
      VarEvaluator.AddValue('SCHEDULENEXTPAYMENT',SchedQuery.FieldByName('NextPayment').AsString);
      VarEvaluator.AddValue('SCHEDULEFREQUENCY',Trim(UpCaseString(SchedQuery.FieldByName('Frequency').AsString)));
      VarEvaluator.AddValue('SCHEDULEPAYMENTSREMAINING',SchedQuery.FieldByName('PaymentsRemaining').AsString);
      VarEvaluator.AddValue('SCHEDULEBALANCE',Trim(StriReal(SchedQuery.FieldByName('GrossAmount').AsCurrency - AmountPaid,2)));

      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SCHEDPAY/SENDONEREMAININGEMAIL') = 'TRUE') and (trim(VarEvaluator.GetValueAsString('SCHEDULEPAYMENTSREMAINING')) = '1') and (Email <> '')  then begin  //2016-8-08 jtm: Feat OT#1013
         SendCustomerEmail(Email, 'ScheduleOneRemaining.htm',OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SCHEDPAY/ONEREMAININGEMAILSUBJECT','Scheduled Payments Ending Soon'),OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAILBCC',''),OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAILREPLYTO',''));
      end;

      SchedQuery.Post;
   end;
   SchedQuery.Close;
   SchedQuery.Free;
   Result := PaymentCount;
end;

Function TCustomerInfoModule.QueryDate(AField : String) : TDatetime;
var
   WS :String;
begin
   Result := 0;
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SEARCHONDATETIME', 'FALSE') = 'TRUE') then begin //2018-08-15 bls: 542
      Result := QueryDateTime(AField);
   end else begin
   WS := ValidCharsOnly(Request.queryfields.Values[AField],False,True,'/');
   If WS = '' then exit;
   Try
      Result := StrToDate(WS);
   except
      on E:Exception do begin
      end;
   end;
   end;
end;

Function TCustomerInfoModule.QueryDateTime(AField : String) : TDatetime; //2018-08-15 bls: 542
var
   WS :String;
begin
   Result := 0;
   WS := ValidCharsOnly(Request.queryfields.Values[AField],True,True,'/: ');
   If WS = '' then exit;
   Try
      Result := StrToDate(WS);
   except
      on E:Exception do begin
         ProcessLog(ltInfo, 'QueryDateTime', E.ClassName + ': ' + E.Message);
end;
   end;

end;

Function TCustomerInfoModule.GetRemoteAddress : String;
Var
   XForwardedFor : String;
   INCAPIP : String;
   RemoteAddr : string; //2016-5-10 jtm
Begin
   XForwardedFor := Request.GetFieldByName('HTTP_X_FORWARDED_FOR');
   IncapIP := Request.GetFieldByName('HTTP_INCAP_CLIENT_IP');
   If IncapIP <> '' then
      RemoteAddr := IncapIp
   else If XForwardedFor <> '' then
      RemoteAddr := XForwardedFor
   else
      RemoteAddr := Request.RemoteAddr;
   RemoteAddr := trim(RemoteAddr);
   if (length(RemoteAddr) > 15) then RemoteAddr := Copy(RemoteAddr,0,14); //2016-5-10 jtm
   Result := RemoteAddr;
  Result := '127.0.0.1'
end;

Function TCustomerInfoModule.GetRNUserByGUID(AGUID : String) : Boolean;
var
username :string;
userloaded : boolean;
begin
   Result := false;
   ProcessLog(ltInfo,'GetRNUserByGUID AGUID:',AGUID);
   RNQuery2.Close;
   RNQuery2.SQL.Text := 'select * from RNEmployee where (chaincode = :ChainCode) and (EmployeeGUID = :EmployeeGUID)';
   RNQuery2.Parameters.ParamByName('ChainCode').Value := ChainCode;
   RNQuery2.Parameters.ParamByName('EmployeeGUID').Value := AGUID;
   RNQuery2.Open;

   If (RNQuery2.RecordCount = 1) then begin
      username := RNQuery2.FieldByName('username').AsString;
      ProcessLog(ltInfo,'GetRNUserByGUID Username found:',username);
      if (username <> '') then begin
          userloaded := GetRNUser(username);
          if (userloaded) then begin
            ProcessLog(ltInfo,'GetRNUserByGUID Username loaded','');
            Result := true;
          end else begin
            ProcessLog(ltInfo,'GetRNUserByGUID Username not loaded','');
          end;
      end;
   end;
end;
Function TCustomerInfoModule.GetRNUser(UserName : String) : Boolean;
var
   PasswordHash : String;    //2016-9-19 jtm: Feat OT# 1054
   EmployeeXMLStr : string;
   UserXMLStr : string;
   AttributesXMLStr :string;
begin
   UserQuery.Close;
   UserQuery.Parameters.ParamByName('ChainCode').Value := ChainCode;
   UserQuery.Parameters.ParamByName('UserName').Value := UserName;
   UserQuery.Open;

   if UserXML <> nil then begin
      FreeAndNil(UserXML);
   end;
   if EmployeeXML <> nil then begin
      FreeAndNil(EmployeeXML);
   end;
   if (AttributesXML <> nil) then begin
      FreeAndNil(AttributesXML);
   end;
   Result := False;
   If UserQuery.RecordCount = 1 then begin
      Result := True;

      Try
         if UserQuery.FieldByName('UserProfile').AsString <> '' then begin    //2016-9-19 jtm: Feat OT# 1054
            UserXMLStr := '<?xml version="1.0" encoding="ISO-8859-1"?><USERPROFILE>' + GetXMLTagStr(UserQuery.FieldByName('UserProfile').AsString,'USERPROFILE') + '</USERPROFILE>';
         end else begin
            UserXMLStr := '<?xml version="1.0" encoding="ISO-8859-1"?><USERPROFILE></USERPROFILE>';
         end;
         UserXML := TOpenXML.CreateFromString(Nil,UserXMLStr);
         if (UserQuery.FieldByName('AttributesXML').AsString <> '') then begin    //2018-06-08 jtm:
            AttributesXMLStr := UserQuery.FieldByName('AttributesXML').AsString;
         end else begin
            AttributesXMLStr := '<ATTRIBUTES><ISPORTALUSER>TRUE</ISPORTALUSER></ATTRIBUTES>';
            UserQuery.Close;
            UserQuery.Parameters.ParamByName('ChainCode').Value := ChainCode;
            UserQuery.Parameters.ParamByName('UserName').Value := UserName;
            UserQuery.Open;

            UserQuery.Edit;
            UserQuery.FieldByName('AttributesXML').AsString := AttributesXMLStr;
            UserQuery.Post;
         end;
         AttributesXML := TOpenXML.CreateFromString(Nil,AttributesXMLStr);
         if UserQuery.FieldByName('EmployeeXML').AsString <> '' then begin
            EmployeeXML := TOpenXML.CreateFromString(Nil,'<?xml version="1.0" encoding="ISO-8859-1"?><EMPLOYEE>' +
                                                   UserQuery.FieldByName('EmployeeXML').AsString + '</EMPLOYEE>');
         end else if UserQuery.FieldByName('UserProfile').AsString <> '' then begin
            Processlog(ltInfo, 'GetRNUser:','Start update RNEmployee record');
            PasswordHash := trim(UserQuery.FieldByName('PasswordHash').AsString);
            UserXMLStr := UserQuery.FieldByName('UserProfile').AsString;
            if PasswordHash = '' then begin
               Processlog(ltInfo, 'GetRNUser:','PasswordHash not set');
               UserQuery.Edit;
               PasswordHash :=  trim(GetXMLTagStr(UserXMLStr,'PASSWORDHASH'));
               if (PasswordHash <> '') then begin
                   UserQuery.FieldByName('UserProfile').AsString := '<USERPROFILE>' + GetXMLTagStr(UserXMLStr,'USERPROFILE')+ '</USERPROFILE>';
               end;
               UserQuery.FieldByName('PasswordHash').AsString := PasswordHash;
               UserQuery.Post;
            end;
            UserQuery.Close;
            UserQuery.Parameters.ParamByName('ChainCode').Value := ChainCode;
            UserQuery.Parameters.ParamByName('UserName').Value := UserName;
            UserQuery.Open;

            EmployeeXMLStr := BuildEmployeeXML(UserQuery);
            UserQuery.Edit;
            UserQuery.FieldByName('EmployeeXML').AsString := EmployeeXMLStr;
            UserQuery.Post;
            VarEvaluator.AddDSCurrentRecord(UserQuery, 'RNEmployee');
            EmployeeXML := TOpenXML.CreateFromString(Nil,'<?xml version="1.0" encoding="ISO-8859-1"?><EMPLOYEE>' +
                                                EmployeeXMLStr + '</EMPLOYEE>');
            Processlog(ltInfo, 'GetRNUser:','Finished update RNEmployee record');
         end else begin
            EmployeeXML := TOpenXML.CreateFromString(Nil,'<?xml version="1.0" encoding="ISO-8859-1"?><EMPLOYEE></EMPLOYEE>');
         end;
         Result := True;
      except
         On E:Exception do begin
            Processlog(ltWarning, 'OpenXMLLoad Exception processing Employee XML, User=' +Username,E.Message);
            If Assigned(UserXML) then FreeAndNil(UserXML);
            If Assigned(EmployeeXML) then FreeAndNil(EmployeeXML);
            Result := False;
         end;
      end;
   end;

   Result := UserQuery.RecordCount = 1;


end;

Procedure TCustomerInfoModule.LoadSessionVars(ADataSet : TDataSet);
var
   EXML : String;
Begin
   EXML := ADataSet.FieldByName('ExternalXML').AsString;
   If EXML <> '' then begin
      Try
         ExternalXML := TOpenXML.CreateFromString(Nil,EXML);
      except
         On E:Exception do begin
            Processlog(ltWarning, 'OpenXMLLoad Exception processing External XML' ,E.Message);
            If Assigned(ExternalXML) then FreeAndNil(ExternalXML);
         end;
      end;
   end;

   VarEvaluator.AddDSCurrentRecord(ADataSet, 'Session');
   SessionVarEval.AddValue('Session.Username', ADataSet.FieldByName('Username').AsString);
   SessionVarEval.AddValue('Session.RNSessionID', ADataSet.FieldByName('RNSessionID').AsString);
   SessionVarEval.AddValue('Session.DateAdded', ADataSet.FieldByName('DateAdded').AsString);
   SessionVarEval.AddValue('Session.LastAccess', ADataSet.FieldByName('LastAccess').AsString);
   SessionVarEval.AddValue('Session.RemoteAddress', ADataSet.FieldByName('RemoteAddress').AsString);
   SessionVarEval.AddValue('Session.CustomerAuthenticatedTill', ADataSet.FieldByName('CustomerAuthenticatedTill').AsString);
   SessionVarEval.AddValue('Session.MembType', ADataSet.FieldByName('MembType').AsString);
end;

Function TCustomerInfoModule.ComputeCustomerSchedulesUsedByPaymentGUID(CustGUID : String; PaymentGUID : String): Integer;
var
   AQuery : TADOQuery;
Begin
   Result := 0;
   CustGUID := GuidOnly(CustGUID);
   PaymentGUID := GUIDOnly(PaymentGUID);
   If CustGUID = '' then exit;
   If PaymentGUID = '' then exit;

   AQuery := NewADOQuery;
   AQuery.SQL.Clear;
   AQuery.SQL.Add('Select Count(*) as SchedCount from custPaySched');
   AQuery.SQL.Add('Where (CustGUID =''' + CustGUID + ''') and (PaymentGUID = ''' + PaymentGUID + ''')');
   AQuery.Open;
   Result := AQuery.FieldByName('SchedCount').AsInteger;
   AQuery.Close;
   AQuery.Free;

end;

Procedure TCustomerInfoModule.GenerateScheduledPaymentReport(ADS : TDataSet; DisplayFormat : String; ShowAction : Boolean; ShowLinks : Boolean);
var
   WS: String;
   ws2 : String;
   ws3 : String;
   TabLine : String;
Begin

   If ADS.RecordCount >0  then begin
      WS :='<TABLE class="StylePortalGrid"><TR><Th><B>Location</B><Th><B>Next Pay</B></Th><Th><B>Freq</B></Th><Th><B>Name</B></Th><Th><B>Total</B></Th><Th><B>Paid</B></Th><Th><B>Balance</B></Th><Th><B>Each Pay</B></Th><Th><B>Type</B></Th><Th><B>Exp</B></Th> ' +
                                             '<Th><B>Payment Name</B></Th><Th><B>Sched<BR>Made<BR>Remain</B></Th>';
      If ShowAction then begin
        WS := WS + '<Th><B>Action</B></Th><Th><B>Edit</B></Th>';
      end;
      WS := WS + '</TR>';
      HTMLResp.Add(WS); WS := '';
      TabTextLines.Add('Location' + #9 +
                       'Status' + #9 +
                       'Add Date' + #9 +
                       'First Payment Date' + #9 +
                       'Next Payment Date' + #9 +
                       'Completed Date' + #9 +
                       'Frequency' + #9 +
                       'FirstName' + #9 +
                       'LastName' + #9 +
                       'AccountNumber' + #9 +
                       'Total Amount' + #9 +
                       'Amount Paid' + #9 +
                       'Amount Due' + #9 +
                       'Payment Amount' + #9 +
                       'PaymentType' + #9 +
                       'Expires' + #9 +
                       'Payment Name' + #9 +
                       'Payments Scheduled' + #9 +
                       'Payments Made' + #9 +
                       'Payments Remaining' + #9) ;
      While Not ADS.EOF do begin
         If DisplayFormat = 'XLS' then begin
            TabLine := Trim(ADS.FieldByName('LocName').AsString) + #9 +
                       Trim(ADS.FieldByName('Status').AsString) + #9 +
                       FormatDateTime('MM/DD/YY',ADS.FieldByName('ScheduleAdded').AsDateTime) + #9 +
                       FormatDateTime('MM/DD/YY',ADS.FieldByName('firstpayment').AsDateTime)+ #9 +
                       FormatDateTime('MM/DD/YY',ADS.FieldByName('NextPayment').AsDateTime)+ #9 +
                       FormatDateTime('MM/DD/YY',ADS.FieldByName('completeddate').AsDateTime)+ #9 +
                       Trim(ADS.FieldByName('Frequency').AsString)+ #9 +
                       Trim(ADS.FieldByName('FN').AsString)+ #9 +
                       Trim(ADS.FieldByName('LN').AsString)+ #9 +
                       Trim(ADS.FieldByName('AccountNumber').AsString)+ #9 +
                       Trim(StriReal(ADS.FieldByName('GrossAmount').AsFloat,2))+ #9 +
                       Trim(StriReal(ADS.FieldByName('AmountPaid').AsFloat,2))+ #9 +
                       Trim(StriReal(ADS.FieldByName('GrossAmount').AsFloat-ADS.FieldByName('AmountPaid').AsFloat,2))+ #9 +
                       Trim(StriReal(ADS.FieldByName('PaymentAmount').AsFloat,2))+ #9 +
                       Trim(ADS.FieldByName('PaymentType').AsString)+ #9 +
                       FormatDateTime('M/YY', ADS.FieldByName('CardExpires').AsDateTime)+ #9 +
                       Trim(ADS.FieldByName('PaymentName').AsString)+ #9 +
                       Trim(ADS.FieldByName('NumberOfPayments').AsString)+ #9 +
                       Trim(ADS.FieldByName('PaymentsMade').AsString)+ #9 +
                       Trim(ADS.FieldByName('PaymentsRemaining').AsString);
            TabTextLines.Add(TabLine);
         end else begin
            WS := WS + '<tr ID="'+Trim(ADS.FieldByName('PaySchedGUID').AsString)+'"><td>' + Trim(ADS.FieldByName('LocName').AsString) + '</td>';
            if Trim(ADS.FieldByName('Status').AsString) = 'COMPLETED' then
               WS := WS + '<td align="CENTER" bgcolor=#C0C0C0>Completed</td>'
            else if Trim(ADS.FieldByName('Status').AsString) = 'SUSPENDED' then
               WS := WS + '<td align="CENTER" bgcolor=#FF0000>Suspended</td>'
            else if Trim(ADS.FieldByName('Status').AsString) = 'CANCELLED' then
               WS := WS + '<td align="CENTER" bgcolor=#900000>Cancelled</td>'
            else
               WS := WS + '<td align="CENTER" bgcolor=#00FF00>' + FormatDateTime('MM/DD/YY',ADS.FieldByName('NextPayment').AsDateTime) + '</td>';
             WS := WS +     '<td>' + Trim(ADS.FieldByName('Frequency').AsString) + '</td>' +
                           '<td>';
            If ShowLinks then begin
               WS := WS + '<a href="javascript:GetCustomerProfile(''' + Trim(ADS.FieldByName('CustomerCode').AsString)+''')">';
            end;
            ws := Ws + Trim(ADS.FieldByName('FN').AsString) + ' ' +Trim(ADS.FieldByName('LN').AsString);
            If ShowLinks then begin
               WS := WS + '</A>';
            end;
            WS3 := Trim(Trim(ADS.FieldByName('CFN').AsString) + ' ' +Trim(ADS.FieldByName('CLN').AsString) + ' '+Trim(ADS.FieldByName('CAN').AsString));
            If WS3 <> '' then WS := WS + '<BR>' + WS3;
            WS := WS +  '</td>' +
                           '<td align="RIGHT">$' + Trim(StriReal(ADS.FieldByName('GrossAmount').AsFloat,2))+'</td>' +
                           '<td align="RIGHT">$' + Trim(StriReal(ADS.FieldByName('AmountPaid').AsFloat,2))+'</td>' +
                           '<td align="RIGHT">$' + Trim(StriReal(ADS.FieldByName('GrossAmount').AsFloat-ADS.FieldByName('AmountPaid').AsFloat,2))+'</td>' +
                           '<td align="RIGHT">$' + Trim(StriReal(ADS.FieldByName('PaymentAmount').AsFloat,2))+'</td>' +
                           '<td>' + Trim(ADS.FieldByName('PaymentType').AsString)+'</td>';
                           If ADS.FieldByName('CardExpires').AsDateTime > 0 then begin
                              If LastDayOfMonthOfDate(ADS.FieldByName('CardExpires').AsDateTime) < Date then begin
                                 WS := WS + '<td bgcolor=#FF0000>' + FormatDateTime('M/YY', ADS.FieldByName('CardExpires').AsDateTime)+'</td>';   //expired
                              end else begin
                                 WS := WS + '<td bgcolor=#00FF00>' + FormatDateTime('M/YY', ADS.FieldByName('CardExpires').AsDateTime)+'</td>';
                              end;
                           end else begin
                              WS := WS + '<td></td>';
                           end;

                             WS2 := Trim(ADS.FieldByName('PaymentName').AsString);
                             ReplaceString(WS2,'*','');
            WS := WS +     '<td>' + WS2+'</td>' +
                           '<td align="RIGHT">' + Trim(ADS.FieldByName('NumberOfPayments').AsString) + '/' +
                                                  Trim(ADS.FieldByName('PaymentsMade').AsString)+  '/' +
                                                  Trim(ADS.FieldByName('PaymentsRemaining').AsString)+ '</td>' ;
            If ShowAction then begin
               WS := WS +     '<td align="center">' + '<a name="RemoveSchedPay" href="" OnClick="RemoveScheduledPayment(''' + Trim(ADS.FieldByName('PaySchedGUID').AsString)+'''); return false;">' +
                                       '<IMG alt="Remove Payment" name="RemovePayIcon"  SRC="/Images/General/CalendarDelete.png"  border="0"></a></td>' ;
               WS := WS +     '<td align="center">' + '<a name="RemoveSchedPay" href="" OnClick="GetCustomerScheduleEditorAJAX(''' +Trim(ADS.FieldByName('CustGUID').AsString) + ''','''+ Trim(ADS.FieldByName('PaySchedGUID').AsString)+'''); return false;">' +
                                       '<IMG alt="Remove Payment" name="RemovePayIcon"  SRC="/Images/General/CalendarEdit.png"  border="0"></a></td>' ;
            end;
            WS := WS + '</tr>';
            HTMLResp.Add(WS); WS := '';
         end;
         ADS.Next;
     end;
   end;

end;

function TCustomerInfoModule.DeliverHTMLEmail(Subject : String;
                                              ToEmail : String) : Boolean;
Begin
   clMail.BuildMessage('',HTMLResp.Text);
   clMail.From.FullAddress := '"' + DomainFriendlyName+'"<'+DomainSendAsEmail+'>';
   clMail.ToList.EmailAddresses := ToEmail;
   clMail.BCCList.EmailAddresses := GetConfigString('CONFIRMATIONBCC','');
   clMail.Subject := Subject;
   clMail.ReplyTo := GetConfigString('CONFIRMATIONREPLYTO','donotreply@spectrumretailnet.com');
   SMTP.Open();

   try
      SMTP.Send(clMail);
      Result := True;
   finally
      SMTP.Close();
      Result := False;
   end;
end;
Function TCustomerInfoModule.GetChildByValues(RNID : String; CustGUID : String; DOB : String; FirstName : String; LastName : String) : TDataSet;
Var
   ADS : TADOQuery;
   WS : String;

Begin
   Result := NIL;
   ADS := NewADOQUery;
   Result := ADS;
   
   ProcessLog(ltInfo,'GetChildByValues', 'RNID:' + RNID + ' CustGUID:' + CustGUID+ ' DOB:' + DOB+'FirstName:' + FirstName + ' LastName:' + LastName);
   Try
      ADS.SQL.Clear;
      ADS.ParamCheck := True;
      ADS.SQL.Add('Select * from CustChild where (RNID = :RNID) and (CustGuid = :custguid) and (DOB = :dob) and (FirstName = :firstname) and (LastName = :lastname)');
      ADS.Parameters.ParamByName('RNID').Value := Trim(RNID);
      ADS.Parameters.ParamByName('custguid').Value := Trim(CustGuid);
      ADS.Parameters.ParamByName('dob').Value := Trim(DOB);
      ADS.Parameters.ParamByName('firstname').Value := Trim(FirstName);
      ADS.Parameters.ParamByName('lastname').Value := Trim(LastName);
      ADS.Open;
   except
      on E:Exception do begin
         ProcessLog(ltWarning,'Exception GetChildByValue' + E.Message,InstanceGUID);
      end;
   end;
end;
Function TCustomerInfoModule.GetCustomerByEmail(CustRNID : String; EmailAddress: String) : TDataSet;
Var
   ADS : TADOQuery;
   WS : String;

Begin
   Result := NIL;
   ADS := NewADOQUery;
   Result := ADS;
   Try
      ADS.SQL.Clear;
      ADS.ParamCheck := True;
      ADS.SQL.Add('Select * from Customers where (StoreCode = :CustRNID) and (Email = :email)');
      ADS.Parameters.ParamByName('email').Value := Trim(EmailAddress);
      ADS.Parameters.ParamByName('CustRNID').Value := Trim(CustRNID);
      ADS.Open;
   except
      on E:Exception do begin
         ProcessLog(ltWarning,'Exception GetCustomerByEmail' + E.Message,InstanceGUID);
      end;
   end;
end;

Function TCustomerInfoModule.OpenScheduledPaymentReportQuery(SiteRNID : String;
                                                             SelectedRNID : String;
                                                             Status : String;
                                                             CustGUID : String;
                                                             LastName : String;
                                                             CustAccountNumber : String) : TDataSet;
Var
   ADS : TADOQuery;
   WS : String;

Begin
   ADS := NewADOQUery;
   Result := ADS;
   Try
      ADS.SQL.Clear;
      ADS.SQL.Add('select CustPaySched.CustGUID as CustGUID, CustPaySched.GrossAmount, CustChild.FirstName as CFN, CustChild.LastName as CLN, CustChild.AccountNumber as CAN, CustPaySched.AmountPaid,PaySchedGUID, ScheduleAdded, CustPaySched.Status, ');
      ADS.SQL.Add('ScheduleAdded,NextPayment,firstpayment,completeddate, Store.Name as LocName, frequency, ');
      ADS.SQL.Add('       customers.customercode, Customers.FirstName as FN, Customers.LastName as LN, customers.accountnumber, paymentAmount, PaymentType, CardExpires, PaymentName, NumberOfPayments,paymentsremaining, PaymentsMade from custpaysched');
      ADS.SQL.Add('left outer join CustChild on ((CustChild.CustGUID = CustPaySched.CustGUID) And (CustChild.ChildGUID = CustPaySChed.ChildGUID))');
      ADS.SQL.Add('left outer join customers on ((customercode = custpaysched.custguid) and (Customers.ChainCode =' + Stri(ChainCode,-1) + '))');
      ADS.SQL.Add('left outer Join CustPayment on (CustPayment.CustGUID = CustPaySched.CustGUID) and (CustPayment.PaymentGUID = CustPaySched.PaymentGUID)');
      ADS.SQL.Add('left outer Join Store on (Store.SystemCode = CustPaySched.RNID) ');

      if (SelectedRNID = 'ALL') or (SelectedRNID = '') then
         ADS.SQL.Add('where custpaysched.SiteRNID=' + SiteRNID + '')
      else
         ADS.SQL.Add('where custpaysched.RNID=' + SelectedRNID + '');

      if Trim(Status)= 'ACTIVE' then
         ADS.SQL.Add('AND CustPaySched.Status=''ACTIVE''');
      if Trim(Status)= 'COMPLETED' then
         ADS.SQL.Add('AND CustPaySched.Status=''COMPLETED''');
      if Trim(Status)= 'SUSPENDED' then
         ADS.SQL.Add('AND CustPaySched.Status=''SUSPENDED''');
      if Trim(Status)= 'CANCELLED' then
         ADS.SQL.Add('AND CustPaySched.Status=''CANCELLED''');

      if guidonly(CustGUID) <> '' then begin
         ADS.SQL.Add('AND Customers.CustomerCode = ''' + GuidOnly(CustGUID) + '''');
      end;
      WS := Trim(AlphaOnly(LastName));
      If WS <> '' then begin
         ADS.SQL.Add('AND Customers.LastName like ''' + WS + '%''');
      end;

      if ValidCharsOnly(CustAccountNumber,true,true,'') <> '' then begin
         ADS.SQL.Add(' and (Customers.AccountNumber = ''' + ValidCharsOnly(CustAccountNumber,true,true,'')+ ''')');
      end;

      ADS.SQL.Add('order by Customers.lastName');
      ADS.Open;
   except
      On E:Exception do begin
          ProcessLog(ltWarning,'Exception on OpenScheduledPaymentReportQuery ' + E.Message +
                     SiteRNID  + '/' +SelectedRNID + '/' + Status + '/' + CustGUID + '/' + LastName + '/' + CustAccountNumber,InstanceGUID);
      end;
   end;



end;


Function TCustomerInfoModule.GetCCBatch(RNID : String;BatchSystemCode : String; ReturnDetail : boolean) : boolean;
var
   BDR : String;
Begin
   BatchXML.Clear;
   Result := False;

   if Not ValidateRNID(RNID) then exit;

   BDR := '<TRANSACTION> <RNID>'+RNID+'</RNID>' +
          '<TRANSACTIONTYPE>CCBATCHDETAIL</TRANSACTIONTYPE>' +
          '<ENCODING>UTF-8</ENCODING>';
   If ReturnDetail then
      BDR := BDR + '<DETAILLEVEL>VERBOSE</DETAILLEVEL>';

   If BatchSystemCode <> '' then  //2018-10-10 bls DVST-2716
      BDR := BDR + '<CCSYSTEMCODE>' + BatchSystemCode + '</CCSYSTEMCODE>'
   else
      BDR := BDR + '<BATCHSERIAL>0</BATCHSERIAL>';

   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHBATCHEMPIDENT', 'FALSE') = 'TRUE') and (ValidCharsonly(Request.queryfields.Values['EMPIDENT'],True,True,'') <> '') then begin //2016-8-08 jtm: Feat OT#892
       BDR := BDR + '<AUTHEMPIDENT>' + ValidCharsonly(Request.queryfields.Values['EMPIDENT'],True,True,'') + '</AUTHEMPIDENT>';
   end;
   if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then   //2016-9-19 jtm: Feat OT# 1145
       BDR := BDR + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';

   BDR := BDR + '</TRANSACTION>'+CRLF;
   VarEvaluator.AddValue('GatewayRNID',RNID);//2017-05-24 jtm: F#1821
   ProcessPPSAPIXML(BDR, BatchXML,GetAppServerHost,0);

   Try
      BatchOXML := TOpenXML.CreateFromString(Nil,BatchXML.Text);
      Result := True;
   except
      on E:Exception do begin
         BatchOXML := NIL;
      end;
   end;

end;
Function TCustomerInfoModule.GetCCBatchFields(RNID : String;BatchSystemCode : String;FieldNameList : TStringList) : boolean;
var
   FBatchDetailDM : TBatchDetailDM;
Begin
   FBatchDetailDM := TBatchDetailDM.Create(ProcessLog, ProcessPPSAPIXML);
   BatchOXML := FBatchDetailDM.GetCCBatch(RNID, BatchSystemCode, TRUE, '', '', '', FieldNameList);

   If BatchOXML <> NIL then begin
      Result := true;
   end else begin
      Result := false;
   end;
end;
Function TCustomerInfoModule.GetCCAuthSig(RNID : String;BatchSystemCode : String) : String;
var
   SigReq : String;
   SIGResponse : TStringList;
Begin
   Result := '';
   if Not ValidateRNID(RNID) then exit;

   ProcessLog(ltInfo,'GetCCAuthSig' ,RNID + ':' + BatchSystemCode);

   SigResponse := TStringList.Create;
   SigReq := '<TRANSACTION> <RNID>'+RNID+'</RNID>' +
          '<TRANSACTIONTYPE>CCSIGRETRIEVE</TRANSACTIONTYPE>' +
          '<CCSYSTEMCODE>' + BatchSystemCode + '</CCSYSTEMCODE>';

   if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then   //2016-9-19 jtm: Feat OT# 1145
      SigReq := SigReq + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';

   SigReq := SigReq + ' </TRANSACTION>'+CRLF;
   VarEvaluator.AddValue('GatewayRNID',RNID);//2017-05-24 jtm: F#1821
   ProcessPPSAPIXML(SigReq, SigResponse,GetAppServerHost,0);

   Try
      if GetXMLTag(SigResponse,'SIGDATATYPE') = '4' then begin  //2017-05-24 jtm F#1812
         Result := XYZtoBMP(GetXMLTag(SigResponse,'SIGDATA'));
      end else begin
         Result := STDBase64Decode(GetXMLTag(SigResponse,'SIGDATA'));
      end;
   ProcessLog(ltWarning,'GetCCAuthSig' ,'Length of JPG:'+STRI(Length(Result),-1));

   except
      on E:Exception do begin

      end;
   end;

   SigResponse.Free;


end;



Function TCustomerInfoModule.SingleBatchXMLToTableHTML(const ReadyOnly,ChargeAgain : boolean): String;
const
  LINK_BUTTON_HTML : String = '<a href="javascript://" class="linkBtn"  onclick="document.getElementById(''VTCardDetailSpacerDiv'').style.display = ''none'';' +
                              'document.getElementById(''VTCardDetailFormActionButtonDIV'').style.display = ''none'';';
var
  BatchHTML : TStringList;
  BRNID, BSC, MaskAcct, ProcessorToken, TicketGUID, CardTransactionUnavailableMessage, CCBatchDetailNum, tranAmt, saleType, authCode, cardName, sigDataType, voidDeleteCreditVerbiage,
   CardAcct : String;
  ReceiptToCustEmail, isVoided, isCredit, isDebit, isAuth, authCodeIsEmpty, batchCodeIsGreaterThanZero : boolean; //2018-09-12 ajs: DVST-1235
  batchCode: integer;
  CardType: String; // 2018-12-19 SS: DVST 2660
Begin
   Result := '';
   If BatchOXML = NIL then exit;

   BatchHTML := TStringList.Create;
   BatchHTML.Add('<TABLE border="1" cellspacing="0" cellpadding="3"  style="border-collapse: collapse; font-size:7pt;font-family:veranda">');
   CCBatchDetailNum := '/TRANRESP/CCBATCHDETAIL/CCAUTHDETAIL[1]/';
   BRNID := Trim(BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'PROFILE'));
   CardTransactionUnavailableMessage := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/CARDTRANSACTIONUNAVAILABLEMESSAGE', '');

   If (BRNID = '') AND (CardTransactionUnavailableMessage <> '') then begin  //2018-05-15 bls: D#2594
      BatchHTML.Add('<br><br><table><tr><td><b>' + CardTransactionUnavailableMessage + '</b></td></tr></table>');
   end else begin
      ReceiptToCustEmail := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ALLOWEMAILRECEIPT', 'FALSE')); //2018-09-12 ajs: DVST-1235
      voidDeleteCreditVerbiage := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VOIDDELETECREDITVERBIAGE', 'Delete Credit');

      BSC := BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'SYSTEMCODE');
      TicketGUID := BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'TICKETGUID');
      isVoided := strtobool(BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'VOIDED'));
      tranAmt := DisplayMoney(ValuReal(BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'TRANAMT')));
      saleType := BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'SALETYPE');
      authCode := BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'AUTHCODE');
      cardName := BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'CARDNAME');
      sigDataType := BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'SIGDATATYPE');
      batchCode := BatchOXML.GetValueAsInteger(CCBatchDetailNum + 'BATCHCODE');

      isCredit := saleType = 'CREDIT';
      isDebit := saleType = 'DEBIT';
      isAuth := saleType = 'AUTH';
      authCodeIsEmpty := authCode = '';
      batchCodeIsGreaterThanZero := batchCode > 0;

      BatchHTML.Add('<table>');
      BatchHTML.Add('<tr><td><b>Location</B></TD><TD>' + BRNID + '</td></tr>');
      BatchHTML.Add('<tr><td><b>Authorization Date</b></td><td>' + BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'AUTHDATE') + '</td></tr>');
      If isVoided then begin
         BatchHTML.Add('<tr><td><b>Amount</b></td><td><del><font color="Red">' + tranAmt + '</font></del></td></tr>');
      end else begin
         BatchHTML.Add('<tr><td><b>Amount</b></td><td>' + tranAmt + '</td></tr>');
      end;
      BatchHTML.Add('<tr><td><b>Tran Type</b></td><td>' + saleType + '</td></tr>');
      BatchHTML.Add('<tr><td><b>Card Type</b></td><td>' + BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'CARDTYPE') + '</td></tr>');

      CardType := BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'CARDTYPE'); // 2018-12-19 SS DVST 2660
      
      CardAcct := trim(BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'CARDACCT'));
      ProcessorToken := trim(BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'PROCESSORTOKEN'));
      if CardAcct <> '' then begin  //2017-12-20 jtm: Feat OT#2430
         if ProcessorToken <> '' then begin  //card number sent in, but either tokenized or not
            MaskAcct := MaskStr(ProcessorToken,DigitsToMask(ProcessorToken));
            MaskAcct := '*..*' + NumericOnly(MaskAcct);
         end else begin
            MaskAcct := 'X..X' + NumericOnly(CardAcct);
         end;
      end else if (CardAcct = '')  and (ProcessorToken <> '') then begin //token passed directly
         MaskAcct := MaskStr(ProcessorToken,DigitsToMask(ProcessorToken));
         MaskAcct := '#..#' + NumericOnly(MaskAcct);
      end;

      BatchHTML.Add('<tr><td><b>Card Account</b></td><td>' + MaskAcct + '</td></tr>');

      If NOT isCredit then begin
         If NOT authCodeIsEmpty then begin
            BatchHTML.Add('<tr><td><b>Authorization Code</b></td><td><img src="/Images/General/CheckSuccess.gif" border="0"><font color="Green">' + authCode + '</font></td></tr>');
         end else begin
            BatchHTML.Add('<tr><td><b>Non Auth Resp</b></td><td><img src="/Images/General/XFailed.gif" border="0"><font color="Red">' + BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'NONAUTHRESP') + '</font></td></tr>');
         end;
      end;

      BatchHTML.Add('<tr><td><b>Entry Mode</b></td><td>' + GetCCTranEntryModeDisplayText(BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'TRANENTRYMODE')) + '</td></tr>');//2017-07-19 jtm: D#1795
      If (BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'CARDTRACKDATA') <> '') or ((cardName <> '') and strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDECARDHOLDERNAME', 'FALSE'))) then begin
         BatchHTML.Add('<tr><td><b>Name on Card</b></td><td>' + cardName + '</td></tr>');
         end;
      BatchHTML.Add('<tr><td><b>Merchant ID</b></td><td>' + BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'MID') + '</td></tr>');
      BatchHTML.Add('<tr><td><b>Item Serial</b></td><td>' + BSC + '</td></tr>');

      BatchHTML.Add('<tr><td><b>Service Name</b></td><td>' + BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'CCSERVICENAME') + '</td></tr>');
      BatchHTML.Add('<tr><td><b>' + OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/TRANIDENTDESCRIPTION', 'Transaction Ident') +
                     '</b></td><td>' + BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'TRANIDENT') + '</td></tr>');
      BatchHTML.Add('<tr><td><b>' + OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/CUSTIDENTDESCRIPTION', 'Customer Ident') +
                     '</b></td><td>' + BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'TRANCUSTOMERCODE') + '</td></tr>');
      BatchHTML.Add('<tr><td><b>Station</b></td><td>' + BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'STATIONIDENT') + '</td></tr>');

      if batchCodeIsGreaterThanZero then begin //2017-11-16 jtm: D#2071
         BatchHTML.Add('<tr><td><b>Batch ID</b></td><td>' + BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'BATCHID') + '</td></tr>');
         BatchHTML.Add('<tr><td><b>Batch Date</b></td><td>' + BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'BATCHDATE') + '</td></tr>');
      end;
      If isVoided then begin
         BatchHTML.Add('<tr><td><b>Void Date</b></td><td><img src="/Images/General/YellowExclamation.gif" border="0">' + BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'VOIDDATETIME') + '</td></tr>');
      end;
      BatchHTML.Add('</table>');

      if (sigDataType = '3') or (sigDataType = '4') then begin //2017-05-24 jtm F#1812
         BatchHTML.Add('<img src="/PP?PAGE=GETCARDSIGIMAGE&LOCATIONRNID=' + BRNID + '&CCSYSTEMCODE=' + BSC + '" border="0"  width="300" height="100"><br>');
      end;

      BatchHTML.Add('<BR><BR><DIV id="VTCardDetailFormActionButtonDIV"><CENTER>');
      if not ReadyOnly then begin //2017-03-22 jtm:  F#1267
         If (NOT isVoided) and (NOT isDebit) and ((NOT authCodeIsEmpty) or (isCredit)) and ((batchCode = 0) or (isAuth)) then begin   //2017-11-08 jtm: D#2071
            if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/USEVOID', 'FALSE')) then begin //2018-05-16 AJS: F#2433
               if strtobool(BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'CAPTUREFLAG')) then begin //2018-06-20 ajs: D#4830
                  BatchHTML.Add('<a href="javascript://" class="linkBtn"  onclick="document.getElementById(''VTCardDetailFormActionButtonDIV'').style.display = ''none'';');
                  BatchHTML.Add('$(''#VTCardDetailFormActionDetailDIV'').activity();');
                  BatchHTML.Add('$.get(''/PP?PAGE=VTVOIDCARDAJAX&LOCATIONRNID=' + BRNID + '&CCSYSTEMCODE=' + BSC + ''',function(data) { document.getElementById(''VTCardDetailFormActionActionResultDIV'').innerHTML=data;RefreshVTCardDetailAJAX(''' + BRNID + ''',''' + BSC + ''');});');
                  if isCredit then begin
                     BatchHTML.Add('");>' + voidDeleteCreditVerbiage + '</a>'); //2018-05-15 bls F#4174
                  end else begin
                     BatchHTML.Add('");>Void</a>');
                  end;
               end;
            end else begin //2018-05-30 AJS: D#4766
               if ValuReal(BatchOXML.GetValueAsWideString(CCBatchDetailNum + 'TRANAMT')) <> 0 then begin //2018-06-20 ajs: D#4830
                  BatchHTML.Add('<a href="javascript://" class="linkBtn"  onclick="document.getElementById(''VTCardDetailFormActionButtonDIV'').style.display = ''none'';');
                  BatchHTML.Add('$(''#VTCardDetailFormActionDetailDIV'').activity();');

                  if(StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/CONFIRMREVERSE', 'FALSE')) = False) then begin // 2018-12-19 SS: DVST-2660
                     if isCredit then begin
                        BatchHTML.Add('$.get(''/PP?PAGE=VTVOIDCARDAJAX&LOCATIONRNID=' + BRNID + '&CCSYSTEMCODE=' + BSC + ''',function(data) { document.getElementById(''VTCardDetailFormActionActionResultDIV'').innerHTML=data;RefreshVTCardDetailAJAX(''' + BRNID + ''',''' + BSC + ''');});');
                        BatchHTML.Add('");>' + voidDeleteCreditVerbiage + '</a>');
                     end else begin
                        BatchHTML.Add('$.get(''/PP?PAGE=VTREVERSECARDAJAX&LOCATIONRNID=' + BRNID + '&CCSYSTEMCODE=' + BSC + ''',function(data) { document.getElementById(''VTCardDetailFormActionActionResultDIV'').innerHTML=data;RefreshVTCardDetailAJAX(''' + BRNID + ''',''' + BSC + ''');});');
                        BatchHTML.Add('");>Reverse</a>');
                     end;
                  end else begin
                     if isCredit then begin
                        BatchHTML.Add('$.get(''/PP?PAGE=VTVOIDCARDAJAX&LOCATIONRNID=' + BRNID + '&CCSYSTEMCODE=' + BSC + ''',function(data) { document.getElementById(''VTCardDetailFormActionActionResultDIV'').innerHTML=data;RefreshVTCardDetailAJAX(''' + BRNID + ''',''' + BSC + ''');});');
                        BatchHTML.Add('");>' + voidDeleteCreditVerbiage + '</a>');
                     end else begin
                        BatchHTML.Add('VirtualTerminalConfirmReverse('''+BRNID+''','''+BSC+''','''+CardType+''', '''+MaskAcct+''');">Reverse</a>');
                     end
                  end;
               end;
            end;
         end;

         if (strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ADMINISSUECREDIT/ONDEBIT', 'FALSE')) or (Not isDebit))
            and (strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ADMINISSUECREDIT/ONOPENBATCH', 'FALSE')) or (batchCodeIsGreaterThanZero)) //2017-11-16 jtm: D#2071
            and (strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ADMINISSUECREDIT/ONVOIDED', 'FALSE')) or (not isVoided)) then begin //2017-07-19 jtm: F#1599 //2017-09-06 jtm: D#1617
            if NOT isAuth then begin
               BatchHTML.Add(LINK_BUTTON_HTML + 'document.getElementById(''VTCardDetailIssueCreditFormDiv'').style.display = '''';");>Issue Credit</a>');
            end;
         end;
         if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ADMINCHARGEAGAIN/ALLOW', 'TRUE')) and (BRNID <> '') then begin
            if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ADMINCHARGEAGAIN/USERRESTRICTED', 'FALSE')) then begin //2019-02-13 jtm: DVST-3067
               if (ChargeAgain) then begin
                  BatchHTML.Add(LINK_BUTTON_HTML + 'document.getElementById(''VTCardDetailChargeAgainFormDiv'').style.display = '''';");>Charge Again</a>');
               end;
            end else begin
               BatchHTML.Add(LINK_BUTTON_HTML + 'document.getElementById(''VTCardDetailChargeAgainFormDiv'').style.display = '''';");>Charge Again</a>');
            end;
         end;
      end;

      if TicketGUID <> '' then begin
         BatchHTML.Add('<br><br><a href="javascript://" class="linkBtn"  onclick="VTPrintAuthReceiptAJAX(' + BRNID + ',' + BSC + ',''CARD'',''' + TicketGUID + ''');");>Print</a>');
      end else begin
         BatchHTML.Add('<br><br><a href="javascript://" class="linkBtn"  onclick="VTPrintAuthReceiptAJAX(' + BRNID + ',' + BSC + ',''CARD'');");>Print</a>');
      end;

      if (isAuth) and strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ALLOWFORCEAUTH', 'FALSE')) then begin
         BatchHTML.Add(LINK_BUTTON_HTML + 'document.getElementById(''VTCardDetailForceAuthFormDiv'').style.display = '''';");>Force Auth</a>');
      end;

      if ReceiptToCustEmail then begin //2018-09-12 ajs: DVST-1235
         BatchHTML.Add(LINK_BUTTON_HTML + 'document.getElementById(''VTCardDetailEmailReceiptFormDiv'').style.display = '''';");>Email Receipt</a>');
   end;
      BatchHTML.Add('</center></div><br><br>');
   end;
   Result := BatchHTML.Text;
   BatchHTML.Free;
end;

Function TCustomerInfoModule.CardForceAuth(const AQueryFields, AContentFields : TStrings): String;
var
   rnidL, systemCodeL, appServerSI, empIdentL, sessionUsername, externalUsername, tranident, amount : string;
   ResponseXML, RequestXML : TStringList;
begin
   Result := '';
   rnidL := NumericOnly(AQueryFields.Values['LOCATIONRNID']);

   if Not ValidateRNID(rnidL) then exit;

   systemCodeL := NumericOnly(AQueryFields.Values['CCSYSTEMCODE']);
   appServerSI := trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', ''));
   sessionUsername := SessionVarEval.GetValueAsString('Session.Username');
   externalUsername := trim(ExternalXMLGetTag('/EXTERNALXML/USERNAME'));
   tranident := ValidCharsOnly(AQueryFields.Values['TRANIDENT'], true, true, '.-_:/& ');
   amount := '';
   if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/AMOUNTONFORCEAUTH', 'FALSE')) then begin
      amount := ValidCharsOnly(AQueryFields.Values['AMOUNT'], false, true, '.');
   end;
   RequestXML := TStringList.Create();
   ResponseXML := TStringList.Create();

   RequestXML.Add('<TRANSACTION>');
   RequestXML.Add('<RNID>' + rnidL + '</RNID>');
   RequestXML.Add('<TRANSACTIONTYPE>CCFORCEAUTH</TRANSACTIONTYPE>');
   RequestXML.Add('<CCSYSTEMCODE>' + systemCodeL + '</CCSYSTEMCODE>');
   RequestXML.Add('<TRANIDENT>' + tranident + '</TRANIDENT>');
   if (amount <> '') then begin
      RequestXML.Add('<CCAMT>' + amount + '</CCAMT>');
   end;
   RequestXML.Add('<ENCODING>UTF-8</ENCODING>');

   if appServerSI <> '' then RequestXML.Add('<SOLUTIONIDENT>' + appServerSI + '</SOLUTIONIDENT>'); //2016-9-19 jtm: Feat OT# 1145

   empIdentL := ''; //2017-11-16 jtm: F#2311
   if strtobool(OpenXMLGetTag('/CONFIGDATA/SENDEMPIDENT', '')) then begin
      if sessionUsername <> '' then empIdentL := sessionUsername
      else if (empIdentL = '') and (externalUsername <> '') then empIdentL := externalUsername;

      ProcessLog(ltInfo,'ProcessPortalPayment EmpIdent', empIdentL);
      if empIdentL <> '' then RequestXML.Add('<EMPIDENT>' + empIdentL + '</EMPIDENT>');
end;

   RequestXML.Add('</TRANSACTION>' + CRLF);
   VarEvaluator.AddValue('GatewayRNID', rnidL); //2017-05-24 jtm: F#1821
   ProcessPPSAPIXML(RequestXML.Text, ResponseXML, GetAppServerHost, 0);
   Result := Utility.GetXMLTag(ResponseXML, 'TRANRESPMESSAGE');

   RequestXML.Free;
   ResponseXML.Free;
end;

Function TCustomerInfoModule.VoidCC(const RNID, BatchSystemCode : String) : String;
var
   BDR : String;
   EmpIdent : string; //2017-11-16 jtm: F#2311
Begin
   BatchXML.Clear;
   Result := '';

   if Not ValidateRNID(RNID) then exit;

   BDR := '<TRANSACTION> <RNID>'+RNID+'</RNID>' +
          '<TRANSACTIONTYPE>CCVOID</TRANSACTIONTYPE>' +
          '<CCSYSTEMCODE>' + BatchSystemCode + '</CCSYSTEMCODE>';

   if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then    //2016-9-19 jtm: Feat OT# 1145
      BDR := BDR + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';

   EmpIdent := '';
   if ((OpenXMLGetTag('/CONFIGDATA/SENDEMPIDENT', '') = 'TRUE') and
   ((SessionVarEval.GetValueAsString('Session.Username') <> '') or (ExternalXMLGetTag('/EXTERNALXML/USERNAME') <> ''))) then begin
      EmpIdent := SessionVarEval.GetValueAsString('Session.Username');
      if EmpIdent = '' then EmpIdent := trim(ExternalXMLGetTag('/EXTERNALXML/USERNAME'));
      ProcessLog(ltInfo,'ProcessPortalPayment EmpIdent', EmpIdent);
      if (EmpIdent <> '') then begin
         BDR := BDR + '<EMPIDENT>'+EmpIdent+'</EMPIDENT>';
      end;
   end;

   BDR := BDR + ' </TRANSACTION>'+CRLF;
   VarEvaluator.AddValue('GatewayRNID',RNID);//2017-05-24 jtm: F#1821
   ProcessPPSAPIXML(BDR, BatchXML,GetAppServerHost,0);
   Result := Utility.GetXMLTag(BatchXML,'TRANRESPMESSAGE');
end;
Function TCustomerInfoModule.ReverseCC(RNID : String;BatchSystemCode : String) : String;
var
   BDR : String;
   EmpIdent : string;
Begin
   BatchXML.Clear;
   Result := '';

   if Not ValidateRNID(RNID) then exit;

   BDR := '<TRANSACTION> <RNID>'+RNID+'</RNID>' +
          '<TRANSACTIONTYPE>CCREVERSE</TRANSACTIONTYPE>' +
          '<CCSYSTEMCODE>' + BatchSystemCode + '</CCSYSTEMCODE>';

   if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then
      BDR := BDR + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';

   EmpIdent := '';
   if ((OpenXMLGetTag('/CONFIGDATA/SENDEMPIDENT', '') = 'TRUE') and
   ((SessionVarEval.GetValueAsString('Session.Username') <> '') or (ExternalXMLGetTag('/EXTERNALXML/USERNAME') <> ''))) then begin
      EmpIdent := SessionVarEval.GetValueAsString('Session.Username');
      if EmpIdent = '' then EmpIdent := trim(ExternalXMLGetTag('/EXTERNALXML/USERNAME'));
      ProcessLog(ltInfo,'ProcessPortalPayment EmpIdent', EmpIdent);
      if (EmpIdent <> '') then begin
         BDR := BDR + '<EMPIDENT>'+EmpIdent+'</EMPIDENT>';
      end;
   end;

   BDR := BDR + ' </TRANSACTION>'+CRLF;
   VarEvaluator.AddValue('GatewayRNID',RNID);
   ProcessPPSAPIXML(BDR, BatchXML,GetAppServerHost,0);
   Result := Utility.GetXMLTag(BatchXML,'TRANRESPMESSAGE');
end;

Function TCustomerInfoModule.IssueCreditcc(RNID : String;BatchSystemCode : String; Amount : Currency; TranIdent : String) : String;
var
   BDR : String;
   EmpIdent : string;//2017-11-16 jtm: F#2311
Begin
   Result := '';

   if Not ValidateRNID(RNID) then exit;

   BDR := '<TRANSACTION> <RNID>'+RNID+'</RNID>' +
          '<TRANSACTIONTYPE>CCCREDIT</TRANSACTIONTYPE>' +
          '<ENCODING>UTF-8</ENCODING>' +
          '<CCAMT>' + Trim(StriReal(Amount,2)) + '</CCAMT>' +
          '<CUSTIDENT>' + GetXMLTag(BatchXML,'TRANCUSTOMERCODE') + '</CUSTIDENT>' +
          '<STATIONIDENT>WEBSITE</STATIONIDENT>' +

          '<CCLOOKUPSYSTEMCODE>' + BatchSystemCode + '</CCLOOKUPSYSTEMCODE>';
          
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ALLOWTRANIDENTONCREDIT', 'FALSE') = 'TRUE') then begin //2017-11-16 ajs: F#2276
      BDR := BDR + '<TRANIDENT>' + TranIdent + '</TRANIDENT>';
   end else begin
      BDR := BDR + '<TRANIDENT>' + GetXMLTag(BatchXML,'TRANIDENT') + '</TRANIDENT>';
   end;

   if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then   //2016-9-19 jtm: Feat OT# 1145
      BDR := BDR + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';

   if (GetXMLTag(BatchXML,'CARDNAME') <> '') then
      BDR := BDR + '<CCNAME>' + GetXMLTag(BatchXML,'CARDNAME') + '</CCNAME>'; //2017-5-10 jtm: Feat OT# 1595

   if (GetXMLTag(BatchXML,'CCSERVICENAME') <> '') then
      BDR := BDR + '<SERVICENAME>' + GetXMLTag(BatchXML,'CCSERVICENAME') + '</SERVICENAME>'; //2017-06-20 jtm: F#1884

   EmpIdent := '';
   if ((OpenXMLGetTag('/CONFIGDATA/SENDEMPIDENT', '') = 'TRUE') and
   ((SessionVarEval.GetValueAsString('Session.Username') <> '') or (ExternalXMLGetTag('/EXTERNALXML/USERNAME') <> ''))) then begin
      EmpIdent := SessionVarEval.GetValueAsString('Session.Username');
      if EmpIdent = '' then EmpIdent := trim(ExternalXMLGetTag('/EXTERNALXML/USERNAME'));
      ProcessLog(ltInfo,'ProcessPortalPayment EmpIdent', EmpIdent);
      if (EmpIdent <> '') then begin
         BDR := BDR + '<EMPIDENT>'+EmpIdent+'</EMPIDENT>';
      end;
   end;

   BDR := BDR + ' </TRANSACTION>'+CRLF;
   VarEvaluator.AddValue('GatewayRNID',RNID);//2017-05-24 jtm: F#1821
   ProcessPPSAPIXML(BDR, BatchXML,GetAppServerHost,0);
   Result := Utility.GetXMLTag(BatchXML,'TRANRESPMESSAGE');
end;
Function TCustomerInfoModule.ChargeAgainCC(const RNID, BatchSystemCode : String; Amount : Currency; tranIdentP : String = ''; custIdentP : String = ''; ccAuthType: String = 'SALE') : String; //2019-5-15 SS DVST-4406
const
   METHOD_NAME = 'TCustomerInfoModule.ChargeAgainCC(...)'; //2019-5-15 SS DVST-4406
var
   BDR : String;
   EmpIdent : string; //2017-11-16 jtm: F#2311
   tranIdentL, custIdentL : string;
Begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN'); //2019-5-15 SS DVST-4406
   Result := '';

   if Not ValidateRNID(RNID) then exit;

   tranIdentL := ValidCharsOnly(tranIdentP, true, true, '.-_:/& ');
   custIdentL := ValidCharsOnly(custIdentP, true, true, '.-_:/& ');

   if tranIdentL = '' then begin
      tranIdentL := GetXMLTag(BatchXML, 'TRANIDENT');
   end;
   if custIdentL = '' then begin
      custIdentL := GetXMLTag(BatchXML, 'TRANCUSTOMERCODE');
   end;

   BDR := '<TRANSACTION> <RNID>'+RNID+'</RNID>' +
          '<TRANSACTIONTYPE>CCAUTH</TRANSACTIONTYPE>' +
          '<ENCODING>UTF-8</ENCODING>' +
          '<CCAMT>' + Trim(StriReal(Amount,2)) + '</CCAMT>' +
          '<TRANIDENT>' + tranIdentL + '</TRANIDENT>' +
          '<CUSTIDENT>' + custIdentL + '</CUSTIDENT>' +
          '<STATIONIDENT>WEBSITE</STATIONIDENT>' +
          '<CCLOOKUPSYSTEMCODE>' + BatchSystemCode + '</CCLOOKUPSYSTEMCODE>';

   BDR := BDR + '<CCAUTHTYPE>' + ccAuthType + '</CCAUTHTYPE>'; //2019-5-15 SS DVST-4406

   if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then  //2016-9-19 jtm: Feat OT# 1145
      BDR := BDR + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';
   if (GetXMLTag(BatchXML,'CARDNAME') <> '') then
      BDR := BDR + '<CCNAME>' + GetXMLTag(BatchXML,'CARDNAME') + '</CCNAME>'; //2017-5-10 jtm: Feat OT# 1595
   if (GetXMLTag(BatchXML,'CCSERVICENAME') <> '') then
      BDR := BDR + '<SERVICENAME>' + GetXMLTag(BatchXML,'CCSERVICENAME') + '</SERVICENAME>'; //2017-06-20 jtm: F#1884

   EmpIdent := '';
   if ((OpenXMLGetTag('/CONFIGDATA/SENDEMPIDENT', '') = 'TRUE') and
   ((SessionVarEval.GetValueAsString('Session.Username') <> '') or (ExternalXMLGetTag('/EXTERNALXML/USERNAME') <> ''))) then begin
      EmpIdent := SessionVarEval.GetValueAsString('Session.Username');
      if EmpIdent = '' then EmpIdent := trim(ExternalXMLGetTag('/EXTERNALXML/USERNAME'));
      ProcessLog(ltInfo,'ProcessPortalPayment EmpIdent', EmpIdent);
      if (EmpIdent <> '') then begin
         BDR := BDR + '<EMPIDENT>'+EmpIdent+'</EMPIDENT>';
      end;
   end;

   BDR := BDR + ' </TRANSACTION>'+CRLF;
   VarEvaluator.AddValue('GatewayRNID',RNID);//2017-05-24 jtm: F#1821
   ProcessLog(ltInfo, METHOD_NAME, 'BDR - '+BDR); //2019-5-15 SS DVST-4406: existing code had processlog with ltwarning. changed that to ltinfo
   ProcessPPSAPIXML(BDR, BatchXML,GetAppServerHost,0);
   Result := Utility.GetXMLTag(BatchXML,'TRANRESPMESSAGE');
   ProcessLog(ltInfo, METHOD_NAME, 'END. RESULT - '+Result); //2019-5-15 SS DVST-4406
end;

Function TCustomerInfoModule.UserIs(Param : String; RNID : string) : boolean;
Begin
   result := False;
   If Param = 'READONLY' then begin
      Result := UserXMLGetTag('/USERPROFILE/READONLY','TRUE') = 'TRUE';
      if UserXMLGetTag('/USERPROFILE/CHAINACCESS/CHAIN[@ID="'+trim(Stri(ChainCode,-1))+'"]/READONLY') <> '' then  Result := UserXMLGetTag('/USERPROFILE/CHAINACCESS/CHAIN[@ID="'+trim(Stri(ChainCode,-1))+'"]/READONLY') = 'TRUE';
      if UserXMLGetTag('/USERPROFILE/RNIDACCESS/RNID[@ID="'+trim(RNID)+'"]/READONLY') <> '' then  Result := UserXMLGetTag('/USERPROFILE/RNIDACCESS/RNID[@ID="'+trim(RNID)+'"]/READONLY') = 'TRUE';
      if VarEvaluator.GetValueAsString('ServiceName') <> '' then begin //2017-05-10 jtm: F#1564
         if UserXMLGetTag('/USERPROFILE/RNIDACCESS/RNID[@ID="'+trim(RNID)+'"]/SERVICENAMES/SERVICENAME[@ID="'+trim(VarEvaluator.GetValueAsString('ServiceName'))+'"]/READONLY') <> '' then begin
            Result := UserXMLGetTag('/USERPROFILE/RNIDACCESS/RNID[@ID="'+trim(RNID)+'"]/SERVICENAMES/SERVICENAME[@ID="'+trim(VarEvaluator.GetValueAsString('ServiceName'))+'"]/READONLY') = 'TRUE';
         end;
      end;
      if (UserXMLGetTag('/USERPROFILE/READONLY') = '') and (ExternalXMLGetTag('/EXTERNALXML/READONLY') <> '') then begin //2016-8-22 jtm: Feat OT#1074
          Result := ExternalXMLGetTag('/EXTERNALXML/READONLY') = 'TRUE';
      end;
   end else if Param = 'CHARGEAGAIN' then begin //2019-02-13 jtm: DVST-3067
      Result := UserXMLGetTag('/USERPROFILE/ALLOWCHARGEAGAIN','FALSE') = 'TRUE';
   end;
end;

Function TCustomerInfoModule.RetrieveReceipt(RNID : String;SystemCode : String;TicketGUID: string;TranType: string) : String;
const
   METHOD_NAME = 'RetrieveReceipt(...)'; //2019-3-13 ss DVST-3849
var
   ReceiptXML : TStringList;
   ReceiptText : TStringList;
   BDR : String;
   UseOldReceiptMethod:boolean;
   POSTranObj: TPOSEnterpriseTransaction; //2018-03-14 jtm F#3832
   ReceiptGen: TPOSEnterpriseReceiptGen;
   POSTicketXMLReq : string;
   POSTicketXMLResp : TStringList;
   ReciptTxt : string;
Begin
   ReceiptXML := TStringList.Create;
   ReceiptText := TStringList.Create;
   POSTicketXMLResp := TStringList.Create;
   Result := '';
   UseOldReceiptMethod := true;
   if Not ValidateRNID(RNID) then exit;

   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINRECEIPTS/USEPROFILECONFIG', 'FALSE') = 'TRUE') then begin
      if (OpenXMLGetTag('/CONFIGDATA/RUNTIMEPROFILE','LOCAL') = 'LOCAL') then begin
         ProfileXML := TTProfileXML.Create(StrToInt(RNID), HDQuery);
      end else if (OpenXMLGetTag('/CONFIGDATA/RUNTIMEPROFILE','LOCAL') = 'GW') then begin
         RNProfileDI := TTADODataLayer.Create(RNDB);
         RNProfile := TTProfile.Create(RNID,false, RNProfileDI);
      end;
      ProcessLog(ltDebug,'RNProfile: RNID;get USEOLDRECEIPTS profile xml',RNID + ';' + GetProfileXMLValueAsString('/PROFILE/DRAWERSETTINGS/USEOLDRECEIPTS',''));
      UseOldReceiptMethod := GetProfileXMLValueAsBoolean('/PROFILE/DRAWERSETTINGS/USEOLDRECEIPTS',true);
   end;
   if not (UseOldReceiptMethod) and (TicketGUID <> '') then begin
      POSTicketXMLReq := '<TRANSACTION>' +
         '   <TRANSACTIONTYPE>POSTICKETLOOKUP</TRANSACTIONTYPE>'+
         '<POSEFEATURESET>'+OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINRECEIPTS/POSEFEATURESET', '')+'</POSEFEATURESET>'+
         '   <TICKETGUID>' + TicketGUID + '</TICKETGUID>'+
         '</TRANSACTION>';
      ProcessLog(ltInfo,'RetrieveReceipt: TicketGUID', TicketGUID);
      POSTicketAPI.GeneratePOSResponse(POSTicketXMLReq, 'POSTICKETLOOKUP');
      POSTicketXMLResp := POSTicketAPI.XMLResp;
      if (GetXMLTagStr(POSTicketXMLResp.Text,'TRANSUCCESS')<>'TRUE') then begin
         ProcessLog(ltWarning,'RetrieveReceipt: POSTicketAPI.GeneratePOSResponse failed:', GetXMLTagStr(POSTicketXMLResp.Text,'TRANRESPMESSAGE'));
      end;
   end;
   ProcessLog(ltInfo,'RetrieveReceipt: SystemCode;RNID;TranType;TicketGUID;UseOldReceiptMethod', SystemCode + ';' +  RNID + ';' + TranType + ';' + TicketGUID + ';' + BoolToStr(UseOldReceiptMethod));
   if (UseOldReceiptMethod) then begin
      if (TranType = 'CCRECEIPTRETRIEVE') then begin
         BDR := '<TRANSACTION> <RNID>'+RNID+'</RNID>' +
             '<TRANSACTIONTYPE>'+TranType+'</TRANSACTIONTYPE>' +
             '<ENCODING>UTF-8</ENCODING>' +
             '<CCSYSTEMCODE>' + SystemCode + '</CCSYSTEMCODE>';

         if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then   //2016-9-19 jtm: Feat OT# 1145
            BDR := BDR + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';

         BDR := BDR + ' </TRANSACTION>'+CRLF;
         VarEvaluator.AddValue('GatewayRNID',RNID);//2017-05-24 jtm: F#1821
         ProcessPPSAPIXML(BDR, ReceiptXML,GetAppServerHost,0);
         ExtractReceipt(ReceiptXML,ReceiptText);

         ReciptTxt := ReceiptText.Text;
         if (FileExists('C:\inetpub\wwwroot\'+ DomainHostFolder +'\' + RNID + '\CCReceiptLogo.bmp')) then begin
             ReciptTxt := '<img src="https://'+ ValidCharsOnly(Request.Host,True,True,'.-')+ '/' + DomainHostFolder +'/' + RNID + '/CCReceiptLogo.bmp" alt="" title="" /><br><br>' + ReciptTxt;
         end;
         if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/INCLUDESIGONPRINT', 'FALSE') = 'TRUE' then begin  //2017-05-24 jtm F#1812
            if (GetXMLTagStr(ReceiptXML.Text,'SIGDATATYPE') = '4') then begin
               ReciptTxt := ReciptTxt + '<img src="data:image/bmp;base64,'+STDBase64Encode(XYZtoBMP(GetXMLTag(ReceiptXML,'SIGDATA')))+'" alt="" title="" width="300" height="100" /><br><br>';
            end else if (GetXMLTagStr(ReceiptXML.Text,'SIGDATATYPE') = '3') then begin
               ReciptTxt := ReciptTxt + '<img src="data:image/bmp;base64,'+GetXMLTag(ReceiptXML,'SIGDATA')+'" alt="" title=""  width="300" height="100"/><br><br>';
            end;
         end;
      end else begin
         ReciptTxt := 'Only Card Transactions are supported with this configuration';
      end;
   end else begin
      SessionVarEval.AddValue('RuntimeRNID',RNID);
      VarEvaluator.AddValue('GatewayRNID',RNID);  //2018-05-23 jtm: D#
      InitializeRuntimeInfo();
      ReceiptGen := TPOSEnterpriseReceiptGen.Create(RuntimeInfo,nil);
      if (POSTicketXMLResp.Text <> '') and (GetXMLTagStr(POSTicketXMLResp.Text,'TRANSUCCESS')='TRUE') then begin
         POSTranObj := TPOSEnterpriseTransaction.Create(SubmitInteractiveXML, GetProfileXMLValueAsBoolean('/PROFILE/DRAWERSETTINGS/POSETICKETACTIVITYENABLED', false));
         POSTranObj.SetSubmitPPSAPIXML(ProcessPPSAPIXML);
         POSTranObj.SetSubmitInteractiveXML(ProcessPPSAPIXML);
         POSTranObj.RecallTicketFromXML(POSTicketXMLResp.Text);
         ReciptTxt := ReceiptGen.GenerateSaleReceipt(POSTranObj, true);
         ProcessLog(ltInfo,'RetrieveReceipt: Receipt generated from POSTicketXMLResp', TicketGUID);
      end else begin
         if (TranType = 'CCRECEIPTRETRIEVE') then begin
            ReciptTxt := ReceiptGen.GenerateCardReceipt(SystemCode,'',ProcessPPSAPIXML);
         end else if (TranType = 'TCBATCHDETAIL') then begin
            ReciptTxt := ReceiptGen.GenerateCheckReceipt(SystemCode,ProcessPPSAPIXML);
         end else if (TranType = 'CASHBATCHDETAIL') then begin
            ReciptTxt := ReceiptGen.GenerateCashReceipt(SystemCode,ProcessPPSAPIXML);
         end;
      end;
      ReplaceString(ReciptTxt,CRLF,'<BR>');
      if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINRECEIPTS/INCLUDESIGONPRINT', 'FALSE') = 'TRUE' then begin
         if (ReceiptGen.SigDataType = 4) then begin
            ReciptTxt := ReciptTxt + '<img src="data:image/bmp;base64,'+STDBase64Encode(XYZtoBMP(ReceiptGen.SigData))+'" alt="" title="" width="300" height="100" /><br><br>';
         end else if (ReceiptGen.SigDataType = 3) then begin
            ReciptTxt := ReciptTxt + '<img src="data:image/bmp;base64,'+ReceiptGen.SigData+'" alt="" title=""  width="300" height="100"/><br><br>';
         end;
      end;
   end;
   if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYRNIDONPAYMENTMATERECEIPT', 'FALSE')) then begin
      ReciptTxt := RNID + ' ' + ReciptTxt;
   end;
   result := ReciptTxt;
   ReceiptXML.Free;
   ReceiptText.Free;
   POSTicketXMLResp.Free;
   FreeAndNil(ReceiptGen);
   FreeAndNil(RuntimeInfo);
end;

function TCustomerInfoModule.SubmitInteractiveXML(RequestXMLStr: string): string;
begin
end;

Function TCustomerInfoModule.EmailReceipt(const EmailAddress : String; const RNID : String; const SystemCode : String; const TicketGUID: string; const TranType:String) : String;
var
   queryType : String;
   ReceiptData : String;
   HtmlEmail : String;
   HtmlEmailTemplate : String;
begin
   ProcessLog(ltInfo,'Email Customer Receipt', 'ToEmail: '+ EmailAddress + ' RNID: '+ RNID + ' SystemCode: '+ SystemCode );
   if (TranType = 'CARD') then begin
      queryType := 'CCRECEIPTRETRIEVE';
   end else if (TranType = 'CHECK') then begin
      queryType := 'TCBATCHDETAIL';
   end else if (TranType = 'CASH') then begin
      queryType := 'CASHBATCHDETAIL';
   end;
   ReceiptData := '';
   HtmlEmail := '';
   ReceiptData := RetrieveReceipt(RNID, SystemCode, TicketGUID, queryType);

   HtmlEmailTemplate := LoadWebFileFromFolder('customer_receipt.htm','');
   If HtmlEmailTemplate <> '' then begin
      HtmlEmail := HtmlEmailTemplate;
   end else begin
      HtmlEmail := LoadWebFileFromFolder('customer_receipt.htm','PPADMIN');
   end;
   ReplaceString(HtmlEmail, '%RECEIPT%', ReceiptData);

   clMail.BuildMessage('',HtmlEmail);
   clMail.From.FullAddress := '"' + DomainFriendlyName+'"<'+DomainSendAsEmail+'>';
   clMail.ToList.EmailAddresses := EmailAddress;
   clMail.BCCList.EmailAddresses := GetConfigString('CONFIRMATIONBCC','');

   if SessionVarEval.GetValueAsString('BCCEMAIL') <> '' then
      clMail.BCCList.EmailAddresses := clMail.BCCList.EmailAddresses + ',' + SessionVarEval.GetValueAsString('BCCEMAIL');
   if SessionVarEval.GetValueAsString('EmployeeEmail') <> '' then  
      clMail.BCCList.EmailAddresses := clMail.BCCList.EmailAddresses + ',' + SessionVarEval.GetValueAsString('EmployeeEmail');

   ProcessLog(ltInfo,'bccemails', clMail.BCCList.EmailAddresses);
   clMail.Subject := 'Payment Transaction Receipt';
   clMail.ReplyTo := GetConfigString('CONFIRMATIONREPLYTO','');
   
   SMTP.Open();
   try
      try
         SMTP.Send(clMail);
         result := 'Email sent.';
      except
        On E:Exception do begin
            ProcessLog(ltWarning,'Exception on Sending Email ', E.Message);
            result := 'Error Occured, Email not sent.';
        end;
      end;
   finally
      SMTP.Close();
   end;
end;

Procedure TCustomerInfoModule.ExtractReceipt(ReceiptXML : TStringList;ReceiptText : TStringList);
var
   LC : Integer;
   I : Integer;
Begin
   LC := Valu(GetXMLTagStr(ReceiptXML.Text,'RECEIPTLINES'));
   ReceiptText.Clear;
   For I := 1 to LC DO begin
      ReceiptText.Add(GetXMLTagStr(ReceiptXML.Text,'RECEIPT' + Stri(I,-1)) + '<BR>');
   end;

end;

procedure TCustomerInfoModule.DecodeToFile(const base64: AnsiString; const FileName: string);
var
  stream: TFileStream;
  bytes: String;
begin
  bytes := Cardutil.STDBase64Decode(base64);

  SaveStringAsFile(FileName,bytes);
end;
Function TCustomerInfoModule.ShowStore(XMLStr : String): boolean;
var
   StoreXML : TOpenXML;
   Hidden : String;
begin
   Result := True;
   if XMLStr <> '' then begin
      Hidden := UpcaseString(GetXMLTagStr(XMLStr, 'HIDDEN'));
      if Hidden = 'TRUE' then begin
         Result := False;
      end else begin
         Result := True;
      end;

   end;
end;
Function TCustomerInfoModule.BCryptPassword(pw : string; custguid: string): string;
var
   base64PW : string;
begin
    base64PW := AWSAPI.CalcSHA256(custguid+pw);


    base64PW := CardUtil.STDBase64Encode(base64PW);

    result := TBCrypt.HashPassword(base64PW);

end;
Function TCustomerInfoModule.CheckBCryptPassword(pw : string; custguid: string; hash : string): boolean;
var
   base64PW : string;
begin
    result := false;
    if hash <> '' then begin
       base64PW := AWSAPI.CalcSHA256(custguid+pw);


       base64PW := CardUtil.STDBase64Encode(base64PW);

       result := TBCrypt.CheckPassword(base64PW,hash);
    end;

end;
Procedure TCustomerInfoModule.InitVars;
Begin
  PL.AddAppValue('HOSTNAME', Trim(UpCaseString(Request.Host)));
  PL.AddAppValue('REMOTEIP', GetRemoteAddress);
  PL.AddAppValue('BYTESRX', Stri(Length(Request.Content),-1));
  PL.AddAppValue('CONTENTTYPE',  Request.ContentType);
  PL.AddAppValue('USERAGENT',  Request.Useragent);
  PL.AddAppValue('URL',  Request.PathInfo);
  PL.AddAppValue('METHOD',  Request.Method);
end;
Procedure TCustomerInfoModule.SaveSessionVarEval;
Var
   ADS : TADOQuery;
   WS : String;
Begin
   If SessionVarEval.Vars.Count = 0 then exit;
   If SessionSC = 0 then exit;
   ProcessLog(ltInfo,'Saving Session Vars',InstanceGUID);

   ADS := NewADOQUery;
   Try
      ADS.SQL.Clear;
      ADS.ParamCheck := True;
      ADS.SQL.Add('Select * from wwwsession where systemcode = :SystemCode');
      ADS.Parameters.ParamByName('SystemCode').Value := SessionSC;
      ADS.Open;
      If ADS.RecordCount = 1 then begin
         ADS.Edit;
         ADS.FieldByName('SessionVars').AsString := SessionVarEval.Vars.Text;
         ADS.Post;
      end else begin
         ProcessLog(ltWarning,'Session not found in WWWSession ' + Stri(SessionSC,-1),InstanceGUID);
      end;
   except
      on E:Exception do begin
         ProcessLog(ltWarning,'Exception Saving Session Vars' + E.Message,InstanceGUID);
      end;
   end;

   Ads.Free;

end;

function TCustomerInfoModule.GetDrawerQueryTable(RNID: String; FromDate, ThruDate: TDateTime; DisplayFormat: String): String;
var
   PosStart : string;
   QueryCount : string;
   QuerySQLText : string;
   QueryOrderBy : string;
   QueryOrderDirect : string;
   QueryTotalCount : string;
   QueryColList : TStringList;
   RNIDList : TStringList;
   TabLines : string;
   TabLine: string;
   StationIdent : string;
   EmpIdent : string;
   IsOpenDate : boolean;
   IsOpenEmp : boolean;
   DisplayInTZ : boolean;
begin
      ProcessLog(ltinfo,'GetDrawerQueryTable','Begin GetDrawerQueryTable');
      Result := '';
      PosStart := '0';
      QueryCount := '100';
      QuerySQLText := '';
      QueryOrderBy := '';
      QueryOrderDirect := '';
      IsOpenDate := true;
      DisplayInTZ := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE'));

      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['posStart']))) <> '' then begin
          PosStart := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['posStart'])));
      end;
      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['count']))) <> '' then begin
          QueryCount := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['count'])));
      end;
      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['orderby']))) <> '' then begin
          QueryOrderBy := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['orderby'])));
      end;
      if ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['direct'])),true,false,'') <> '' then begin
          QueryOrderDirect := ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['direct'])),true,false,'');
      end;
      if ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['StationIdent'])),true,true,'.- _:/,&') <> '' then begin
          StationIdent := ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['StationIdent'])),true,true,'.- _:/,&');
      end;
      if ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['EmpIdent'])),true,true,'.- _:/,&') <> '' then begin
          EmpIdent := ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['EmpIdent'])),true,true,'.- _:/,&');
      end;
      if ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['OpenDate'])),true,false,'') <> '' then begin
          IsOpenDate := ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['OpenDate'])),true,false,'') = 'TRUE';
      end;
      if ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['OpenEmp'])),true,false,'') <> '' then begin
          IsOpenEmp := ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['OpenEmp'])),true,false,'') = 'TRUE';
      end;


      QuerySQLText := 'SELECT';
      if (DisplayInTZ) then begin
         QuerySQLText := QuerySQLText + ' CASE r.KeyValue WHEN ''AST'' THEN DATEADD(hour,+1,OpenDate) WHEN ''CST'' THEN DATEADD(hour,-1,OpenDate) WHEN ''MST'' THEN DATEADD(hour,-2,OpenDate) ' +
                             'WHEN ''PST'' THEN DATEADD(hour,-3,OpenDate) WHEN ''AKST'' THEN DATEADD(hour,-4,OpenDate)' +
                             'WHEN ''HAST'' THEN DATEADD(hour,-'+HASTOffsetEST+',OpenDate) ELSE OpenDate END OpenDatetz,'+
                             'CASE r.KeyValue WHEN ''AST'' THEN DATEADD(hour,+1,CloseDate) WHEN ''CST'' THEN DATEADD(hour,-1,CloseDate) WHEN ''MST'' THEN DATEADD(hour,-2,CloseDate) ' +
                             'WHEN ''PST'' THEN DATEADD(hour,-3,CloseDate) WHEN ''AKST'' THEN DATEADD(hour,-4,CloseDate)' +
                             'WHEN ''HAST'' THEN DATEADD(hour,-'+HASTOffsetEST+',CloseDate) ELSE CloseDate END CloseDatetz,r.KeyValue as TZ, ';
      end;
      QuerySQLText := QuerySQLText + '*, ROW_NUMBER() OVER (ORDER BY ';

      QueryColList := TStringList.Create;
      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINDRAWER/INCLUDEDRAWERRNIDCOLUMN','FALSE') = 'TRUE') then begin //2017-11-16 jtm: F#2264
         QueryColList.CommaText := 'Profile,OpenEmpIdent,CloseEmpIdent,OpenBalance,CloseBalance,VarianceReason,OpenDate,CloseDate,StationIdent';
      end else begin
         QueryColList.CommaText := 'OpenEmpIdent,CloseEmpIdent,OpenBalance,CloseBalance,VarianceReason,OpenDate,CloseDate,StationIdent';
      end;

      if (QueryOrderBy <> '') and not(StrToInt(QueryOrderBy) >= QueryColList.Count) then begin
         QuerySQLText := QuerySQLText + QueryColList[StrToInt(QueryOrderBy)];
      end else begin
         QuerySQLText := QuerySQLText + ' OpenDate';
      end;
      FreeAndNil(QueryColList);
      if QueryOrderDirect = 'DES' then QuerySQLText := QuerySQLText + ' desc';
      QuerySQLText := QuerySQLText +  ',DrawerIdent) as row FROM (select (CashCounted) as CloseBalance, * from Drawer) as data';
      if (DisplayInTZ) then begin
         QuerySQLText := QuerySQLText +' left outer join REGISTRY r on r.SubKey1 = Profile';
      end;
      if RNID = 'ALL' then begin
         RNIDList := TStringList.Create;
         GetChainRNIDs(RNIDList);
         QuerySQLText := QuerySQLText + ' where Profile in (' + RNIDList.CommaText + ')';
         RNIDList.Free;
      end else begin
         QuerySQLText := QuerySQLText + ' where Profile = ' + RNID;
      end;

      if (DisplayInTZ) then begin
         QuerySQLText := QuerySQLText + ' and r.subkey2 = ''storetz''';
      end;
      If FromDate > 0 then begin
         if (DisplayInTZ) then begin
            if IsOpenDate then begin
               QuerySQLText := QuerySQLText + ' and (OpenDate >= case r.KeyValue WHEN ''AST'' THEN @BegDateAST WHEN ''CST'' THEN @BegDateCST WHEN ''MST'' THEN @BegDateMST WHEN ''PST'' THEN @BegDatePST WHEN ''AKST'' THEN @BegDateAKST WHEN ''HAST'' THEN @BegDateHAST ELSE @BegDate END)'; //figure out DST for AZ and HI
            end else begin
               QuerySQLText := QuerySQLText + ' and (CloseDate >= case r.KeyValue WHEN ''AST'' THEN @BegDateAST WHEN ''CST'' THEN @BegDateCST WHEN ''MST'' THEN @BegDateMST WHEN ''PST'' THEN @BegDatePST WHEN ''AKST'' THEN @BegDateAKST WHEN ''HAST'' THEN @BegDateHAST ELSE @BegDate END)'; //figure out DST for AZ and HI
            end;
         end else begin
            if IsOpenDate then begin
               QuerySQLText := QuerySQLText + ' And (OpenDate >= @BegDate)'
            end else begin
               QuerySQLText := QuerySQLText + ' And (CloseDate >= @BegDate)';
            end;
         end;
      end;

      If ThruDate > 0 then begin
         if (DisplayInTZ) then begin
            if IsOpenDate then begin
               QuerySQLText := QuerySQLText +' and (OpenDate < case r.KeyValue WHEN ''AST'' THEN @EndDateAST WHEN ''CST'' THEN @EndDateCST WHEN ''MST'' THEN @EndDateMST WHEN ''PST'' THEN @EndDatePST WHEN ''AKST'' THEN @EndDateAKST WHEN ''HAST'' THEN @EndDateHAST ELSE @EndDate END)';
            end else begin
               QuerySQLText := QuerySQLText +' and (CloseDate < case r.KeyValue WHEN ''AST'' THEN @EndDateAST WHEN ''CST'' THEN @EndDateCST WHEN ''MST'' THEN @EndDateMST WHEN ''PST'' THEN @EndDatePST WHEN ''AKST'' THEN @EndDateAKST WHEN ''HAST'' THEN @EndDateHAST ELSE @EndDate END)';
            end;
         end else begin
            if IsOpenDate then begin
               QuerySQLText := QuerySQLText + ' And (OpenDate < @EndDate)';
            end else begin
               QuerySQLText := QuerySQLText + ' And (CloseDate < @EndDate)';
            end;
         end;
      end;
      If EmpIdent <> '' then begin
         QuerySQLText := QuerySQLText + ' And (OpenEmpIdent like ''' + EmpIdent + '%'''+ 'or CloseEmpIdent like ''' + EmpIdent + '%'')';
      end;
      If StationIdent <> '' then
         QuerySQLText := QuerySQLText + ' And StationIdent like ''' + StationIdent + '%''';

      if StrToInt(PosStart) = 0 then begin
         RNQuery.Close;
         RNQuery.SQL.Clear;
         RNQuery.SQL.Add('SET ARITHABORT ON;');
         RNQuery.SQL.Add(DRSQLVarsDec);
         RNQuery.SQL.Add('Set @StartPos = '+ PosStart +'; set @count = '+ QueryCount +';');
         RNQuery.SQL.Add('set @BegDate = ''' + FormatDateTime('MM/DD/YYYY', Fromdate) + '''; set @EndDate =''' + FormatDateTime('MM/DD/YYYY', ThruDate + 1) + ''';');
         RNQuery.SQL.Add(DRSQLSetTZ);
         RNQuery.SQL.Add('set @BegDateHAST = DATEADD(hour,+'+HASTOffsetEST+',@BegDate);set @EndDateHAST = DATEADD(hour,+'+HASTOffsetEST+',@EndDate); ');
         RNQuery.SQL.Add(QuerySQLText);
         ProcessLog(ltDebug,'GetDrawerQueryTable','PosStart 0 Query : '+RNQuery.SQL.text);
         RNQuery.Open;
         QueryTotalCount := IntToStr(RNQuery.RecordCount);
         SessionVarEval.AddValue('DrawerQueryTotalCount', QueryTotalCount);
         ProcessLog(ltinfo,'GetDrawerQueryTable','Query Opened; Total Record Count: '+QueryTotalCount);
      end;
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('SET ARITHABORT ON;');
      RNQuery.SQL.Add(DRSQLVarsDec);
      RNQuery.SQL.Add('Set @StartPos = '+ PosStart +'; set @count = '+ QueryCount +';');
      RNQuery.SQL.Add('set @BegDate = ''' + FormatDateTime('MM/DD/YYYY', Fromdate) + '''; set @EndDate =''' + FormatDateTime('MM/DD/YYYY', ThruDate + 1) + ''';');
      RNQuery.SQL.Add(DRSQLSetTZ);
      RNQuery.SQL.Add('set @BegDateHAST = DATEADD(hour,+'+HASTOffsetEST+',@BegDate);set @EndDateHAST = DATEADD(hour,+'+HASTOffsetEST+',@EndDate); ');

      RNQuery.SQL.Add('SELECT * FROM (' + QuerySQLText);
      RNQuery.SQL.Add(') a where a.row > @StartPos and a.row <= (@StartPos +@count)');


      ProcessLog(ltinfo,'GetDrawerQueryTable','Query : '+RNQuery.SQL.text);
      RNQuery.Open;
      ProcessLog(ltinfo,'GetDrawerQueryTable','Query Opened; Partial Record Count: '+IntToStr(RNQuery.RecordCount));

      If RNQuery.RecordCount > 0 then begin
         RNQuery.DisableControls;
         if DisplayFormat = 'XML' then begin
            TabLine := '<?xml version="1.0" encoding="iso-8859-1"?><rows total_count='''+SessionVarEval.GetValueAsString('DrawerQueryTotalCount')+''' pos= '''+PosStart+'''>';
            TabLines := TabLine;
         end;
         TabLine := '';
         While Not RNQuery.EOF do begin
            if DisplayFormat = 'XML' then begin
               TabLine := '<row id="'+ RNQuery.FieldByName('row').AsString  +'">';
               if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINDRAWER/INCLUDEDRAWERRNIDCOLUMN','FALSE') = 'TRUE') then begin //2017-11-16 jtm: F#2264
                  TabLine := TabLine +  '<cell>' + Trim(RNQuery.FieldByName('Profile').AsString)+'</cell>';
               end;
               TabLine := TabLine + '<cell><![CDATA[<a href="javascript:GetDrawerDownload(''' + Trim(RNQuery.FieldByName('DrawerIdent').AsString)+''','''+Trim(RNQuery.FieldByName('Profile').AsString)+''')">'+Trim(RNQuery.FieldByName('OpenEmpIdent').AsString)+'</a>]]></cell>' +
                              '<cell>' + Trim(RNQuery.FieldByName('CloseEmpIdent').AsString)+'</cell>' +
                              '<cell>'+DisplayMoney(RNQuery.FieldByName('OpenBalance').AsCurrency)+'</cell>' +
                              '<cell>'+DisplayMoney(RNQuery.FieldByName('CloseBalance').AsCurrency)+'</cell>';
               if ((RNQuery.FieldByName('VarianceSignOffEmpIdent').AsString = '') and (RNQuery.FieldByName('VarianceReason').AsString <> '') and (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINDRAWER/ALLOWDRAWERAPPROVAL','FALSE') = 'TRUE')) then begin //2017-11-16 jtm: F#2264
                  TabLine := TabLine + '<cell><![CDATA[<a href="javascript:GetDrawerApprovalPage(''' + Trim(RNQuery.FieldByName('DrawerIdent').AsString)+''','''+Trim(RNQuery.FieldByName('Profile').AsString)+''')" style="color: red;">'+Trim(RNQuery.FieldByName('VarianceReason').AsString)+'</a>]]></cell>';
               end else begin
                  TabLine := TabLine + '<cell>'+Trim(RNQuery.FieldByName('VarianceReason').AsString)+'</cell>'; //2017-09-20 jtm: F#2093
               end;

               if RNQuery.FieldByName('OpenDate').AsString <> '' then begin
                  if (DisplayInTZ) then begin
                     TabLine := TabLine +  '<cell>' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',RNQuery.FieldByName('OpenDatetz').AsDateTime)+' ' + trim(RNQuery.FieldByName('TZ').AsString)+'</cell>';
                  end else begin
                     TabLine := TabLine +  '<cell>' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',RNQuery.FieldByName('OpenDate').AsDateTime)+' EST</cell>';
                  end;
               end else begin
                  TabLine := TabLine + '<cell></cell>';
               end;
               if RNQuery.FieldByName('CloseDate').AsString <> '' then begin
                  if (DisplayInTZ) then begin
                     TabLine := TabLine +  '<cell>' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',RNQuery.FieldByName('CloseDatetz').AsDateTime)+' ' + trim(RNQuery.FieldByName('TZ').AsString)+'</cell>';
                  end else begin
                     TabLine := TabLine +  '<cell>' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',RNQuery.FieldByName('CloseDate').AsDateTime)+' EST</cell>';
                  end;
               end else begin
                  TabLine := TabLine + '<cell></cell>';
               end;
               TabLine := TabLine + '<cell>' + Trim(RNQuery.FieldByName('StationIdent').AsString)+ '</cell>';
               TabLines := TabLines + TabLine + '</row>';
            end;

            RNQuery.Next;
         end;
      end else begin
          TabLines := '<?xml version="1.0" encoding="iso-8859-1"?><rows total_count="0" pos="0">';
      end;
      ProcessLog(ltinfo,'GetDrawerQueryTable','End');
      if DisplayFormat = 'XML' then begin
         Result := TabLines + '</rows>';
      end;
end;

function TCustomerInfoModule.GetEODShiftReport(ARNID, DrawerIdent: string): string;
var
   DrawerDetailXML, HTMLReport: TStringList;
   DrawerEODCardDtl, DrawerEODCashDtl,DrawerEODCheckDtl : TDataSet;
   CCBatchXML,TCBatchXML,CashBatchXML : TOpenXML;
   CCBatchXMLNode,TCBatchXMLNode,CashBatchXMLNode : TOPENXMLNode;
   CCBatchXMLStr,TCBatchXMLStr,CashBatchXMLStr : string;
   DrawerOpen, CashCounted,DrawerClose,Drawervariance,CashDeposit,CashCalculated : string; //2016-06-22 jtm
   CardTotal, CashTotal,VoucherTotal, CheckTotal, TCCheckTotal : Currency;
   WS, DrawerRequest, CustomField1Name, CustomField2Name, CustomField3Name, CustomField4Name, CustomField5Name, CustomField6Name : String;
   CustomField1Value, CustomField2Value, CustomField3Value, CustomField4Value, CustomField5Value, CustomField6Value : String;

   function BuildCustomFieldsTable: string;
   begin
      HTMLReport.Clear;
      CustomField1Name := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/NAME', '');
      CustomField2Name := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/NAME', '');
      CustomField3Name := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/NAME', '');
      CustomField4Name := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/NAME', '');
      CustomField5Name := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/NAME', '');
      CustomField6Name := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/NAME', '');

      CustomField1Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/VALUE', '');
      CustomField2Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/VALUE', '');
      CustomField3Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/VALUE', '');
      CustomField4Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/VALUE', '');
      CustomField5Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/VALUE', '');
      CustomField6Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/VALUE', '');
      HTMLReport.Add('<table>');
      HTMLReport.Add('	<tr>');
      if ((CustomField1Name <> '') and (CustomField1Value <> '')) then begin
         HTMLReport.Add('		<th align="left" style="padding-right: 10px;">' + CustomField1Name + '</th>');
         HTMLReport.Add('		<td align="left" style="padding-right: 10px;">' + CustomField1Value + '</td>');
      end;
      HTMLReport.Add('		<th align="left" style="padding-right: 10px;">User Name:</th>');
      HTMLReport.Add('		<td align="left" style="padding-right: 10px;">' + GetXMLTag(DrawerDetailXML, 'OPENEMPIDENT') + '</td>');
      HTMLReport.Add('		<th align="left" style="padding-right: 10px;">Drawer Open:</th>');
      HTMLReport.Add('		<td align="left" style="padding-right: 10px;">' + GetXMLTag(DrawerDetailXML, 'DRAWEROPENDATE') + '</td>');
      HTMLReport.Add('	</tr>');
      HTMLReport.Add('	<tr>');
      if ((CustomField2Name <> '') and (CustomField2Value <> '')) then begin
         HTMLReport.Add('		<th align="left" style="padding-right: 10px;">' + CustomField2Name + '</th>');
         HTMLReport.Add('		<td align="left" style="padding-right: 10px;">' + CustomField2Value + '</td>');
      end;
      HTMLReport.Add('		<th align="left" style="padding-right: 10px;">Station Name: </th>');
      HTMLReport.Add('		<td align="left" style="padding-right: 10px;">' + GetXMLTag(DrawerDetailXML, 'STATIONIDENT') + '</td>');


      HTMLReport.Add('		<th align="left" style="padding-right: 10px;">Drawer Close: </th>');
      HTMLReport.Add('		<td align="left" style="padding-right: 10px;">' + GetXMLTag(DrawerDetailXML, 'DRAWERCLOSEDATE') + '</td>');
      HTMLReport.Add('	</tr>');
      HTMLReport.Add('	<tr>');
      if ((CustomField3Name <> '') and (CustomField3Value <> '')) then begin
         HTMLReport.Add('		<th align="left" style="padding-right: 10px;">' + CustomField3Name + '</th>');
         HTMLReport.Add('		<td align="left" style="padding-right: 10px;">' + CustomField3Value + '</td>');
      end;
      if ((CustomField4Name <> '') and (CustomField4Value <> '')) then begin
         HTMLReport.Add('		<th align="left" style="padding-right: 10px;">' + CustomField4Name + '</th>');
         HTMLReport.Add('		<td align="left" style="padding-right: 10px;">' + CustomField4Value + '</td>');
      end;
      if ((CustomField5Name <> '') and (CustomField5Value <> '')) then begin
         HTMLReport.Add('		<th align="left" style="padding-right: 10px;">' + CustomField5Name + '</th>');
         HTMLReport.Add('		<td align="left" style="padding-right: 10px;">' + CustomField5Value + '</td>');
      end;
      if ((CustomField6Name <> '') and (CustomField6Value <> '')) then begin
         HTMLReport.Add('		<th align="left" style="padding-right: 10px;">' + CustomField6Name + '</th>');
         HTMLReport.Add('		<td align="left" style="padding-right: 10px;">' + CustomField6Value + '</td>');
      end;
      HTMLReport.Add('	</tr>');
      HTMLReport.Add('</table>');
      result := HTMLReport.Text;
   end;
   function BuildCashCreditCheckReport: string;
   begin
      HTMLReport.Clear;
      HTMLReport.Add('<table>');

      CashBatchXMLNode := CashBatchXML.GetNode('/CASHBATCHDETAIL');
      CashBatchXMLNode := CashBatchXMLNode.FindFirstChildElement;
      if (CashBatchXMLNode <> nil) then begin
         HTMLReport.Add('	<tr>');
         HTMLReport.Add('		<th align="left"><font size="5">Cash</font></th>');
         HTMLReport.Add('	</tr>');
         HTMLReport.Add('	<tr></tr>');
         HTMLReport.Add('	<tr></tr>');
         HTMLReport.Add('	<tr>');
         HTMLReport.Add('		<th align="left" style="padding-right: 40px">Date/Time</th>');
         HTMLReport.Add('		<th align="left" style="padding-right: 40px">TranIdent</th>');
         HTMLReport.Add('		<th align="left" style="padding-right: 40px">CustIdent</th>');
         HTMLReport.Add('		<th align="left" style="padding-right: 40px"></th>');
         HTMLReport.Add('		<th align="left" style="padding-right: 40px">Amount</th>');
         HTMLReport.Add('	</tr>');
         While (CashBatchXMLNode <> nil)  do begin  //2017-05-10 jtm: D#1594
            if (CashBatchXMLNode.NodeName = 'CASHDETAIL') then begin //2017-09-06 jtm: D#1884
               HTMLReport.Add('	<tr>');
               HTMLReport.Add('		<td align="left" style="padding-right: 40px">' +CashBatchXML.GetContextValueAsWideString(CashBatchXMLNode, 'TRANDATE') + '</td>');
               HTMLReport.Add('		<td align="left" style="padding-right: 40px">' + CashBatchXML.GetContextValueAsWideString(CashBatchXMLNode, 'TRANIDENT') + '</td>');
               HTMLReport.Add('		<td align="left" style="padding-right: 40px">' + CashBatchXML.GetContextValueAsWideString(CashBatchXMLNode, 'CUSTIDENT') + '</td>');
               HTMLReport.Add('		<td align="left" style="padding-right: 40px"></td>');

               if(CashBatchXML.GetContextValueAsWideString(CashBatchXMLNode,'CURRENCYTYPE') = 'CASH') then begin
                  if (CashBatchXML.GetContextValueAsWideString(CashBatchXMLNode, 'TRANTYPE') = 'VOID') or (CashBatchXML.GetContextValueAsWideString(CashBatchXMLNode, 'TRANTYPE') = 'CRVOID') then begin  //2016-06-22 jtm
                     HTMLReport.Add('		<td align="left" style="padding-right: 40px" class="cashVoid"><del>' + CurrToStrF(CashBatchXML.GetContextValueAsNumber(CashBatchXMLNode, 'TRANAMT'), ffCurrency, 2) + '</del></td>');
                  end else if CashBatchXML.GetContextValueAsWideString(CashBatchXMLNode, 'TRANTYPE') = 'REFUND' then begin
                     HTMLReport.Add('		<td align="left" style="padding-right: 40px" class="cashRefund">(' + CurrToStrF(CashBatchXML.GetContextValueAsNumber(CashBatchXMLNode, 'TRANAMT'), ffCurrency, 2) + ')</td>');
                     CashTotal := CashTotal - CashBatchXML.GetContextValueAsNumber(CashBatchXMLNode, 'TRANAMT');
                  end else begin
                     HTMLReport.Add('		<td align="left" style="padding-right: 40px" class="cashSale">' + CurrToStrF(CashBatchXML.GetContextValueAsNumber(CashBatchXMLNode, 'TRANAMT'), ffCurrency, 2) + '</td>');
                     CashTotal := CashTotal + CashBatchXML.GetContextValueAsNumber(CashBatchXMLNode, 'TRANAMT');
                  end;
               end else if(CashBatchXML.GetContextValueAsWideString(CashBatchXMLNode,'CURRENCYTYPE') = 'VOUCHER') then begin //2017-04-05 jtm: Def #1544
                  if (CashBatchXML.GetContextValueAsWideString(CashBatchXMLNode, 'TRANTYPE') = 'VOID') or (CashBatchXML.GetContextValueAsWideString(CashBatchXMLNode, 'TRANTYPE') = 'CRVOID') then begin
                     HTMLReport.Add('		<td align="left" style="padding-right: 40px" class="voucherVoid"><del>' + CurrToStrF(CashBatchXML.GetContextValueAsNumber(CashBatchXMLNode, 'TRANAMT'), ffCurrency, 2) + '</del></td>');
                  end else if CashBatchXML.GetContextValueAsWideString(CashBatchXMLNode, 'TRANTYPE') = 'REFUND' then begin
                     HTMLReport.Add('		<td align="left" style="padding-right: 40px" class="voucherRefund">(' + CurrToStrF(CashBatchXML.GetContextValueAsNumber(CashBatchXMLNode, 'TRANAMT'), ffCurrency, 2) + ')</td>');
                     VoucherTotal := VoucherTotal - CashBatchXML.GetContextValueAsNumber(CashBatchXMLNode, 'TRANAMT');
                  end else begin
                     HTMLReport.Add('		<td align="left" style="padding-right: 40px" class="voucherSale">' + CurrToStrF(CashBatchXML.GetContextValueAsNumber(CashBatchXMLNode, 'TRANAMT'), ffCurrency, 2) + '</td>');
                     VoucherTotal := VoucherTotal + CashBatchXML.GetContextValueAsNumber(CashBatchXMLNode, 'TRANAMT');
                  end;
                  HTMLReport.Add('<td align="left">(Voucher)</td>'); //2017-04-12 jtm: Def #1590
               end;

               HTMLReport.Add('	</tr>');
            end;
            CashBatchXMLNode := CashBatchXMLNode.FindNextSiblingElement;
         end;

         HTMLReport.Add('	<tr>');
         HTMLReport.Add('		<th></th>');
         HTMLReport.Add('		<th></th>');
         HTMLReport.Add('		<th></th>');
         HTMLReport.Add('		<th align="left">Total Cash:</th>');
         HTMLReport.Add('		<th align="left" id="totalCashTranAmt"">' + CurrToStrF(CashTotal, ffCurrency, 2) + '</th>');
         HTMLReport.Add('	</tr>');
         HTMLReport.Add('	<tr>');
         HTMLReport.Add('		<th></th>');
         HTMLReport.Add('		<th></th>');
         HTMLReport.Add('		<th></th>');
         HTMLReport.Add('		<th align="left">Total Voucher:</th>');
         HTMLReport.Add('		<th align="left" id="totalVoucherTranAmt"">' + CurrToStrF(VoucherTotal, ffCurrency, 2) + '</th>');  //2017-04-05 jtm: Def #1544
         HTMLReport.Add('	</tr>');
         HTMLReport.Add('	<tr></tr>');
         HTMLReport.Add('	<tr></tr>');
         HTMLReport.Add('	<tr></tr>');
         ProcessLog(ltinfo,'CashBatchXMLNode:', 'Complete');
      end;
      CCBatchXMLNode := CCBatchXML.GetNode('/CCBATCHDETAIL');
      CCBatchXMLNode := CCBatchXMLNode.FindFirstChildElement;
      if (CCBatchXMLNode <> nil) then begin
         HTMLReport.Add('	<tr>');
         HTMLReport.Add('		<th align="left"><font size="5">Credit</font></th>');
         HTMLReport.Add('	</tr>');
         HTMLReport.Add('	<tr></tr>');
         HTMLReport.Add('	<tr></tr>');
         HTMLReport.Add('	<tr>');
         HTMLReport.Add('		<th align="left" style="padding-right: 40px">Date/Time</th>');
         HTMLReport.Add('		<th align="left" style="padding-right: 40px">TranIdent</th>');  //TODO: Change TRANIDENT/CUSTIDENT descriptions and suppression based on profile XML

         HTMLReport.Add('		<th align="left" style="padding-right: 40px">CustIdent</th>');
         HTMLReport.Add('		<th align="left" style="padding-right: 40px">Last Four</th>');
         HTMLReport.Add('		<th align="left" style="padding-right: 40px">Amount</th>');
         HTMLReport.Add('	</tr>');
         While (CCBatchXMLNode  <> nil) do begin  //2017-05-10 jtm: D#1594
            if (CCBatchXMLNode.NodeName = 'CCAUTHDETAIL') then begin //2017-09-06 jtm: D#1884
               HTMLReport.Add('	<tr>');
               HTMLReport.Add('		<td align="left" style="padding-right: 40px">' + CCBatchXML.GetContextValueAsWideString(CCBatchXMLNode, 'AUTHDATE')+ '</td>');
               HTMLReport.Add('		<td align="left" style="padding-right: 40px">' + CCBatchXML.GetContextValueAsWideString(CCBatchXMLNode, 'TRANIDENT') + '</td>');
               HTMLReport.Add('		<td align="left" style="padding-right: 40px">' + CCBatchXML.GetContextValueAsWideString(CCBatchXMLNode, 'TRANCUSTOMERCODE') + '</td>');
               HTMLReport.Add('		<td align="left" style="padding-right: 40px">' + Copy(CCBatchXML.GetContextValueAsWideString(CCBatchXMLNode, 'CARDACCT'), Length(CCBatchXML.GetContextValueAsWideString(CCBatchXMLNode, 'CARDACCT'))-3, 4) + '</td>');
               if (CCBatchXML.GetContextValueAsWideString(CCBatchXMLNode, 'SALETYPE') = 'VOID') or (CCBatchXML.GetContextValueAsWideString(CCBatchXMLNode, 'SALETYPE') = 'CRVOID') then begin
                  HTMLReport.Add('		<td align="left" style="padding-right: 40px" class="cardVoid"><del>' + CurrToStrF(CCBatchXML.GetContextValueAsNumber(CCBatchXMLNode, 'TRANAMT'), ffCurrency, 2) + '</del></td>');
               end else if (CCBatchXML.GetContextValueAsWideString(CCBatchXMLNode, 'SALETYPE') = 'REFUND') or (CCBatchXML.GetContextValueAsWideString(CCBatchXMLNode, 'SALETYPE') = 'CREDIT' ) then begin
                  HTMLReport.Add('		<td align="left" style="padding-right: 40px" class="cardRefund">(' + CurrToStrF(CCBatchXML.GetContextValueAsNumber(CCBatchXMLNode, 'TRANAMT'), ffCurrency, 2) + ')</td>');
                  CardTotal := CardTotal - CCBatchXML.GetContextValueAsNumber(CCBatchXMLNode, 'TRANAMT');
               end else if (CCBatchXML.GetContextValueAsWideString(CCBatchXMLNode, 'AUTHCODE') = '')  then begin
                  HTMLReport.Add('		<td align="left" style="padding-right: 40px" class="cardVoid"><del>' + CurrToStrF(CCBatchXML.GetContextValueAsNumber(CCBatchXMLNode, 'TRANAMT'), ffCurrency, 2) + '</del></td>');
               end else begin
                  HTMLReport.Add('		<td align="left" style="padding-right: 40px" class="cardSale">' + CurrToStrF(CCBatchXML.GetContextValueAsNumber(CCBatchXMLNode, 'TRANAMT'), ffCurrency, 2) + '</td>');
                  CardTotal := CardTotal + CCBatchXML.GetContextValueAsNumber(CCBatchXMLNode, 'TRANAMT');
               end;
               HTMLReport.Add('	</tr>');
            end;
            CCBatchXMLNode := CCBatchXMLNode.FindNextSiblingElement;
         end;
         HTMLReport.Add('	<tr></tr>');
         HTMLReport.Add('	<tr>');
         HTMLReport.Add('		<th></th>');
         HTMLReport.Add('		<th></th>');
         HTMLReport.Add('		<th></th>');
         HTMLReport.Add('		<th align="left">Total:</th>');
         HTMLReport.Add('		<th align="left" id="totalCardTranAmt">'+CurrToStrF(CardTotal, ffCurrency, 2)+'</th>');
         HTMLReport.Add('	</tr>');
         HTMLReport.Add('	<tr></tr>');
         HTMLReport.Add('	<tr></tr>');
         HTMLReport.Add('	<tr></tr>');
         ProcessLog(ltinfo,'CCBatchXMLNode:', 'Complete');
      end;
      TCBatchXMLNode := TCBatchXML.GetNode('/TCBATCHDETAIL');
      TCBatchXMLNode := TCBatchXMLNode.FindFirstChildElement;
      if (TCBatchXMLNode <> nil)  then begin
         HTMLReport.Add('	<tr>');
         HTMLReport.Add('		<th align="left"><font size="5">Check</font></th>');
         HTMLReport.Add('	</tr>');
         HTMLReport.Add('	<tr></tr>');
         HTMLReport.Add('	<tr></tr>');
         HTMLReport.Add('	<tr>');
         HTMLReport.Add('		<th align="left" style="padding-right: 40px">Date/Time</th>');
         HTMLReport.Add('		<th align="left" style="padding-right: 40px">TranIdent</th>');
         HTMLReport.Add('		<th align="left" style="padding-right: 40px">CustIdent</th>');
         HTMLReport.Add('		<th align="left" style="padding-right: 40px">Check Number</th>');
         HTMLReport.Add('		<th align="left" style="padding-right: 40px">Amount</th>');
         HTMLReport.Add('	</tr>');
         While (TCBatchXMLNode <> nil) do begin  //2017-05-10 jtm: D#1594
            if (TCBatchXMLNode.NodeName = 'TCAUTHDETAIL') then begin //2017-09-06 jtm: D#1884
               HTMLReport.Add('	<tr>');
               HTMLReport.Add('		<td align="left" style="padding-right: 40px">' + TCBatchXML.GetContextValueAsWideString(TCBatchXMLNode, 'AUTHDATE') + '</td>');
               HTMLReport.Add('		<td align="left" style="padding-right: 40px">' + TCBatchXML.GetContextValueAsWideString(TCBatchXMLNode, 'TRANIDENT') + '</td>');
               HTMLReport.Add('		<td align="left" style="padding-right: 40px">' + TCBatchXML.GetContextValueAsWideString(TCBatchXMLNode, 'TRANCUSTOMERCODE') + '</td>');
               HTMLReport.Add('		<td align="left" style="padding-right: 40px">' + TCBatchXML.GetContextValueAsWideString(TCBatchXMLNode, 'RESPONSECHECKNUMBER') + '</td>');
               if (TCBatchXML.GetContextValueAsWideString(TCBatchXMLNode, 'TCSERVICENAME') = 'NONE') then begin
                  if (TCBatchXML.GetContextValueAsWideString(TCBatchXMLNode, 'VOIDED') = 'TRUE') or (TCBatchXML.GetContextValueAsWideString(TCBatchXMLNode, 'ECAVOIDDATE') <> '') then begin
                     HTMLReport.Add('		<td align="left" style="padding-right: 40px" class="checkVoid"><del>' + CurrToStrF(TCBatchXML.GetContextValueAsNumber(TCBatchXMLNode, 'TRANAMOUNT'), ffCurrency, 2) + '</del></td>');
                  end
                  else begin
                     HTMLReport.Add('		<td align="left" style="padding-right: 40px" class="checkSale">' + CurrToStrF(TCBatchXML.GetContextValueAsNumber(TCBatchXMLNode, 'TRANAMOUNT'), ffCurrency, 2) + '</td>');
                     CheckTotal := CheckTotal + TCBatchXML.GetContextValueAsNumber(TCBatchXMLNode, 'TRANAMOUNT');
                  end;
               end
               else begin
                  if (TCBatchXML.GetContextValueAsWideString(TCBatchXMLNode, 'VOIDED') = 'TRUE') or (TCBatchXML.GetContextValueAsWideString(TCBatchXMLNode, 'ECAVOIDDATE') <> '') then begin
                     HTMLReport.Add('		<td align="left" style="padding-right: 40px" class="tcVoid"><del>' + CurrToStrF(TCBatchXML.GetContextValueAsNumber(TCBatchXMLNode, 'TRANAMOUNT'), ffCurrency, 2) + '</del></td></td><td align="left">(' + TCBatchXML.GetContextValueAsWideString(TCBatchXMLNode, 'TCSERVICENAME') + ')</td>');
                  end
                  else begin
                     HTMLReport.Add('		<td align="left" style="padding-right: 40px" class="tcSale">' + CurrToStrF(TCBatchXML.GetContextValueAsNumber(TCBatchXMLNode, 'TRANAMOUNT'), ffCurrency, 2) + '</td></td><td align="left">(' + TCBatchXML.GetContextValueAsWideString(TCBatchXMLNode, 'TCSERVICENAME') + ')</td>');
                     TCCheckTotal := TCCheckTotal + TCBatchXML.GetContextValueAsNumber(TCBatchXMLNode, 'TRANAMOUNT');
                  end;
               end;

               HTMLReport.Add('	</tr>');
            end;
            TCBatchXMLNode := TCBatchXMLNode.FindNextSiblingElement;
         end;
         HTMLReport.Add('	<tr></tr>');    //2017-04-05 jtm: Def #1544
         HTMLReport.Add('	<tr>');
         HTMLReport.Add('		<th></th>');
         HTMLReport.Add('		<th></th>');
         HTMLReport.Add('		<th></th>');
         HTMLReport.Add('		<th align="left">Non-Telecheck Total:</th>');
         HTMLReport.Add('		<th align="left" id="checkTotalTranAmt">' + CurrToStrF(CheckTotal, ffCurrency, 2) + '</th>');
         HTMLReport.Add('	</tr>');
         HTMLReport.Add('	<tr>');
         HTMLReport.Add('		<th></th>');
         HTMLReport.Add('		<th></th>');
         HTMLReport.Add('		<th></th>');
         HTMLReport.Add('		<th align="left">Telecheck Total:</th>');
         HTMLReport.Add('		<th align="left" id="tcTotalTranAmt">' + CurrToStrF(TCCheckTotal, ffCurrency, 2) + '</th>');
         HTMLReport.Add('	</tr>');
         ProcessLog(ltinfo,'TCBatchXMLNode:', 'Complete');
      end;
      HTMLReport.Add('</table>');
      result := HTMLReport.Text;
   end;
begin
   DrawerRequest := '<TRANSACTION> <DRAWERIDENT>'+DrawerIdent+'</DRAWERIDENT>' +
                    '<TRANSACTIONTYPE>DRAWERDETAIL</TRANSACTIONTYPE>'+
                    '</TRANSACTION>'+CRLF;
   ProcessLog(ltinfo,'GetEODShiftReport','Begin GetEODShiftReport');
   DrawerDetailXML := TStringList.Create;
   CashTotal := 0;
   VoucherTotal := 0; //2017-04-05 jtm: Def #1544
   CardTotal := 0;
   CheckTotal := 0;
   TCCheckTotal := 0; //2017-04-05 jtm: Def #1544
   DrawerDetailXML.Text := GetDrawerDetail(ARNID,DrawerIdent);
   ProcessLog(ltinfo,'GetEODShiftReport','END GetDrawerDetail');
   ProcessLog(ltinfo,'GetEODShiftReport DrawerDetailXML',DrawerDetailXML.Text);
   if GetXMLTag(DrawerDetailXML,'TRANSUCCESS') = 'TRUE' then begin
      ProcessLog(ltinfo,'GetEODShiftReport','TRANSUCCESS TRUE; begin HTML report creation');

      CCBatchXMLStr := '<CCBATCHDETAIL>';
      CCBatchXMLStr := CCBatchXMLStr + trim(GetXMLTagStr(DrawerDetailXML.Text, 'CCBATCHDETAIL'));
      CCBatchXMLStr := CCBatchXMLStr + '</CCBATCHDETAIL>';
      Try
         CCBatchXML := TOpenXML.CreateFromString(Nil, CCBatchXMLStr);
      except
         On E:Exception do begin
            ProcessLog(ltWarning,'CCBATCHDETAIL','OpenXMLLoad Exception processing XML: ' + E.Message);
            If Assigned(CCBatchXML) then FreeAndNil(CCBatchXML);
         end;
      end;

      TCBatchXMLStr := '<TCBATCHDETAIL>';
      TCBatchXMLStr := TCBatchXMLStr + trim(GetXMLTagStr(DrawerDetailXML.Text, 'TCBATCHDETAIL'));
      TCBatchXMLStr := TCBatchXMLStr + '</TCBATCHDETAIL>';
      Try
         TCBatchXML := TOpenXML.CreateFromString(Nil, TCBatchXMLStr);
      except
         On E:Exception do begin
            ProcessLog(ltWarning,'TCBATCHDETAIL','OpenXMLLoad Exception processing XML: ' + E.Message);
            If Assigned(TCBatchXML) then FreeAndNil(TCBatchXML);
         end;
      end;

      CashBatchXMLStr := '<CASHBATCHDETAIL>';
      CashBatchXMLStr := CashBatchXMLStr + trim(GetXMLTagStr(DrawerDetailXML.Text, 'CASHBATCHDETAIL'));
      CashBatchXMLStr := CashBatchXMLStr + '</CASHBATCHDETAIL>';
      Try
         CashBatchXML := TOpenXML.CreateFromString(Nil, CashBatchXMLStr);
      except
         On E:Exception do begin
            ProcessLog(ltWarning,'CASHBATCHDETAIL','OpenXMLLoad Exception processing XML: ' + E.Message);
            If Assigned(CashBatchXML) then FreeAndNil(CashBatchXML);
         end;
      end;
      ProcessLog(ltinfo,'GetEODShiftReport','TOpenXML creation completed');
      WS := LoadWebFileFromFolder('EODShiftReport.htm','');
      HTMLReport := TStringList.Create;

      ReplaceString(WS,'%CUSTOMFIELDS%', BuildCustomFieldsTable);
      ReplaceString(WS,'%TRANFIELDS%', BuildCashCreditCheckReport);
      ProcessLog(ltinfo,'BuildCashCreditCheckReport','TOpenXML creation completed');
      if GetXMLTag(DrawerDetailXML, 'DRAWEROPENBALANCE') <> '' then  //2016-06-22 jtm
         DrawerOpen := CurrToStrF(StrToCurr(GetXMLTag(DrawerDetailXML, 'DRAWEROPENBALANCE')), ffCurrency, 2)
      else
         DrawerOpen := '';
      if GetXMLTag(DrawerDetailXML, 'CASHCOUNTED') <> '' then
         CashCounted := CurrToStrF(StrToCurr(GetXMLTag(DrawerDetailXML, 'CASHCOUNTED')), ffCurrency, 2)
      else
         CashCounted := '';
      if (CashCounted <> '') and (DrawerOpen <> '') then
         Drawervariance := CurrToStrF((StrToCurr(GetXMLTag(DrawerDetailXML, 'CASHCOUNTED'))-(StrToCurr(GetXMLTag(DrawerDetailXML, 'DRAWEROPENBALANCE')) + CashTotal)), ffCurrency, 2)
      else
         Drawervariance := '$0.00';

      if (DrawerOpen <> '') then
         CashCalculated := CurrToStrF(CashTotal +  StrToCurr(GetXMLTag(DrawerDetailXML, 'DRAWEROPENBALANCE')), ffCurrency, 2)
      else
         CashCalculated := '$0.00';


      ReplaceString(WS,'%DRAWEROPEN%', DrawerOpen);
      ReplaceString(WS,'%CASHCOUNTED%', CashCounted);
      ReplaceString(WS,'%CASHCALCULATED%', CashCalculated);
      ReplaceString(WS,'%DRAWERVARIANCE%', Drawervariance);
      ReplaceString(WS,'%CASHDEPOSIT%', CurrToStrF(CashTotal, ffCurrency, 2));
      ReplaceString(WS,'%VARIANCEREASON%', GetXMLTag(DrawerDetailXML, 'VARIANCEREASON'));  //2016-8-08 jtm: Feat OT#1025
      ReplaceString(WS,'%VARIANCESIGNOFFEMPIDENT%', GetXMLTag(DrawerDetailXML, 'VARIANCESIGNOFFEMPIDENT'));
      ReplaceString(WS,'%SUBMITTERVARIANCENOTES%', GetXMLTag(DrawerDetailXML, 'SUBMITTERVARIANCENOTES')); //2017-03-22 jtm: Feat OT#1471

      ReplaceString(WS,'%DEPOSITSLIPNUMBER%', GetXMLTag(DrawerDetailXML, 'DEPOSITSLIPNUMBER'));  //2016-8-22 jtm: Feat OT#1081
      ReplaceString(WS,'%DEPOSITNOTES%', GetXMLTag(DrawerDetailXML, 'DEPOSITNOTES'));
      ReplaceString(WS,'%BAGNUMBER%', GetXMLTag(DrawerDetailXML, 'BAGNUMBER'));
      ReplaceString(WS,'%MANAGERVARIANCEAPPROVALNOTES%', GetXMLTag(DrawerDetailXML, 'MANAGERVARIANCEAPPROVALNOTES'));


      FreeAndNil(HTMLReport);
      FreeAndNil(CCBatchXML);
      FreeAndNil(TCBatchXML);
      FreeAndNil(CashBatchXML);
   end else begin
      WS := 'Drawer Detail Response Failure: ' + DrawerDetailXML.Text;
   end;
   ProcessLog(ltinfo,'GetEODShiftReport','end');
   result := WS;
end;

function TCustomerInfoModule.GetDrawerDetail(ARNID : String; DrawerIdent: string): string;
var
RequestXML,XMLResp,TmpXMLResp : TStringList;
BatchDetail : string;
begin
   RequestXML := TStringList.Create;
   XMLResp := TStringList.Create;
   TmpXMLResp := TStringList.Create;
   TmpXMLResp.Append(' <TRANRESP>');
	TmpXMLResp.Append(' <RESPTYPE>DRAWERDETAILRESP</RESPTYPE>');

   RequestXML.Clear;
   RequestXML.Append('<TRANSACTION>');
   RequestXML.Append(' <RNID>' + ARNID + '</RNID>');
   RequestXML.Append(' <TRANSACTIONTYPE>CCBATCHDETAIL</TRANSACTIONTYPE>');
   RequestXML.Append(' <AUTHDRAWERIDENT>' + DrawerIdent + '</AUTHDRAWERIDENT>');
   RequestXML.Append(' <DETAILLEVEL>VERBOSE</DETAILLEVEL>');
   if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then  //2016-9-19 jtm: Feat OT# 1145
      RequestXML.Append('<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>');
   RequestXML.Append('<ENCODING>UTF-8</ENCODING>'); //2018-01-29 jtm: D#3707
   RequestXML.Append('</TRANSACTION>');
   ProcessLog(ltinfo,'GetDrawerDetail CCBATCHDETAIL sent',RequestXML.Text);
   VarEvaluator.AddValue('GatewayRNID',ARNID);//2017-05-24 jtm: F#1821
   ProcessPPSAPIXML(RequestXML.Text, XMLResp,GetAppServerHost,0);

   TmpXMLResp.Append(' <CCBATCHDETAIL>');
   BatchDetail := trim(GetXMLTagStr(XMLResp.Text, 'CCBATCHDETAIL'));
   ProcessLog(ltinfo,'GetDrawerDetail CCBATCHDETAIL',XMLResp.Text);
   if (BatchDetail <> '') then begin
      TmpXMLResp.Append(BatchDetail);
   end;
   TmpXMLResp.Append(' </CCBATCHDETAIL>');

   XMLResp.Clear;
   RequestXML.Clear;
   RequestXML.Append('<TRANSACTION>');
   RequestXML.Append(' <RNID>' + ARNID + '</RNID>');
   RequestXML.Append(' <TRANSACTIONTYPE>TCBATCHDETAIL</TRANSACTIONTYPE>');
   RequestXML.Append(' <AUTHDRAWERIDENT>' + DrawerIdent + '</AUTHDRAWERIDENT>');
   RequestXML.Append(' <DETAILLEVEL>VERBOSE</DETAILLEVEL>');
   if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then  //2016-9-19 jtm: Feat OT# 1145
      RequestXML.Append('<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>');
   RequestXML.Append('<ENCODING>UTF-8</ENCODING>'); //2018-01-29 jtm: D#3707
   RequestXML.Append('</TRANSACTION>');
   ProcessLog(ltinfo,'GetDrawerDetail TCBATCHDETAIL sent',RequestXML.Text);
   ProcessPPSAPIXML(RequestXML.Text, XMLResp,GetAppServerHost,0);
   TmpXMLResp.Append(' <TCBATCHDETAIL>');
   BatchDetail := trim(GetXMLTagStr(XMLResp.Text, 'TCBATCHDETAIL'));
   ProcessLog(ltinfo,'GetDrawerDetail TCBATCHDETAIL',XMLResp.Text);
   if (BatchDetail <> '') then begin
      TmpXMLResp.Append(BatchDetail);
   end;
   TmpXMLResp.Append(' </TCBATCHDETAIL>');


   XMLResp.Clear;
   RequestXML.Clear;
   RequestXML.Append('<TRANSACTION>');
   RequestXML.Append(' <RNID>' + ARNID + '</RNID>');
   RequestXML.Append(' <TRANSACTIONTYPE>CASHBATCHDETAIL</TRANSACTIONTYPE>');
   RequestXML.Append(' <AUTHDRAWERIDENT>' + DrawerIdent + '</AUTHDRAWERIDENT>');
   if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then   //2016-9-19 jtm: Feat OT# 1145
      RequestXML.Append('<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>');
   RequestXML.Append('<ENCODING>UTF-8</ENCODING>'); //2018-01-29 jtm: D#3707
   RequestXML.Append('</TRANSACTION>');
   ProcessLog(ltinfo,'GetDrawerDetail CASHBATCHDETAIL sent',RequestXML.Text);
   ProcessPPSAPIXML(RequestXML.Text, XMLResp,GetAppServerHost,0);
   TmpXMLResp.Append(' <CASHBATCHDETAIL>');
   BatchDetail := trim(GetXMLTagStr(XMLResp.Text, 'CASHBATCHDETAIL'));
   ProcessLog(ltinfo,'GetDrawerDetail CASHBATCHDETAIL',XMLResp.Text);
   if (BatchDetail <> '') then begin
      TmpXMLResp.Append(BatchDetail);
   end;
   TmpXMLResp.Append(' </CASHBATCHDETAIL>');

   TmpXMLResp.Append(GetDrawerXMLbyDrawerIdent(ARNID,DrawerIdent));
   TmpXMLResp.Append('   <SERVERDATE>' + FormatDateTime('MM/DD/YYYY', NOW) + '</SERVERDATE>');
   TmpXMLResp.Append('   <SERVERTIME>' + FormatDateTime('HH:NN:SS', NOW) + '</SERVERTIME>');
   TmpXMLResp.Append('</TRANRESP>');

   result := TmpXMLResp.Text;

   FreeAndNil(XMLResp);
   FreeAndNil(TmpXMLResp);
   FreeAndNil(RequestXML);
end;

function TCustomerInfoModule.GetDrawerXMLbyDrawerIdent(ARNID : String; DrawerIdent: string): string;
var
DrawerXML : TStringList;
begin
   DrawerXML := TStringList.Create;
   RNQuery.Close;
   RNQuery.SQL.Clear;
   RNQuery.SQL.Append('select *');
   RNQuery.SQL.Append('from Drawer');
   RNQuery.SQL.Append('where Profile = :RNID');
   RNQuery.SQL.Append('          and DrawerIdent = :DrawerIdent');
   RNQuery.Parameters.ParamByName('RNID').Value := ARNID;
   RNQuery.Parameters.ParamByName('DrawerIdent').Value := DrawerIdent;
   RNQuery.Open;
   if (RNQuery.RecordCount <> 1) then begin
      DrawerXML.Append('   <DRAWERIDENT>' + DrawerIdent+ '</DRAWERIDENT>');
      DrawerXML.Append('   <TRANSUCCESS>FALSE</TRANSUCCESS>');
      DrawerXML.Append('<TRANRESPMESSAGE>Drawer Not Found</TRANRESPMESSAGE>');
      RNQuery.Close;
   end else begin
      DrawerXML.Append('<DRAWERIDENT>' + DrawerIdent+ '</DRAWERIDENT>');
      DrawerXML.Append('<DRAWERIDENTGUID>' + Trim(RNQuery.FieldByName('DrawerIdentGUID').AsString) + '</DRAWERIDENTGUID>');
      DrawerXML.Append('<OPENEMPIDENT>' + Trim(RNQuery.FieldByName('OpenEmpIdent').AsString) + '</OPENEMPIDENT>');
      DrawerXML.Append('<CLOSEEMPIDENT>' + Trim(RNQuery.FieldByName('CloseEmpIdent').AsString) + '</CLOSEEMPIDENT>');
      DrawerXML.Append('<DRAWEROPENBALANCE>' + Trim(RNQuery.FieldByName('OpenBalance').AsString) + '</DRAWEROPENBALANCE> ');
      if RNQuery.FieldByName('OpenDate').AsString <> '' then   //2016-06-22 jtm
         DrawerXML.Append('<DRAWEROPENDATE>' + FormatDateTime('MM/DD/YYYY HH:NN:SS',RNQuery.FieldByName('OpenDate').AsDateTime) + '</DRAWEROPENDATE>')
      else
         DrawerXML.Append('<DRAWEROPENDATE></DRAWEROPENDATE>');
      if RNQuery.FieldByName('CloseDate').AsString <> '' then
         DrawerXML.Append('<DRAWERCLOSEDATE>' + FormatDateTime('MM/DD/YYYY HH:NN:SS',RNQuery.FieldByName('CloseDate').AsDateTime) + '</DRAWERCLOSEDATE>')
      else
         DrawerXML.Append('<DRAWERCLOSEDATE></DRAWERCLOSEDATE>');
      DrawerXML.Append('<CASHCOUNTED>' + Trim(RNQuery.FieldByName('CashCounted').AsString) + '</CASHCOUNTED>');
      DrawerXML.Append('<CARDCOUNTED>' + Trim(RNQuery.FieldByName('CardCounted').AsString) + '</CARDCOUNTED>');
      DrawerXML.Append('<CHECKCOUNTED>' + Trim(RNQuery.FieldByName('CheckCounted').AsString) + '</CHECKCOUNTED> ');
      DrawerXML.Append('<VARIANCEREASON>' + Trim(RNQuery.FieldByName('VarianceReason').AsString) + '</VARIANCEREASON>');
      DrawerXML.Append('<VARIANCESIGNOFFEMPIDENT>' + Trim(RNQuery.FieldByName('VarianceSignOffEmpIdent').AsString) + '</VARIANCESIGNOFFEMPIDENT> ');
      DrawerXML.Append('<CLOSEINSTANCECOUNT>' + Trim(RNQuery.FieldByName('CloseInstanceCount').AsString) + '</CLOSEINSTANCECOUNT> ');
      DrawerXML.Append('<STATIONIDENT>' + Trim(RNQuery.FieldByName('StationIdent').AsString) + '</STATIONIDENT> ');  //added for websvc since we need it on the EODShiftReport
      DrawerXML.Append('<DEPOSITSLIPNUMBER>' + Trim(RNQuery.FieldByName('DepositSlipNumber').AsString) + '</DEPOSITSLIPNUMBER> ');   //2016-8-22 jtm: Feat OT#915
      DrawerXML.Append('<DEPOSITNOTES>' + Trim(RNQuery.FieldByName('DepositNotes').AsString) + '</DEPOSITNOTES> ');
      DrawerXML.Append('<BAGNUMBER>' + Trim(RNQuery.FieldByName('BagNumber').AsString) + '</BAGNUMBER> ');
      DrawerXML.Append('<MANAGERVARIANCEAPPROVALNOTES>' + Trim(RNQuery.FieldByName('ManagerVarianceApprovalNotes').AsString) + '</MANAGERVARIANCEAPPROVALNOTES> ');
      DrawerXML.Append('<SUBMITTERVARIANCENOTES>' + Trim(RNQuery.FieldByName('SubmitterVarianceNotes').AsString) + '</SUBMITTERVARIANCENOTES> ');  //2017-03-22 jtm: Feat OT#1471
      DrawerXML.Append('<TRANSUCCESS>TRUE</TRANSUCCESS>');
      DrawerXML.Append('<TRANRESPMESSAGE>DRAWERDETAILS</TRANRESPMESSAGE>');
      RNQuery.Close;
   end;
   result := DrawerXML.text;
   FreeAndNil(DrawerXML);
end;

function TCustomerInfoModule.GetDrawerProfile(DisplayFormat: string): string;
var
   HTMLReport: TStringList;
   WS : string;
   CustomField1Name, CustomField2Name, CustomField3Name, CustomField4Name, CustomField5Name, CustomField6Name : String;
   CustomField1Value, CustomField2Value, CustomField3Value, CustomField4Value, CustomField5Value, CustomField6Value : String;
begin
   if Assigned(ProfileXML) then begin
      CustomField1Name := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/NAME', '');
      CustomField2Name := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/NAME', '');
      CustomField3Name := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/NAME', '');
      CustomField4Name := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/NAME', '');
      CustomField5Name := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/NAME', '');
      CustomField6Name := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/NAME', '');

      CustomField1Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/VALUE', '');
      CustomField2Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/VALUE', '');
      CustomField3Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/VALUE', '');
      CustomField4Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/VALUE', '');
      CustomField5Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/VALUE', '');
      CustomField6Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/VALUE', '');

      if DisplayFormat = 'HTML' then begin
         HTMLReport := TStringList.Create;
         HTMLReport.Add('<table>');
         HTMLReport.Add('	<tr>');
         if ((CustomField1Name <> '') and (CustomField1Value <> '')) then begin
            HTMLReport.Add('		<th align="left" style="padding-right: 10px;">' + CustomField1Name + '</th>');
            HTMLReport.Add('		<td align="left" style="padding-right: 10px;">' + CustomField1Value + '</td>');
         end;
         if ((CustomField2Name <> '') and (CustomField2Value <> '')) then begin
            HTMLReport.Add('		<th align="left" style="padding-right: 10px;">' + CustomField2Name + '</th>');
            HTMLReport.Add('		<td align="left" style="padding-right: 10px;">' + CustomField2Value + '</td>');
         end;
         HTMLReport.Add('	</tr>');
         HTMLReport.Add('	<tr>');
         if ((CustomField3Name <> '') and (CustomField3Value <> '')) then begin
            HTMLReport.Add('		<th align="left" style="padding-right: 10px;">' + CustomField3Name + '</th>');
            HTMLReport.Add('		<td align="left" style="padding-right: 10px;">' + CustomField3Value + '</td>');
         end;
         if ((CustomField4Name <> '') and (CustomField4Value <> '')) then begin
            HTMLReport.Add('		<th align="left" style="padding-right: 10px;">' + CustomField4Name + '</th>');
            HTMLReport.Add('		<td align="left" style="padding-right: 10px;">' + CustomField4Value + '</td>');
         end;
         HTMLReport.Add('	</tr>');
         HTMLReport.Add('	<tr>');
         if ((CustomField5Name <> '') and (CustomField5Value <> '')) then begin
            HTMLReport.Add('		<th align="left" style="padding-right: 10px;">' + CustomField5Name + '</th>');
            HTMLReport.Add('		<td align="left" style="padding-right: 10px;">' + CustomField5Value + '</td>');
         end;
         if ((CustomField6Name <> '') and (CustomField6Value <> '')) then begin
            HTMLReport.Add('		<th align="left" style="padding-right: 10px;">' + CustomField6Name + '</th>');
            HTMLReport.Add('		<td align="left" style="padding-right: 10px;">' + CustomField6Value + '</td>');
         end;
         HTMLReport.Add('	</tr>');
         HTMLReport.Add('</table>');
         WS := HTMLReport.Text;
         FreeAndNil(HTMLReport);
      end;
   end else begin
      WS := 'Profile not assigned'
   end;
   result := WS;

end;
function TCustomerInfoModule.GetDrawerVarianceReasons(DisplayFormat: string;Variance:string): string;
var
   WS : string;
   VarianceNode : TOpenXMLNode;
begin
   WS := '';
   if Assigned(ProfileXML) then begin
      if (DisplayFormat = 'HTML') then begin
      end;
      ProcessLog(ltinfo,'GetDrawerVarianceReasons','get node');
      VarianceNode := ProfileXML.GetXMLNode('/PROFILE/DRAWERSETTINGS/VARIANCEREASONS');
      if (VarianceNode = nil) then begin
         result := WS;
         exit;
      end;
      VarianceNode := VarianceNode.FindFirstChildElement;
      ProcessLog(ltinfo,'GetDrawerVarianceReasons','start loop');
      while (VarianceNode <> nil) do begin

         if (VarianceNode.NodeName = 'VARIANCEREASON') then begin
            if (DisplayFormat = 'HTML') then begin
               WS := WS + '<option';
               if (trim(Variance) = trim(ProfileXML.GetContextValueAsWideString(VarianceNode,'TEXT',''))) then begin
                  WS := WS + ' selected';
               end;
               WS := WS + '>' +ProfileXML.GetContextValueAsWideString(VarianceNode,'TEXT','') + '</option>';
            end;
         end;
         VarianceNode := VarianceNode.FindNextSiblingElement;
      end;
   end else begin
      WS := 'Profile not assigned'
   end;
   result := WS;
end;
function TCustomerInfoModule.GenerateApproveDrawerXML(ARNID,AEmpIdent,ADrawerIdent,AManagerVarApprovalNotes,AVarianceReason:string): string;
var
xmlstr : string;
begin
  xmlstr :=  '<TRANSACTION>';
  xmlstr := xmlstr + '<TRANSACTIONTYPE>DRAWERCLOSE</TRANSACTIONTYPE>';
  xmlstr := xmlstr + '<RNID>'+ARNID+'</RNID>';
  xmlstr := xmlstr + '<VARIANCEREASON>' + AVarianceReason + '</VARIANCEREASON>'; //2018-04-11 jtm D#4212
  xmlstr := xmlstr + '<VARIANCESIGNOFFEMPIDENT>'+AEmpIdent+'</VARIANCESIGNOFFEMPIDENT>';
  xmlstr := xmlstr + '<STATIONIDENT>WEBSITE</STATIONIDENT>';
  xmlstr := xmlstr + '<DRAWERIDENT>'+ADrawerIdent+'</DRAWERIDENT>';
  xmlstr := xmlstr + '<MANAGERVARIANCEAPPROVALNOTES>'+AManagerVarApprovalNotes+'</MANAGERVARIANCEAPPROVALNOTES>';
  xmlstr := xmlstr + '</TRANSACTION>';

  result := xmlstr;
end;


function TCustomerInfoModule.GetCashBatch(RNID, BatchSystemCode: String; ReturnDetail: boolean): boolean;
var
   BDR : String;
Begin
   BatchXML.Clear;
   Result := False;

   if Not ValidateRNID(RNID) then exit;

   BDR := '<TRANSACTION> <RNID>'+RNID+'</RNID>' +
          '<TRANSACTIONTYPE>CASHBATCHDETAIL</TRANSACTIONTYPE>' +
          '<ENCODING>UTF-8</ENCODING>';
   If (ReturnDetail) then begin
      BDR := BDR + '<DETAILLEVEL>VERBOSE</DETAILLEVEL>';
   end;

   if (BatchSystemCode <> '') then begin
      BDR := BDR + '<CASHSYSTEMCODE>' + BatchSystemCode + '</CASHSYSTEMCODE>';
   end;
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHBATCHEMPIDENT', 'FALSE') = 'TRUE') and (ValidCharsonly(Request.queryfields.Values['EMPIDENT'],True,True,'') <> '') then begin //2016-8-08 jtm: Feat OT#892
       BDR := BDR + '<AUTHEMPIDENT>' + ValidCharsonly(Request.queryfields.Values['EMPIDENT'],True,True,'') + '</AUTHEMPIDENT>';
   end;
   If( BatchSystemCode = '') then begin                    //2016-9-19 jtm: Feat OT# 1093
       BDR := BDR + '<BATCHSERIAL>0</BATCHSERIAL>';
   end;
   if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then begin   //2016-9-19 jtm: Feat OT# 1145
       BDR := BDR + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';
   end;
   BDR := BDR + '</TRANSACTION>'+CRLF;
   VarEvaluator.AddValue('GatewayRNID',RNID);//2017-05-24 jtm: F#1821
   ProcessPPSAPIXML(BDR, BatchXML,GetAppServerHost,60);
   Try
      BatchOXML := TOpenXML.CreateFromString(Nil,BatchXML.Text);
      Result := True;
   except
      on E:Exception do begin
         BatchOXML := NIL;
      end;
   end;

end;

Function TCustomerInfoModule.GetCashBatchFields(RNID, BatchSystemCode : String; FieldNames : TStringList) : boolean; //2018-06-20 bls: F#2227
var
   FBatchDetailDM : TBatchDetailDM;
begin
   Result := false;

   FBatchDetailDM := TBatchDetailDM.Create(ProcessLog, ProcessPPSAPIXML);
   BatchOXML := FBatchDetailDM.GetCashBatch(RNID,BatchSystemCode, true, '', '', '', FieldNames);

   If BatchOXML <> NIL then begin
      Result := true;
   end;

   FBatchDetailDM.Free;
end;

function TCustomerInfoModule.GetTCBatch(RNID, BatchSystemCode: String; ReturnDetail: boolean): boolean;
var
   BDR : String;
Begin
   BatchXML.Clear;
   Result := False;

   if Not ValidateRNID(RNID) then exit;

   BDR := '<TRANSACTION> <RNID>'+RNID+'</RNID>' +
          '<TRANSACTIONTYPE>TCBATCHDETAIL</TRANSACTIONTYPE>' +
          '<ENCODING>UTF-8</ENCODING>';
   If ReturnDetail then
      BDR := BDR + '<DETAILLEVEL>VERBOSE</DETAILLEVEL>';

   If BatchSystemCode <> '' then //2017-07-19 jtm: D#1796
     BDR := BDR + '<TCSYSTEMCODE>' + BatchSystemCode + '</TCSYSTEMCODE>'
   else
     BDR := BDR + '<BATCHSERIAL>0</BATCHSERIAL>';  //2018-10-10 bls DVST-2716

   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHBATCHEMPIDENT', 'FALSE') = 'TRUE') and (ValidCharsonly(Request.queryfields.Values['EMPIDENT'],True,True,'') <> '') then begin //2016-8-08 jtm: Feat OT#892
       BDR := BDR + '<AUTHEMPIDENT>' + ValidCharsonly(Request.queryfields.Values['EMPIDENT'],True,True,'') + '</AUTHEMPIDENT>';
   end;
   if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then  //2016-9-19 jtm: Feat OT# 1145
       BDR := BDR + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';

   BDR := BDR + '</TRANSACTION>'+CRLF;
   VarEvaluator.AddValue('GatewayRNID',RNID);//2017-05-24 jtm: F#1821
   ProcessPPSAPIXML(BDR, BatchXML,GetAppServerHost,0);

   Try
      BatchOXML := TOpenXML.CreateFromString(Nil,BatchXML.Text);
      Result := True;
   except
      on E:Exception do begin
         BatchOXML := NIL;
      end;
   end;

end;

Function TCustomerInfoModule.GetTCBatchFields(RNID, BatchSystemCode : String; FieldNames : TStringList) : boolean; //2018-06-20 bls: F#2227
var
   FBatchDetailDM : TBatchDetailDM;
begin
   Result := false;

   FBatchDetailDM := TBatchDetailDM.Create(ProcessLog, ProcessPPSAPIXML);
   BatchOXML := FBatchDetailDM.GetTCBatch(RNID,BatchSystemCode, true, '', FieldNames);

   If BatchOXML <> NIL then begin
      Result := true;
   end;

   FBatchDetailDM.Free;
end;

function TCustomerInfoModule.GetTCImageDetail(RNID : String;BatchSystemCode : String) : boolean; //2018-05-16 ajs: D#4615
var
   BDR : String;
Begin
   BatchXML.Clear;
   Result := False;

   if Not ValidateRNID(RNID) then exit;

   BDR := '<TRANSACTION> <RNID>'+RNID+'</RNID>' +
          '<TRANSACTIONTYPE>TCIMAGEDETAIL</TRANSACTIONTYPE>' +
          '<ENCODING>UTF-8</ENCODING>';

   If BatchSystemCode <> '' then
     BDR := BDR + '<TCSYSTEMCODE>' + BatchSystemCode + '</TCSYSTEMCODE>';

   BDR := BDR + '</TRANSACTION>'+CRLF;
   VarEvaluator.AddValue('GatewayRNID',RNID);
   ProcessPPSAPIXML(BDR, BatchXML,GetAppServerHost,0);

   Try
      BatchOXML := TOpenXML.CreateFromString(Nil,BatchXML.Text);
      Result := True;
   except
      on E:Exception do begin
         BatchOXML := NIL;
      end;
   end;

end;

function TCustomerInfoModule.DisplayStoreNameOnOpenCheck(const defaultValue: String = 'FALSE'): boolean;
begin
   Result := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYSTORENAMEONOPENCHECK', defaultValue));
end;

function TCustomerInfoModule.GetCheckBatchToHTML(const UILinks: Boolean; const ARNID, EmpIdentP : string): String; //2018-06-20 bls: F#2227
var
  IncludeEmpIdent, IncludeRefundData, IncludeStoreName: boolean;
  TranIdentHeader, CustIdentHeader, StoreSystemCodeLabel, StoreName, LocationRNID: string;

  FBatchDetailDM : TBatchDetailDM;
  FCheckBatchXML : TOpenXML;
  TCResults : TDataSet;
  FieldNames, BatchHTML : TStringList;

  Procedure CreateFieldNames();
  begin
      FieldNames.Add('AUTHDATE');
      FieldNames.Add('UPDATEDAMOUNT');
      FieldNames.Add('TRANAMOUNT');
      FieldNames.Add('VOIDED');
      FieldNames.Add('RESPONSECHECKNUMBER');
      FieldNames.Add('DISPLAYTEXT');
      FieldNames.Add('ECATRANSTATUS');
      FieldNames.Add('TRANIDENT');
      FieldNames.Add('TRANCUSTOMERCODE');
      FieldNames.Add('STATIONIDENT');
      FieldNames.Add('TCMID');

      If IncludeEmpIdent then FieldNames.Add('TRANEMPLOYEEIDENT');

      if IncludeRefundData then begin
         FieldNames.Add('REFUNDAMOUNT');
         FieldNames.Add('REFUNDDATE');
         FieldNames.Add('REFUNDCOUNT');
      end;   
  end;

  Procedure FormatHTMLHeader;
  var
   BatchHTMLHeader : string;
  begin
   BatchHTML := TStringList.Create;
   BatchHTML.Add('<TABLE border="1" cellspacing="0" cellpadding="3"  style="border-collapse: collapse; font-size:7pt;font-family:veranda">'); //2017-09-06 jtm: D#1887
   BatchHTML.Add('<TR><TD><B>RNID</B></TD>');
   if IncludeStoreName then BatchHTML.Add('<td><strong>Location</strong></td>');
   BatchHTML.Add('<TD><B>Auth Date</B></TD>');
   BatchHTML.Add('<TD Align="Right"><B>Amount</B></TD>');
   BatchHTML.Add('<TD><B>CHK #</B></TD>');
   BatchHTML.Add('<TD><B>TCK Response</B></TD>');
   BatchHTML.Add('<TD Colspan=2 align="Center"><B>Status</B></TD>');
   BatchHTML.Add('<TD><B>' + TranIdentHeader + '</B></TD>');
   BatchHTML.Add('<TD><B>' + CustIdentHeader + '</B></TD>');
   BatchHTML.Add('<TD><B>Station</B></TD>');
   BatchHTML.Add('<TD><B>MID</B></TD>');
   BatchHTML.Add('<TD><B>Service</B></TD>');
                 
   if IncludeEmpIdent then BatchHTML.Add('<TD><B>EmpIdent</B></TD>');
   if IncludeRefundData then BatchHTML.Add('<TD><B>Refund Amount</B></TD><TD><B>Last Refund Date</B></TD><TD><B>Refund Count</B></TD>');

   if StoreSystemCodeLabel <> '' then BatchHTML.Add('<TD><B>'+ StoreSystemCodeLabel +'</B></TD>')
   else BatchHTML.Add('<TD><B>Item Serial</B></TD>');

   BatchHTML.Add('</TR>');
  end;

  Procedure FormatHTMLBody;
  var
   Line, BRNID, BSC, Amt : string;

   scField, dateField, updatedAmtField, amtField, voidedField, respCheckNumField, displayTextField, ecaStatusField, tranIdentField, custIdentField, stationIdentField, midField,
      servNameField, empIdentField, refundAmtField, refundDateField, refundCountField : TField;
  begin
      TCResults.DisableControls;
      
      scField := TCResults.FieldByName('SYSTEMCODE');
      dateField := TCResults.FieldByName('AUTHDATE');
      updatedAmtField := TCResults.FieldByName('UPDATEDAMOUNT');
      amtField := TCResults.FieldByName('TRANAMOUNT');
      voidedField := TCResults.FieldByName('VOIDED');
      respCheckNumField := TCResults.FieldByName('RESPONSECHECKNUMBER');
      displayTextField := TCResults.FieldByName('DISPLAYTEXT');
      ecaStatusField := TCResults.FieldByName('ECATRANSTATUS');
      tranIdentField := TCResults.FieldByName('TRANIDENT');
      custIdentField := TCResults.FieldByName('TRANCUSTOMERCODE');
      stationIdentField := TCResults.FieldByName('STATIONIDENT');
      midField := TCResults.FieldByName('TCMID');
      servNameField := TCResults.FieldByName('TCSERVICENAME');
      if IncludeEmpIdent then empIdentField := TCResults.FieldByName('TRANEMPLOYEEIDENT');
      if IncludeRefundData then begin
         refundAmtField := TCResults.FieldByName('REFUNDAMOUNT');
         refundDateField := TCResults.FieldByName('REFUNDDATE');
         refundCountField := TCResults.FieldByName('REFUNDCOUNT');
      end;

      While NOT TCResults.EOF do begin
         Line := '';
         BRNID := Trim(ARNID);
         BSC := scField.AsString;
         BatchHTML.Add('<TR>');
         BatchHTML.Add('<TD>' + BRNID + '</TD>');
         if IncludeStoreName then BatchHTML.Add('<TD>' + StoreName + '</TD>');
         BatchHTML.Add('<TD>' + dateField.AsString + '</TD>');
         BatchHTML.Add('<TD align="Right">');

         if (updatedAmtField.AsString <> '') then begin //2017-11-16 jtm: F#2047
            BatchHTML.Add('<IMG SRC="/Images/General/Refresh.gif" border="0">');
            Amt := updatedAmtField.AsString;
         end else begin
            Amt := amtField.AsString;
         end;
         if strtobool(voidedField.AsString) then begin
           BatchHTML.Add('<DEL>Void ' + DisplayMoney(ValuReal(Amt)) + '</DEL></TD>');
         end else begin
            BatchHTML.Add(DisplayMoney(ValuReal(Amt)) + '</TD>');
         end;

         BatchHTML.Add('<TD>' + respCheckNumField.AsString + '</TD>');
         BatchHTML.Add('<TD>' + displayTextField.AsString + '</TD>');
         BatchHTML.Add('<TD>' + ecaStatusField.AsString + '</TD>');

         If ecaStatusField.AsString = '0' then begin
            BatchHTML.Add('<TD align="CENTER"><IMG SRC="/Images/General/CheckSmall.gif" border="0"></TD>');
         end else If ecaStatusField.AsString = '1' then begin
            BatchHTML.Add('<TD align="CENTER"><IMG SRC="/Images/General/BoltSmall.gif" border="0"></TD>');
         end else If ecaStatusField.AsString = '3' then begin
            BatchHTML.Add('<TD align="CENTER"><IMG SRC="/Images/General/XFailed.gif" border="0"></TD>');
         end else If ecaStatusField.AsString = '4' then begin
            BatchHTML.Add('<TD align="CENTER"><IMG SRC="/Images/General/XFailed.gif" border="0"></TD>');
         end else begin
            BatchHTML.Add('<TD align="CENTER"><IMG SRC="/Images/General/ExclamationSmall.gif" border="0"></TD>');
         end;

         BatchHTML.Add('<TD>' + tranIdentField.AsString + '</TD>');
         BatchHTML.Add('<TD>' + custIdentField.AsString + '</TD>');
         BatchHTML.Add('<TD>' + stationIdentField.AsString + '</TD>');
         BatchHTML.Add('<TD>' + midField.AsString + '</TD>');
         BatchHTML.Add('<TD>' + servNameField.AsString + '</TD>');

         if IncludeEmpIdent then BatchHTML.Add('<TD>' + empIdentField.AsString + '</TD>');
         if IncludeRefundData then BatchHTML.Add('<TD>' + refundAmtField.AsString + '</TD><TD>' + refundDateField.ASString + '</TD><TD>' + refundCountField.AsString + '</TD>');
         If UILinks then begin
            BatchHTML.Add('<TD><a href="javascript://" onclick="GetVTCheckDetailAJAX(''' + BRNID + ''',''' + BSC + ''',true)">' + BSC + '</a></TD>');
         end else begin
            BatchHTML.Add('<TD>' + BSC + '</TD>');
         end;

         BatchHTML.Add('</TR>');
         TCResults.Next;
      end;
      BatchHTML.Add('</TABLE>');
  end;

Begin
   Result := '';

   TranIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/TCTRANIDENTDESC', 'Tran Ident')); //2018-4-24 bls: F#3735
   CustIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/TCCUSTIDENTDESC', 'Cust Ident')); //2018-4-24 bls: F#3735
   StoreSystemCodeLabel := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL', ''));

   IncludeEmpIdent := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEEMPIDENT', 'FALSE'));
   IncludeRefundData := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEREFUNDDATA', 'FALSE'));
   IncludeStoreName := DisplayStoreNameOnOpenCheck;

   LocationRNID := NumericOnly(Request.queryfields.Values['LOCATIONRNID']);
   if IncludeStoreName then begin
      StoreName := FetchStoreName(LocationRNID);
   end;

   FBatchDetailDM := TBatchDetailDM.Create(ProcessLog, ProcessPPSAPIXML);

   FieldNames := TStringList.Create;
   CreateFieldNames;
   FCheckBatchXML := FBatchDetailDM.GetTCBatch(LocationRNID, '', true, EmpIdentP, FieldNames);
   FormatHTMLHeader;

   If (FCheckBatchXML <> NIL) AND (FCheckBatchXML.GetNode('/TRANRESP/TCBATCHDETAIL/TCAUTHDETAIL') <> NIL) then begin
      FBatchDetailDM.BatchXMLToACRTable(FCheckBatchXML.DocumentAsString,'TCBATCHDETAIL');
      TCResults := FBatchDetailDM.BatchDS;

      if (TCResults.RecordCount > 0) then FormatHTMLBody;
   end;
   Result := BatchHTML.Text;

   if assigned(BatchHTML) then BatchHTML.Free;
   if assigned(FieldNames) then FieldNames.Free;
   if assigned(FCheckBatchXML) then FCheckBatchXML.Free;
   if assigned(TCResults) then TCResults.Free;
   if assigned(FBatchDetailDM) then FBatchDetailDM.Free;
end;


function TCustomerInfoModule.GetCheckBatchToGRID(const UILinks: Boolean; const ARNID, EmpIdentP : string): String; //2018-06-20 bls: F#840 //2018-07-18 bls: F#4978
var
  IncludeEmpIdent, IncludeRefundData, useJSONResp, IncludeStoreName: boolean;
  CustIdentHeader, StoreSystemCodeLabel, TranIdentHeader, StoreName, LocationRNID: string;

  FBatchDetailDM : TBatchDetailDM;
  FCheckBatchXML : TOpenXML;
  FieldNames, GRID : TStringList;
  TCResults : TDataSet;

  Procedure CreateFieldNames();
  begin
      FieldNames.Add('AUTHDATE');
      FieldNames.Add('UPDATEDAMOUNT');
      FieldNames.Add('TRANAMOUNT');
      FieldNames.Add('VOIDED');
      FieldNames.Add('RESPONSECHECKNUMBER');
      FieldNames.Add('DISPLAYTEXT');
      FieldNames.Add('ECATRANSTATUS');
      FieldNames.Add('TRANIDENT');
      FieldNames.Add('TRANCUSTOMERCODE');
      FieldNames.Add('STATIONIDENT');
      FieldNames.Add('TCMID');

      If IncludeEmpIdent then FieldNames.Add('TRANEMPLOYEEIDENT');

      if IncludeRefundData then begin
         FieldNames.Add('REFUNDAMOUNT');
         FieldNames.Add('REFUNDDATE');
         FieldNames.Add('REFUNDCOUNT');
      end;   
  end;

  Procedure FormatGRID;
  var
      BRNID, BSC, Amt, totalCount : string; //2017-11-16 jtm: F#2047
  begin
      GRID := TStringList.Create();
      totalCount := inttostr(TCResults.RecordCount);

      GRID.Append('<?xml version="1.0" encoding="UTF-8"?><rows total_count=''' + totalCount + ''' pos=''0''>');

      while NOT TCResults.EOF do begin
         GRID.Append('<row>');

         BRNID := trim(ARNID);
         BSC := Trim(TCResults.FieldByName('SYSTEMCODE').AsString);
         GRID.Append('<cell>' + BRNID + '</cell>');
         if IncludeStoreName then GRID.Add('<cell>' + StoreName + '</cell>');
         GRID.Append('<cell>' + Trim(TCResults.FieldByName('AUTHDATE').AsString) + '</cell>');

         GRID.Append('<cell>');
         if (TCResults.FieldByName('UPDATEDAMOUNT').AsString <> '') then begin //2017-11-16 jtm: F#2047
            GRID.Append('<![CDATA[<IMG SRC="/Images/General/Refresh.gif" border="0" style="display: inline-block">]]>');
            Amt := Trim(TCResults.FieldByName('UPDATEDAMOUNT').AsString);
         end else begin
            Amt := Trim(TCResults.FieldByName('TRANAMOUNT').AsString);
         end;

         if TCResults.FieldByName('VOIDED').AsString = 'TRUE'  then begin
            GRID.Append('<![CDATA[<DEL>Void ' + DisplayMoney(ValuReal(Amt)) + '</DEL>]]></cell>');
         end else begin
            GRID.Append(DisplayMoney(ValuReal(Amt)) + '</cell>');
         end;

         GRID.Append('<cell>' + Trim(TCResults.FieldByName('RESPONSECHECKNUMBER').AsString) + '</cell>');
         GRID.Append('<cell>' + Trim(TCResults.FieldByName('DISPLAYTEXT').AsString) + '</cell>');

         If TCResults.FieldByName('ECATRANSTATUS').AsString = '0' then begin
            GRID.Append('<cell><![CDATA[<IMG SRC="/Images/General/CheckSmall.gif" border="0" style="display: inline-block">');
         end else If TCResults.FieldByName('ECATRANSTATUS').AsString = '1' then begin
            GRID.Append('<cell><![CDATA[<IMG SRC="/Images/General/BoltSmall.gif" border="0" style="display: inline-block">');
         end else If TCResults.FieldByName('ECATRANSTATUS').AsString = '3' then begin
            GRID.Append('<cell><![CDATA[<IMG SRC="/Images/General/XFailed.gif" border="0" style="display: inline-block">');
          end else If TCResults.FieldByName('ECATRANSTATUS').AsString = '4' then begin
            GRID.Append('<cell><![CDATA[<IMG SRC="/Images/General/XFailed.gif" border="0" style="display: inline-block">');
         end else begin
            GRID.Append('<cell><![CDATA[<IMG SRC="/Images/General/ExclamationSmall.gif" border="0" style="display: inline-block">');
         end;
         GRID.Append(Trim(TCResults.FieldByName('ECATRANSTATUS').AsString) + ']]></cell>');

         GRID.Append('<cell>' + Trim(TCResults.FieldByName('TRANIDENT').AsString) + '</cell>');
         GRID.Append('<cell>' + Trim(TCResults.FieldByName('TRANCUSTOMERCODE').AsString) + '</cell>');
         GRID.Append('<cell>' + Trim(TCResults.FieldByName('STATIONIDENT').AsString) + '</cell>');
         GRID.Append('<cell>' + Trim(TCResults.FieldByName('TCMID').AsString) + '</cell>');
         GRID.Append('<cell>' + Trim(TCResults.FieldByName('TCSERVICENAME').AsString) + '</cell>');

         if IncludeEmpIdent then GRID.Append('<cell>' + Trim(TCResults.FieldByName('TRANEMPLOYEEIDENT').AsString) + '</cell>');

         if IncludeRefundData then begin
            GRID.Append('<cell>' + Trim(TCResults.FieldByName('REFUNDAMOUNT').AsString) + '</cell>');
            GRID.Append('<cell>' + Trim(TCResults.FieldByName('REFUNDDATE').AsString) + '</cell>');
            GRID.Append('<cell>' + Trim(TCResults.FieldByName('REFUNDCOUNT').AsString) + '</cell>');
         end;

         If UILinks then begin
            GRID.Append('<cell><![CDATA[<a href="javascript://" onclick="GetVTCheckDetailAJAX(''' + BRNID + ''',''' + BSC + ''',true)">' + BSC + '</a>]]></cell>');
         end else begin
            GRID.Append('<cell>' + BSC + '</cell>');
         end;

         GRID.Append('</row>');
         TCResults.Next;
      end;
      GRID.Append('</rows>');
   end;

  Procedure FormatGRIDJSON; //2018-07-18 bls: F#4978
  var
      BRNID, BSC, Amt, totalCount : string; //2017-11-16 jtm: F#2047
      i : integer;

      scField, dateField, updatedAmtField, amtField, voidedField, respCheckNumField, displayTextField, ecaStatusField, tranIdentField, custIdentField, stationIdent, midField, servNameField,
         empIdentField, refundAmtField, refundDateField, refundCountField : TField;
  begin
      i := 0;
      TCResults.DisableControls;
      totalCount := inttostr(TCResults.RecordCount);

      scField := TCResults.FieldByName('SYSTEMCODE');
      dateField := TCResults.FieldByName('AUTHDATE');
      updatedAmtField := TCResults.FieldByName('UPDATEDAMOUNT');
      amtField := TCResults.FieldByName('TRANAMOUNT');
      voidedField := TCResults.FieldByName('VOIDED');
      respCheckNumField := TCResults.FieldByName('RESPONSECHECKNUMBER');
      displayTextField := TCResults.FieldByName('DISPLAYTEXT');
      ecaStatusField := TCResults.FieldByName('ECATRANSTATUS');
      tranIdentField := TCResults.FieldByName('TRANIDENT');
      custIdentField := TCResults.FieldByName('TRANCUSTOMERCODE');
      stationIdent := TCResults.FieldByName('STATIONIDENT');
      midField := TCResults.FieldByName('TCMID');
      servNameField := TCResults.FieldByName('TCSERVICENAME');
      if IncludeEmpIdent then empIdentField := TCResults.FieldByName('TRANEMPLOYEEIDENT');
      if IncludeRefundData then begin
         refundAmtField := TCResults.FieldByName('REFUNDAMOUNT');
         refundDateField := TCResults.FieldByName('REFUNDDATE');
         refundCountField := TCResults.FieldByName('REFUNDCOUNT');
      end;

      GRID := TStringList.Create();
      GRID.BeginUpdate;
      GRID.Append('{"total_count":' + totalCount + ',"pos":0,"rows":[');

      while NOT TCResults.EOF do begin
         inc(i);
         GRID.Add('{"id":' + inttostr(i) + ',"data":[');

         BRNID := trim(ARNID);
         BSC := Trim(scField.AsString);
         GRID.Add('"' + BRNID + '",');
         if IncludeStoreName then GRID.Add('"' + StoreName + '",');
         GRID.Add('"' + Trim(dateField.AsString) + '",');

         GRID.Add('"');
         if (updatedAmtField.AsString <> '') then begin //2017-11-16 jtm: F#2047
            GRID.Add('"<IMG SRC=\"\/Images\/General\/Refresh.gif\" border=\"0\" style=\"display: inline-block\" \/>');
            Amt := Trim(updatedAmtField.AsString);
         end else begin
            Amt := Trim(amtField.AsString);
         end;

         if voidedField.AsString = 'TRUE'  then begin
            GRID.Add('<DEL>Void ' + DisplayMoney(ValuReal(Amt)) + '<\/DEL>",');
         end else begin
            GRID.Add(DisplayMoney(ValuReal(Amt)) + '",');
         end;

         GRID.Add('"' + Trim(respCheckNumField.AsString) + '",');
         GRID.Add('"' + Trim(displayTextField.AsString) + '",');

         If ecaStatusField.AsString = '0' then begin
            GRID.Add('"<IMG SRC=\"\/Images\/General\/CheckSmall.gif\" border=\"0\" style=\"display: inline-block\" \/>');
         end else If ecaStatusField.AsString = '1' then begin
            GRID.Add('"<IMG SRC=\"\/Images\/General\/BoltSmall.gif\" border=\"0\" style=\"display: inline-block\" \/>');
         end else If ecaStatusField.AsString = '3' then begin
            GRID.Add('"<IMG SRC=\"\/Images\/General\/XFailed.gif\" border=\"0\" style=\"display: inline-block\" \/>');
          end else If ecaStatusField.AsString = '4' then begin
            GRID.Add('"<IMG SRC=\"\/Images\/General\/XFailed.gif\" border=\"0\" style=\"display: inline-block\" \/>');
         end else begin
            GRID.Add('"<IMG SRC=\"\/Images\/General\/ExclamationSmall.gif\" border=\"0\" style=\"display: inline-block\" \/>');
         end;
         GRID.Add(Trim(ecaStatusField.AsString) + '",');

         GRID.Add('"' + Trim(tranIdentField.AsString) + '",');
         GRID.Add('"' + Trim(custIdentField.AsString) + '",');
         GRID.Add('"' + Trim(stationIdent.AsString) + '",');
         GRID.Add('"' + Trim(midField.AsString) + '",');
         GRID.Add('"' + Trim(servNameField.AsString) + '",');

         if IncludeEmpIdent then GRID.Add('"' + Trim(empIdentField.AsString) + '",');

         if IncludeRefundData then begin
            GRID.Add('"' + Trim(refundAmtField.AsString) + '",');
            GRID.Add('"' + Trim(refundDateField.AsString) + '",');
            GRID.Add('"' + Trim(refundCountField.AsString) + '",');
         end;

         If UILinks then begin
            GRID.Add('"<a href=\"javascript:\/\/\" onclick=\"GetVTCheckDetailAJAX(''' + BRNID + ''',''' + BSC + ''',true)\">' + BSC + '<\/a>"]}');
         end else begin
            GRID.Add('"' + BSC + '"]}');
         end;

         TCResults.Next;
         if NOT TCResults.EOF then GRID.Add(',');
      end;
      GRID.Add(']}');
      GRID.EndUpdate;
   end;

Begin
   TranIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/TCTRANIDENTDESC', 'Tran Ident')); //2018-4-24 bls: F#3735
   CustIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/TCCUSTIDENTDESC', 'Cust Ident')); //2018-4-24 bls: F#3735
   StoreSystemCodeLabel := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL', ''));

   IncludeEmpIdent := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEEMPIDENT', 'FALSE'));
   IncludeRefundData := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEREFUNDDATA', 'FALSE'));
   useJSONResp := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEJSONFORGRIDS','TRUE'));
   IncludeStoreName := DisplayStoreNameOnOpenCheck;

   LocationRNID := NumericOnly(Request.queryfields.Values['LOCATIONRNID']);
   if IncludeStoreName then begin
      StoreName := FetchStoreName(LocationRNID);
   end;

   if useJSONResp then begin
      Result := '{"total_count":0,"pos":0,"rows":[]}';
   end else begin
      Result := '<?xml version="1.0" encoding="UTF-8"?><rows total_count=''0'' pos=''0''></rows>';
   end;

   FBatchDetailDM := TBatchDetailDM.Create(ProcessLog, ProcessPPSAPIXML);

   FieldNames := TStringList.Create;
   CreateFieldNames();

   FCheckBatchXML := FBatchDetailDM.GetTCBatch(LocationRNID, '', true, EmpIdentP, FieldNames);

   IF (FCheckBatchXML <> NIL) AND (FCheckBatchXML.GetNode('/TRANRESP/TCBATCHDETAIL/TCAUTHDETAIL') <> NIL) then begin
      FBatchDetailDM.BatchXMLToACRTable(FCheckBatchXML.DocumentAsString,'TCBATCHDETAIL');
      TCResults := FBatchDetailDM.BatchDS;

      if (TCResults.RecordCount > 0) then begin
         if useJSONResp then begin
            FormatGRIDJSON();
            Result := TextWithoutNewLine(GRID);
         end else begin
            FormatGrid();
            Result := GRID.Text;
         end;
      end;
   end;

   if assigned(GRID) then GRID.Free;
   if assigned(FieldNames) then FieldNames.Free;
   if assigned(TCResults) then  TCResults.Free;
   if assigned(FCheckBatchXML) then FCheckBatchXML.Free;
   if assigned(FBatchDetailDM ) then FBatchDetailDM.Free;
end;

function TCustomerInfoModule.GetCashBatchToGRID(const UILinks : Boolean; const EmpIdentP : String): String; //2018-06-20 bls: F#840 //2018-07-18 bls: F#4978
var
  useJSONResp : boolean;
  CustIdentHeader, TranIdentHeader, StoreSystemCodeLabel, lastSystemCode, count : string;
  rowsRemaining : integer;

  FBatchDetailDM : TBatchDetailDM;
  FCashBatchXML : TOpenXML;
  CashResults : TDataSet;
  FieldNames, GRID : TStringList;

  Procedure CreateFieldNames();
  begin
      FieldNames.Add('TRANAMT');
      FieldNames.Add('TRANDATE');
      FieldNames.Add('TRANTYPE');
      FieldNames.Add('EMPIDENT');
      FieldNames.Add('TRANIDENT');
      FieldNames.Add('CUSTIDENT');
      FieldNames.Add('STATIONIDENT');
      FieldNames.Add('CURRENCYTYPE');
  end;

  Procedure FormatGRIDJSON;
  var
      BRNID, BSC, totalCount, amount : String;
      i : integer;
      rnidField, scField, amtField, dateField, tranTypeField, empIdentField, tranIdentField, custIdentField, stationIdentField, currTypeField : TField;

  begin
      CashResults.DisableControls;
      totalCount := inttostr(CashResults.RecordCount);

      rnidField := CashResults.FieldByName('PROFILE');
      scField := CashResults.FieldByName('SYSTEMCODE');
      amtField := CashResults.FieldByName('TRANAMT');
      dateField := CashResults.FieldByName('TRANDATE');
      tranTypeField := CashResults.FieldByName('TRANTYPE');
      empIdentField := CashResults.FieldByName('EMPIDENT');
      tranIdentField := CashResults.FieldByName('TRANIDENT');
      custIdentField := CashResults.FieldByName('CUSTIDENT');
      stationIdentField := CashResults.FieldByName('STATIONIDENT');
      currTypeField := CashResults.FieldByName('CURRENCYTYPE');

      GRID := TStringList.Create();
      GRID.BeginUpdate;
      GRID.Add('{"total_count":' + totalCount + ',"pos":0,"rows":[');

      while NOT CashResults.EOF do begin
         inc(i);
         GRID.Add('{"id":' + inttostr(i) + ',"data":[');

         BRNID := Trim(rnidField.AsString);
         BSC := Trim(scField.AsString);
         amount := DisplayMoney(ValuReal(Trim(amtField.AsString)));

         GRID.Add('"' + BRNID + '",');
         GRID.Add('"' + dateField.AsString + '",');
         GRID.Add('"' + Trim(tranTypeField.AsString) + '",');
         GRID.Add('"' + amount + '",');

         GRID.Add('"' + Trim(empIdentField.AsString) + '",');
         GRID.Add('"' + Trim(tranIdentField.AsString) + '",');
         GRID.Add('"' + Trim(custIdentField.AsString) + '",');

         GRID.Add('"' + Trim(stationIdentField.AsString) + '",');
         GRID.Add('"' + Trim(currTypeField.AsString) + '",'); //2016-8-22 jtm: Feat OT#1080

         if (UILinks) then begin
            GRID.Add('"<a href=\"javascript:\/\/\" onclick=\"GetVTCashDetailAJAX(''' + BRNID+ ''','''+ BSC + ''',true)\">' + BSC+ '<\/a>"]}');
         end else begin
            GRID.Add('"' + BSC + '"]}');
         end;
         CashResults.Next;
         if NOT CashResults.EOF then GRID.Add(',');
      end;
      GRID.Add(']}');
      GRID.EndUpdate;
  end;

  Procedure FormatGRID;
  var
   BRNID, BSC, totalCount, amount : String;
  begin
         GRID := TStringList.Create();
         totalCount := inttostr(CashResults.RecordCount);

         GRID.Append('<?xml version="1.0" encoding="UTF-8"?><rows total_count=''' + totalCount + ''' pos=''0''>');

         while NOT CashResults.EOF do begin
            GRID.Append('<row>');

            BRNID := Trim(CashResults.FieldByName('PROFILE').AsString);
            BSC := Trim(CashResults.FieldByName('SYSTEMCODE').AsString);
            amount := DisplayMoney(ValuReal(Trim(CashResults.FieldByName('TRANAMT').AsString)));

            GRID.Append('<cell>' + BRNID + '</cell>');
            GRID.Append('<cell>' + Trim(CashResults.FieldByName('TRANDATE').AsString) + '</cell>');
            GRID.Append('<cell>' + Trim(CashResults.FieldByName('TRANTYPE').AsString) + '</cell>');
            GRID.Append('<cell>' + amount + '</cell>');

            GRID.Append('<cell>' + Trim(CashResults.FieldByName('EMPIDENT').AsString) + '</cell>');
            GRID.Append('<cell>' + Trim(CashResults.FieldByName('TRANIDENT').AsString) + '</cell>');
            GRID.Append('<cell>' + Trim(CashResults.FieldByName('CUSTIDENT').AsString) + '</cell>');

            GRID.Append('<cell>' + Trim(CashResults.FieldByName('STATIONIDENT').AsString) + '</cell>');
            GRID.Append('<cell>' + Trim(CashResults.FieldByName('CURRENCYTYPE').AsString) + '</cell>'); //2016-8-22 jtm: Feat OT#1080

            if (UILinks) then begin
               GRID.Append('<cell><![CDATA[<a href="javascript://" onclick="GetVTCashDetailAJAX(''' + BRNID+ ''','''+ BSC + ''',true)">' + BSC+ '</a>]]></cell>');
            end else begin
            GRID.Append('<cell>' + BSC + '</cell>');
            end;

            GRID.Append('</row>');
            CashResults.Next;
         end;
         GRID.Append('</rows>');
  end;

Begin
   useJSONResp := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEJSONFORGRIDS','TRUE'));

   if useJSONResp then begin
      Result := '{"total_count":0,"pos":0,"rows":[]}';
   end else begin
      Result := '<?xml version="1.0" encoding="UTF-8"?><rows total_count=''0'' pos=''0''></rows>';
   end;

   TranIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CASHTRANIDENTDESC', 'Tran Ident')); //2018-4-24 bls: F#3735
   CustIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CASHCUSTIDENTDESC', 'Cust Ident')); //2018-4-24 bls: F#3735
   StoreSystemCodeLabel := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL', ''));


   rowsRemaining := 0;
   lastSystemCode := '';
   count := '';
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ALLOWCHUNKING', 'FALSE') = 'TRUE') then begin
      count := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ROWSFETCHEDPERCHUNKCASH', '400');
   end;

   FBatchDetailDM := TBatchDetailDM.Create(ProcessLog, ProcessPPSAPIXML);

   FieldNames := TStringList.Create();
   CreateFieldNames();

   FCashBatchXML := FBatchDetailDM.GetCashBatch(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),'', true, count, lastSystemCode, EmpIdentP, FieldNames);

   If (FCashBatchXML <> NIL) AND (FCashBatchXML.GetNode('/TRANRESP/CASHBATCHDETAIL/CASHDETAIL') <> NIL) then begin // If there was a response
      if count <> '' then begin
         rowsRemaining := FCashBatchXML.GetValueAsInteger('/TRANRESP/PENDINGRECORDCOUNT'); // Get the amount of records that are left in the gateway
         lastSystemCode := FCashBatchXML.GetValueAsWideString('/TRANRESP/LASTSYSTEMCODE'); // Get the last system code of a set of records to know where to start the next chunk
      end;

      FBatchDetailDM.BatchXMLToACRTable(FCashBatchXML.DocumentAsString, 'CASHBATCHDETAIL'); // Load the Response into a queryable table

      while (rowsRemaining > 0) AND (count <> '') do begin
         FCashBatchXML := FBatchDetailDM.GetCashBatch(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),'', true, count, lastSystemCode, EmpIdentP, FieldNames);

         if FCashBatchXML <> NIL then begin
            FBatchDetailDM.AddDataToTable(FCashBatchXML.DocumentAsString);
            rowsRemaining := FCashBatchXML.GetValueAsInteger('/TRANRESP/PENDINGRECORDCOUNT');  // update rowsRemaining
            lastSystemCode := FCashBatchXML.GetValueAsWideString('/TRANRESP/LASTSYSTEMCODE'); // update lastsystemcode
         end;
      end;

      CashResults := FBatchDetailDM.BatchDS; // Turn that table into a dataset

      if (CashResults.RecordCount > 0) then begin // If we have records
         if useJSONResp then begin
            FormatGRIDJSON();
            Result := TextWithoutNewLine(GRID);
         end else begin
         FormatGRID();
         Result := GRID.Text;
      end;
   end;
   end;

   if assigned(GRID) then GRID.Free;
   if assigned(FieldNames) then FieldNames.Free;
   if assigned(CashResults) then CashResults.Free;
   if assigned(FBatchDetailDM) then FBatchDetailDM.Free;
   if assigned(FCashBatchXML) then FCashBatchXML.Free;
end;

function TCustomerInfoModule.GetCashBatchToHTML(const UILinks: Boolean; const EmpIdentP: String): String; //2018-06-20 bls: F#2227
var
  StoreSystemCodeLabel, TranIdentHeader, CustIdentHeader, lastSystemCode, count : string;
  rowsRemaining : integer;

  FBatchDetailDM : TBatchDetailDM;
  FCashBatchXML : TOpenXML;
  CashResults : TDataSet;
  BatchHTML, FieldNames : TStringList;

  Procedure CreateFieldNames();
  begin
      FieldNames.Add('TRANAMT');
      FieldNames.Add('TRANDATE');
      FieldNames.Add('TRANTYPE');
      FieldNames.Add('EMPIDENT');
      FieldNames.Add('TRANIDENT');
      FieldNames.Add('CUSTIDENT');
      FieldNames.Add('STATIONIDENT');
      FieldNames.Add('CURRENCYTYPE');
  end;

  Procedure FormatHTMLHeader;
  var
   BatchHTMLHeader : string;
  begin
   BatchHTML := TStringList.Create;
   BatchHTMLHeader := '<TABLE border="1" cellspacing="0" cellpadding="3"  style="border-collapse: collapse; font-family:veranda">' +
                 '<TR><TD><B>RNID</B></TD>'+
                 '    <TD><B>Tran Date</B></TD>'+
                 '    <TD><B>Tran Type</B></TD>'+
                 '    <TD><B>Amount</B></TD>'+
                 '    <TD><B>Emp Ident</B></TD>'+
                 '    <TD><B>' + TranIdentHeader + '</B></TD>'+
                 '    <TD><B>' + CustIdentHeader + '</B></TD>';

    BatchHTMLHeader := BatchHTMLHeader + '    <TD><B>Station Ident</B></TD>'+
                                        '    <TD><B>Type</B></TD>';

   if (StoreSystemCodeLabel <> '') then begin
      BatchHTMLHeader := BatchHTMLHeader +  '  <TD><B>'+ StoreSystemCodeLabel +'</B></TD>'
   end else begin
      BatchHTMLHeader := BatchHTMLHeader + '  <TD><B>Item Serial</B></TD>';
   end;
   BatchHTMLHeader := BatchHTMLHeader + '</TR>';

   BatchHTML.Add(BatchHTMLHeader);
  end;

  Procedure FormatHTMLBody;
  var
      Line, BRNID, BSC : String;
      rnidField, dateField, tranTypeField, amtField, empIdentField, tranIdentField, custIdentField, stationIdentField, currTypeField, scField : TField;
  begin
      CashResults.DisableControls;

      rnidField := CashResults.FieldByName('PROFILE');
      dateField := CashResults.FieldByName('TRANDATE');
      tranTypeField := CashResults.FieldByName('TRANTYPE');
      amtField := CashResults.FieldByName('TRANAMT');
      empIdentField := CashResults.FieldByName('EMPIDENT');
      tranIdentField := CashResults.FieldByName('TRANIDENT');
      custIdentField := CashResults.FieldByName('CUSTIDENT');
      stationIdentField := CashResults.FieldByName('STATIONIDENT');
      currTypeField := CashResults.FieldByName('CURRENCYTYPE');
      scField := CashResults.FieldByName('SYSTEMCODE');

      While NOT CashResults.EOF do begin
      Line := '';
         BRNID := Trim(rnidField.AsString);
         BSC := scField.AsString;
         Line := Line + '<TR>' +
                     '<TD>' + BRNID + '</TD>' +
                     '<TD>' + dateField.AsString + '</TD>' +
                     '<TD>' + tranTypeField.AsString + '</TD>' +
                     '<TD>' + DisplayMoney(ValuReal(amtField.AsString)) + '</TD>';

         Line := Line +'<TD>' + empIdentField.AsString + '</TD>' +
                     '<TD>' + tranIdentField.AsString + '</TD>' +
                     '<TD>' + custIdentField.AsString + '</TD>';

         Line := Line + '<TD>' + stationIdentField.AsString + '</TD>' +
                        '<TD>' + currTypeField.AsString + '</TD>';  //2016-8-22 jtm: Feat OT#1080

         if (UILinks) then begin
            Line := Line +  '<TD><a href="javascript://" onclick="GetVTCashDetailAJAX(''' + BRNID+ ''','''+ BSC + ''',true)">' + BSC+ '</a></TD>';
         end else begin
            Line := Line +  '<TD>' + BSC + '</TD>';
         end;
         Line := Line +  '</TR>';
         BatchHTML.Add(Line);
         CashResults.Next;
      end;
  end;

  Procedure FormatHTMLBodyOld;
  var
   Line, BRNID, BSC : String;
  begin
      While NOT CashResults.EOF do begin
         Line := '';
         BRNID := Trim(CashResults.FieldByName('PROFILE').AsString);
         BSC := CashResults.FieldByName('SYSTEMCODE').AsString;
         Line := Line + '<TR>' +
                     '<TD>' + CashResults.FieldByName('PROFILE').AsString + '</TD>' +
                     '<TD>' + CashResults.FieldByName('TRANDATE').AsString + '</TD>' +
                     '<TD>' + CashResults.FieldByName('TRANTYPE').AsString + '</TD>' +
                     '<TD>' + DisplayMoney(ValuReal(CashResults.FieldByName('TRANAMT').AsString)) + '</TD>';

         Line := Line +'<TD>' + CashResults.FieldByName('EMPIDENT').AsString + '</TD>' +
                     '<TD>' + CashResults.FieldByName('TRANIDENT').AsString + '</TD>' +
                     '<TD>' + CashResults.FieldByName('CUSTIDENT').AsString + '</TD>';

         Line := Line + '<TD>' + CashResults.FieldByName('STATIONIDENT').AsString + '</TD>' +
                        '<TD>' + CashResults.FieldByName('CURRENCYTYPE').AsString + '</TD>';  //2016-8-22 jtm: Feat OT#1080

         if (UILinks) then begin
            Line := Line +  '<TD><a href="javascript://" onclick="GetVTCashDetailAJAX(''' + BRNID+ ''','''+ BSC + ''',true)">' + BSC+ '</a></TD>';
         end else begin
         Line := Line +  '<TD>' + BSC + '</TD>';
         end;
         Line := Line +  '</TR>';
         BatchHTML.Add(Line);
         CashResults.Next;
      end;
   end;

Begin
   Result := '';

   TranIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CASHTRANIDENTDESC', 'Tran Ident')); //2018-4-24 bls: F#3735
   CustIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CASHCUSTIDENTDESC', 'Cust Ident')); //2018-4-24 bls: F#3735
   StoreSystemCodeLabel := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL', ''));

   rowsRemaining := 0;
   lastSystemCode := '';
   count := '';
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ALLOWCHUNKING', 'FALSE') = 'TRUE') then begin
      count := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ROWSFETCHEDPERCHUNKCASH', '400');
end;

   FBatchDetailDM := TBatchDetailDM.Create(ProcessLog, ProcessPPSAPIXML);

   FieldNames := TStringList.Create();
   CreateFieldNames();

   FCashBatchXML := FBatchDetailDM.GetCashBatch(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),'', true, count, lastSystemCode, EmpIdentP, FieldNames);
   FormatHTMLHeader();

   If (FCashBatchXML <> NIL) AND (FCashBatchXML.GetNode('/TRANRESP/CASHBATCHDETAIL/CASHDETAIL') <> NIL) then begin // If there was a response
      if count <> '' then begin
         rowsRemaining := FCashBatchXML.GetValueAsInteger('/TRANRESP/PENDINGRECORDCOUNT'); // Get the amount of records that are left in the gateway
         lastSystemCode := FCashBatchXML.GetValueAsWideString('/TRANRESP/LASTSYSTEMCODE'); // Get the last system code of a set of records to know where to start the next chunk
      end;

      FBatchDetailDM.BatchXMLToACRTable(FCashBatchXML.DocumentAsString, 'CASHBATCHDETAIL'); // Load the Response into a queryable table

      while (rowsRemaining > 0) AND (count <> '') do begin
         FCashBatchXML := FBatchDetailDM.GetCashBatch(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),'', true, count, lastSystemCode, EmpIdentP, FieldNames);

         if FCashBatchXML <> NIL then begin
            FBatchDetailDM.AddDataToTable(FCashBatchXML.DocumentAsString);
            rowsRemaining := FCashBatchXML.GetValueAsInteger('/TRANRESP/PENDINGRECORDCOUNT');  // update rowsRemaining
            lastSystemCode := FCashBatchXML.GetValueAsWideString('/TRANRESP/LASTSYSTEMCODE'); // update lastsystemcode
         end;
      end;

      CashResults := FBatchDetailDM.BatchDS; // Turn that table into a dataset

      if (CashResults.RecordCount > 0) then begin // If we have records
         FormatHTMLBody();
      end;
   end;

   BatchHTML.Add('</TABLE>');
   Result := BatchHTML.Text;

   if assigned(BatchHTML) then BatchHTML.Free;
   if assigned(FieldNames) then FieldNames.Free;
   if assigned(CashResults) then CashResults.Free;
   if assigned(FCashBatchXML) then FCashBatchXML.Free;
   if assigned(FBatchDetailDM) then FBatchDetailDM.Free;
end;

function TCustomerInfoModule.GetCardQueryTableXML(RNID: String; FromDate, ThruDate: TDateTime;
   BatchSerial: Integer; StationName, SaleType,
   StationIdent, DisplayFormat: String; SettledOnly,
   ShowLinks: Boolean): String;
var
   WS : String;
   I : Integer;
   StoreInfo : String;
   TabText : String;
   PosStart : string;
   QueryCount : string;
   QuerySQLText : string;
   QueryOrderBy : string;
   QueryOrderDirect : string;
   QueryTotalCount : string;
   QueryColList : TStringList;

   SaleVisaMC : Integer;
   SaleAMEX : Integer;
   SaleDISC : Integer;
   SaleQVisaMC : Integer;
   SaleQAMEX : Integer;
   SaleQDISC : Integer;

   CreditVisaMC : Integer;
   CreditAMEX : Integer;
   CreditDISC : Integer;
   CreditQVisaMC : Integer;
   CreditQAMEX : Integer;
   CreditQDISC : Integer;

   VoidVisaMC : Integer;
   VoidAMEX : Integer;
   VoidDISC : Integer;
   VoidQVisaMC : Integer;
   VoidQAMEX : Integer;
   VoidQDISC : Integer;
   MaskAcct : String;

   WI : Integer;

   Line, Lines : String;
   TotalRecs : Integer;
   ReturnedRecs : integer;
   StartRow : integer;

   HTML : TStringList;
   CSV : TStringList;
   IncludeServiceName : boolean;
   IncludeEmpIdent : boolean;
   IncludeCardHolderName : boolean;
   IncludeSFINDICATOR : boolean;
   IncludeCVVResp : boolean; //2018-3-14 ajs: F#3629
   IncludeAVSResp : boolean; //2018-3-14 ajs: F#3629
   IncludeAVSData : boolean; // 2019-06-15 tjr: DVST-564
   AVSDataHeader : string; // 2019-06-15 tjr: DVST-564
   HTMLHeader : string;
   Procedure AddAmt(Var VisaMCInt : integer; Var AmexInt : integer; Var DiscInt : integer;
                    Var VisaMCQInt : integer; Var AmexQInt : integer; Var DiscQInt : integer);
   Begin
      WI := Round(RNQuery.FieldByName('TranAmt').AsFloat *100);
      If (Trim(RNQuery.FieldByName('CardType').AsString) = 'VISA') or
         (Trim(RNQuery.FieldByName('CardType').AsString) = 'MC') then begin
         VisaMCInt := VISAMCInt + WI;
         Inc(VisaMCQInt);
      end else If (Trim(RNQuery.FieldByName('CardType').AsString) = 'AMEX') then begin
         AmexInt := AmexInt + WI;
         Inc(AmexQInt);
      end else If (Trim(RNQuery.FieldByName('CardType').AsString) = 'DISC') then begin
         DiscInt := DiscInt + WI;
         Inc(DiscQInt);
      end;
   end;
begin
   SaleVisaMC := 0;
   SaleAMEX := 0;
   SaleDISC := 0;
   SaleQVisaMC := 0;
   SaleQAMEX := 0;
   SaleQDISC := 0;

   CreditVisaMC := 0;
   CreditAMEX := 0;
   CreditDISC := 0;
   CreditQVisaMC := 0;
   CreditQAMEX := 0;
   CreditQDISC := 0;

   VoidVisaMC := 0;
   VoidAMEX := 0;
   VoidDISC := 0;
   VoidQVisaMC := 0;
   VoidQAMEX := 0;
   VoidQDISC := 0;
   PosStart := '0';
   QueryCount := '100';
   QuerySQLText := '';
   QueryOrderBy := '';
   QueryOrderDirect := '';

   HTML := TStringList.Create;
   CSV := TstringList.Create;
   IncludeServiceName := false;
   IncludeEmpIdent := false;
   IncludeCardHolderName := false;
   IncludeSFINDICATOR := false;
   IncludeCVVResp := false;  //2018-3-14 ajs: F#3629
   IncludeAVSResp := false;  //2018-3-14 ajs: F#3629
   IncludeAVSData := false; // 2019-06-15 tjr: DVST-564
   
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEEMPIDENT', 'FALSE') = 'TRUE' then IncludeEmpIdent := true;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESERVICENAME', 'FALSE') = 'TRUE' then IncludeServiceName := true;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDECARDHOLDERNAME', 'FALSE') = 'TRUE' then IncludeCardHolderName := true;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESFINDICATOR', 'FALSE') = 'TRUE' then IncludeSFINDICATOR := true;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDECVVRESP', 'FALSE') = 'TRUE' then IncludeCVVResp := true;  //2018-3-14 ajs: F#3629
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEAVSRESP', 'FALSE') = 'TRUE' then IncludeAVSResp := true;  //2018-3-14 ajs: F#3629
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEAVSDATA', 'FALSE') = 'TRUE' then IncludeAVSData := true; // 2019-06-15 tjr: DVST-564
   AVSDataHeader := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/AVSDATAHEADER', 'AVSDATA'); // 2019-06-15 tjr: DVST-564

   Result := '';
   If NOT ValidateRNID(RNID) then begin
      Result := 'Invalid Store Code';
      exit;
   end;
   StoreInfo := GetStoreInfo(Valu(RNID));

   if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['posStart']))) <> '' then begin
       PosStart := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['posStart'])));
   end;
   if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['count']))) <> '' then begin
       QueryCount := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['count'])));
   end;
   if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['orderby']))) <> '' then begin
       QueryOrderBy := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['orderby'])));
   end;
   if ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['direct'])),true,false,'') <> '' then begin
       QueryOrderDirect := ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['direct'])),true,false,'');
   end;

   QuerySQLText := 'SELECT *, ROW_NUMBER() OVER (ORDER BY ';

   QueryColList := TStringList.Create;
   QueryColList.CommaText := 'StoreCode,AuthDate,SaleType,TranAmt,AuthCode,BatchDate,BatchID,CardType,CardAcct,TranIdent,TranCustomerCode';
   if IncludeServiceName then QueryColList.Add('Service Name');
   if IncludeEmpIdent then QueryColList.Add('EmployeIdent');
   if IncludeCardHolderName then QueryColList.Add('Card Holder Name');
   if IncludeSFINDICATOR then QueryColList.Add('SF');
   if IncludeCVVResp then QueryColList.Add('CVVRESP'); //2018-3-14 ajs: F#3629
   if IncludeAVSResp then QueryColList.Add('AVSRESP'); //2018-3-14 ajs: F#3629
   if IncludeAVSData then QueryColList.Add('AVSDATA');  // 2019-06-15 tjr: DVST-564
   QueryColList.Add('StationIdent');
   QueryColList.Add('StoreSystemCode');

   if (QueryOrderBy <> '') and not(StrToInt(QueryOrderBy) >= QueryColList.Count) then begin
      QuerySQLText := QuerySQLText + QueryColList[StrToInt(QueryOrderBy)];
   end else begin
      QuerySQLText := QuerySQLText + ' AuthDate';
   end;
   FreeAndNil(QueryColList);
   if QueryOrderDirect = 'DES' then QuerySQLText := QuerySQLText + ' desc';
   QuerySQLText := QuerySQLText +  ') as row FROM CCAuth ';

   QuerySQLText := QuerySQLText + 'where (StoreCode = ' + NumericOnly(RNID) + ')';
   If FromDate > 0 then
      QuerySQLText := QuerySQLText + 'And (' + RNReg.RegGetValAsString('PMACCESS.CARDLOOKUPFIELD','AuthDate') + ' >=''' + FormatDateTime('MM/DD/YYYY', Fromdate) + ''')';
   If ThruDate > 0 then
      QuerySQLText := QuerySQLText + 'And (' + RNReg.RegGetValAsString('PMACCESS.CARDLOOKUPFIELD','AuthDate') + ' <''' + FormatDateTime('MM/DD/YYYY', ThruDate + 1) + ''')';

   If VarEvaluator.GetValueAsString('LASTFOUR') <> '' then begin
      QuerySQLText := QuerySQLText + 'And (CardAcct LIKE ''%X' + VarEvaluator.GetValueAsString('LASTFOUR') + ''')';
   end;

   SaleType := UpCaseString(AlphaOnly(SaleType));
   If SaleType <> '' then
      QuerySQLText := QuerySQLText + 'And (SaleType=''' + SaleType + ''')';

   StationIdent := ValidCharsOnly(StationIdent,True,True,'-._');
   If StationIdent <> '' then
      QuerySQLText := QuerySQLText + 'And (StationIdent =''' + StationIdent + ''')';
   If SettledOnly then
      QuerySQLText := QuerySQLText + 'And (captureflag = 1)';



   if StrToInt(PosStart) = 0 then begin
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Text := QuerySQLText;
      RNQuery.Open;
      QueryTotalCount := IntToStr(RNQuery.RecordCount);
      SessionVarEval.AddValue('CCQueryTotalCount', QueryTotalCount);
      ProcessLog(ltinfo,'CCQueryTotalCount','Query Opened; Total Record Count: '+QueryTotalCount);
   end;
   RNQuery.Close;
   RNQuery.SQL.clear;
   RNQuery.SQL.Add('SET ARITHABORT ON; Declare @StartPos as int; Declare @count as int; Set @StartPos = '+ PosStart +'; set @count = '+ QueryCount +';');
   RNQuery.SQL.Add('SELECT * FROM (' + QuerySQLText);
   RNQuery.SQL.Add(') a where a.row > @StartPos and a.row <= (@StartPos +@count)');
   RNQuery.Open;

   TabText := '';
   If RNquery.RecordCount > 0 then begin

      if DisplayFormat = 'XML' then begin
         Line := '<?xml version="1.0" encoding="iso-8859-1"?><rows total_count='''+SessionVarEval.GetValueAsString('CCQueryTotalCount')+''' pos= '''+PosStart+'''>';
         Lines := Line;
      end;
      If (DisplayFormat = 'XLS') then begin
         TabText := 'RNID' + #9 +
            'Auth Date'+ #9 +
            'Type'+ #9 +
            'Amount'+ #9 + #9 +
            'Auth Code'+ #9 +
            'Non Auth Resp'+ #9 +
            'Batch Date'+ #9 +
            'Batch ID'+ #9 +
            'Type'+ #9 +
            'Card Acct'+ #9 +
            'Tran Ident'+ #9 +
            'Cust Ident'+ #9 +
            'Station'+   #9 +
            'Station Code'+ #9 +
            'Store Name'+ #9 +
            'Store City'+ #9 +
            'Store State'+ #9 +
            'Store ZIP'+ #9;
         if IncludeServiceName then TabText := TabText + 'Service Name' + #9;
         if IncludeEmpIdent then TabText := TabText + 'Employe Ident' + #9;
         if IncludeCardHolderName then TabText := TabText + 'Card Holder Name' + #9;
         if IncludeSFINDICATOR then TabText := TabText + 'SF' + #9;
         if IncludeCVVResp then TabText := TabText + 'CVVRESP' + #9; //2018-3-14 ajs: F#3629
         if IncludeAVSResp then TabText := TabText + 'AVSRESP' + #9; //2018-3-14 ajs: F#3629
         if IncludeAVSData then TabText := TabText + AVSDataHeader + #9; // 2019-06-15 tjr: DVST-564
         CSV.Add(TabText);
      end;

      While Not RNQuery.EOF do begin
         If DisplayFormat = 'XLS' then begin
            TabText := Trim(RNQuery.FieldByName('StoreCode').AsString) + #9 +
                            RNQuery.FieldByName('AuthDate').AsString + #9 +
                            Trim(RNQuery.FieldByName('SaleType').AsString) + #9;
             If Trim(RNQuery.FieldByName('SaleType').AsString) = 'CREDIT' then
               TabText := TabText + '-' + Trim(StriReal(RNQuery.FieldByName('TranAmt').AsFloat,2)) + #9
             else
               TabText := TabText + Trim(StriReal(RNQuery.FieldByName('TranAmt').AsFloat,2)) + #9;
            TabText := TabText + Trim(StriReal(RNQuery.FieldByName('TranAmt').AsFloat,2)) + #9;

            MaskAcct := Trim(RNQuery.FieldByName('CardAcct').AsString);
            ReplaceString(MaskAcct, 'XXXXXXXXX', 'X..X');
            TabText := TabText +
                                 Trim(RNQuery.FieldByName('AuthCode').AsString) + #9 +
                                 Trim(RNQuery.FieldByName('NonAuthResp').AsString) + #9 +
                                 RNQuery.FieldByName('BatchDate').AsString + #9 +
                                 Trim(RNQuery.FieldByName('BatchID').AsString) + #9 +
                                 Trim(RNQuery.FieldByName('CardType').AsString) + #9 +
                                 MaskAcct+ #9 +
                                 Trim(RNQuery.FieldByName('TranIdent').AsString) + #9 +
                                 Trim(RNQuery.FieldByName('TranCustomerCode').AsString) + #9 +
                                 Trim(RNQuery.FieldByName('StationIdent').AsString) + #9 +
                                 Trim(RNQuery.FieldByName('StoreSystemCode').AsString) + #9 +
                                 StoreName + #9 +
                                 StoreCity + #9 +
                                 StoreState + #9 +
                                 StoreZIP + #9;
            if IncludeServiceName then TabText := TabText + Trim(RNQuery.FieldByName('CCServiceName').AsString) + #9;
            if IncludeEmpIdent then TabText := TabText + Trim(RNQuery.FieldByName('TranEmployeeIdent').AsString) + #9;
            if IncludeCardHolderName then TabText := TabText + Trim(RNQuery.FieldByName('CardName').AsString) + #9;
            if (IncludeSFINDICATOR and (Trim(RNQuery.FieldByName('SFTranGUID').AsString) <> ''))then begin
               TabText := TabText + 'X' + #9;
            end;
            if IncludeCVVResp then TabText := TabText + Trim(RNQuery.FieldByName('CVVResp').AsString) + #9; //2018-3-14 ajs: F#3629
            if IncludeAVSResp then TabText := TabText + Trim(RNQuery.FieldByName('AVSResp').AsString) + #9; //2018-3-14 ajs: F#3629
            if IncludeAVSData then TabText := TabText + Trim(RNQuery.FieldByName('AVSData').AsString) + #9; // 2019-06-15 tjr: DVST-564

            CSV.Add(TabText);
         end else if DisplayFormat = 'XML' then begin
            Line := '<row id="'+ RNQuery.FieldByName('row').AsString  +'">';

            Line := Line + '<cell>' + RNQuery.FieldByName('StoreCode').AsString + '</cell>' +
                     '<cell>' + RNQuery.FieldByName('AuthDate').AsString + '</cell>'   +
                     '<cell>' + RNQuery.FieldByName('SaleType').AsString + '</cell>';

            If Trim(RNQuery.FieldByName('SaleType').AsString) = 'CREDIT' then begin
               Line := Line + '<cell align="Right">(' + Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat]) + ')</cell>';
            end else If (Trim(RNQuery.FieldByName('SaleType').AsString) = 'VOID') or (Trim(RNQuery.FieldByName('SaleType').AsString) = 'CRVOID') then begin
               Line := Line + '<cell align="Right"><![CDATA[<DEL>' + Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat]) + '</DEL>]]></cell>';
            end else begin
               Line := Line + '<cell align="Right">' + Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat]) + '</cell>';
            end;

            If Trim(RNQuery.FieldByName('SaleType').AsString) = 'CREDIT' then begin
               Line := Line + '<cell><![CDATA[<IMG SRC="/Images/General/CashSmall.gif" border="0">]]></cell>' +
                              '<cell align="Right"></cell>';
               AddAmt(CreditVisaMC, CreditAMEX, CreditDisc,CreditQVisaMC, CreditQAMEX, CreditQDisc);
            end else If (Trim(RNQuery.FieldByName('SaleType').AsString) = 'VOID') or (Trim(RNQuery.FieldByName('SaleType').AsString) = 'CRVOID')  then begin
               Line := Line + '<cell><![CDATA[<IMG SRC="/Images/General/YellowExclamation.gif" border="0">]]></cell>' +
                              '<cell align="Right">' + RNQuery.FieldByName('AuthCode').AsString + '</cell>';
               AddAmt(VoidVisaMC, VoidAMEX, VoidDisc,VoidQVisaMC, VoidQAMEX, VoidQDisc);

            end else If Trim(RNQuery.FieldByName('AuthCode').AsString) <> '' then begin
               Line := Line + '<cell><![CDATA[<IMG SRC="/Images/General/CheckSuccess.gif" border="0">]]></cell>' +
                              '<cell align="Right"><![CDATA[<font color="GREEN">' + RNQuery.FieldByName('AuthCode').AsString + '</FONT>]]></cell>';
               AddAmt(SaleVisaMC, SaleAMEX, SaleDisc,SaleQVisaMC, SaleQAMEX, SaleQDisc);
            end else begin
               Line := Line + '<cell><![CDATA[<IMG SRC="/Images/General/XFailed.gif" border="0">]]></cell>' +
                              '<cell align="Right"><![CDATA[<font color="Red">' + RNQuery.FieldByName('NonAuthResp').AsString + '</FONT>]]></cell>';
            end;

            MaskAcct := Trim(RNQuery.FieldByName('CardAcct').AsString);
            ReplaceString(MaskAcct, 'XXXXXXXXXXX', 'X..X');

            Line := Line + '<cell>' + RNQuery.FieldByName('BatchDate').AsString + '</cell>'+
                           '<cell>' + RNQuery.FieldByName('BatchID').AsString + '</cell>'+
                           '<cell>' + RNQuery.FieldByName('CardType').AsString + '</cell>'+
                           '<cell>' + MaskAcct + '</cell>'+
                           '<cell>' + RNQuery.FieldByName('TranIdent').AsString + '</cell>'+
                           '<cell>' + RNQuery.FieldByName('TranCustomerCode').AsString + '</cell>';
            if IncludeServiceName then Line := Line + '<cell>' + Trim(RNQuery.FieldByName('CCServiceName').AsString) + '</cell>';
            if IncludeEmpIdent then Line := Line + '<cell>' + Trim(RNQuery.FieldByName('TranEmployeeIdent').AsString) + '</cell>';
            if IncludeCardHolderName then Line := Line + '<cell>' + Trim(RNQuery.FieldByName('CardName').AsString) + '</cell>';
            if (IncludeSFINDICATOR and (Trim(RNQuery.FieldByName('SFTranGUID').AsString) <> '')) then begin
               Line := Line + '<cell>' + 'X' + '</cell>';
            end;
            if IncludeCVVResp then Line := Line + '<cell>' + Trim(RNQuery.FieldByName('CVVResp').AsString) + '</cell>'; //2018-3-14 ajs: F#3629
            if IncludeAVSResp then Line := Line + '<cell>' + Trim(RNQuery.FieldByName('AVSResp').AsString) + '</cell>'; //2018-3-14 ajs: F#3629
            if IncludeAVSData then Line := Line + '<cell>' + Trim(RNQuery.FieldByName('AVSData').AsString) + '</cell>';  // 2019-06-15 tjr: DVST-564
            If  Trim(RNQuery.FieldByName('TranEntryMode').AsString) = '90' then
                Line := Line + '<cell>' + 'S' + '</cell>'
            else
                Line := Line + '<cell>' + 'K' + '</cell>';

            Line := Line + '<cell>' + Trim(RNQuery.FieldByName('StationIdent').AsString) + '</cell>';


            If ShowLinks then begin
               Line := Line +  '<cell><![CDATA[<a href="javascript://" onclick="GetVTCardDetailAJAX(''' + RNID+ ''','''+ RNQuery.FieldByName('StoreSystemCode').AsString + ''')">' + RNQuery.FieldByName('StoreSystemCode').AsString+ '</a>]]></cell>';
            end else begin
               Line := Line + '<cell>' + RNQuery.FieldByName('StoreSystemCode').AsString + '</cell>';
            end;

            Line := Line + '</row>';

            Lines := Lines + Line;
         end;
         RNQuery.Next;
      end;



   end else begin
      Lines := '<?xml version="1.0" encoding="iso-8859-1"?><rows total_count="0" pos="0">';
   end;
   Lines := Lines + '</rows>';
   If DisplayFormat = 'XML' then begin
      Result := Lines;
      Response.CustomHeaders.Values['Cache-Control'] := 'private';
      Response.CustomHeaders.Values['Pragma'] := 'private';
   end else If DisplayFormat = 'XLS' then begin
      Result := CSV.Text;
      Response.CustomHeaders.Values['Cache-Control'] := 'private';
      Response.CustomHeaders.Values['Pragma'] := 'private';
   end;
   CSV.Free;
end;

function TCustomerInfoModule.ProcessPPSAPIXML(XMLRequest: String; XMLResponse: TStrings; Server: String; Timeout:integer): Boolean;
var
   HTTPTimeOutSeconds: Integer;
   WebsvcVersion: string;
   WebSvc: TWebServiceComm;
begin
   result := false;
   WebsvcVersion := VersionInfo.GetFileVersion(aFileVersionLong);

   ProcessLog(ltInfo, 'ProcessPPSAPIXML to:' , Server);
   if (pos('HTTP', Server) = 1) then begin
      WebSvc := TWebServiceComm.Create(ProcessLog);
      WebSvc.HTTP.UserAgent := 'PortalWebsvc/' + WebsvcVersion + '+CleverComponents/7.6+(Windows NT ' + WindowsVersion + ')+Web';
      
      HTTPTimeOutSeconds := Timeout;
      if (HTTPTimeOutSeconds = 0) then HTTPTimeOutSeconds := 60;
      if (HTTPTimeOutSeconds <> 0) then begin
         processlog(ltInfo, 'websvc request PPSAPI Timeout: ', StrI(HTTPTimeOutSeconds, -1));
         WebSvc.HTTP.TimeOut := HTTPTimeOutSeconds * 1000;
      end;
      WebSvc.HTTP.CertificateFlags := [cfIgnoreCommonNameInvalid, cfIgnoreDateInvalid, cfIgnoreUnknownAuthority, cfIgnoreRevocation, cfIgnoreWrongUsage];

      try
         XMLResponse.Text := WebSvc.Post(Server, XMLRequest);
         ProcessLog(ltInfo,'ProcessPPSAPIXML Request Complete, ' + Stri(XMLResponse.Count,-1) + ' Lines, Success=' + GetXMLTag(XMLResponse, 'TRANSUCCESS'),'Messagae='+GetXMLTag(XMLResponse, 'TRANRESPMESSAGE'));
         result := true;
      except
         on E:Exception do begin
           ProcessLog(ltWarning,'Exception ' + E.Message ,' Communicating with  ' + Server +' WebSvc.Post');
           Result := False;
         end;
      end;
      WebSvc.Free;
   end else begin
      if (not(ProcessIPXML(XMLRequest, XMLResponse,Server))) then begin
         XMLResponse.Clear;
         XMLResponse.Add('<TRANRESP>');
         XMLResponse.Add('   <TRANSUCCESS>FALSE</TRANSUCCESS>');
         XMLResponse.Add('   <TRANRESPMESSAGE>EXCEPTION PROCESSING REQUEST-TRY LATER</TRANRESPMESSAGE>');
         XMLResponse.Add('   <SERVERDATE>' + FormatDateTime('MM/DD/YYYY', NOW) + '</SERVERDATE>');
         XMLResponse.Add('   <SERVERTIME>' + FormatDateTime('HH:NN:SS', NOW) + '</SERVERTIME>');
         XMLResponse.Add('</TRANRESP>');
      end else begin
          result := true;
      end;
   end;
   ProcessLog(ltInfo, 'ProcessPPSAPIXML complete', '');
end;

function TCustomerInfoModule.DisplayStoreNameOnOpenCard(const defaultValue: String = 'FALSE'): boolean;
begin
   Result := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYSTORENAMEONOPENCARD', defaultValue));
end;

function TCustomerInfoModule.GetBatchToHTML(const UILinks: Boolean; const EmpIdentP : String): String; //2018-06-20 bls: F#2227
var
  IncludeAVSResp, IncludeAVSData, IncludeCardHolderName, IncludeCVVResp, IncludeEmpIdent, IncludeServiceName, IncludeServiceNameDesc, IncludeSFINDICATOR, SearchOnServiceName, ServiceNameSearchedOn, includeOtherCardType : boolean;   //2016-3-28 jtm
  CustIdentHeader, TranIdentHeader, StoreSystemCodeLabel, count, lastSystemCode, AVSDataHeader : string; //2016-8-22 jtm: Feat OT#1082
  ServiceNamesByRNID, rowsRemaining : integer; //2017-09-20 jtm: D#1946

  SaleVisaMC, SaleAMEX, SaleDISC, SaleOTHR : Integer;
  SaleQVisaMC, SaleQAMEX, SaleQDISC, SaleQOTHR : Integer;
  CreditVisaMC, CreditAMEX, CreditDISC, CreditOTHR : Integer;
  CreditQVisaMC, CreditQAMEX, CreditQDISC, CreditQOTHR : Integer;
  VoidVisaMC, VoidAMEX, VoidDISC, VoidOTHR : Integer;
  VoidQVisaMC, VoidQAMEX, VoidQDISC, VoidQOTHR : Integer;
  CRVoidVisaMC, CRVoidAMEX, CRVoidDISC, CRVoidOTHR : Integer;
  CRVoidQVisaMC, CRVoidQAMEX, CRVoidQDISC, CRVoidQOTHR : Integer;

  FBatchDetailDM : TBatchDetailDM;
  FCCBatchXML : TOpenXML;
  CCResults : TDataSet;
  BatchHTML, FieldNames, ServNameList, ServNameDescList : TStringList; //2017-09-20 jtm: D#1946

  rnidField, scField, saleTypeField, amtField, aCodeField, dateField, entryModeField, nonAuthField, cardTypeField, cardAcctField, pTField, tranIdentField,
      custCodeField, empIdentField, servNameField, cNameField, sFField, cvvField, avsField, zipField, stationIdentField : TField;

  includeStoreName: boolean;
  StoreName, LocationRNID: string;

  Procedure AddAmt(Var VisaMCInt : integer; Var AmexInt : integer; Var DiscInt : integer; Var OthrInt : integer;
                    Var VisaMCQInt : integer; Var AmexQInt : integer; Var DiscQInt : integer; Var OthrQInt : integer);
  var
      WI : Integer;
      amtStr : string;
  Begin
     amtStr := amtField.AsString; //2018-10-10 bls DVST-2707
     WI := 0;
     if((amtStr <> '') AND (ValidCharsOnly(amtStr, false, true, '.') = amtStr)) then begin
        WI := Round(amtField.AsCurrency * 100);
     end;

     If (Trim(cardTypeField.AsString) = 'VISA') or (Trim(cardTypeField.AsString) = 'MC') then begin
        VisaMCInt := VISAMCInt + WI;
        Inc(VisaMCQInt);
     end else If (Trim(cardTypeField.AsString) = 'AMEX') then begin
        AmexInt := AmexInt + WI;
        Inc(AmexQInt);
     end else If (Trim(cardTypeField.AsString) = 'DISC') then begin
        DiscInt := DiscInt + WI;
        Inc(DiscQInt);
     end else if includeOtherCardType then begin
        OthrInt := OthrInt + WI;
        Inc(OthrQInt);
     end;
  end;

  Procedure CreateHTMLHeader;
  var
      BatchHTMLHeader : string;
  begin
      BatchHTML := TStringList.Create;
      BatchHTMLHeader := '<TABLE border="1" cellspacing="0" cellpadding="3"  style="border-collapse: collapse; font-size:7pt;font-family:veranda">' +
                    '<TR><TD><B>RNID</B></TD>';

      if IncludeStoreName then BatchHTMLHeader := BatchHTMLHeader + '<TD><B>Location</B></TD>';

      BatchHTMLHeader := BatchHTMLHeader + '    <TD><B>Auth Date</B></TD>'+
                    '    <TD><B>Entry</B></TD>'+
                    '    <TD><B>Type</B></TD>'+
                    '    <TD Align="Right"><B>Amount</B></TD>'+
                    '    <TD colspan=2><B>Auth Code</B></TD>'+
                    '    <TD><B>Type</B></TD>'+
                    '    <TD><B>Card Acct</B></TD>'+
                    '    <TD><B>' + TranIdentHeader + '</B></TD>'+
                    '    <TD><B>' + CustIdentHeader + '</B></TD>';

       if IncludeEmpIdent then BatchHTMLHeader := BatchHTMLHeader + '    <TD><B>Emp Ident</B></TD>';
       if IncludeServiceName then BatchHTMLHeader := BatchHTMLHeader + '    <TD><B>Service Name</B></TD>';
       if IncludeCardHolderName then BatchHTMLHeader := BatchHTMLHeader + '    <TD><B>Card Name</B></TD>';
       if IncludeSFINDICATOR then BatchHTMLHeader := BatchHTMLHeader + '    <TD><B>SF</B></TD>';
       if IncludeCVVResp then BatchHTMLHeader := BatchHTMLHeader + '    <TD><B>CVVRESP</B></TD>'; //2018-3-14 ajs: F#3629
       if IncludeAVSResp then BatchHTMLHeader := BatchHTMLHeader + '    <TD><B>AVSRESP</B></TD>'; //2018-3-14 ajs: F#3629
       if IncludeAVSData then BatchHTMLHeader := BatchHTMLHeader + '    <TD><B>' + AVSDataHeader + '</B></TD>';   // 2019-06-15 tjr: DVST-564

       BatchHTMLHeader := BatchHTMLHeader + '    <TD><B>Station</B></TD>';
       if StoreSystemCodeLabel <> '' then BatchHTMLHeader := BatchHTMLHeader +  '  <TD><B>'+ StoreSystemCodeLabel +'</B></TD>'
       else BatchHTMLHeader := BatchHTMLHeader + '  <TD><B>Item Serial</B></TD>';

      BatchHTMLHeader := BatchHTMLHeader + '</TR>';
      BatchHTML.Add(BatchHTMLHeader);
  end;

  Procedure FormatHTML;
  var
      I, Index: Integer;
      Line, BRNID, BSC, MaskAcct, CardAcct, ProcessorToken: string;
  begin
      CCResults.DisableControls;

      rnidField := CCResults.FieldByName('PROFILE');
      servNameField := CCResults.FieldByName('CCSERVICENAME');
      scField := CCResults.FieldByName('SYSTEMCODE');
      dateField := CCResults.FieldByName('TRANDATE');
      entryModeField := CCResults.FieldByName('TRANENTRYMODE');
      saleTypeField := CCResults.FieldByName('SALETYPE');
      amtField := CCResults.FieldByName('TRANAMT');
      aCodeField := CCResults.FieldByName('AUTHCODE');
      nonAuthField := CCResults.FieldByName('NONAUTHRESP');
      cardTypeField := CCResults.FieldByName('CARDTYPE');
      cardAcctField := CCResults.FieldByName('CARDACCT');
      pTField := CCResults.FieldByName('PROCESSORTOKEN');
      tranIdentField := CCResults.FieldByName('TRANIDENT');
      custCodeField := CCResults.FieldByName('TRANCUSTOMERCODE');
      if IncludeEmpIdent then empIdentField := CCResults.FieldByName('TRANEMPLOYEEIDENT');
      if IncludeServiceName then servNameField := CCResults.FieldByName('CCSERVICENAME');
      if IncludeCardHolderName then cNameField := CCResults.FieldByName('CARDNAME');
      if IncludeSFINDICATOR then sFField := CCResults.FieldByName('SFTRANGUID');
      if IncludeCVVResp then cvvField := CCResults.FieldByName('CVVRESP');
      if IncludeAVSResp then avsField := CCResults.FieldByName('AVSRESP');
      if IncludeAVSData then zipField := CCResults.FieldByName('AVSDATA'); // 2019-06-15 tjr: DVST-564
      stationIdentField := CCResults.FieldByName('STATIONIDENT');

      I := 0;
      Index := 0;
      While NOT CCResults.EOF do begin
         Line := '';
         BRNID := rnidField.AsString;

         if (SearchOnServiceName) then begin
            ServiceNameSearchedOn := (servNameField.AsString = VarEvaluator.GetValueAsString('ServiceName'));
         end;
         if (IncludeServiceName) or (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHONSERVICENAME', 'FALSE') = 'TRUE') then begin  //2018-01-29 jtm: D#3693
            ServiceNamesByRNID := GetServiceNamesByRNID(BRNID,'',ServNameList,ServNameDescList);
         end;

         BSC := scField.AsString;
         Line := Line + '<TR><TD>' + BRNID + '</TD>';
         if IncludeStoreName then Line := Line + '<TD>' + StoreName + '</TD>';

         Line := Line + '<TD>' + dateField.AsString + '</TD>' +
                     '<TD>' + GetCCTranEntryModeDisplayCode(entryModeField.AsString) + '</TD>' +
                     '<TD>' + saleTypeField.AsString + '</TD>';

         if (saleTypeField.AsString = 'CREDIT') or (saleTypeField.AsString = 'REFUND') then begin   //2017-11-16 jtm: D#2021
            Line := Line + '<TD>(' + Format('%m',[ValuReal(amtField.AsString)]) + ')</TD>';
            if SearchOnServiceName then begin
               if ServiceNameSearchedOn then begin
                  AddAmt(CreditVisaMC, CreditAMEX, CreditDisc,CreditOthr,CreditQVisaMC, CreditQAMEX, CreditQDisc,CreditQOthr); //2018-01-25 ajs: F#2414
               end;
            end else begin
               AddAmt(CreditVisaMC, CreditAMEX, CreditDisc,CreditOthr,CreditQVisaMC, CreditQAMEX, CreditQDisc,CreditQOthr);
            end;
         end else if (saleTypeField.AsString = 'CRVOID' ) then begin
            Line := Line + '<TD><DEL>(' + Format('%m',[ValuReal(amtField.AsString)]) + ')</DEL></TD>';
            if SearchOnServiceName then begin
               if ServiceNameSearchedOn then begin
                  AddAmt(CRVoidVisaMC, CRVoidAMEX, CRVoidDisc,CRVoidOthr,CRVoidQVisaMC, CRVoidQAMEX, CRVoidQDisc, CRVoidQOthr); //2018-01-25 ajs: F#2414
               end;
            end else begin
               AddAmt(CRVoidVisaMC, CRVoidAMEX, CRVoidDisc,CRVoidOthr,CRVoidQVisaMC, CRVoidQAMEX, CRVoidQDisc, CRVoidQOthr); //2018-01-25 ajs: F#2414
            end;
         end else if (saleTypeField.AsString = 'VOID' ) then begin
            Line := Line + '<TD><DEL>' + Format('%m',[ValuReal(amtField.AsString)]) + '</DEL></TD>';
            if SearchOnServiceName then begin
               if ServiceNameSearchedOn then begin
                  AddAmt(VoidVisaMC, VoidAMEX, VoidDisc,VoidOthr,VoidQVisaMC, VoidQAMEX, VoidQDisc, VoidQOthr); //2018-01-25 ajs: F#2414
               end;
            end else begin
               AddAmt(VoidVisaMC, VoidAMEX, VoidDisc,VoidOthr,VoidQVisaMC, VoidQAMEX, VoidQDisc, VoidQOthr); //2018-01-25 ajs: F#2414
            end;
         end else begin
            Line := Line + '<TD>' + Format('%m',[ValuReal(amtField.AsString)]) + '</TD>';
            if (Trim(aCodeField.AsString) <> '') then begin //2018-01-25 ajs: F#2414
               if SearchOnServiceName then begin
                  if ServiceNameSearchedOn then begin
                     AddAmt(SaleVisaMC, SaleAMEX, SaleDisc,SaleOthr,SaleQVisaMC, SaleQAMEX, SaleQDisc,SaleQOthr);
                  end;
               end else begin
                  AddAmt(SaleVisaMC, SaleAMEX, SaleDisc,SaleOthr,SaleQVisaMC, SaleQAMEX, SaleQDisc,SaleQOthr);
               end;
            end;
         end;
         If (saleTypeField.AsString = 'CREDIT') or (saleTypeField.AsString = 'REFUND') then begin //2017-11-16 jtm: D#2021
            Line := Line + '    <TD><IMG SRC="/Images/General/CashSmall.gif" border="0"></TD>';
            If (CCResults.FieldByName('SALETYPE').AsString = 'CREDIT') then begin
               Line := Line + '    <TD align="Right"></TD>';
            end else begin
               Line := Line + '    <TD align="Right">' + aCodeField.AsString + '</TD>';
            end;
         end else If (saleTypeField.AsString = 'VOID') or (saleTypeField.AsString = 'CRVOID') then begin
            Line := Line + '    <TD><IMG SRC="/Images/General/YellowExclamation.gif" border="0"></TD>' +
                           '    <TD align="Right">' + aCodeField.AsString + '</TD>';
         end else If aCodeField.AsString <> '' then begin
            Line := Line + '    <TD><IMG SRC="/Images/General/CheckSuccess.gif" border="0"></TD>' +
                           '    <TD align="Right"><font color="GREEN">' + aCodeField.AsString + '</FONT></TD>';
         end else begin
            Line := Line + '    <TD><IMG SRC="/Images/General/XFailed.gif" border="0"></TD>' +
                           '    <TD align="Right"><font color="Red">' + nonAuthField.AsString + '</FONT></TD>';
         end;

         Line := Line + '<TD>' + cardTypeField.AsString + '</TD>';

         CardAcct := cardAcctField.AsString;
         ProcessorToken := pTField.AsString;
         MaskAcct := '';
         if (CardAcct <> '') then begin  //2017-12-20 jtm: F#2430
            if (ProcessorToken <> '') then begin  //card number sent in, but either tokenized or not
               MaskAcct := MaskStr(ProcessorToken,DigitsToMask(ProcessorToken));
               MaskAcct := '*..*' + NumericOnly(MaskAcct);
            end else begin
               MaskAcct := CardAcct;
               MaskAcct := 'X..X' + NumericOnly(MaskAcct);
            end;
         end else if (CardAcct = '')  and (ProcessorToken <> '') then begin //token passed directly
            MaskAcct := MaskStr(ProcessorToken,DigitsToMask(ProcessorToken));
            MaskAcct := '#..#' + NumericOnly(MaskAcct);
         end;
         Line := Line +  '<TD>' + MaskAcct + '</TD>';

         Line := Line +  '<TD>' + tranIdentField.AsString + '</TD>' +
                     '<TD>' + custCodeField.AsString + '</TD>';
         if IncludeEmpIdent then Line := Line + '<TD>' + empIdentField.AsString + '</TD>';
         if IncludeServiceName then begin //2018-01-25 ajs: F#2378
            if IncludeServiceNameDesc then begin
               Index := ServNameList.IndexOf(servNameField.AsString);
               if (Index = -1) then begin
                  Line := Line + '<TD>' + servNameField.AsString + '</TD>';
               end else begin
                  Line := Line + '<TD>' + ServNameDescList[Index] + '</TD>';
               end;
            end else begin
               Line := Line + '<TD>' + servNameField.AsString + '</TD>';
            end;
         end;
         if IncludeCardHolderName then Line := Line + '<TD>' + cNameField.AsString + '</TD>';
         if IncludeSFINDICATOR then begin
            if (sFField.AsString <> '') then begin
               Line := Line + '<TD>' + sFField.AsString + '</TD>';
            end else begin
               Line := Line + '<TD>' + ' ' + '</TD>';
            end;
         end;
         if IncludeCVVResp then Line := Line + '<TD>' + cvvField.AsString + '</TD>';  //2018-3-14 ajs: F#3629
         if IncludeAVSResp then Line := Line + '<TD>' + avsField.AsString + '</TD>';  //2018-3-14 ajs: F#3629
         if IncludeAVSData then Line := Line + '<TD>' + zipField.AsString + '</TD>'; // 2019-06-15 tjr: DVST-564

         Line := Line + '<TD>' + stationIdentField.AsString + '</TD>';
         If UILinks then begin
            Line := Line +  '<TD><a href="javascript://" onclick="GetVTCardDetailAJAX(''' + BRNID+ ''','''+ BSC + ''',true)">' + BSC+ '</a></TD>';
         end else begin
            Line := Line +  '<TD>' + BSC + '</TD>';
         end;

         Line := Line +  '</TR>';
         if SearchOnServiceName then begin   //2017-05-10 jtm: F#1565
            if (ServiceNameSearchedOn) then BatchHTML.Add(Line);
         end else if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHONSERVICENAME', 'FALSE') = 'TRUE') and (VarEvaluator.GetValueAsString('ServiceName') = 'ALL') then begin  //2017-09-20 jtm: D#1946
            if (ServiceNamesByRNID <> GetUserServNameAccessByRNID(ServNameList,BRNID,(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/NOREADONLYLOCATIONS','FALSE') = 'TRUE'),ServiceNamesByRNID)) then begin //2017-10-26 jtm: D#2042
               ProcessLog(ltInfo,'BatchXMLToHTML search on servicename:',CCResults.FieldByName('CCSERVICENAME').AsString);
               if (ServNameList.IndexOf(CCResults.FieldByName('CCSERVICENAME').AsString) >= 0) then begin
                  ProcessLog(ltInfo,'BatchXMLToHTML search on servicename index:',IntToStr(ServNameList.IndexOf(CCResults.FieldByName('CCSERVICENAME').AsString)));
                  BatchHTML.Add(Line);
               end
            end else begin
               BatchHTML.Add(Line);
            end;
         end else begin
            BatchHTML.Add(Line);
         end;
         inc(I);
         CCResults.Next;
      end;
      ProcessLog(ltInfo,'BatchXMLToHTML processed records:' + IntToStr(i),InstanceGUID);
  end;

  Procedure ProcessFooter;
  Begin
      processlog(ltInfo, 'BatchXMLToHTML ProcessFooter', 'Start');
      BatchHTML.Add('<BR><BR>' +
                  '<TABLE border="1" cellspacing="0" cellpadding="3" bordercolorlight="#0000FF" style="border-collapse: collapse">'+
                  '<TR><TD ALIGN=''CENTER''><B>TOTALS</B></TD>'+
                  '    <TD ALIGN=''CENTER'' colspan=2><B>VISA/MC</B></TD>'+
                  '    <TD ALIGN=''CENTER'' colspan=2><B>AMEX</B></TD>'+
                  '    <TD ALIGN=''CENTER'' colspan=2><B>DISC</B></TD>');
      if includeOtherCardType then begin
         BatchHTML.Add('    <TD ALIGN=''CENTER'' colspan=2><B>OTHER</B></TD>');
      end;
      BatchHTML.Add('    <TD ALIGN=''CENTER'' colspan=2><B>All Cards</B></TD>'+
                  '</TR>'+
                  '<TR><TD><B><IMG SRC="/Images/General/CheckSuccess.gif" border="0"> Sale</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[SaleQVisaMC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[SaleVisaMC/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[SaleQAMEX])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[SaleAMEX/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[SaleQDISC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[SaleDISC/100])+'</TD>');

      if includeOtherCardType then begin
         BatchHTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[SaleQOthr])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[SaleOthr/100])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%d',[SaleQVisaMC + SaleQAMEX+SaleQDISC+SaleQOthr])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[(SaleVisaMC + SaleAMEX +SaleDISC+SaleOthr)/100])+'</TD>');
      end else begin
         BatchHTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[SaleQVisaMC + SaleQAMEX+SaleQDISC])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[(SaleVisaMC + SaleAMEX +SaleDISC)/100])+'</TD>');
      end;

      BatchHTML.Add('</TR>'+
                  '<TR><TD><B><IMG SRC="/Images/General/CashSmall.gif" border="0"> Credit</B></TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[CreditQVisaMC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[CreditVisaMC/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[CreditQAMEX])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[CreditAMEX/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[CreditQDISC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[CreditDISC/100])+'</TD>');
      if includeOtherCardType then begin
         BatchHTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[CreditQOthr])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[CreditOthr/100])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%d',[CreditQVisaMC + CreditQAMEX+CreditQDISC+CreditQOthr])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[(CreditVisaMC + CreditAMEX +CreditDISC+CreditOthr)/100])+'</TD>' +
               '</TR>'+
               '<TR><TD><B><IMG SRC="/Images/General/CashSmall.gif" border="0"> NET</B></TD>'+
               '    <TD colspan="8"></TD>'+ //spacer
               '    <TD align=''RIGHT''>'+ Format('%d',[SaleQVisaMC + SaleQAMEX+SaleQDISC +SaleQOthr+ CreditQVisaMC + CreditQAMEX+CreditQDISC+CreditQOthr])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[((SaleVisaMC + SaleAMEX +SaleDISC+SaleOthr) - (CreditVisaMC + CreditAMEX +CreditDISC+CreditOthr))/100])+'</TD>'+

               '</TR>');
      end else begin
         BatchHTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[CreditQVisaMC + CreditQAMEX+CreditQDISC])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[(CreditVisaMC + CreditAMEX +CreditDISC)/100])+'</TD>'+
               '</TR>'+
               '<TR><TD><B><IMG SRC="/Images/General/CashSmall.gif" border="0"> NET</B></TD>'+
               '    <TD colspan="6"></TD>'+ //spacer
               '    <TD align=''RIGHT''>'+ Format('%d',[SaleQVisaMC + SaleQAMEX+SaleQDISC + CreditQVisaMC + CreditQAMEX+CreditQDISC])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[((SaleVisaMC + SaleAMEX +SaleDISC) - (CreditVisaMC + CreditAMEX +CreditDISC))/100])+'</TD>'+
               '</TR>');
      end;
      BatchHTML.Add('<TR><TD><B><IMG SRC="/Images/General/YellowExclamation.gif" border="0"> Voids</B></TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[VoidQVisaMC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[VoidVisaMC/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[VoidQAMEX])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[VoidAMEX/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[VoidQDISC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[VoidDISC/100])+'</TD>');
      if includeOtherCardType then begin
         BatchHTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[VoidQOthr])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[VoidOthr/100])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%d',[VoidQVisaMC + VoidQAMEX+VoidQDISC+VoidQOthr])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[(VoidVisaMC + VoidAMEX +VoidDISC+VoidOthr)/100])+'</TD>');
      end else begin
         BatchHTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[VoidQVisaMC + VoidQAMEX+VoidQDISC])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[(VoidVisaMC + VoidAMEX +VoidDISC)/100])+'</TD>');
      end;
      if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDECREDITVOIDROW', 'FALSE')) then begin
         BatchHTML.Add('<TR><TD><B><IMG SRC="/Images/General/YellowExclamation.gif" border="0"> Credit Voids</B></TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[CRVoidQVisaMC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[CRVoidVisaMC/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[CRVoidQAMEX])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[CRVoidAMEX/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[CRVoidQDISC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[CRVoidDISC/100])+'</TD>');
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEOTHERCARDTYPE', 'FALSE') = 'TRUE') then begin
            BatchHTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[CRVoidQOthr])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[CRVoidOthr/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[CRVoidQVisaMC + CRVoidQAMEX+CRVoidQDISC+CRVoidQOthr])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[(CRVoidVisaMC + CRVoidAMEX +CRVoidDISC+CRVoidOthr)/100])+'</TD>');
         end else begin
            BatchHTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[CRVoidQVisaMC + CRVoidQAMEX+CRVoidQDISC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[(CRVoidVisaMC + CRVoidAMEX +CRVoidDISC)/100])+'</TD>');
         end;
      end;
      BatchHTML.Add('</TR></TABLE><BR>');
   end;

  Procedure CreateFieldNames;
  begin
      FieldNames.Add('PROFILE');
      FieldNames.Add('SYSTEMCODE');
      FieldNames.Add('TRANDATE');
      FieldNames.Add('TRANENTRYMODE');
      FieldNames.Add('SALETYPE');
      FieldNames.Add('TRANAMT');
      FieldNames.Add('AUTHCODE');
      FieldNames.Add('NONAUTHRESP');
      FieldNames.Add('CARDTYPE');
      FieldNames.Add('PROCESSORTOKEN');
      FieldNames.Add('CARDACCT');
      FieldNames.Add('TRANIDENT');
      FieldNames.Add('TRANCUSTOMERCODE');
      FieldNames.Add('STATIONIDENT');

      if IncludeEmpIdent then FieldNames.Add('TRANEMPLOYEEIDENT');
      if IncludeCardHolderName then FieldNames.Add('CARDNAME');
      if IncludeSFINDICATOR then FieldNames.Add('SFTRANGUID');
      if IncludeCVVResp then FieldNames.Add('CVVRESP');
      if IncludeAVSResp then FieldNames.Add('AVSRESP');
      if IncludeAVSData then FieldNames.Add('AVSDATA'); // 2019-06-15 tjr: DVST-564
  end;

Begin
   Result := '';
   ServNameList := TStringList.Create;
   ServNameDescList := TStringList.Create;
   ServiceNameSearchedOn := false; //2018-05-16 ajs: D#4493

   SaleVisaMC := 0;
   SaleAMEX := 0;
   SaleDISC := 0;
   SaleQVisaMC := 0;
   SaleQAMEX := 0;
   SaleQDISC := 0;
   SaleOTHR := 0;
   SaleQOTHR := 0;

   CreditVisaMC  := 0;
   CreditAMEX := 0;
   CreditDISC := 0;
   CreditQVisaMC := 0;
   CreditQAMEX := 0;
   CreditQDISC := 0;
   CreditOTHR := 0;
   CreditQOTHR := 0;

   VoidVisaMC := 0;
   VoidAMEX := 0;
   VoidDISC := 0;
   VoidQVisaMC := 0;
   VoidQAMEX := 0;
   VoidQDISC := 0;
   VoidOTHR := 0;
   VoidQOTHR := 0;

   CRVoidVisaMC := 0;
   CRVoidAMEX := 0;
   CRVoidDISC := 0;
   CRVoidQVisaMC := 0;
   CRVoidQAMEX := 0;
   CRVoidQDISC := 0;
   CRVoidOTHR := 0;
   CRVoidQOTHR := 0;

   TranIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CCTRANIDENTDESC', 'Tran Ident')); //2018-4-24 bls: F#3735
   CustIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CCCUSTIDENTDESC', 'Cust Ident')); //2018-4-24 bls: F#3735
   StoreSystemCodeLabel := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL', ''));

   includeOtherCardType := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEOTHERCARDTYPE', 'FALSE'));
   IncludeEmpIdent := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEEMPIDENT', 'FALSE'));
   IncludeServiceName := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESERVICENAME', 'FALSE'));
   IncludeCardHolderName := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDECARDHOLDERNAME', 'FALSE'));
   IncludeSFINDICATOR := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESFINDICATOR', 'FALSE'));
   IncludeCVVResp := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDECVVRESP', 'FALSE'));
   IncludeAVSResp := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEAVSRESP', 'FALSE'));
   IncludeAVSData := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEAVSDATA', 'FALSE')); // 2019-06-15 tjr: DVST-564
   AVSDataHeader := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/AVSDATAHEADER', 'AVSDATA'); // 2019-06-15 tjr: DVST-564
   IncludeServiceNameDesc := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESERVICENAMEDESCRIPTION', 'FALSE'));
   IncludeStoreName := DisplayStoreNameOnOpenCard;

   LocationRNID := NumericOnly(Request.QueryFields.Values['LOCATIONRNID']);

   if IncludeStoreName then begin
      StoreName := FetchStoreName(LocationRNID);
   end;

   SearchOnServiceName := (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHONSERVICENAME', 'FALSE') = 'TRUE') and (VarEvaluator.GetValueAsString('ServiceName') <> 'ALL');

   lastSystemCode := '';
   rowsRemaining := 0;
   count := '';
   if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ALLOWCHUNKING', 'TRUE')) then begin  // We allow chunking by default for performance reasons
      count := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ROWSFETCHEDPERCHUNKCARD', '500');
   end;

   FieldNames := TStringList.Create();
   CreateFieldNames;
   CreateHTMLHeader;

   FBatchDetailDM := TBatchDetailDM.Create(ProcessLog, ProcessPPSAPIXML);
   FCCBatchXML := FBatchDetailDM.GetCCBatch(LocationRNID, '', TRUE, count, lastSystemCode, EmpIdentP, FieldNames);

   If (FCCBatchXML <> NIL) AND (FCCBatchXML.GetNode('/TRANRESP/CCBATCHDETAIL/CCAUTHDETAIL') <> NIL) then begin
      if count <> '' then begin
         rowsRemaining := FCCBatchXML.GetValueAsInteger('/TRANRESP/PENDINGRECORDCOUNT'); // Get the amount of records that are left in the gateway
         lastSystemCode := FCCBatchXML.GetValueAsWideString('/TRANRESP/LASTSYSTEMCODE'); // Get the last system code of a set of records to know where to start the next chunk
      end;

      FBatchDetailDM.BatchXMLToACRTable(FCCBatchXML.DocumentAsString,'CCBATCHDETAIL'); // Load the Response into a queryable table

      while (rowsRemaining > 0) AND (count <> '') do begin // Round up the rest of the data
         FCCBatchXML := FBatchDetailDM.GetCCBatch(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),'', true, count, lastSystemCode, EmpIdentP, FieldNames);

         if FCCBatchXML <> NIL then begin
            FBatchDetailDM.AddDataToTable(FCCBatchXML.DocumentAsString);
            rowsRemaining := FCCBatchXML.GetValueAsInteger('/TRANRESP/PENDINGRECORDCOUNT'); // update rowsRemaining
            lastSystemCode := FCCBatchXML.GetValueAsWideString('/TRANRESP/LASTSYSTEMCODE'); // update lastsystemcode
         end;
      end;

      CCResults := FBatchDetailDM.BatchDS; // Turn that table into a dataset

      if (CCResults.RecordCount > 0) then begin
         FormatHTML;
      end;
   end;
      BatchHTML.Append('</TABLE>');

   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ENABLECARDBATCHSUMMARY', 'FALSE') = 'TRUE') then begin
      ProcessFooter;
   end;

   Result := BatchHTML.Text;

   BatchHTML.Free;
   ServNameList.Free;
   ServNameDescList.Free;
   if assigned(CCResults) then CCResults.Free;
   if assigned(FCCBatchXML) then FCCBatchXML.Free;
   if assigned(FBatchDetailDM) then FBatchDetailDM.Free;
   if assigned(FieldNames) then FieldNames.Free;
end;


function TCustomerInfoModule.GetBatchToGRID(const UILinks: Boolean; const EmpIdentP : String): String; //2018-06-20 bls: F#840 //2018-07-18 bls: F#4978
var
  IncludeEmpIdent : boolean;   //2016-3-28 jtm
  IncludeServiceName : boolean;  //2016-5-25 jtm
  IncludeCardHolderName : boolean;
  IncludeSFINDICATOR : boolean;
  IncludeCVVResp : boolean; //2018-3-14 ajs: F#3629
  IncludeAVSResp : boolean; //2018-3-14 ajs: F#3629
  IncludeAVSData : boolean; // 2019-06-15 tjr: DVST-564
  AVSDataHeader : string; // 2019-06-15 tjr: DVST-564
  ServNameList : TStringList; //2017-09-20 jtm: D#1946
  ServNameDescList : TStringList;
  StoreSystemCodeLabel : string; //2016-8-22 jtm: Feat OT#1082
  IncludeServiceNameDesc : boolean; //2018-01-25 ajs: F#2378

  TranIdentHeader : string;
  CustIdentHeader : string;

  FBatchDetailDM : TBatchDetailDM;
  FCCBatchXML : TOpenXML;
  count, lastSystemCode, totalCount : string;
  GRID : TStringList;
  CCResults : TDataSet;
  rowsRemaining : integer;
  FieldNames : TStringList;
  useJSONResp : boolean;
  IncludeStoreName: boolean;
  StoreName, LocationRNID: string;

  Procedure CreateFieldNames;
  begin
      FieldNames.Add('PROFILE');
      FieldNames.Add('SYSTEMCODE');
      FieldNames.Add('TRANDATE');
      FieldNames.Add('TRANENTRYMODE');
      FieldNames.Add('SALETYPE');
      FieldNames.Add('TRANAMT');
      FieldNames.Add('AUTHCODE');
      FieldNames.Add('NONAUTHRESP');
      FieldNames.Add('CARDTYPE');
      FieldNames.Add('PROCESSORTOKEN');
      FieldNames.Add('CARDACCT');
      FieldNames.Add('TRANIDENT');
      FieldNames.Add('TRANCUSTOMERCODE');
      FieldNames.Add('STATIONIDENT');

      if IncludeEmpIdent then FieldNames.Add('TRANEMPLOYEEIDENT');
      if IncludeCardHolderName then FieldNames.Add('CARDNAME');
      if IncludeSFINDICATOR then FieldNames.Add('SFTRANGUID');
      if IncludeCVVResp then FieldNames.Add('CVVRESP');
      if IncludeAVSResp then FieldNames.Add('AVSRESP');
      if IncludeAVSData then FieldNames.Add('AVSDATA');  // 2019-06-15 tjr: DVST-564
  end;

  Procedure FormatGrid;
  var
      saleType, amount, authCode, serviceName, sf : string;
      MaskAcct, BRNID, BSC, CardAcct, ProcessorToken : string;  //2017-03-22 jtm: Feat OT#1289
      Index : Integer; //2018-01-25 ajs: F#2378
  begin
      GRID := TStringList.Create();
      totalCount := inttostr(CCResults.RecordCount);

      GRID.Append('<?xml version="1.0" encoding="UTF-8"?><rows total_count=''' + totalCount + ''' pos=''0''>');

      while NOT CCResults.EOF do begin // Load all of that data into the GRID stringlist (in xml format)
         GRID.Append('<row>');

         BRNID := Trim(CCResults.FieldByName('PROFILE').AsString);
         BSC := Trim(CCResults.FieldByName('SYSTEMCODE').AsString);
         saleType := Trim(CCResults.FieldByName('SALETYPE').AsString);
         amount := Format('%m', [ValuReal(Trim(CCResults.FieldByName('TRANAMT').AsString))]);
         authCode := Trim(CCResults.FieldByName('AUTHCODE').AsString);

         GRID.Append('<cell>' + BRNID + '</cell>');
         if IncludeStoreName then begin
            GRID.Add('"' + StoreName + '",');
         end;
         GRID.Append('<cell>' + Trim(CCResults.FieldByName('TRANDATE').AsString) + '</cell>');
         GRID.Append('<cell>' + GetCCTranEntryModeDisplayCode(CCResults.FieldByName('TRANENTRYMODE').AsString) + '</cell>');
         GRID.Append('<cell>' + saleType + '</cell>');

         if (saleType = 'CREDIT') OR (saleType = 'REFUND') then begin
            GRID.Append('<cell>(' + amount + ')</cell>');
            GRID.Append('<cell><![CDATA[<IMG SRC="/Images/General/CashSmall.gif" border="0" style="display: inline-block" />');
            if (saleType = 'CREDIT') then begin
               GRID.Append(']]></cell>');
            end else begin
               GRID.Append(']]>' + authCode + '</cell>');
            end;
         end else if (saleType = 'CRVOID') then begin //2019-06-12 jtm: DVST-2864
            GRID.Append('<cell><![CDATA[<DEL>(' + amount + ')</DEL>]]></cell>');
            GRID.Append('<cell><![CDATA[<IMG SRC="/Images/General/YellowExclamation.gif" border="0" style="display: inline-block" />');
            GRID.Append(']]>' + authCode + '</cell>');
         end else if (saleType = 'VOID') then begin
            GRID.Append('<cell><![CDATA[<DEL>' + amount + '</DEL>]]></cell>');
            GRID.Append('<cell><![CDATA[<IMG SRC="/Images/General/YellowExclamation.gif" border="0" style="display: inline-block" />');
            GRID.Append(']]>' + authCode + '</cell>');
         end else begin
            GRID.Append('<cell>' + amount + '</cell>');
            if (authCode <> '') then begin
               GRID.Append('<cell><![CDATA[<IMG SRC="/Images/General/CheckSuccess.gif" border="0" style="display: inline-block" />');
               GRID.Append('<font color="GREEN">' + authCode + '</font>]]></cell>');
            end else begin
               GRID.Append('<cell><![CDATA[<IMG SRC="/Images/General/XFailed.gif" border="0" style="display: inline-block" />');
               GRID.Append('<font color="Red">' + Trim(CCResults.FieldByName('NONAUTHRESP').AsString) + '</FONT>]]></cell>');
            end;
         end;

         GRID.Append('<cell>' + Trim(CCResults.FieldByName('CARDTYPE').AsString) + '</cell>');

         CardAcct := Trim(CCResults.FieldByName('CARDACCT').AsString);
         ProcessorToken := Trim(CCResults.FieldByName('PROCESSORTOKEN').AsString);
         MaskAcct := '';
         if (CardAcct <> '') then begin  //2017-12-20 jtm: F#2430
            if (ProcessorToken <> '') then begin  //card number sent in, but either tokenized or not
               MaskAcct := MaskStr(ProcessorToken,DigitsToMask(ProcessorToken));
               MaskAcct := '*..*' + NumericOnly(MaskAcct);
            end else begin
               MaskAcct := CardAcct;
               MaskAcct := 'X..X' + NumericOnly(MaskAcct);
            end;
         end else if (CardAcct = '') AND (ProcessorToken <> '') then begin //token passed directly
            MaskAcct := MaskStr(ProcessorToken,DigitsToMask(ProcessorToken));
            MaskAcct := '#..#' + NumericOnly(MaskAcct);
         end;
         GRID.Append('<cell>' + MaskAcct + '</cell>');

         GRID.Append('<cell>' + Trim(CCResults.FieldByName('TRANIDENT').AsString) + '</cell>');
         GRID.Append('<cell>' + Trim(CCResults.FieldByName('TRANCUSTOMERCODE').AsString) + '</cell>');

         if IncludeEmpIdent then GRID.Append('<cell>' + Trim(CCResults.FieldByName('TRANEMPLOYEEIDENT').AsString) + '</cell>');

         if IncludeServiceName then begin //2018-01-25 ajs: F#2378
            serviceName := Trim(CCResults.FieldByName('CCSERVICENAME').AsString);
            if IncludeServiceNameDesc then begin
               Index := ServNameList.IndexOf(serviceName);
               if (Index = -1) then begin
                  GRID.Append('<cell>' + serviceName + '</cell>');
               end else begin
                  GRID.Append('<cell>' + ServNameDescList[Index] + '</cell>');
               end;
            end else begin
               GRID.Append('<cell>' + serviceName + '</cell>');
            end;
         end;

         if IncludeCardHolderName then GRID.Append('<cell>' + Trim(CCResults.FieldByName('CARDNAME').AsString) + '</cell>');

         if IncludeSFINDICATOR then begin
            sf := Trim(CCResults.FieldByName('SFTRANGUID').AsString);
            if (sf <> '') then begin
               GRID.Append('<cell>' + sf + '</cell>');
            end else begin
               GRID.Append('<cell>' + ' ' + '</cell>');
            end;
         end;

         if IncludeCVVResp then GRID.Append('<cell>' + Trim(CCResults.FieldByName('CVVRESP').AsString) + '</cell>');  //2018-3-14 ajs: F#3629
         if IncludeAVSResp then GRID.Append('<cell>' + Trim(CCResults.FieldByName('AVSRESP').AsString) + '</cell>');  //2018-3-14 ajs: F#3629
         if IncludeAVSData then GRID.Append('<cell>' + Trim(CCResults.FieldByName('AVSData').AsString) + '</cell>'); // 2019-06-15 tjr: DVST-564

         GRID.Append('<cell>' + Trim(CCResults.FieldByName('STATIONIDENT').AsString) + '</cell>');
         If UILinks then begin
            GRID.Append('<cell><![CDATA[<a href="javascript://" onclick="GetVTCardDetailAJAX(''' + BRNID + ''','''+ BSC + ''',true)">' + BSC + '</a>]]></cell>');
         end else begin
            GRID.Append('<cell>' + BSC + '</cell>');
         end;

         GRID.Append('</row>');
         CCResults.Next;
            end;
      GRID.Append('</rows>');
         end;

  Procedure FormatGridJSON;
  var
      saleType, amount, authCode, serviceName, sf : string;
      MaskAcct, BRNID, BSC, CardAcct, ProcessorToken : string; 
      i, Index : integer;

      rnidField, scField, saleTypeField, amtField, aCodeField, dateField, entryModeField, nonAuthField, cardTypeField, cardAcctField, pTField, tranIdentField,
      custCodeField, empIdentField, servNameField, cNameField, sFField, cvvField, avsField, zipField, stationIdentField : TField;
  begin
      CCResults.DisableControls;

      totalCount := inttostr(CCResults.RecordCount);
      rnidField := CCResults.FindField('PROFILE');
      scField := CCResults.FindField('SYSTEMCODE');
      saleTypeField := CCResults.FindField('SALETYPE');
      amtField := CCResults.FindField('TRANAMT');
      aCodeField := CCResults.FindField('AUTHCODE');
      dateField := CCResults.FindField('TRANDATE');
      entryModeField := CCResults.FindField('TRANENTRYMODE');
      nonAuthField := CCResults.FindField('NONAUTHRESP');
      cardTypeField := CCResults.FindField('CARDTYPE');
      cardAcctField := CCResults.FindField('CARDACCT');
      pTField := CCResults.FindField('PROCESSORTOKEN');
      tranIdentField := CCResults.FindField('TRANIDENT');
      custCodeField := CCResults.FindField('TRANCUSTOMERCODE');

      if IncludeEmpIdent then empIdentField := CCResults.FindField('TRANEMPLOYEEIDENT');
      if IncludeServiceName then servNameField := CCResults.FindField('CCSERVICENAME');
      if IncludeCardHolderName then cNameField := CCResults.FindField('CARDNAME');
      if IncludeSFINDICATOR then sFField := CCResults.FindField('SFTRANGUID');
      if IncludeCVVResp then cvvField := CCResults.FindField('CVVRESP');
      if IncludeAVSResp then avsField := CCResults.FindField('AVSRESP');
      if IncludeAVSData then zipField := CCResults.FindField('AVSDATA'); // 2019-06-15 tjr: DVST-564
      stationIdentField := CCResults.FindField('STATIONIDENT');

      GRID := TStringList.Create();
      GRID.BeginUpdate;
      GRID.Add('{"total_count":' + totalCount + ',"pos":0,"rows":[');
      
      i := 0;
      while NOT CCResults.EOF do begin // Load all of that data into the GRID stringlist (in xml format)
         inc(i);
         GRID.Add('{"id":' + inttostr(i) + ',"data":[');

         BRNID := rnidField.AsString;
         BSC := scField.AsString;
         saleType := saleTypeField.AsString;
         amount := Format('%m', [ValuReal(amtField.AsString)]);
         authCode := aCodeField.AsString;

         GRID.Add('"' + BRNID + '",');

         if IncludeStoreName then begin
            GRID.Add('"' + StoreName + '",');
         end;

         GRID.Add('"' + dateField.AsString + '",');
         GRID.Add('"' + GetCCTranEntryModeDisplayCode(entryModeField.AsString) + '",');
         GRID.Add('"' + saleType + '",');

         if (saleType = 'CREDIT') OR (saleType = 'REFUND') then begin
            GRID.Add('"(' + amount + ')",');
            GRID.Add('"<IMG SRC=\"\/Images\/General\/CashSmall.gif\" border=\"0\" style=\"display: inline-block\" \/>');
            if (saleType = 'CREDIT') then begin
               GRID.Add('",');
            end else begin
               GRID.Add(authCode + '",');
            end;
         end else if (saleType = 'CRVOID') then begin
            GRID.Add('"<DEL>(' + amount + ')<\/DEL>",');
            GRID.Add('"<IMG SRC=\"\/Images\/General\/YellowExclamation.gif\" border=\"0\" style=\"display: inline-block\" \/>');
            GRID.Add(authCode + '",');
         end else if (saleType = 'VOID') then begin
            GRID.Add('"<DEL>' + amount + '<\/DEL>",');
            GRID.Add('"<IMG SRC=\"\/Images\/General\/YellowExclamation.gif\" border=\"0\" style=\"display: inline-block\" \/>');
            GRID.Add(authCode + '",');
         end else begin
            GRID.Add('"' + amount + '",');
            if (authCode <> '') then begin
               GRID.Add('"<IMG SRC=\"\/Images\/General\/CheckSuccess.gif\" border=\"0\" style=\"display: inline-block\" \/>');
               GRID.Add('<font color=\"GREEN\">' + authCode + '<\/font>",');
            end else begin
               GRID.Add('"<IMG SRC=\"\/Images\/General\/XFailed.gif\" border=\"0\" style=\"display: inline-block\" \/>');
               GRID.Add('<font color=\"Red\">' + nonAuthField.AsString + '<\/FONT>",');
            end;
         end;

         GRID.Add('"' + cardTypeField.AsString + '",');

         CardAcct := cardAcctField.AsString;
         ProcessorToken := pTField.AsString;
         MaskAcct := '';
         if (CardAcct <> '') then begin  //2017-12-20 jtm: F#2430
            if (ProcessorToken <> '') then begin  //card number sent in, but either tokenized or not
               MaskAcct := MaskStr(ProcessorToken,DigitsToMask(ProcessorToken));
               MaskAcct := '*..*' + NumericOnly(MaskAcct);
            end else begin
               MaskAcct := CardAcct;
               MaskAcct := 'X..X' + NumericOnly(MaskAcct);
            end;
         end else if (ProcessorToken <> '') then begin //token passed directly
            MaskAcct := MaskStr(ProcessorToken,DigitsToMask(ProcessorToken));
            MaskAcct := '#..#' + NumericOnly(MaskAcct);
         end;
         GRID.Add('"' + MaskAcct + '",');

         GRID.Add('"' + tranIdentField.AsString + '",');
         GRID.Add('"' + custCodeField.AsString + '",');

         if IncludeEmpIdent then GRID.Add('"' + empIdentField.AsString + '",');

         if IncludeServiceName then begin //2018-01-25 ajs: F#2378
            serviceName := servNameField.AsString;
            if IncludeServiceNameDesc then begin
               Index := ServNameList.IndexOf(serviceName);
               if (Index = -1) then begin
                  GRID.Add('"' + serviceName + '",');
               end else begin
                  GRID.Add('"' + ServNameDescList[Index] + '",');
               end;
            end else begin
               GRID.Add('"' + serviceName + '",');
            end;
         end;

         if IncludeCardHolderName then GRID.Add('"' + cNameField.AsString + '",');

         if IncludeSFINDICATOR then begin
            sf := sFField.AsString;
            if (sf <> '') then begin
               GRID.Add('"' + sf + '",');
            end else begin
               GRID.Add('"' + ' ' + '",');
            end;
         end;

         if IncludeCVVResp then GRID.Add('"' + cvvField.AsString + '",');  //2018-3-14 ajs: F#3629
         if IncludeAVSResp then GRID.Add('"' + avsField.AsString + '",');  //2018-3-14 ajs: F#3629
         if IncludeAVSData then GRID.Add('"' + zipField.AsString + '",'); // 2019-06-15 tjr: DVST-564

         GRID.Add('"' + stationIdentField.AsString + '",');
         If UILinks then begin
            GRID.Add('"<a href=\"javascript:\/\/\" onclick=\"GetVTCardDetailAJAX(''' + BRNID + ''','''+ BSC + ''',true)\">' + BSC + '<\/a>"]}');
         end else begin
            GRID.Add('"' + BSC + '"]}');
         end;
         CCResults.Next;

         if NOT CCResults.EOF then GRID.Add(',');
      end;
      GRID.Add(']}');
      GRID.EndUpdate;
  end;

Begin
   ServNameList := TStringList.Create;
   ServNameDescList := TStringList.Create;

   LocationRNID := NumericOnly(Request.queryfields.Values['LOCATIONRNID']);
   TranIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CCTRANIDENTDESC', 'Tran Ident')); //2018-4-24 bls: F#3735
   CustIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CCCUSTIDENTDESC', 'Cust Ident')); //2018-4-24 bls: F#3735
   StoreSystemCodeLabel := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL', ''));

   IncludeEmpIdent := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEEMPIDENT', 'FALSE'));
   IncludeServiceName := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESERVICENAME', 'FALSE'));
   IncludeCardHolderName := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDECARDHOLDERNAME', 'FALSE'));
   IncludeSFINDICATOR := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESFINDICATOR', 'FALSE'));
   IncludeCVVResp := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDECVVRESP', 'FALSE'));
   IncludeAVSResp := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEAVSRESP', 'FALSE'));
   IncludeAVSData := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEAVSDATA', 'FALSE')); // 2019-06-15 tjr: DVST-564
   AVSDataHeader := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/AVSDATAHEADER', 'AVSDATA'); // 2019-06-15 tjr: DVST-564
   IncludeServiceNameDesc := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESERVICENAMEDESCRIPTION', 'FALSE'));
   useJSONResp := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEJSONFORGRIDS','TRUE'));
   IncludeStoreName := DisplayStoreNameOnOpenCard;

   if IncludeStoreName then begin
      StoreName := FetchStoreName(LocationRNID);
   end;

   if useJSONResp then begin
      Result := '{"total_count":0,"pos":0,"rows":[]}';
   end else begin
      Result := '<?xml version="1.0" encoding="UTF-8"?><rows total_count=''0'' pos=''0''></rows>';
   end;

   rowsRemaining := 0;
   lastSystemCode := '';
   count := '';
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ALLOWCHUNKING', 'TRUE')='TRUE') then begin // We allow chunking by default for performance reasons
      count := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ROWSFETCHEDPERCHUNKCARD', '500'); // Around 500 records per chunk is optimal
   end;

   FBatchDetailDM := TBatchDetailDM.Create(ProcessLog, ProcessPPSAPIXML);

   FieldNames := TStringList.Create;
   CreateFieldNames;
   FCCBatchXML := FBatchDetailDM.GetCCBatch(LocationRNID, '', true, count, lastSystemCode, EmpIdentP, FieldNames);

   If (FCCBatchXML <> NIL) AND (FCCBatchXML.GetNode('/TRANRESP/CCBATCHDETAIL/CCAUTHDETAIL') <> NIL) then begin  // If there was a response
      if count <> '' then begin
         rowsRemaining := FCCBatchXML.GetValueAsInteger('/TRANRESP/PENDINGRECORDCOUNT'); // Get the amount of records that are left in the gateway
         lastSystemCode := FCCBatchXML.GetValueAsWideString('/TRANRESP/LASTSYSTEMCODE'); // Get the last system code of a set of records to know where to start the next chunk
      end;
      
      FBatchDetailDM.BatchXMLToACRTable(FCCBatchXML.DocumentAsString,'CCBATCHDETAIL'); // Load the Response into a queryable table

      while (rowsRemaining > 0) AND (count <> '') do begin // Round up the rest of the data
         FCCBatchXML := FBatchDetailDM.GetCCBatch(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),'', true, count, lastSystemCode, EmpIdentP, FieldNames);

         if FCCBatchXML <> NIL then begin
            FBatchDetailDM.AddDataToTable(FCCBatchXML.DocumentAsString);
            rowsRemaining := FCCBatchXML.GetValueAsInteger('/TRANRESP/PENDINGRECORDCOUNT'); // update rowsRemaining
            lastSystemCode := FCCBatchXML.GetValueAsWideString('/TRANRESP/LASTSYSTEMCODE'); // update lastsystemcode
         end;
      end;

      CCResults := FBatchDetailDM.BatchDS; // Turn that table into a dataset

      if (CCResults.RecordCount > 0) then begin // If we have records
         if useJSONResp then begin
            FormatGridJSON;
            Result := TextWithoutNewLine(GRID);
         end else begin
         FormatGrid;
         Result := GRID.Text;
         end;
      end;
   end;

   if assigned(GRID) then GRID.Free;
   if assigned(FCCBatchXML) then FCCBatchXML.Free;
   if assigned(CCResults) then CCResults.Free;
   if assigned(FBatchDetailDM) then FBatchDetailDM.Free;
   ServNameList.Free;
   ServNameDescList.Free;
end;

function TCustomerInfoModule.FetchStoreName(const ARNID: String): String;
var
   SanitizedRNID: String;
begin
   Result := '';

   SanitizedRNID := NumericOnly(ARNID);
   RNQuery.Close;
   RNQuery.SQL.Clear;
   RNQuery.ParamCheck := true;
   RNQuery.SQL.Add('Select systemcode, name from store where systemcode = :RNID');
   RNQuery.Parameters.ParamByName('RNID').Value := SanitizedRNID;
   RNQuery.Open;
   if RNQuery.RecordCount > 0 then begin
      Result := RNQuery.FieldByName('name').AsString;
   end;
end;

function TCustomerInfoModule.GetBatchToXLS(xExport : TOExport; const DisplayFormat, EmpIdentP : String): String; //2018-06-20 bls: F#2227
var
   IncludeAVSResp, IncludeAVSData, IncludeCardHolderName, IncludeCVVResp, IncludeEmpIdent, IncludeServiceName, IncludeServiceNameDesc, IncludeSFINDICATOR, SearchOnServiceName : boolean;
   CustIdentHeader, TranIdentHeader, StoreSystemCodeLabel, count, lastSystemCode, AVSDataHeader : string;
   rowsRemaining, ServiceNamesByRNID : integer;

   xlsWorkSheet : TExportWorksheet; //Represents actual xls worksheet
   Row : TExportRow; //Represents actual row inside the TExportWorksheet
   FBatchDetailDM : TBatchDetailDM;
   FCCBatchXML : TOpenXML;
   CCResults : TDataSet;
   FieldNames, JSON, ServNameList, ServNameDescList : TStringList;

   IncludeStoreName: boolean;
   StoreName, LocationRNID: string;

   Procedure CreateFieldNames;
   begin
      FieldNames.Add('PROFILE');
      FieldNames.Add('SYSTEMCODE');
      FieldNames.Add('TRANDATE');
      FieldNames.Add('TRANENTRYMODE');
      FieldNames.Add('SALETYPE');
      FieldNames.Add('TRANAMT');
      FieldNames.Add('AUTHCODE');
      FieldNames.Add('NONAUTHRESP');
      FieldNames.Add('CARDTYPE');
      FieldNames.Add('PROCESSORTOKEN');
      FieldNames.Add('CARDACCT');
      FieldNames.Add('TRANIDENT');
      FieldNames.Add('TRANCUSTOMERCODE');
      FieldNames.Add('STATIONIDENT');

      if IncludeEmpIdent then FieldNames.Add('TRANEMPLOYEEIDENT');
      if IncludeCardHolderName then FieldNames.Add('CARDNAME');
      if IncludeSFINDICATOR then FieldNames.Add('SFTRANGUID');
      if IncludeCVVResp then FieldNames.Add('CVVRESP');
      if IncludeAVSResp then FieldNames.Add('AVSRESP');
      if IncludeAVSData then FieldNames.Add('AVSDATA');  // 2019-06-15 tjr: DVST-564
   end;

   Procedure FormatXLSHeader;
   var
      iterator : integer;
   begin
      Row := xlsWorkSheet.AddRow;
      Row.AddCellString('RNID');
      if IncludeStoreName then Row.AddCellString('Location');
      Row.AddCellString('Auth Date');
      Row.AddCellString('Entry');
      Row.AddCellString('Type');
      Row.AddCellString('Amount');
      Row.AddCellString('Auth Code');
      Row.AddCellString('Card Acct');
      Row.AddCellString('Card Type');
      Row.AddCellString(TranIdentHeader); //2018-4-24 bls: F#3735
      Row.AddCellString(CustIdentHeader); //2018-4-24 bls: F#3735

      if IncludeEmpIdent then Row.AddCellString('Emp Ident');
      if IncludeServiceName then Row.AddCellString('Service Name');
      if IncludeCardHolderName then Row.AddCellString('Card Name');
      if IncludeSFINDICATOR then Row.AddCellString('SF');
      if IncludeCVVResp then Row.AddCellString('CVVRESP'); //2018-3-14 ajs: F#3629
      if IncludeAVSResp then Row.AddCellString('AVSRESP'); //2018-3-14 ajs: F#3629
      if IncludeAVSData then Row.AddCellString('AVSDATA'); // 2019-06-15 tjr: DVST-564

      Row.AddCellString('Station');

      if StoreSystemCodeLabel <> '' then begin
         Row.AddCellString(StoreSystemCodeLabel);
      end else begin
         Row.AddCellString('Station Code');
      end;

      For iterator := 0 to Row.Cells.Count - 1 do begin
         Row.Cells.Items[iterator].SetFontColor(clBlack).SetBorder(cbBottom).SetBGColor(TColor($80000000)).SetAlignment(cahCenter);
      end;
   end;

   Procedure FormatXLSBody;
   var
      BRNID, BSC, MaskAcct, CardAcct, ProcessorToken : string;
      Index : Integer; //2018-01-25 ajs: F#2378

      rnidField, scField, saleTypeField, amtField, aCodeField, dateField, entryModeField, nonAuthField, cardTypeField, cardAcctField, pTField, tranIdentField,
         custCodeField, empIdentField, servNameField, cNameField, sFField, cvvField, avsField, zipField, stationIdentField : TField;
   begin
      CCResults.DisableControls;
      rnidField := CCResults.FieldByName('PROFILE');
      scField := CCResults.FieldByName('SYSTEMCODE');
      dateField := CCResults.FieldByName('TRANDATE');
      entryModeField := CCResults.FieldByName('TRANENTRYMODE');
      saleTypeField := CCResults.FieldByName('SALETYPE');
      amtField := CCResults.FieldByName('TRANAMT');
      aCodeField := CCResults.FieldByName('AUTHCODE');
      cardAcctField := CCResults.FieldByName('CARDACCT');
      pTField := CCResults.FieldByName('PROCESSORTOKEN');
      cardTypeField := CCResults.FieldByName('CARDTYPE');
      tranIdentField := CCResults.FieldByName('TRANIDENT');
      custCodeField := CCResults.FieldByName('TRANCUSTOMERCODE');
      if IncludeEmpIdent then empIdentField := CCResults.FieldByName('TRANEMPLOYEEIDENT');
      if IncludeServiceName then servNameField := CCResults.FieldByName('CCSERVICENAME');
      if IncludeCardHolderName then cNameField := CCResults.FieldByName('CARDNAME');
      if IncludeSFINDICATOR then sFField := CCResults.FieldByName('SFTRANGUID');
      if IncludeCVVResp then cvvField := CCResults.FieldByName('CVVRESP');
      if IncludeAVSResp then avsField := CCResults.FieldByName('AVSRESP');
      if IncludeAVSData then zipField := CCResults.FieldByName('AVSDATA');  // 2019-06-15 tjr: DVST-564
      stationIdentField := CCResults.FieldByName('STATIONIDENT');

      While NOT CCResults.EOF do begin
         BRNID := rnidField.AsString;
         BSC := scField.AsString;

         if IncludeServiceName or strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHONSERVICENAME', 'FALSE')) then begin  //2018-01-29 jtm: D#3693
            ServiceNamesByRNID := GetServiceNamesByRNID(BRNID,'',ServNameList,ServNameDescList);
         end;

         Row := xlsWorkSheet.AddRow;
         if SearchOnServiceName then begin
            if (CCResults.FieldByName('CCSERVICENAME').AsString <> VarEvaluator.GetValueAsString('ServiceName')) then begin
               CCResults.Next;
               Continue;
            end;
         end else if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHONSERVICENAME', 'FALSE') = 'TRUE') and (VarEvaluator.GetValueAsString('ServiceName') = 'ALL') then begin
            if (ServiceNamesByRNID <> GetUserServNameAccessByRNID(ServNameList,BRNID,(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/NOREADONLYLOCATIONS','FALSE') = 'TRUE'),ServiceNamesByRNID)) then begin
               if (ServNameList.IndexOf(CCResults.FieldByName('CCSERVICENAME').AsString) < 0) then begin
                  CCResults.Next;
                  Continue;
               end;
            end;
         end;

         Row.AddCellString(BRNID);
         if IncludeStoreName then begin Row.AddCellString(StoreName);
         Row.AddCellString(dateField.AsString);
         Row.AddCellString(GetCCTranEntryModeDisplayCode(entryModeField.AsString));
         Row.AddCellString(saleTypeField.AsString);

         If (saleTypeField.AsString = 'CREDIT') or (saleTypeField.AsString = 'REFUND') or (saleTypeField.AsString = 'CRVOID') then begin
            Row.AddCellString('-' + DisplayMoney(ValuReal(amtField.AsString)));
         end else begin
            Row.AddCellString(DisplayMoney(ValuReal(amtField.AsString)));
         end;
         Row.AddCellString(aCodeField.AsString);

         CardAcct := cardAcctField.AsString;
         ProcessorToken := pTField.AsString;
         MaskAcct := '';
         if (CardAcct <> '') then begin  //2017-12-20 jtm: F#2430
            if (ProcessorToken <> '') then begin  //card number sent in, but either tokenized or not
               MaskAcct := MaskStr(ProcessorToken,DigitsToMask(ProcessorToken));
               MaskAcct := '*..*' + NumericOnly(MaskAcct);
            end else begin
               MaskAcct := CardAcct;
               MaskAcct := 'X..X' + NumericOnly(MaskAcct);
            end;
         end else if (CardAcct = '')  and (ProcessorToken <> '') then begin //token passed directly
            MaskAcct := MaskStr(ProcessorToken,DigitsToMask(ProcessorToken));
            MaskAcct := '#..#' + NumericOnly(MaskAcct);
         end;
         Row.AddCellString(MaskAcct);

         Row.AddCellString(cardTypeField.AsString);
         Row.AddCellString(tranIdentField.AsString);
         Row.AddCellString(custCodeField.AsString);

         if IncludeEmpIdent then Row.AddCellString(empIdentField.AsString);
         if IncludeServiceName then begin //2018-01-25 ajs: F#2378
            If IncludeServiceNameDesc then begin
               Index := ServNameList.IndexOf(servNameField.AsString);
               if (Index = -1) then begin
                  Row.AddCellString(servNameField.AsString);
               end else begin
                  Row.AddCellString(ServNameDescList[Index]);
               end;
            end else begin
               Row.AddCellString(servNameField.AsString);
            end;
         end;

         if IncludeCardHolderName then Row.AddCellString(cNameField.AsString);
         if IncludeSFINDICATOR then begin
            if (sFField.AsString <> '') then begin
               Row.AddCellString(sFField.AsString);
            end else begin
               Row.AddCellString(' ');
            end;
         end;
         if IncludeCVVResp then Row.AddCellString(cvvField.AsString); //2018-3-14 ajs: F#3629
         if IncludeAVSResp then Row.AddCellString(avsField.AsString); //2018-3-14 ajs: F#3629
         if IncludeAVSData then Row.AddCellString(zipField.AsString); // 2019-06-15 tjr: DVST-564
         Row.AddCellString(stationIdentField.AsString);
         Row.AddCellString(BSC);

         CCResults.Next;
      end;
   end;
end;
   Procedure FormatJSONBody;
   var
      BRNID, BSC, MaskAcct, CardAcct, ProcessorToken : string;
      Index : Integer; //2018-01-25 ajs: F#2378

      rnidField, scField, saleTypeField, amtField, aCodeField, dateField, entryModeField, nonAuthField, cardTypeField, cardAcctField, pTField, tranIdentField,
         custCodeField, empIdentField, servNameField, cNameField, sFField, cvvField, avsField, zipField, stationIdentField : TField;
   begin
      CCResults.DisableControls;

      rnidField := CCResults.FieldByName('PROFILE');
      scField := CCResults.FieldByName('SYSTEMCODE');
      dateField := CCResults.FieldByName('TRANDATE');
      entryModeField := CCResults.FieldByName('TRANENTRYMODE');
      saleTypeField := CCResults.FieldByName('SALETYPE');
      amtField := CCResults.FieldByName('TRANAMT');
      aCodeField := CCResults.FieldByName('AUTHCODE');
      cardAcctField := CCResults.FieldByName('CARDACCT');
      pTField := CCResults.FieldByName('PROCESSORTOKEN');
      cardTypeField := CCResults.FieldByName('CARDTYPE');
      tranIdentField := CCResults.FieldByName('TRANIDENT');
      custCodeField := CCResults.FieldByName('TRANCUSTOMERCODE');
      if IncludeEmpIdent then empIdentField := CCResults.FieldByName('TRANEMPLOYEEIDENT');
      if IncludeServiceName then servNameField := CCResults.FieldByName('CCSERVICENAME');
      if IncludeCardHolderName then cNameField := CCResults.FieldByName('CARDNAME');
      if IncludeSFINDICATOR then sFField := CCResults.FieldByName('SFTRANGUID');
      if IncludeCVVResp then cvvField := CCResults.FieldByName('CVVRESP');
      if IncludeAVSResp then avsField := CCResults.FieldByName('AVSRESP');
      if IncludeAVSData then zipField := CCResults.FieldByName('AVSDATA');  // 2019-06-15 tjr: DVST-564
      stationIdentField := CCResults.FieldByName('STATIONIDENT');

      JSON := TStringList.Create;
      JSON.BeginUpdate;
      JSON.Add('[');
      While NOT CCResults.EOF do begin
         if SearchOnServiceName then begin
            if (servNameField.AsString <> VarEvaluator.GetValueAsString('ServiceName')) then begin
               CCResults.Next;
               Continue;
            end;
         end else if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHONSERVICENAME', 'FALSE') = 'TRUE') and (VarEvaluator.GetValueAsString('ServiceName') = 'ALL') then begin
            if (ServiceNamesByRNID <> GetUserServNameAccessByRNID(ServNameList,BRNID,(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/NOREADONLYLOCATIONS','FALSE') = 'TRUE'),ServiceNamesByRNID)) then begin
               if (ServNameList.IndexOf(servNameField.AsString) < 0) then begin
                  CCResults.Next;
                  Continue;
               end;
            end;
         end;
         BRNID := rnidField.AsString;
         BSC := scField.AsString;

         JSON.Add('{"RNID":"' + BRNID + '",');
         if IncludeStoreName then JSON.Add('"Location":"' + StoreName + '",');
         JSON.Add('"Auth Date":"' + dateField.AsString + '",');
         JSON.Add('"Entry":"' + GetCCTranEntryModeDisplayCode(entryModeField.AsString) + '",');
         JSON.Add('"Transaction Type":"' + saleTypeField.AsString + '",');


         If (saleTypeField.AsString = 'CREDIT') or (saleTypeField.AsString = 'REFUND') or (saleTypeField.AsString = 'CRVOID') then begin
            JSON.Add('"Amount":"' + '-' + DisplayMoney(ValuReal(amtField.AsString)) + '",');
         end else begin
            JSON.Add('"Amount":"' + DisplayMoney(ValuReal(amtField.AsString)) + '",');
         end;

         JSON.Add('"Auth Code":"' + aCodeField.AsString + '",');
         CardAcct := cardAcctField.AsString;
         ProcessorToken := pTField.AsString;
         MaskAcct := '';
         if (CardAcct <> '') then begin
            if (ProcessorToken <> '') then begin  //card number sent in, but either tokenized or not
               MaskAcct := MaskStr(ProcessorToken,DigitsToMask(ProcessorToken));
               MaskAcct := '*..*' + NumericOnly(MaskAcct);
            end else begin
               MaskAcct := CardAcct;
               MaskAcct := 'X..X' + NumericOnly(MaskAcct);
            end;
         end else if (CardAcct = '')  and (ProcessorToken <> '') then begin //token passed directly
            MaskAcct := MaskStr(ProcessorToken,DigitsToMask(ProcessorToken));
            MaskAcct := '#..#' + NumericOnly(MaskAcct);
         end;
         JSON.Add('"Card Acct":"' + MaskAcct + '",');


         JSON.Add('"Card Type":"' + cardTypeField.AsString + '",');
         JSON.Add('"'+ TranIdentHeader +'":"' + tranIdentField.AsString + '",'); //2018-4-24 bls: F#3735
         JSON.Add('"'+ CustIdentHeader +'":"' + custCodeField.AsString + '",'); //2018-4-24 bls: F#3735

         if IncludeEmpIdent then JSON.Add('"Emp Ident":"' + empIdentField.AsString + '",');
         if IncludeServiceName then JSON.Add('"Service Name":"' + servNameField.AsString + '",');
         if IncludeCardHolderName then JSON.Add('"Card Name":"' + cNameField.AsString + '",');
         if IncludeSFINDICATOR then begin
            if (sFField.AsString <> '') then begin
               JSON.Add('"SF":"' + sFField.AsString + '",');
            end else begin
               JSON.Add('"SF":"' + ' ' + '",');
            end;
         end;
         if IncludeCVVResp then JSON.Add('"CVV Response":"' + cvvField.AsString + '",');
         if IncludeAVSResp then JSON.Add('"AVS Response":"' + avsField.AsString + '",');
         if IncludeAVSData then JSON.Add('"' + AVSDataHeader + '":"' + zipField.AsString + '",');  // 2019-06-15 tjr: DVST-564

         JSON.Add('"Station":"' + stationIdentField.AsString + '",');
         JSON.Add('"Station Code":"' + BSC + '"}');

         CCResults.Next;
         if NOT CCResults.EOF then JSON.Add(',');
      end;
      JSON.Add(']');
      JSON.EndUpdate;
   end;
Begin
   Result := '';
   if DisplayFormat = 'JSON' then begin
      Result := '[]';
   end;

   ServNameList := TStringList.Create;  //2018-01-29 jtm: D#3702
   ServNameDescList := TStringList.Create;

   IncludeEmpIdent := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEEMPIDENT', 'FALSE'));
   IncludeServiceName := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESERVICENAME', 'FALSE'));
   IncludeCardHolderName := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDECARDHOLDERNAME', 'FALSE'));
   IncludeSFINDICATOR := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESFINDICATOR', 'FALSE'));
   IncludeCVVResp := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDECVVRESP', 'FALSE'));
   IncludeAVSResp := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEAVSRESP', 'FALSE'));
   IncludeAVSData := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEAVSDATA', 'FALSE'));  // 2019-06-15 tjr: DVST-564
   AVSDataHeader := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/AVSDATAHEADER', 'AVSDATA');  // 2019-06-15 tjr: DVST-564
   IncludeServiceNameDesc := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESERVICENAMEDESCRIPTION', 'FALSE'));

   SearchOnServiceName := (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHONSERVICENAME', 'FALSE') = 'TRUE') and (VarEvaluator.GetValueAsString('ServiceName') <> 'ALL');

   TranIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CCTRANIDENTDESC', 'Tran Ident')); //2018-4-24 bls: F#3735
   CustIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CCCUSTIDENTDESC', 'Cust Ident')); //2018-4-24 bls: F#3735
   StoreSystemCodeLabel := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL', ''));

   IncludeStoreName := DisplayStoreNameOnOpenCard;

   LocationRNID := NumericOnly(Request.QueryFields.Values['LOCATIONRNID']);

   if IncludeStoreName then begin
      StoreName := FetchStoreName(LocationRNID);
   end;

   rowsRemaining := 0;
   lastSystemCode := '';
   count := '';
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ALLOWCHUNKING', 'TRUE')='TRUE') then begin // We allow chunking by default for performance reasons
      count := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ROWSFETCHEDPERCHUNKCARD', '500'); // Around 500 records per chunk is optimal
      end;

   FBatchDetailDM := TBatchDetailDM.Create(ProcessLog, ProcessPPSAPIXML);

   FieldNames := TStringList.Create();
   CreateFieldNames();

   FCCBatchXML := FBatchDetailDM.GetCCBatch(LocationRNID, '', true, count, lastSystemCode, EmpIdentP, FieldNames);

   if xExport <> NIL then begin
      xlsWorkSheet := xExport.AddWorkSheet;
   end;

   if (FCCBatchXML <> NIL) AND (FCCBatchXML.GetNode('/TRANRESP/CCBATCHDETAIL/CCAUTHDETAIL') <> NIL) then begin // If there was a response
      if count <> '' then begin
         rowsRemaining := FCCBatchXML.GetValueAsInteger('/TRANRESP/PENDINGRECORDCOUNT'); // Get the amount of records that are left in the gateway
         lastSystemCode := FCCBatchXML.GetValueAsWideString('/TRANRESP/LASTSYSTEMCODE'); // Get the last system code of a set of records to know where to start the next chunk
      end;

      FBatchDetailDM.BatchXMLToACRTable(FCCBatchXML.DocumentAsString,'CCBATCHDETAIL'); // Load the Response into a queryable table

      while (rowsRemaining > 0) AND (count <> '') do begin // Round up the rest of the data
         FCCBatchXML := FBatchDetailDM.GetCCBatch(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),'', true, count, lastSystemCode, EmpIdentP, FieldNames);

         if FCCBatchXML <> NIL then begin
            FBatchDetailDM.AddDataToTable(FCCBatchXML.DocumentAsString);
            rowsRemaining := FCCBatchXML.GetValueAsInteger('/TRANRESP/PENDINGRECORDCOUNT'); // update rowsRemaining
            lastSystemCode := FCCBatchXML.GetValueAsWideString('/TRANRESP/LASTSYSTEMCODE'); // update lastsystemcode
         end;
      end;

      CCResults := FBatchDetailDM.BatchDS; // Turn that table into a dataset

      if (CCResults.RecordCount > 0) then begin // If we have records
         if DisplayFormat = 'XLS' then begin
            FormatXLSHeader();
            FormatXLSBody();
         end else if DisplayFormat = 'JSON' then begin
            FormatJSONBody();
            Result := TextWithoutNewLine(JSON);
   end;
      end;
   end;

   ServNameList.Free;
   ServNameDescList.Free;
   
   if assigned(JSON) then JSON.Free;
   if assigned(FCCBatchXML) then FCCBatchXML.Free;
   if assigned(CCResults) then CCResults.Free;
   if assigned(FieldNames) then FieldNames.Free;
   if assigned(FBatchDetailDM) then FBatchDetailDM.Free;
   if assigned(Row) then Row.Free;
end;

function TCustomerInfoModule.GetCashBatchToXLS(xExport : TOExport; const DisplayFormat, EmpIdentP : String): String; //2018-06-20 bls: F#2227
var
  useUpdatedMethods : boolean;
  rowsRemaining : integer;
  StoreSystemCodeLabel, TranIdentHeader, CustIdentHeader, lastSystemCode, count : string;

  xlsWorkSheet : TExportWorksheet; //Represents actual xls worksheet
  Row : TExportRow; //Represents actual row inside the TExportWorksheet
  FieldNames, JSON : TStringList;
  FBatchDetailDM : TBatchDetailDM;
  FCashBatchXML : TOpenXML;
  CashResults : TDataSet;

  Procedure CreateFieldNames();
  begin
      FieldNames.Add('TRANAMT');
      FieldNames.Add('TRANDATE');
      FieldNames.Add('TRANTYPE');
      FieldNames.Add('EMPIDENT');
      FieldNames.Add('TRANIDENT');
      FieldNames.Add('CUSTIDENT');
      FieldNames.Add('STATIONIDENT');
      FieldNames.Add('CURRENCYTYPE');
  end;

  Procedure FormatXLSHeader();
  var
      iterator : integer;
  begin
      xlsWorkSheet := xExport.AddWorkSheet;
      Row := xlsWorkSheet.AddRow;

      Row.AddCellString('RNID');
      Row.AddCellString('Tran Date');
      Row.AddCellString('Tran Type');
      Row.AddCellString('Amount');
      Row.AddCellString('Emp Ident');
      Row.AddCellString(TranIdentHeader);      //2018-4-24 bls: F#3735
      Row.AddCellString(CustIdentHeader);      //2018-4-24 bls: F#3735
      Row.AddCellString('Station Ident');
      Row.AddCellString('Type');

      if StoreSystemCodeLabel <> '' then begin
         Row.AddCellString(StoreSystemCodeLabel);
      end else begin
         Row.AddCellString('Station Code');
      end;

      For iterator := 0 to Row.Cells.Count - 1 do begin
         Row.Cells.Items[iterator].SetFontColor(clBlack).SetBorder(cbBottom).SetBGColor(TColor($80000000)).SetAlignment(cahCenter);
      end;
  end;

  Procedure FormatXLSBody();
  var
   rnidField, scField, dateField, tranTypeField, amtField, empIdentField, tranIdentField, custIdentField, stationIdentField, currTypeField : TField;
  begin
      CashResults.DisableControls;

      rnidField := CashResults.FieldByName('PROFILE');
      scField := CashResults.FieldByName('SYSTEMCODE');
      dateField := CashResults.FieldByName('TRANDATE');
      tranTypeField := CashResults.FieldByName('TRANTYPE');
      amtField := CashResults.FieldByName('TRANAMT');
      empIdentField := CashResults.FieldByName('EMPIDENT');
      tranIdentField := CashResults.FieldByName('TRANIDENT');
      custIdentField := CashResults.FieldByName('CUSTIDENT');
      stationIdentField := CashResults.FieldByName('STATIONIDENT');
      currTypeField := CashResults.FieldByName('CURRENCYTYPE');

      While NOT CashResults.EOF do begin
         Row := xlsWorksheet.AddRow;

         Row.AddCellString(rnidField.AsString);
         Row.AddCellString(dateField.AsString);
         Row.AddCellString(tranTypeField.AsString);
         Row.AddCellString(DisplayMoney(ValuReal(amtField.AsString)));
         Row.AddCellString(empIdentField.AsString);
         Row.AddCellString(tranIdentField.AsString);
         Row.AddCellString(custIdentField.AsString);
         Row.AddCellString(stationIdentField.AsString);
         Row.AddCellString(currTypeField.AsString);
         Row.AddCellString(scField.AsString);

         CashResults.Next;
      end;
  end;

  Procedure FormatJSONBody();
  var
   rnidField, scField, dateField, tranTypeField, amtField, empIdentField, tranIdentField, custIdentField, stationIdentField, currTypeField : TField;
  begin
      CashResults.DisableControls;
      
      rnidField := CashResults.FieldByName('PROFILE');
      scField := CashResults.FieldByName('SYSTEMCODE');
      dateField := CashResults.FieldByName('TRANDATE');
      tranTypeField := CashResults.FieldByName('TRANTYPE');
      amtField := CashResults.FieldByName('TRANAMT');
      empIdentField := CashResults.FieldByName('EMPIDENT');
      tranIdentField := CashResults.FieldByName('TRANIDENT');
      custIdentField := CashResults.FieldByName('CUSTIDENT');
      stationIdentField := CashResults.FieldByName('STATIONIDENT');
      currTypeField := CashResults.FieldByName('CURRENCYTYPE');
         
      JSON := TStringList.Create;
      JSON.BeginUpdate;
      JSON.Add('[');
      While NOT CashResults.EOF do begin
         JSON.Add('{"RNID":"' + rnidField.AsString + '",');
         JSON.Add('"Tran Date":"' + dateField.AsString + '",');
         JSON.Add('"Tran Type":"' + tranTypeField.AsString + '",');
         JSON.Add('"Amount":"' + DisplayMoney(ValuReal(amtField.AsString)) + '",');
         JSON.Add('"Emp Ident":"' + empIdentField.AsString + '",');
         JSON.Add('"'+ TranIdentHeader +'":"' + tranIdentField.AsString + '",');  //2018-4-24 bls: F#3735
         JSON.Add('"'+ CustIdentHeader +'":"' + custIdentField.AsString + '",');  //2018-4-24 bls: F#3735
         JSON.Add('"Station Ident":"' + stationIdentField.AsString + '",');
         JSON.Add('"Type":"' + currTypeField.AsString + '",');
         JSON.Add('"Station Code":"' + scField.AsString + '"}');

         CashResults.Next;

         if NOT CashResults.EOF then JSON.Add(',');
      end;

      JSON.Add(']');
      JSON.EndUpdate;
  end;

  Procedure FormatXLSBodyOld();
  var
   BRNID, BSC : String;
  begin
      While NOT CashResults.EOF do begin
         Row := xlsWorksheet.AddRow;

         BRNID := Trim(CashResults.FieldByName('PROFILE').AsString);
         BSC := CashResults.FieldByName('SYSTEMCODE').AsString;

         Row.AddCellString(CashResults.FieldByName('PROFILE').AsString);
         Row.AddCellString(CashResults.FieldByName('TRANDATE').AsString);
         Row.AddCellString(CashResults.FieldByName('TRANTYPE').AsString);
         Row.AddCellString(DisplayMoney(ValuReal(CashResults.FieldByName('TRANAMT').AsString)));
         Row.AddCellString(CashResults.FieldByName('EMPIDENT').AsString);
         Row.AddCellString(CashResults.FieldByName('TRANIDENT').AsString);
         Row.AddCellString(CashResults.FieldByName('CUSTIDENT').AsString);
         Row.AddCellString(CashResults.FieldByName('STATIONIDENT').AsString);
         Row.AddCellString(CashResults.FieldByName('CURRENCYTYPE').AsString);
            Row.AddCellString(BSC);

         CashResults.Next;
         end;
      end;

  Procedure FormatJSONBodyOld();
  var
   BRNID, BSC : String;
  begin
      JSON := TStringList.Create;
      JSON.Append('[');

      While NOT CashResults.EOF do begin
         BRNID := Trim(CashResults.FieldByName('PROFILE').AsString);
         BSC := CashResults.FieldByName('SYSTEMCODE').AsString;
            
         JSON.Append('{"RNID":"' + BRNID + '",');
         JSON.Append('"Tran Date":"' + CashResults.FieldByName('TRANDATE').AsString + '",');
         JSON.Append('"Tran Type":"' + CashResults.FieldByName('TRANTYPE').AsString + '",');
         JSON.Append('"Amount":"' + DisplayMoney(ValuReal(CashResults.FieldByName('TRANAMT').AsString)) + '",');
         JSON.Append('"Emp Ident":"' + CashResults.FieldByName('EMPIDENT').AsString + '",');
         JSON.Append('"'+ TranIdentHeader +'":"' + CashResults.FieldByName('TRANIDENT').AsString + '",');  //2018-4-24 bls: F#3735
         JSON.Append('"'+ CustIdentHeader +'":"' + CashResults.FieldByName('CUSTIDENT').AsString + '",');  //2018-4-24 bls: F#3735
         JSON.Append('"Station Ident":"' + CashResults.FieldByName('STATIONIDENT').AsString + '",');
         JSON.Append('"Type":"' + CashResults.FieldByName('CURRENCYTYPE').AsString + '",');
         JSON.Append('"Station Code":"' + BSC + '"}');

         CashResults.Next;

         if NOT CashResults.EOF then JSON.Append(','); 
         end;

      JSON.Append(']');
      end;
      
Begin
   Result := '';
   if DisplayFormat = 'JSON' then begin
      Result := '[]';
   end;

   TranIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CASHTRANIDENTDESC', 'Tran Ident'));  //2018-4-24 bls: F#3735
   CustIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CASHCUSTIDENTDESC', 'Cust Ident'));  //2018-4-24 bls: F#3735
   StoreSystemCodeLabel := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL', ''));

   useUpdatedMethods := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEUPDATEDOPENBATCHDOWNLOAD','TRUE'));

   rowsRemaining := 0;
   lastSystemCode := '';
   count := '';
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ALLOWCHUNKING', 'FALSE') = 'TRUE') then begin
      count := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ROWSFETCHEDPERCHUNKCASH', '400');
   end;

   FBatchDetailDM := TBatchDetailDM.Create(ProcessLog, ProcessPPSAPIXML);

   FieldNames := TStringList.Create();
   CreateFieldNames();

   FCashBatchXML := FBatchDetailDM.GetCashBatch(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),'', true, count, lastSystemCode, EmpIdentP, FieldNames);

   If (FCashBatchXML <> NIL) AND (FCashBatchXML.GetNode('/TRANRESP/CASHBATCHDETAIL/CASHDETAIL') <> NIL) then begin // If there was a response
      if count <> '' then begin
         rowsRemaining := FCashBatchXML.GetValueAsInteger('/TRANRESP/PENDINGRECORDCOUNT'); // Get the amount of records that are left in the gateway
         lastSystemCode := FCashBatchXML.GetValueAsWideString('/TRANRESP/LASTSYSTEMCODE'); // Get the last system code of a set of records to know where to start the next chunk
      end;

      FBatchDetailDM.BatchXMLToACRTable(FCashBatchXML.DocumentAsString, 'CASHBATCHDETAIL'); // Load the Response into a queryable table

      while (rowsRemaining > 0) AND (count <> '') do begin
         FCashBatchXML := FBatchDetailDM.GetCashBatch(NumericOnly(Request.queryfields.Values['LOCATIONRNID']),'', true, count, lastSystemCode, EmpIdentP, FieldNames);

         if FCashBatchXML <> NIL then begin
            FBatchDetailDM.AddDataToTable(FCashBatchXML.DocumentAsString);
            rowsRemaining := FCashBatchXML.GetValueAsInteger('/TRANRESP/PENDINGRECORDCOUNT'); // update rowsRemaining
            lastSystemCode := FCashBatchXML.GetValueAsWideString('/TRANRESP/LASTSYSTEMCODE'); // update lastsystemcode
         end;
      end;

      CashResults := FBatchDetailDM.BatchDS; // Turn that table into a dataset

      if (CashResults.RecordCount > 0) then begin // If we have records
         if DisplayFormat = 'XLS' then begin
            FormatXLSHeader();
            if useUpdatedMethods then begin
            FormatXLSBody();
            end else begin
               FormatXLSBodyOld();
            end;
         end else if DisplayFormat = 'JSON' then begin
            if useUpdatedMethods then begin
            FormatJSONBody();
            end else begin
               FormatJSONBodyOld();
            end;

            Result := TextWithoutNewLine(JSON);
   end;
end;
   end;

   if assigned(JSON) then JSON.Free;
   if assigned(CashResults) then CashResults.Free;
   if assigned(FieldNames) then FieldNames.Free;
   if assigned(FCashBatchXML) then FCashBatchXML.Free;
   if assigned(FBatchDetailDM) then FBatchDetailDM.Free;
   if assigned(Row) then Row.Free;
end;

function TCustomerInfoModule.GetCheckBatchToXLS(xExport: TOExport; const ARNID, DisplayFormat, EmpIdentP: String): String; //2018-06-20 bls: F#2227
var
  IncludeEmpIdent, ShowVoidAsZero, IncludeStoreName: boolean;
  TranIdentHeader, CustIdentHeader, StoreSystemCodeLabel, StoreName, LocationRNID: string;

  xlsWorkSheet: TExportWorksheet; //Represents actual xls worksheet
  Row: TExportRow; //Represents actual row inside the TExportWorksheet
  FieldNames, JSON: TStringList;
  FBatchDetailDM: TBatchDetailDM;
  FCheckBatchXML: TOpenXML;
  TCResults: TDataSet;

  Procedure CreateFieldNames();
  begin
      FieldNames.Add('AUTHDATE');
      FieldNames.Add('UPDATEDAMOUNT');
      FieldNames.Add('TRANAMOUNT');
      FieldNames.Add('VOIDED');
      FieldNames.Add('RESPONSECHECKNUMBER');
      FieldNames.Add('DISPLAYTEXT');
      FieldNames.Add('ECATRANSTATUS');
      FieldNames.Add('TRANIDENT');
      FieldNames.Add('TRANCUSTOMERCODE');
      FieldNames.Add('STATIONIDENT');
      FieldNames.Add('TCMID');

      If IncludeEmpIdent then FieldNames.Add('TRANEMPLOYEEIDENT');
  end;

  Procedure FormatXLSHeader;
  var
      iterator : integer;
  begin
      Row := xlsWorkSheet.AddRow;

      Row.AddCellString('RNID');
      if IncludeStoreName then Row.AddCellString('Location');
      Row.AddCellString('Auth Date');
      Row.AddCellString('Amount');
      Row.AddCellString('CHK #');
      Row.AddCellString('TCK Response');
      Row.AddCellString('Status');
      Row.AddCellString(TranIdentHeader); //2018-4-24 bls: F#3735
      Row.AddCellString(CustIdentHeader); //2018-4-24 bls: F#3735
      Row.AddCellString('Station');
      Row.AddCellString('MID');
      Row.AddCellString('Service');

      if IncludeEmpIdent then Row.AddCellString('Emp Ident');
      if StoreSystemCodeLabel <> '' then begin
         Row.AddCellString(StoreSystemCodeLabel);
      end else begin
         Row.AddCellString('Station Code');
      end;

      For iterator := 0 to Row.Cells.Count - 1 do begin
         Row.Cells.Items[iterator].SetFontColor(clBlack).SetBorder(cbBottom).SetBGColor(TColor($80000000)).SetAlignment(cahCenter);
      end;
  end;

  Procedure FormatXLSBody;
  var
   BRNID, BSC, Amt : string;
   scField, dateField, updatedAmtField, amtField, voidedField, respCheckNumField, displayTextField, ecaStatusField, tranIdentField, custIdentField, stationIdentField,
      midField, servNameField, empIdentField : TField;
  begin
      TCResults.DisableControls;
      scField := TCResults.FieldByName('SYSTEMCODE');
      dateField := TCResults.FieldByName('AUTHDATE');
      updatedAmtField := TCResults.FieldByName('UPDATEDAMOUNT');
      amtField := TCResults.FieldByName('TRANAMOUNT');
      voidedField := TCResults.FieldByName('VOIDED');
      respCheckNumField := TCResults.FieldByName('RESPONSECHECKNUMBER');
      displayTextField := TCResults.FieldByName('DISPLAYTEXT');
      ecaStatusField := TCResults.FieldByName('ECATRANSTATUS');
      tranIdentField := TCResults.FieldByName('TRANIDENT');
      custIdentField := TCResults.FieldByName('TRANCUSTOMERCODE');
      stationIdentField := TCResults.FieldByName('STATIONIDENT');
      midField := TCResults.FieldByName('TCMID');
      servNameField := TCResults.FieldByName('TCSERVICENAME');
      if IncludeEmpIdent then empIdentField := TCResults.FieldByName('TRANEMPLOYEEIDENT');

      While NOT TCResults.EOF do begin
         Row := xlsWorkSheet.AddRow;
         BRNID := Trim(ARNID);
         BSC := scField.AsString;

         Row.AddCellString(BRNID);
         if IncludeStoreName then Row.AddCellString(StoreName);
         Row.AddCellString(dateField.AsString);

         if (updatedAmtField.AsString <> '') then begin //2017-11-16 jtm: D#2047
            Amt := updatedAmtField.AsString;
         end else begin
            Amt := amtField.AsString;
         end;
         if (ShowVoidAsZero and (voidedField.AsString = 'TRUE')) then begin
            Row.AddCellString(DisplayMoney(0));
         end else begin
            Row.AddCellString(DisplayMoney(ValuReal(Amt)));
         end;

         Row.AddCellString(respCheckNumField.AsString);
         Row.AddCellString(displayTextField.AsString);
         Row.AddCellString(ecaStatusField.AsString);
         Row.AddCellString(tranIdentField.AsString);
         Row.AddCellString(custIdentField.AsString);
         Row.AddCellString(stationIdentField.AsString);
         Row.AddCellString(midField.AsString);
         Row.AddCellString(servNameField.AsString);

         if IncludeEmpIdent then Row.AddCellString(empIdentField.AsString);
         Row.AddCellString(BSC);
         TCResults.Next;
      end;
  end;

  Procedure FormatJSONBody;
  var
   BRNID, BSC, Amt : string;
   scField, dateField, updatedAmtField, amtField, voidedField, respCheckNumField, displayTextField, ecaStatusField, tranIdentField, custIdentField, stationIdentField,
      midField, servNameField, empIdentField : TField;
  begin
      TCResults.DisableControls;
      scField := TCResults.FieldByName('SYSTEMCODE');
      dateField := TCResults.FieldByName('AUTHDATE');
      updatedAmtField := TCResults.FieldByName('UPDATEDAMOUNT');
      amtField := TCResults.FieldByName('TRANAMOUNT');
      voidedField := TCResults.FieldByName('VOIDED');
      respCheckNumField := TCResults.FieldByName('RESPONSECHECKNUMBER');
      displayTextField := TCResults.FieldByName('DISPLAYTEXT');
      ecaStatusField := TCResults.FieldByName('ECATRANSTATUS');
      tranIdentField := TCResults.FieldByName('TRANIDENT');
      custIdentField := TCResults.FieldByName('TRANCUSTOMERCODE');
      stationIdentField := TCResults.FieldByName('STATIONIDENT');
      midField := TCResults.FieldByName('TCMID');
      servNameField := TCResults.FieldByName('TCSERVICENAME');
      if IncludeEmpIdent then empIdentField := TCResults.FieldByName('TRANEMPLOYEEIDENT');

      JSON := TStringList.Create;
      JSON.BeginUpdate;
      JSON.Add('[');

      While NOT TCResults.EOF do begin
         BRNID := Trim(ARNID);
         BSC := scField.AsString;

         JSON.Add('{"RNID":"' + BRNID + '",');
         if IncludeStoreName then JSON.Add('"Location":"' + StoreName + '",');
         JSON.Add('"Auth Date":"' + dateField.AsString + '",');

         if (updatedAmtField.AsString <> '') then begin
            Amt := updatedAmtField.AsString;
         end else begin
            Amt := amtField.AsString;
         end;
         if (voidedField.AsString = 'TRUE') then begin
            JSON.Add('"Amount":"' + DisplayMoney(0) + '",');
         end else begin
            JSON.Add('"Amount":"' + DisplayMoney(ValuReal(Amt)) + '",');
         end;
         JSON.Add('"CHK #":"' + respCheckNumField.AsString + '",');
         JSON.Add('"TCK Response":"' + displayTextField.AsString + '",');
         JSON.Add('"Status":"' + ecaStatusField.AsString + '",');
         JSON.Add('"' + TranIdentHeader + '":"' + tranIdentField.AsString + '",');  //2018-4-24 bls: F#3735
         JSON.Add('"' + CustIdentHeader + '":"' + custIdentField.AsString + '",'); //2018-4-24 bls: F#3735
         JSON.Add('"Station":"' + stationIdentField.AsString + '",');
         JSON.Add('"MID":"' + midField.AsString + '",');
         JSON.Add('"Service":"' + servNameField.AsString + '",');

         if IncludeEmpIdent then JSON.Add('"Emp Ident":"' + empIdentField.AsString + '",');

         if StoreSystemCodeLabel <> '' then begin
            JSON.Add('"' + StoreSystemCodeLabel + '":"' + BSC + '"}');
         end else begin
            JSON.Add('"Station Code":"' + BSC + '"}');
         end;
         TCResults.Next;

         if NOT TCResults.EOF then JSON.Add(',');
      end;
      JSON.Add(']');
      JSON.EndUpdate;
  end;
Begin
   Result := '';
   if DisplayFormat = 'JSON' then begin
      Result := '[]';
   end;

   TranIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/TCTRANIDENTDESC', 'Tran Ident')); //2018-4-24 bls: F#3735
   CustIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/TCCUSTIDENTDESC', 'Cust Ident')); //2018-4-24 bls: F#3735
   StoreSystemCodeLabel := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL', ''));

   IncludeEmpIdent := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEEMPIDENT', 'FALSE'));
   ShowVoidAsZero := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SHOWCHECKVOIDASZERO', 'FALSE'));
   IncludeStoreName := DisplayStoreNameOnOpenCheck;

   LocationRNID := NumericOnly(Request.queryfields.Values['LOCATIONRNID']);
   if IncludeStoreName then begin
      StoreName := FetchStoreName(LocationRNID);
   end;

   FBatchDetailDM := TBatchDetailDM.Create(ProcessLog, ProcessPPSAPIXML);
   FieldNames := TStringList.Create;
   CreateFieldNames();

   FCheckBatchXML := FBatchDetailDM.GetTCBatch(LocationRNID, '', true, EmpIdentP, FieldNames);

   If xExport <> NIL then begin
      xlsWorkSheet := xExport.AddWorkSheet;
   end;

   IF (FCheckBatchXML <> NIL) AND (FCheckBatchXML.GetNode('/TRANRESP/TCBATCHDETAIL/TCAUTHDETAIL') <> NIL) then begin
      FBatchDetailDM.BatchXMLToACRTable(FCheckBatchXML.DocumentAsString,'TCBATCHDETAIL');
      TCResults := FBatchDetailDM.BatchDS;

      if (TCResults.RecordCount > 0) then begin
         if DisplayFormat = 'XLS' then begin
            FormatXLSHeader;
            FormatXLSBody;
         end else if DisplayFormat = 'JSON' then begin
            FormatJSONBody;
            Result := TextWithoutNewLine(JSON);
         end;
      end;
   end;

   if assigned(JSON) then JSON.Free;
   if assigned(FieldNames) then FieldNames.Free;
   if assigned(FCheckBatchXML) then FCheckBatchXML.Free;
   if assigned(TCResults) then TCResults.Free;
   if assigned(FBatchDetailDM) then FBatchDetailDM.Free;
   if assigned(Row) then Row.Free;
end;

function TCustomerInfoModule.SendCustomerEmail(Email, EmailTemplate,EmailSubject,BCCList,ReplyTo: string): boolean;
var
    HTMLEmail : String;
begin
   result := false;
   if (EmailTemplate <> '') and (Email <> '') and (EmailSubject <> '') then begin
      HTMLEmail := LoadWebFileFromFolder(EmailTemplate,'');
      ProcessLog(ltInfo, 'SendCustomerEmail: EmailTemplate', EmailTemplate);
      if HTMLEmail <> '' then begin
         try
            clMail.BuildMessage('',HTMLEmail);
            clMail.From.FullAddress := '"' + DomainFriendlyName+'"<'+DomainSendAsEmail+'>';
            clMail.ToList.EmailAddresses := Email;
            ProcessLog(ltInfo, 'SendCustomerEmail: Email', Email);
            clMail.BCCList.EmailAddresses := BCCList;
            clMail.Subject := EmailSubject;
            clMail.ReplyTo := ReplyTo;

            SMTP.Open();
            try
               SMTP.Send(clMail);
            finally
               SMTP.Close();
            end;

            Result := true;
         except
           On E:Exception do begin
               ProcessLog(ltWarning,'Exception SendCustomerEmail:',e.message);
           end;
         end;
      end;
   end;
end;

function TCustomerInfoModule.GetCashQueryTable(RNID: String; FromDate, ThruDate: TDateTime; BatchSerial: Integer; StationName, SaleType,
StationIdent, DisplayFormat: String; ShowLinks: Boolean; xExport: TOExport): String;
var
   WS : String;
   I : Integer;
   StoreInfo : String;
   TabText : String;

   SaleCash : Integer;
   SaleVoucher : Integer;
   SaleQCash : Integer;
   SaleQVoucher : Integer;

   RefundCash : Integer;
   RefundVoucher : Integer;
   RefundQCash : Integer;
   RefundQVoucher : Integer;

   VoidCash : Integer;
   VoidVoucher : Integer;
   VoidQCash : Integer;
   VoidQVoucher : Integer;

   WI : Integer;
   Line : String;
   TotalRecs : Integer;
   ReturnedRecs : integer;
   StartRow : integer;

   HTML : TStringList;
   CSV : TStringList;
   JSON : TStringList;
   GRID : TStringList; //2018-06-20 bls: F#840
   RecordFormatType: TRecordFormatType; //2018-06-20 bls: F#840

   RNIDList : TStringList;
   AllowAll : boolean;
   IncludeServiceName : boolean;
   IncludeEmpIdent : boolean;
   IncludeCardHolderName : boolean;
   IncludeProfileFields : boolean;
   ExcludeExtraAmount : boolean;
   PreviousRNID : string;
   CustomField1Value, CustomField2Value, CustomField3Value, CustomField4Value, CustomField5Value, CustomField6Value : String;
   HTMLHeader : string;
   StoreSystemCodeLabel : string;
   DisplayInTZ : boolean; //2017-12-20 jtm: D#2620
   UsingAll : boolean;
   DisplayInAMPM : BOOlean;

   xlsWorkSheet : TExportWorksheet; //Represents actual xls worksheet
   Row : TExportRow; //Represents actual row inside the TExportWorksheet
   JSONString : string;
   DateRange : string;

   TranIdentHeader : string; //2018-4-24 bls: F#3735
   CustIdentHeader : string; //2018-4-24 bls: F#3735

   DisplayStoreName : boolean; //2018-04-30 bls: F#1129

   posStart, totalCount, count, orderBy, direction : string; //2018-06-20 bls: F#840
   QueryBuilder, ParameterList : TStringList; //2018-06-20 bls: F#840
   useJSONResp : boolean; //2018-07-18 bls: F#4978

   Procedure AddAmt(Var CashInt : integer; Var VoucherInt : integer; Var CashQInt : integer; Var VoucherQInt : integer);
   Begin
      WI := Round(RNQuery.FieldByName('TranAmt').AsFloat *100);
      If (Trim(RNQuery.FieldByName('CurrencyType').AsString) = 'CASH') or (Trim(RNQuery.FieldByName('CurrencyType').AsString) = '') then begin
         CashInt := CashInt + WI;
         Inc(CashQInt);
      end else If (Trim(RNQuery.FieldByName('CurrencyType').AsString) = 'VOUCHER') then begin
         VoucherInt := VoucherInt + WI;
         Inc(VoucherQInt);
      end;
   end;

   Procedure ProcessHeader(AStoreCode: String; ADetailrecsExists: Boolean); //2018-06-20 bls: F#840
   var
      iterator : integer;
   begin
      SaleCash := 0;
      SaleVoucher := 0;
      SaleQCash := 0;
      SaleQVoucher := 0;
      RefundCash := 0;
      RefundVoucher := 0;
      RefundQCash := 0;
      RefundQVoucher := 0;
      VoidCash := 0;
      VoidVoucher := 0;
      VoidQCash := 0;
      VoidQVoucher := 0;
      CustomField1Value := '';
      CustomField2Value := '';
      CustomField3Value := '';
      CustomField4Value := '';
      CustomField5Value := '';
      CustomField6Value := '';

      if AStoreCode <> '' then begin  //2017-05-10 jtm F#1696
         StoreInfo := GetStoreInfo(Valu(AStoreCode));
      end;

      if (RecordFormatType in [ttrftHTML, ttrftAJAX]) then begin
         HTML.Append('<TABLE border="1" cellspacing="0" cellpadding="3" bordercolorlight="#0000FF" style="border-collapse: collapse; font-size:7pt;font-family:veranda">');
         HTML.Append('<TR><TD><B>RNID</B></TD>');

         if DisplayStoreName then begin //2018-04-30 bls: F#1129
            HTML.Append('  <TD><B>Store Name</B></TD>');
         end;

         HTML.Append('    <TD><B>Tran Date</B></TD>');
         HTML.Append('    <TD><B>Type</B></TD>');
         HTML.Append('    <TD Align="Right" colspan=2><B>Amount</B></TD>');
         HTML.Append('    <TD><B>Tran Type</B></TD>');
         HTML.Append('    <TD><B>Emp Ident</B></TD>');
         HTML.Append('    <TD><B>' + TranIdentHeader + '</B></TD>');   //2018-4-24 bls: F#3735
         HTML.Append('    <TD><B>' + CustIdentHeader + '</B></TD>');   //2018-4-24 bls: F#3735
         HTML.Append('    <TD><B>Batch Date</B></TD>');
         HTML.Append('    <TD><B>Batch ID</B></TD>');
         if IncludeServiceName then HTML.Append('    <TD><B>Service Name</B></TD>');

         HTML.Append('    <TD><B>Station Ident</B></TD>');
         if StoreSystemCodeLabel <> '' then begin
            HTML.Append('  <TD><B>'+ StoreSystemCodeLabel +'</B></TD>');
         end else begin
            HTML.Append('  <TD><B>Item Serial</B></TD>');
         end;
         HTML.Append('</TR>');

      end else If (RecordFormatType = ttrftXLS) and (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEREPORTHEADERS', 'FALSE') = 'TRUE') then begin   //2016-3-28 jtm
         Row := xlsWorkSheet.AddRow;

         Row.AddCellString('RNID');

         if DisplayStoreName then begin //2018-30-2018 bls: F#1129
            Row.AddCellString('Store Name');
         end;

         Row.AddCellString('Tran Date');
         Row.AddCellString('Type');
         Row.AddCellString('Amount');
         Row.AddCellString('Tran Type');
         Row.AddCellString('Employee Ident').SetCalculateColWidth;
         Row.AddCellString(TranIdentHeader); //2018-4-24 bls: F#3735
         Row.AddCellString(CustIdentHeader); //2018-4-24 bls: F#3735
         Row.AddCellString('Batch Date');
         Row.AddCellString('Batch ID');
         Row.AddCellString('Station');

         if StoreSystemCodeLabel <> '' then begin
            Row.AddCellString(StoreSystemCodeLabel);
         end else begin
            Row.AddCellString('Station Code');
         end;
         Row.AddCellString('Store Name');
         Row.AddCellString('Store City');
         Row.AddCellString('Store State');
         Row.AddCellString('Store ZIP');

         if IncludeServiceName then Row.AddCellString('Service Name').SetCalculateColWidth;

         if IncludeProfileFields then begin
            if not Assigned(ProfileXML) then ProfileXML := TTProfileXML.Create(StrToInt(Trim(RNQuery.FieldByName('StoreCode').AsString)), HDQuery);

            Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/NAME', ''));
            Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/NAME', ''));
            Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/NAME', ''));
            Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/NAME', ''));
            Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/NAME', ''));
            Row.AddCellString(ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/NAME', ''));
         end;

         For iterator := 0 to Row.Cells.Count - 1 do begin
            Row.Cells.Items[iterator].SetFontColor(clBlack).SetBorder(cbBottom).SetBGColor(TColor($80000000)).SetAlignment(cahCenter);
         end;
      end;
   end;

   Procedure FormatXML;
   begin
   end;

   Procedure FormatXLS;
   begin
      Row := xlsWorkSheet.AddRow;

      Row.AddCellString(Trim(RNQuery.FieldByName('StoreCode').AsString));

      if DisplayStoreName then begin //2018-30-2018 bls: F#1129
         Row.AddCellString(Trim(RNQuery.FieldByName('NAME').AsString));
      end;

      if (DisplayInTZ) then begin
         if DisplayInAMPM then begin
            Row.AddCellString(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByname('authdatetz').AsDateTime)).SetCalculateColWidth;
         end else begin
            Row.AddCellString(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('authdatetz').AsDateTime)).SetCalculateColWidth;
         end;
      end else begin
         Row.AddCellString(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('TranDate').AsDateTime)).SetCalculateColWidth;
      end;

      Row.AddCellString(Trim(RNQuery.FieldByName('TranType').AsString)).SetCalculateColWidth;
      If Trim(RNQuery.FieldByName('TranType').AsString) = 'REFUND' then begin
         Row.AddCellString('-$' + Trim(StriReal(RNQuery.FieldByName('TranAmt').AsFloat,2))).SetCalculateColWidth;
      end else begin
         Row.AddCellString('$' + Trim(StriReal(RNQuery.FieldByName('TranAmt').AsFloat,2))).SetCalculateColWidth;
      end;

      Row.AddCellString(Trim(RNQuery.FieldByName('CurrencyType').AsString));
      Row.AddCellString(Trim(RNQuery.FieldByName('EmpIdent').AsString));
      Row.AddCellString(Trim(RNQuery.FieldByName('TranIdent').AsString));
      Row.AddCellString(Trim(RNQuery.FieldByName('CustIdent').AsString));

      if (DisplayInTZ) then begin
         if DisplayInAMPM then begin
            Row.AddCellString(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByname('BatchDatetz').AsDateTime)).SetCalculateColWidth;
         end else begin
            Row.AddCellString(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('BatchDatetz').AsDateTime)).SetCalculateColWidth;
         end;
      end else begin
         Row.AddCellString(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('BatchDate').AsDateTime)).SetCalculateColWidth;
      end;

      Row.AddCellString(Trim(RNQuery.FieldByName('BatchCode').AsString));
      Row.AddCellString(Trim(RNQuery.FieldByName('StationIdent').AsString)).SetCalculateColWidth;
      Row.AddCellString(Trim(RNQuery.FieldByName('StoreSystemCode').AsString));
      Row.AddCellString(Trim(RNQuery.FieldByName('Name').AsString)).SetCalculateColWidth;
      Row.AddCellString(Trim(RNQuery.FieldByName('City').AsString));
      Row.AddCellString(Trim(RNQuery.FieldByName('State').AsString));
      Row.AddCellString(Trim(RNQuery.FieldByName('ZIP').AsString));

      if IncludeServiceName then Row.AddCellString(Trim(RNQuery.FieldByName('CashServiceName').AsString));
      if IncludeProfileFields then begin
         if PreviousRNID <> Trim(RNQuery.FieldByName('StoreCode').AsString) then begin
            ProfileXML := TTProfileXML.Create(StrToInt(Trim(RNQuery.FieldByName('StoreCode').AsString)), HDQuery);
            CustomField1Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/VALUE', '');
            CustomField2Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/VALUE', '');
            CustomField3Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/VALUE', '');
            CustomField4Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/VALUE', '');
            CustomField5Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/VALUE', '');
            CustomField6Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/VALUE', '');
         end;

         Row.AddCellString(CustomField1Value);
         Row.AddCellString(CustomField2Value);
         Row.AddCellString(CustomField3Value);
         Row.AddCellString(CustomField4Value);
         Row.AddCellString(CustomField5Value);
         Row.AddCellString(CustomField6Value);
      end;
   end;

   Procedure FormatJSON;
   begin
      JSON.Append('{"RNID":"' + Trim(RNQuery.FieldByName('StoreCode').AsString) + '",');

      if DisplayStoreName then begin //2018-30-2018 bls: F#1129
         JSON.Append('"Store Name":"' + Trim(RNQuery.FieldByName('NAME').AsString) + '",');
      end;

      if (DisplayInTZ) then begin
         if DisplayInAMPM then begin
            JSON.Append('"Tran Date":"' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByname('authdatetz').AsDateTime) + '",');
         end else begin
            JSON.Append('"Tran Date":"' + FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('authdatetz').AsDateTime) + '",');
         end;
      end else begin
         JSON.Append('"Tran Date":"' + FormatDateTime('MM/DD/YYYY HH:NN:SS',RNQuery.FieldByName('TranDate').AsDateTime) + '",');
      end;

      JSON.Append('"Type":"' + Trim(RNQuery.FieldByName('TranType').AsString) + '",');
      If Trim(RNQuery.FieldByName('TranType').AsString) = 'REFUND' then begin
         JSON.Append('"Amount":"' + '-$' + Trim(StriReal(RNQuery.FieldByName('TranAmt').AsFloat,2)) + '",');
      end else begin
         JSON.Append('"Amount":"$' + Trim(StriReal(RNQuery.FieldByName('TranAmt').AsFloat,2)) + '",');
      end;

      JSON.Append('"Tran Type":"' + Trim(RNQuery.FieldByName('CurrencyType').AsString) + '",');
      JSON.Append('"Employee Ident":"' + Trim(RNQuery.FieldByName('EmpIdent').AsString) + '",');
      JSON.Append('"'+ TranIdentHeader +'":"' + Trim(RNQuery.FieldByName('TranIdent').AsString) + '",');   //2018-4-24 bls: F#3735
      JSON.Append('"'+ CustIdentHeader +'":"' + Trim(RNQuery.FieldByName('CustIdent').AsString) + '",');   //2018-4-24 bls: F#3735

      if (DisplayInTZ) then begin
         if DisplayInAMPM then begin
            JSON.Append('"Batch Date":"' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByname('BatchDatetz').AsDateTime) + '",');
         end else begin
            JSON.Append('"Batch Date":"' + FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('BatchDatetz').AsDateTime) + '",');
         end;
      end else begin
         JSON.Append('"Batch Date":"' + FormatDateTime('MM/DD/YYYY HH:NN:SS',RNQuery.FieldByName('BatchDate').AsDateTime) + '",');
      end;

      JSON.Append('"Batch ID":"' + Trim(RNQuery.FieldByName('BatchCode').AsString) + '",');
      JSON.Append('"Station":"' + Trim(RNQuery.FieldByName('StationIdent').AsString) + '",');
      JSON.Append('"Station Code":"' + Trim(RNQuery.FieldByName('StoreSystemCode').AsString) + '",');

      if IncludeServiceName then begin
         JSON.Append('"Service Name":"' + Trim(RNQuery.FieldByName('CashServiceName').AsString) + '",');
      end;
      if IncludeProfileFields then begin
         if PreviousRNID <> Trim(RNQuery.FieldByName('StoreCode').AsString) then begin
            ProfileXML := TTProfileXML.Create(StrToInt(Trim(RNQuery.FieldByName('StoreCode').AsString)), HDQuery);
            CustomField1Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/VALUE', '');
            CustomField2Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/VALUE', '');
            CustomField3Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/VALUE', '');
            CustomField4Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/VALUE', '');
            CustomField5Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/VALUE', '');
            CustomField6Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/VALUE', '');
         end;
         JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/NAME', '') + '":"' + CustomField1Value + '",');
         JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/NAME', '') + '":"' + CustomField2Value + '",');
         JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/NAME', '') + '":"' + CustomField3Value + '",');
         JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/NAME', '') + '":"' + CustomField4Value + '",');
         JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/NAME', '') + '":"' + CustomField5Value + '",');
         JSON.Append('"' + ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/NAME', '') + '":"' + CustomField6Value + '",');
      end;

      JSON.Append('"Store Name":"' + Trim(RNQuery.FieldByName('Name').AsString) + '",');
      JSON.Append('"Store City":"' + Trim(RNQuery.FieldByName('City').AsString) + '",');
      JSON.Append('"Store State":"' + Trim(RNQuery.FieldByName('State').AsString) + '",');
      JSON.Append('"Store ZIP":"' + Trim(RNQuery.FieldByName('ZIP').AsString) + '"}');
   end;

   Procedure FormatGRID; //2018-06-20 bls: F#840
   begin

      GRID.Append('<row>');

      GRID.Append('<cell>' + Trim(RNQuery.FieldByName('StoreCode').AsString) + '</cell>');

      if DisplayStoreName then begin
         GRID.Append('<cell>' + Trim(RNQuery.FieldByName('NAME').AsString) + '</cell>');
      end;

      if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620
         if DisplayInAMPM then begin
            GRID.Append('<cell>' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByname('authdatetz').AsDateTime)) + '</cell>');
         end else begin
            GRID.Append('<cell>' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('authdatetz').AsDateTime)) + '</cell>');
         end;
      end else begin
         GRID.Append('<cell>' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('TranDate').AsDateTime)) + '</cell>');
      end;
      GRID.Append('<cell>' + Trim(RNQuery.FieldByName('TranType').AsString) + '</cell>');

      If Trim(RNQuery.FieldByName('TranType').AsString) = 'REFUND' then begin
         GRID.Append('<cell><![CDATA[<IMG SRC="/Images/General/CashSmall.gif" border="0" style="display: inline-block">');
      end else If (Trim(RNQuery.FieldByName('TranType').AsString) = 'VOID') or (Trim(RNQuery.FieldByName('TranType').AsString) = 'CRVOID') then begin
         GRID.Append('<cell><![CDATA[<IMG SRC="/Images/General/YellowExclamation.gif" border="0" style="display: inline-block">');
      end else begin
         GRID.Append('<cell><![CDATA[<IMG SRC="/Images/General/CheckSuccess.gif" border="0" style="display: inline-block">');
      end;

      If Trim(RNQuery.FieldByName('TranType').AsString) = 'REFUND' then begin
         GRID.Append('(' + Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat]) + ')]]></cell>');
      end else If (Trim(RNQuery.FieldByName('TranType').AsString) = 'VOID') or (Trim(RNQuery.FieldByName('TranType').AsString) = 'CRVOID') then begin
         GRID.Append('<DEL>' + Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat]) + '</DEL>]]></cell>');
      end else begin
         GRID.Append(Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat]) + ']]></cell>');
      end;

      GRID.Append('<cell>' + Trim(RNQuery.FieldByName('CurrencyType').AsString) + '</cell>');
      GRID.Append('<cell>' + Trim(RNQuery.FieldByName('EmpIdent').AsString) + '</cell>');
      GRID.Append('<cell>' + Trim(RNQuery.FieldByName('TranIdent').AsString) + '</cell>');
      GRID.Append('<cell>' + Trim(RNQuery.FieldByName('CustIdent').AsString) + '</cell>');

      if (DisplayInTZ) then begin
         if DisplayInAMPM then begin
            GRID.Append('<cell>' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByname('BatchDatetz').AsDateTime)) + '</cell>');
         end else begin
            GRID.Append('<cell>' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('BatchDatetz').AsDateTime)) + '</cell>');
         end;
      end else begin
         GRID.Append('<cell>' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('BatchDate').AsDateTime)) + '</cell>');
      end;

      GRID.Append('<cell>' + Trim(RNQuery.FieldByName('BatchCode').AsString) + '</cell>');
      if IncludeServiceName then GRID.Append('<cell>' + Trim(RNQuery.FieldByName('CashServiceName').AsString) + '</cell>');

      GRID.Append('<cell>' + Trim(RNQuery.FieldByName('StationIdent').AsString) + '</cell>');

      If ShowLinks then begin
         if (AllowAll) and (RNID = 'ALL') then begin
            GRID.Append('<cell><![CDATA[<a href="javascript://" onclick="GetVTCashDetailAJAX(''' + trim(RNQuery.FieldByName('StoreCode').AsString)+ ''','''+ trim(RNQuery.FieldByName('StoreSystemCode').AsString) + ''')">' + Trim(RNQuery.FieldByName('StoreSystemCode').AsString) + '</a>]]></cell>');
         end else begin
            GRID.Append('<cell><![CDATA[<a href="javascript://" onclick="GetVTCashDetailAJAX(''' + RNID+ ''','''+ trim(RNQuery.FieldByName('StoreSystemCode').AsString) + ''')">' + Trim(RNQuery.FieldByName('StoreSystemCode').AsString) + '</a>]]></cell>');
         end;
      end else begin
         GRID.Append('<cell>' + Trim(RNQuery.FieldByName('StoreSystemCode').AsString) + '</cell>');
      end;
      GRID.Append('</row>');
   end;

   Procedure FormatGRIDJSON; //2018-07-18 bls: F#4978
   var
      storeCodeL, storeSysCodeL, tranTypeL, tranAmtL : string;
   begin
      storeCodeL := Trim(RNQuery.FieldByName('StoreCode').AsString);
      storeSysCodeL := trim(RNQuery.FieldByName('StoreSystemCode').AsString);
      tranTypeL := Trim(RNQuery.FieldByName('TranType').AsString);
      tranAmtL := Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat]);

      GRID.Add('{"id":' + RNQuery.FieldByName('row').AsString + ',"data":[');

      GRID.Add('"' + storeCodeL + '",');

      if DisplayStoreName then begin
         GRID.Add('"' + Trim(RNQuery.FieldByName('NAME').AsString) + '",');
      end;

      if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620
         if DisplayInAMPM then begin
            GRID.Add('"' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByname('authdatetz').AsDateTime)) + '",');
         end else begin
            GRID.Add('"' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('authdatetz').AsDateTime)) + '",');
         end;
      end else begin
         GRID.Add('"' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('TranDate').AsDateTime)) + '",');
      end;
      GRID.Add('"' + tranTypeL + '",');

      If tranTypeL = 'REFUND' then begin
         GRID.Add('"<IMG SRC=\"\/Images\/General\/CashSmall.gif\" border=\"0\" style=\"display: inline-block\">');
         GRID.Add('(' + tranAmtL + ')",');
      end else If (tranTypeL = 'VOID') or (tranTypeL = 'CRVOID') then begin
         GRID.Add('"<IMG SRC=\"\/Images\/General\/YellowExclamation.gif\" border=\"0\" style=\"display: inline-block\">');
         GRID.Add('<DEL>' + tranAmtL + '<\/DEL>",');
      end else begin
         GRID.Add('"<IMG SRC=\"\/Images\/General\/CheckSuccess.gif\" border=\"0\" style=\"display: inline-block\">');
         GRID.Add(tranAmtL + '",');
      end;

      GRID.Add('"' + Trim(RNQuery.FieldByName('CurrencyType').AsString) + '",');
      GRID.Add('"' + Trim(RNQuery.FieldByName('EmpIdent').AsString) + '",');
      GRID.Add('"' + Trim(RNQuery.FieldByName('TranIdent').AsString) + '",');
      GRID.Add('"' + Trim(RNQuery.FieldByName('CustIdent').AsString) + '",');

      if (DisplayInTZ) then begin
         if DisplayInAMPM then begin
            GRID.Add('"' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByname('BatchDatetz').AsDateTime)) + '",');
         end else begin
            GRID.Add('"' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('BatchDatetz').AsDateTime)) + '",');
         end;
      end else begin
         GRID.Add('"' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('BatchDate').AsDateTime)) + '",');
      end;

      GRID.Add('"' + Trim(RNQuery.FieldByName('BatchCode').AsString) + '",');

      if IncludeServiceName then GRID.Add('"' + Trim(RNQuery.FieldByName('CashServiceName').AsString) + '",');

      GRID.Add('"' + Trim(RNQuery.FieldByName('StationIdent').AsString) + '",');

      If ShowLinks then begin
         if (AllowAll) and (RNID = 'ALL') then begin
            GRID.Add('"<a href=\"javascript://\" onclick=\"GetVTCashDetailAJAX(''' + storeCodeL + ''',''' + storeSysCodeL + ''')\">' + storeSysCodeL + '<\/a>"]}');
         end else begin
            GRID.Add('"<a href=\"javascript:\/\/\" onclick=\"GetVTCashDetailAJAX(''' + RNID + ''','' '+ storeSysCodeL + ''')\">' + storeSysCodeL + '<\/a>"]}');
         end;
      end else begin
         GRID.Add('"' + storeSysCodeL + '"]}');
      end;
   end;


   Procedure FormatHTML;
   begin
      inc(ReturnedRecs);

      HTML.Append('<TR><TD>' + RNQuery.FieldByName('StoreCode').AsString + '</TD>');

      if DisplayStoreName then begin
         HTML.Append('<TD>' + RNQuery.FieldByName('NAME').AsString + '</TD>');
      end;

      if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620
         if DisplayInAMPM then begin
            HTML.Append('<TD>' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByname('authdatetz').AsDateTime)+ '</TD>');
         end else begin
            HTML.Append('<TD>' + FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('authdatetz').AsDateTime)+ '</TD>');
         end;
      end else begin
         HTML.Append('<TD>' + FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('TranDate').AsDateTime) + '</TD>');
      end;
      HTML.Append('<TD>' + RNQuery.FieldByName('TranType').AsString + '</TD>');

      If Trim(RNQuery.FieldByName('TranType').AsString) = 'REFUND' then begin
         HTML.Append('    <TD align="Right">(' + Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat]) + ')</TD>');
      end else If (Trim(RNQuery.FieldByName('TranType').AsString) = 'VOID') or (Trim(RNQuery.FieldByName('TranType').AsString) = 'CRVOID') then begin
         HTML.Append('    <TD align="Right"><DEL>' + Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat]) + '</DEL></TD>');
      end else begin
         HTML.Append('    <TD align="Right">' + Format('%m',[RNQuery.FieldByName('TranAmt').AsFloat]) + '</TD>');
      end;

      If Trim(RNQuery.FieldByName('TranType').AsString) = 'REFUND' then begin
         HTML.Append('    <TD><IMG SRC="/Images/General/CashSmall.gif" border="0"></TD>');
         AddAmt(RefundCash, RefundVoucher, RefundQCash, RefundQVoucher);
         ProcessLog(ltinfo,'GetCashQueryTable','PostAddAmt: '+IntToStr(RefundCash) + IntToStr(RefundVoucher)+IntToStr(RefundQCash) + IntToStr(RefundQVoucher));
      end else If (Trim(RNQuery.FieldByName('TranType').AsString) = 'VOID') or (Trim(RNQuery.FieldByName('TranType').AsString) = 'CRVOID') then begin
         HTML.Append('    <TD><IMG SRC="/Images/General/YellowExclamation.gif" border="0"></TD>');
         AddAmt(VoidCash, VoidVoucher, VoidQCash, VoidQVoucher);
      end else begin
         HTML.Append('    <TD><IMG SRC="/Images/General/CheckSuccess.gif" border="0"></TD>');
         AddAmt(SaleCash, SaleVoucher, SaleQCash, SaleQVoucher);
      end;

      HTML.Append('    <TD>' + RNQuery.FieldByName('CurrencyType').AsString + '</TD>');
      HTML.Append('    <TD>' + RNQuery.FieldByName('EmpIdent').AsString + '</TD>');
      HTML.Append('    <TD>' + RNQuery.FieldByName('TranIdent').AsString + '</TD>');
      HTML.Append('    <TD>' + RNQuery.FieldByName('CustIdent').AsString + '</TD>');

      if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620
         if DisplayInAMPM then begin
            HTML.Append('<TD>' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM', RNQuery.FieldByname('BatchDatetz').AsDateTime)+ '</TD>');
         end else begin
            HTML.Append('<TD>' + FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByname('BatchDatetz').AsDateTime)+ '</TD>');
         end;
      end else begin
         HTML.Append('<TD>' + FormatDateTime('MM/DD/YYYY HH:NN:SS', RNQuery.FieldByName('BatchDate').AsDateTime) + '</TD>');
      end;
      HTML.Append('    <TD>' + RNQuery.FieldByName('BatchCode').AsString + '</TD>');

      if IncludeServiceName then HTML.Append('    <TD>' + Trim(RNQuery.FieldByName('CashServiceName').AsString) + '</TD>');


      HTML.Append('<TD>' + Trim(RNQuery.FieldByName('StationIdent').AsString) + '</TD>');

      If ShowLinks then begin
         if (AllowAll) and (RNID = 'ALL') then begin
            HTML.Append('<TD><a href="javascript://" onclick="GetVTCashDetailAJAX(''' + trim(RNQuery.FieldByName('StoreCode').AsString)+ ''','''+ trim(RNQuery.FieldByName('StoreSystemCode').AsString) + ''')">' + RNQuery.FieldByName('StoreSystemCode').AsString+ '</a></TD>');
         end else begin
            HTML.Append('<TD><a href="javascript://" onclick="GetVTCashDetailAJAX(''' + RNID+ ''','''+ trim(RNQuery.FieldByName('StoreSystemCode').AsString) + ''')">' + RNQuery.FieldByName('StoreSystemCode').AsString+ '</a></TD>');
         end;
      end else begin
         HTML.Append('<TD>' + RNQuery.FieldByName('StoreSystemCode').AsString + '</TD>');
      end;
      HTML.Append('</TR>');
   end;

   Procedure ProcessFooter;
   begin
      HTML.Append('</TABLE>');
      HTML.Append('<BR><BR>');
      HTML.Append('<TABLE border="1" cellspacing="0" cellpadding="3" bordercolorlight="#0000FF" style="border-collapse: collapse">'+
               '<TR><TD ALIGN=''CENTER''><B>TOTALS</B></TD>'+
               '    <TD ALIGN=''CENTER'' colspan=2><B>Cash</B></TD>'+
               '    <TD ALIGN=''CENTER'' colspan=2><B>Voucher</B></TD>'+
               '    <TD ALIGN=''CENTER'' colspan=2><B>All Transactions</B></TD>'+
               '</TR>'+
               '<TR><TD><B><IMG SRC="/Images/General/CheckSuccess.gif" border="0"> Sale</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%d',[SaleQCash])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[SaleCash/100])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%d',[SaleQVoucher])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[SaleVoucher/100])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%d',[SaleQCash + SaleQVoucher])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[(SaleCash + SaleVoucher )/100])+'</TD>'+

               '</TR>'+
               '<TR><TD><B><IMG SRC="/Images/General/CashSmall.gif" border="0"> Refund</B></TD>'+
               '    <TD align=''RIGHT''>'+ Format('%d',[RefundQCash])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[RefundCash/100])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%d',[RefundQVoucher])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[RefundVoucher/100])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%d',[RefundQCash + RefundQVoucher])+'</TD>'+
               '    <TD align=''RIGHT''>('+ Format('%m',[(RefundCash + RefundVoucher)/100])+')</TD>'+

               '</TR>'+
               '<TR><TD><B><IMG SRC="/Images/General/CashSmall.gif" border="0"> NET</B></TD>'+
               '    <TD colspan="4"></TD>'+ //spacer
               '    <TD align=''RIGHT''>'+ Format('%d',[SaleQCash + SaleQVoucher + RefundQCash + RefundQVoucher])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[((SaleCash + SaleVoucher) - (RefundCash + RefundVoucher))/100])+'</TD>'+

               '</TR>'+



               '<TR><TD><B><IMG SRC="/Images/General/YellowExclamation.gif" border="0"> Voids</B></TD>'+
               '    <TD align=''RIGHT''>'+ Format('%d',[VoidQCash])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[VoidCash/100])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%d',[VoidQVoucher])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[VoidVoucher/100])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%d',[VoidQCash + VoidQVoucher])+'</TD>'+
               '    <TD align=''RIGHT''>'+ Format('%m',[(VoidCash + VoidVoucher)/100])+'</TD>'+

               '</TR>'+
               '</TABLE><BR>');
   end;

   Function getColumnName(gridColumn : string) : string; //2018-06-20 bls: F#840
   var
      sqlColName : string;

      tranIdent, custIdent, itemSerial : string;
   begin
      sqlColName := '';

      tranIdent := ValidCharsOnly(Trim(tranIdentHeader),true,false,'');
      custIdent := ValidCharsOnly(Trim(custIdentHeader),true,false,'');

      if StoreSystemCodeLabel <> '' then begin
         itemSerial := ValidCharsOnly(Trim(StoreSystemCodeLabel), true, false, '');
      end else begin
         itemSerial := 'ItemSerial';
      end;

      if gridColumn = 'RNID' then sqlColName := 'ca.StoreCode'
      else if gridColumn = 'StoreName' then sqlColName := 's.Name'
      else if gridColumn = 'TranDate' then sqlColName := 'ca.Trandate'
      else if gridColumn = 'Type' then sqlColName := 'ca.TranType'
      else if gridColumn = 'Amount' then sqlColName := 'ca.TranAmt'
      else if gridColumn = 'TranType' then sqlColName := 'ca.CurrencyType'
      else if gridColumn = 'EmpIdent' then sqlColName := 'ca.EmpIdent'
      else if gridColumn = tranIdent then sqlColName := 'ca.TranIdent'
      else if gridColumn = custIdent then sqlColName := 'ca.CustIdent'
      else if gridColumn = 'BatchDate' then sqlColName := 'ca.BatchDate'
      else if gridColumn = 'BatchID' then sqlColName := 'ca.BatchCode'
      else if gridColumn = 'ServiceName' then sqlColName := 'ca.CashServiceName'
      else if gridColumn = 'StationIdent' then sqlColName := 'ca.StationIdent'
      else if gridColumn = itemSerial then sqlColName := 'ca.StoreSystemCode'
      else sqlColName :=  'ca.Trandate';

      Result := sqlColName;
   end;

begin
   If DisplayFormat = 'XML' then begin
      RecordFormatType := ttrftXML;
      CSV := TstringList.Create;
   end else If DisplayFormat = 'XLS' then begin
      RecordFormatType := ttrftXLS;
   end else If DisplayFormat = 'JSON' then begin
      RecordFormatType := ttrftJSON;
      JSON := TStringList.Create;
   end else If DisplayFormat = 'GRID' then begin
      RecordFormatType := ttrftGRID;
      GRID := TstringList.Create;
   end else If DisplayFormat = 'AJAX' then begin
      RecordFormatType := ttrftAJAX;
      HTML := TStringList.Create;
   end else begin
      RecordFormatType := ttrftHTML;
      HTML := TStringList.Create;
   end;

   IncludeServiceName := false;
   IncludeEmpIdent := false;
   IncludeProfileFields := false;
   IncludeCardHolderName := false;
   ExcludeExtraAmount := false;
   AllowAll := false;
   UsingAll := false;
   RNIDList := TStringList.Create;
   DisplayStoreName := false; //2018-30-2018 bls: F#1129
   DateRange := '';
   StoreSystemCodeLabel := '';
   ParameterList := TStringList.Create(); //2018-06-20 bls: F#840
   QueryBuilder := TStringList.Create(); //2018-06-20 bls: F#840

   TranIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CASHTRANIDENTDESC', 'Tran Ident')); //2018-4-24 bls: F#3735
   CustIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CASHCUSTIDENTDESC', 'Cust Ident')); //2018-4-24 bls: F#3735

   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CASHHISTDISPLAYSTORENAME', 'FALSE') = 'TRUE' then DisplayStoreName := true; //2018-30-2018 bls: F#1129
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/ALLOWALLSEARCH', 'FALSE') = 'TRUE' then AllowAll := true;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL', '') <> '' then StoreSystemCodeLabel := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL'));  //2016-8-08 jtm: Feat OT#1038
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESERVICENAME', 'FALSE') = 'TRUE' then IncludeServiceName := true;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEPROFILEFIELDS', 'FALSE') = 'TRUE' then IncludeProfileFields := true;
   useJSONResp := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEJSONFORGRIDS','TRUE')); //2018-07-18 bls: F#4978

   DisplayInTZ := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE'));
   DisplayInAMPM := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINAMPM', 'FALSE'));

   if not (DisplayInTZ) then begin
      if (RNReg.RegGetValAsString('PMACCESS.DISPLAYINTZ','FALSE') = 'TRUE') then begin //for APM
         DisplayInTZ := true;
      end;
   end;
   if (AllowAll) and (RNID = 'ALL') then begin
      GetChainRNIDs(RNIDList);
      UsingAll := true;
   end else begin
      If NOT ValidateRNID(RNID)  then begin
         Result := 'Invalid Store Code';
         exit;
      end;
      StoreInfo := GetStoreInfo(Valu(RNID));
      RNIDList.Add(NumericOnly(RNID));
   end;
   Result := '';
   
   RNQuery.Close;
   RNQuery.SQL.clear;

   ParameterList.Append(DRSQLVarsDec);
   if (DateRange = 'CUSTOM') or (DateRange = '')  then begin
      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SEARCHONDATETIME', 'FALSE') = 'TRUE') then begin //2018-08-15 bls: 542
         ParameterList.Append('set @BegDate = ''' + FormatDateTime('MM/DD/YYYY hh:nn', Fromdate) + '''; set @EndDate =''' + FormatDateTime('MM/DD/YYYY hh:nn', ThruDate + 1) + ''';');
      end else begin
         ParameterList.Append('set @BegDate = ''' + FormatDateTime('MM/DD/YYYY', Fromdate) + '''; set @EndDate =''' + FormatDateTime('MM/DD/YYYY', ThruDate + 1) + ''';');
      end;
   end else begin
      ParameterList.Append('set @DateRangeName = '''+DateRange+''';'+DRSQLSetBegDate + DRSQLSetEndDate);
   end;
   ParameterList.Append(DRSQLSetTZ);
   ParameterList.Append('set @BegDateHAST = DATEADD(hour,+'+HASTOffsetEST+',@BegDate);set @EndDateHAST = DATEADD(hour,+'+HASTOffsetEST+',@EndDate); ');

   if RecordFormatType = ttrftGRID then begin //2018-06-20 bls: F#840
      posStart := '0';
      count := '100';

      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['posStart']))) <> '' then begin
          posStart := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['posStart']))); // Get Starting position
      end;
      if NumericOnly(Trim(UpCaseString(Request.queryfields.Values['count']))) <> '' then begin
          count := NumericOnly(Trim(UpCaseString(Request.queryfields.Values['count']))); // Get amount of rows to receive from db
      end;
      if ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['orderby'])),true,false,'') <> '' then begin
          orderBy := Request.queryfields.Values['orderby']; // Determines which column to sort the data by
      end;
      if ValidCharsOnly(Trim(UpCaseString(Request.queryfields.Values['direct'])),true,false,'') <> '' then begin
          direction := Request.queryfields.Values['direct']; // Determines whether the data will be ascending or descending
          if direction = 'des' then direction := 'DESC';
      end;

      ParameterList.Append('Set @StartPos = ' + posStart + '; set @count = ' + count + ';');
   end;

   QueryBuilder.Append('Select');
   if (DisplayInTZ) then begin
      QueryBuilder.Append('CASE r.KeyValue WHEN ''AST'' THEN DATEADD(hour,+1,ca.Trandate) WHEN ''CST'' THEN DATEADD(hour,-1,ca.Trandate) WHEN ''MST'' THEN DATEADD(hour,-2,ca.Trandate) ');
      QueryBuilder.Append('WHEN ''PST'' THEN DATEADD(hour,-3,ca.Trandate) WHEN ''AKST'' THEN DATEADD(hour,-4,ca.Trandate)');
      QueryBuilder.Append('WHEN ''HAST'' THEN DATEADD(hour,-'+HASTOffsetEST+',ca.Trandate) ELSE ca.Trandate END authdatetz,');

      QueryBuilder.Append('CASE r.KeyValue WHEN ''AST'' THEN DATEADD(hour,+1,ca.BatchDate) WHEN ''CST'' THEN DATEADD(hour,-1,ca.BatchDate) WHEN ''MST'' THEN DATEADD(hour,-2,ca.BatchDate) ' +
                             'WHEN ''PST'' THEN DATEADD(hour,-3,ca.BatchDate) WHEN ''AKST'' THEN DATEADD(hour,-4,ca.BatchDate)' +
                             'WHEN ''HAST'' THEN DATEADD(hour,-'+HASTOffsetEST+',ca.BatchDate) ELSE ca.BatchDate END BatchDatetz,');
   end;
   QueryBuilder.Append('S.SystemCode RNID, ca.*,s.Name,s.City,s.State,s.ZIP');

   if RecordFormatType = ttrftGRID then begin //2018-06-20 bls: F#840
      if orderBy = '' then begin
         QueryBuilder.Append(',ROW_NUMBER() OVER (ORDER BY ca.TranDate) as row');
      end else begin
         QueryBuilder.Append(',ROW_NUMBER() OVER (ORDER BY ' + getColumnName(orderBy) + ' ' + direction + ') as row');
      end;
   end;

   QueryBuilder.Append('from Cash ca');
   QueryBuilder.Append('left outer join Store s on ca.StoreCode = s.SystemCode');

   if (DisplayInTZ) then begin
      QueryBuilder.Append('left outer join REGISTRY r on r.SubKey1 = ca.storecode');
   end;
   QueryBuilder.Append('where (ca.StoreCode in (' + RNIDList.CommaText + '))');

   if (DisplayInTZ) then begin
      QueryBuilder.Append('and r.subkey2 = ''storetz''');
      QueryBuilder.Append('and (Trandate >= case r.KeyValue WHEN ''AST'' THEN @BegDateAST WHEN ''CST'' THEN @BegDateCST WHEN ''MST'' THEN @BegDateMST WHEN ''PST'' THEN @BegDatePST WHEN ''AKST'' THEN @BegDateAKST WHEN ''HAST'' THEN @BegDateHAST ELSE @BegDate END)'); //figure out DST for AZ and HI
      QueryBuilder.Append('and (Trandate < case r.KeyValue WHEN ''AST'' THEN @EndDateAST WHEN ''CST'' THEN @EndDateCST WHEN ''MST'' THEN @EndDateMST WHEN ''PST'' THEN @EndDatePST WHEN ''AKST'' THEN @EndDateAKST WHEN ''HAST'' THEN @EndDateHAST ELSE @EndDate END)');
   end else begin
      QueryBuilder.Append('and (Trandate >= @BegDate)');
      QueryBuilder.Append('and (Trandate < @EndDate)');
   end;

   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHEMPIDENT', 'FALSE') = 'TRUE') and (ValidCharsonly(Request.queryfields.Values['EMPIDENT'],True,True,'') <> '') then begin
      QueryBuilder.Append('And (EmpIdent LIKE ''' + ValidCharsonly(Request.queryfields.Values['EMPIDENT'],True,True,'_- ') + '%'')'); //2018-04-26 bls D#2533
   end;

   SaleType := UpCaseString(AlphaOnly(SaleType));
   If SaleType <> '' then
      QueryBuilder.Append('And (TranType=''' + SaleType + ''')');

   StationIdent := ValidCharsOnly(StationIdent,True,True,'-._');
   If StationIdent <> '' then
      QueryBuilder.Append('And (StationIdent =''' + StationIdent + ''')');

   if VarEvaluator.GetValueAsString('CASHCURTYPE') <> '' then
      QueryBuilder.Append('And (CurrencyType =''' + trim(VarEvaluator.GetValueAsString('CASHCURTYPE')) + ''')');

   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHTRANIDENT', 'FALSE') = 'TRUE') and (ValidCharsonly(Request.queryfields.Values['TRANIDENT'],True,True,'.-_:/& ') <> '') then begin   //2017-05-10 jtm: D#1605
      QueryBuilder.Append('And (TranIdent LIKE ''' + ValidCharsonly(Request.queryfields.Values['TRANIDENT'],True,True,'.-_:/& ') + '%'')'); //2018-04-26 bls D#2533
   end;
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHDOLLARAMT', 'FALSE') = 'TRUE') and (ValidCharsonly(Request.queryfields.Values['DOLLARAMT'],False,True,'.') <> '') then begin
      if (NumericOnly(Request.queryfields.Values['DOLLARAMTCOMP']) = '0') then begin
          QueryBuilder.Append('And (TranAmt = ''' + ValidCharsonly(Request.queryfields.Values['DOLLARAMT'],false,True,'.') + ''')');
      end else if(NumericOnly(Request.queryfields.Values['DOLLARAMTCOMP']) = '1') then begin
          QueryBuilder.Append('And (TranAmt > ''' + ValidCharsonly(Request.queryfields.Values['DOLLARAMT'],false,True,'.') + ''')');
      end else if (NumericOnly(Request.queryfields.Values['DOLLARAMTCOMP']) = '2') then begin
          QueryBuilder.Append('And (TranAmt < ''' + ValidCharsonly(Request.queryfields.Values['DOLLARAMT'],false,True,'.') + ''')');
      end;
   end;
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHCUSTIDENT', 'FALSE') = 'TRUE') and (ValidCharsonly(Request.queryfields.Values['CUSTIDENT'],True,True,'.-_:/& ') <> '') then begin
      QueryBuilder.Append('And (CustIdent LIKE ''' + ValidCharsonly(Request.queryfields.Values['CUSTIDENT'],True,True,'.-_:/& ') + '%'')'); //2017-05-10 jtm D#1605
   end;

   ProcessLog(ltDebug,'GetCashQueryTable SQL Text', ParameterList.Text + QueryBuilder.Text);

   if RecordFormatType = ttrftGRID then begin //2018-06-20 bls: F#840
      if StrToInt(posStart) = 0 then begin
         RNQuery.SQL.Append(parameterList.Text + ' SELECT COUNT(*) as totalCount FROM(' + QueryBuilder.Text + ') as a');
         RNQuery.Open();
         totalCount := RNQuery.FieldByName('totalCount').AsString;
         SessionVarEval.AddValue('cashTotalCount', totalCount);
         ProcessLog(ltinfo, 'getCardQueryTable', 'Query Opened: Total Record Count: ' + totalCount);
      end;
      RNQuery.Close();
      RNQuery.SQL.Clear();

      RNQuery.SQL.Append(ParameterList.Text + ' SELECT * FROM(' + QueryBuilder.Text + ') as a WHERE row between (@StartPos + 1) and (@StartPos + @count)');
   end else begin
      QueryBuilder.Append('Order by Trandate');
      RNQuery.SQL.Append(ParameterList.Text + QueryBuilder.Text);
   end;

   RNQuery.Open;

   ParameterList.Free();
   QueryBuilder.Free();

   TotalRecs := RNQuery.RecordCount;
   ReturnedRecs := 0;
   StartRow := 1;

   if RecordFormatType = ttrftJSON then begin
      JSON.Append('[');
   end;

   I := 0;
   TabText := '';
   PreviousRNID := '';

   if RecordFormatType in [ttrftAJAX, ttrftHTML] then begin
      WS := 'Cash Transactions from ' + FormatDateTime('MM/DD/YYYY',Fromdate) + ' Thru ' +FormatDateTime('MM/DD/YYYY',Thrudate) + ' <BR><B>' + RNID + '<BR>' + StoreInfo + '</B><BR>'  ;
      HTML.Add(WS);
   end;

   if xExport <> nil then begin
      xlsWorkSheet := xExport.AddWorkSheet;
   end;

   If RNquery.RecordCount > 0 then begin
      RNQuery.DisableControls;

      ProcessHeader(Trim(RNQuery.FieldByName('RNID').AsString), not(RNQuery.FieldByName('StoreCode').IsNull));

      Repeat
         Inc(I);
         case RecordFormatType of
            ttrftXML: FormatXML;
            ttrftXLS: FormatXLS;
            ttrftJSON: FormatJSON;
            ttrftGRID: begin //2018-06-20 bls: F#840
               If I = 1 then begin
                  if useJSONResp then begin //2018-07-18 bls: F#4978
                     GRID.Add('{"total_count":' + SessionVarEval.GetValueAsString('cashTotalCount') + ',"pos":' + posStart + ',"rows":[');
                  end else begin
                     GRID.Add('<?xml version="1.0" encoding="UTF-8"?><rows total_count=''' + SessionVarEval.GetValueAsString('cashTotalCount') + ''' pos= ''' + posStart + '''>');
                  end;
               end;
               if useJSONResp then begin //2018-07-18 bls: F#4978
                  FormatGridJSON;
               end else begin
                  FormatGrid;
               end;
            end;
            ttrftHTML,
            ttrftAJAX: begin
               if I >= StartRow then begin
                  FormatHTML;
               end;
            end;
         end;
         
         PreviousRNID := Trim(RNQuery.FieldByName('StoreCode').AsString);
         
         RNQuery.Next;

         if (NOT RNQuery.EOF) AND (RecordFormatType = ttrftJSON) then JSON.Add(',');
         if (NOT RNQuery.EOF) AND (RecordFormatType = ttrftGRID) AND useJSONResp then GRID.Add(',');
      Until RNQuery.EOF;

      if (PreviousRNID <> Null) AND (RecordFormatType in [ttrftAJAX, ttrftHTML]) then begin  //Do the last footer
         ProcessFooter;
      end;

   end else begin // Empty content
      WS := '';
   end;
   
   case RecordFormatType of
      ttrftXML: begin
         Result := CSV.Text;
      end;
      ttrftXLS: begin
         Result := '';
      end;
      ttrftJSON: begin
         JSON.Add(']');
         Result := TextWithoutNewLine(JSON);
      end;
      ttrftGRID: begin //2018-06-20 bls: F#840
         if RNQuery.RecordCount = 0 then begin
            if useJSONResp then begin //2018-07-18 bls: F#4978
               GRID.Add('{"total_count":0,"pos":0,"rows":[');
            end else begin
               GRID.Add('<?xml version="1.0" encoding="UTF-8"?><rows total_count=''0'' pos= ''0''>');
            end;
         end;
         if useJSONResp then begin //2018-07-18 bls: F#4978
            GRID.Add(']}');
            Result := TextWithoutNewLine(GRID);
         end else begin
            Result := GRID.Text + '</rows>';
         end;
      end;
      ttrftHTML: begin
         Result := HTML.Text;
      end;
      ttrftAJAX: begin
         Result := HTML.Text;
      end;
   end;

   RNIDList.Free;
   if assigned(HTML) then HTML.Free;
   if assigned(CSV) then CSV.Free;
   if assigned(JSON) then JSON.Free;
   if assigned(GRID) then GRID.Free; //2018-06-20 bls: F#840
end;

function TCustomerInfoModule.EmployeeXMLGetTag(TagName: String): String;
begin
   Result := '';
   If not Assigned(EmployeeXML) then exit;
   Try
      Result := EmployeeXML.GetValueAsWideString(TagName);
   except
      On E:Exception do begin
      end;
   end;
end;

function TCustomerInfoModule.EmployeeXMLGetTag(TagName,Default: String): String;
begin
    Result := EmployeeXMLGetTag(TagName);
   If Result = '' then Result := Default;
end;

procedure TCustomerInfoModule.EmployeeXMLSetTag(TagName, Value: String);
var
NewNodeName :string;
XpathExp : string;
posit : integer;
NewNodeAtt : string;
NewNodeAttVal : string;
NewNode : TOpenXMLNode;
begin
   if not Assigned(EmployeeXML) then exit;
   XMLSetTag(EmployeeXML,TagName,Value);
   end;

function TCustomerInfoModule.BuildEmployeeXML(ADS: TDataSet): string;
var
   EMPXML : String;
   ASL : TStringList;
   I : Integer;
   procedure AddField(FieldName : String);
   begin
      EmpXML := EmpXML + '<' + FieldName + '>' + ToUTF(Trim(ADS.FieldByName(FieldName).AsString)) + '</' + FieldName + '>' + CRLF ;
   end;
Begin
   ASL := TStringList.Create;
   EMPXML := '';
   AddField('USERNAME');
   AddField('LASTNAME');
   AddField('FIRSTNAME');
   AddField('MIDDLEINITIAL');
   AddField('SSN');
   AddField('DOB');
   AddField('ADDRESS1');
   AddField('ADDRESS2');
   AddField('ADDRESS3');
   AddField('CITY');
   AddField('STATE');
   AddField('POSTALCODE');
   AddField('HOMEPHONE');
   AddField('ALTERNATEPHONE');
   AddField('EMERGENCYPHONE');
   AddField('EMERGENCYCONTACT');
   AddField('RELATIONSHIP');
   AddField('CITIZEN');
   AddField('TITLE');
   AddField('PAYTYPE');
   AddField('PAYRATE');
   AddField('STARTDATE');
   AddField('TERMDATE');
   AddField('HIREDBY');
   AddField('LASTUPDATED');
   AddField('PASSWORDHASH');
   AddField('CARDHASH');
   AddField('LASTCLOCKIN');
   AddField('LASTCLOCKOUT');
   AddField('PAYROLLID');
   AddField('LASTPASSWORDCHANGE');
   AddField('PASSWORDDOESNOTEXPIRE');
   AddField('LASTLOGIN');
   AddField('LASTFAILEDLOGIN');
   AddField('FAILEDLOGINCOUNT');
   AddField('LOCKEDOUTTILL');
   AddField('EMPLOYEEGUID');
   ASL.text := ADS.FieldByName('RecentPasswords').AsString;
   EmpXML := EmpXML + '<PASSWORDHISTORY>';
   For I := 0 to ASL.Count -1 do begin
      If ASL[I] <> '' then
         EmpXML := EmpXML + '<HISTORICALPASSWORDHASH>' + ASL[I]+ '</HISTORICALPASSWORDHASH>';
   end;
   EmpXML := EmpXML + '</PASSWORDHISTORY>';

   EmpXML := EmpXML + '<GROUPMEMBERSHIP>' + ADS.FieldByName('GroupMembership').AsString + '</GROUPMEMBERSHIP>';

   Result := EmpXML;
   ASL.Free;
end;

procedure TCustomerInfoModule.SetRNUser(UserName: String);
begin
   UserQuery.Close;
   UserQuery.Parameters.ParamByName('ChainCode').Value := ChainCode;
   UserQuery.Parameters.ParamByName('UserName').Value := UserName;
   UserQuery.Open;

   If UserXML = nil then exit;
   If EmployeeXML = nil then exit;

   If UserQuery.RecordCount = 1 then begin
      Processlog(ltInfo, 'SetRNUser', 'User=' +Username);
      Try
         UserQuery.Edit;
         UserQuery.FieldByName('UserProfile').AsString := UserXML.DocumentAsString;
         UserQuery.FieldByName('EmployeeXML').AsString := GetXMLTagStr(EmployeeXML.DocumentAsString,'EMPLOYEE');
         UserQuery.FieldByName('Username').AsString := Trim(GetXMLTagStr(EmployeeXML.DocumentAsString,'USERNAME'));
         UserQuery.FieldByName('GROUPMEMBERSHIP').AsString := Trim(GetXMLTagStr(EmployeeXML.DocumentAsString,'GROUPMEMBERSHIP'));
         UserQuery.FieldByName('LastUpdated').AsDateTime := NOW;

         UserQuery.Post;
      except
         On E:Exception do begin
            Processlog(ltWarning, 'SetRNUser Exception, User=' +Username,E.Message);
         end;
      end;
   end;

end;

procedure TCustomerInfoModule.XMLAddNode(XML: TOpenXML; Xpath, NewNode,value,NewNodeAttr,NewNodeAttrVal: string);
var
   ANewNodeName :string;
   AXpathExp : string;
   Apos : integer;
   ANewNodeAttr : string; //2016-09-29 jtm Feat OT# 1177
   ANewNodeAttrVal : string;
   ANewNode : TOpenXMLNode;
begin
   try
   if XML.GetNode(Xpath) = nil then begin
      Apos := LastPos('/',Xpath,false);
      ANewNodeName := Copy(Xpath, Apos+1, Length(Xpath)-Apos);
      if ANewNodeName = '' then exit;
      if (Pos('@',ANewNodeName) > 0) then begin
          ANewNodeAttr := Copy(ANewNodeName, Pos('@',ANewNodeName)+1, (Pos('=',ANewNodeName)-1)-Pos('@',ANewNodeName));
          ANewNodeAttrVal := Copy(ANewNodeName, Pos('"',ANewNodeName)+1, (LastPos('"',ANewNodeName,false)-1)-Pos('"',ANewNodeName));
          Delete(ANewNodeName,Pos('[',ANewNodeName), Pos('[',ANewNodeName) -1 + length(ANewNodeName));
      end;
      AXpathExp := LeftStr(Xpath,LastPos('/',Xpath,false)-1);
      if XML.GetNode(AXpathExp) <> nil then begin
         ANewNode := XML.AddChildNode(AXpathExp,ANewNodeName,'');
         if ANewNodeAttr <> ''  then XML.InsertNewContextAttribute(ANewNode,ANewNodeAttr,ANewNodeAttrVal);
      end else begin
         XMLAddNode(XML,AXpathExp,ANewNodeName, '',ANewNodeAttr,ANewNodeAttrVal);
      end;
   end;
   if XML.GetNode(Xpath) <> nil then begin
      ANewNode := XML.AddChildNode(Xpath,NewNode,Value);
      if NewNodeAttr <> ''  then XML.InsertNewContextAttribute(ANewNode,NewNodeAttr,NewNodeAttrVal);
   end;
   except
      on e:exception do begin
         Processlog(ltWarning, 'XMLAddNode Exception editing xml',E.Message + ';' + Xpath+ ';' +NewNode+ ';' +value+ ';' +NewNodeAttr+ ';' +NewNodeAttrVal+ ';' + XML.DocumentAsString);
         raise;
      end;
   end;
end;

function TCustomerInfoModule.GetUserQueryTable(AUsername,GUID,DisplayFormat: string; Download: Boolean): string;
var
   PosStart : string;
   QueryCount : string;
   QuerySQLText : string;
   QueryOrderBy : string;
   QueryOrderDirect : string;
   QueryTotalCount : string;
   QueryColList : TStringList;
   RNIDList : TStringList;
   ChainRNIDList : TStringList;
   StoreNameList : TStringList;
   TabLines : string;
   TabLine: string;
   StationIdent : string;
   EmpIdent : string;
   UserRNIDXML : TOpenXML;
   AXML : TOpenXML; //2018-06-20 bls: F#4654
   UserRNIDNode : TOpenXMLNode;
   UserRNIDNodeChild : TOpenXMLNode;
   UserRNIDXMLStr : string;
   ReadOnlyStr : string;
   i : integer;
   IncludeServiceName : boolean;
   ChainIndex :integer;//2017-09-20 jtm: D#1945
   IsDisplayTimeInTZ: Boolean; //2019-4-17 ss DVST-4900
   ChainCodeTZ, TZDeclareSetStmt: String; //2019-4-17 ss DVST-4900
   ActiveStr: String; //2019-5-15 SS DVST-702
   UserProfileXML: String;
begin
      ProcessLog(ltinfo,'GetUserQueryTable','Begin GetUserQueryTable');
      Result := '';
      PosStart := '0';
      QueryCount := '100';
      QuerySQLText := '';
      QueryOrderBy := '';
      QueryOrderDirect := '';
      IncludeServiceName := UpperCase(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINUSERMANAGEMENT/INCLUDESERVICENAME','FALSE')) = 'TRUE';  //2017-05-24 jtm F#1775
      RNIDList := TStringList.Create;
      StoreNameList := TStringList.Create;
      ChainRNIDList := TStringList.Create;
      GetChainRNIDs(ChainRNIDList);   //we might need this later so we call it here to not interfere with RNQuery later
      GetStoreNames(ChainRNIDList,StoreNameList);
      IsDisplayTimeInTZ := StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE')); // 2019-4-17 ss DVST-4900
      ProcessLog(ltinfo,'GetUserQueryTable','ActPosStart,ActCount,ActOrderBy,ActOrderDirect: '+PosStart +';'+QueryCount +';'+QueryOrderBy+';'+QueryOrderDirect+';');
      ActiveStr := ''; //2019-5-15 SS DVST-702

      if(IsDisplayTimeInTZ) then begin //2019-4-17 ss DVST-4900
         ChainCodeTZ := Trim(OpenXMLGetTag('/CONFIGDATA/CHAINCODETZ', ''));// 2019-4-17 ss DVST-4900
         TZDeclareSetStmt := 'Declare @timezone varchar(10);Set @timezone = ''' + ChainCodeTZ+'''; ';
         QuerySQLText := TZDeclareSetStmt + 'SELECT *, ';
         QuerySQLText := QuerySQLText + 'CASE @timezone WHEN ''AST'' THEN DATEADD(hour,+1,LastLogin) WHEN ''CST'' THEN DATEADD(hour,-1,LastLogin) WHEN ''MST'' THEN DATEADD(hour,-2,LastLogin)';
         QuerySQLText := QuerySQLText + 'WHEN ''PST'' THEN DATEADD(hour,-3,LastLogin) WHEN ''AKST'' THEN DATEADD(hour,-4,LastLogin)';
         QuerySQLText := QuerySQLText + 'WHEN ''HAST'' THEN DATEADD(hour,-'+HASTOffsetEST+',LastLogin) ELSE LastLogin END LastLogintz, ';
         QuerySQLText := QuerySQLText + ' ROW_NUMBER() OVER (ORDER BY ';
      end else begin
         QuerySQLText := 'SELECT *, ROW_NUMBER() OVER (ORDER BY ';
      end;

      QueryColList := TStringList.Create;
      QueryColList.CommaText := 'Username,Email,LastLogin,FirstName,LastName';

      if (QueryOrderBy <> '') and not(StrToInt(QueryOrderBy) >= QueryColList.Count) then begin
         QuerySQLText := QuerySQLText + QueryColList[StrToInt(QueryOrderBy)];
      end else begin
         QuerySQLText := QuerySQLText + ' Username';
      end;
      FreeAndNil(QueryColList);
      if QueryOrderDirect = 'DES' then QuerySQLText := QuerySQLText + ' desc';

      QuerySQLText := QuerySQLText +  ') as row FROM (select * from RNEmployee) as data';
      QuerySQLText := QuerySQLText + ' where ChainCode = ' + IntToStr(ChainCode);

      If GUID <> '' then begin
         QuerySQLText := QuerySQLText + ' And EmployeeGUID = ''' + GUID + '''';
      end else begin
         If AUsername <> '' then begin //2019-4-17 ss DVST-4900
            QuerySQLText := QuerySQLText + ' And UserName like ''' + AUsername + '%''';
      end;
      end;

      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Text := QuerySQLText;

      ProcessLog(ltinfo,'GetUserQueryTable','Query : '+RNQuery.SQL.text);
      RNQuery.Open;
      ProcessLog(ltinfo,'GetUserQueryTable','Query Opened; Record Count: '+IntToStr(RNQuery.RecordCount));

      If RNQuery.RecordCount > 0 then begin
         RNQuery.DisableControls;
         if DisplayFormat = 'XML' then begin
            TabLines := '<?xml version="1.0" encoding="iso-8859-1"?><rows total_count='''+IntToStr(RNQuery.RecordCount)+''' pos= '''+PosStart+'''>';
         end else if ((DisplayFormat = 'JSON') And (Not Download)) then begin // 2019-5-15 SS DVST-702
            TabLines := '{';
         end else if ((DisplayFormat = 'JSON') And (Download)) then begin // 2019-5-15 SS DVST-702
            TabLines := '[';
         end;

         TabLine := '';
         While Not RNQuery.EOF do begin
            if DisplayFormat = 'XML' then begin
               TabLine := '<row id="'+ RNQuery.FieldByName('row').AsString  +'">';
               TabLine := TabLine + '<cell>' + Trim(RNQuery.FieldByName('EmployeeGUID').AsString)+'</cell>' +
                              '<cell>' + Trim(RNQuery.FieldByName('Username').AsString)+'</cell>' +
                              '<cell>'+Trim(RNQuery.FieldByName('Email').AsString)+'</cell>' +
                              '<cell>'+Trim(RNQuery.FieldByName('FirstName').AsString)+'</cell>'+
                              '<cell>'+Trim(RNQuery.FieldByName('LastName').AsString)+'</cell>';
               if RNQuery.FieldByName('LastLogin').AsString <> '' then begin
                     if(IsDisplayTimeInTZ) then begin // 2019-4-17 ss DVST-4900
                        TabLine := TabLine +  '<cell>' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',RNQuery.FieldByName('LastLogintz').AsDateTime)+'</cell>';
                     end else begin
                     TabLine := TabLine +  '<cell>' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',RNQuery.FieldByName('LastLogin').AsDateTime)+' EST</cell>';
                     end;
               end else begin
                  TabLine := TabLine + '<cell></cell>';
               end;
               if GetXMLTagStr(RNQuery.FieldByName('UserProfile').AsString, 'DEACTIVATED') <> '' then begin
                   TabLine := TabLine + '<cell>'+ GetXMLTagStr(RNQuery.FieldByName('UserProfile').AsString, 'DEACTIVATED') +'</cell>';
               end else begin
                   TabLine := TabLine + '<cell>FALSE</cell>';//2019-5-15 SS DVST-702: Front end has code that flips this end data point to true, as such a green checkbox is displayed in that column, indicating user is active.
               end;

               if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYUSERTYPE','FALSE')) then begin
                  if RNQuery.FieldByName('AttributesXML').AsString <> '' then begin
                     if GetXMLTagStr(RNQuery.FieldByName('AttributesXML').AsString, 'ISPORTALUSER') = 'TRUE' then begin
                        TabLine := TabLine + '<cell>Portal User</cell>';
                     end else begin
                        TabLine := TabLine + '<cell>Non-Portal User</cell>';
                     end;
                  end else begin
                     TabLine := TabLine + '<cell>Non-Portal User</cell>';
                  end;
               end;

               TabLines := TabLines + TabLine + '</row>';
            end else if ((DisplayFormat = 'JSON') And (Not Download)) then begin // 2019-5-15 SS DVST-702
               TabLine := '"user": {';
               TabLine := TabLine + '"guid":"' + EscapeJSONTokens(Trim(RNQuery.FieldByName('EmployeeGUID').AsString))+'",' +
                              '"username":"' + EscapeJSONTokens(Trim(RNQuery.FieldByName('Username').AsString))+'",' +
                              '"email":"'+EscapeJSONTokens(Trim(RNQuery.FieldByName('Email').AsString))+'",' +
                              '"firstName":"'+EscapeJSONTokens(Trim(RNQuery.FieldByName('FirstName').AsString))+'",' +
                              '"lastName":"'+EscapeJSONTokens(Trim(RNQuery.FieldByName('LastName').AsString))+'",';
               if RNQuery.FieldByName('LastLogin').AsString <> '' then begin
                     if(IsDisplayTimeInTZ) then begin // 2019-4-17 ss DVST-4900
                        TabLine := TabLine +  '"lastLogin":"'+ EscapeJSONTokens(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',RNQuery.FieldByName('LastLogintz').AsDateTime))+'",';
                     end else begin
                     TabLine := TabLine +  '"lastLogin":"'+ EscapeJSONTokens(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',RNQuery.FieldByName('LastLogin').AsDateTime))+' EST",';
                     end;
               end else begin
                  TabLine := TabLine + '"lastLogin":"",';
               end;
               UserProfileXML := RNQuery.FieldByName('UserProfile').AsString;

               if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYUSERTYPE','FALSE')) then begin
                  if RNQuery.FieldByName('AttributesXML').AsString <> '' then begin
                     if GetXMLTagStr(RNQuery.FieldByName('AttributesXML').AsString, 'ISPORTALUSER') = 'TRUE' then begin
                        TabLine := TabLine + '"userType":"1",';
                     end else begin
                        TabLine := TabLine + '"userType":"0",';
                     end;
                  end else begin
                     TabLine := TabLine + '"userType":"0",';
                  end;
               end;
               if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/BYUSERTABACCESS[@name="ProcessCard"]', 'FALSE')) then begin
                  if UserProfileXML <> '' then begin
                     if strtobool(GetXMLTagStr(UserProfileXML, 'ALLOWPROCESSCARDACCESS')) then begin
                        TabLine := TabLine + '"processCardAccess":"1",';
                     end else begin
                        TabLine := TabLine + '"processCardAccess":"0",';
                     end;
                  end else begin
                     TabLine := TabLine + '"processCardAccess":"0",';
                  end;
               end;
               if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ADMINCHARGEAGAIN/USERRESTRICTED', 'FALSE')) then begin //2019-02-13 jtm: DVST-3067
                  if UserProfileXML <> '' then begin
                     if GetXMLTagStr(UserProfileXML, 'ALLOWCHARGEAGAIN') = 'TRUE' then begin
                        TabLine := TabLine + '"chargeAgain":"1",';
                     end else begin
                        TabLine := TabLine + '"chargeAgain":"0",';
                     end;
                  end else begin
                     TabLine := TabLine + '"chargeAgain":"0",';
                  end;
               end;
               TabLine := TabLine + '"rnidaccess":{';
               try
                  if UserProfileXML <> '' then begin
                     UserRNIDXMLStr := '<?xml version="1.0" encoding="ISO-8859-1"?><USERPROFILE>' + GetXMLTagStr(RNQuery.FieldByName('UserProfile').AsString,'USERPROFILE') + '</USERPROFILE>';
                  end else begin
                     UserRNIDXMLStr := '<?xml version="1.0" encoding="ISO-8859-1"?><USERPROFILE></USERPROFILE>';
                  end;
                  UserRNIDXML := TOpenXML.CreateFromString(Nil,UserRNIDXMLStr);
               except
                  On E:Exception do begin
                     Processlog(ltWarning, 'OpenXMLLoad Exception processing UserRNIDXML, User=' +Trim(RNQuery.FieldByName('Username').AsString),E.Message);
                     If Assigned(UserRNIDXML) then FreeAndNil(UserRNIDXML);
                  end;
               end;
               if (UserRNIDXML <> nil) then begin
                  if UserRNIDXML.GetNode('/USERPROFILE/RNIDACCESS') = nil then begin
                     ReadOnlyStr := UserRNIDXML.GetValueAsWideString('/USERPROFILE/READONLY');
                     if ReadOnlyStr = '' then ReadOnlyStr := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DEFAULTREAD','TRUE');

                     if UserRNIDXML.GetNode('/USERPROFILE/ALLOWEDRNIDS') = nil then begin
                        RNIDList.CommaText := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DEFAULTRNID','');
                     end else begin
                        if UserRNIDXML.GetValueAsWideString('/USERPROFILE/ALLOWEDRNIDS') <> '' then begin
                            RNIDList.CommaText := UserRNIDXML.GetValueAsWideString('/USERPROFILE/ALLOWEDRNIDS');
                        end else begin
                            XMLSetTag(UserRNIDXML,'/USERPROFILE/CHAINACCESS/CHAIN[@ID="'+trim(Stri(ChainCode,-1))+'"]/READONLY',ReadOnlyStr);  //2016-11-03 jtm Feat OT# 1247
                        end;
                     end;
                     XMLSetTag(UserRNIDXML,'/USERPROFILE/RNIDACCESS','');
                     for i := 0 to RNIDList.Count-1 do begin
                         XMLSetTag(UserRNIDXML,'/USERPROFILE/RNIDACCESS/RNID[@ID="'+trim(RNIDList[i])+'"]/READONLY',ReadOnlyStr);
                     end;
                     RNQuery.Edit;
                     RNQuery.FieldByName('UserProfile').AsString := UserRNIDXML.DocumentAsString;
                     RNQuery.Post;
                  end;
                  if UserRNIDXML.GetNode('/USERPROFILE/RNIDACCESS') <> nil then begin
                     UserRNIDNode := UserRNIDXML.GetNode('/USERPROFILE/RNIDACCESS');
                     UserRNIDNode := UserRNIDNode.FindFirstChildElement;
                     while UserRNIDNode <> nil do begin
                        Tabline := TabLine + '"'+ trim(UserRNIDXML.GetContextValueAsWideString(UserRNIDNode,'@ID'))+ '":{';
                        UserRNIDNodeChild := UserRNIDNode.FindFirstChildElement;
                        while UserRNIDNodeChild <> nil do begin
                            Tabline := Tabline + '"'+ EscapeJSONTokens(UserRNIDNodeChild.NodeName) + '":' + '"'+ EscapeJSONTokens(UserRNIDXML.GetContextValueAsWideString(UserRNIDNode,UserRNIDNodeChild.NodeName)) + '",';
                            UserRNIDNodeChild := UserRNIDNodeChild.FindNextSiblingElement;
                        end;
                        ChainIndex := ChainRNIDList.IndexOf(UserRNIDXML.GetContextValueAsWideString(UserRNIDNode,'@ID')); //2017-09-20 jtm: D#1945
                        if (StoreNameList.Count = ChainRNIDList.Count) and (ChainIndex > -1 ) then begin
                           Tabline := TabLine + '"storename":"' + EscapeJSONTokens(ToUTF(StoreNameList[ChainIndex]))+'"';
                        end else begin
                           Tabline := TabLine + '"storename":""';
                        end;
                        if IncludeServiceName then begin
                           Tabline := TabLine + ',"servicenames":"' + 'https://' + Request.Host + '/PP?PAGE=GETSERVICENAMESAJAX&DISPLAYFORMAT=XML&USERGUID=' + EscapeJSONTokens(Trim(RNQuery.FieldByName('EmployeeGUID').AsString)) + '&LOCATIONRNID=' + trim(UserRNIDXML.GetContextValueAsWideString(UserRNIDNode,'@ID'))+'"';
                        end;
                        UserRNIDNode := UserRNIDNode.FindNextSiblingElement;
                        Tabline := Tabline + '}';
                        if UserRNIDNode <> nil then Tabline := Tabline + ',';
                     end;
                  end;
                  if UserRNIDXML.GetNode('/USERPROFILE/CHAINACCESS') <> nil then begin  //2016-11-03 jtm Feat OT# 1247
                     TabLine := TabLine + '}, "chainaccess":{';
                     UserRNIDNode := UserRNIDXML.GetNode('/USERPROFILE/CHAINACCESS');
                     UserRNIDNode := UserRNIDNode.FindFirstChildElement;
                     while UserRNIDNode <> nil do begin
                        Tabline := TabLine + '"'+ trim(UserRNIDXML.GetContextValueAsWideString(UserRNIDNode,'@ID'))+ '":{';
                        UserRNIDNodeChild := UserRNIDNode.FindFirstChildElement;
                        while UserRNIDNodeChild <> nil do begin
                            Tabline := Tabline + '"'+ EscapeJSONTokens(UserRNIDNodeChild.NodeName) + '":' + '"'+ EscapeJSONTokens(UserRNIDXML.GetContextValueAsWideString(UserRNIDNode,UserRNIDNodeChild.NodeName)) + '"';
                            UserRNIDNodeChild := UserRNIDNodeChild.FindNextSiblingElement;
                            if UserRNIDNodeChild <> nil then Tabline := Tabline + ',';
                        end;
                        UserRNIDNode := UserRNIDNode.FindNextSiblingElement;
                        Tabline := Tabline + '}';
                        if UserRNIDNode <> nil then Tabline := Tabline + ',';
                     end;
                  end;
               end;
               TabLines := TabLines + TabLine + '}}';
            end else if ((DisplayFormat = 'JSON') And (Download)) then begin // 2019-5-15 SS DVST-702
               TabLine := TabLine + '{';

               TabLine := TabLine + '"User Name":"' + EscapeJSONTokens(Trim(RNQuery.FieldByName('Username').AsString))+'",' +
                              '"Email":"'+EscapeJSONTokens(Trim(RNQuery.FieldByName('Email').AsString))+'",' +
                              '"First Name":"'+EscapeJSONTokens(Trim(RNQuery.FieldByName('FirstName').AsString))+'",' +
                              '"Last Name":"'+EscapeJSONTokens(Trim(RNQuery.FieldByName('LastName').AsString))+'",';
               if RNQuery.FieldByName('LastLogin').AsString <> '' then begin
                     if(IsDisplayTimeInTZ) then begin // 2019-4-17 ss DVST-4900
                        TabLine := TabLine +  '"Last Login":"'+ EscapeJSONTokens(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',RNQuery.FieldByName('LastLogintz').AsDateTime))+'",';
                     end else begin
                     TabLine := TabLine +  '"Last Login":"'+ EscapeJSONTokens(FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',RNQuery.FieldByName('LastLogin').AsDateTime))+' EST",';
            end;
               end else begin
                  TabLine := TabLine + '"Last Login":"",';
               end;

               if GetXMLTagStr(RNQuery.FieldByName('UserProfile').AsString, 'DEACTIVATED') <> '' then begin
                   ActiveStr := BoolToStr((Not(StrToBool(Trim(UpCaseString(GetXMLTagStr(RNQuery.FieldByName('UserProfile').AsString, 'DEACTIVATED')))))));
                   TabLine := TabLine + '"Active":'+'"'+ActiveStr+'"';
               end else begin
                   TabLine := TabLine + '"Active":"TRUE"'; // by default everyone is active unless we haven't manually deactivated them
               end;
               TabLine := TabLine + '},';
            end;
            RNQuery.Next;
         end;
      end else begin
         if DisplayFormat = 'XML' then begin
            TabLines := '<?xml version="1.0" encoding="iso-8859-1"?><rows total_count="0" pos="0">';
         end else if DisplayFormat = 'JSON' then begin
            TabLines := '{';
         end;
      end;
      ProcessLog(ltinfo,'GetUserQueryTable','End');
      if DisplayFormat = 'XML' then begin
         TabLines:= TabLines + '</rows>';
      end else if ((DisplayFormat = 'JSON') And (Not Download)) then begin // 2019-4-17 ss DVST-702
         TabLines := TabLines + '}';
      end else if ((DisplayFormat = 'JSON') And (Download)) then begin// 2019-4-17 ss DVST-702
         delete(TabLine, length(TabLine), 1); // remove the last ','
         TabLines := TabLines + TabLine + ']';
      end;
      RNIDList.Free;
      StoreNameList.Free;
      ChainRNIDList.Free;
      Result :=  TabLines;
end;

procedure TCustomerInfoModule.XMLSetTag(XML: TOpenXML; TagName, Value: String);
var
NewNodeName :string;
XpathExp : string;
posit : integer;
NewNodeAtt : string;
NewNodeAttVal : string;
NewNode : TOpenXMLNode;
begin
   if not Assigned(XML) then exit;
   if (XML.GetValueAsWideString(TagName) <> '') or (XML.GetNode(TagName) <> nil ) then begin
      XML.EditNodeValue(TagName,Value);
   end else begin
      posit := LastPos('/',TagName,false);
      NewNodeName := Copy(TagName, posit+1, Length(TagName)-posit);
      XpathExp := LeftStr(TagName,LastPos('/',TagName,false)-1);
      if (Pos('@',NewNodeName) > 0) then begin
          NewNodeAtt := Copy(NewNodeName, Pos('@',NewNodeName)+1, (Pos('=',NewNodeName)-1)-Pos('@',NewNodeName));
          NewNodeAttVal := Copy(NewNodeName, Pos('"',NewNodeName)+1, (LastPos('"',NewNodeName,false)-1)-Pos('"',NewNodeName));
          Delete(NewNodeName,Pos('[',NewNodeName), Pos('[',NewNodeName) -1 + length(NewNodeName));
      end;
      if XML.GetNode(XpathExp) <> nil then begin
         NewNode := XML.AddChildNode(XpathExp,NewNodeName,Value);
         if NewNodeAtt <> ''  then XML.InsertNewContextAttribute(NewNode,NewNodeAtt,NewNodeAttVal);
      end else begin
         XMLAddNode(XML, XpathExp,NewNodeName, value,NewNodeAtt,NewNodeAttVal);
      end;
   end;
end;

function TCustomerInfoModule.GetStoreNames(RNIDs,ASL: TStringList): Integer;
var
   I : Integer;
Begin
   I := 0;
   if RNIDs.Count > 0 then begin
      ASL.Clear;
      RNQuery.Close;
      RNQuery.SQL.Text := 'Select Name from store where (SystemCode in (' + RNIDs.CommaText + '))' +
                                  ' Order by Name';
      RNQuery.Open;

      While Not RNQuery.EOF Do begin
         Inc(I);
         ASL.Add(RNQuery.FieldByName('Name').AsString);
         RNQuery.Next;
      end;
      RNQuery.Close;
   end;
   Result := I;
end;

function TCustomerInfoModule.OpenUserQueryGUID(UserGUID: String): boolean;
begin
   Result := False;
   UserGUID := GuidONly(UserGUID);
   If UserGUID = '' then exit;

   RNQuery.Close;
   RNQuery.SQL.Clear;
   RNQuery.ParamCheck := True;
   RNQuery.SQL.Add('Select * from RNEmployee where (ChainCode = :ChainCode) and (EmployeeGUID = :EmployeeGUID)');
   RNQuery.Parameters.ParamByName('ChainCode').Value := ChainCode;
   RNQuery.Parameters.ParamByName('EmployeeGUID').Value := UserGUID;
   RNQuery.Open;
   Result := RNQuery.RecordCount = 1;
end;

function TCustomerInfoModule.UserNameExists(AUsername: string): boolean;
Var
   ADS : TADOQuery;
   WS : String;

Begin
   Result := False;
   ADS := NewADOQUery;
   Try
      ADS.SQL.Clear;
      ADS.ParamCheck := True;
      ADS.SQL.Add('Select * from RNEmployee where (ChainCode = :ChainCode) and (UserName = :UserName)');
      ADS.Parameters.ParamByName('ChainCode').Value := ChainCode;
      ADS.Parameters.ParamByName('UserName').Value := AUserName;
      ADS.Open;
      result := ADS.RecordCount = 1;
   except
      on E:Exception do begin
         ProcessLog(ltWarning,'Exception UsernameExists' + E.Message,InstanceGUID);
      end;
   end;

end;

procedure TCustomerInfoModule.LoadUserFormData(ADS: TDataSet;AUsername : string);
const //2018-06-20 bls: F#4654
   PORTAL_USER = '<ATTRIBUTES><ISPORTALUSER>TRUE</ISPORTALUSER></ATTRIBUTES>';
   NON_PORTAL_USER = '<ATTRIBUTES><ISPORTALUSER>FALSE</ISPORTALUSER></ATTRIBUTES>';
var
   UserProfileXML : TOpenXML;
   RNIDAccessXML : TOpenXML;
   RNIDAccessXMLNode : TOpenXMLNode;
   ServNameAccessXMLNode : TOpenXMLNode;  //2017-05-24 jtm F#1775
   AttributesXMLNode : TOpenXMLNode; //2018-06-20 bls: F#4654
   UserProfileXMLStr, RNIDAccessXMLStr : string;
   RNIDAccess : string;
   RNIDReadOnly : boolean;
   UserRNIDExists : boolean;
   ServNameRNID : string; //2017-05-24 jtm F#1775
   AttributesXMLStr : string; //2018-06-20 bls: F#4654
   IsPortalUser : string; //2018-06-20 bls: F#4654
   LastName, FirstName : string;
   IsChargeAgain : boolean; //2019-02-13 jtm: DVST-3067
   processCard: string;
   canUseProcessCardTab: boolean;
begin
   Processlog(ltInfo, 'LoadUserFormData: AUsername=' +AUsername,'Begin');
   if (trim(ADS.FieldByName('Username').AsString) <> AUsername) then begin
      ADS.FieldByName('Username').AsString  := AUsername;
      if (ADS.FieldByName('EmployeeXML').AsString <> '') then begin //2017-07-19 jtm: D#1754
         EmployeeXML := TOpenXML.CreateFromString(Nil,'<?xml version="1.0" encoding="ISO-8859-1"?><EMPLOYEE>' +
                                                   ADS.FieldByName('EmployeeXML').AsString + '</EMPLOYEE>');
         EmployeeXMLSetTag('/EMPLOYEE/USERNAME', AUsername);
         ADS.FieldByName('EmployeeXML').AsString := GetXMLTagStr(EmployeeXML.DocumentAsString,'EMPLOYEE');
      end;
   end;

   If (trim(ADS.FieldByName('LastName').AsString)  <> ValidCharsOnly(Request.ContentFields.Values['userLN'],True,True,'-'' ')) then begin
      LastName := ValidCharsOnly(Request.ContentFields.Values['userLN'],True,True,'-'' '); //2018-06-20 bls: F#4834
      ADS.FieldByName('LastName').AsString := LastName;
   end;

   If (trim(ADS.FieldByName('FirstName').AsString) <> ValidCharsOnly(Request.ContentFields.Values['userFN'],True,True,'-'' ')) then begin
      FirstName := ValidCharsOnly(Request.ContentFields.Values['userFN'],True,True,'-'' ');
      ADS.FieldByName('FirstName').AsString := FirstNAme;
   end;

   IsChargeAgain := false;
   if (NumericOnly(Request.ContentFields.Values['chargeAgain']) <> '') then begin //2019-02-13 jtm: DVST-3067
      IsChargeAgain := strtobool(NumericOnly(Request.ContentFields.Values['chargeAgain']));
   end;

   processCard := NumericOnly(Request.ContentFields.Values['processCard']);
   canUseProcessCardTab := false;
   if NumericOnly(processCard) <> '' then begin
      canUseProcessCardTab := strtobool(processCard);
   end;

   If (trim(ADS.FieldByName('Email').AsString) <> ValidCharsOnly(Request.ContentFields.Values['userEmail'],True,True,'_.-#@+/')) then
      ADS.FieldByName('Email').AsString := ValidCharsOnly(Request.ContentFields.Values['userEmail'],True,True,'_.-#@+/');

   if ValidCharsOnly(Request.ContentFields.Values['userType'],False,True,'') = '1' then begin // If the userType is a portal user...
      AttributesXMLStr := PORTAL_USER;
      IsPortalUser := 'TRUE';
   end else begin
      AttributesXMLStr := NON_PORTAL_USER;
      IsPortalUser := 'FALSE';
   end;

   if (trim(ADS.FieldByName('AttributesXML').AsString) = '') then begin // If the AttributesXML cell is null, inject the appropriate xml
      ADS.FieldByName('AttributesXML').AsString := AttributesXMLStr;
   end else if (trim(ADS.FieldByName('AttributesXML').AsString) <> AttributesXMLStr) then begin  // If it has content and differs from the results of the post request
      try
         AttributesXMLStr := '<?xml version="1.0" encoding="ISO-8859-1"?>' + ValidCharsOnly(trim(ADS.FieldByName('AttributesXML').AsString), true, true, '<>"?=/-_ ');
         AttributesXML := TOpenXML.CreateFromString(NIL, AttributesXMLStr);
      except
         on E:Exception do begin
            Processlog(ltWarning, 'OpenXMLLoad Exception processing AttributesXML, User=' + AUsername, E.Message);
            If Assigned(AttributesXML) then FreeAndNil(AttributesXML);
            Exit;
         end;
      end;
      if AttributesXML.GetNode('/ATTRIBUTES/ISPORTALUSER') <> NIL then begin     // If the xml has this node...
         AttributesXML.EditNodeValue('/ATTRIBUTES/ISPORTALUSER',IsPortalUser);   // Update the value
      end else begin                                                             // Else...
         AttributesXML.AddChildNode('/ATTRIBUTES','ISPORTALUSER', IsPortalUser); // Create a new node with the appropriate value
      end;
      AttributesXMLNode := AttributesXML.GetNode('/ATTRIBUTES'); // Set the node equal to the root node
      ADS.FieldByName('AttributesXML').AsString := AttributesXML.GetContextNodeAsXMLString(AttributesXMLNode, true); // Save the xml as a string in the db
   end;

   Try
      if ADS.FieldByName('UserProfile').AsString <> '' then begin
         UserProfileXMLStr := '<?xml version="1.0" encoding="ISO-8859-1"?><USERPROFILE>' + ValidCharsOnly(GetXMLTagStr(ADS.FieldByName('UserProfile').AsString,'USERPROFILE'), true, true, '<>"?=/-_ ') + '</USERPROFILE>'; //2018-05-16 bls: D#2530
      end else begin
         UserProfileXMLStr := '<?xml version="1.0" encoding="ISO-8859-1"?><USERPROFILE><FIRSTLOGIN>TRUE</FIRSTLOGIN></USERPROFILE>';  //if they don't have UserProfile then assume it's an add
      end;
      UserProfileXML := TOpenXML.CreateFromString(Nil,UserProfileXMLStr);
   except
      On E:Exception do begin
         Processlog(ltWarning, 'OpenXMLLoad Exception processing UserProfileXML, User=' +AUsername,E.Message);
         If Assigned(UserProfileXML) then FreeAndNil(UserProfileXML);
         exit;
      end;
   end;

   if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/BYUSERTABACCESS[@name="ProcessCard"]', 'FALSE')) then begin
      ProcessCard := BoolToStr(canUseProcessCardTab);
      if (UserProfileXML.GetValueAsWideString('/USERPROFILE/ALLOWPROCESSCARDACCESS') <> '') then begin
         UserProfileXML.EditNodeValue('/USERPROFILE/ALLOWPROCESSCARDACCESS', ProcessCard);
      end else begin
         XMLSetTag(UserProfileXML, '/USERPROFILE/ALLOWPROCESSCARDACCESS', ProcessCard);
      end;
   end;

   if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ADMINCHARGEAGAIN/USERRESTRICTED', 'FALSE')) then begin //2019-02-13 jtm: DVST-3067
      if (UserProfileXML.GetValueAsWideString('/USERPROFILE/ALLOWCHARGEAGAIN') <> '') then begin
         UserProfileXML.EditNodeValue('/USERPROFILE/ALLOWCHARGEAGAIN',BoolToStr(IsChargeAgain));
      end else begin
         XMLSetTag(UserProfileXML, '/USERPROFILE/ALLOWCHARGEAGAIN',BoolToStr(IsChargeAgain));
      end;
   end;
   Try
      if Request.ContentFields.Values['USERGRIDDATA'] <> '' then begin
         RNIDAccessXMLStr := Request.ContentFields.Values['USERGRIDDATA'];
      end else begin
         RNIDAccessXMLStr := '<?xml version="1.0" encoding="ISO-8859-1"?><rows></rows>';
      end;
      RNIDAccessXML := TOpenXML.CreateFromString(Nil,RNIDAccessXMLStr);
   except
      On E:Exception do begin
         Processlog(ltWarning, 'OpenXMLLoad Exception processing RNIDAccessXML USERGRIDDATA, User=' +AUsername,E.Message);
         If Assigned(RNIDAccessXML) then FreeAndNil(RNIDAccessXML);
         If Assigned(UserProfileXML) then FreeAndNil(UserProfileXML);
         exit;
      end;
   end;
   UserRNIDExists := UserProfileXML.GetNode('/USERPROFILE/RNIDACCESS') <> nil;

   if UserRNIDExists and (UserProfileXML.GetNode('/USERPROFILE/RNIDACCESS/RNID') = nil) then begin //2019-02-14 jtm: DVST:3626
      UserProfileXML.EditNodeValue('/USERPROFILE/RNIDACCESS','');  //if it's empty, set the value to empty so we don't have extra spaces in the node
   end;
   if RNIDAccessXML.GetNode('/rows') <> nil then begin
      RNIDAccessXMLNode :=  RNIDAccessXML.GetNode('/rows');
      RNIDAccessXMLNode := RNIDAccessXMLNode.FindFirstChildElement;
      Processlog(ltInfo, 'LoadUserFormData: AUsername=' +AUsername,'Update USERPROFILE RNID');
      while RNIDAccessXMLNode <> nil do begin
         RNIDAccess := RNIDAccessXML.GetContextValueAsWideString(RNIDAccessXMLNode,'cell[1]'); //RNID
         RNIDReadOnly :=  RNIDAccessXML.GetContextValueAsBoolean(RNIDAccessXMLNode,'cell[2]'); //ReadOnly comes back as '0' or '1'
         if RNIDAccess <> '' then begin
            if UserRNIDExists and (UserProfileXML.GetValueAsWideString('/USERPROFILE/RNIDACCESS/RNID[@ID="'+trim(RNIDAccess)+'"]/READONLY') <> '') then
               UserProfileXML.EditNodeValue('/USERPROFILE/RNIDACCESS/RNID[@ID="'+trim(RNIDAccess)+'"]/READONLY',BoolToStr(RNIDReadOnly))
            else
               XMLSetTag(UserProfileXML, '/USERPROFILE/RNIDACCESS/RNID[@ID="'+trim(RNIDAccess)+'"]/READONLY',BoolToStr(RNIDReadOnly));
         end;
         RNIDAccessXMLNode := RNIDAccessXMLNode.FindNextSiblingElement;
      end;
   end;
   RNIDAccessXML.Free;
   Try
      if Request.ContentFields.Values['CHAINGRIDDATA'] <> '' then begin
         RNIDAccessXMLStr := Request.ContentFields.Values['CHAINGRIDDATA'];
      end else begin
         RNIDAccessXMLStr := '<?xml version="1.0" encoding="ISO-8859-1"?><rows></rows>';
      end;
      RNIDAccessXML := TOpenXML.CreateFromString(Nil,RNIDAccessXMLStr);
   except
      On E:Exception do begin
         Processlog(ltWarning, 'OpenXMLLoad Exception processing RNIDAccessXML CHAINGRIDDATA, User=' +AUsername,E.Message);
         If Assigned(RNIDAccessXML) then FreeAndNil(RNIDAccessXML);
         If Assigned(UserProfileXML) then FreeAndNil(UserProfileXML);
         exit;
      end;
   end;
   UserRNIDExists := UserProfileXML.GetNode('/USERPROFILE/CHAINACCESS') <> nil;
   if UserRNIDExists and (UserProfileXML.GetNode('/USERPROFILE/CHAINACCESS/CHAIN') = nil) then begin  //2019-02-14 jtm: DVST:3626
      UserProfileXML.EditNodeValue('/USERPROFILE/CHAINACCESS','');  //if it's empty, set the value to empty so we don't have extra spaces in the node
   end;
   if RNIDAccessXML.GetNode('/rows') <> nil then begin
      RNIDAccessXMLNode :=  RNIDAccessXML.GetNode('/rows');
      RNIDAccessXMLNode := RNIDAccessXMLNode.FindFirstChildElement;
      Processlog(ltInfo, 'LoadUserFormData: AUsername=' +AUsername,'Update USERPROFILE Chain');
      while RNIDAccessXMLNode <> nil do begin
         RNIDAccess := RNIDAccessXML.GetContextValueAsWideString(RNIDAccessXMLNode,'cell[1]'); //Chain
         RNIDReadOnly :=  RNIDAccessXML.GetContextValueAsBoolean(RNIDAccessXMLNode,'cell[2]'); //ReadOnly comes back as '0' or '1'
         if RNIDAccess <> '' then begin
            if UserRNIDExists and (UserProfileXML.GetValueAsWideString('/USERPROFILE/CHAINACCESS/CHAIN[@ID="'+trim(RNIDAccess)+'"]/READONLY') <> '') then
               UserProfileXML.EditNodeValue('/USERPROFILE/CHAINACCESS/CHAIN[@ID="'+trim(RNIDAccess)+'"]/READONLY',BoolToStr(RNIDReadOnly))
            else
               XMLSetTag(UserProfileXML, '/USERPROFILE/CHAINACCESS/CHAIN[@ID="'+trim(RNIDAccess)+'"]/READONLY',BoolToStr(RNIDReadOnly));
         end;
         RNIDAccessXMLNode := RNIDAccessXMLNode.FindNextSiblingElement;
      end;
   end;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINUSERMANAGEMENT/INCLUDESERVICENAME','FALSE') = 'TRUE' then begin //2017-05-24 jtm F#1775
       Try
         if Request.ContentFields.Values['USERSNDATA'] <> '' then begin
            RNIDAccessXMLStr := Request.ContentFields.Values['USERSNDATA'];
         end else begin
            RNIDAccessXMLStr := '<?xml version="1.0" encoding="ISO-8859-1"?><rows></rows>';
         end;
         RNIDAccessXML := TOpenXML.CreateFromString(Nil,RNIDAccessXMLStr);
      except
         On E:Exception do begin
            Processlog(ltWarning, 'OpenXMLLoad Exception processing RNIDAccessXML USERSNDATA, User=' +AUsername,E.Message);
            If Assigned(RNIDAccessXML) then FreeAndNil(RNIDAccessXML);
            If Assigned(UserProfileXML) then FreeAndNil(UserProfileXML);
            exit;
         end;
      end;

      if RNIDAccessXML.GetNode('/rows') <> nil then begin
         RNIDAccessXMLNode :=  RNIDAccessXML.GetNode('/rows');
         RNIDAccessXMLNode := RNIDAccessXMLNode.FindFirstChildElement;
         Processlog(ltInfo, 'LoadUserFormData: AUsername=' +AUsername,'Update USERPROFILE ServiceName');
         while RNIDAccessXMLNode <> nil do begin
            ServNameRNID := RNIDAccessXML.GetContextValueAsWideString(RNIDAccessXMLNode,'@id');
            ServNameAccessXMLNode := RNIDAccessXMLNode.FindFirstChildElement;
            while ServNameAccessXMLNode <> nil do begin
               RNIDAccess := RNIDAccessXML.GetContextValueAsWideString(ServNameAccessXMLNode,'@id');
               RNIDReadOnly :=  RNIDAccessXML.GetContextValueAsBoolean(ServNameAccessXMLNode,'readonly');
               if (ServNameRNID <> '') and (RNIDAccess <> '') then begin
                  if (UserProfileXML.GetValueAsWideString('/USERPROFILE/RNIDACCESS/RNID[@ID="'+trim(ServNameRNID)+'"]/SERVICENAMES/SERVICENAME[@ID="'+trim(RNIDAccess)+'"]/READONLY') <> '') then
                     UserProfileXML.EditNodeValue('/USERPROFILE/RNIDACCESS/RNID[@ID="'+trim(ServNameRNID)+'"]/SERVICENAMES/SERVICENAME[@ID="'+trim(RNIDAccess)+'"]/READONLY',BoolToStr(RNIDReadOnly))
                  else
                     XMLSetTag(UserProfileXML,'/USERPROFILE/RNIDACCESS/RNID[@ID="'+trim(ServNameRNID)+'"]/SERVICENAMES/SERVICENAME[@ID="'+trim(RNIDAccess)+'"]/READONLY',BoolToStr(RNIDReadOnly));
               end;
               ServNameAccessXMLNode := ServNameAccessXMLNode.FindNextSiblingElement;
            end;
            RNIDAccessXMLNode := RNIDAccessXMLNode.FindNextSiblingElement;
         end;
      end;
   end;
   ADS.FieldByName('UserProfile').AsString := UserProfileXML.DocumentAsString;
   FreeAndNil(UserProfileXML);
   FreeAndNil(RNIDAccessXML);
   Processlog(ltInfo, 'LoadUserFormData: AUsername=' +AUsername,'End');
end;

function TCustomerInfoModule.GetUserRNIDAccess(ASL: TStringList;CheckReadOnly:boolean): Integer;
var
   I : Integer;
   RNIDAccessXMLNode : TOpenXMLNode;
Begin
   ASL.Clear;
   Result := 0;
   I := 0;
   If not Assigned(UserXML) then exit;
   if UserXML.GetNode('/USERPROFILE/RNIDACCESS') <> nil then begin
      RNIDAccessXMLNode := UserXML.GetNode('/USERPROFILE/RNIDACCESS');
      RNIDAccessXMLNode := RNIDAccessXMLNode.FindFirstChildElement;
      while RNIDAccessXMLNode <> nil do begin
         Inc(I);
         if CheckReadOnly then begin //2017-05-24 jtm F#1554
            if UserXML.GetContextValueAsWideString(RNIDAccessXMLNode,'READONLY') = 'FALSE' then
               ASL.Add(trim(UserXML.GetContextValueAsWideString(RNIDAccessXMLNode,'@ID')));
         end else begin
            ASL.Add(trim(UserXML.GetContextValueAsWideString(RNIDAccessXMLNode,'@ID')));
         end;
         RNIDAccessXMLNode := RNIDAccessXMLNode.FindNextSiblingElement;
      end;
   end;

   Result := I;
end;

Function TCustomerInfoModule.RemoveUserRNIDAccess(ADS: TDataSet; AXMLStr : string): boolean;
var
   UserProfileXML : TOpenXML;
   RNIDAccessXML : TOpenXML;
   RNIDAccessXMLNode : TOpenXMLNode;
   ServNameAccessXMLNode : TOpenXMLNode; //2017-05-24 jtm F#1775
   ServNameRNID : string; //2017-05-24 jtm F#1775
   UserProfileXMLStr, RNIDAccessXMLStr : string;
   RNIDAccess : string;
   RNIDReadOnly : boolean;
   UserRNIDExists : boolean;
begin
   Result := false;
   if AXMLStr <> '' then begin
      Try
         UserProfileXML := TOpenXML.CreateFromString(Nil,'<?xml version="1.0" encoding="ISO-8859-1"?><USERPROFILE>' + GetXMLTagStr(ADS.FieldByName('UserProfile').AsString,'USERPROFILE') + '</USERPROFILE>');
      except
         On E:Exception do begin
            Processlog(ltWarning, 'OpenXMLLoad Exception processing UserProfileXML',E.Message);
            If Assigned(UserProfileXML) then FreeAndNil(UserProfileXML);
            exit;
         end;
      end;
      Try
         RNIDAccessXML := TOpenXML.CreateFromString(Nil,AXMLStr);
      except
         On E:Exception do begin
            Processlog(ltWarning, 'OpenXMLLoad Exception processing RNIDAccessXML in RemoveUserRNIDAccess',E.Message);
            If Assigned(RNIDAccessXML) then FreeAndNil(RNIDAccessXML);
            If Assigned(UserProfileXML) then FreeAndNil(UserProfileXML);
            exit;
         end;
      end;
      UserRNIDExists := UserProfileXML.GetNode('/USERPROFILE/RNIDACCESS') <> nil;

      if RNIDAccessXML.GetNode('/rows') <> nil then begin
         RNIDAccessXMLNode :=  RNIDAccessXML.GetNode('/rows');
         RNIDAccessXMLNode := RNIDAccessXMLNode.FindFirstChildElement;
         Processlog(ltInfo, 'LoadUserFormData: ','Update USERPROFILE');
         while RNIDAccessXMLNode <> nil do begin
            ServNameRNID := NumericOnly(RNIDAccessXML.GetContextValueAsWideString(RNIDAccessXMLNode,'@id')); //2017-05-24 jtm F#1775
            RNIDAccess := NumericOnly(RNIDAccessXMLNode.TextContent);
            if ServNameRNID <> '' then begin //if we pass back an RNID in the id attribute, then we're just deleting service names
               ServNameAccessXMLNode := RNIDAccessXMLNode.FindFirstChildElement;
               while ServNameAccessXMLNode <> nil do begin
                  RNIDAccess := trim(ServNameAccessXMLNode.TextContent);
                  if (RNIDAccess <> '') then begin
                     if (UserProfileXML.GetValueAsWideString('/USERPROFILE/RNIDACCESS/RNID[@ID="'+ServNameRNID+'"]/SERVICENAMES/SERVICENAME[@ID="'+RNIDAccess+'"]/READONLY') <> '') then begin
                        UserProfileXML.RemoveNode('/USERPROFILE/RNIDACCESS/RNID[@ID="'+ServNameRNID+'"]/SERVICENAMES/SERVICENAME[@ID="'+RNIDAccess+'"]');
                     end;
                  end;
                  ServNameAccessXMLNode := ServNameAccessXMLNode.FindNextSiblingElement;
               end;
            end else if RNIDAccess <> '' then begin
               if UserRNIDExists and (UserProfileXML.GetValueAsWideString('/USERPROFILE/RNIDACCESS/RNID[@ID="'+trim(RNIDAccess)+'"]/READONLY') <> '') then begin
                  UserProfileXML.RemoveNode('/USERPROFILE/RNIDACCESS/RNID[@ID="'+trim(RNIDAccess)+'"]');
               end;
            end;
            RNIDAccessXMLNode := RNIDAccessXMLNode.FindNextSiblingElement;
         end;
      end;
      ADS.Edit;
      ADS.FieldByName('UserProfile').AsString := UserProfileXML.DocumentAsString;
      ADS.Post;
      Result := true;
      FreeAndNil(UserProfileXML);
      FreeAndNil(RNIDAccessXML);
   end;
end;

Function TCustomerInfoModule.RemoveUserChainAccess(ADS: TDataSet; AXMLStr : string): boolean;
var
   UserProfileXML : TOpenXML;
   ChainAccessXML : TOpenXML;
   ChainAccessXMLNode : TOpenXMLNode;
   UserProfileXMLStr, ChainAccessXMLStr : string;
   ChainAccess : string;
   ChainReadOnly : boolean;
   UserRNIDExists : boolean;
begin
   Result := false;
   if AXMLStr <> '' then begin
      Try
         UserProfileXML := TOpenXML.CreateFromString(Nil,'<?xml version="1.0" encoding="ISO-8859-1"?><USERPROFILE>' + GetXMLTagStr(ADS.FieldByName('UserProfile').AsString,'USERPROFILE') + '</USERPROFILE>');
      except
         On E:Exception do begin
            Processlog(ltWarning, 'OpenXMLLoad Exception processing UserProfileXML',E.Message);
            If Assigned(UserProfileXML) then FreeAndNil(UserProfileXML);
            exit;
         end;
      end;
      Try
         ChainAccessXML := TOpenXML.CreateFromString(Nil,AXMLStr);
      except
         On E:Exception do begin
            Processlog(ltWarning, 'OpenXMLLoad Exception processing RNIDAccessXML in RemoveUserRNIDAccess',E.Message);
            If Assigned(ChainAccessXML) then FreeAndNil(ChainAccessXML);
            If Assigned(UserProfileXML) then FreeAndNil(UserProfileXML);
            exit;
         end;
      end;
      UserRNIDExists := UserProfileXML.GetNode('/USERPROFILE/CHAINACCESS') <> nil;

      if ChainAccessXML.GetNode('/rows') <> nil then begin
         ChainAccessXMLNode :=  ChainAccessXML.GetNode('/rows');
         ChainAccessXMLNode := ChainAccessXMLNode.FindFirstChildElement;
         Processlog(ltInfo, 'LoadUserFormData: ','Update USERPROFILE');

         while ChainAccessXMLNode <> nil do begin
            ChainAccess := ChainAccessXMLNode.TextContent;//ChainAccessXML.GetValueAsWideString('/rows/row'); //Chain
            ProcessLog(ltInfo,'ChainAccess',ChainAccess);
            if ChainAccess <> '' then begin
               if UserRNIDExists and (UserProfileXML.GetValueAsWideString('/USERPROFILE/CHAINACCESS/CHAIN[@ID="'+trim(ChainAccess)+'"]/READONLY') <> '') then begin
                  UserProfileXML.RemoveNode('/USERPROFILE/CHAINACCESS/CHAIN[@ID="'+trim(ChainAccess)+'"]');
               end;
            end;
            ChainAccessXMLNode := ChainAccessXMLNode.FindNextSiblingElement;
         end;
      end;
      ADS.Edit;
      ADS.FieldByName('UserProfile').AsString := UserProfileXML.DocumentAsString;
      ADS.Post;
      Result := true;
      FreeAndNil(UserProfileXML);
      FreeAndNil(ChainAccessXML);
   end;
end;
function TCustomerInfoModule.SingleCheckBatchXMLToTableHTML(const ReadyOnly : boolean): String;
var
  I : Integer;
  Line : String;
  BatchHTML : TStringList;
  BRNID : String;
  BSC : String;
  CheckBatchXMLNode : TOPENXMLNode;
  Trace : string;
  ImageSize : integer;
  TicketGUID : string;
  CheckTransactionUnavailableMessage : string;
  IncludeRefundData : boolean;
  CheckHoriz : boolean;
Begin
   Result := '';
   If BatchOXML = NIL then exit;
   I := 1;
   IncludeRefundData := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEREFUNDDATA', 'FALSE')); //2019-02-13 jtm: DVST-3122
   BatchHTML := TStringList.Create;
   CheckTransactionUnavailableMessage := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/CHECKTRANSACTIONUNAVAILABLEMESSAGE', 'Transaction not available');

   CheckBatchXMLNode := BatchOXML.GetNode('/TRANRESP/TCBATCHDETAIL');

   CheckHoriz := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ALIGNCHECKHORIZONTAL', 'FALSE'));

   if (CheckBatchXMLNode = nil) then begin
      Line := '<br><br><table><tr><td><b>' + CheckTransactionUnavailableMessage + '</b></td></tr></table>';
   end else begin
      CheckBatchXMLNode := CheckBatchXMLNode.FindFirstChildElement;

      BRNID := Trim(BatchOXML.GetValueAsWideString('/TRANRESP/PROFILE'));
      BSC := BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'TCSYSTEMCODE');
      if BSC = '' then BSC := BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'SYSTEMCODE');
      TicketGUID := BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'TICKETGUID');

      Trace := Trim(BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'TRACEID'));
      ImageSize := BatchOXML.GetContextValueAsInteger(CheckBatchXMLNode,'IMAGESIZE');


      If (Trim(StriREal(BatchOXML.GetContextValueAsNumber(CheckBatchXMLNode,'TRANAMOUNT'),2)) = 'Nan') AND (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/CHECKTRANSACTIONUNAVAILABLEMESSAGE','')<>'')  then begin //2018-05-15 bls: D#2596
         Line := '<BR><BR><TABLE><TR><TD><B>' + OpenXMLGetTag('/CONFIGDATA/UIPARAMS/CHECKTRANSACTIONUNAVAILABLEMESSAGE') + '</B></TD></TR></TABLE>';
      end else begin

         if CheckHoriz then begin
            Line := '<TABLE border="0"><TR><TD><TABLE>';
         end else
            Line := '<TABLE>';
         Line := Line + '<TR><TD Align="Left"><B>Location</B></TD><TD>' + BRNID +'</TD></TR>';
         Line := Line + '<TR><TD Align="Left"><B>Auth Date</B></TD><TD>' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'AUTHDATE') +'</TD></TR>';
         If BatchOXML.GetContextValueAsBoolean(CheckBatchXMLNode,'VOIDED') then
            Line := Line + '<TR><TD Align="Left"><B>Date Voided</B></TD><TD>' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'VOIDEDDATE')+'</TD></TR>';

         Line := Line + '<TR><TD Align="Left"><B>Amount</B></TD><TD>$' + Trim(StriREal(BatchOXML.GetContextValueAsNumber(CheckBatchXMLNode,'TRANAMOUNT'),2)) +'</TD></TR>';
         Line := Line + '<TR><TD Align="Left"><B>Check Number</B></TD><TD>' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'RESPONSECHECKNUMBER')+'</TD></TR>';
         Line := Line + '<TR><TD Align="Left"><B>Check Type</B></TD><TD>' +BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'CHECKTYPE') +'</TD></TR>';

         Line := Line + '<TR><TD Align="Left"><B>TCK Response</B></TD><TD>' + ColorByECAStatus(TCKEffectiveStatus(BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'ECATRANSTATUS'),BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'ECAACCEPTDATE'),BatchOXML.GetContextValueAsBoolean(CheckBatchXMLNode,'VOIDED'))) +
                                                                        BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'DISPLAYTEXT') +'</FONT></TD></TR>';
         Line := Line + '<TR><TD Align="Left"><B>Status</B></TD><TD>' +BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'ECATRANSTATUS') +'</TD></TR>';
         Line := Line + '<TR><TD Align="Left"><B>Approval Code</B></TD><TD>' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'APPROVALCODE') +'</TD></TR>';
         Line := Line + '<TR><TD Align="Left"><B>Trace ID</B></TD><TD>' + Trace +'</TD></TR>';

         Line := Line + '<TR><TD Align="Left"><B>Tran Ident</B></TD><TD>' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'TRANIDENT') +'</TD></TR>';
         Line := Line + '<TR><TD Align="Left"><B>Batch Serial</B></TD><TD>' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'BATCHSERIAL') +'</TD></TR>';
         If Trim(BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'DENIALRECORDNUMBER')) <> '' then
            Line := Line + '<TR><TD Align="Left"><B>Denial Record Number</B></TD><TD>' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'DENIALRECORDNUMBER')+'</TD></TR>';

         Line := Line + '<TR><TD Align="Left"><B>MID</B></TD><TD>' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'TCMID') +'</TD></TR>';
         Line := Line + '<TR><TD Align="Left"><B>Service Name</B></TD><TD>' +BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'TCSERVICENAME') +'</TD></TR>';
         Line := Line + '<TR><TD Align="Left"><B>Station</B></TD><TD>' +BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'STATIONIDENT') +'</TD></TR>';
         Line := Line + '<TR><TD Align="Left"><B>Store System Code</B></TD><TD>' + BSC +'</TD></TR>';


         if IncludeRefundData then begin //2019-02-13 jtm: DVST-3122
            if (BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'REFUNDAMOUNT') <> '') then begin
               Line := Line + '<TR><TD Align="Left"><B>Refund Amount<B></TD><TD>$' + Trim(StriREal(BatchOXML.GetContextValueAsNumber(CheckBatchXMLNode,'REFUNDAMOUNT'),2)) +'</TD></TR>';
            end else begin
               Line := Line + '<TR><TD Align="Left"><B>Refund Amount<B></TD><TD></TD></TR>';
            end;
            Line := Line + '<TR><TD Align="Left"><B>Refund Date</B></TD><TD>' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'REFUNDDATE') +'</TD></TR>';
            Line := Line + '<TR><TD Align="Left"><B>Refund Count</B></TD><TD>' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'REFUNDCOUNT') +'</TD></TR>';
         end;

         Line := Line + '</TABLE>';


         If Trace <> '' then begin
            RNQuery.Close;
            RNQuery.SQL.Text := 'Select * from tckfunddetail where  (AuthTrace =''' + Trace +''') Order by DetailDate';
            RNQuery.Open;
            If RNQuery.RecordCount > 0 then begin
               Line := Line + '<BR><B>Funding Summary</B></BR>';
               Line := Line + '<TABLE border="1" cellspacing="0" cellpadding="3" bordercolorlight="#0000FF" style="border-collapse: collapse">';
               Line := Line + '<TR><TD><B>Submit Date</B></TD><TD><B>Effective Date</B></TD><TD><B>Credit/Debit</B></TD><TD><B>Amount</B></TD><TD><B>Reason</B></TD><TD><B>Fund To Acct</B></TD></TR>';
               While not RNQuery.EOF do begin
                  Line := Line + '<TR><TD>'+Trim(RNQuery.FieldByName('SubDate').AsString)+'</TD>' +
                                 '<TD>'+Trim(RNQuery.FieldByName('EffectiveDate').AsString)+'</TD>' +
                                 '<TD>'+Trim(RNQuery.FieldByName('CreditDebit').AsString)+'</TD>' +
                                 '<TD align="RIGHT">'+Trim(StriReal(RNQuery.FieldByName('Amount').AsFloat,2))+'</TD>' +
                                 '<TD>'+Trim(RNQuery.FieldByName('Reason').AsString)+'</TD>' +
                                 '<TD align="RIGHT">'+Trim(RNQuery.FieldByName('FundToAcct').AsString)+'</TD>' + '</TR>';
                  RNQuery.Next;
               end;
               Line := Line + '</TABLE><BR>';

            end;
         end;

         If ImageSize > 0 then begin
            if CheckHoriz then
               Line := Line + '</TD><TD>';
            Line := Line + '<TABLE border="0" style="width:800px">';
            Line := Line + '<TR><TD style="height:250px"><B><IMG SRC="PP?PAGE=GETOPENBATCHCHECKIMAGE&CHECKCODE='+BSC + '&LOCATIONRNID=' + BRNID +'"  border="0"></B></TD></TR></TABLE>';  // 2019-06-15 tjr: DVST-3507
            if CheckHoriz then
               Line := Line + '</TD></TR></TABLE>';
         end else begin
            if CheckHoriz then
               Line := Line + '</TD></TR></TABLE>';
            Line := Line + '<BR>Image Not Available<BR>';
         end;

         If ImageSize > 0 then begin
            Line := Line + '<DIV id="hasImage" style="display: none">';
         end else begin
            Line := Line + '<DIV id="noImage" style="display: none">';
         end;
         Line := Line + '</DIV>';

         Line := Line + '<BR><BR><DIV id="VTCheckDetailFormActionButtonDIV"><CENTER>';
         if not (ReadyOnly) then begin
            if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ADMINISSUECHECKREFUND', 'FALSE')) and (BatchOXML.GetContextValueAsNumber(CheckBatchXMLNode,'BATCHSERIAL') > 0) and (TCKEffectiveStatus(BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'ECATRANSTATUS'),BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'ECAACCEPTDATE'),BatchOXML.GetContextValueAsBoolean(CheckBatchXMLNode,'VOIDED')) = 1) then begin
               Line := Line + '<a href="javascript://" class="linkBtn" onclick="document.getElementById(''VTCheckDetailIssueRefundFormDiv'').style.display = '''';");>Issue Refund</a> ';
            end;
         end;
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINRECEIPTS/USEPROFILECONFIG', 'FALSE') = 'TRUE') then begin
            if (OpenXMLGetTag('/CONFIGDATA/RUNTIMEPROFILE','LOCAL') = 'LOCAL') then begin
               if not assigned(ProfileXML) then ProfileXML := TTProfileXML.Create(StrToInt(BRNID), HDQuery);
            end else if (OpenXMLGetTag('/CONFIGDATA/RUNTIMEPROFILE','LOCAL') = 'GW') then begin
               if not assigned(ProfileXML) then begin
                  RNProfileDI := TTADODataLayer.Create(RNDB);
                  RNProfile := TTProfile.Create(BRNID,false, RNProfileDI);
               end;
            end;
            if not (GetProfileXMLValueAsBoolean('/PROFILE/DRAWERSETTINGS/USEOLDRECEIPTS',true)) then begin
               if (TicketGUID <> '') then begin
                  Line := Line + '<a href="javascript://" class="linkBtn"  onclick="VTPrintAuthReceiptAJAX(' + BRNID + ',' + BSC + ',''CHECK'',''' + TicketGUID + ''');");>Print</a>   ';
               end else begin
                  Line := Line + '<a href="javascript://" class="linkBtn"  onclick="VTPrintAuthReceiptAJAX(' + BRNID + ',' + BSC + ',''CHECK'');");>Print</a>   ';
               end;
            end;
         end;
         Line := Line + '</CENTER></DIV><BR><BR>';
      end;
   end;
   BatchHTML.Add(Line);
   Result := batchHTML.Text;
   BatchHTML.Free;

end;

procedure TCustomerInfoModule.GetCheckImage;
Var
   WS: String;
   CheckSC : String;
   Profile : String;
begin

  WS := GetStyle('');

  CheckSC :=NumericOnly(Request.queryfields.Values['CHECKCODE']);
  Profile :=NumericOnly(Request.queryfields.Values['LOCATIONRNID']);
  ProcessLog(ltInfo,'GetCheckImage',CheckSC);
  If Not LoadTCAuth(CheckSC, Profile) then begin
   ProcessLog(ltInfo,'GetCheckImage Not Found:',CheckSC);
   exit;
  end;
  ProcessLog(ltInfo,'GetCheckImage Found:',CheckSC);
  DecodeImageData(RNQuery.fieldByName('Imagedata').AsString, CheckSC);
  (*
  Try
     if (RNReg.RegGetValAsString('PMACCESS.USELEGACYIMGCONVERT','FALSE') = 'TRUE') then begin //2018-01-25 jtm: D#3544
         TIFData := Base64Decode(RNQuery.fieldByName('Imagedata').AsString);
     end else begin
         TIFData := STDBase64Decode(RNQuery.fieldByName('Imagedata').AsString); //2017-03-22 jtm:  F#1414
     end;
  except
     On E:Exception do begin
        ProcessLog(ltWarning,'Image Decode Exception','GetCheckImage Image Size=' + Stri(Length(RNQuery.fieldByName('Imagedata').AsString),-1)+ 'StoreSystemCode=' +CheckSC);
     end;
  end;

  ImageGUID := GenerateGUID;
  FN := 'c:\ImageCache\' + ImageGUID + '.TIF';
  SaveStringAsFile(FN,TIFData);
  if not assigned(gdip) then begin
     Gdip.RegisterPictures;
  end;

  If Not FileExists(FN) then begin
     ProcessLog(ltWarning, 'Image File does Not Exist', FN);
     exit;
  end;

  tiff := TTiffImage.Create;
  S := TMemoryStream.Create;
  tiff.LoadFromFile(FN);
  Try
     SaveAs(tiff,S,gptJPG,80,700,200);
     ProcessLog(ltInfo, 'Image Resize complete, Setting TIF DPI to 200', 'Width:700');
  except
     On E:Exception do begin
        ProcessLog(ltInfo, 'Exception during resize', e.Message);
     end;
  end;
  *)
  (*commentted out on 2017-03-22 jtm:  F#1414LI := TLoadImage.create(NIL);
  LI.Width := 700;
  LI.Height := 300;
  with LI.Picture do begin
     Cur_Rect := Bounds(0, 0, 700, 300);
  end;
  LI.ImageFileName := 'c:\ImageCache\' + ImageGUID + '.TIF';
  LI.ReScale := 50;
  LI.ReDraw(Cur_rect, False, True);

  Jpg := TJpegImage.Create;
  try
     JPG.CompressionQuality := 90;
     Jpg.Assign(LI.Picture.Bitmap);
     ProcessLog(0,ltInfo,'JPGOK' + Stri(JPG.Width,-1),'GetCheckImage Image Size=' + Stri(Length(RNQuery.fieldByName('Imagedata').AsString),-1)+ 'StoreSystemCode=' +CheckSC,'',0,'');
  except
    on E:Exception do begin
      ProcessLog(0,ltWarning,'JPGConv Fail' + Stri(LI.Compression,-1),'GetCheckImage Image Size=' + Stri(Length(RNQuery.fieldByName('Imagedata').AsString),-1)+ 'StoreSystemCode=' +CheckSC,'',0,'');
    end;
  end;

  If JPG.Width = 0 then begin //Redo it for other decode
     JPG.Free;
     LI.Free;
     TIFData := STDBase64Decode(RNQuery.fieldByName('Imagedata').AsString);
     SaveStringAsFile('c:\ImageCache\' + ImageGUID + '.TIF',TIFData);
     LI := TLoadImage.create(NIL);
     LI.Width := 700;
     LI.Height := 300;
     with LI.Picture do begin
        Cur_Rect := Bounds(0, 0, 700, 300);
     end;
     THM := TTifHeaderManager.Create('c:\ImageCache\' + ImageGUID + '.TIF'); //we need to do this before we assign the ImageFileName property of LI because LI creates some kind of lock on the file
     LI.ImageFileName := 'c:\ImageCache\' + ImageGUID + '.TIF';
     LI.ReScale := 50;

     if THM.TLoadImageShouldInvert then begin //in other implementations we had to do some wonky stuff here since Invert acts more like a toggle. Since this thing gets disposed each time (CGI) we aren't worried about setting invert back to false
      LI.Invert := true;
     end;

     LI.ReDraw(Cur_rect, False, True);
     FreeAndNil(THM);


     Jpg := TJpegImage.Create;
     try
        JPG.CompressionQuality := 90;
        Jpg.Assign(LI.Picture.Bitmap);
        ProcessLog(0,ltInfo,'JPGOK' + Stri(JPG.Width,-1),'GetCheckImage Image Size=' + Stri(Length(RNQuery.fieldByName('Imagedata').AsString),-1)+ 'StoreSystemCode=' +CheckSC,'',0,'');
     except
       on E:Exception do begin
        ProcessLog(0,ltInfo,'JPGConv Fail' + Stri(LI.Compression,-1),'GetCheckImage Image Size=' + Stri(Length(RNQuery.fieldByName('Imagedata').AsString),-1)+ 'StoreSystemCode=' +CheckSC,'',0,'');
        end;
     end;
  end;     *)

  (*
  DeleteFiles(FN);

  S.Position := 0;
  Response.ContentType := 'image/jpeg';
  Response.ContentStream := S;// do not free the stream because the response
  tiff.Free;
  *)
end;

procedure TCustomerInfoModule.GetOpenBatchCheckImage;
Var
   WS: String;
   CheckSC : String;
   Profile : String;
   XMLResponse : String;
begin
  WS := GetStyle('');

  CheckSC :=NumericOnly(Request.queryfields.Values['CHECKCODE']);
  Profile :=NumericOnly(Request.queryfields.Values['LOCATIONRNID']);
  ProcessLog(ltInfo,'GetOpenBatchCheckImage',CheckSC);
  If GetTCImageDetail(Profile,CheckSC) then begin
   if (BatchOXML <> NIL) and (BatchOXML.GetValueAsWideString('/TRANRESP/TRANSUCCESS') = 'TRUE') then begin
      ProcessLog(ltInfo,'GetOpenBatchCheckImage Found:',CheckSC);
      DecodeImageData(BatchOXML.GetValueAsWideString('/TRANRESP/CHECKFACEDATA'), CheckSC); //2018-05-30 AJS: D#4737
   end else begin
      ProcessLog(ltInfo,'GetOpenBatchCheckImage Not Found:',CheckSC);
   end;
  end else begin
   ProcessLog(ltInfo,'GetOpenBatchCheckImage Not Found:',CheckSC);
   exit;
  end;
end;

procedure TCustomerInfoModule.DecodeImageData(ImageData : String; CheckCode : String);
Var
   TifData : String;
   S: TMemoryStream;
   ImageGUID : String;
   FN : string;
   tiff: TTiffImage;
   firstfour :string;
begin
   Try
      if (RNReg.RegGetValAsString('PMACCESS.USELEGACYIMGCONVERT','FALSE') = 'TRUE') then begin
         firstfour :=  copy(ImageData, 0, 4);
         ProcessLog(ltDebug, 'DecodeImageData', firstfour);
         if (firstfour = 'IKag') then begin   //Old starts with IKag
            TIFData := Base64Decode(ImageData);
         end else begin
            TIFData := STDBase64Decode(ImageData); //and new starts with SUkq
         end;
      end else begin
         TIFData := STDBase64Decode(ImageData);
      end;
   except
      On E:Exception do begin
         ProcessLog(ltWarning,'Image Decode Exception','DecodeImageData Image Size=' + Stri(Length(ImageData),-1)+ 'StoreSystemCode=' +CheckCode);
      end;
   end;

   ImageGUID := GenerateGUID;
   FN := 'c:\ImageCache\' + ImageGUID + '.TIF';
   SaveStringAsFile(FN,TIFData);
   if not assigned(gdip) then begin
      Gdip.RegisterPictures;
   end;

   If Not FileExists(FN) then begin
      ProcessLog(ltWarning, 'Image File does Not Exist', FN);
      exit;
   end;

   tiff := TTiffImage.Create;
   S := TMemoryStream.Create;
   tiff.LoadFromFile(FN);
   Try
      SaveAs(tiff,S,gptJPG,80,700,200);
      ProcessLog(ltInfo, 'Image Resize complete, Setting TIF DPI to 200', 'Width:700');
   except
      On E:Exception do begin
         ProcessLog(ltInfo, 'Exception during resize', e.Message);
      end;
   end;
   DeleteFiles(FN);
   S.Position := 0;
   Response.ContentType := 'image/jpeg';
   Response.ContentStream := S;// do not free the stream because the response
   tiff.Free;
end;

function TCustomerInfoModule.LoadTCAuth(StoreSystemCode: string; StoreCode: string): boolean;
Begin
   Result := False;
   RNQuery.Close;
   RNQuery.SQL.Text := 'Select * from TCAuth where (StoreSystemCode = ' + StoreSystemCode + ')' + 'and (StoreCode = ' + StoreCode + ')';
   RNQuery.Open;
   If RNQuery.RecordCount = 0 then begin
      exit;
   end;
   If NOT ValidateRNID(RNQuery.FieldByName('StoreCode').AsString) then begin
      exit;
   end;
   Result := RNQuery.RecordCount = 1;
end;

function TCustomerInfoModule.TCKEffectiveStatus(Status: string; AcceptDate: string; Voided: boolean): Integer;
var
  ES : Integer;
  AAcceptDate : TDateTime;
Begin
  if AcceptDate = '' then
    AAcceptDate := 0
  else
   AAcceptDate := StrToDateTime(AcceptDate);
  ES := 0;
  If (Trim(Status) = '1') and
     (AAcceptDate > 0) and
     (NOT Voided) then
     ES := 1;

  If (Trim(Status) = '3')
     Then ES := 3;
  If (Trim(Status) = '4')
     Then ES := 4;
  If (Trim(Status) = '')
     Then ES := -1;
  If (Trim(Status) = '-')
     Then ES := -1;
  Result := ES;

end;

function TCustomerInfoModule.EscapeJSONTokens(value: String): String;
var
   jsonifiedStr : String;
begin
   jsonifiedStr := value;
   jsonifiedStr := StringReplace(jsonifiedStr, '\', '\\', [rfReplaceAll, rfIgnoreCase]);
   jsonifiedStr := StringReplace(jsonifiedStr, '"', '\"', [rfReplaceAll, rfIgnoreCase]);
   jsonifiedStr := StringReplace(jsonifiedStr, '/', '\/', [rfReplaceAll, rfIgnoreCase]);
   jsonifiedStr := StringReplace(jsonifiedStr, chr(10), '\n', [rfReplaceAll, rfIgnoreCase]);
   jsonifiedStr := StringReplace(jsonifiedStr, chr(13), '\r', [rfReplaceAll, rfIgnoreCase]);
   jsonifiedStr := StringReplace(jsonifiedStr, chr(9), '\t', [rfReplaceAll, rfIgnoreCase]);
   Result := jsonifiedStr;

end;

function TCustomerInfoModule.GenerateCustomReportOptions: string;
var
CustomReportNode : TOpenXMLNode;
HTMLStrings : TStringList;
begin
   HTMLStrings := TStringList.Create;
   CustomReportNode := DomainConfigXML.GetNode('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CUSTOMREPORTS');
   CustomReportNode := CustomReportNode.FindFirstChildElement;
   while CustomReportNode <> nil do begin
      if DomainConfigXML.GetContextValueAsWideString(CustomReportNode,'DISPLAYTYPE') = 'BUTTON' then begin
          HTMLStrings.Append('<a href="javascript://" onclick="GetCustomReportDownload('''+ DomainConfigXML.GetContextValueAsWideString(CustomReportNode,'@NAME') +''');" class="linkBtn">' + DomainConfigXML.GetContextValueAsWideString(CustomReportNode,'DISPLAYNAME') + '</a><br><br>');
      end else if DomainConfigXML.GetContextValueAsWideString(CustomReportNode,'DISPLAYTYPE') = 'BUTTONCHUNKED' then begin //2017-07-19 jtm: F#1879
          HTMLStrings.Append('<a href="javascript://" onclick="GetCustomReportChunkDownload('''+ DomainConfigXML.GetContextValueAsWideString(CustomReportNode,'@NAME') +''','''+DomainConfigXML.GetContextValueAsWideString(CustomReportNode,'@NAME')+''');" id="Report'+DomainConfigXML.GetContextValueAsWideString(CustomReportNode,'@NAME')+'" class="linkBtn">' + DomainConfigXML.GetContextValueAsWideString(CustomReportNode,'DISPLAYNAME') + '</a><br><br>');
      end;
      CustomReportNode := CustomReportNode.FindNextSiblingElement;
   end;
   Result := HTMLStrings.Text;
   HTMLStrings.Free;
end;

function TCustomerInfoModule.GetCustomReport(AReportName, ADisplayFormat, ARNID: String; FromDate, ThruDate: TDateTime; xExport: TOExport): String;
var
ReportNode : TOpenXMLNode;
RecordFormatType : TRecordFormatType;
ReportDelimiterType : TReportDelimiterType;
HeaderFieldList : TTTStringList;
ReportFieldList : TTTStringList;
Row : TStringList;
XMLFile : TStringList;
Report : TStringList;
ReportDelimiter,ReportXML,FieldName,RootTag : string;
ADS: TDataSet;
AnySQLReporting: TQueryReportDM;
i, RecordCount : integer;
Fld: TField;
IncludeProfileFields : boolean;
ProfileStoreCode : string;
PreviousProfileStoreCode : Variant;
ProfileSCFieldName : string;
AddHeaders : boolean;//2017-06-07 jtm: F#1856

JSON : TStringList;
JSONString : string;

xlsWorkSheet : TExportWorksheet; //Represents actual xls worksheet
xlsRow : TExportRow; //Represents actual row inside the TExportWorksheet
ReportDBIndexFieldList : TTTStringList; //2018-04-11 jtm D#4180
Field : TField;
   function GetFieldValue(FieldName: String; ADS: TDataSet): String;
   var
      AField : TField;
   begin
      Result := '';
      FieldName := Trim(UpCaseString(FieldName));
      AField := ADS.FindField(FieldName);
      If AField <> Nil then begin
         Result := Trim(AField.AsString);
      end else begin
         fExprEval.ADS := ADS;
         Result  := VarExprEvalAsString('', FieldName);
      end;
   end;

   function WriteRow(ARecordFormatType : TRecordFormatType; ADelimiter:TReportDelimiterType; ARow: TStringList; ADS: TDataSet; AHeaders: TStringList): String;
   var
      OutStr : String;
      I,it : Integer;
      OutHeader : String;
      addedHeaders : boolean; //2018-04-11 bls D#4257
      dataTypeNotStr : boolean; //2018-04-11 jtm D#4180
      floatString : string;
   Begin
      OutStr := '';
      OutHeader := '';
      if xExport <> nil then begin
         xlsRow := xlsWorkSheet.AddRow;
      end;

      If ADelimiter = ttrdtCSV then begin
         OutStr := Row.CommaText;
         OutHeader := AHeaders.CommaText;
      end else if ADelimiter = ttrdtPipe then begin
         For I := 0 to Row.Count -1 do begin
            OutStr := OutStr + Row[I] + '|';
            If (AHeaders.Count >= (I + 1)) then OutHeader := OutHeader + AHeaders[I] + '|';
         end;
      end else if ADisplayFormat = 'JSON' then begin
         For I := 0 to Row.Count -1 do begin   //2018-05-15 bls: D#4180
            try
               dataTypeNotStr := false;
               if (ReportDBIndexFieldList[I] <> '') then begin
                  it := StrToInt(ReportDBIndexFieldList[I]);
                  if (ADS.Fields.Fields[it].DataType = ftFloat) OR (ADS.Fields.Fields[it].DataType = ftCurrency) OR (ADS.Fields.Fields[it].DataType = ftBCD) then begin
                     dataTypeNotStr := true;
                  end;
               end;
               if (dataTypeNotStr) then begin
                  if (ADS.Bof) then ProcessLog(ltDebug,'add as currency Row[I];Fields[I]',Row[I]+';'+ADS.Fields.Fields[it].AsString);

                  floatString := Format('%m', [strtofloat(Row[I])]);

                  if (strtofloat(Row[I]) < 0) then begin   // 2018-06-20 bls: D#4930   // If a number is negative
                     floatString := stringreplace(floatString, '(','',[rfReplaceAll]); // Remove delphi's added ( and ) characters
                     floatString := stringreplace(floatString, ')','',[rfReplaceAll]);
                     insert('-',floatString,1);                                        // Add a - character to the front
                  end;

                  floatString := stringreplace(floatString, ',','',[rfReplaceAll]);    // Replace all ',' with nothing
                  floatString := stringreplace(floatString, '$','',[rfReplaceAll]);    // Replace all '$' with nothing
                  
                  JSON.Append('"' + AHeaders[I] + '":' + floatString + ',');
               end else begin
                  JSON.Append('"' + AHeaders[I] + '":"' + Row[I] + '",');
                  if (ADS.Bof) then ProcessLog(ltDebug,'add as string Row[I];Fields[I]',Row[I]+';'+ADS.Fields.Fields[it].AsString);
               end;
            except
               JSON.Append('"' + AHeaders[I] + '":"' + Row[I] + '",');
            end;
         end;
      end else begin
         addedHeaders := false;
         If AHeaders.Count > 0 then begin
            For I := 0 to Row.Count -1 do begin

               If (AHeaders.Count >= (I + 1)) then begin
                  xlsRow.AddCellString(AHeaders[I]).SetFontColor(clBlack).SetBorder(cbBottom).SetBGColor(TColor($80000000)).SetAlignment(cahCenter); //OutHeader := OutHeader + AHeaders[I] + #9;
                  addedHeaders := true;
               end;
            end;
         end;
         if addedHeaders then begin
            xlsRow := xlsWorkSheet.AddRow;
         end;
         For I := 0 to Row.Count -1 do begin
            try
               dataTypeNotStr := false;
               if (ReportDBIndexFieldList[I] <> '') then begin
                  it := StrToInt(ReportDBIndexFieldList[I]);
                  if (ADS.Fields.Fields[it].DataType = ftFloat) OR (ADS.Fields.Fields[it].DataType = ftCurrency) OR (ADS.Fields.Fields[it].DataType = ftBCD) then begin
                     dataTypeNotStr := true;
                  end;
               end;
               if (dataTypeNotStr) then begin
                  if (ADS.Bof) then ProcessLog(ltDebug,'add as currency Row[I];Fields[I]',Row[I]+';'+ADS.Fields.Fields[it].AsString);
                  xlsRow.AddCellCurrency(strtofloat(Row[I]));
               end else begin
                  xlsRow.AddCellString(Row[I]);
                  if (ADS.Bof) then ProcessLog(ltDebug,'add as string Row[I];Fields[I]',Row[I]+';'+ADS.Fields.Fields[it].AsString);
               end;
            except
               xlsRow.AddCellString(Row[I]);
            end;
         end;
      end;
      If AHeaders.Count > 0 then begin
         if (Report.Count = 0) then begin
            Report.Append(OutHeader);
            ProcessLog(ltDebug,'ReportDBIndexFieldList',ReportDBIndexFieldList.CommaText);
         end;
      end;

      Report.Append(Outstr);
   end;
   function ProcessQueryXML(Node : TOpenXMLNode): string;
   var
      ParamNode : TOpenXMLNode;
      QueryXML : TOpenXML;
      QueryXMLStr,ParamVal : string;
   begin
      result := '';
      if node = nil then exit;
      ParamNode := DomainConfigXML.GetContextNode(Node,'QUERY');
      try
         QueryXML := TOpenXML.CreateFromString(nil,DomainConfigXML.GetContextNodeAsXMLString(ParamNode,true));
      except
         on E:Exception do begin
            ProcessLog(ltWarning,'Exception on QueryXML ProcessQueryXML',E.Message);
         end;
      end;
      if QueryXML <> nil then begin
         ParamNode := QueryXML.GetNode('/QUERY/PARAMSLIST');
         ParamNode := ParamNode.FindFirstChildElement;
         while ParamNode <> nil do begin
            if QueryXML.GetContextValueAsWideString(ParamNode,'VALUE[@TYPE="STATIC"]') = '' then begin
               ParamVal := QueryXML.GetContextValueAsWideString(ParamNode,'VALUE');
               try
                  ParamVal := VarExprEvalAsString('', ParamVal);
                  QueryXML.EditContextNodeValue(QueryXML.GetContextNode(ParamNode,'VALUE'),ParamVal);
               except
                  on E:Exception do begin
                     ProcessLog(ltWarning,'Exception on VarExprEvalAsString ProcessQueryXML',E.Message);
                  end;
               end;
            end;
            ParamNode := ParamNode.FindNextSiblingElement;
         end;

          Result := QueryXML.DocumentAsString;
      end;
      if assigned(QueryXML) then FreeAndNil(QueryXML);
   end;
   procedure AddProfileFieldsToVars;
   begin
      if ProfileXML = nil then exit;
      VarEvaluator.AddValue('ProfileField1',ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/VALUE', ''));
      VarEvaluator.AddValue('ProfileField2',ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/VALUE', ''));
      VarEvaluator.AddValue('ProfileField3',ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/VALUE', ''));
      VarEvaluator.AddValue('ProfileField4',ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/VALUE', ''));
      VarEvaluator.AddValue('ProfileField5',ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/VALUE', ''));
      VarEvaluator.AddValue('ProfileField6',ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/VALUE', ''));
   end;
   procedure ClearProfileFieldsToVars; //2017-08-24 jtm: D#1872
   begin
      if ProfileXML = nil then exit;
      VarEvaluator.AddValue('ProfileField1','');
      VarEvaluator.AddValue('ProfileField2','');
      VarEvaluator.AddValue('ProfileField3','');
      VarEvaluator.AddValue('ProfileField4','');
      VarEvaluator.AddValue('ProfileField5','');
      VarEvaluator.AddValue('ProfileField6','');
   end;
begin
   processlog(ltInfo, 'GetCustomReport', 'Begin Report;DisplayFormat: ' + AReportName+';'+ADisplayFormat);
   Result := '';
   if AReportName = '' then exit;
   HeaderFieldList := TTTStringList.Create;
   ReportFieldList := TTTStringList.Create;
   JSON := TStringList.Create;
   IncludeProfileFields := false;
   Row := TStringList.Create;
   XMLFile := TStringList.Create;
   Report := TStringList.Create;
   HeaderFieldList.Delimiter := '|';
   ReportFieldList.Delimiter := '|';
   HeaderFieldList.StrictDelimiter := true;
   ReportFieldList.StrictDelimiter := true;
   i := 0;
   RecordCount := 0;
   PreviousProfileStoreCode := Null;
   AddHeaders := false;
   ReportDBIndexFieldList := TTTStringList.Create;
   if xExport <> nil then begin
      xlsWorkSheet := xExport.AddWorkSheet;
   end;

   JSON.Append('[');
   try
      If ADisplayFormat = 'XML' then begin
         RecordFormatType := ttrftXML;
      end else If ADisplayFormat = 'HTML'  then begin
         RecordFormatType := ttrftHTML;
      end else If ADisplayFormat = 'JSON' then begin
         RecordFormatType := ttrftJSON;   
      end else begin
         RecordFormatType := ttrftXLS;
      end;
      ReportNode := DomainConfigXML.GetNode('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CUSTOMREPORTS/CUSTOMREPORT[@NAME="'+ AReportName + '"]');
      if ReportNode <> nil then begin
         processlog(ltInfo, 'GetCustomReport', 'ReportNode exists');
         HeaderFieldList.DelimitedText := DomainConfigXML.GetContextValueAsWideString(ReportNode,'HEADERFIELDLIST');
         ReportFieldList.DelimitedText := DomainConfigXML.GetContextValueAsWideString(ReportNode,'REPORTFIELDLIST');
         IncludeProfileFields := DomainConfigXML.GetContextValueAsBoolean(ReportNode,'INCLUDEPROFILEFIELDS');
         ProfileSCFieldName := DomainConfigXML.GetContextValueAsWideString(ReportNode,'RNIDFIELDNAME');
         AnySQLReporting:= TQueryReportDM.Create(HDDB,RNDB,nil);
         if AnySQLReporting = nil then exit;
         AnySQLReporting.OnProcessLog := PL.ProcessLog;
         ReportDelimiter  := DomainConfigXML.GetContextValueAsWideString(ReportNode,'REPORTDELIMITER');
         If (ReportDelimiter = '') then begin
            if (RecordFormatType = ttrftXML) then begin
               ReportDelimiterType := ttrdtRow;
            end else begin
               ReportDelimiterType := ttrdtTab;
            end;
         end else begin
            if ReportDelimiter = 'CSV' then begin
                ReportDelimiterType := ttrdtCSV;
            end else if ReportDelimiter = 'PIPE' then begin
               ReportDelimiterType := ttrdtPipe;
            end else begin
               ReportDelimiterType := ttrdtTab;
            end;
         end;
         ReportXML := ProcessQueryXML(ReportNode);    //    '<QUERY>' + DomainConfigXML.GetContextNodeAsXMLString(ReportNode,false) + '</QUERY>';
         processlog(ltInfo, 'GetCustomReport', ' Start GenerateDataSet');
         ADS :=  AnySQLReporting.GenerateDataSet('Delphi5', ReportXML);
         if ADS <> nil then begin
            processlog(ltInfo, 'GetCustomReport', 'GenerateDataSet Finshed; Count:'+ IntToStr(ADS.RecordCount));
            if (ReportFieldList.Count = 0) then begin
               for i := 0 to pred(ADS.FieldCount) do begin
                  Fld := ADS.Fields[i];
                  FieldName := Fld.FieldName;
                  ReportFieldList.Append(FieldName);
               end;
            end;
            if (HeaderFieldList.Count = 0) then AddHeaders := true;//2017-06-07 jtm: F#1856
            if IncludeProfileFields then begin
               processlog(ltInfo, 'GetCustomReport', 'IncludeProfileFields');
               ProfileStoreCode := GetFieldValue(ProfileSCFieldName,ADS);
               if ProfileStoreCode <> '' then begin //2017-08-24 jtm: D#1872
                  if not Assigned(ProfileXML) then ProfileXML := TTProfileXML.Create(StrToInt(Trim(ProfileStoreCode)), HDQuery);
                  AddProfileFieldsToVars;
               end;
               PreviousProfileStoreCode := ProfileStoreCode;
            end;
            For I := 0 to ReportFieldList.Count -1 do begin //2018-04-11 jtm D#4180
               Field := ADS.FindField(ReportFieldList[i]);
               if (Field <> nil) then begin
                  ReportDBIndexFieldList.Append(IntToStr(Field.Index));
                  ProcessLog(ltDebug,'Field.Index;Field.AsString',IntToStr(Field.Index) + ';' +Field.AsString);
               end else begin
                  ReportDBIndexFieldList.Append('');
               end;
            end;
            processlog(ltInfo, 'GetCustomReport', 'Start Loop');
            While Not ADS.EOF do begin
               Inc(RecordCount);
               Row.Clear;
               if IncludeProfileFields then begin
                  ProfileStoreCode := GetFieldValue(ProfileSCFieldName,ADS);
                  if (PreviousProfileStoreCode <> ProfileStoreCode) then begin
                     if ProfileStoreCode <> '' then begin //2017-08-24 jtm: D#1872
                        ProfileXML := TTProfileXML.Create(StrToInt(Trim(ProfileStoreCode)), HDQuery);
                        AddProfileFieldsToVars;
                     end else begin
                        ClearProfileFieldsToVars; //if we can't load the ProfileXML, then we need to clear the Profile fields
                     end;
                     PreviousProfileStoreCode := ProfileStoreCode;
                  end;
               end;

               For I := 0 to ReportFieldList.Count -1 do begin
                  FieldName := ReportFieldList[I];

                  If RecordFormatType = ttrftXML then begin
                     Row.Append('<' + FieldName + '>' + ToUTF(GetFieldValue(FieldName,ADS)) +'</' + FieldName + '>' );
                  end else begin
                     If (AddHeaders and (RecordCount = 1)) then begin //2017-06-07 jtm: F#1856
                        HeaderFieldList.Add(FieldName);
                     end;
                     Row.Append(GetFieldValue(FieldName,ADS));
                  end;
               end;

               If RecordFormatType = ttrftXML then begin
                  XMLFile.Add('<' + ReportDelimiter + '>' + Row.Text + '</' + ReportDelimiter + '>');
               end else begin
                  if ADisplayFormat = 'JSON' then begin
                     JSON.Append('{');
                  end;
                  WriteRow(RecordFormatType, ReportDelimiterType,Row,ADS,HeaderFieldList);
                  if ADisplayFormat = 'JSON' then begin
                     JSONString := JSON.Strings[JSON.Count - 1];
                     JSON.Delete(JSON.Count - 1);
                     delete(JSONString, length(JSONString), 1);
                     JSON.Append(JSONString + '},');
                  end;
                  if (RecordCount = 1) AND (ADisplayFormat <> 'JSON') then HeaderFieldList.Clear;
               end;
               ADS.Next;
               if ((RecordCount mod 1000) = 0) then begin
                  processlog(ltInfo, 'GetCustomReport', '1000 rows written so far');
               end;
            end;
            processlog(ltInfo, 'GetCustomReport', 'End Loop');
            If RecordFormatType = ttrftXML then begin
               RootTag := DomainConfigXML.GetContextValueAsWideString(ReportNode,'ROOTTAG');
               if (RootTag = '') then begin
                  processlog(ltWarning, 'No <ROOTTAG> For XML', 'Setting as ROOTMISSING');
                  RootTag := 'ROOTMISSING';
               end;
               XMLFile.Insert(0,'<?xml version="1.0"?>' + CRLF+ '<' + RootTag +'>');
               XMLFile.Add('</' + RootTag +'>');
               Report.clear;
               Report.AddStrings(XMLFile);
            end;
         end else begin
             processlog(ltInfo, 'GetCustomReport', 'GenerateDataSet nil');
         end;
      end;

      case RecordFormatType of
         ttrftXML: begin
                     Response.ContentType := 'text/xml';
                     Result := Report.Text;
                  end;
         ttrftXLS: begin
                     Response.ContentType := 'application/vnd.ms-excel';
                     Response.CustomHeaders.Values['Content-Disposition'] := 'attachment; filename=' + AReportName + FormatDateTime('MMDDYY',date) + '.xls';
                     Result := 'attachment; filename=' + AReportName + FormatDateTime('MMDDYY',date) + '.xls';
                  end;
         ttrftJSON: begin
                     JSONString := stringreplace(JSON.Text, #13,'',[rfReplaceAll]); // Sets JSONString equal to all of the text in the JSON String list; Replaces all Carriage Return characters with nothing
                     JSONString := stringreplace(JSONString, #10,'',[rfReplaceAll]); // Replaces all Line Feed characters with nothing
                     delete(JSONString, length(JSONString), 1); // Deletes the trailing comma in the JSONString
                     Response.ContentType := 'application/json';
                     Result := JSONString + ']'; // Sends the complete JSONString back with a closing square bracket
                  end;
         ttrftHTML,
         ttrftAJAX: begin
                     Response.ContentType := 'text/html';
                     Result := Report.Text;
                  end;
      end;
      Response.CustomHeaders.Values['Cache-Control'] := 'private';
      Response.CustomHeaders.Values['Pragma'] := 'private';

   except
      on E:Exception do begin
         ProcessLog(ltWarning,'Exception on GetCustomReport',E.Message);
      end;
   end;
   if assigned(AnySqlReporting) then FreeAndNil(AnySQLReporting);
   HeaderFieldList.Free;
   ReportFieldList.Free;
   Row.Free;
   Report.Free;
   XMLFile.Free;
   JSON.Free;
   FreeAndNil(ProfileXML);
   processlog(ltInfo, 'GetCustomReport', 'End Report: '+AReportName);
end;


function TCustomerInfoModule.GenerateSubAccountsOnFileAdmin(CustGUID: String): String;
var
  CG : String;
  SchedCnt : Integer;
Begin
   RNQuery.Close;
   RNQuery.SQL.Clear;
   RNQuery.SQL.Add('Select * from CustChild left outer join store on (store.systemcode = CustChild.RNID) where (CustGUID = :CustGUID) and (Hidden=0)');
   RNQuery.Parameters.ParamByName('CustGUID').Value := GuidOnly(CustGUID);
   RNQuery.Open;

   If RNQuery.RecordCount >0  then begin
      While Not RNQuery.EOF do begin
         SchedCnt := ComputeCustomerSchedulesUsedByChildGUID(CustGUID,(RNQuery.FieldByName('ChildGUID').AsString));

         CG := CG + '<tr><td>' + Trim(RNQuery.FieldByName('FirstName').AsString) + ' ' +
                                 Trim(RNQuery.FieldByName('LastName').AsString) + '</td><td>' +
                                 Trim(RNQuery.FieldByName('Name').AsString) + ', ' +
                                    Trim(RNQuery.FieldByName('City').AsString) + ' ' +
                                    Trim(RNQuery.FieldByName('State').AsString)+'</TD>';
         If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERPROFILE/EDITSUBACCOUNT', 'FALSE') = 'TRUE' then begin
            CG := CG + '<TD><a href="" title="Edit Account" onclick="EditCustChild('''+CustGUID+''','''+Trim(RNQuery.FieldByName('ChildGUID').AsString)+'''); return false;" class="mdbutton">'+Trim(RNQuery.FieldByName('AccountNumber').AsString)+'</a></td>';
         end else begin
            CG := CG + '<TD>' + Trim(RNQuery.FieldByName('AccountNumber').AsString) + '</TD>';
         end;
         
         If SchedCnt > 0 then
               CG := CG + '<TD>Cancel scheduled payments to remove</TD></TR>'
         else
               CG := CG + '<TD><a href="" title="Remove Payment" onclick="RemoveCustChild('''+CustGUID+''','''+Trim(RNQuery.FieldByName('ChildGUID').AsString)+'''); return false;" class="mdbutton">Remove</a></td></tr>';

         RNQuery.Next;
      end;
   end else begin
      CG := CG + '<TR><TD><B>**No '+OpenXMLGetTag('/CONFIGDATA/UIPARAMS/CHILDDESCRIPTION', 'SubAccounts')+' on file**</B></TD></TR>';
   end;
   Result := cg;

end;

function TCustomerInfoModule.ComputeCustomerSchedulesUsedByChildGUID(CustGUID, ChildGUID: String): Integer;
var
   AQuery : TADOQuery;
Begin
   Result := 0;
   CustGUID := GuidOnly(CustGUID);
   ChildGUID := GUIDOnly(ChildGUID);
   If CustGUID = '' then exit;
   If ChildGUID = '' then exit;

   AQuery := NewADOQuery;
   AQuery.SQL.Clear;
   AQuery.SQL.Add('Select Count(*) as SchedCount from custPaySched');
   AQuery.SQL.Add('Where (CustGUID =''' + CustGUID + ''') and (ChildGUID = ''' + ChildGUID + ''')');
   AQuery.Open;
   Result := AQuery.FieldByName('SchedCount').AsInteger;
   AQuery.Close;
   AQuery.Free;

end;

Function TCustomerInfoModule.GetServiceNamesByRNID(ARNID: string; AProfileName : string;var ASL : TStringList;var ASL2 : TStringList): integer;
var
   I : integer;
   HTML : string;
begin
   if ARNID = '' then exit;
   if AProfileName = '' then AProfileName := 'DEFAULT';
   HDQuery.Close;
   HDQuery.SQL.Clear;
   HDQuery.SQL.Add('set transaction isolation level read uncommitted;');
   HDQuery.SQL.Add('Declare @ProfileName as char(20);');
   HDQuery.SQL.Add('Declare @RNID as int;');
   HDQuery.SQL.Add('Set @ProfileName =:ProfileName;');
   HDQuery.SQL.Add('Set @RNID =:RNID;');
   HDQuery.SQL.Add('select ''Servicename'' = case when mid.MODIFIER > '''' then ''CARD-''+ mid.MODIFIER else ''CARD'' end, LTrim(RTrim(mid.MID)) as ''MerchantID'', LTrim(RTrim(tid.TID)) as ''TerminalID'', LTrim(RTrim(CCDID.DID)) as ''DatawireID'', LTrim(RTrim(CCHOST.HOST)) as ''Host'',');
   HDQuery.SQL.Add('LTrim(RTrim(CCTRANSPORT.TRANSPORT)) as ''Transport'', LTrim(RTrim(CCACCTDESC.ACCTDESC)) as ''AccountDesc'', LTrim(RTrim(CCACCTTYPE.ACCTTYPE)) as ''Type'', ');
   HDQuery.SQL.Add('(case when CCDCCENABLED.DCCENABLED = ''TRUE'' then CAST(''TRUE'' as bit) else CAST(''FALSE'' as bit) end) as ''DCCENABLED'', ');
   HDQuery.SQL.Add('(case when LEVEL2SETTLE.LEVEL2SETTLE = ''TRUE'' then CAST(''TRUE'' as bit) else CAST(''FALSE'' as bit) end) as ''L2Settle'', ');
   HDQuery.SQL.Add('(case when CCDISABLED.DISABLED = ''TRUE'' then CAST(''TRUE'' as bit) else CAST(''FALSE'' as bit) end) as ''Disabled'',');
   HDQuery.SQL.Add('LTrim(RTrim(CCINACTIVEMID.INACTIVEMID)) as ''InactiveMID''');
   HDQuery.SQL.Add('from (');
   HDQuery.SQL.Add('select PROFILENAME as rnid, rtrim(tagvalue) as MID, Modifier');
   HDQuery.SQL.Add('from rnprofiles');
   HDQuery.SQL.Add('where profiletag = ''CCMID'' ');
   HDQuery.SQL.Add('AND RNID = @RNID');
   HDQuery.SQL.Add('AND ProfileName= @ProfileName');
	HDQuery.SQL.Add(') mid full outer join');
	HDQuery.SQL.Add('( select PROFILENAME as rnid, rtrim(tagvalue) as TID, Modifier');
   HDQuery.SQL.Add('from rnprofiles');
   HDQuery.SQL.Add('where profiletag = ''CCTID'' ');
   HDQuery.SQL.Add('AND RNID = @RNID');
   HDQuery.SQL.Add('AND ProfileName= @ProfileName');
	HDQuery.SQL.Add(') TID on Mid.rnid = tid.rnid');
   HDQuery.SQL.Add('and mid.modifier = tid.modifier full outer join');
	HDQuery.SQL.Add('( select PROFILENAME as rnid, rtrim(tagvalue) as HOST, Modifier');
   HDQuery.SQL.Add('from rnprofiles');
   HDQuery.SQL.Add('where profiletag = ''CCHOST'' ');
   HDQuery.SQL.Add('AND RNID = @RNID');
   HDQuery.SQL.Add('AND ProfileName= @ProfileName');
	HDQuery.SQL.Add(') CCHOST on Mid.rnid = CCHOST.rnid');
   HDQuery.SQL.Add('and mid.modifier = CCHOST.modifier full outer join');
	HDQuery.SQL.Add('( select PROFILENAME as rnid, rtrim(tagvalue) as TRANSPORT, Modifier');
   HDQuery.SQL.Add('from rnprofiles');
   HDQuery.SQL.Add('where profiletag = ''CCTRANSPORT''');
   HDQuery.SQL.Add('AND RNID = @RNID');
   HDQuery.SQL.Add('AND ProfileName= @ProfileName');
	HDQuery.SQL.Add(') CCTRANSPORT on Mid.rnid = CCTRANSPORT.rnid');
   HDQuery.SQL.Add('and mid.modifier = CCTRANSPORT.modifier full outer join');
	HDQuery.SQL.Add('( select PROFILENAME as rnid, rtrim(tagvalue) as ACCTTYPE, Modifier');
   HDQuery.SQL.Add('from rnprofiles');
   HDQuery.SQL.Add('where profiletag = ''CCACCTTYPE'' ');
   HDQuery.SQL.Add('AND RNID = @RNID');
   HDQuery.SQL.Add('AND ProfileName= @ProfileName');
	HDQuery.SQL.Add(') CCACCTTYPE on Mid.rnid = CCACCTTYPE.rnid');
   HDQuery.SQL.Add('and mid.modifier = CCACCTTYPE.modifier full outer join');
   HDQuery.SQL.Add('( select PROFILENAME as rnid, rtrim(tagvalue) as ACCTDESC, Modifier');
   HDQuery.SQL.Add('from rnprofiles');
   HDQuery.SQL.Add('where profiletag = ''CCACCTDESC'' ');
   HDQuery.SQL.Add('AND RNID = @RNID');
   HDQuery.SQL.Add('AND ProfileName= @ProfileName');
	HDQuery.SQL.Add(') CCACCTDESC on Mid.rnid = CCACCTDESC.rnid');
   HDQuery.SQL.Add('and mid.modifier = CCACCTDESC.modifier full outer join');
	HDQuery.SQL.Add('( select PROFILENAME as rnid, rtrim(tagvalue) as DCCENABLED, Modifier');
   HDQuery.SQL.Add('from rnprofiles');
   HDQuery.SQL.Add('where profiletag = ''CCDCCENABLED''');
   HDQuery.SQL.Add('AND RNID = @RNID');
   HDQuery.SQL.Add('AND ProfileName= @ProfileName');
	HDQuery.SQL.Add(') CCDCCENABLED on Mid.rnid = CCDCCENABLED.rnid');
   HDQuery.SQL.Add('and mid.modifier = CCDCCENABLED.modifier full outer join');
	HDQuery.SQL.Add('( select PROFILENAME as rnid, rtrim(tagvalue) as LEVEL2SETTLE, Modifier');
   HDQuery.SQL.Add('from rnprofiles');
   HDQuery.SQL.Add('where profiletag = ''LEVEL2SETTLE'' ');
   HDQuery.SQL.Add('AND RNID = @RNID');
   HDQuery.SQL.Add('AND ProfileName= @ProfileName');
	HDQuery.SQL.Add(') LEVEL2SETTLE on Mid.rnid = LEVEL2SETTLE.rnid');
   HDQuery.SQL.Add('and mid.modifier = LEVEL2SETTLE.modifier full outer join');
	HDQuery.SQL.Add('( select PROFILENAME as rnid, rtrim(tagvalue) as DISABLED, Modifier');
   HDQuery.SQL.Add('from rnprofiles');
   HDQuery.SQL.Add('where profiletag = ''CCDISABLED'' ');
   HDQuery.SQL.Add('AND RNID = @RNID');
   HDQuery.SQL.Add('AND ProfileName= @ProfileName');
	HDQuery.SQL.Add(') CCDISABLED on Mid.rnid = CCDISABLED.rnid');
   HDQuery.SQL.Add('and mid.modifier = CCDISABLED.modifier full outer join');
	HDQuery.SQL.Add('( select PROFILENAME as rnid, rtrim(tagvalue) as INACTIVEMID, Modifier');
   HDQuery.SQL.Add('from rnprofiles');
   HDQuery.SQL.Add('where profiletag = ''CCINACTIVEMID'' ');
   HDQuery.SQL.Add('AND RNID = @RNID');
   HDQuery.SQL.Add('AND ProfileName= @ProfileName');
	HDQuery.SQL.Add(') CCINACTIVEMID on Mid.rnid = CCINACTIVEMID.rnid');
	HDQuery.SQL.Add('and mid.modifier = CCINACTIVEMID.modifier full outer join');
	HDQuery.SQL.Add('( select PROFILENAME as rnid, rtrim(tagvalue) as DID, Modifier');
	HDQuery.SQL.Add('from rnprofiles');
	HDQuery.SQL.Add('where profiletag = ''CCDID'' ');
   HDQuery.SQL.Add('AND RNID = @RNID');
   HDQuery.SQL.Add('AND ProfileName= @ProfileName');
	HDQuery.SQL.Add(')  CCDID on Mid.rnid = CCDID.rnid');
	HDQuery.SQL.Add('and mid.modifier = CCDID.modifier');
	HDQuery.SQL.Add('order by Cast(mid.modifier as int)');
   HDQuery.Parameters.ParamValues['RNID']:= StrToInt(ARNID);
   HDQuery.Parameters.ParamValues['ProfileName']:= AProfileName;
   HDQuery.Open;

   ASL.Clear;
   ASL2.Clear;

   I := 0;
   While Not HDQuery.EOF Do begin
      Inc(I);
      ASL.Add(trim(HDQuery.FieldByName('Servicename').AsString));
      ASL2.Add(trim(HDQuery.FieldByName('AccountDesc').AsString));
      HDQuery.Next;
   end;
   HDQuery.Close;
   Result := I;
end;

function TCustomerInfoModule.GetServiceNamesDropDown(ARNID, AProfileName,AFieldID: string; AIncludeAll: boolean;ACheckReadOnly:boolean): string;
var
  HTML : string;
  ServNames : TStringList;
  ServDesc  : TStringList;
  i:integer;
  ServiceNamesByRNID: integer;//2017-09-20 jtm: D#1946
begin
   ServNames := TStringList.Create;
   ServDesc  := TStringList.Create;
   i:=0;
   ServiceNamesByRNID := GetServiceNamesByRNID(ARNID,AProfileName,ServNames,ServDesc); //2018-01-25 ajs: F#2378
   if UserXML.GetNode('/USERPROFILE/RNIDACCESS/RNID[@ID="'+trim(ARNID)+'"]/SERVICENAMES') <> nil then begin
      GetUserServNameAccessByRNID(ServNames,ARNID,ACheckReadOnly,ServiceNamesByRNID); //if this user has xml for this service name, then use it
   end;
   HTML := '<select id="'+AFieldID+'" name="'+AFieldID+'" >';
   if AIncludeAll and (ServNames.Count >1) then HTML := HTML + '<option Value="ALL">All</option>';
   for i:=0 to ServNames.Count-1 do begin
      HTML := HTML + '<option Value="' + Trim(ServNames[i]) + '">';
      if ((OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SERVICENAMEFORMAT') = 'ACCTDESC') and (Trim(ServDesc[i]) <> '')) then begin
         HTML := HTML + Trim(ServDesc[i]);
      end else begin
         HTML := HTML + Trim(ServNames[i]);
      end;
      HTML := HTML + '</option>';
   end;
   HTML := HTML + '</select>' + CRLF;
   result :=  HTML;
   FreeAndNil(ServNames);
   FreeAndNil(ServDesc);
end;
function TCustomerInfoModule.GetUserServNameAccessByRNID(ASL: TStringList;ARNID:string;CheckReadOnly:boolean;DefaultServiceNameCount:integer): Integer;
var
   I : Integer;
   ServNameAccessXMLNode : TOpenXMLNode;
Begin
   I := 0;
   If not Assigned(UserXML) then exit;
   if UserXML.GetNode('/USERPROFILE/RNIDACCESS/RNID[@ID="'+trim(ARNID)+'"]/SERVICENAMES') <> nil then begin
      ServNameAccessXMLNode := UserXML.GetNode('/USERPROFILE/RNIDACCESS/RNID[@ID="'+trim(ARNID)+'"]/SERVICENAMES');
      ServNameAccessXMLNode := ServNameAccessXMLNode.FindFirstChildElement;
      ASL.Clear;
      while ServNameAccessXMLNode <> nil do begin
         if CheckReadOnly then begin //2017-05-24 jtm F#1554
             if (UserXML.GetContextValueAsWideString(ServNameAccessXMLNode,'READONLY') = 'FALSE') then begin
               ASL.Add(trim(UserXML.GetContextValueAsWideString(ServNameAccessXMLNode,'@ID')));
               Inc(I);//2017-09-20 jtm: D#1946
             end;
         end else begin
            ASL.Add(trim(UserXML.GetContextValueAsWideString(ServNameAccessXMLNode,'@ID')));
            Inc(I);//2017-09-20 jtm: D#1946
         end;
         ServNameAccessXMLNode := ServNameAccessXMLNode.FindNextSiblingElement;
      end;
   end else begin
      I := DefaultServiceNameCount;//2017-09-20 jtm: D#1946
   end;
   Result := I;
end;

Function TCustomerInfoModule.RemoveUserServNameAccessByRNID(ADS: TDataSet; AXMLStr : string;ARNID:string): boolean;
var
   UserProfileXML : TOpenXML;
   RNIDAccessXML : TOpenXML;
   RNIDAccessXMLNode : TOpenXMLNode;
   UserProfileXMLStr, RNIDAccessXMLStr : string;
   RNIDAccess : string;
   RNIDReadOnly : boolean;
   UserRNIDExists : boolean;
begin
   Result := false;
   if AXMLStr <> '' then begin
      Try
         UserProfileXML := TOpenXML.CreateFromString(Nil,'<?xml version="1.0" encoding="ISO-8859-1"?><USERPROFILE>' + GetXMLTagStr(ADS.FieldByName('UserProfile').AsString,'USERPROFILE') + '</USERPROFILE>');
      except
         On E:Exception do begin
            Processlog(ltWarning, 'OpenXMLLoad Exception processing UserProfileXML',E.Message);
            If Assigned(UserProfileXML) then FreeAndNil(UserProfileXML);
            exit;
         end;
      end;
      Try
         RNIDAccessXML := TOpenXML.CreateFromString(Nil,AXMLStr);
      except
         On E:Exception do begin
            Processlog(ltWarning, 'OpenXMLLoad Exception processing RNIDAccessXML in RemoveUserRNIDAccess',E.Message);
            If Assigned(RNIDAccessXML) then FreeAndNil(RNIDAccessXML);
            If Assigned(UserProfileXML) then FreeAndNil(UserProfileXML);
            exit;
         end;
      end;
      UserRNIDExists := UserProfileXML.GetNode('/USERPROFILE/RNIDACCESS') <> nil;

      if RNIDAccessXML.GetNode('/rows') <> nil then begin
         RNIDAccessXMLNode :=  RNIDAccessXML.GetNode('/rows');
         RNIDAccessXMLNode := RNIDAccessXMLNode.FindFirstChildElement;
         Processlog(ltInfo, 'LoadUserFormData: ','Update USERPROFILE');
         while RNIDAccessXMLNode <> nil do begin
            RNIDAccess := RNIDAccessXMLNode.TextContent;//RNIDAccess := RNIDAccessXML.GetContextValueAsWideString(RNIDAccessXMLNode,'cell[1]'); //RNID
            if RNIDAccess <> '' then begin
               if UserRNIDExists and (UserProfileXML.GetValueAsWideString('/USERPROFILE/RNIDACCESS/RNID[@ID="'+trim(RNIDAccess)+'"]/READONLY') <> '') then begin
                  UserProfileXML.RemoveNode('/USERPROFILE/RNIDACCESS/RNID[@ID="'+trim(RNIDAccess)+'"]');
               end;
            end;
            RNIDAccessXMLNode := RNIDAccessXMLNode.FindNextSiblingElement;
         end;
      end;





      ADS.Edit;
      ADS.FieldByName('UserProfile').AsString := UserProfileXML.DocumentAsString;
      ADS.Post;
      Result := true;
      FreeAndNil(UserProfileXML);
      FreeAndNil(RNIDAccessXML);
   end;
end;

function TCustomerInfoModule.GetServiceNamesByUser(ARNID, AProfileName, ADisplayFormat, AUserGUID: string): string;
var
ServNameSL : TStringList;
TabLine,TabLines: string;
i : integer;
ServNameAccessXMLNode : TOpenXMLNode;
ServNameAccessXMLChildNode : TOpenXMLNode;
UserServiceNameXML  : TOpenXML;
UserServiceNameXMLStr : string;
begin
   ProcessLog(ltInfo,'GetServiceNamesByUser begin:', '');
   Result := 'FAILED';
   ServNameSL := TStringList.Create;

   if (AUserGUID <> '') and (OpenUserQueryGUID(AUserGUID)) then begin
      ProcessLog(ltInfo,'GetServiceNamesByUser User found:', AUserGUID);
      try
         if ADisplayFormat = 'XML' then begin
            TabLines := '<?xml version="1.0" encoding="iso-8859-1"?><rows>';
         end else if ADisplayFormat = 'JSON' then begin
            TabLines := '{ rows:[';
         end;

         TabLine := '';
         I := 1;
         try
            if RNQuery.FieldByName('UserProfile').AsString <> '' then begin
               UserServiceNameXMLStr := '<?xml version="1.0" encoding="ISO-8859-1"?><USERPROFILE>' + GetXMLTagStr(RNQuery.FieldByName('UserProfile').AsString,'USERPROFILE') + '</USERPROFILE>';
            end else begin
               UserServiceNameXMLStr := '<?xml version="1.0" encoding="ISO-8859-1"?><USERPROFILE></USERPROFILE>';
            end;
            UserServiceNameXML := TOpenXML.CreateFromString(Nil,UserServiceNameXMLStr);
         except
            On E:Exception do begin
               Processlog(ltWarning, 'OpenXMLLoad Exception processing UserServiceNameXML, User=' +Trim(RNQuery.FieldByName('Username').AsString),E.Message);
               If Assigned(UserServiceNameXML) then FreeAndNil(UserServiceNameXML);
            end;
         end;
         If not Assigned(UserServiceNameXML) then exit;
         if UserServiceNameXML.GetNode('/USERPROFILE/RNIDACCESS/RNID[@ID="'+trim(ARNID)+'"]/SERVICENAMES') <> nil then begin
            ServNameAccessXMLNode := UserServiceNameXML.GetNode('/USERPROFILE/RNIDACCESS/RNID[@ID="'+trim(ARNID)+'"]/SERVICENAMES');
            ServNameAccessXMLNode := ServNameAccessXMLNode.FindFirstChildElement;
            while ServNameAccessXMLNode <> nil do begin
               if ADisplayFormat = 'XML' then begin
                  TabLine := '<row id="'+ IntToStr(i)  +'">';
                  TabLine := TabLine + '<cell>0</cell>' + '<cell>' + trim(UserServiceNameXML.GetContextValueAsWideString(ServNameAccessXMLNode,'@ID'))+'</cell>';

                  if Trim(UserServiceNameXML.GetContextValueAsWideString(ServNameAccessXMLNode,'READONLY')) = 'TRUE' then
                     TabLine := TabLine + '<cell>1</cell>'
                  else
                     TabLine := TabLine + '<cell>0</cell>';

                  TabLine := TabLine + '</row>';
               end else if ADisplayFormat = 'JSON' then begin
                  TabLine := TabLine + '{ id:'+ IntToStr(i)  +', data:[';
                  TabLine := TabLine + '"'+ EscapeJSONTokens('0') + '"';
                  TabLine := TabLine + '"'+ EscapeJSONTokens(trim(UserServiceNameXML.GetContextValueAsWideString(ServNameAccessXMLNode,'@ID'))) + '"';

                  if Trim(UserServiceNameXML.GetContextValueAsWideString(ServNameAccessXMLNode,'READONLY')) = 'TRUE' then
                     TabLine := TabLine + '"'+ EscapeJSONTokens('1') + '"'
                  else
                     TabLine := TabLine + '"'+ EscapeJSONTokens('0') + '"';
                  TabLine := TabLine + ']}';
                  if ServNameAccessXMLNode.FindNextSiblingElement <> nil then TabLine := TabLine + ',';
               end;
               TabLines := TabLines + TabLine;
               Inc(I);
               ServNameAccessXMLNode := ServNameAccessXMLNode.FindNextSiblingElement;
            end;
         end;

         if ADisplayFormat = 'XML' then begin
            TabLines := TabLines + '</rows>';
            Response.ContentType := 'text/xml';
         end else if ADisplayFormat = 'JSON' then begin
            TabLines := TabLines + ']}';
         end;
      except
         on E:Exception do begin
            ProcessLog(ltWarning,'Exception on GetServiceNamesByUser',E.Message);
         end;
      end;

      Result := TabLines;
   end else begin
      ProcessLog(ltWarning,'GetServiceNamesByUser AUserGUID not provided or found:',AUserGUID);
   end;
   FreeAndNil(ServNameSL);
   FreeAndNil(UserServiceNameXML);
   ProcessLog(ltInfo,'GetServiceNamesByUser end:', '');
end;
Procedure TCustomerInfoModule.DeleteXMLTag(Var RawXML: String; TagName : String);
var
   StartTagPos : integer;
   EndTagPos : Integer;
Begin
   StartTagPos := Pos('<' +TagName + '>', RawXML);
   EndTagPos := Pos('</' +TagName + '>', RawXML);

   If StartTagPos = 0 then exit;
   If EndTagPos = 0 then Exit;
   If EndTagPos < StartTagPos then exit;
   Delete(RawXML, StartTagPos, StartTagPos + Length('<' +TagName + '>'));
   EndTagPos := Pos('</' +TagName + '>', RawXML);
   Delete(RawXML, EndTagPos, EndTagPos + Length('</' +TagName + '>'));
end;

function TCustomerInfoModule.GetCustomReportChunked(StartPos,QueryCountInt: integer; AReportName,ADisplayFormat, ARNID: String; FromDate, ThruDate: TDateTime): String;
var
   Total,ReportID,i : integer;
   ConfigNode,QueryNode,ReportNode,TotalsNode : TOpenXMLNode;
   QueryXMLStr,ConfigXMLStr,ReportType,TotalName,AggVal : string;
   ReportResult,Report : TStringList;
begin
   processlog(ltInfo, 'GetCustomReportChunked', 'Begin Report: '+AReportName);
   Result := '';
   ReportID := 0;
   if AReportName = '' then exit;
   CustomReportSumFields := TStringList.Create;
   Report := TStringList.Create;
   RecordTextLines := TStringList.Create;
   if SessionVarEval.GetValueAsString('QueryTotal') <> '' then begin
      Total := StrToInt(SessionVarEval.GetValueAsString('QueryTotal'));
   end else begin
      Total := 0;
   end;
   ReportType := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CUSTOMREPORTS/CUSTOMREPORT[@NAME="'+ AReportName + '"]/REPORTTYPE','CUSTOMREPORT');
   if StartPos = 0 then begin
      RNReg.ChainCode := 0;
      RNReg.StoreCode := 0;
      ReportID := RNReg.RegIncrementValue('COUNTERS.'+ReportType+'.'+ARNID,1,2147483647);
      SessionVarEval.AddValue('ReportIDCounter',IntToStr(ReportID));
   end else begin
      if SessionVarEval.GetValueAsString('ReportIDCounter') <> '' then begin
         ReportID := Valu(SessionVarEval.GetValueAsString('ReportIDCounter'));
      end;
   end;
   VarEvaluator.AddValue('ReportIDCounter',IntToStr(ReportID));

   processlog(ltInfo, 'GetCustomReportChunked: ReportIDCounter', IntToStr(ReportID));
   ReportNode := DomainConfigXML.GetNode('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CUSTOMREPORTS/CUSTOMREPORT[@NAME="'+ AReportName + '"]');
   if ReportNode <> nil then begin
      processlog(ltInfo, 'GetCustomReportChunked', 'ReportNode exists');
      TotalsNode := DomainConfigXML.GetContextNode(ReportNode,'TOTALS'); //2017-07-19 jtm: F#1879
      if (TotalsNode <> nil) then begin //2018-04-11 jtm D#4337
         TotalsNode := TotalsNode.FindFirstChildElement;
      end;
      if StartPos = 0 then begin
         while TotalsNode <> nil do begin
            TotalName := trim(DomainConfigXML.GetContextValueAsWideString(TotalsNode,'NAME'));
            CustomReportSumFields.Add(TotalName);
            SessionVarEval.AddValue(TotalName+'Sum','0');
            TotalsNode := TotalsNode.FindNextSiblingElement;
         end;
         SessionVarEval.AddValue('CustomReportSumFields',CustomReportSumFields.Text);
      end else begin
         CustomReportSumFields.Text := SessionVarEval.GetValueAsString('CustomReportSumFields');
         for i := 0 to CustomReportSumFields.Count - 1 do begin
            if SessionVarEval.GetValueAsString(CustomReportSumFields[i]+'Sum') <> '' then begin
               VarEvaluator.AddValue(CustomReportSumFields[i]+'Sum',SessionVarEval.GetValueAsString(CustomReportSumFields[i]+'Sum'));
            end;
         end;
      end;

      ttCustomReporting := TttCustomReporting.Create(PL.ProcessLog,HDDB,RNDB,nil,DoProcessExportNode,VarEvaluator);

      TotalsNode := DomainConfigXML.GetContextNode(ReportNode,'AGGREGATES');
      if (TotalsNode <> nil) then begin
         ttCustomReporting.Aggregates := TAggregates.Create(DomainConfigXML.GetContextNodeAsXMLString(TotalsNode,true));//2018-01-25 jtm: D#3684
         if (StartPos = 0) then begin
            for i := 0 to ttCustomReporting.Aggregates.AggNameList.Count - 1 do begin
               SessionVarEval.AddValue(ttCustomReporting.Aggregates.AggNameList[i],'0');
            end;
         end else begin
            for i := 0 to ttCustomReporting.Aggregates.AggNameList.Count - 1 do begin
               AggVal := SessionVarEval.GetValueAsString(ttCustomReporting.Aggregates.AggNameList[i]);
               if (AggVal <> '') then begin
                  ttCustomReporting.Aggregates.AggValList.Add(AggVal);
                  ttCustomReporting.VarEvaluator.AddValue(ttCustomReporting.Aggregates.AggNameList[i],AggVal);
               end;
            end;
         end;
      end;
      if FromDate > 0 then ttCustomReporting.BeginDate := FromDate;
      if ThruDate > 0 then ttCustomReporting.EndDate := ThruDate;

      ConfigNode := DomainConfigXML.GetContextNode(ReportNode,'CUSTOMREPORTDEFINITION/CONFIG');
      ConfigXMLStr := DomainConfigXML.GetContextNodeAsXMLString(ConfigNode,true);

      QueryNode := DomainConfigXML.GetContextNode(ReportNode,'QUERY');
      QueryXMLStr := DomainConfigXML.GetContextNodeAsXMLString(QueryNode,true);



      ttCustomReporting.GenerateExportChunked(Total,StartPos,QueryCountInt,'Delphi5',QueryXMLStr,ConfigXMLStr);
      if StartPos = 0 then Report.Add(IntToStr(Total));
      Report.AddStrings(RecordTextLines);
      SessionVarEval.AddValue('QueryTotal',IntToStr(Total));
      Result := Report.Text;
      processlog(ltInfo, 'GetCustomReportChunked','Finished function');
      FreeAndNil(ttCustomReporting);
   end;

   Report.Free;
   RecordTextLines.Free;
   CustomReportSumFields.Free;
end;

procedure TCustomerInfoModule.DoProcessExportNode(Sender: TObject; ExportRecord: TStringList; AExportType:TProcessExportType;AADS : TDataset;AReportFormat:TReportFormatType;ARecordTypeList: TStringList);
var
AField: TField;
i : integer;
begin

   if (ExportRecord.Count > 0) then begin
   RecordTextLines.AddStrings(ExportRecord);
   end;
end;
function TCustomerInfoModule.GetRNEmployeeGuidByEmail(Email: String): string;
var
EmployeeGUIID :string;
begin
   Result := '';
   ProcessLog(ltInfo,'GetRNEmployeeGuidByEmail Email:',Email);
   RNQuery2.Close;
   RNQuery2.SQL.Text := 'select * from RNEmployee where (chaincode = :ChainCode) and (Email = :Email)';
   RNQuery2.Parameters.ParamByName('ChainCode').Value := ChainCode;
   RNQuery2.Parameters.ParamByName('Email').Value := trim(Email);
   RNQuery2.Open;

   If (RNQuery2.RecordCount = 1) then begin
      EmployeeGUIID := RNQuery2.FieldByName('EmployeeGUID').AsString;
      ProcessLog(ltInfo,'GetRNEmployeeGuidByEmail EmployeeGUID found:',EmployeeGUIID);
      Result := EmployeeGUIID;
   end else if (RNQuery2.RecordCount > 1) then begin
      ProcessLog(ltInfo,'GetRNEmployeeGuidByEmail multiple RNEmployee Records found:',IntToStr(RNQuery2.RecordCount));
   end else begin
      ProcessLog(ltInfo,'GetRNEmployeeGuidByEmail no RNEmployee Records found:','');
   end;
end;
function TCustomerInfoModule.GetRNUserByEmail(Email: String): string;
var
username :string;
userloaded : boolean;
begin
   Result := '';
   ProcessLog(ltInfo,'GetRNUserByEmail Email:',Email);
   RNQuery2.Close;
   RNQuery2.SQL.Text := 'select * from RNEmployee where (chaincode = :ChainCode) and (Email = :Email)';
   RNQuery2.Parameters.ParamByName('ChainCode').Value := ChainCode;
   RNQuery2.Parameters.ParamByName('Email').Value := Email;
   RNQuery2.Open;

   If (RNQuery2.RecordCount = 1) then begin
      username := RNQuery2.FieldByName('UserName').AsString;
      ProcessLog(ltInfo,'GetRNUserByEmail Username found:',username);
      if (username <> '') then begin
          userloaded := GetRNUser(username);
          if (userloaded) then begin
            ProcessLog(ltInfo,'GetRNUserByEmail Username loaded','');
          end else begin
            ProcessLog(ltInfo,'GetRNUserByEmail Username not loaded','');
          end;
      end;
      Result := username;
   end;
end;

function TCustomerInfoModule.ExternalWebSvcEx(Input: TStringList; var Output: TStringList;URL, Action: String; APIUsername,APIPW :string; OAuth: boolean): Integer;
var
   OutStr : String;
   HTTPRequest : TclHttpRequest;
   HTTP : TclHttp;
   InputText : string;
   ExUserName: string;
   ExPW : string;
   Proxy : string;
   EpicClientID : string;
begin
try
   Result := -1;
   If Input <> NIL then
      InputText := Input.Text;

   ProcessLog(ltInfo,'Starting External Web ServiceEx: ' + Action + ' TO URL:' + URL, InputText);

   HTTP := TclHTTP.Create(Nil);
   HTTPRequest := TclHttpRequest.Create(nil);
   HTTPRequest.AddTextData(InputText);
   HTTP.Request := HTTPRequest;
   HTTP.TLSFlags := [tfUseTLS, tfUseTLS11, tfUseTLS12];
   HTTP.AllowCaching := False;
   HTTP.KeepConnection := False;
   HTTP.TimeOut := 60 * 1000;

   If OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION') <> '' then begin
      ExUserName := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/WEBAPIUN');
      ExPW := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/WEBAPIPW');
      if (APIUsername <> '') then begin
         ExUserName := APIUsername;
         ProcessLog(ltDebug,'ExternalWebSvcEx Using APIUsername ',APIUsername);
      end;
      if (APIPW <> '') then begin
         ExPW := APIPW;
         ProcessLog(ltDebug,'ExternalWebSvcEx Using APIPW ','');
      end;
      if (OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/WEBAPIUSEAUTH') = 'TRUE') or (OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/HE/USEAUTH') = 'TRUE') then begin
         HTTP.UserName := ExUserName;
         HTTP.Password := FromUTF(ExPW);
         HTTP.AuthenticationType := atBasic;
         ProcessLog(ltinfo,'ExternalWebSvcEx Using External Auth: ',' Username: ' + ExUserName);
      end else if (OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/EPIC') <> '') then begin //jtm:
         EpicClientID :=  OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/EPIC/CLIENTID');

         HTTP.Request.Header.Authorization := 'Basic ' + CardUtil.STDBase64Encode(OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/EPIC/UNTYPE')+'$'+ExUserName+':'+FromUTF(ExPW));
         HTTP.Request.Header.ExtraFields.Append(Format('%s: %s', ['Epic-Client-ID', EpicClientID]));

         ProcessLog(ltDebug,'ExternalWebSvcEx Using External Epic Auth: ',HTTP.Request.Header.Authorization);
         ProcessLog(ltinfo,'ExternalWebSvcEx ExtraFields: ',HTTP.Request.Header.ExtraFields.Text);
         ProcessLog(ltinfo,'ExternalWebSvcEx Using External Epic Auth: ',' Username: ' + ExUserName);
      end else if (OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/WEBAPIUSEOAUTH') = 'TRUE') and (SessionVarEval.GetValueAsString('OAUTHACCESSTOKEN') <> '') then begin
         HTTP.Request.Header.Authorization := 'Bearer  ' + SessionVarEval.GetValueAsString('OAUTHACCESSTOKEN');
      end;
      if OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/WEBAPICONTENTTYPE') <> '' then begin
         HTTP.Request.Header.ContentType := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/WEBAPICONTENTTYPE');
      end else begin
         HTTP.Request.Header.ContentType := 'text/xml; charset=utf-8';
      end;
      if (OAuth) then begin
         HTTP.Request.Header.Authorization := 'Basic ' + CardUtil.STDBase64Encode(ExUserName+':'+FromUTF(ExPW));
         HTTP.Request.Header.ContentType := 'application/x-www-form-urlencoded';
      end;
      ProcessLog(ltinfo,'ExternalWebSvcEx WEBAPICONTENTTYPE',HTTP.Request.Header.ContentType);
   end;

   Http.ProxySettings.Server := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/PROXYSERVER', 'PORTALPROXY.TEMPUS.LOCAL');
   Http.ProxySettings.Port := StrToInt(OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/PROXYPORT', '8080'));
   Http.ProxySettings.UserName := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/PROXYUN', '');
   Http.ProxySettings.Password := FromUTF(OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/PROXYPW', ''));
   ProcessLog(ltinfo,'ExternalWebSvcEx Using Proxy: ' + Http.ProxySettings.Server, ' Port: ' + IntToStr(Http.ProxySettings.Port));


   PL.StartTimer;
   Try
     Application.ProcessMessages;
     HTTP.Close;

     If action = 'POST' then begin
        Http.Post(URL, Output);
     end else begin
        HTTP.Get(URL,Output);
     end;

     PL.StopTimer;
     PL.AddMessageValue('RESOURCE',URL);
     PL.AddMessageValue('HTTPSTATUS',Stri(HTTP.StatusCode,-1));
     PL.SetLogIdentGUID('95914DB9-3D5C-4358-A364-7D5BBE4449B0');
     ProcessLog(ltInfo,'External Web ServiceEx Request Complete, status: ' + Stri(HTTP.StatusCode,-1),'');

   except
      On E:EclHttpError do begin
         PL.StopTimer;
         ProcessLog(0,ltwarning,'Exception on External Web ServiceEx: ' + E.ClassName + ' ' + E.Message + ' TO URL:' + URL,InstanceGUID,'',0,'');
         Output.Text := e.ResponseText;
      end;
   end;
   ProcessLog(ltInfo,'External Web ServiceEx Response: ', Output.Text);
 except
   on E:Exception do begin
      ProcessLog(0,ltwarning,'External Web ServiceEx Exception: ' + E.ClassName + ' ' + E.Message + ' TO URL:' + URL,InstanceGUID,'',0,'');
   end;
 end;
   Result := http.StatusCode;
   HTTPRequest.Free;
   HTTP.Free;
end;
function TCustomerInfoModule.NumToBoolStr(num:string): string;
begin
   result := 'FALSE';
   if (num = '1') then begin
      result := 'TRUE';
   end;
end;
function TCustomerInfoModule.GenerateReportXMLFromRequest: String;
var
xmlsl : TTTStringList;
RNIDs : TTTStringList;
AllowedRNIDs : TTTStringList;
i,iter,it,hierIndex,stnum : integer;
count : integer;
RNIDXML : TOpenXML;
RNIDXMLStr : string;
RNIDXMLNode : TOpenXMLNode;
RNIDChecked : boolean;
RNIDStr : string;
CardBrands : TTTStringList;
SaleTypes : TTTStringList;
FromDate : string;
ThruDate : string;
ws : string;
StoreFields,StrAttr : TTTStringList;
StoreFieldExists : boolean;
begin
   result := '';
   xmlsl := TTTStringList.Create();
   xmlsl.Append('<REPORT>');

	xmlsl.Append('<HEADERFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/HEADERFIELDNAMES','RNID,Auth Date,Type,Amount,Tran Type,Auth Code,NonAuthResp,Check #,Batch Date,Batch ID,Emp Ident,Tran Ident,Cust Ident,Station Ident,Transerial')+'</HEADERFIELDNAMES>');
	xmlsl.Append('<CARDFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CARDFIELDNAMES','StoreCode|AuthDate|SaleType|TranAmt||AuthCode|NonAuthResp||BatchDate|BatchID|TranEmployeeIdent|TranIdent|TranCustomerCode|StationIdent|StoreSystemCode')+'</CARDFIELDNAMES>');
	xmlsl.Append('<CASHFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CASHFIELDNAMES','StoreCode|TranDate|TranType|TranAmt|CurrencyType||||BatchDate|BatchCode|EmpIdent|TranIdent|CustIdent|StationIdent|StoreSystemCode')+'</CASHFIELDNAMES>');
	xmlsl.Append('<CHECKFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CHECKFIELDNAMES','StoreCode|AuthDate||TranAmount|TCServiceName|ECATranStatus|DisplayText|ResponseCheckNumber|BatchDate|BatchSerial|TranEmployeeIdent|TranIdent|TranCustomerCode|StationIdent|StoreSystemCode')+'</CHECKFIELDNAMES>');
	xmlsl.Append('<OPENCARDFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/OPENCARDFIELDNAMES','')+'</OPENCARDFIELDNAMES>');
	xmlsl.Append('<OPENCASHFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/OPENCASHFIELDNAMES','')+'</OPENCASHFIELDNAMES>');
	xmlsl.Append('<OPENCHECKFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/OPENCHECKFIELDNAMES','')+'</OPENCHECKFIELDNAMES>');
   xmlsl.Append('<USEBATCHFIELDSEARCH>' + OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEBATCHFIELDSEARCH','FALSE') + '</USEBATCHFIELDSEARCH>'); //2018-06-20 bls: F#2227

   xmlsl.Append('<SEARCHFILTERS>');
      xmlsl.Append('<TENDERTYPES>');
         xmlsl.Append('<CARDSEARCH>'+NumToBoolStr(NumericOnly(Request.ContentFields.Values['SearchCard']))+'</CARDSEARCH>');
         xmlsl.Append('<CHECKSEARCH>'+NumToBoolStr(NumericOnly(Request.ContentFields.Values['SearchCheckPaper']))+'</CHECKSEARCH>');
         xmlsl.Append('<ACHSEARCH>'+NumToBoolStr(NumericOnly(Request.ContentFields.Values['SearchACH']))+'</ACHSEARCH>');
         xmlsl.Append('<CASHSEARCH>'+NumToBoolStr(NumericOnly(Request.ContentFields.Values['SearchCash']))+'</CASHSEARCH>');
         xmlsl.Append('<VOUCHERSEARCH>'+NumToBoolStr(NumericOnly(Request.ContentFields.Values['SearchVoucher']))+'</VOUCHERSEARCH>');
      xmlsl.Append('</TENDERTYPES>');
      xmlsl.Append('<DATERANGE>');

      ProcessLog(ltDebug,'GenerateReportXMLFromRequest: Fromdate before format',Request.ContentFields.Values['FromDate']);

      FromDate := Request.ContentFields.Values['FromDate'];
      ThruDate := Request.ContentFields.Values['ThruDate'];
      ReplaceString(FromDate,'%2F','/');
      ReplaceString(ThruDate,'%2F','/');

      ProcessLog(ltDebug,'GenerateReportXMLFromRequest: Fromdate after format', FromDate);
         xmlsl.Append('<FROMDATE>'+ValidCharsOnly(FromDate,false,true,'/')+'</FROMDATE>');
         xmlsl.Append('<THRUDATE>'+ValidCharsOnly(ThruDate,false,true,'/')+'</THRUDATE>');
         xmlsl.Append('<RANGE>'+DateRangeNumToStr(NumericOnly(Request.ContentFields.Values['daterange']))+'</RANGE>'); //2018-04-11 jtm F#3540
      xmlsl.Append('</DATERANGE>');
      xmlsl.Append('<BATCHSTATUS>');
         xmlsl.Append('<OPENBATCHSEARCH>'+NumToBoolStr(NumericOnly(Request.ContentFields.Values['OpenBatchSearch']))+'</OPENBATCHSEARCH>');
         xmlsl.Append('<CLOSEDBATCHSEARCH>'+NumToBoolStr(NumericOnly(Request.ContentFields.Values['ClosedBatchSearch']))+'</CLOSEDBATCHSEARCH>');
      xmlsl.Append('</BATCHSTATUS>');

      RNIDs := TTTStringList.Create();
      AllowedRNIDs := TTTStringList.Create();
      GenerateAllLocationOptionsSL(RNIDs);
      Try
         if Request.ContentFields.Values['RNIDGRIDDATA'] <> '' then begin
            RNIDXMLStr := Request.ContentFields.Values['RNIDGRIDDATA'];
         end else begin
            RNIDXMLStr := '<?xml version="1.0" encoding="ISO-8859-1"?><rows></rows>';
         end;
         RNIDXML := TOpenXML.CreateFromString(Nil,RNIDXMLStr);
      except
         On E:Exception do begin
            Processlog(ltWarning, 'OpenXMLLoad Exception processing RNIDXML RNIDGRIDDATA',E.Message);
            If Assigned(RNIDXML) then FreeAndNil(RNIDXML);
            exit;
         end;
      end;

       ProcessLog(ltInfo,'RNIDGRIDDATA;', Request.ContentFields.Values['RNIDGRIDDATA']);
      if (RNIDXML.GetNode('/rows') <> nil) then begin
         RNIDXMLNode :=  RNIDXML.GetNode('/rows').FindFirstChildElement;
         while (RNIDXMLNode <> nil) do begin
            RNIDChecked :=  RNIDXML.GetContextValueAsBoolean(RNIDXMLNode,'cell[1]'); //comes back as '0' or '1'
            RNIDStr := RNIDXML.GetContextValueAsWideString(RNIDXMLNode,'cell[2]'); //RNID
            if (RNIDChecked) then begin
               if (UpperCase(RNIDStr) = 'ALL') then begin
                  AllowedRNIDs.CommaText := RNIDs.CommaText;
                  break;
               end else begin
                  AllowedRNIDs.Append(RNIDStr);
               end;
            end;
            RNIDXMLNode := RNIDXMLNode.FindNextSiblingElement;
         end;
      end;
      RNIDXML.Free;


      xmlsl.Append('<RNIDS>'+AllowedRNIDs.CommaText+'</RNIDS>');
   xmlsl.Append('</SEARCHFILTERS>');

   xmlsl.Append('<SEARCHFIELDS>');
   xmlsl.Append('<CARDLASTFOUR>'+ValidCharsOnly(Request.ContentFields.Values['last4'],false,true,',')+'</CARDLASTFOUR>');
   xmlsl.Append('<EMPIDENT>'+ValidCharsOnly(Request.ContentFields.Values['empident'],true,true,'.\-_:/&,')+'</EMPIDENT>');
   xmlsl.Append('<TRANIDENT>'+ValidCharsOnly(Request.ContentFields.Values['tranident'],true,true,'.\-_:/&,')+'</TRANIDENT>');
   xmlsl.Append('<CUSTIDENT>'+ValidCharsOnly(Request.ContentFields.Values['custident'],true,true,'.\-_:/&,')+'</CUSTIDENT>');
   xmlsl.Append('<STORESYSTEMCODES>'+ValidCharsOnly(Request.ContentFields.Values['transerial'],false,true,',')+'</STORESYSTEMCODES>');
   xmlsl.Append('<CARDNAME>'+ValidCharsOnly(Request.ContentFields.Values['cardname'],true,true,'/-,')+'</CARDNAME>');

      CardBrands := TTTStringList.Create();
      if (NumToBoolStr(NumericOnly(Request.ContentFields.Values['SearchAllCardBrands']))= 'FALSE') then begin
         if (NumToBoolStr(NumericOnly(Request.ContentFields.Values['SearchVisa']))= 'TRUE') then begin
            CardBrands.Append('VISA');
         end;
         if (NumToBoolStr(NumericOnly(Request.ContentFields.Values['SearchMC']))= 'TRUE') then begin
            CardBrands.Append('MC');
         end;
         if (NumToBoolStr(NumericOnly(Request.ContentFields.Values['SearchDisc']))= 'TRUE') then begin
            CardBrands.Append('DISC');
         end;
         if (NumToBoolStr(NumericOnly(Request.ContentFields.Values['SearchAmex']))= 'TRUE') then begin
            CardBrands.Append('AMEX');
         end;
         if (NumToBoolStr(NumericOnly(Request.ContentFields.Values['SearchOtherBrand']))= 'TRUE') then begin
            CardBrands.Append('OTHER');
         end;

      end;
      xmlsl.Append('<CARDBRAND>'+CardBrands.CommaText+'</CARDBRAND>'); ///TODO multiple cards

      SaleTypes := TTTStringList.Create();
      if (NumToBoolStr(NumericOnly(Request.ContentFields.Values['SearchAllSaleTypes']))= 'FALSE') then begin
         if (NumToBoolStr(NumericOnly(Request.ContentFields.Values['SearchSTCredit']))= 'TRUE') then begin
            SaleTypes.Append('CREDIT');
         end;
         if (NumToBoolStr(NumericOnly(Request.ContentFields.Values['SearchSTReversal']))= 'TRUE') then begin
            SaleTypes.Append('REVERSAL');
         end;
         if (NumToBoolStr(NumericOnly(Request.ContentFields.Values['SearchSTSale']))= 'TRUE') then begin
            SaleTypes.Append('SALE');
         end;
         if (NumToBoolStr(NumericOnly(Request.ContentFields.Values['SearchSTVoid']))= 'TRUE') then begin
            SaleTypes.Append('VOID');
            SaleTypes.Append('CRVOID');
         end;
         if (NumToBoolStr(NumericOnly(Request.ContentFields.Values['SearchSTDebit']))= 'TRUE') then begin
            SaleTypes.Append('DEBIT');
         end;
         if (NumToBoolStr(NumericOnly(Request.ContentFields.Values['SearchSTRefund']))= 'TRUE') then begin
            SaleTypes.Append('REFUND');
         end;
      end;
      xmlsl.Append('<SALETYPE>'+SaleTypes.CommaText+'</SALETYPE>'); ///TODO multiple types


      
      xmlsl.Append('<MID>'+ValidCharsOnly(Request.ContentFields.Values['mid'],false,true,',')+'</MID>');
      xmlsl.Append('<AUTHCODE>'+ValidCharsOnly(Request.ContentFields.Values['authcode'],true,true,',')+'</AUTHCODE>');
      xmlsl.Append('<DEPOSITSLIP>'+ValidCharsOnly(Request.ContentFields.Values['depositslip'],true,true,',')+'</DEPOSITSLIP>');
      xmlsl.Append('<BAGNUMBER>'+ValidCharsOnly(Request.ContentFields.Values['bagnumber'],true,true,',')+'</BAGNUMBER>');

      xmlsl.Append('<STATIONIDENT>'+ValidCharsOnly(Request.ContentFields.Values['stationident'],true,true,'.\-_:/&,')+'</STATIONIDENT>');
      xmlsl.Append('<SETTLEDONLY>'+NumericOnly(Request.ContentFields.Values['settleonly'])+'</SETTLEDONLY>');
      xmlsl.Append('<DOLLARAMT>'+ValidCharsOnly(Request.ContentFields.Values['tranamt'],false,true,'.')+'</DOLLARAMT>');
      xmlsl.Append('<DOLLARAMTCOMP>'+NumericOnly(Request.ContentFields.Values['dollaramtcomp'])+'</DOLLARAMTCOMP>');
   xmlsl.Append('</SEARCHFIELDS>');

   xmlsl.Append('</REPORT>');

result := xmlsl.Text;
Processlog(ltInfo, 'GenerateReportXMLFromRequest result',xmlsl.Text);
FreeAndNil(RNIDs);
FreeAndNil(AllowedRNIDs);
FreeAndNIl(CardBrands);
FreeAndNil(SaleTypes);
end;

function TCustomerInfoModule.GenerateReportXMLFromRequestQuery: String;
var
xmlsl : TTTStringList;
RNIDs : TTTStringList;
AllowedRNIDs : TTTStringList;
i : integer;
count : integer;
RNIDXML : TOpenXML;
RNIDXMLStr : string;
RNIDXMLNode : TOpenXMLNode;
RNIDChecked : boolean;
RNIDStr : string;
CardBrands : TTTStringList;
SaleTypes : TTTStringList;
FromDate : string;
ThruDate : string;
function NumToBoolStr(num:string): string;
begin
   result := 'FALSE';
   if (num = '1') then begin
      result := 'TRUE';
   end;
end;
begin
   result := '';
   xmlsl := TTTStringList.Create();
   xmlsl.Append('<REPORT>');

	xmlsl.Append('<HEADERFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/HEADERFIELDNAMES','RNID,Auth Date,Type,Amount,Tran Type,Auth Code,NonAuthResp,Check #,Batch Date,Batch ID,Emp Ident,Tran Ident,Cust Ident,Station Ident,Transerial')+'</HEADERFIELDNAMES>');
	xmlsl.Append('<CARDFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CARDFIELDNAMES','StoreCode|AuthDate|SaleType|TranAmt||AuthCode|NonAuthResp||BatchDate|BatchID|TranEmployeeIdent|TranIdent|TranCustomerCode|StationIdent|StoreSystemCode')+'</CARDFIELDNAMES>');
	xmlsl.Append('<CASHFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CASHFIELDNAMES','StoreCode|TranDate|TranType|TranAmt|CurrencyType||||BatchDate|BatchCode|EmpIdent|TranIdent|CustIdent|StationIdent|StoreSystemCode')+'</CASHFIELDNAMES>');
	xmlsl.Append('<CHECKFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CHECKFIELDNAMES','StoreCode|AuthDate||TranAmount|TCServiceName|ECATranStatus|DisplayText|ResponseCheckNumber|BatchDate|BatchSerial|TranEmployeeIdent|TranIdent|TranCustomerCode|StationIdent|StoreSystemCode')+'</CHECKFIELDNAMES>');
	xmlsl.Append('<OPENCARDFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/OPENCARDFIELDNAMES','')+'</OPENCARDFIELDNAMES>');
	xmlsl.Append('<OPENCASHFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/OPENCASHFIELDNAMES','')+'</OPENCASHFIELDNAMES>');
	xmlsl.Append('<OPENCHECKFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/OPENCHECKFIELDNAMES','')+'</OPENCHECKFIELDNAMES>');

    xmlsl.Append('<SEARCHFILTERS>');
      xmlsl.Append('<TENDERTYPES>');
         xmlsl.Append('<CARDSEARCH>'+NumToBoolStr(NumericOnly(Request.QueryFields.Values['SearchCard']))+'</CARDSEARCH>');
         xmlsl.Append('<CHECKSEARCH>'+NumToBoolStr(NumericOnly(Request.QueryFields.Values['SearchCheckPaper']))+'</CHECKSEARCH>');
         xmlsl.Append('<ACHSEARCH>'+NumToBoolStr(NumericOnly(Request.QueryFields.Values['SearchACH']))+'</ACHSEARCH>');
         xmlsl.Append('<CASHSEARCH>'+NumToBoolStr(NumericOnly(Request.QueryFields.Values['SearchCash']))+'</CASHSEARCH>');
         xmlsl.Append('<VOUCHERSEARCH>'+NumToBoolStr(NumericOnly(Request.QueryFields.Values['SearchVoucher']))+'</VOUCHERSEARCH>');
      xmlsl.Append('</TENDERTYPES>');
      xmlsl.Append('<DATERANGE>');

      ProcessLog(ltInfo,'GenerateReportXMLFromRequest: Fromdate before format',Request.QueryFields.Values['FromDate']);

      FromDate := Request.QueryFields.Values['FromDate'];
      ThruDate := Request.QueryFields.Values['ThruDate'];

      ReplaceString(FromDate,'%2F','/');
      ReplaceString(ThruDate,'%2F','/');

         xmlsl.Append('<FROMDATE>'+ValidCharsOnly(FromDate,false,true,'/')+'</FROMDATE>');
         xmlsl.Append('<THRUDATE>'+ValidCharsOnly(ThruDate,false,true,'/')+'</THRUDATE>');
      xmlsl.Append('</DATERANGE>');
      xmlsl.Append('<BATCHSTATUS>');
         xmlsl.Append('<OPENBATCHSEARCH>'+NumToBoolStr(NumericOnly(Request.QueryFields.Values['OpenBatchSearch']))+'</OPENBATCHSEARCH>');
         xmlsl.Append('<CLOSEDBATCHSEARCH>'+NumToBoolStr(NumericOnly(Request.QueryFields.Values['ClosedBatchSearch']))+'</CLOSEDBATCHSEARCH>');
      xmlsl.Append('</BATCHSTATUS>');
      RNIDs := TTTStringList.Create();
      AllowedRNIDs := TTTStringList.Create();
      GenerateAllLocationOptionsSL(RNIDs);
      Try
         if Request.QueryFields.Values['RNIDGRIDDATA'] <> '' then begin
            RNIDXMLStr := Request.QueryFields.Values['RNIDGRIDDATA'];
         end else begin
            RNIDXMLStr := '<?xml version="1.0" encoding="ISO-8859-1"?><rows></rows>';
         end;
         RNIDXML := TOpenXML.CreateFromString(Nil,RNIDXMLStr);
      except
         On E:Exception do begin
            Processlog(ltWarning, 'OpenXMLLoad Exception processing RNIDXML RNIDGRIDDATA',E.Message);
            If Assigned(RNIDXML) then FreeAndNil(RNIDXML);
            exit;
         end;
      end;

       ProcessLog(ltInfo,'RNIDGRIDDATA;', Request.ContentFields.Values['RNIDGRIDDATA']);
      if (RNIDXML.GetNode('/rows') <> nil) then begin
         RNIDXMLNode :=  RNIDXML.GetNode('/rows').FindFirstChildElement;
         while (RNIDXMLNode <> nil) do begin
            RNIDChecked :=  RNIDXML.GetContextValueAsBoolean(RNIDXMLNode,'cell[1]'); //comes back as '0' or '1'
            RNIDStr := RNIDXML.GetContextValueAsWideString(RNIDXMLNode,'cell[2]'); //RNID
            if (RNIDChecked) then begin
               if (UpperCase(RNIDStr) = 'ALL') then begin
                  AllowedRNIDs.CommaText := RNIDs.CommaText;
                  break;
               end else begin
                  AllowedRNIDs.Append(RNIDStr);
               end;
            end;
            RNIDXMLNode := RNIDXMLNode.FindNextSiblingElement;
         end;
      end;
      RNIDXML.Free;


      xmlsl.Append('<RNIDS>'+AllowedRNIDs.CommaText+'</RNIDS>');
   xmlsl.Append('</SEARCHFILTERS>');

   xmlsl.Append('<SEARCHFIELDS>');
      xmlsl.Append('<CARDLASTFOUR>'+NumericOnly(Request.QueryFields.Values['last4'])+'</CARDLASTFOUR>');
      xmlsl.Append('<EMPIDENT>'+ValidCharsOnly(Request.QueryFields.Values['empident'],true,true,'.\-_:/&,')+'</EMPIDENT>');
      xmlsl.Append('<TRANIDENT>'+ValidCharsOnly(Request.QueryFields.Values['tranident'],true,true,'.\-_:/&,')+'</TRANIDENT>');
      xmlsl.Append('<CUSTIDENT>'+ValidCharsOnly(Request.QueryFields.Values['custident'],true,true,'.\-_:/&,')+'</CUSTIDENT>');
      xmlsl.Append('<STORESYSTEMCODES>'+ValidCharsOnly(Request.QueryFields.Values['transerial'],false,true,',')+'</STORESYSTEMCODES>');
      xmlsl.Append('<CARDNAME>'+ValidCharsOnly(Request.QueryFields.Values['cardname'],true,true,'/-,')+'</CARDNAME>');

      CardBrands := TTTStringList.Create();
      if (NumToBoolStr(NumericOnly(Request.QueryFields.Values['SearchAllCardBrands']))= 'FALSE') then begin
         if (NumToBoolStr(NumericOnly(Request.QueryFields.Values['SearchVisa']))= 'TRUE') then begin
            CardBrands.Append('VISA');
         end;
         if (NumToBoolStr(NumericOnly(Request.QueryFields.Values['SearchMC']))= 'TRUE') then begin
            CardBrands.Append('MC');
         end;
         if (NumToBoolStr(NumericOnly(Request.QueryFields.Values['SearchDisc']))= 'TRUE') then begin
            CardBrands.Append('DISC');
         end;
         if (NumToBoolStr(NumericOnly(Request.QueryFields.Values['SearchAmex']))= 'TRUE') then begin
            CardBrands.Append('AMEX');
         end;
         if (NumToBoolStr(NumericOnly(Request.QueryFields.Values['SearchOtherBrand']))= 'TRUE') then begin
            CardBrands.Append('OTHER');
         end;

      end;
      xmlsl.Append('<CARDBRAND>'+CardBrands.CommaText+'</CARDBRAND>'); ///TODO multiple cards

      SaleTypes := TTTStringList.Create();
      if (NumToBoolStr(NumericOnly(Request.QueryFields.Values['SearchAllSaleTypes']))= 'FALSE') then begin
         if (NumToBoolStr(NumericOnly(Request.QueryFields.Values['SearchSTCredit']))= 'TRUE') then begin
            SaleTypes.Append('CREDIT');
         end;
         if (NumToBoolStr(NumericOnly(Request.QueryFields.Values['SearchSTReversal']))= 'TRUE') then begin
            SaleTypes.Append('REVERSAL');
         end;
         if (NumToBoolStr(NumericOnly(Request.QueryFields.Values['SearchSTSale']))= 'TRUE') then begin
            SaleTypes.Append('SALE');
         end;
         if (NumToBoolStr(NumericOnly(Request.QueryFields.Values['SearchSTVoid']))= 'TRUE') then begin
            SaleTypes.Append('VOID');
            SaleTypes.Append('CRVOID');
         end;
         if (NumToBoolStr(NumericOnly(Request.QueryFields.Values['SearchSTDebit']))= 'TRUE') then begin
            SaleTypes.Append('DEBIT');
         end;
         if (NumToBoolStr(NumericOnly(Request.QueryFields.Values['SearchSTRefund']))= 'TRUE') then begin
            SaleTypes.Append('REFUND');
         end;
      end;
      xmlsl.Append('<SALETYPE>'+SaleTypes.CommaText+'</SALETYPE>'); ///TODO multiple types



      xmlsl.Append('<MID>'+ValidCharsOnly(Request.QueryFields.Values['mid'],true,false,',')+'</MID>');
      xmlsl.Append('<AUTHCODE>'+ValidCharsOnly(Request.QueryFields.Values['authcode'],true,true,',')+'</AUTHCODE>');
      xmlsl.Append('<DEPOSITSLIP>'+ValidCharsOnly(Request.QueryFields.Values['depositslip'],true,true,',')+'</DEPOSITSLIP>');
      xmlsl.Append('<BAGNUMBER>'+ValidCharsOnly(Request.QueryFields.Values['bagnumber'],true,true,',')+'</BAGNUMBER>');

      xmlsl.Append('<STATIONIDENT>'+ValidCharsOnly(Request.QueryFields.Values['stationident'],true,true,'.\-_:/&,')+'</STATIONIDENT>');
      xmlsl.Append('<SETTLEDONLY>'+NumericOnly(Request.QueryFields.Values['settleonly'])+'</SETTLEDONLY>');
      xmlsl.Append('<DOLLARAMT>'+ValidCharsOnly(Request.QueryFields.Values['tranamt'],false,true,'.')+'</DOLLARAMT>');
      xmlsl.Append('<DOLLARAMTCOMP>'+NumericOnly(Request.QueryFields.Values['dollaramtcomp'])+'</DOLLARAMTCOMP>');
   xmlsl.Append('</SEARCHFIELDS>');
   xmlsl.Append('</REPORT>');

result := xmlsl.Text;
Processlog(ltInfo, 'GenerateReportXMLFromRequest result',xmlsl.Text);
FreeAndNil(RNIDs);
FreeAndNil(AllowedRNIDs);
FreeAndNIl(CardBrands);
FreeAndNil(SaleTypes);
end;

procedure TCustomerInfoModule.GenerateAllLocationOptionsSL(var Locs: TTTStringList);
Var
   AllowedRNIDs : String;
   RNIDAccess : TStringList;
   StoreProfile : string;
Begin
   AllowedRNIDs := UserXMLGetTag('/USERPROFILE/ALLOWEDRNIDS');
   RNIDAccess := TStringList.Create;
   if (GetUserRNIDAccess(RNIDAccess,false) > 0) then AllowedRNIDs := RNIDAccess.CommaText;

   if (UserXMLGetTag('/USERPROFILE/CHAINACCESS/CHAIN[@ID="'+trim(Stri(ChainCode,-1))+'"]/READONLY') <> '') then  AllowedRNIDs := '';
   if (AllowedRNIDs = '') then AllowedRNIDs := ExternalXMLGetTag('/EXTERNALXML/ALLOWEDRNIDS');

   If (OpenXMLGetTag('/CONFIGDATA/RNIDACCESSBYSTOREATTRIBUTES/ONGRID', 'FALSE') = 'TRUE') then begin //2018-01-25 jtm F#2360
      if (GetUserRNIDAccessByStoreAttr(RNIDAccess) > 0) then begin
         AllowedRNIDs := RNIDAccess.CommaText;
      end else if (OpenXMLGetTag('/CONFIGDATA/RNIDACCESSBYSTOREATTRIBUTES/OVERRIDEOTHERCONFIGS', 'FALSE') = 'TRUE') then begin
         AllowedRNIDs := '1234'; //give it a dummy rnid when overriding other config settings
      end;
   end;

   RNQuery2.Close;
   RNQuery2.SQL.Clear;
   RNQuery2.SQL.Add('Select * from Store where (Chaincode = ' + Stri(ChainCode,-1) + ')');
   If (GetConfigString('HIDECHAINRNIDS','') <> '') then begin
      RNQuery2.SQL.Add('and (NOT systemcode in (' + GetConfigString('HIDECHAINRNIDS','')+'))');
   end;
   If (AllowedRNIDs <> '') then begin
      RNQuery2.SQL.Add('and (systemcode in (' + AllowedRNIDs+'))');
   end;

   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONORDER','') <> '') then begin
      RNQuery2.SQL.Add('Order by ' + OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONORDER',''));
   end else begin
      RNQuery2.SQL.Add('Order by State,Name');
   end;

   RNQuery2.Open;
   RNQuery2.First;
   While Not (RNQuery2.EOF) do begin
      Locs.Append(RNQuery2.FieldByName('SystemCode').AsString);
      RNQuery2.Next;
   end;
   RNQuery2.Close;
   FreeAndNil(RNIDAccess);
end;


procedure TCustomerInfoModule.DoProcessRecord(Sender: TObject; ExportRecord: TStringList; AExportType: TProcessRecordType; AADS: TDataset);
begin
end;

function TCustomerInfoModule.GenerateReportGridHeaders: string;
var
xmlsl : TTTStringList;
NumberFormatNode : string;
begin
   result := '';
   xmlsl := TTTStringList.Create();
   xmlsl.Append('<?xml version="1.0" ?><REPORTHEADERS>');

	xmlsl.Append('<HEADERFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/HEADERFIELDNAMES','RNID,Auth Date,Type,Amount,Tran Type,Auth Code,NonAuthResp,Check #,Batch Date,Batch ID,Emp Ident,Tran Ident,Cust Ident,Station Ident,Transerial')+'</HEADERFIELDNAMES>');
	xmlsl.Append('<HEADERFIELDWIDTHS>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/HEADERFIELDWIDTHS','*,*,*,*,*,*,*,*,*,*,*,*,*,*,*')+'</HEADERFIELDWIDTHS>');
	xmlsl.Append('<HEADERFIELDCOLTYPES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/HEADERFIELDCOLTYPES','ro,ro,ro,ron,ro,ro,ro,ro,ro,ro,ro,ro,ro,ro,ro')+'</HEADERFIELDCOLTYPES>');
	xmlsl.Append('<HEADERFIELDCOLSORT>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/HEADERFIELDCOLSORT','str,date,str,int,str,str,int,date,int,str,str,str,str,str,str')+'</HEADERFIELDCOLSORT>');

   NumberFormatNode := DomainConfigXML.GetXPathNodeAsXMLString('/CONFIGDATA/SUPERREPORT/NUMBERFORMATS',false);
   if (NumberFormatNode = '') then begin
      NumberFormatNode := '<NUMBERFORMATS><NUMBERFORMAT><MASK>$0,000.00</MASK><COLNUM>3</COLNUM><PSEP>.</PSEP><DSEP>,</DSEP></NUMBERFORMAT></NUMBERFORMATS>';
   end;
   xmlsl.Append(NumberFormatNode);

   xmlsl.Append('</REPORTHEADERS>');


   result := xmlsl.Text;
end;
function TCustomerInfoModule.GenerateRNIDGridHeaders: string;
var
xmlsl : TTTStringList;
NumberFormatNode : string;
begin
   result := '';
   xmlsl := TTTStringList.Create();
   xmlsl.Append('<?xml version="1.0" ?><RNIDHEADERS>');

	xmlsl.Append('<HEADERFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/RNIDHEADERFIELDNAMES','Select,RNID,Store Name')+'</HEADERFIELDNAMES>');
	xmlsl.Append('<HEADERFIELDWIDTHS>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/RNIDHEADERFIELDWIDTHS','50,100,*')+'</HEADERFIELDWIDTHS>');
	xmlsl.Append('<HEADERFIELDCOLTYPES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/RNIDHEADERFIELDCOLTYPES','ch,ro,ro')+'</HEADERFIELDCOLTYPES>');
	xmlsl.Append('<HEADERFIELDCOLSORT>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/RNIDHEADERFIELDCOLSORT','na,int,str')+'</HEADERFIELDCOLSORT>');

   NumberFormatNode := DomainConfigXML.GetXPathNodeAsXMLString('/CONFIGDATA/SUPERREPORT/RNIDNUMBERFORMATS',false);
   xmlsl.Append(NumberFormatNode);

   xmlsl.Append('</RNIDHEADERS>');

   result := xmlsl.Text;
end;

function TCustomerInfoModule.GenerateReportConfigXML: string;
var
xmls : string;
NumberFormatNode : string;
begin
   result := '';

   xmls := xmls + '<?xml version="1.0" ?><REPORTCONFIG>';
   xmls := xmls + '<TRANSERIALLABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/TRANSERIALLABEL','TranSerial')+'</TRANSERIALLABEL>';
   xmls := xmls + '<CUSTIDENTLABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/CUSTIDENTLABEL','Cust Ident')+'</CUSTIDENTLABEL>';
   xmls := xmls + '<TRANIDENTLABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/TRANIDENTLABEL','Tran Ident')+'</TRANIDENTLABEL>';
   xmls := xmls + '<EMPIDENTLABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/EMPIDENTLABEL','Emp Ident')+'</EMPIDENTLABEL>';

   xmls := xmls + '<TENDERTYPELABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/TENDERTYPELABEL','Tender Type')+'</TENDERTYPELABEL>';
   xmls := xmls + '<CARDBRANDLABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/CARDBRANDLABEL','Card Brand')+'</CARDBRANDLABEL>';
   xmls := xmls + '<CARDTYPELABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/CARDTYPELABEL','Card Type')+'</CARDTYPELABEL>';
   xmls := xmls + '<LAST4LABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/LAST4LABEL','Last 4 Card')+'</LAST4LABEL>';
   xmls := xmls + '<MIDLABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/MIDLABEL','MID (Card Only)')+'</MIDLABEL>';
   xmls := xmls + '<SALETYPELABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/SALETYPELABEL','Type')+'</SALETYPELABEL>';
   xmls := xmls + '<AMOUNTLABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/AMOUNTLABEL','Amount')+'</AMOUNTLABEL>';
   xmls := xmls + '<AUTHCODELABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/AUTHCODELABEL','Auth Code')+'</AUTHCODELABEL>';
   xmls := xmls + '<STATIONIDENTLABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/STATIONIDENTLABEL','Station Ident')+'</STATIONIDENTLABEL>';
   xmls := xmls + '<DEPOPSITSLIPLABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/DEPOPSITSLIPLABEL','Deposit Slip #')+'</DEPOPSITSLIPLABEL>';
   xmls := xmls + '<BAGNUMBERLABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/BAGNUMBERLABEL','Bag #')+'</BAGNUMBERLABEL>';
   xmls := xmls + '<BATCHLABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/BATCHLABEL','Batch')+'</BATCHLABEL>';
   xmls := xmls + '<OPENBATCHLABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/OPENBATCHLABEL','Open Batch (Current)')+'</OPENBATCHLABEL>';
   xmls := xmls + '<CLOSEDBATCHLABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/CLOSEDBATCHLABEL','Closed Batch (History)')+'</CLOSEDBATCHLABEL>';

   xmls := xmls + '<FROMDATELABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/FROMDATELABEL','From Date')+'</FROMDATELABEL>';
   xmls := xmls + '<THRUDATELABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/THRUDATELABEL','Thru Date')+'</THRUDATELABEL>';

   xmls := xmls + '<STOREATTR1LABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/STOREATTR1LABEL','')+'</STOREATTR1LABEL>';
   xmls := xmls + '<STOREATTR2LABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/STOREATTR2LABEL','')+'</STOREATTR2LABEL>';
   xmls := xmls + '<STOREATTR3LABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/STOREATTR3LABEL','')+'</STOREATTR3LABEL>';
   xmls := xmls + '<STOREATTR4LABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/STOREATTR4LABEL','')+'</STOREATTR4LABEL>';
   xmls := xmls + '<STOREATTR5LABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/STOREATTR5LABEL','')+'</STOREATTR5LABEL>';
   xmls := xmls + '<STOREATTR6LABEL>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/STOREATTR6LABEL','')+'</STOREATTR6LABEL>';

   xmls := xmls + '<RNIDHEADERFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/RNIDHEADERFIELDNAMES','Select,RNID,Store Name')+'</RNIDHEADERFIELDNAMES>'; //2018-02-02 jtm: F#3765
   xmls := xmls + '<RNIDHEADERFIELDWIDTHS>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/RNIDHEADERFIELDWIDTHS','50,100,*')+'</RNIDHEADERFIELDWIDTHS>';
   xmls := xmls + '<RNIDHEADERFIELDCOLTYPES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/RNIDHEADERFIELDCOLTYPES','ch,ro,ro')+'</RNIDHEADERFIELDCOLTYPES>';
   xmls := xmls + '<RNIDHEADERFIELDCOLSORT>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/RNIDHEADERFIELDCOLSORT','na,int,str')+'</RNIDHEADERFIELDCOLSORT>';

   xmls := xmls + '<SECTIONSETTINGS>'; //2018-06-20 bls: F#4898
      xmls := xmls + '<ENABLEAREASECTION>' + OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/SECTIONSETTINGS/ENABLEAREASECTION', 'FALSE') + '</ENABLEAREASECTION>';
   xmls := xmls + '</SECTIONSETTINGS>';   

   xmls := xmls + '<ADVANCEDSEARCHSETTINGS>'; //2018-07-18 bls: F#4898
      xmls := xmls + '<ENABLEBAGNUMBER>' + OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/ADVANCEDSEARCHSETTINGS/ENABLEBAGNUMBER', 'FALSE') + '</ENABLEBAGNUMBER>';
      xmls := xmls + '<ENABLEDEPOSITSLIP>' + OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CONFIG/ADVANCEDSEARCHSETTINGS/ENABLEDEPOSITSLIP', 'FALSE') + '</ENABLEDEPOSITSLIP>';
   xmls := xmls + '</ADVANCEDSEARCHSETTINGS>';
   xmls := xmls + '</REPORTCONFIG>';
   result := xmls;

end;



function TCustomerInfoModule.EpicGetPaySessionData(SessionID: string): boolean;
var
EPRequest : TStringList;
EPResult : TStringList;
HTTPStatus : integer;
xmlstr : string;
EpicXML : TOpenXML;
EpicXMLNode : TOpenXMLNode;
begin
   result := false;
   EPRequest := TStringList.Create;
   EPResult := TStringList.Create;
   EPRequest.Add(LoadWebFileFromFolder('EpicGetPaySessionData.txt', 'EPICExtPaymentPage'));
   HTTPStatus := ExternalWebSvcEx(EPRequest,EPResult,OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/WEBAPIURL')+OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/EPIC/GETSESSIONDATAENDPOINT'),'POST','','');
   if (EPResult.Text <> '') and (HTTPStatus = 200) then begin
      xmlstr :=  EPResult.Text;
      xmlstr := JSONToXML(xmlstr);
      Try
         EpicXML := TOpenXML.CreateFromString(Nil,xmlstr);
      except
         On E:Exception do begin
            ProcessLog(ltWarning, 'Exception EpicXML: ', E.Message);
            exit;
         end;
      end;

      EpicXMLNode := EpicXML.GetNode('/JSON').FindFirstChildElement;

      while (EpicXMLNode <> nil) do begin
         SessionVarEval.AddValue(EpicXMLNode.NodeName, EpicXMLNode.TextContent);
         EpicXMLNode := EpicXMLNode.FindNextSiblingElement;
      end;
   end;
   Result := HTTPStatus = 200;//EPResult.Text;
   FreeAndNil(EpicXML);
   FreeAndNil(EPRequest);
   FreeAndNil(EPResult);
end;

function TCustomerInfoModule.DoGetAppServerEvent(Sender: TObject; ARNID: string): string;
begin
   VarEvaluator.AddValue('GatewayRNID',ARNID);
   result := GetAppServerHost;
end;

function TCustomerInfoModule.GenerateWebReferSession(RNID:string): boolean;
var
RNC : string;
custident : string;
hash : string;
sessiondatestr : string;
sessiondurationstr : string;
sessionduration : integer;
begin
   result := false;
   ProcessLog(ltInfo, 'GenerateWebReferSession:', 'Begin');
   if (RNID <> '') then begin
      RNC := trim(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/APICERT',''));
      if (RNC = '') then begin
         RNC := GetRNCERT(Valu(RNID));
         if (RNC = '') then begin
            ProcessLog(ltWarning,'GenerateWebReferSession','Account Not Configured');
            exit;
         end;
      end;
      custident := generateGuid();
      SessionVarEval.AddValue('GeneratedCustIdent',custident);
      
      if (OpenXMLGetTag('/CONFIGDATA/WEBREFER/USESHA1','FALSE') = 'TRUE') then begin
         hash := StringToSHADigestHex(RNID + RNC + custident + Trim(StriReal(ValuReal(SessionVarEval.GetValueAsString('Amount')),2)) + FormatDateTime('YYYYMMDD', NOW));
      end else begin
         hash := AnsiUpperCase(AWSAPI.CalcSHA256ToHex(RNID + RNC + custident + Trim(StriReal(ValuReal(SessionVarEval.GetValueAsString('Amount')),2)) + FormatDateTime('YYYYMMDD', NOW)));
      end;

      ProcessLog(ltInfo,'GenerateWebReferSession hash values','RNID=' + RNID + ', ' + 'CUSTIDENT=' + custident + ', ' +
                                                              'LOCALDATE=' + FormatDateTime('YYYYMMDD', NOW) + ', ' +
                                                              'LOCALTXNAUTH=' + hash + ', ' +
                                                              'AMOUNT='+ Trim(StriReal(ValuReal(SessionVarEval.GetValueAsString('Amount')),2)));
      SessionVarEval.AddValue('GeneratedHash',hash);

      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from WWWSession where RNSessionID = ''' + RnSessionID + '''');
      RNQuery.Open;
      RNQuery.Edit;
      RNQuery.FieldByName('ChainCode').AsInteger := ChainCode;
      RNQuery.FieldByName('RNID').AsString := RNID;

      SessionVarEval.AddValue('RNSessionID',RNSessionID);
      sessiondurationstr := NumericOnly(SessionVarEval.GetValueAsString('SessionDuration'));
      if (sessiondurationstr <> '') then begin
         sessionduration := StrToInt(sessiondurationstr);
      end else begin
         sessionduration := StrToInt(OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/EPIC/SESSIONDURATION','10'))
      end;
      if (SessionVarEval.GetValueAsString('SessionDateTime') <> '') then begin
         sessiondatestr := SessionVarEval.GetValueAsString('SessionDateTime');
         Try
            if (Pos('T',sessiondatestr)> 0) then begin
               RNQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime := RemoteTimeToLocalTimeWithDST(sessiondatestr) + EncodeTime(0,sessionduration,0,0);
            end else if (Pos('Z',sessiondatestr)> 0) then begin
               RNQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime := ZTimeToLocalTimeWithDST(sessiondatestr) + EncodeTime(0,sessionduration,0,0);
            end else begin
               RNQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime := StrToDateTime(sessiondatestr) + EncodeTime(0,sessionduration,0,0);
            end;
         except
            On E:Exception do begin
            ProcessLog(ltWarning, 'Exception Attempting date as datetime:', E.Message);
            end;
         end;
      end else begin
         RNQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime := Now + EncodeTime(0,sessionduration,0,0);
      end;

      RNQuery.Post;
      result := true;
   end else begin
      ProcessLog(ltWarning,'GenerateWebReferSession','Empty RNID');
   end;
   ProcessLog(ltInfo, 'GenerateWebReferSession:', 'End');
end;

function TCustomerInfoModule.EpicPostTransactionResult(): boolean;
var
EPRequest : TStringList;
EPResult : TStringList;
HTTPStatus : integer;
xmlstr : string;
EpicXML : TOpenXML;
EpicXMLNode : TOpenXMLNode;
begin
   result := false;
   EPRequest := TStringList.Create;
   EPResult := TStringList.Create;
   EPRequest.Add(LoadWebFileFromFolder('EpicPostTransactionResult.txt', 'EPICExtPaymentPage'));
   ProcessLog(ltInfo,'EpicPostTransactionResult Packet',EPRequest.Text);
   HTTPStatus := ExternalWebSvcEx(EPRequest,EPResult,OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/WEBAPIURL')+OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/EPIC/POSTTRANSACTIONRESULTENDPOINT'),'POST','','');
   if (EPResult.Text <> '') and (HTTPStatus = 200) then begin
      xmlstr :=  EPResult.Text;
      xmlstr := JSONToXML(xmlstr);
      if (UpperCase(GetXMLTagStr(xmlstr,'Success')) = 'TRUE') then begin
         Result := true;
      end else begin
         Result := false;
         ProcessLog(ltWarning,'EpicPostTransactionResult Failure',trim(GetXMLTagStr(xmlstr,'ErrorCode')));
      end;

   end else begin
      Result := false;//EPResult.Text;
      ProcessLog(ltWarning,'EpicPostTransactionResult Failure',IntToStr(HTTPStatus));
      ProcessLog(ltInfo,'EpicPostTransactionResult Packet',EPRequest.Text);
   end;


   FreeAndNil(EPRequest);
   FreeAndNil(EPResult);

end;

function TCustomerInfoModule.CCAuthRespErrorCodeToEpicDeclineType(ErrorCode: string): integer;
begin
   result := 0; //Unknown

   if (ErrorCode = '13') then begin //INVALID AMOUNT
      result := 1; //Insufficient funds
   end else if (ErrorCode = '54') then begin //EXPIRED CARD
      result := 2; //Expired card
   end else if (ErrorCode = '14') then begin  //INV ACCT NUM or INVALID CARD
      result := 3; //Invalid card number
   end else if (ErrorCode = 'C2') then begin //CVV2 DECLINED
      result := 4; //Invalid CVV
   end else if (ErrorCode = 'Z2') then begin //ADDRESS VERIFICATION ERROR
      result := 5; //Invalid billing address
   end else if (ErrorCode = 'Z3') then begin  //CARD VERIFICATION ERROR
      result := 6; //Additional verification required
   end else if (ErrorCode = '??') then begin
      result := 7; //Potential fraud
   end;

end;

function TCustomerInfoModule.CardTypeToEpicCardType(CardType: string): integer;
begin
   result := 0; //Unknown

   if (CardType = 'VISA') then begin
      result := 1;
   end else if (CardType = 'MC') then begin
      result := 2;
   end else if (CardType = 'AMEX') then begin
      result := 3;
   end else if (CardType = 'DISC') then begin
      result := 4;
   end else if (CardType = 'DINERS') then begin
      result := 5;
   end;
end;

function TCustomerInfoModule.SendPaymentInviteSMS(SessionID,PhoneNumber,DestinationURL, FileName,ClientURL,ARNID,ACustIdent: String): String;
var
    SMSText : String;
    LinkURL : String;
    SMSURL : string;
    SMSClient : TSMSEagle;
    un : string;
    pw : string;
    URLShortener : TURLShortener;
    ShortURLID : string;
    SMSHostname : string;
    Expiration : integer;
    MaxAccess : integer;
    return :string;
begin
   try
      if (DestinationURL <> '') then begin
         LinkURL := DestinationURL + '&SESSIONID=' + SessionID;
      end else begin
         LinkURL := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/PAYMENTINVITEURL') + '&SESSIONID=' + SessionID;
      end;
      if (ClientURL <> '') then begin  //2017-12-20 jtm: F#2235
         LinkURL := ClientURL + LoadWebFileFromFolder('PaymentInviteParams.htm','');
      end;

      URLShortener := TURLShortener.Create(PL.ProcessLog,RNDB);
      Expiration := StrToInt(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/PAYMENTINVITESMSURLEXP','72')); //hours
      MaxAccess  := StrToInt(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/PAYMENTINVITESMSURLMAXACCESS','5'));

      ShortURLID := URLShortener.InsertURL(LinkURL,Expiration,MaxAccess,ARNID,ACustIdent);
      ProcessLog(ltInfo, 'SendSMS: ShortURLID', ShortURLID);
      RNReg.KeyDelimiter := '\';
      DomainInfrastructure := RNReg.RegGetValAsString('PAYMENTPORTAL\INFRASTRUCTURE\'+DomainHostname,'DEFAULT',false);
      SMSURL := RNReg.RegGetValAsString('PAYMENTPORTAL\'+DomainInfrastructure+'\SMSIPTarget','',false);
      un := RNReg.RegGetValAsString('PAYMENTPORTAL\'+DomainInfrastructure+'\SMSUsername','',false);
      pw := RNReg.RegGetValAsString('PAYMENTPORTAL\'+DomainInfrastructure+'\SMSPassword','',false);
      if (SMSURL <> '') then begin
         if (PhoneNumber <> '') then begin
            SMSClient := TSMSEagle.create(SMSURL,FRegistry,PL.ProcessLog);
            SMSText := LoadWebFileFromFolder('PaymentInviteSMS.txt','');

            SMSHostname := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/PAYMENTINVITESMSURL');
            if (SMSHostname = '') then begin
               SMSHostname := RNReg.RegGetValAsString('PAYMENTPORTAL\'+DomainInfrastructure+'\SMSShortHostname','',false);
            end;
            LinkURL := SMSHostname + '?a=' + ShortURLID;
            ReplaceString(SMSText,'%LINKURL%', LinkURL);
            ProcessLog(ltInfo, 'SendSMS: FileName', FileName);
            ProcessLog(ltInfo, 'SendSMS: SMSURL', SMSURL);
            ProcessLog(ltDebug, 'SendSMS: un', un);
            return := SMSClient.SMSSendMessage(un,pw,PhoneNumber,SMSText);
            ProcessLog(ltInfo, 'SendSMS: SMSSendMessage result', return);
            if (Pos('OK',return)>0) then begin
               Result := 'TRUE';
            end else begin
               Result := 'FALSE';
            end;
         end else begin
            ProcessLog(ltInfo, 'SendPaymentInviteSMS Phone Number not sent in', '');
            Result := 'FALSE';
         end;
      end else begin
         ProcessLog(ltWarning, 'SMSIPTarget not set for INFRASTRUCTURE', DomainInfrastructure);
         Result := 'FALSE';
      end;
   except
      On E:Exception do begin
      ProcessLog(ltWarning, 'Exception SendPaymentInviteSMS:', E.Message);
       Result := 'FALSE';
      end;
   end;
end;

function TCustomerInfoModule.GetStoreAttrOptionsSL(var StoreAttr: TTTStringList; AttrNum : string): boolean;
begin
   result := true;
   AttrNum := NumericOnly(AttrNum);
   if (AttrNum = '') then begin
       AttrNum := '0';
   end;
   GetUserStoreAttrAccess(); //2018-02-02 jtm: F#3765
   try
      RNQuery2.Close;
      RNQuery2.SQL.Clear;
      RNQuery2.SQL.Add('Select distinct StoreAttribute'+AttrNum+' from Store where (Chaincode = ' + Stri(ChainCode,-1) + ')');
      ProcessStoreAttrFields(RNQuery2,true,StrToInt(AttrNum));
      RNQuery2.Open;
      ProcessLog(ltInfo,'GetStoreAttrOptionsSL RNQuery2',RNQuery2.SQL.Text);
      While Not (RNQuery2.EOF) do begin
         if (trim(RNQuery2.FieldByName('StoreAttribute'+AttrNum).AsString) <> '') then begin
            StoreAttr.Append(RNQuery2.FieldByName('StoreAttribute'+AttrNum).AsString);
         end;
         RNQuery2.Next;
      end;
   except
      On E:Exception do begin
         ProcessLog(ltWarning, 'Exception GetStoreAttrOptionsSL:', E.Message);
         if ((ExceptionIsMultiUserInterference(RNQuery2)) or (ExceptionIsPrimaryKeyConstraint(RNQuery2))) and (RecursionDepth < 5) then begin //2018-02-02 jtm: F#3765
            Inc(RecursionDepth);
            ProcessLog(ltWarning, 'Exception GetStoreAttrOptionsSL:', 'start recursion:' + IntToStr(RecursionDepth));
            result := GetStoreAttrOptionsSL(StoreAttr,AttrNum);
            RecursionDepth := 0;
         end else begin
            ProcessLog(ltWarning, 'Exception GetStoreAttrOptionsSL error number:', IntToStr(RNQuery2.Connection.Errors.Item[0].Number));
            result := false;
         end;
      end;
   end;
end;

function TCustomerInfoModule.StoreAttrSLToDHTMLXGrid(StoreAttr: TTTStringList): string;
var
Locs :string;
i : integer;
begin
   Locs := '<?xml version="1.0" encoding="iso-8859-1"?><rows total_count='''+IntToStr(StoreAttr.Count)+''' pos= "0">';
   for i := 1 to StoreAttr.Count do begin
      Locs := Locs + '<row id="'+IntToStr(i)+'"><cell>0</cell><cell>'+StoreAttr[i-1]+'</cell></row>';
   end;
   Locs := Locs + '</rows>';
   Result := Locs;
end;
procedure TCustomerInfoModule.GetUserStoreAttrAccess;
var
   RNIDAccessXMLNode : TOpenXMLNode;
begin
   if Assigned(UserXML) and (UserXML.GetNode('/USERPROFILE/STOREATTRIBUTES') <> nil) then begin  //2018-01-29 jtm: D#3705
      RNIDAccessXMLNode := UserXML.GetNode('/USERPROFILE/STOREATTRIBUTES');
      ProcessLog(ltInfo,'GetUserRNIDAccessByStoreAttr','UserXML not null');
      ProcessStoreAttributeXML(UserXML,RNIDAccessXMLNode);
   end else if Assigned(ExternalXML) and (ExternalXML.GetNode('/EXTERNALXML/STOREATTRIBUTES') <> nil) then begin
      RNIDAccessXMLNode := ExternalXML.GetNode('/EXTERNALXML/STOREATTRIBUTES');
      ProcessStoreAttributeXML(ExternalXML,RNIDAccessXMLNode);
   end;
end;
function TCustomerInfoModule.GetUserRNIDAccessByStoreAttr(var ASL: TStringList): Integer;
var
   I : Integer;

Begin
   ASL.Clear;
   Result := 0;
   I := 0;
   ProcessLog(ltInfo,'GetUserRNIDAccessByStoreAttr','start');
   GetUserStoreAttrAccess();
   RNQuery2.Close;
   RNQuery2.SQL.Clear;
   RNQuery2.SQL.Add('Select * from Store where (Chaincode = ' + Stri(ChainCode,-1) + ')');
   ProcessStoreAttrFields(RNQuery2,true,0);

   ProcessLog(ltInfo,'GetUserRNIDAccessByStoreAttr RNQuery2',RNQuery2.SQL.Text);
   RNQuery2.Open;
   I := RNQuery2.RecordCount;
   While Not (RNQuery2.EOF) do begin
      if (trim(RNQuery2.FieldByName('systemcode').AsString) <> '') then begin
         ASL.Append(RNQuery2.FieldByName('systemcode').AsString);
      end;
      RNQuery2.Next;
   end;;
   ProcessLog(ltInfo,'GetUserRNIDAccessByStoreAttr','end');
   Result := I;
end;
function TCustomerInfoModule.StringListToSQLCommaTest(ASL: TStringList): string;
var s : string;
i : integer;
begin
   s := '';
   for i := 0 to ASL.Count-1 do begin
      s := s + '''' + ASL[i];
      if (i = ASL.Count-1) then begin
         s := s  + '''';
      end else begin
         s := s + ''',';
      end;
   end;
   result := s;
end;
procedure TCustomerInfoModule.ProcessStoreAttributeXML(XML:TOpenXML;XMLNode:TOpenXMLNode);
var
FldName,val : string;
begin
   XMLNode := XMLNode.FindFirstChildElement;
   ProcessLog(ltInfo,'ProcessStoreAttributeXML ProcessXML','start');
   while XMLNode <> nil do begin
      FldName := trim(XML.GetContextValueAsWideString(XMLNode,'FLDNAME'));
      val := trim(XML.GetContextValueAsWideString(XMLNode,'VALUE'));
      if (FldName = 'StoreAttribute1') then begin
         StoreAttr1.Append(val);
      end else if (FldName = 'StoreAttribute2') then begin
         StoreAttr2.Append(val);
      end else if (FldName = 'StoreAttribute3') then begin
         StoreAttr3.Append(val);
      end else if (FldName = 'StoreAttribute4') then begin
         StoreAttr4.Append(val);
      end else if (FldName = 'StoreAttribute5') then begin
        StoreAttr5.Append(val);
      end else if (FldName = 'StoreAttribute6') then begin
        StoreAttr6.Append(val);
      end;
      XMLNode := XMLNode.FindNextSiblingElement;
   end;
end;
procedure TCustomerInfoModule.ProcessStoreAttrFields(AQuery : TADOQuery; AFirstCon : boolean; AttrNum:integer);
procedure CheckFirstCon;
begin
   if (AFirstCon) then begin
      RNQuery2.SQL.Add('and (');
      AFirstCon := false;
   end else begin
      AQuery.SQL.Add('and');
   end;
end;
begin
   if (StoreAttr1.Text <> '') and ((AttrNum = 1) or (AttrNum = 0)) then begin
      if not (Pos('ALL',StoreAttr1.Text) > 0) then begin
         CheckFirstCon();
         AQuery.SQL.Add('(StoreAttribute1 in (' + StringListToSQLCommaTest(StoreAttr1) + '))');
      end;
   end;
   if (StoreAttr2.Text <> '') and ((AttrNum = 2) or (AttrNum = 0)) then begin
      if not (Pos('ALL',StoreAttr2.Text) > 0) then begin
         CheckFirstCon();
         AQuery.SQL.Add('(StoreAttribute2 in (' + StringListToSQLCommaTest(StoreAttr2) + '))');
      end;
   end;
   if (StoreAttr3.Text <> '') and ((AttrNum = 3) or (AttrNum = 0)) then begin
      if not (Pos('ALL',StoreAttr3.Text) > 0) then begin
         CheckFirstCon();
         AQuery.SQL.Add('(StoreAttribute3 in (' + StringListToSQLCommaTest(StoreAttr3) + '))');
      end;
   end;
   if (StoreAttr4.Text <> '') and ((AttrNum = 4) or (AttrNum = 0)) then begin
      if not (Pos('ALL',StoreAttr4.Text) > 0) then begin
         CheckFirstCon();
         AQuery.SQL.Add('(StoreAttribute4 in (' + StringListToSQLCommaTest(StoreAttr4) + '))');
      end;
   end;
   if (StoreAttr5.Text <> '') and ((AttrNum = 5) or (AttrNum = 0)) then begin
      if not (Pos('ALL',StoreAttr5.Text) > 0) then begin
         CheckFirstCon();
         AQuery.SQL.Add('(StoreAttribute5 in (' + StringListToSQLCommaTest(StoreAttr5) + '))');
      end;
   end;
   if (StoreAttr6.Text <> '') and ((AttrNum = 6) or (AttrNum = 0)) then begin
      if not (Pos('ALL',StoreAttr6.Text) > 0) then begin
         CheckFirstCon();
         AQuery.SQL.Add('(StoreAttribute6 in (' + StringListToSQLCommaTest(StoreAttr6) + '))');
      end;
   end;
   if not (AFirstCon) then begin
      RNQuery2.SQL.Add(')');
   end;
end;

function TCustomerInfoModule.AuthenticateOAuthSession: boolean;
var
   Lastauthentication :string;
   SessionDate:TDateTime;
   OAuthPacket,OAuthResp:string;
   OAuthPacketSL,OAuthRespSL:TStringList;
   ClientID,ClientSecret:string;
   Node,Name,Value,URL,AccessToken:string;
   seconds:integer;
begin
   (*
      Request:

      Response:
   *)

   Result := false;

   LastAuthentication := SessionVarEval.GetValueAsString('OAUTHSESSIONDT');
   if IsValidDateTimeString(LastAuthentication) then begin
      SessionDate := StrToDateTime(LastAuthentication);
      If (Now() > SessionDate) then begin
         ProcessLog(ltInfo,'Session requires new authentication','');
         AccessToken := ''; //Clear acces token
         SessionVarEval.AddValue('OAUTHACCESSTOKEN',AccessToken);
      end else begin
         ProcessLog(ltInfo,'Session still Authenticated','');
         AccessToken := SessionVarEval.GetValueAsString('OAUTHACCESSTOKEN');
         if AccessToken <> '' then begin
            Result := true;
            exit;
         end else begin
            ProcessLog(ltInfo,'Access Token not found','');
         end;
      end;
   end;

   URL := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/OAUTH/AUTHURL', '');//CDM.CreditReg.ReadString('Credit Processing\Private Label\SYF', 'AuthenticationURL','');
   if URL = '' then begin
      Processlog(ltCritical, 'OAUTH Web Service Authentication URL BLANK','');
   end;

   ClientID := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/OAUTH/CLIENTID', '');//CDM.CreditReg.ReadString('Credit Processing\Private Label\SYF','ClientID','');
   ClientSecret := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/OAUTH/CLIENTSECRET', '');//CDM.CreditReg.ReadString('Credit Processing\Private Label\SYF','ClientSecret','');
   if (ClientID = '') or (ClientSecret = '') then begin
      ProcessLog(ltWarning,'ClientID and Client Secret Required for Authentication','');
   end;

   OAuthPacketSL := TStringList.Create;
   OAuthRespSL := TStringList.Create;
   OAuthPacketSL.Text := 'grant_type=client_credentials';   //vecna
   ExternalWebSvcEx(OAuthPacketSL, OAuthRespSL,URL,'POST','','',true);

   OAuthResp := OAuthRespSL.Text;
   FreeAndNil(OAuthPacketSL);
   FreeAndNil(OAuthRespSL);
   if OAuthResp <> '' then begin
      while OAuthResp <> '' do begin
         Node := ParseTochar(OAuthResp,',');
         Name := ValidcharsOnly(ParseToChar(Node,':'),true,true,'_');
         if Name = 'scope' then begin

         end else if name = 'expires_in' then begin
            Value := trim(Node);
            if Value <> '' then begin
               Seconds := StrToInt(Value) - 60;
               SessionVarEval.AddValue('OAUTHSESSIONDT', FormatDateTime('YYYY-MM-DD HH:NN:SS',Now + GetEncodedTimeFromSecondsWindowOfTime(Seconds,0,ProcessLog)));
            end;
         end else if name = 'token_type' then begin

         end else if name = 'access_token' then begin
            ParseToChar(Node,'"');
            Value := trim(ParseToChar(Node,'"'));
            if Value <> '' then begin
               ProcessLog(ltInfo,'Access Token Received','');
               AccessToken := Value;
               SessionVarEval.AddValue('OAUTHACCESSTOKEN',AccessToken);
               Result := true;
            end;
         end;
      end;
   end else begin
      ProcessLog(ltInfo,'Authentication Failed','No Response from:' + '');
   end;

end;

function TCustomerInfoModule.VencaAccountValidation(ClinicRNID, DOB,LastFour, Account, URL: String; ResultXML: TStringList): Boolean;
var
   APIRequest : TStringList;
   HTTPStatus : Integer;
   RequestFN : String;
   DOBDate : TDateTime;
begin
   LastFour := NumericOnly(LastFour);
   DOB := ValidCharsOnly(DOB,false, true,'-/');
   try
      DOBDate := StrToDateTime(DOB);
   except
      on e:exception do begin

      end;
   end;
   Account := ValidCharsOnly(Account,true,true,'-/.');
   APIRequest := TStringList.Create;
   SessionVarEval.AddValue('dob', FormatDateTime('YYYY-MM-DD',DOBDate));
   SessionVarEval.AddValue('last4Ssn', LastFour);
   SessionVarEval.AddValue('VecnaAccountNumber',  Account);

   RequestFN := OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/VECNA/ACCOUNTVALIDATIONFILE', 'AccountValidation.xml');
   APIRequest.Add(LoadWebFileFromFolder(RequestFN, 'VECNA'));
   ProcessLog(ltInfo,'Venca validate account',APIRequest.Text);

   HTTPStatus := ExternalWebSvcEx(APIRequest,ResultXML,URL,'POST','','');
   Result :=  HTTPStatus = 200;
   If HTTPStatus = 200 then begin
      VarEvaluator.AddValue('ExternalCustIdent', GetXMLTag(ResultXML,'PatientID'));
      SessionVarEval.AddValue('VecnaAccountValidationResp', ResultXML.Text);
      SessionVarEval.AddValue('VecnaAccountNumber', GetXMLTag(ResultXML,'accountNumber'));
      SessionVarEval.AddValue('VecnaBalance', GetXMLTag(ResultXML,'accountNumber'));
      SessionVarEval.AddValue('VecnaPatientName', GetXMLTag(ResultXML,'patientName'));
      SessionVarEval.AddValue('VecnaStatusCode', GetXMLTag(ResultXML,'statusCode'));
   end else begin
      ProcessLog(ltWarning,'Venca error',GetXMLTag(ResultXML,'error')+':'+ GetXMLTag(ResultXML,'error_description'));
   end;

end;

function TCustomerInfoModule.ProcessPPSAPIXML(XMLRequest: String): string;
var
XMLResp : TStringList;
XMLReq : TOpenXML;
begin
   XMLResp := TStringList.Create;
   XMLReq := TOpenXML.CreateFromString(nil,XMLRequest);
   XMLReq.AddChildNode('/TRANSACTION','RNID', SessionVarEval.GetValueAsString('RuntimeRNID'));
   ProcessPPSAPIXML(XMLReq.DocumentAsString, XMLResp,GetAppServerHost,0);
   Result := XMLResp.Text;
   FreeAndNil(XMLResp);
   FreeAndNil(XMLReq);
end;

procedure TCustomerInfoModule.InitializeRuntimeInfo();
begin
   RuntimeInfo := TPMRuntimeInfo.Create(GetRNID, GetRNCERT);
   RuntimeInfo.OnGetEmpIdent := GetEmpIdent;
   RuntimeInfo.OnGetStationIdent := GetStationIdent;
   RuntimeInfo.OnGetProfileXMLValueAsString := GetProfileXMLValueAsString;
   RuntimeInfo.OnGetProfileXMLValueAsInteger := GetProfileXMLValueAsInteger;
   RuntimeInfo.OnGetProfileXMLValueAsBoolean := GetProfileXMLValueAsBoolean;
   RuntimeInfo.OnGetProfileXMLValueAsNumber := GetProfileXMLValueAsNumber;
   RuntimeInfo.OnGetStoreName := GetStoreName;
   RuntimeInfo.OnGetStoreAddress := GetStoreAddress;
   RuntimeInfo.OnGetStoreCSZ := GetStoreCSZ;
   RuntimeInfo.OnGetStorePhone := GetStorePhone;
   RuntimeInfo.OnProcessLog := PL.ProcessLog;
   RuntimeInfo.OnGetCustIdentDesc := GetCustIdentDesc;
   RuntimeInfo.OnGetTranIdentDesc := GetTranIdentDesc;
   RuntimeInfo.OnGetCustIdentRequired := GetCustIdentRequired;
   RuntimeInfo.OnGetTranIdentRequired := GetTranIdentRequired;
   RuntimeInfo.OnGetDrawerIdent := GetDrawerIdent;
end;

function TCustomerInfoModule.GetCustIdentDesc(ADefault: String): string;
begin
   Result := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/CUSTIDENTDESCRIPTION',ADefault);
end;

function TCustomerInfoModule.GetCustIdentRequired(ADefault: boolean): boolean;
begin
   Result := StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/CUSTIDENTREQUIRED',BoolToStr(ADefault)));
end;

function TCustomerInfoModule.GetDrawerIdent: string;
begin
   Result := SessionVarEval.GetValueAsString('RuntimeDrawerIdent');
end;

function TCustomerInfoModule.GetEmpIdent: string;
begin
   Result := SessionVarEval.GetValueAsString('RuntimeEmpIdent');
end;

function TCustomerInfoModule.GetProfileXMLValueAsBoolean(XPath: string; ADefault: boolean): boolean;
begin
  if (OpenXMLGetTag('/CONFIGDATA/RUNTIMEPROFILE','LOCAL') = 'LOCAL') and assigned(ProfileXML) then begin
     Result := ProfileXML.GetXMLValueAsBoolean(XPath,ADefault);
  end else if (OpenXMLGetTag('/CONFIGDATA/RUNTIMEPROFILE','LOCAL') = 'GW') and assigned(RNProfile) then begin
     Result := RNProfile.GetProfileXMLValueAsBoolean(XPath,ADefault);
  end else begin
     Result := ADefault;
  end;
end;

function TCustomerInfoModule.GetProfileXMLValueAsInteger(XPath: string; ADefault: integer): integer;
begin
  if (OpenXMLGetTag('/CONFIGDATA/RUNTIMEPROFILE','LOCAL') = 'LOCAL') and assigned(ProfileXML) then begin
     Result := ProfileXML.GetXMLValueAsInteger(XPath,ADefault);
  end else if (OpenXMLGetTag('/CONFIGDATA/RUNTIMEPROFILE','LOCAL') = 'GW') and assigned(RNProfile) then begin
     Result := RNProfile.GetProfileXMLValueAsInteger(XPath,ADefault);
  end else begin
     Result := ADefault;
  end;
end;

function TCustomerInfoModule.GetProfileXMLValueAsNumber(XPath: string; ADefault: double): double;
begin
  if (OpenXMLGetTag('/CONFIGDATA/RUNTIMEPROFILE','LOCAL') = 'LOCAL') and assigned(ProfileXML) then begin
     Result := ProfileXML.GetXMLValueAsNumber(XPath,ADefault);
  end else if (OpenXMLGetTag('/CONFIGDATA/RUNTIMEPROFILE','LOCAL') = 'GW') and assigned(RNProfile) then begin
     Result := RNProfile.GetProfileXMLValueAsNumber(XPath,ADefault);
  end else begin
     Result := ADefault;
  end;
end;

function TCustomerInfoModule.GetProfileXMLValueAsString(XPath: string; ADefault: String): string;
begin
  if (OpenXMLGetTag('/CONFIGDATA/RUNTIMEPROFILE','LOCAL') = 'LOCAL') and assigned(ProfileXML) then begin
     Result := ProfileXML.GetXMLValueAsString(XPath,ADefault);
  end else if (OpenXMLGetTag('/CONFIGDATA/RUNTIMEPROFILE','LOCAL') = 'GW') and assigned(RNProfile) then begin
     Result := RNProfile.GetProfileXMLValueAsString(XPath,ADefault);
  end else begin
     Result := ADefault;
  end;
end;

function TCustomerInfoModule.GetRNCERT: string;
begin
   Result := GetRNCERT(Valu(SessionVarEval.GetValueAsString('RuntimeRNID')));
end;

function TCustomerInfoModule.GetRNID: string;
begin
   Result := SessionVarEval.GetValueAsString('RuntimeRNID');
end;

function TCustomerInfoModule.GetStationIdent: string;
begin
   Result := SessionVarEval.GetValueAsString('RuntimeStationIdent');
end;

function TCustomerInfoModule.GetStoreAddress: string;
begin
  Result := StoreAddress1;
end;

function TCustomerInfoModule.GetStoreCSZ: string;
begin
  Result := StoreCity+', '+StoreState+' '+StoreZip; //2018-06-20 bls: D#4497
end;

function TCustomerInfoModule.GetStoreName: string;
begin
  Result := StoreName;
end;

function TCustomerInfoModule.GetStorePhone: string;
begin
  Result := StorePhone;
end;

function TCustomerInfoModule.GetTranIdentDesc(ADefault: String): string;
begin
   Result := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/TRANIDENTDESCRIPTION',ADefault);
end;

function TCustomerInfoModule.GetTranIdentRequired(ADefault: boolean): boolean;
begin
   Result := StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/TRANIDENTREQUIRED',BoolToStr(ADefault)));
end;

function TCustomerInfoModule.SingleCashBatchXMLToTableHTML: String;
var
  BatchHTML : TStringList;
  BRNID : String;
  BSC : String;
  CashBatchXMLNode : TOPENXMLNode;
  TicketGUID : string;
  CashTransactionUnavailableMessage : string;
Begin
   Result := '';
   If BatchOXML = NIL then exit;

   BatchHTML := TStringList.Create;
   CashTransactionUnavailableMessage := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/CASHTRANSACTIONUNAVAILABLEMESSAGE', 'Transaction not available');
   CashBatchXMLNode := BatchOXML.GetNode('/TRANRESP/CASHBATCHDETAIL');


   If (CashBatchXMLNode = nil) then begin
      BatchHTML.Add('<br><br><table><tr><td><b>' + CashTransactionUnavailableMessage + '</b></td></tr></table>');
   end else begin
      CashBatchXMLNode := CashBatchXMLNode.FindFirstChildElement;

      BRNID := Trim(BatchOXML.GetValueAsWideString('/TRANRESP/PROFILE'));
      BSC := BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'SYSTEMCODE');
      TicketGUID := BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'TICKETGUID');

      BatchHTML.Append('<TABLE>');
      BatchHTML.Append('<TR><TD Align="Left"><B>Location</B></TD><TD>' + BRNID +'</TD></TR>');
      BatchHTML.Append('<TR><TD Align="Left"><B>Tran Date</B></TD><TD>' + BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'TRANDATE') +'</TD></TR>');
      If BatchOXML.GetContextValueAsBoolean(CashBatchXMLNode,'VOIDED') then begin
         BatchHTML.Append('<TR><TD Align="Left"><B>Date Voided</B></TD><TD>' + BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'VOIDEDDATE')+'</TD></TR>');
      end;

      BatchHTML.Append('<TR><TD Align="Left"><B>Amount</B></TD><TD>$' + Trim(StriREal(BatchOXML.GetContextValueAsNumber(CashBatchXMLNode,'TRANAMT'),2)) +'</TD></TR>');

      BatchHTML.Append('<TR><TD Align="Left"><B>Currency Type Type</B></TD><TD>' +BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'CURRENCYTYPE') +'</TD></TR>');
      BatchHTML.Append('<TR><TD Align="Left"><B>Tran Type</B></TD><TD>' +BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'TRANTYPE') +'</TD></TR>');

      BatchHTML.Append('<TR><TD Align="Left"><B>Tran Ident</B></TD><TD>' + BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'TRANIDENT') +'</TD></TR>');
      BatchHTML.Append('<TR><TD Align="Left"><B>Batch Code</B></TD><TD>' + BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'BATCHCODE') +'</TD></TR>');

      BatchHTML.Append('<TR><TD Align="Left"><B>Service Name</B></TD><TD>' +BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'CASHSERVICENAME') +'</TD></TR>');
      BatchHTML.Append('<TR><TD Align="Left"><B>Station</B></TD><TD>' +BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'STATIONIDENT') +'</TD></TR>');
      BatchHTML.Append('<TR><TD Align="Left"><B>Store System Code</B></TD><TD>' + BSC +'</TD></TR>');

      BatchHTML.Append('</TABLE>');

      BatchHTML.Append('<BR><BR><DIV id="VTCashDetailFormActionButtonDIV"><CENTER>');
      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINRECEIPTS/USEPROFILECONFIG', 'FALSE') = 'TRUE') then begin
         if (OpenXMLGetTag('/CONFIGDATA/RUNTIMEPROFILE','LOCAL') = 'LOCAL') then begin
            if not assigned(ProfileXML) then begin
               ProfileXML := TTProfileXML.Create(StrToInt(BRNID), HDQuery);
            end;
         end else if (OpenXMLGetTag('/CONFIGDATA/RUNTIMEPROFILE','LOCAL') = 'GW') then begin
            if not assigned(RNProfile) then begin
               RNProfileDI := TTADODataLayer.Create(RNDB);
               RNProfile := TTProfile.Create(BRNID,false, RNProfileDI);
            end;
         end;
         ProcessLog(ltDebug,'SingleCashBatchXMLToTableHTML','Profile Created');
         if not (GetProfileXMLValueAsBoolean('/PROFILE/DRAWERSETTINGS/USEOLDRECEIPTS',true)) then begin
            ProcessLog(ltDebug,'SingleCashBatchXMLToTableHTML','UseOldReceipts is false, show the print button');
            if (TicketGUID <> '') then begin
               BatchHTML.Append('<a href="javascript://" class="linkBtn"  onclick="VTPrintAuthReceiptAJAX(' + BRNID + ',' + BSC + ',''CASH'',''' + TicketGUID + ''');");>Print</a>   ');
            end else begin
               BatchHTML.Append('<a href="javascript://" class="linkBtn"  onclick="VTPrintAuthReceiptAJAX(' + BRNID + ',' + BSC + ',''CASH'');");>Print</a>   ');
            end;
         end;
      end;
      BatchHTML.Append('</CENTER></DIV><BR><BR>');
   end;
   Result := batchHTML.Text;
   BatchHTML.Free;

end;
function TCustomerInfoModule.DateRangeNumToStr(number: string): string;
begin
   result := 'CUSTOM';
   if (number = '0') then begin
      result := 'CUSTOM';
   end else if (number = '1') then begin
      result := 'TODAY';
   end else if (number = '2') then begin
      result := 'YESTERDAY';
   end else if (number = '3') then begin
      result := 'LAST7DAYS';
   end else if (number = '4') then begin
      result := 'LAST30DAYS';
   end else if (number = '5') then begin
      result := 'LAST6MONTHS';
   end else if (number = '6') then begin
      result := 'LAST12MONTHS';
   end else if (number = '7') then begin
      result := 'LAST18MONTHS';
   end else if (number = '8') then begin
      result := 'MTD';
   end else if (number = '9') then begin
      result := 'YTD';
   end else if (number = '10') then begin
      result := 'LASTWEEK';
   end else if (number = '11') then begin
      result := 'THISWEEK';
   end else if (number = '12') then begin
      result := 'LASTMONTH';
   end else if (number = '13') then begin
      result := 'LASTYEAR';
   end;
end;

function TCustomerInfoModule.CashBatchXMLToXLS(xExport : TOExport; DisplayFormat : String): String;
var
  BRNID : String;
  BSC : String;
  BatchXLSHeader : string;
  CashBatchXMLNode : TOPENXMLNode;
  StoreSystemCodeLabel : string;  //2016-8-22 jtm: Feat OT#1082

  xlsWorkSheet : TExportWorksheet; //Represents actual xls worksheet
  Row : TExportRow; //Represents actual row inside the TExportWorksheet
  iterator : integer;
  JSON : TStringList;
  JSONString : String;

  TranIdentHeader : string; //2018-4-24 bls: F#3735
  CustIdentHeader : string; //2018-4-24 bls: F#3735

Begin
   Result := '';
   If BatchOXML = NIL then exit;

   TranIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CASHTRANIDENTDESC', 'Tran Ident'));  //2018-4-24 bls: F#3735
   CustIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CASHCUSTIDENTDESC', 'Cust Ident'));  //2018-4-24 bls: F#3735

   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL', '') <> '' then StoreSystemCodeLabel := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL'));  //2016-8-22 jtm: Feat OT#1038

   if DisplayFormat = 'XLS' then begin

      xlsWorkSheet := xExport.AddWorkSheet;
      Row := xlsWorkSheet.AddRow;

      Row.AddCellString('RNID');
      Row.AddCellString('Tran Date');
      Row.AddCellString('Tran Type');
      Row.AddCellString('Amount');
      Row.AddCellString('Emp Ident');
      Row.AddCellString(TranIdentHeader);      //2018-4-24 bls: F#3735
      Row.AddCellString(CustIdentHeader);      //2018-4-24 bls: F#3735
      Row.AddCellString('Station Ident');
      Row.AddCellString('Type');

      if StoreSystemCodeLabel <> '' then begin
         Row.AddCellString(StoreSystemCodeLabel);
      end else begin
         BatchXLSHeader := BatchXLSHeader + 'Station Code'+ #9;
         Row.AddCellString('Station Code');
      end;

      For iterator := 0 to Row.Cells.Count - 1 do begin
         Row.Cells.Items[iterator].SetFontColor(clBlack).SetBorder(cbBottom).SetBGColor(TColor($80000000)).SetAlignment(cahCenter);
      end;


      CashBatchXMLNode := BatchOXML.GetNode('/TRANRESP/CASHBATCHDETAIL');
      CashBatchXMLNode := CashBatchXMLNode.FindFirstChildElement;

      While (CashBatchXMLNode <> nil) do begin
         Row := xlsWorksheet.AddRow;

         if (CashBatchXMLNode.NodeName = 'CASHDETAIL') then begin //2017-09-06 jtm: D#1885
            BRNID := Trim(BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'PROFILE'));
            BSC := BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'SYSTEMCODE');

            Row.AddCellString(BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'PROFILE'));
            Row.AddCellString(BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'TRANDATE'));
            Row.AddCellString(BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'TRANTYPE'));
            Row.AddCellString(DisplayMoney(ValuReal(BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'TRANAMT'))));
            Row.AddCellString(BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'EMPIDENT'));
            Row.AddCellString(BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'TRANIDENT'));
            Row.AddCellString(BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'CUSTIDENT'));
            Row.AddCellString(BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'STATIONIDENT'));
            Row.AddCellString(BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'CURRENCYTYPE'));
            Row.AddCellString(BSC);
         end;
         CashBatchXMLNode := CashBatchXMLNode.FindNextSiblingElement;
      end;
      Result := '';

   end else if DisplayFormat = 'JSON' then begin
      JSON := TStringList.Create;
      JSON.Append('[');
      CashBatchXMLNode := BatchOXML.GetNode('/TRANRESP/CASHBATCHDETAIL');
      CashBatchXMLNode := CashBatchXMLNode.FindFirstChildElement;

      While (CashBatchXMLNode <> nil) do begin
         if (CashBatchXMLNode.NodeName = 'CASHDETAIL') then begin //2017-09-06 jtm: D#1885
            BRNID := Trim(BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'PROFILE'));
            BSC := BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'SYSTEMCODE');
            
            JSON.Append('{"RNID":"' + BRNID + '",');
            JSON.Append('"Tran Date":"' + BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'TRANDATE') + '",');
            JSON.Append('"Tran Type":"' + BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'TRANTYPE') + '",');
            JSON.Append('"Amount":"' + DisplayMoney(ValuReal(BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'TRANAMT'))) + '",');
            JSON.Append('"Emp Ident":"' + BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'EMPIDENT') + '",');
            JSON.Append('"'+ TranIdentHeader +'":"' + BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'TRANIDENT') + '",');  //2018-4-24 bls: F#3735
            JSON.Append('"'+ CustIdentHeader +'":"' + BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'CUSTIDENT') + '",');  //2018-4-24 bls: F#3735
            JSON.Append('"Station Ident":"' + BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'STATIONIDENT') + '",');
            JSON.Append('"Type":"' + BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'CURRENCYTYPE') + '",');
            JSON.Append('"Station Code":"' + BSC + '",');
         end;
         CashBatchXMLNode := CashBatchXMLNode.FindNextSiblingElement;

         JSONString := JSON.Strings[JSON.Count - 1]; // Sets a string equal to the last string in the JSON StringList
         JSON.Delete(JSON.Count - 1); // Removes the last string in the JSON StringList
         delete(JSONString, length(JSONString), 1); // Deletes the trailing comma in the JSONString
         JSON.Append(JSONString + '},'); // Adds the JSONString to the JSON StringList with a closing curly brace and a comma (in case of more rows being created)
      end;
      
      JSONString := stringreplace(JSON.Text, #13,'',[rfReplaceAll]); // Sets JSONString equal to all of the text in the JSON String list; Replaces all Carriage Return characters with nothing
      JSONString := stringreplace(JSONString, #10,'',[rfReplaceAll]); // Replaces all Line Feed characters with nothing
      delete(JSONString, length(JSONString), 1); // Deletes the trailing comma in the JSONString
      Result := JSONString + ']'; // Sends the complete JSONString back with a closing square bracket

      JSON.Free;
      CashBatchXMLNode.Free;
   end;
end;



function TCustomerInfoModule.CashBatchXMLToHTML(UILinks: Boolean): String;
var
  I : Integer;
  Line : String;
  BatchHTML : TStringList;
  BRNID : String;
  BSC : String;
  BatchHTMLHeader : string;
  CashBatchXMLNode : TOPENXMLNode;
  StoreSystemCodeLabel : string; //2016-8-22 jtm: Feat OT#1082

  TranIdentHeader : string;
  CustIdentHeader : string;
Begin
   Result := '';
   If BatchOXML = NIL then exit;
   I := 1;

   TranIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CASHTRANIDENTDESC', 'Tran Ident')); //2018-4-24 bls: F#3735
   CustIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CASHCUSTIDENTDESC', 'Cust Ident')); //2018-4-24 bls: F#3735

   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL', '') <> '' then StoreSystemCodeLabel := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL'));  //2016-8-08 jtm: Feat OT#1038

   BatchHTML := TStringList.Create;
   BatchHTMLHeader := '<TABLE border="1" cellspacing="0" cellpadding="3"  style="border-collapse: collapse; font-family:veranda">' +
                 '<TR><TD><B>RNID</B></TD>'+
                 '    <TD><B>Tran Date</B></TD>'+
                 '    <TD><B>Tran Type</B></TD>'+
                 '    <TD><B>Amount</B></TD>'+
                 '    <TD><B>Emp Ident</B></TD>'+
                 '    <TD><B>' + TranIdentHeader + '</B></TD>'+
                 '    <TD><B>' + CustIdentHeader + '</B></TD>';

    BatchHTMLHeader := BatchHTMLHeader + '    <TD><B>Station Ident</B></TD>'+
                                        '    <TD><B>Type</B></TD>';

   if (StoreSystemCodeLabel <> '') then begin
      BatchHTMLHeader := BatchHTMLHeader +  '  <TD><B>'+ StoreSystemCodeLabel +'</B></TD>'
   end else begin
      BatchHTMLHeader := BatchHTMLHeader + '  <TD><B>Item Serial</B></TD>';
   end;
   BatchHTMLHeader := BatchHTMLHeader + '</TR>';

   BatchHTML.Add(BatchHTMLHeader);
   CashBatchXMLNode := BatchOXML.GetNode('/TRANRESP/CASHBATCHDETAIL');
   CashBatchXMLNode := CashBatchXMLNode.FindFirstChildElement;

   While (CashBatchXMLNode <> nil) do begin
      Line := '';
      if (CashBatchXMLNode.NodeName = 'CASHDETAIL') then begin //2017-09-06 jtm: D#1885
         BRNID := Trim(BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'PROFILE'));
         BSC := BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'SYSTEMCODE');
         Line := Line + '<TR>' +
                     '<TD>' + BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'PROFILE') + '</TD>' +
                     '<TD>' + BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'TRANDATE') + '</TD>' +
                     '<TD>' + BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'TRANTYPE') + '</TD>' +
                     '<TD>' + DisplayMoney(ValuReal(BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'TRANAMT'))) + '</TD>';

         Line := Line +'<TD>' + BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'EMPIDENT') + '</TD>' +
                     '<TD>' + BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'TRANIDENT') + '</TD>' +
                     '<TD>' + BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'CUSTIDENT') + '</TD>';

         Line := Line + '<TD>' + BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'STATIONIDENT') + '</TD>' +
                        '<TD>' + BatchOXML.GetContextValueAsWideString(CashBatchXMLNode,'CURRENCYTYPE') + '</TD>';  //2016-8-22 jtm: Feat OT#1080

         if (UILinks) then begin
            Line := Line +  '<TD><a href="javascript://" onclick="GetVTCashDetailAJAX(''' + BRNID+ ''','''+ BSC + ''',true)">' + BSC+ '</a></TD>';
         end else begin
         Line := Line +  '<TD>' + BSC + '</TD>';
         end;
         Line := Line +  '</TR>';
         BatchHTML.Add(Line);
         inc(I);
      end;
      CashBatchXMLNode := CashBatchXMLNode.FindNextSiblingElement;
   end;
   BatchHTML.Add('</TABLE>');
   Result := batchHTML.Text;
   BatchHTML.Free;

end;


function TCustomerInfoModule.CheckBatchXMLToHTML(UILinks: Boolean;ARNID: string): String;
var
  I : Integer;
  Line : String;
  BatchHTML : TStringList;
  BRNID : String;
  BSC : String;
  BatchHTMLHeader : string;
  CheckBatchXMLNode : TOPENXMLNode;
  StoreSystemCodeLabel : string; //2016-8-22 jtm: Feat OT#1082
  IncludeRefundData : boolean; //2017-08-16 jtm: F#1833
  Amt : string; //2017-11-16 jtm: F#2047

  TranIdentHeader : string;
  CustIdentHeader : string;

  IncludeStoreName: boolean;
  StoreName: string;
Begin
   Result := '';

   TranIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/TCTRANIDENTDESC', 'Tran Ident')); //2018-4-24 bls: F#3735
   CustIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/TCCUSTIDENTDESC', 'Cust Ident')); //2018-4-24 bls: F#3735

   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL', '') <> '' then StoreSystemCodeLabel := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL'));  //2016-8-22 jtm: Feat OT#1038
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEREFUNDDATA', 'FALSE') = 'TRUE' then IncludeRefundData := true;

   IncludeStoreName := DisplayStoreNameOnOpenCheck;
   if IncludeStoreName then begin
      StoreName := FetchStoreName(ARNID);
   end;
   If BatchOXML = NIL then exit;
   I := 1;

   BatchHTML := TStringList.Create;
   BatchHTMLHeader := '<TABLE border="1" cellspacing="0" cellpadding="3"  style="border-collapse: collapse; font-size:7pt;font-family:veranda"><TR><TD><B>RNID</B></TD>';
   if IncludeStoreName then BatchHTMLHeader := BatchHTMLHeader + '<td><strong>Location</strong></td>';

   BatchHTMLHeader := BatchHTMLHeader + '    <TD><B>Auth Date</B></TD>';
   BatchHTMLHeader := BatchHTMLHeader + '<TD Align="Right"><B>Amount</B></TD>' +
                 '<TD><B>CHK #</B></TD>' +
                 '<TD><B>TCK Response</B></TD>' +
                 '<TD Colspan=2 align="Center"><B>Status</B></TD>' +
                 '<TD><B>' + TranIdentHeader + '</B></TD>'+
                 '<TD><B>' + CustIdentHeader + '</B></TD>'+
                 '<TD><B>Station</B></TD>' +
                 '<TD><B>MID</B></TD>' +
                 '<TD><B>Service</B></TD>';
   if IncludeRefundData then BatchHTMLHeader := BatchHTMLHeader + '<TD><B>Refund Amount</B></TD><TD><B>Last Refund Date</B></TD><TD><B>Refund Count</B></TD>';
   if StoreSystemCodeLabel <> '' then BatchHTMLHeader := BatchHTMLHeader +  '<TD><B>'+ StoreSystemCodeLabel + '</B></TD>'
   else BatchHTMLHeader := BatchHTMLHeader + '<TD><B>Item Serial</B></TD>';

   BatchHTMLHeader := BatchHTMLHeader + '</TR>';
   BatchHTML.Add(BatchHTMLHeader);
   CheckBatchXMLNode := BatchOXML.GetNode('/TRANRESP/TCBATCHDETAIL');
   CheckBatchXMLNode := CheckBatchXMLNode.FindFirstChildElement;

   While (CheckBatchXMLNode <> nil) do begin
      Line := '';
      if (CheckBatchXMLNode.NodeName = 'TCAUTHDETAIL') then begin //2017-09-06 jtm: D#1885
         BRNID := Trim(ARNID);
         BSC := BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'SYSTEMCODE');
         Line := Line + '<TR><TD>' + BRNID + '</TD>';
         if IncludeStoreName then Line := Line + '<TD>' + StoreName + '</TD>';
         Line := Line + '<TD>' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'AUTHDATE') + '</TD>' +
                     '<TD align="Right">';

         if (BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'UPDATEDAMOUNT') <> '') then begin //2017-11-16 jtm: F#2047
            Line := Line + '<IMG SRC="/Images/General/Refresh.gif" border="0">';
            Amt := BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'UPDATEDAMOUNT');
         end else begin
            Amt := BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'TRANAMOUNT');
         end;
         if (BatchOXML.GetContextValueAsBoolean(CheckBatchXMLNode,'VOIDED')) then begin
            Line := Line + '<DEL>Void ' + DisplayMoney(ValuReal(Amt)) + '</DEL></TD>';
         end else begin
            Line := Line + DisplayMoney(ValuReal(Amt)) + '</TD>';
         end;
         Line := Line + '<TD>' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'RESPONSECHECKNUMBER') + '</TD>' +
                     '<TD>' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'DISPLAYTEXT') + '</TD>' +
                     '<TD>' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'ECATRANSTATUS') + '</TD>';

         If BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'ECATRANSTATUS') = '0' then begin
            Line := Line + '<TD align="CENTER"><IMG SRC="/Images/General/CheckSmall.gif" border="0"></TD>';
         end else If BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'ECATRANSTATUS') = '1' then begin
            Line := Line + '<TD align="CENTER"><IMG SRC="/Images/General/BoltSmall.gif" border="0"></TD>';
         end else If BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'ECATRANSTATUS') = '3' then begin
            Line := Line + '<TD align="CENTER"><IMG SRC="/Images/General/XFailed.gif" border="0"></TD>';
          end else If BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'ECATRANSTATUS') = '4' then begin
            Line := Line + '<TD align="CENTER"><IMG SRC="/Images/General/XFailed.gif" border="0"></TD>';
         end else begin
            Line := Line + '<TD align="CENTER"><IMG SRC="/Images/General/ExclamationSmall.gif" border="0"></TD>';
         end;

         Line := Line + '<TD>' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'TRANIDENT') + '</TD>' +
                         '<TD>' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'TRANCUSTOMERCODE') + '</TD>' +
                         '<TD>' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'STATIONIDENT') + '</TD>' +
                         '<TD>' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'TCMID') + '</TD>' +
                         '<TD>' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'TCSERVICENAME') + '</TD>';
         if IncludeRefundData then Line := Line + '<TD>' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'REFUNDAMOUNT') + '</TD>' +
                                      '<TD>' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'REFUNDDATE') + '</TD>' +
                                      '<TD>' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'REFUNDCOUNT') + '</TD>';
         If UILinks then begin
            Line := Line + '<TD><a href="javascript://" onclick="GetVTCheckDetailAJAX(''' + BRNID+ ''','''+ BSC + ''',true)">' + BSC+ '</a></TD>';
         end else begin
            Line := Line + '<TD>' + BSC + '</TD>';
         end;
         Line := Line + '</TR>';
         BatchHTML.Add(Line);
      end;
      CheckBatchXMLNode := CheckBatchXMLNode.FindNextSiblingElement;
      inc(I);
   end;
   BatchHTML.Add('</TABLE>');
   Result := batchHTML.Text;
   FreeAndNil(BatchHTML);
   FreeAndNil(CheckBatchXMLNode);
end;

function TCustomerInfoModule.CheckBatchXMLToXLS(ARNID : string;
                                                xExport : TOExport;
                                                DisplayFormat : String): String;
var
  BRNID : String;
  BSC : String;
  BatchXLSHeader : string;
  CheckBatchXMLNode : TOPENXMLNode;
  IncludeEmpIdent : boolean;
  StoreSystemCodeLabel : string; //2016-8-22 jtm: Feat OT#1082
  Amt : string; //2017-11-16 jtm: D#2047
  ShowVoidAsZero : boolean;

  xlsWorkSheet : TExportWorksheet; //Represents actual xls worksheet
  Row : TExportRow; //Represents actual row inside the TExportWorksheet
  iterator : integer;
  JSON : TStringList;
  JSONString : string;

  TranIdentHeader: string; //2018-4-24 bls: F#3735
  CustIdentHeader: string; //2018-4-24 bls: F#3735

  IncludeStoreName: boolean;
  StoreName: string;
Begin
   Result := '';
   If BatchOXML = NIL then exit;
   IncludeEmpIdent := false;
   ShowVoidAsZero := false;
   TranIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/TCTRANIDENTDESC', 'Tran Ident')); //2018-4-24 bls: F#3735
   CustIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/TCCUSTIDENTDESC', 'Cust Ident')); //2018-4-24 bls: F#3735

   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEEMPIDENT', 'FALSE') = 'TRUE' then IncludeEmpIdent := true;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL', '') <> '' then StoreSystemCodeLabel := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL'));  //2016-8-22 jtm: Feat OT#1038
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SHOWCHECKVOIDASZERO', 'FALSE') = 'TRUE' then ShowVoidAsZero := true;
   IncludeStoreName := DisplayStoreNameOnOpenCheck;

   if IncludeStoreName then begin
      StoreName := FetchStoreName(ARNID);
   end;

   if DisplayFormat = 'XLS' then begin
      xlsWorkSheet := xExport.AddWorkSheet;
      Row := xlsWorkSheet.AddRow;

      Row.AddCellString('RNID');
      if IncludeStoreName then Row.AddCellString('Location');
      Row.AddCellString('Auth Date');
      Row.AddCellString('Amount');
      Row.AddCellString('CHK #');
      Row.AddCellString('TCK Response');
      Row.AddCellString('Status');
      Row.AddCellString(TranIdentHeader); //2018-4-24 bls: F#3735
      Row.AddCellString(CustIdentHeader); //2018-4-24 bls: F#3735
      Row.AddCellString('Station');
      Row.AddCellString('MID');
      Row.AddCellString('Service');

      if IncludeEmpIdent then Row.AddCellString('Emp Ident');
      if StoreSystemCodeLabel <> '' then begin
         Row.AddCellString(StoreSystemCodeLabel);
      end else begin
         Row.AddCellString('Station Code');
      end;

      For iterator := 0 to Row.Cells.Count - 1 do begin
         Row.Cells.Items[iterator].SetFontColor(clBlack).SetBorder(cbBottom).SetBGColor(TColor($80000000)).SetAlignment(cahCenter);
      end;

      CheckBatchXMLNode := BatchOXML.GetNode('/TRANRESP/TCBATCHDETAIL');
      CheckBatchXMLNode := CheckBatchXMLNode.FindFirstChildElement;

      While (CheckBatchXMLNode <> nil) do begin
         if (CheckBatchXMLNode.NodeName = 'TCAUTHDETAIL') then begin //2017-09-06 jtm: D#1885
            Row := xlsWorkSheet.AddRow;
            BRNID := Trim(ARNID);
            BSC := BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'SYSTEMCODE');

            Row.AddCellString(BRNID);
            if IncludeStoreName then Row.AddCellString(StoreName);
            Row.AddCellString(BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'AUTHDATE'));

            if (BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'UPDATEDAMOUNT') <> '') then begin //2017-11-16 jtm: D#2047
               Amt := BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'UPDATEDAMOUNT');
            end else begin
               Amt := BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'TRANAMOUNT');
            end;
            if (ShowVoidAsZero and BatchOXML.GetContextValueAsBoolean(CheckBatchXMLNode,'VOIDED')) then begin
               Row.AddCellString(DisplayMoney(0));
            end else begin
               Row.AddCellString(DisplayMoney(ValuReal(Amt)));
            end;

            Row.AddCellString(BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'RESPONSECHECKNUMBER'));
            Row.AddCellString(BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'DISPLAYTEXT'));
            Row.AddCellString(BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'ECATRANSTATUS'));
            Row.AddCellString(BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'TRANIDENT'));
            Row.AddCellString(BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'TRANCUSTOMERCODE'));
            Row.AddCellString(BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'STATIONIDENT'));
            Row.AddCellString(BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'TCMID'));
            Row.AddCellString(BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'TCSERVICENAME'));

            if IncludeEmpIdent then Row.AddCellString(BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'TRANEMPLOYEEIDENT'));
            Row.AddCellString(BSC);
         end;
         CheckBatchXMLNode := CheckBatchXMLNode.FindNextSiblingElement;
      end;
      Result := '';
      CheckBatchXMLNode.Free;

   end else if DisplayFormat = 'JSON' then begin
      JSON := TStringList.Create;
      JSON.Append('[');

      CheckBatchXMLNode := BatchOXML.GetNode('/TRANRESP/TCBATCHDETAIL');
      CheckBatchXMLNode := CheckBatchXMLNode.FindFirstChildElement;
      
      While (CheckBatchXMLNode <> nil) do begin
         if (CheckBatchXMLNode.NodeName = 'TCAUTHDETAIL') then begin
            BRNID := Trim(ARNID);
            BSC := BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'SYSTEMCODE');

            JSON.Append('{"RNID":"' + BRNID + '",');
            if IncludeStoreName then JSON.Add('"Location":"' + StoreName + '",');
            JSON.Append('"Auth Date":"' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode, 'AUTHDATE') + '",');

            if (BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'UPDATEDAMOUNT') <> '') then begin
               Amt := BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode, 'UPDATEDAMOUNT');
            end else begin
               Amt := BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode, 'TRANAMOUNT');
            end;
            if (ShowVoidAsZero and BatchOXML.GetContextValueAsBoolean(CheckBatchXMLNode,'VOIDED')) then begin
               JSON.Append('"Amount":"' + DisplayMoney(0) + '",');
            end else begin
               JSON.Append('"Amount":"' + DisplayMoney(ValuReal(Amt)) + '",');
            end;
            JSON.Append('"CHK #":"' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'RESPONSECHECKNUMBER') + '",');
            JSON.Append('"TCK Response":"' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'DISPLAYTEXT') + '",');
            JSON.Append('"Status":"' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'ECATRANSTATUS') + '",');
            JSON.Append('"'+ TranIdentHeader +'":"' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'TRANIDENT') + '",');  //2018-4-24 bls: F#3735
            JSON.Append('"'+ CustIdentHeader +'":"' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'TRANCUSTOMERCODE') + '",'); //2018-4-24 bls: F#3735
            JSON.Append('"Station":"' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'STATIONIDENT') + '",');
            JSON.Append('"MID":"' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'TCMID') + '",');
            JSON.Append('"Service":"' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'TCSERVICENAME') + '",');

            if IncludeEmpIdent then JSON.Append('"Emp Ident":"' + BatchOXML.GetContextValueAsWideString(CheckBatchXMLNode,'TRANEMPLOYEEIDENT') + '",');
            if StoreSystemCodeLabel <> '' then begin
               JSON.Append('"' + StoreSystemCodeLabel + '":"' + BSC + '",');
            end else begin
               JSON.Append('"Station Code":"' + BSC + '",');
            end;
         end;
         CheckBatchXMLNode := CheckBatchXMLNode.FindNextSiblingElement;
         JSONString := JSON.Strings[JSON.Count - 1]; // Sets a string equal to the last string in the JSON StringList
         JSON.Delete(JSON.Count - 1); // Removes the last string in the JSON StringList
         delete(JSONString, length(JSONString), 1); // Deletes the trailing comma in the JSONString
         JSON.Append(JSONString + '},'); // Adds the JSONString to the JSON StringList with a closing curly brace and a comma (in case of more rows being created)
      end;

      JSONString := stringreplace(JSON.Text, #13,'',[rfReplaceAll]); // Sets JSONString equal to all of the text in the JSON String list; Replaces all Carriage Return characters with nothing
      JSONString := stringreplace(JSONString, #10,'',[rfReplaceAll]); // Replaces all Line Feed characters with nothing
      delete(JSONString, length(JSONString), 1); // Deletes the trailing comma in the JSONString
      Result := JSONString + ']'; // Sends the complete JSONString back with a closing square bracket

      JSON.Free;
      CheckBatchXMLNode.Free;
   end;
end;

function TCustomerInfoModule.BatchXMLToXLS(xExport : TOExport; DisplayFormat : String; LocationRNID: String): String;
var
  BRNID : String;
  BSC : String;
  IncludeEmpIdent : boolean;   //2016-3-28 jtm
  IncludeServiceName : boolean;  //2016-5-25 jtm
  IncludeServiceNameDesc : boolean; //2018-01-25 ajs: F#2378
  Index : Integer; //2018-01-25 ajs: F#2378
  IncludeCardHolderName : boolean;
  IncludeSFINDICATOR : boolean;
  IncludeCVVResp : boolean; //2018-3-14 ajs: F#3629
  IncludeAVSResp : boolean; //2018-3-14 ajs: F#3629
  IncludeAVSData : boolean; // 2019-06-15 tjr: DVST-564
  AVSDataHeader : string;  // 2019-06-15 tjr: DVST-564
  BatchXLSHeader : string;
  BatchXMLNode : TOPENXMLNode;
  StoreSystemCodeLabel : string; //2016-8-22 jtm: Feat OT#1082
  MaskAcct : string;  //2017-03-22 jtm: Feat OT#1289
  SearchOnServiceName : boolean;//2017-05-10 jtm: F#1565
  ServNameList : TStringList; //2017-09-20 jtm: D#1946
  ServNameDescList : TStringList; //2018-01-25 ajs: F#2378
  ServiceNamesByRNID : integer;//2017-09-20 jtm: D#1946s
  CardAcct : string;
  ProcessorToken : string;

  xlsWorkSheet : TExportWorksheet; //Represents actual xls worksheet
  Row : TExportRow; //Represents actual row inside the TExportWorksheet
  iterator : integer;
  JSON : TStringList;
  JSONString : string;

  TranIdentHeader: string; //2018-4-24 bls: F#3735
  CustIdentHeader: string; //2018-4-24 bls: F#3735

  IncludeStoreName: boolean;
  StoreName: String;
Begin
   Result := '';
   IncludeEmpIdent := false;
   IncludeServiceName := false;
   IncludeCardHolderName := false;
   IncludeSFINDICATOR := false;
   IncludeCVVResp := false; //2018-3-14 ajs: F#3629
   IncludeAVSResp := false; //2018-3-14 ajs: F#3629
   IncludeAVSData := false;  // 2019-06-15 tjr: DVST-564
   SearchOnServiceName := false;
   ServNameList := TStringList.Create;  //2018-01-29 jtm: D#3702
   ServNameDescList := TStringList.Create;

   TranIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CCTRANIDENTDESC', 'Tran Ident')); //2018-4-24 bls: F#3735
   CustIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CCCUSTIDENTDESC', 'Cust Ident')); //2018-4-24 bls: F#3735

   If BatchOXML = NIL then exit;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEEMPIDENT', 'FALSE') = 'TRUE' then IncludeEmpIdent := true;  //2016-3-28 jtm
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESERVICENAME', 'FALSE') = 'TRUE' then IncludeServiceName := true;  //2016-5-25 jtm
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDECARDHOLDERNAME', 'FALSE') = 'TRUE' then IncludeCardHolderName := true;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL', '') <> '' then StoreSystemCodeLabel := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL'));  //2016-8-22 jtm: Feat OT#1038
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHONSERVICENAME', 'FALSE') = 'TRUE') and (VarEvaluator.GetValueAsString('ServiceName') <> 'ALL') then SearchOnServiceName := true; //2017-05-10 jtm: F#1565
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESFINDICATOR', 'FALSE') = 'TRUE' then IncludeSFINDICATOR := true;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESERVICENAMEDESCRIPTION', 'FALSE') = 'TRUE' then IncludeServiceNameDesc := true;  //2018-01-25 ajs: F#2378
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDECVVRESP', 'FALSE') = 'TRUE' then IncludeCVVResp := true; //2018-3-14 ajs: F#3629
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEAVSRESP', 'FALSE') = 'TRUE' then IncludeAVSResp := true; //2018-3-14 ajs: F#3629
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEAVSDATA', 'FALSE') = 'TRUE' then IncludeAVSData := true;  // 2019-06-15 tjr: DVST-564
   AVSDataHeader := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/AVSDATAHEADER', 'AVSDATA');  // 2019-06-15 tjr: DVST-564

   IncludeStoreName := DisplayStoreNameOnOpenCard;

   if IncludeStoreName then begin
      StoreName := FetchStoreName(LocationRNID);
   end;

   if DisplayFormat = 'XLS' then begin
      xlsWorkSheet := xExport.AddWorkSheet;
      Row := xlsWorkSheet.AddRow;
      Row.AddCellString('RNID');
      if IncludeStoreName then Row.AddCellString('Location');
      Row.AddCellString('Auth Date');
      Row.AddCellString('Entry');
      Row.AddCellString('Type');
      Row.AddCellString('Amount');
      Row.AddCellString('Auth Code');
      Row.AddCellString('Card Acct');
      Row.AddCellString('Card Type');
      Row.AddCellString(TranIdentHeader); //2018-4-24 bls: F#3735
      Row.AddCellString(CustIdentHeader); //2018-4-24 bls: F#3735

      if IncludeEmpIdent then Row.AddCellString('Emp Ident');
      if IncludeServiceName then Row.AddCellString('Service Name');
      if IncludeCardHolderName then Row.AddCellString('Card Name');
      if IncludeSFINDICATOR then Row.AddCellString('SF');
      if IncludeCVVResp then Row.AddCellString('CVVRESP'); //2018-3-14 ajs: F#3629
      if IncludeAVSResp then Row.AddCellString('AVSRESP'); //2018-3-14 ajs: F#3629
      if IncludeAVSData then Row.AddCellString(AVSDataHeader); // 2019-06-15 tjr: DVST-564

      Row.AddCellString('Station');

      if StoreSystemCodeLabel <> '' then begin
         Row.AddCellString(StoreSystemCodeLabel);
      end else begin
         Row.AddCellString('Station Code');
      end;

      For iterator := 0 to Row.Cells.Count - 1 do begin
         Row.Cells.Items[iterator].SetFontColor(clBlack).SetBorder(cbBottom).SetBGColor(TColor($80000000)).SetAlignment(cahCenter);
      end;

      BatchXMLNode := BatchOXML.GetNode('/TRANRESP/CCBATCHDETAIL');
      BatchXMLNode := BatchXMLNode.FindFirstChildElement;

      While (BatchXMLNode <> nil) do begin
         if (BatchXMLNode.NodeName = 'CCAUTHDETAIL') then begin
            BRNID := Trim(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'PROFILE'));
            BSC := BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SYSTEMCODE');
            if (IncludeServiceName) or (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHONSERVICENAME', 'FALSE') = 'TRUE') then begin  //2018-01-29 jtm: D#3693
               ServiceNamesByRNID := GetServiceNamesByRNID(BRNID,'',ServNameList,ServNameDescList);
            end;
            Row := xlsWorkSheet.AddRow;
            if SearchOnServiceName then begin
               if (BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CCSERVICENAME') <> VarEvaluator.GetValueAsString('ServiceName')) then begin
                  BatchXMLNode := BatchXMLNode.FindNextSiblingElement;
                  Continue;
               end;
            end else if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHONSERVICENAME', 'FALSE') = 'TRUE') and (VarEvaluator.GetValueAsString('ServiceName') = 'ALL') then begin
               if (ServiceNamesByRNID <> GetUserServNameAccessByRNID(ServNameList,BRNID,(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/NOREADONLYLOCATIONS','FALSE') = 'TRUE'),ServiceNamesByRNID)) then begin
                  if (ServNameList.IndexOf(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CCSERVICENAME')) < 0) then begin
                     BatchXMLNode := BatchXMLNode.FindNextSiblingElement;
                     Continue;
                  end;
               end;
            end;

            Row.AddCellString(BRNID);
            if IncludeStoreName then Row.AddCellString(StoreName);
            Row.AddCellString(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANDATE'));
            Row.AddCellString(GetCCTranEntryModeDisplayCode(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANENTRYMODE')));
            Row.AddCellString(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SALETYPE'));

            If (BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SALETYPE') = 'CREDIT') or (BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SALETYPE') = 'REFUND') or (BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SALETYPE') = 'CRVOID') then begin
               Row.AddCellString('-' + DisplayMoney(ValuReal(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANAMT'))));
            end else begin
               Row.AddCellString(DisplayMoney(ValuReal(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANAMT'))));
            end;
            Row.AddCellString(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'AUTHCODE'));

            CardAcct := trim(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CARDACCT'));
            ProcessorToken := trim(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'PROCESSORTOKEN'));
            MaskAcct := '';
            if (CardAcct <> '') then begin  //2017-12-20 jtm: F#2430
               if (ProcessorToken <> '') then begin  //card number sent in, but either tokenized or not
                  MaskAcct := MaskStr(ProcessorToken,DigitsToMask(ProcessorToken));
                  MaskAcct := '*..*' + NumericOnly(MaskAcct);
               end else begin
                  MaskAcct := CardAcct;
                  MaskAcct := 'X..X' + NumericOnly(MaskAcct);
               end;
            end else if (CardAcct = '')  and (ProcessorToken <> '') then begin //token passed directly
               MaskAcct := MaskStr(ProcessorToken,DigitsToMask(ProcessorToken));
               MaskAcct := '#..#' + NumericOnly(MaskAcct);
            end;
            Row.AddCellString(MaskAcct);
            Row.AddCellString(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CARDTYPE'));
            Row.AddCellString(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANIDENT'));
            Row.AddCellString(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANCUSTOMERCODE'));

            if IncludeEmpIdent then Row.AddCellString(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANEMPLOYEEIDENT'));
            if IncludeServiceName then begin //2018-01-25 ajs: F#2378
               If IncludeServiceNameDesc then begin
                  Index := ServNameList.IndexOf(Trim(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CCSERVICENAME')));
                  if (Index = -1) then begin
                     Row.AddCellString(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CCSERVICENAME'));
                  end else begin
                     Row.AddCellString(ServNameDescList[Index]);
                  end;
               end else begin
                  Row.AddCellString(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CCSERVICENAME'));
               end;
            end;

            if IncludeCardHolderName then Row.AddCellString(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CARDNAME'));
            if IncludeSFINDICATOR then begin
            if (BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SFTRANGUID') <> '') then begin
               Row.AddCellString(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SFTRANGUID'));
            end else begin
                  Row.AddCellString(' ');
               end;
            end;
            if IncludeCVVResp then Row.AddCellString(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CVVRESP')); //2018-3-14 ajs: F#3629
            if IncludeAVSResp then Row.AddCellString(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'AVSRESP')); //2018-3-14 ajs: F#3629
            if IncludeAVSData then Row.AddCellString(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'AVSDATA'));  // 2019-06-15 tjr: DVST-564
            Row.AddCellString(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'STATIONIDENT'));
            Row.AddCellString(BSC);
         end;
         BatchXMLNode := BatchXMLNode.FindNextSiblingElement;
      end;
      Result := '';
      BatchXMLNode.Free;
   end else if DisplayFormat = 'JSON' then begin
      JSON := TStringList.Create;
      JSON.Append('[');

      BatchXMLNode := BatchOXML.GetNode('/TRANRESP/CCBATCHDETAIL');
      BatchXMLNode := BatchXMLNode.FindFirstChildElement;
      While (BatchXMLNode <> nil) do begin
         if (BatchXMLNode.NodeName = 'CCAUTHDETAIL') then begin
            if SearchOnServiceName then begin
               if (BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CCSERVICENAME') <> VarEvaluator.GetValueAsString('ServiceName')) then begin
                  BatchXMLNode := BatchXMLNode.FindNextSiblingElement;
                  Continue;
               end;
            end else if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHONSERVICENAME', 'FALSE') = 'TRUE') and (VarEvaluator.GetValueAsString('ServiceName') = 'ALL') then begin
               if (ServiceNamesByRNID <> GetUserServNameAccessByRNID(ServNameList,BRNID,(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/NOREADONLYLOCATIONS','FALSE') = 'TRUE'),ServiceNamesByRNID)) then begin
                  if (ServNameList.IndexOf(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CCSERVICENAME')) < 0) then begin
                     BatchXMLNode := BatchXMLNode.FindNextSiblingElement;
                     Continue;
                  end;
               end;
            end;
            BRNID := Trim(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'PROFILE'));
            BSC := BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SYSTEMCODE');

            JSON.Append('{"RNID":"' + BRNID + '",');
            if IncludeStoreName then JSON.Add('"Location":"' + StoreName + '",');
            JSON.Append('"Auth Date":"' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANDATE') + '",');
            JSON.Append('"Entry":"' + GetCCTranEntryModeDisplayCode(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANENTRYMODE')) + '",');
            JSON.Append('"Type":"' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SALETYPE') + '",');


            If (BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SALETYPE') = 'CREDIT') or (BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SALETYPE') = 'REFUND') or (BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SALETYPE') = 'CRVOID') then begin
               JSON.Append('"Amount":"' + '-' + DisplayMoney(ValuReal(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANAMT'))) + '",');
            end else begin
               JSON.Append('"Amount":"' + DisplayMoney(ValuReal(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANAMT'))) + '",');
            end;

            JSON.Append('"Auth Code":"' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'AUTHCODE') + '",');
            CardAcct := trim(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CARDACCT'));
            ProcessorToken := trim(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'PROCESSORTOKEN'));
            MaskAcct := '';
            if (CardAcct <> '') then begin
               if (ProcessorToken <> '') then begin  //card number sent in, but either tokenized or not
                  MaskAcct := MaskStr(ProcessorToken,DigitsToMask(ProcessorToken));
                  MaskAcct := '*..*' + NumericOnly(MaskAcct);
               end else begin
                  MaskAcct := CardAcct;
                  MaskAcct := 'X..X' + NumericOnly(MaskAcct);
               end;
            end else if (CardAcct = '')  and (ProcessorToken <> '') then begin //token passed directly
               MaskAcct := MaskStr(ProcessorToken,DigitsToMask(ProcessorToken));
               MaskAcct := '#..#' + NumericOnly(MaskAcct);
            end;
            JSON.Append('"Card Acct":"' + MaskAcct + '",');


            JSON.Append('"Card Type":"' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CARDTYPE') + '",');
            JSON.Append('"'+ TranIdentHeader +'":"' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANIDENT') + '",'); //2018-4-24 bls: F#3735
            JSON.Append('"'+ CustIdentHeader +'":"' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANCUSTOMERCODE') + '",'); //2018-4-24 bls: F#3735
         
            if IncludeEmpIdent then JSON.Append('"Emp Ident":"' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANEMPLOYEEIDENT') + '",');
            if IncludeServiceName then JSON.Append('"Service Name":"' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CCSERVICENAME') + '",');
            if IncludeCardHolderName then JSON.Append('"Card Name":"' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CARDNAME') + '",');
            if IncludeSFINDICATOR then begin
               if (BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SFTRANGUID') <> '') then begin
                  JSON.Append('"SF":"' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SFTRANGUID') + '",');
               end else begin
                  JSON.Append('"SF":"' + ' ' + '",');
               end;
            end;
            if IncludeCVVResp then JSON.Append('"CVV Response":"' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CVVRESP') + '",');
            if IncludeAVSResp then JSON.Append('"AVS Response":"' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'AVSRESP') + '",');
            if IncludeAVSData then JSON.Append('"' + AVSDataHeader + '":"' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'AVSDATA') + '",'); // 2019-06-15 tjr: DVST-564

            JSON.Append('"Station":"' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'STATIONIDENT') + '",');
            JSON.Append('"Station Code":"' + BSC + '",');
         end;
         BatchXMLNode := BatchXMLNode.FindNextSiblingElement;

         JSONString := JSON.Strings[JSON.Count - 1]; // Sets a string equal to the last string in the JSON StringList
         JSON.Delete(JSON.Count - 1); // Removes the last string in the JSON StringList
         delete(JSONString, length(JSONString), 1); // Deletes the trailing comma in the JSONString
         JSON.Append(JSONString + '},'); // Adds the JSONString to the JSON StringList with a closing curly brace and a comma (in case of more rows being created)
      end;
      JSONString := stringreplace(JSON.Text, #13,'',[rfReplaceAll]); // Sets JSONString equal to all of the text in the JSON String list; Replaces all Carriage Return characters with nothing
      JSONString := stringreplace(JSONString, #10,'',[rfReplaceAll]); // Replaces all Line Feed characters with nothing
      delete(JSONString, length(JSONString), 1); // Deletes the trailing comma in the JSONString
      Result := JSONString + ']'; // Sends the complete JSONString back with a closing square bracket

      JSON.Free;
      BatchXMLNode.Free;
   end;
   ServNameList.Free;
   ServNameDescList.Free;
end;



function TCustomerInfoModule.BatchXMLToHTML(UILinks: Boolean; LocationRNID: String): String;
var
  I : Integer;
  Line : String;
  BatchHTML : TStringList;
  BRNID : String;
  BSC : String;
  IncludeEmpIdent : boolean;   //2016-3-28 jtm
  IncludeServiceName : boolean;  //2016-5-25 jtm
  IncludeServiceNameDesc : boolean; //2018-01-25 ajs: F#2378
  Index : Integer; //2018-01-25 ajs: F#2378
  IncludeCardHolderName : boolean;
  IncludeSFINDICATOR : boolean;
  IncludeCVVResp : boolean; //2018-3-14 ajs: F#3629
  IncludeAVSResp : boolean; //2018-3-14 ajs: F#3629
  IncludeAVSData : boolean;  // 2019-06-15 tjr: DVST-564
  AVSDataHeader : string;  // 2019-06-15 tjr: DVST-564
  BatchHTMLHeader : string;
  BatchXMLNode : TOPENXMLNode;
  StoreSystemCodeLabel : string; //2016-8-22 jtm: Feat OT#1082
  MaskAcct : string;  //2017-03-22 jtm: Feat OT#1289
  SearchOnServiceName : boolean;  //2017-05-10 jtm: F#1565
  ServNameList : TStringList; //2017-09-20 jtm: D#1946
  ServNameDescList : TStringList;
  ServiceNamesByRNID : integer;//2017-09-20 jtm: D#1946
  CardAcct : string; //2017-12-20 jtm: F#2430
  ProcessorToken : string;
  ServiceNameSearchedOn : boolean; //2018-05-16 ajs: D#4493
  
  SaleVisaMC : Integer;
  SaleAMEX : Integer;
  SaleDISC : Integer;
  SaleQVisaMC : Integer;
  SaleQAMEX : Integer;
  SaleQDISC : Integer;
  SaleOTHR : Integer;
  SaleQOTHR : Integer;

  CreditVisaMC : Integer;
  CreditAMEX : Integer;
  CreditDISC : Integer;
  CreditQVisaMC : Integer;
  CreditQAMEX : Integer;
  CreditQDISC : Integer;
  CreditOTHR : Integer;
  CreditQOTHR : Integer;

  VoidVisaMC : Integer;
  VoidAMEX : Integer;
  VoidDISC : Integer;
  VoidQVisaMC : Integer;
  VoidQAMEX : Integer;
  VoidQDISC : Integer;
  VoidOTHR : Integer;
  VoidQOTHR : Integer;

  CRVoidVisaMC : Integer;
  CRVoidAMEX : Integer;
  CRVoidDISC : Integer;
  CRVoidQVisaMC : Integer;
  CRVoidQAMEX : Integer;
  CRVoidQDISC : Integer;
  CRVoidOTHR : Integer;
  CRVoidQOTHR : Integer;

  WI : Integer;

  TranIdentHeader : string;
  CustIdentHeader : string;

  IncludeStoreName: boolean;
  StoreName: string;

  Procedure AddAmt(Var VisaMCInt : integer; Var AmexInt : integer; Var DiscInt : integer; Var OthrInt : integer;
                    Var VisaMCQInt : integer; Var AmexQInt : integer; Var DiscQInt : integer; Var OthrQInt : integer);
  Begin
     WI := Round(StrToFloat(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANAMT')) *100);

     If (Trim(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CARDTYPE')) = 'VISA') or
        (Trim(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CARDTYPE')) = 'MC') then begin
        VisaMCInt := VISAMCInt + WI;
        Inc(VisaMCQInt);
     end else If (Trim(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CARDTYPE')) = 'AMEX') then begin
        AmexInt := AmexInt + WI;                                                                                                                            
        Inc(AmexQInt);
     end else If (Trim(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CARDTYPE')) = 'DISC') then begin
        DiscInt := DiscInt + WI;
        Inc(DiscQInt);
     end else if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEOTHERCARDTYPE', 'FALSE') = 'TRUE') then begin
        OthrInt := OthrInt + WI;
        Inc(OthrQInt);
     end;
  end;

  Procedure ProcessFooter;
  Begin
      processlog(ltInfo, 'BatchXMLToHTML ProcessFooter', 'Start');
         BatchHTML.Add('<BR><BR>' +
                  '<TABLE border="1" cellspacing="0" cellpadding="3" bordercolorlight="#0000FF" style="border-collapse: collapse">'+
                  '<TR><TD ALIGN=''CENTER''><B>TOTALS</B></TD>'+
                  '    <TD ALIGN=''CENTER'' colspan=2><B>VISA/MC</B></TD>'+
                  '    <TD ALIGN=''CENTER'' colspan=2><B>AMEX</B></TD>'+
                  '    <TD ALIGN=''CENTER'' colspan=2><B>DISC</B></TD>');
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEOTHERCARDTYPE', 'FALSE') = 'TRUE') then begin
            BatchHTML.Add('    <TD ALIGN=''CENTER'' colspan=2><B>OTHER</B></TD>');
         end;
         BatchHTML.Add('    <TD ALIGN=''CENTER'' colspan=2><B>All Cards</B></TD>'+
                  '</TR>'+
                  '<TR><TD><B><IMG SRC="/Images/General/CheckSuccess.gif" border="0"> Sale</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[SaleQVisaMC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[SaleVisaMC/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[SaleQAMEX])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[SaleAMEX/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[SaleQDISC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[SaleDISC/100])+'</TD>');

         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEOTHERCARDTYPE', 'FALSE') = 'TRUE') then begin
            BatchHTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[SaleQOthr])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[SaleOthr/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[SaleQVisaMC + SaleQAMEX+SaleQDISC+SaleQOthr])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[(SaleVisaMC + SaleAMEX +SaleDISC+SaleOthr)/100])+'</TD>');
         end else begin
            BatchHTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[SaleQVisaMC + SaleQAMEX+SaleQDISC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[(SaleVisaMC + SaleAMEX +SaleDISC)/100])+'</TD>');
         end;

         BatchHTML.Add('</TR>'+
                  '<TR><TD><B><IMG SRC="/Images/General/CashSmall.gif" border="0"> Credit</B></TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[CreditQVisaMC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[CreditVisaMC/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[CreditQAMEX])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[CreditAMEX/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[CreditQDISC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[CreditDISC/100])+'</TD>');
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEOTHERCARDTYPE', 'FALSE') = 'TRUE') then begin
            BatchHTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[CreditQOthr])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[CreditOthr/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[CreditQVisaMC + CreditQAMEX+CreditQDISC+CreditQOthr])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[(CreditVisaMC + CreditAMEX +CreditDISC+CreditOthr)/100])+'</TD>' +
                  '</TR>'+
                  '<TR><TD><B><IMG SRC="/Images/General/CashSmall.gif" border="0"> NET</B></TD>'+
                  '    <TD colspan="8"></TD>'+ //spacer
                  '    <TD align=''RIGHT''>'+ Format('%d',[SaleQVisaMC + SaleQAMEX+SaleQDISC +SaleQOthr+ CreditQVisaMC + CreditQAMEX+CreditQDISC+CreditQOthr])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[((SaleVisaMC + SaleAMEX +SaleDISC+SaleOthr) - (CreditVisaMC + CreditAMEX +CreditDISC+CreditOthr))/100])+'</TD>'+

                  '</TR>');
         end else begin
            BatchHTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[CreditQVisaMC + CreditQAMEX+CreditQDISC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[(CreditVisaMC + CreditAMEX +CreditDISC)/100])+'</TD>'+
                  '</TR>'+
                  '<TR><TD><B><IMG SRC="/Images/General/CashSmall.gif" border="0"> NET</B></TD>'+
                  '    <TD colspan="6"></TD>'+ //spacer
                  '    <TD align=''RIGHT''>'+ Format('%d',[SaleQVisaMC + SaleQAMEX+SaleQDISC + CreditQVisaMC + CreditQAMEX+CreditQDISC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[((SaleVisaMC + SaleAMEX +SaleDISC) - (CreditVisaMC + CreditAMEX +CreditDISC))/100])+'</TD>'+
                  '</TR>');
         end;
         BatchHTML.Add('<TR><TD><B><IMG SRC="/Images/General/YellowExclamation.gif" border="0"> Voids</B></TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[VoidQVisaMC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[VoidVisaMC/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[VoidQAMEX])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[VoidAMEX/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[VoidQDISC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[VoidDISC/100])+'</TD>');
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEOTHERCARDTYPE', 'FALSE') = 'TRUE') then begin
            BatchHTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[VoidQOthr])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[VoidOthr/100])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%d',[VoidQVisaMC + VoidQAMEX+VoidQDISC+VoidQOthr])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[(VoidVisaMC + VoidAMEX +VoidDISC+VoidOthr)/100])+'</TD>');
         end else begin
            BatchHTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[VoidQVisaMC + VoidQAMEX+VoidQDISC])+'</TD>'+
                  '    <TD align=''RIGHT''>'+ Format('%m',[(VoidVisaMC + VoidAMEX +VoidDISC)/100])+'</TD>');
         end;

         if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDECREDITVOIDROW', 'FALSE')) then begin
            BatchHTML.Add('<TR><TD><B><IMG SRC="/Images/General/YellowExclamation.gif" border="0"> Credit Voids</B></TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%d',[CRVoidQVisaMC])+'</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%m',[CRVoidVisaMC/100])+'</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%d',[CRVoidQAMEX])+'</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%m',[CRVoidAMEX/100])+'</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%d',[CRVoidQDISC])+'</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%m',[CRVoidDISC/100])+'</TD>');
            if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEOTHERCARDTYPE', 'FALSE') = 'TRUE') then begin
               BatchHTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[CRVoidQOthr])+'</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%m',[CRVoidOthr/100])+'</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%d',[CRVoidQVisaMC + CRVoidQAMEX+CRVoidQDISC+CRVoidQOthr])+'</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%m',[(CRVoidVisaMC + CRVoidAMEX +CRVoidDISC+CRVoidOthr)/100])+'</TD>');
            end else begin
               BatchHTML.Add('    <TD align=''RIGHT''>'+ Format('%d',[CRVoidQVisaMC + CRVoidQAMEX+CRVoidQDISC])+'</TD>'+
                     '    <TD align=''RIGHT''>'+ Format('%m',[(CRVoidVisaMC + CRVoidAMEX +CRVoidDISC)/100])+'</TD>');
            end;
         end;

         BatchHTML.Add('</TR>'+
                  '</TABLE><BR>');
   end;
Begin
   Result := '';
   IncludeEmpIdent := false;
   IncludeServiceName := false;
   IncludeCardHolderName := false;
   IncludeSFINDICATOR := false;
   IncludeCVVResp := false; //2018-3-14 ajs: F#3629
   IncludeAVSResp := false; //2018-3-14 ajs: F#3629
   IncludeAVSData := false; // 2019-06-15 tjr: DVST-564
   SearchOnServiceName := false;
   ServNameList := TStringList.Create;
   ServNameDescList := TStringList.Create;
   ServiceNameSearchedOn := false; //2018-05-16 ajs: D#4493

   SaleVisaMC := 0;
   SaleAMEX := 0;
   SaleDISC := 0;
   SaleQVisaMC := 0;
   SaleQAMEX := 0;
   SaleQDISC := 0;
   SaleOTHR := 0;
   SaleQOTHR := 0;

   CreditVisaMC  := 0;
   CreditAMEX := 0;
   CreditDISC := 0;
   CreditQVisaMC := 0;
   CreditQAMEX := 0;
   CreditQDISC := 0;
   CreditOTHR := 0;
   CreditQOTHR := 0;

   VoidVisaMC := 0;
   VoidAMEX := 0;
   VoidDISC := 0;
   VoidQVisaMC := 0;
   VoidQAMEX := 0;
   VoidQDISC := 0;
   VoidOTHR := 0;
   VoidQOTHR := 0;

   CRVoidVisaMC := 0;
   CRVoidAMEX := 0;
   CRVoidDISC := 0;
   CRVoidQVisaMC := 0;
   CRVoidQAMEX := 0;
   CRVoidQDISC := 0;
   CRVoidOTHR := 0;
   CRVoidQOTHR := 0;

   If BatchOXML = NIL then exit;
   I := 0;
   Index := 0;

   TranIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CCTRANIDENTDESC', 'Tran Ident')); //2018-4-24 bls: F#3735
   CustIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CCCUSTIDENTDESC', 'Cust Ident')); //2018-4-24 bls: F#3735

   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEEMPIDENT', 'FALSE') = 'TRUE' then IncludeEmpIdent := true;  //2016-3-28 jtm
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESERVICENAME', 'FALSE') = 'TRUE' then IncludeServiceName := true;  //2016-5-25 jtm
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDECARDHOLDERNAME', 'FALSE') = 'TRUE' then IncludeCardHolderName := true;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL', '') <> '' then StoreSystemCodeLabel := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL'));  //2016-8-22 jtm: Feat OT#1038
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHONSERVICENAME', 'FALSE') = 'TRUE') and (VarEvaluator.GetValueAsString('ServiceName') <> 'ALL') then SearchOnServiceName := true; //2017-05-10 jtm: F#1565
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESFINDICATOR', 'FALSE') = 'TRUE' then IncludeSFINDICATOR := true;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDECVVRESP', 'FALSE') = 'TRUE' then IncludeCVVResp := true;  //2018-3-14 ajs: F#3629
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEAVSRESP', 'FALSE') = 'TRUE' then IncludeAVSResp := true;  //2018-3-14 ajs: F#3629
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEAVSDATA', 'FALSE') = 'TRUE' then IncludeAVSData := true; // 2019-06-15 tjr: DVST-564
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESERVICENAMEDESCRIPTION', 'FALSE') = 'TRUE' then IncludeServiceNameDesc := true;  //2018-01-25 ajs: F#2378
   AVSDataHeader := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/AVSDATAHEADER', 'AVSDATA'); // 2019-06-15 tjr: DVST-564

   IncludeStoreName := DisplayStoreNameOnOpenCard;

   if IncludeStoreName then begin
      StoreName := FetchStoreName(LocationRNID);
   end;

   BatchHTML := TStringList.Create;
   BatchHTMLHeader := '<TABLE border="1" cellspacing="0" cellpadding="3"  style="border-collapse: collapse; font-size:7pt;font-family:veranda">' +
                 '<TR><TD><B>RNID</B></TD>';

   if IncludeStoreName then BatchHTMLHeader := BatchHTMLHeader + '<TD><B>Location</B></TD>';              

   BatchHTMLHeader := BatchHTMLHeader + '    <TD><B>Auth Date</B></TD>'+
                 '    <TD><B>Entry</B></TD>'+
                 '    <TD><B>Type</B></TD>'+
                 '    <TD Align="Right"><B>Amount</B></TD>'+
                 '    <TD colspan=2><B>Auth Code</B></TD>'+
                 '    <TD><B>Type</B></TD>'+
                 '    <TD><B>Card Acct</B></TD>'+
                 '    <TD><B>' + TranIdentHeader + '</B></TD>'+
                 '    <TD><B>' + CustIdentHeader + '</B></TD>';

    if IncludeEmpIdent then BatchHTMLHeader := BatchHTMLHeader + '    <TD><B>Emp Ident</B></TD>';
    if IncludeServiceName then BatchHTMLHeader := BatchHTMLHeader + '    <TD><B>Service Name</B></TD>';
    if IncludeCardHolderName then BatchHTMLHeader := BatchHTMLHeader + '    <TD><B>Card Name</B></TD>';
    if IncludeSFINDICATOR then BatchHTMLHeader := BatchHTMLHeader + '    <TD><B>SF</B></TD>';
    if IncludeCVVResp then BatchHTMLHeader := BatchHTMLHeader + '    <TD><B>CVVRESP</B></TD>'; //2018-3-14 ajs: F#3629
    if IncludeAVSResp then BatchHTMLHeader := BatchHTMLHeader + '    <TD><B>AVSRESP</B></TD>'; //2018-3-14 ajs: F#3629
    if IncludeAVSData then BatchHTMLHeader := BatchHTMLHeader + '    <TD><B>' + AVSDataHeader + '</B></TD>';  // 2019-06-15 tjr: DVST-564

    BatchHTMLHeader := BatchHTMLHeader + '    <TD><B>Station</B></TD>';
    if StoreSystemCodeLabel <> '' then
       BatchHTMLHeader := BatchHTMLHeader +  '  <TD><B>'+ StoreSystemCodeLabel +'</B></TD>'
    else
       BatchHTMLHeader := BatchHTMLHeader + '  <TD><B>Item Serial</B></TD>';
   BatchHTMLHeader := BatchHTMLHeader +               '</TR>';
   BatchHTML.Add(BatchHTMLHeader);
   BatchXMLNode := BatchOXML.GetNode('/TRANRESP/CCBATCHDETAIL');
   BatchXMLNode := BatchXMLNode.FindFirstChildElement;

   While (BatchXMLNode <> nil) do begin
      Line := '';
      if (BatchXMLNode.NodeName = 'CCAUTHDETAIL') then begin //2017-09-06 jtm: D#1885
         BRNID := Trim(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'PROFILE'));

         if (SearchOnServiceName) then begin
            ServiceNameSearchedOn := (BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CCSERVICENAME') = VarEvaluator.GetValueAsString('ServiceName'));
         end;
         if (IncludeServiceName) or (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHONSERVICENAME', 'FALSE') = 'TRUE') then begin  //2018-01-29 jtm: D#3693
            ServiceNamesByRNID := GetServiceNamesByRNID(BRNID,'',ServNameList,ServNameDescList);
         end;

         BSC := BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SYSTEMCODE');
         Line := Line + '<TR>' +
                     '<TD>' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'PROFILE') + '</TD>';

         if includeStoreName then Line := Line + '<TD>' + StoreName + '</TD>';

         Line := Line + '<TD>' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANDATE') + '</TD>' +
                     '<TD>' + GetCCTranEntryModeDisplayCode(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANENTRYMODE')) + '</TD>' +
                     '<TD>' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SALETYPE') + '</TD>';

                     if (BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SALETYPE') = 'CREDIT') or (BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SALETYPE') = 'REFUND') then begin   //2017-11-16 jtm: D#2021
                        Line := Line + '<TD>(' + Format('%m',[ValuReal(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANAMT'))]) + ')</TD>';
                        if SearchOnServiceName then begin
                           if ServiceNameSearchedOn then begin
                              AddAmt(CreditVisaMC, CreditAMEX, CreditDisc,CreditOthr,CreditQVisaMC, CreditQAMEX, CreditQDisc,CreditQOthr); //2018-01-25 ajs: F#2414
                           end;
                        end else begin
                           AddAmt(CreditVisaMC, CreditAMEX, CreditDisc,CreditOthr,CreditQVisaMC, CreditQAMEX, CreditQDisc,CreditQOthr);
                        end;
                     end else if (BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SALETYPE') = 'CRVOID' ) then begin
                        Line := Line + '<TD><DEL>(' + Format('%m',[ValuReal(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANAMT'))]) + ')</DEL></TD>';
                        if SearchOnServiceName then begin
                           if ServiceNameSearchedOn then begin
                              AddAmt(CRVoidVisaMC, CRVoidAMEX, CRVoidDisc,CRVoidOthr,CRVoidQVisaMC, CRVoidQAMEX, CRVoidQDisc, CRVoidQOthr); //2018-01-25 ajs: F#2414
                           end;
                        end else begin
                           AddAmt(CRVoidVisaMC, CRVoidAMEX, CRVoidDisc,CRVoidOthr,CRVoidQVisaMC, CRVoidQAMEX, CRVoidQDisc, CRVoidQOthr); //2018-01-25 ajs: F#2414
                        end;
                     end else if (BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SALETYPE') = 'VOID' ) then begin
                        Line := Line + '<TD><DEL>' + Format('%m',[ValuReal(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANAMT'))]) + '</DEL></TD>';
                        if SearchOnServiceName then begin
                           if ServiceNameSearchedOn then begin
                              AddAmt(VoidVisaMC, VoidAMEX, VoidDisc,VoidOthr,VoidQVisaMC, VoidQAMEX, VoidQDisc, VoidQOthr); //2018-01-25 ajs: F#2414
                           end;
                        end else begin
                           AddAmt(VoidVisaMC, VoidAMEX, VoidDisc,VoidOthr,VoidQVisaMC, VoidQAMEX, VoidQDisc, VoidQOthr); //2018-01-25 ajs: F#2414
                        end;
                     end else begin
                        Line := Line + '<TD>' + Format('%m',[ValuReal(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANAMT'))]) + '</TD>';
                        if (Trim(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'AUTHCODE')) <> '') then begin //2018-01-25 ajs: F#2414
                           if SearchOnServiceName then begin
                              if ServiceNameSearchedOn then begin
                                 AddAmt(SaleVisaMC, SaleAMEX, SaleDisc,SaleOthr,SaleQVisaMC, SaleQAMEX, SaleQDisc,SaleQOthr);
                              end;
                           end else begin
                              AddAmt(SaleVisaMC, SaleAMEX, SaleDisc,SaleOthr,SaleQVisaMC, SaleQAMEX, SaleQDisc,SaleQOthr);
                           end;
                        end;
                     end;
                     If (BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SALETYPE') = 'CREDIT') or (BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SALETYPE') = 'REFUND') then begin //2017-11-16 jtm: D#2021
                        Line := Line + '    <TD><IMG SRC="/Images/General/CashSmall.gif" border="0"></TD>';
                        If (BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SALETYPE') = 'CREDIT') then begin
                           Line := Line + '    <TD align="Right"></TD>';
                        end else begin
                           Line := Line + '    <TD align="Right">' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'AUTHCODE') + '</TD>';
                        end;
                     end else If BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SALETYPE') = 'VOID' then begin
                        Line := Line + '    <TD><IMG SRC="/Images/General/YellowExclamation.gif" border="0"></TD>' +
                                       '    <TD align="Right">' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'AUTHCODE') + '</TD>';
                     end else If BatchOXML.GetContextValueAsWideString(BatchXMLNode,'AUTHCODE') <> '' then begin
                        Line := Line + '    <TD><IMG SRC="/Images/General/CheckSuccess.gif" border="0"></TD>' +
                                       '    <TD align="Right"><font color="GREEN">' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'AUTHCODE') + '</FONT></TD>';
                     end else begin
                        Line := Line + '    <TD><IMG SRC="/Images/General/XFailed.gif" border="0"></TD>' +
                                       '    <TD align="Right"><font color="Red">' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'NONAUTHRESP') + '</FONT></TD>';
                     end;



         Line := Line + '<TD>' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CARDTYPE') + '</TD>';
         CardAcct := trim(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CARDACCT'));
         ProcessorToken := trim(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'PROCESSORTOKEN'));
         MaskAcct := '';
         if (CardAcct <> '') then begin  //2017-12-20 jtm: F#2430
            if (ProcessorToken <> '') then begin  //card number sent in, but either tokenized or not
               MaskAcct := MaskStr(ProcessorToken,DigitsToMask(ProcessorToken));
               MaskAcct := '*..*' + NumericOnly(MaskAcct);
            end else begin
               MaskAcct := CardAcct;
               MaskAcct := 'X..X' + NumericOnly(MaskAcct);
            end;
         end else if (CardAcct = '')  and (ProcessorToken <> '') then begin //token passed directly
            MaskAcct := MaskStr(ProcessorToken,DigitsToMask(ProcessorToken));
            MaskAcct := '#..#' + NumericOnly(MaskAcct);
         end;
         Line := Line +  '<TD>' + MaskAcct + '</TD>';

         Line := Line +  '<TD>' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANIDENT') + '</TD>' +
                     '<TD>' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANCUSTOMERCODE') + '</TD>';
         if IncludeEmpIdent then Line := Line + '<TD>' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'TRANEMPLOYEEIDENT') + '</TD>';
         if IncludeServiceName then begin //2018-01-25 ajs: F#2378
            if IncludeServiceNameDesc then begin
               Index := ServNameList.IndexOf(Trim(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CCSERVICENAME')));
               if (Index = -1) then begin
                  Line := Line + '<TD>' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CCSERVICENAME') + '</TD>';
               end else begin
                  Line := Line + '<TD>' + ServNameDescList[Index] + '</TD>';
               end;
            end else begin
               Line := Line + '<TD>' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CCSERVICENAME') + '</TD>';
            end;
         end;
         if IncludeCardHolderName then Line := Line + '<TD>' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CARDNAME') + '</TD>';
         if IncludeSFINDICATOR then begin
            if (BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SFTRANGUID') <> '') then begin
               Line := Line + '<TD>' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'SFTRANGUID') + '</TD>';
            end else begin
               Line := Line + '<TD>' + ' ' + '</TD>';
            end;
         end;
         if IncludeCVVResp then Line := Line + '<TD>' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CVVRESP') + '</TD>';  //2018-3-14 ajs: F#3629
         if IncludeAVSResp then Line := Line + '<TD>' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'AVSRESP') + '</TD>';  //2018-3-14 ajs: F#3629
         if IncludeAVSData then Line := Line + '<TD>' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'AVSDATA') + '</TD>'; // 2019-06-15 tjr: DVST-564

         Line := Line + '<TD>' + BatchOXML.GetContextValueAsWideString(BatchXMLNode,'STATIONIDENT') + '</TD>';
         If UILinks then begin
            Line := Line +  '<TD><a href="javascript://" onclick="GetVTCardDetailAJAX(''' + BRNID+ ''','''+ BSC + ''',true)">' + BSC+ '</a></TD>';
         end else begin
            Line := Line +  '<TD>' + BSC + '</TD>';
         end;
         Line := Line +  '</TR>';
         if SearchOnServiceName then begin   //2017-05-10 jtm: F#1565
            if (ServiceNameSearchedOn) then BatchHTML.Add(Line);
         end else if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHONSERVICENAME', 'FALSE') = 'TRUE') and (VarEvaluator.GetValueAsString('ServiceName') = 'ALL') then begin  //2017-09-20 jtm: D#1946
            if (ServiceNamesByRNID <> GetUserServNameAccessByRNID(ServNameList,BRNID,(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/NOREADONLYLOCATIONS','FALSE') = 'TRUE'),ServiceNamesByRNID)) then begin //2017-10-26 jtm: D#2042
               ProcessLog(ltInfo,'BatchXMLToHTML search on servicename:',BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CCSERVICENAME'));
               if (ServNameList.IndexOf(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CCSERVICENAME')) >= 0) then begin
                  ProcessLog(ltInfo,'BatchXMLToHTML search on servicename index:',IntToStr(ServNameList.IndexOf(BatchOXML.GetContextValueAsWideString(BatchXMLNode,'CCSERVICENAME'))));
                  BatchHTML.Add(Line);
               end
            end else begin
               BatchHTML.Add(Line);
            end;
         end else begin
          BatchHTML.Add(Line);
         end;
         inc(I);
      end;
      BatchXMLNode := BatchXMLNode.FindNextSiblingElement;
   end;
   ProcessLog(ltInfo,'BatchXMLToHTML processed records:' + IntToStr(i),InstanceGUID);
   BatchHTML.Add('</TABLE>');
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ENABLECARDBATCHSUMMARY', 'FALSE') = 'TRUE') then begin
      ProcessFooter;
   end;
   Result := batchHTML.Text;
   BatchHTML.Free;
   ServNameList.Free;
   ServNameDescList.Free;
end;

Function TCustomerInfoModule.LoadCustPayHistGUIDToVars(PaymentHistGuid : String; LoadVars : TVarEval) : boolean;
var
   AQuery : TADOQuery;
begin
   Result := False;
   PaymentHistGuid := GuidOnly(PaymentHistGuid);
   If PaymentHistGuid = '' then exit;
   AQuery := NewADOQuery;
   AQuery.SQL.Add('select * from CustPaymentHistory');
   AQuery.SQL.Add('where (PayHistGUID = ''' + PaymentHistGUID + ''')');
   AQuery.Open;
   Result := AQuery.RecordCount = 1;
   LoadVars.AddDSCurrentRecord(AQuery, 'CustPaymentHistory');
   AQuery.Close;
   AQUery.Free;
end;


function TCustomerInfoModule.VTCardAjaxPost(const ARNID: string): string;
var
   ws :string;
begin
   VarEvaluator.ClearAll;
   result := '';
   ws := '';
   if ProcessPortalPayment(ARNID,'NONE', nil) then begin
      if (VarEvaluator.GetValueAsString('PromptForFraudReversal') = 'FALSE') AND (VarEvaluator.GetValueAsString('FraudAutoReversal') = '') then begin //2018-06-20 bls: F#2076
      WS := '<CENTER><B>Payment Approved</B></CENTER><BR>' +
            '<CENTER><B>Approval Code:'+VarEvaluator.GetValueAsString('APPROVALCODE')+'</B></CENTER><BR>' +
            '<CENTER><B>Transaction Identifier:'+VarEvaluator.GetValueAsString('TRANIDENT')+'</B></CENTER><BR>' +
            '<a style="text-align: center;" href="javascript:VTPrintAuthReceiptAJAX('+ VarEvaluator.GetValueAsString('PaymentLocationRNID')+ ',' +
            VarEvaluator.GetValueAsString('GWSC')+',''CARD'');" class="linkBtn">Print Receipt</a>';
      end else if VarEvaluator.GetValueAsString('FraudAutoReversal') <> '' then begin
         WS := '<CENTER><B>Transaction was automatically reversed based on fraud detection settings.</B></CENTER><BR>' +
               '<CENTER><B>' + VarEvaluator.GetValueAsString('FraudAutoReversal') + '</B></CENTER>';
               if VarEvaluator.GetValueAsString('CVVRespText') <> '' then begin
                  WS := WS + '<CENTER>CVV Response: ' + VarEvaluator.GetValueAsString('CVVRespText') + '</CENTER><BR>';
               end;
               if VarEvaluator.GetValueAsString('AVSRespText') <> '' then begin
                  WS := WS + '<CENTER>AVS Response: ' + VarEvaluator.GetValueAsString('AVSRespText') + '</CENTER><BR>';
               end;
               WS := WS + '<a style="text-align: center;" href="javascript:VTPrintAuthReceiptAJAX('+ VarEvaluator.GetValueAsString('PaymentLocationRNID')+ ',' +
               VarEvaluator.GetValueAsString('GWSC')+',''CARD'');" class="linkBtn">Print Receipt</a>';
      end else begin
         WS := '<CENTER><B>' + OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/FRAUDPROMPTMESSAGE', 'Transaction flagged as possible fraud. User must present ID to use card.') + '</B></CENTER><BR>' +
               '<CENTER><B>Do you want to accept the transaction?</B></CENTER><BR><BR>';

         if VarEvaluator.GetValueAsString('CVVRespText') <> '' then begin //2018-06-20 bls: F#2076
            WS := WS + '<CENTER>CVV Response: ' + VarEvaluator.GetValueAsString('CVVRespText') + '</CENTER><BR>';
         end;
         if VarEvaluator.GetValueAsString('AVSRespText') <> '' then begin
            WS := WS + '<CENTER>AVS Response: ' + VarEvaluator.GetValueAsString('AVSRespText') + '</CENTER><BR>';
         end;
         WS := WS + '<BR><DIV style="text-align: center;"><a style="margin-right: 5px" href="javascript://" class="linkBtn" onclick="$.get(''/PP?PAGE=VTCARDAJAXPOSTSUCCESS&APPROVALCODE=' + VarEvaluator.GetValueAsString('APPROVALCODE');
         WS := WS + '&TRANIDENT=' + VarEvaluator.GetValueAsString('TRANIDENT') + '&PAYMENTRNID=' + VarEvaluator.GetValueAsString('GatewayRNID') + '&GWSC=' + VarEvaluator.GetValueAsString('CCSystemCode');
         WS := WS + '&RECEIPTNUMBER=' + VarEvaluator.GetValueAsString('ReceiptNumber') + '&AMOUNT=' + VarEvaluator.GetValueAsString('TranAmount') + '&CUSTIDENT=' + VarEvaluator.GetValueAsString('CustIdent');
         WS := WS + '&ACCOUNTNUMBER=' + VarEvaluator.GetValueAsString('AccountNumber') + '&PAYMENTAMOUNT=' + VarEvaluator.GetValueAsString('PaymentAmount') + '&CARDEXP=' + VarEvaluator.GetValueAsString('CARDEXP');
         WS := WS +'&PAYMENTTYPE=' + VarEvaluator.GetValueAsString('PAYMENTTYPE') + '&=TRANAMOUNT' + VarEvaluator.GetValueAsString('TranAmount') + '&CARDTYPE=' + VarEvaluator.GetValueAsString('CardType');
         WS := WS + '&PR=' + VarEvaluator.GetValueAsString('PR') + '&CUSTOMFIELD1=' +  VarEvaluator.GetValueAsString('CustomField1') + '&CUSTOMFIELD2=' + VarEvaluator.GetValueAsString('CustomField2') + '&CUSTOMFIELD3=';
         WS := WS + VarEvaluator.GetValueAsString('CustomField3') + '&CUSTOMFIELD4=' + VarEvaluator.GetValueAsString('CustomField4') + '&CUSTOMFIELD5=' + VarEvaluator.GetValueAsString('CustomField5') + '&CUSTOMFIELD6=';
         WS := WS + VarEvaluator.GetValueAsString('CustomField6') + '&CUSTOMFIELD7=' + VarEvaluator.GetValueAsString('CustomField7') + '&CUSTOMFIELD8=' + VarEvaluator.GetValueAsString('CustomField8') + '&CUSTOMFIELD9=';
         WS := WS + VarEvaluator.GetValueAsString('CustomField9') + '&CUSTOMFIELD10=' + VarEvaluator.GetValueAsString('CustomField10') + '&PAYMENTGUID=' + VarEvaluator.GetValueAsString('PAYMENTGUID') + ''', function(response){ $(''#TAB-VirtualTerminalCard'').html(response); } );">Yes</a>';
         WS := WS + '<a href="javascript://" class="linkBtn" onclick="$.get(''/PP?PAGE=VTCARDAJAXPOSTREVERSAL&LOCATIONRNID=' + VarEvaluator.GetValueAsString('GatewayRNID') +
               '&CCSYSTEMCODE=' + VarEvaluator.GetValueAsString('CCSystemCode') + ''', function(response) { $(''#TAB-VirtualTerminalCard'').html(''<CENTER></B>'' + response + ''</B></CENTER>''); });">No</a></DIV>';
      end;
   end else begin
      WS := '<BR><BR><CENTER><B>Sorry, this payment was not processed. Failure Reason: '+VarEvaluator.GetValueAsString('NonAuthReason')+'</B></CENTER><BR>' + //2017-08-16 ajs: F#1578
            '<CENTER><B>'+ VarEvaluator.GetValueAsString('PR')+'</B></CENTER><BR>';
   end;
   result := WS;

end;

function TCustomerInfoModule.VTCardAjaxPostReversal(RNID,SystemCode: string): string;
var
EmailMessage : string;
begin
   Result :=  ReverseCC(NumericOnly(RNID),NumericOnly(SystemCode)) +
                           '<BR><BR><BR><a href="javascript:VTPrintAuthReceiptAJAX('+ NumericOnly(RNID) + ',' +
                           NumericOnly(SystemCode) + ',''CARD'');" class="linkBtn">Print Receipt</a>';;

   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/FRAUDPROMPTSENDEMAIL','FALSE')='TRUE') AND (SessionVarEval.GetValueAsString('CUSTOMEREMAIL') <> '') then begin
      EmailMessage := '<HTML>' + OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/FRAUDPROMPTMESSAGEEMAIL', 'Your Credit card Payment was reversed due to potential Fraud.') + '<BR>';

      clMail.BuildMessage('',EmailMessage);
      clMail.From.FullAddress := '"' + DomainFriendlyName+'"<'+DomainSendAsEmail+'>';
      clMail.ToList.EmailAddresses := SessionVarEval.GetValueAsString('CUSTOMEREMAIL');
      clMail.BCCList.EmailAddresses := GetConfigString('CONFIRMATIONBCC','');
      if SessionVarEval.GetValueAsString('BCCEMAIL') <> '' then
         clMail.BCCList.EmailAddresses := clMail.BCCList.EmailAddresses + ',' + SessionVarEval.GetValueAsString('BCCEMAIL');
      if SessionVarEval.GetValueAsString('EmployeeEmail') <> '' then     //2016-8-08 jtm: Feat OT#979
         clMail.BCCList.EmailAddresses := clMail.BCCList.EmailAddresses + ',' + SessionVarEval.GetValueAsString('EmployeeEmail');

      ProcessLog(ltInfo,'bccemails', clMail.BCCList.EmailAddresses);
      If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAIL/DECLINEDPAYMENTSUBJECT') <> '' then
         clMail.Subject := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAIL/DECLINEDPAYMENTSUBJECT') + ' ' + FormatDateTime('MM/DD/YYYY', Date)
      else
         clMail.Subject := 'Payment Failure Notification ' + FormatDateTime('MM/DD/YYYY', Date);
      clMail.ReplyTo := GetConfigString('CONFIRMATIONREPLYTO','');
      SMTP.Open();
      try
         try
            SMTP.Send(clMail);
         except  //2017-08-16 jtm: D#1857
           On E:Exception do begin
               ProcessLog(ltWarning,'Exception on Sending Email ', E.Message);
           end;
         end;
      finally
         SMTP.Close();
      end;
   end else if (SessionVarEval.GetValueAsString('CUSTOMEREMAIL') <> '') AND (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/FRAUDPROMPTSENDEMAIL','FALSE')='TRUE') then begin
      ProcessLog(ltInfo, 'VTCARDAJAXPOSTREVERSAL', 'Customer Email is missing');
   end;
end;

function TCustomerInfoModule.VTCardAjaxPostSuccess(AQueryFields: TStrings): string;
var
   EmailMessage : string;
   HTMLEmail : string;
   ReceiptToCustEmail : boolean; //2018-09-12 ajs: DVST-1235
   CustReceiptEmailResp : string; //2018-09-12 ajs: DVST-1235
begin
   Result := '';
   ReceiptToCustEmail := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ALLOWEMAILRECEIPT','FALSE')); //2018-09-12 ajs: DVST-1235
   if (AQueryFields.Values['APPROVALCODE'] <> '') AND (AQueryFields.Values['PAYMENTRNID'] <> '') AND (AQueryFields.Values['GWSC'] <> '') then begin
      result := '<CENTER><B>Payment Approved</B></CENTER><BR>' +
                  '<CENTER><B>Approval Code: '+ AQueryFields.Values['APPROVALCODE'] +'</B></CENTER><BR>' +
                  '<CENTER><B>Transaction Identifier: '+ AQueryFields.Values['TRANIDENT'] +'</B></CENTER><BR>' +
                  '<a href="javascript:VTPrintAuthReceiptAJAX('+ AQueryFields.Values['PAYMENTRNID'] + ',' +
                  AQueryFields.Values['GWSC'] + ',''CARD'');" class="linkBtn">Print Receipt</a>';

      VarEvaluator.AddValue('GWSC',AQueryFields.Values['GWSC']);
      VarEvaluator.AddValue('ApprovalCode',AQueryFields.Values['APPROVALCODE']);
      VarEvaluator.AddValue('TranIdent',AQueryFields.Values['TRANIDENT']);
      VarEvaluator.AddValue('paymentamount',AQueryFields.Values['AMOUNT']);
      VarEvaluator.AddValue('ReceiptNumber',AQueryFields.Values['RECEIPTNUMBER']);
      VarEvaluator.AddValue('CARDEXP',AQueryFields.Values['CARDEXP']);
      VarEvaluator.AddValue('CustomField4',AQueryFields.Values['CUSTOMFIELD4']);
      VarEvaluator.AddValue('CustomField1',AQueryFields.Values['CUSTOMFIELD1']);
      VarEvaluator.AddValue('CustomField5',AQueryFields.Values['CUSTOMFIELD5']);
      VarEvaluator.AddValue('CustomField6',AQueryFields.Values['CUSTOMFIELD6']);
      VarEvaluator.AddValue('CustomField7',AQueryFields.Values['CUSTOMFIELD7']);
      VarEvaluator.AddValue('CustomField8',AQueryFields.Values['CUSTOMFIELD8']);
      VarEvaluator.AddValue('CustomField2',AQueryFields.Values['CUSTOMFIELD2']);
      VarEvaluator.AddValue('CustomField3',AQueryFields.Values['CUSTOMFIELD3']);
      VarEvaluator.AddValue('CustomField9',AQueryFields.Values['CUSTOMFIELD9']);
      VarEvaluator.AddValue('CustomField10',AQueryFields.Values['CUSTOMFIELD10']);
      VarEvaluator.AddValue('CardType',AQueryFields.Values['CARDTYPE']);
      LoadCustPayHistGUIDToVars(AQueryFields.Values['PAYMENTGUID'], VarEvaluator);

      if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/FRAUDPROMPTSENDEMAIL','FALSE')='TRUE') then begin

         if (ReceiptToCustEmail AND (SessionVarEval.GetValueAsString('CUSTRECEIPTEMAIL') <> '')) then begin
            CustReceiptEmailResp := '';
            CustReceiptEmailResp := EmailReceipt(SessionVarEval.GetValueAsString('CUSTRECEIPTEMAIL'),AQueryFields.Values['PAYMENTRNID'],AQueryFields.Values['GWSC'],'','CARD');
            ProcessLog(ltInfo, 'VTCARDAJAXPOSTSUCCESS Customer Receipt Email Response:', CustReceiptEmailResp);
         end;
         if (SessionVarEval.GetValueAsString('CUSTOMEREMAIL') <> '') then begin
            EmailMessage := '<HTML>Thank you for your Payment.<BR><BR>' +
                       '<B>Receipt Number:</B> ' + AQueryFields.Values['RECEIPTNUMBER'] + '<BR>' +
                       '<B>Amount:</B> ' + AQueryFields.Values['AMOUNT'] + '<BR>' +
                       '<B>Date:</B> ' + FormatDateTime('MM/DD/YYYY', NOW) + '<BR>';
            EmailMessage := EmailMessage + '<BR>' + AQueryFields.Values['CUSTIDENT'];
            EmailMessage := EmailMessage + '<BR>' + AQueryFields.Values['ACCOUNTNUMBER'];

            HTMLEmail := LoadWebFileFromFolder('ReceiptCardApproved.htm','');
            If HTMLEmail <> '' then EmailMessage := HTMLEmail;

            clMail.BuildMessage('',EmailMessage);
            clMail.From.FullAddress := '"' + DomainFriendlyName+'"<'+DomainSendAsEmail+'>';
            clMail.ToList.EmailAddresses := SessionVarEval.GetValueAsString('CUSTOMEREMAIL');
            clMail.BCCList.EmailAddresses := GetConfigString('CONFIRMATIONBCC','');
            if SessionVarEval.GetValueAsString('BCCEMAIL') <> '' then
               clMail.BCCList.EmailAddresses := clMail.BCCList.EmailAddresses + ',' + SessionVarEval.GetValueAsString('BCCEMAIL');
            if SessionVarEval.GetValueAsString('EmployeeEmail') <> '' then     //2016-8-08 jtm: Feat OT#979
               clMail.BCCList.EmailAddresses := clMail.BCCList.EmailAddresses + ',' + SessionVarEval.GetValueAsString('EmployeeEmail');

            ProcessLog(ltInfo,'bccemails', clMail.BCCList.EmailAddresses);

            If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAIL/APPROVEDPAYMENTSUBJECT') <> '' then
                  clMail.Subject := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAIL/APPROVEDPAYMENTSUBJECT') + ' ' + FormatDateTime('MM/DD/YYYY', Date)
               else
                  clMail.Subject := 'Payment Receipt ' + FormatDateTime('MM/DD/YYYY', Date);

            clMail.ReplyTo := GetConfigString('CONFIRMATIONREPLYTO','');
            SMTP.Open();
            try
               try
                  SMTP.Send(clMail);
               except  //2017-08-16 jtm: D#1857
                 On E:Exception do begin
                     ProcessLog(ltWarning,'Exception on Sending Email ', E.Message);
                 end;
               end;
            finally
               SMTP.Close();
            end;
         end;
      end else if (SessionVarEval.GetValueAsString('CUSTOMEREMAIL') = '') AND (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/FRAUDPROMPTSENDEMAIL','FALSE')='TRUE') then begin
         ProcessLog(ltInfo, 'VTCARDAJAXPOSTSUCCESS', 'Customer Email is missing');
      end;
   end;
end;

function TCustomerInfoModule.CalculateSurcharge(const AQueryFields, AContentFields: TStrings): string;
var
   rnidL, amount, cardEventParams, appServerSI, tranTypeL, billSt, billZIP, tranIdentL, custIdentL, surchargeStr, responseHTMLStr, legal, surchargeAmt, serviceName, custEmail, PaymentServiceName : string;
   RequestXML, ResponseXML, ResponseHTML : TStringList;
   CEPXML : TOpenXML;
begin
   Result := '<center><b>Something went wrong; please try again later</b></center>';
   
   rnidL := NumericOnly(AContentFields.Values['PaymentLocation']);
   if NOT validateRNID(rnidL) then exit;

   cardEventParams := AContentFields.Values['CARDEVENTPARAMS'];
   try
      CEPXML := TOpenXML.CreateFromString(nil, cardEventParams);
   except
      on E:Exception do begin
         ProcessLog(ltWarning, 'CalculateSurcharge Invalid XML', 'Invalid Card Event Params XML');
         exit;
      end;
   end;
   
   amount := ValidCharsOnly(AContentFields.Values['amount'], false, true, '.');
   appServerSI := trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', ''));

   PaymentServiceName := 'CARD';
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/SHOWSERVICENAME', 'FALSE') = 'TRUE') and
         (ValidCharsOnly(Request.ContentFields.Values['VTCardServiceName'],True,True,'-') <> '') and (UpperCase(ValidCharsOnly(AContentFields.Values['VTCardServiceName'], True,True,'-')) <> 'ALL')  then begin
      PaymentServiceName := ValidCharsOnly(Request.ContentFields.Values['VTCardServiceName'],True,True,'-');
      ProcessLog(ltInfo,'VTCardServiceName:', PaymentServiceName);
   end;

   RequestXML := TStringList.Create();
   RequestXML.Add('<TRANSACTION>');
   RequestXML.Add('<PROFILE>' + rnidL + '</PROFILE>');
   RequestXML.Add('<TRANSACTIONTYPE>SURCHARGEQUOTE</TRANSACTIONTYPE>');
   RequestXML.Add('<SERVICENAME>' + PaymentServiceName + '</SERVICENAME>');
   RequestXML.Add('<CCAMT>' + amount + '</CCAMT>');
   if appServerSI <> '' then RequestXML.Add('<SOLUTIONIDENT>' + appServerSI + '</SOLUTIONIDENT>');
   RequestXML.Add(CEPXML.DocumentAsString);
   RequestXML.Add('</TRANSACTION>' + CRLF);

   VarEvaluator.AddValue('GatewayRNID', rnidL);
   ResponseXML := TStringList.Create();
   ProcessPPSAPIXML(RequestXML.Text, ResponseXML, GetAppServerHost, 0);
   surchargeStr := ResponseXML.Text;
   RequestXML.Free;
   ResponseXML.Free;

   ResponseHTML := TStringList.Create();
   if Utility.GetXMLTagStr(surchargeStr, 'TRANSUCCESS') = 'TRUE' then begin
      tranTypeL := AContentFields.Values['PaymentTransactionType'];
      billSt := AContentFields.Values['billingStreet'];
      billZIP := AContentFields.Values['billingZip'];
      tranIdentL := AContentFields.Values['TRANIDENT'];
      custIdentL := AContentFields.Values['CUSTIDENT'];
      serviceName := PaymentServiceName;
      custEmail := AContentFields.Values['CustEmail'];

      amount := Utility.GetXMLTagStr(surchargeStr, 'CCAMT');
      legal := Utility.GetXMLTagStr(surchargeStr, 'SURCHARGELEGAL');
      surchargeAmt := Utility.GetXMLTagStr(surchargeStr, 'SURCHARGEAMT');

      ResponseHTML.Add('<center><strong>Fee Disclosure</strong></center><br><br>');
      ResponseHTML.Add('<center>An additional fee of <strong>$' + surchargeAmt + '</strong> has been added to this transaction of <strong>$' + Utility.GetXMLTagStr(surchargeStr, 'SURCHARGEBASISAMT') + '</strong>.</center><br>');
      ResponseHTML.Add('<center>The total amount charged will be <strong>$' + amount + '</strong>.</center><br>');
      ResponseHTML.Add('<center>The fee must be accepted for the transaction to process. Not accepting the fee will cancel the transaction.</center><br><br>');
      ResponseHTML.Add('<center><textarea style="width: 600px; height: 75px; overflow-y: scroll;">' + legal + '</textarea></center><br>');

      ResponseHTML.Add('<div style="text-align: center"><a style="margin-right: 5px" href="javascript://" class="linkBtn" onclick="$.ajax({method: ''POST'',');
      ResponseHTML.Add('url: ''/PP?PAGE=VTCARDAJAXPOST'',');
      ResponseHTML.Add('data: {');
      ResponseHTML.Add('PAYMENTLOCATION: ''' + rnidL + ''',');
      ResponseHTML.Add('AMOUNT: ''' + amount + ''',');
      ResponseHTML.Add('SURCHARGELEGAL: ''' + legal + ''',');
      ResponseHTML.Add('SURCHARGEAMT: ''' + surchargeAmt + ''',');
      ResponseHTML.Add('BILLINGSTREET: ''' + billSt + ''',');
      ResponseHTML.Add('BILLINGZIP: ''' + billZIP + ''',');
      ResponseHTML.Add('TRANIDENT: ''' + tranIdentL + ''',');
      ResponseHTML.Add('CUSTIDENT: ''' + custIdentL + ''',');

      if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/DISPLAYAUTHTYPES', 'FALSE')) then begin
         ResponseHTML.Add('PAYMENTTRANSACTIONTYPE: ''' + tranTypeL + ''',');
      end;
      if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/SHOWSERVICENAME', 'FALSE')) then begin
         ResponseHTML.Add('VTCardServiceName: ''' + serviceName + ''',');
      end;
      if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ALLOWEMAILRECEIPT', 'FALSE')) then begin
         ResponseHTML.Add('CUSTEMAIL: ''' + custEmail + ''',');
      end;

      ResponseHTML.Add('CARDEVENTPARAMS: ''' + cardEventParams + '''');
      ResponseHTML.Add('}');
      ResponseHTML.Add('}).done(function (response) { document.getElementById(''TAB-VirtualTerminalCard'').innerHTML = response; });">Accept</a>');

      ResponseHTML.Add('<a href="javascript://" class="linkBtn" onclick="$.get(''/PP?PAGE=GETVTCARDAJAX'', function (response) { document.getElementById(''TAB-VirtualTerminalCard'').innerHTML = response; });">Cancel</a>');
      responseHTMLStr := TextWithoutNewLine(ResponseHTML);
   end else begin
      responseHTMLStr := VTCardAjaxPost(rnidL);
   end;

   Result := responseHTMLStr;
end;

function TCustomerInfoModule.CreateSSReportSchedAjax(AQueryFields,AContentFields: TStrings; ARNID:string): string;
var
   ReportFormat : TReportFormatType;
   ReportGUID : string;
   ReportDescription : string;
   RunTime : TDateTime;
   dowSL : TStringList;
   frequency : string;
   EndType : string;
   StartDate : string;
   EndDate : string;
   weekStartDate,weekEndDate : TDateTime;
   todaysDateTimeTZ,todaysDateTime : TDateTime;
   todaysDateTZ : TDateTime;
   numofoccurrences : integer;
   dayofthemonth : integer;
   EmpIdent,EmployeeGUID,TimeZone,TimeZoneAbr : string;
   emailList : TStringList;
begin
   result := '';
   ReportGUID := GUIDOnly(AQueryFields.Values['ReportGUID']);
   GetEmpIdentAndGuid(EmpIdent, EmployeeGUID);
   emailList := TStringList.Create;
   emailList.commatext := AContentFields.Values['emailList'];
   ReportFormat := StrToReportFormat(ValidCharsOnly(AContentFields.Values['ReportType'],true,false,''));
   frequency := ValidCharsOnly(AContentFields.Values['frequency'],true,false,'');
   EndType :=  ValidCharsOnly(AContentFields.Values['ends'],true,false,'');
   numofoccurrences := Valu(NumericOnly(AContentFields.Values['numofoccurrences']));
   TimeZone :=  ValidCharsOnly(AContentFields.Values['TimeZoneSelect'],false,true,'-+');
   dowSL := TStringList.Create();
   TimeZoneAbr := GetTimeZoneBiasNameStringByNumber(TimeZone);
   todaysDateTime := now;
   todaysDateTZ := LocalTimeToZoneTime(todaysDateTime,TimeZoneAbr);
   todaysDateTZ := EncodeDate(YearOf(todaysDateTZ), MonthOf(todaysDateTZ), DayOf(todaysDateTZ));
   if (frequency <> 'once') then begin
      RunTime := StrToTime(ValidCharsOnly(AContentFields.Values['RunTimeCal'],true,true,':'));
   end;
   if (EndType = 'never') then begin
      EndDate := '';
   end else if (EndType = 'on') then begin
      EndDate :=  FormatDateTime('MM/DD/YYYY HH:NN:SS', ZoneTimeToLocalTime(StrToDateTime(ValidCharsOnly(AContentFields.Values['OnDateCal'],true,true,'/'))  + RunTime,TimeZoneAbr));
   end else if (EndType = 'after') then begin
   end;
   if (frequency = 'daily') then begin
      if (ZoneTimeToLocalTime(todaysDateTZ + RunTime,TimeZoneAbr) > now) then begin
         StartDate := FormatDateTime('MM/DD/YYYY HH:NN:SS', ZoneTimeToLocalTime(todaysDateTZ + RunTime,TimeZoneAbr));
      end else begin
         StartDate := FormatDateTime('MM/DD/YYYY HH:NN:SS', ZoneTimeToLocalTime(todaysDateTZ + 1 + RunTime,TimeZoneAbr));
      end;
      if (EndType = 'after') then begin
         EndDate := FormatDateTime('MM/DD/YYYY HH:NN:SS', StrToDateTime(StartDate) + numofoccurrences);
      end;
   end else if (frequency = 'weekly') then begin
      if (NumToBoolStr(NumericOnly(AContentFields.Values['dowMonday']))= 'TRUE') then begin
         dowSL.Append('Monday');
      end;
      if (NumToBoolStr(NumericOnly(AContentFields.Values['dowTuesday']))= 'TRUE') then begin
         dowSL.Append('Tuesday');
      end;
      if (NumToBoolStr(NumericOnly(AContentFields.Values['dowWednesday']))= 'TRUE') then begin
         dowSL.Append('Wednesday');
      end;
      if (NumToBoolStr(NumericOnly(AContentFields.Values['dowThursday']))= 'TRUE') then begin
         dowSL.Append('Thursday');
      end;
      if (NumToBoolStr(NumericOnly(AContentFields.Values['dowFriday']))= 'TRUE') then begin
         dowSL.Append('Friday');
      end;
      if (NumToBoolStr(NumericOnly(AContentFields.Values['dowSaturday']))= 'TRUE') then begin
         dowSL.Append('Saturday');
      end;
      if (NumToBoolStr(NumericOnly(AContentFields.Values['dowSunday']))= 'TRUE') then begin
         dowSL.Append('Sunday');
      end;
      if (dowSL.IndexOf(LongDayNames[dayofweek(todaysDateTZ)]) >= 0) then begin
         if (ZoneTimeToLocalTime(todaysDateTZ + RunTime,TimeZoneAbr) > now) then begin
            StartDate := FormatDateTime('MM/DD/YYYY HH:NN:SS', ZoneTimeToLocalTime(todaysDateTZ + RunTime,TimeZoneAbr));
         end else begin  //starts next week
            StartDate := FormatDateTime('MM/DD/YYYY HH:NN:SS', ZoneTimeToLocalTime(IncWeek(todaysDateTZ) + RunTime,TimeZoneAbr));
         end;
         dowSL.Delete(dowSL.IndexOf(LongDayNames[dayofweek(todaysDateTZ)]));
      end else begin
         if dowSL.Count > 0 then begin
            weekStartDate := todaysDateTZ;
            Repeat
               weekStartDate := IncDay(weekStartDate);
            until dowSL[0] = LongDayNames[dayofweek(weekStartDate)];

            StartDate := FormatDateTime('MM/DD/YYYY HH:NN:SS',ZoneTimeToLocalTime(weekStartDate + RunTime,TimeZoneAbr));
            dowSL.Delete(0);
         end else begin
            ProcessLog(ltInfo,'CREATESSREPORTSCHEDAJAX dow not set',dowSL.Text);
            Result := 'dow not set';
            Exit;
         end;
      end;
      if (EndType = 'after') then begin
         EndDate := FormatDateTime('MM/DD/YYYY HH:NN:SS', IncWeek(StrToDateTime(StartDate), numofoccurrences));
      end else if (EndType = 'on') then begin
         if (dayofweek(StrToDateTime(StartDate)) <> dayofweek(StrToDateTime(EndDate))) then begin  //if we're not ending on the same day as the start date, then we need to find a previous day to end
            weekEndDate := StrToDateTime(EndDate);
            Repeat
               weekEndDate := DecDay(weekEndDate);
            until dayofweek(StrToDateTime(StartDate)) = dayofweek(weekEndDate);
            EndDate := FormatDateTime('MM/DD/YYYY HH:NN:SS',weekEndDate);
         end;
      end;
   end else if (frequency = 'monthly') then begin
      if (AContentFields.Values['dayofthemonth'] <> 'end') then begin
         dayofthemonth := valu(NumericOnly(AContentFields.Values['dayofthemonth']));
         if (dayofthemonth = DayOf(todaysDateTZ)) then begin
            if (ZoneTimeToLocalTime(todaysDateTZ + RunTime,TimeZoneAbr) > now) then begin //starts today
               StartDate := FormatDateTime('MM/DD/YYYY HH:NN:SS', ZoneTimeToLocalTime(todaysDateTZ + RunTime,TimeZoneAbr));
            end else begin  //starts next month
               StartDate := FormatDateTime('MM/DD/YYYY HH:NN:SS',  ZoneTimeToLocalTime(IncMonth(EncodeDate(YearOf(todaysDateTZ), MonthOf(todaysDateTZ), dayofthemonth),1) + RunTime,TimeZoneAbr));
            end;
         end else begin
            if (dayofthemonth > DayOf(todaysDateTZ)) then begin  //still this month
               StartDate := FormatDateTime('MM/DD/YYYY HH:NN:SS', ZoneTimeToLocalTime(EncodeDate(YearOf(todaysDateTZ), MonthOf(todaysDateTZ), dayofthemonth)  + RunTime,TimeZoneAbr));
            end else begin  //starts next month
               StartDate := FormatDateTime('MM/DD/YYYY HH:NN:SS',  ZoneTimeToLocalTime(IncMonth(EncodeDate(YearOf(todaysDateTZ), MonthOf(todaysDateTZ), dayofthemonth),1) + RunTime,TimeZoneAbr));
            end;
         end;
      end else begin
         StartDate := FormatDateTime('MM/DD/YYYY HH:NN:SS',ZoneTimeToLocalTime(LastDayOfMonthOfDate(todaysDateTZ)+RunTime,TimeZoneAbr));
         frequency := 'monthlyend';
      end;
      if (EndType = 'after') then begin
         EndDate := FormatDateTime('MM/DD/YYYY HH:NN:SS', IncMonth(StrToDateTime(StartDate), numofoccurrences));
      end;
   end else if (frequency = 'once') then begin
      StartDate := FormatDateTime('MM/DD/YYYY HH:NN:SS',ZoneTimeToLocalTime(StrToDateTime(ValidCharsOnly(AContentFields.Values['OneRunCal'],true,true,'/: ')),TimeZoneAbr));
      EndDate :=  StartDate;
   end else begin
      ProcessLog(ltInfo,'CREATESSREPORTSCHEDAJAX frequency not set',frequency);
      Result := 'frequency not set';
      Exit;
   end;

   ttSSReporting := TttSSReporting.Create(PL.ProcessLog,RNDB,DoGetAppServerEvent);
   ttSSReporting.ChainCode := ChainCode;
   ttSSReporting.SQLwithTZ := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE'));
   ProcessLog(ltDebug,'CREATESSREPORTSCHEDAJAX CreateSSReportSched RNID begin',ARNID);
   Result := ttSSReporting.CreateSSReportSched(EmpIdent,ARNID,ReportGUID,frequency,StartDate,EndDate,'EXPORTBATCHDATEVAREVAL+''SSRTSchedReport.'+Lowercase(ReportFormatToStr(ReportFormat))+'''',ReportFormat,EmployeeGUID,UpperCase(DomainHostname),TimeZoneAbr,emailList);
   if (frequency = 'weekly') and (dowSL.Count > 0) then begin
      while (dowSL.Count > 0) do begin
         weekStartDate := todaysDateTZ;
         Repeat
            weekStartDate := IncDay(weekStartDate);
         until dowSL[0] = LongDayNames[dayofweek(weekStartDate)];

         StartDate := FormatDateTime('MM/DD/YYYY HH:NN:SS',ZoneTimeToLocalTime(weekStartDate + RunTime,TimeZoneAbr));
         dowSL.Delete(0);

         if (EndType = 'never') then begin
            EndDate := '';
         end else if (EndType = 'on') then begin
            EndDate :=  FormatDateTime('MM/DD/YYYY HH:NN:SS', ZoneTimeToLocalTime(StrToDateTime(ValidCharsOnly(AContentFields.Values['OnDateCal'],true,true,'/'))  + RunTime,TimeZoneAbr));
            if (dayofweek(StrToDateTime(StartDate)) <> dayofweek(StrToDateTime(EndDate))) then begin  //if we're not ending on the same day as the start date, then we need to find a previous day to end
               weekEndDate := StrToDateTime(EndDate);
               Repeat
                  weekEndDate := DecDay(weekEndDate);
               until dayofweek(StrToDateTime(StartDate)) = dayofweek(weekEndDate);
               EndDate := FormatDateTime('MM/DD/YYYY HH:NN:SS',weekEndDate);
            end;
         end else if (EndType = 'after') then begin
            EndDate := FormatDateTime('MM/DD/YYYY HH:NN:SS', IncWeek(StrToDateTime(StartDate), numofoccurrences));
         end;
         Result := ttSSReporting.CreateSSReportSched(EmpIdent,ARNID,ReportGUID,frequency,StartDate,EndDate,'EXPORTBATCHDATEVAREVAL+''SSRTSchedReport.'+Lowercase(ReportFormatToStr(ReportFormat))+'''',ReportFormat,EmployeeGUID,UpperCase(DomainHostname),TimeZoneAbr,emailList);
           
      end;
   end;
   ProcessLog(ltDebug,'CREATESSREPORTSCHEDAJAX CreateSSReportSched RNID end',ARNID);
   FreeAndNil(dowSL);
   FreeAndNil(ttSSReporting);
   FreeAndNil(emailList);
end;

function TCustomerInfoModule.GetEmployeeGUIDFromUsername(AUsername: string): string;
begin
   result := '';
   UserQuery.Close;
   UserQuery.Parameters.ParamByName('ChainCode').Value := ChainCode;
   UserQuery.Parameters.ParamByName('UserName').Value := AUserName;
   UserQuery.Open;
   if (UserQuery.RecordCount = 1) then begin
      result := UserQuery.FieldByName('EmployeeGUID').AsString;
   end;
   UserQuery.Close;
end;
function TCustomerInfoModule.GetScheduledSSReportAjax(AQueryFields, AContentFields: TStrings; const ARNID: string): string;
var
   EmpIdent, EmployeeGUID :string;
begin
   GetEmpIdentAndGuid(EmpIdent, EmployeeGUID);
   ProcessLog(ltInfo,'GETSCHEDULEDSSREPORTAJAX EmpIdent;RNID',EmpIdent+';'+ARNID);

   ttSSReporting := TttSSReporting.Create(PL.ProcessLog,RNDB,DoGetAppServerEvent);
   ttSSReporting.ChainCode := ChainCode;
   ttSSReporting.SQLwithTZ := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE'));
   ProcessLog(ltDebug,'GETSCHEDULEDSSREPORTAJAX ChainCode',IntToStr(ChainCode));
   result := ttSSReporting.GetSchedReportsGrid(EmpIdent,ARNID,EmployeeGUID);
   FreeAndNil(ttSSReporting);
end;
function TCustomerInfoModule.GetScheduledSSReportRunsAjax(AQueryFields, AContentFields: TStrings; ARNID: string): string;
var
EmpIdent,EmployeeGUID,SchedSC :string;
begin
   GetEmpIdentAndGuid(EmpIdent, EmployeeGUID);
   ProcessLog(ltInfo,'GetScheduledSSReportRunsAjax EmpIdent;RNID',EmpIdent+';'+ARNID);
   SchedSC := AQueryFields.Values['SCHEDSC'];
   ttSSReporting := TttSSReporting.Create(PL.ProcessLog,RNDB,DoGetAppServerEvent);
   ttSSReporting.ChainCode := ChainCode;
   ttSSReporting.SQLwithTZ := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE'));
   ProcessLog(ltDebug,'GetScheduledSSReportRunsAjax ChainCode',IntToStr(ChainCode));
   result := ttSSReporting.GetSchedReportsRunGrid(EmpIdent,ARNID,EmployeeGUID,SchedSC);
   FreeAndNil(ttSSReporting);
end;
function TCustomerInfoModule.DeleteScheduleSSReportAjax(AQueryFields, AContentFields: TStrings; ARNID: string): string;
var
SchedSC,EmpIdent,EmployeeGUID :string;
begin
   SchedSC := NumericOnly(AQueryFields.Values['SchedSC']);
   GetEmpIdentAndGuid(EmpIdent, EmployeeGUID);
   ProcessLog(ltInfo,'DELETESSREPORTAJAX EmpIdent;RNID;SchedSC',EmpIdent+';'+ARNID+';'+SchedSC);

   ttSSReporting := TttSSReporting.Create(PL.ProcessLog,RNDB,DoGetAppServerEvent);
   ttSSReporting.ChainCode := ChainCode;
   ttSSReporting.SQLwithTZ := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE'));
   ProcessLog(ltDebug,'DELETESSREPORTAJAX ChainCode',IntToStr(ChainCode));
   result := ttSSReporting.DeleteSSSchedule(SchedSC,EmpIdent,ARNID,EmployeeGUID);

   FreeAndNil(ttSSReporting);
end;

function TCustomerInfoModule.DeleteSSReportAjax(AQueryFields,AContentFields: TStrings; ARNID: string): string;
var
ReportGUID,EmpIdent,EmployeeGUID :string;
begin
   ReportGUID := GUIDOnly(AQueryFields.Values['ReportGUID']);
   GetEmpIdentAndGuid(EmpIdent, EmployeeGUID);
   ProcessLog(ltInfo,'DELETESSREPORTAJAX EmpIdent;RNID;ReportGuid',EmpIdent+';'+ARNID+';'+ReportGUID);

   ttSSReporting := TttSSReporting.Create(PL.ProcessLog,RNDB,DoGetAppServerEvent);
   ttSSReporting.ChainCode := ChainCode;
   ttSSReporting.SQLwithTZ := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE'));
   ProcessLog(ltDebug,'DELETESSREPORTAJAX ChainCode',IntToStr(ChainCode));
   Result := ttSSReporting.DeleteSSReport(ReportGUID,EmpIdent,ARNID,EmployeeGUID);
   FreeAndNil(ttSSReporting);
end;

function TCustomerInfoModule.GetSavedSSReportAjax(AQueryFields, AContentFields: TStrings; const ARNID: string): string;
var
   ReportGUID, EmpIdent, EmployeeGUID :string;
   usingNewSSRT: boolean;
begin
   GetEmpIdentAndGuid(EmpIdent, EmployeeGUID);
   ProcessLog(ltInfo,'GETSAVEDSSREPORTAJAX EmpIdent;RNID',EmpIdent+';'+ARNID);

   usingNewSSRT := strtobool(OpenXMLGetTag('/CONFIGDATA/TAB[@name="SSRT"]/ENABLE', 'FALSE'));

   ttSSReporting := TttSSReporting.Create(PL.ProcessLog,RNDB,DoGetAppServerEvent);
   ttSSReporting.ChainCode := ChainCode;
   ProcessLog(ltDebug,'SAVESSREPORTAJAX ChainCode',IntToStr(ChainCode));
   ttSSReporting.SQLwithTZ := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE'));
   ttSSReporting.ReportTZ := GetTimeZoneBiasNameStringByNumber(ValidCharsOnly(Request.QueryFields.Values['ReportTimeZone'],false,true,'-+'));
   Result := ttSSReporting.GetSavedReportsGrid(EmpIdent,ARNID,EmployeeGUID, usingNewSSRT);
   FreeAndNil(ttSSReporting);
end;

procedure TCustomerInfoModule.GetEmpIdentAndGuid(out tEmpIdent, tEmpGUID : string);
begin
   tEmpIdent := SessionVarEval.GetValueAsString('Session.Username');
   if (tEmpIdent = '') then begin
      tEmpIdent := trim(ExternalXMLGetTag('/EXTERNALXML/USERNAME'));
   end else begin
      tEmpGUID := GetEmployeeGUIDFromUsername(tEmpIdent);
   end;
end;

function TCustomerInfoModule.GetSSReportAjaxDownload(AQueryFields,AContentFields: TStrings; ARNID: string): string;
begin

end;

function TCustomerInfoModule.GetSSReportGUIDAjaxDownload(AQueryFields, AContentFields: TStrings; ARNID: string): string;
begin

end;

function TCustomerInfoModule.DownloadSSRun(AQueryFields, AContentFields : TStrings; const ARNID : string; out fileName : string) : TMemoryStream;
var
   systemCode, GUID, filePath, empId, empGUID : string;
   memStream : TMemoryStream;
begin
   memStream := TMemoryStream.Create();

   systemCode := ValidCharsOnly(AQueryFields.Values['SYSCODE'], false, true, ''); // Used to get specific row from db
   GUID := GUIDOnly(AQueryFields.Values['GUID']); // Used to get specific run from row
   filePath := OpenXMLGetTag('/CONFIGDATA/SSRTROOTFOLDER'); // Determines where the file we want to download is
   GetEmpIdentAndGuid(empId, empGUID); // Sets the empIdent/empguid

   ttSSReporting := TttSSReporting.Create(PL.ProcessLog, RNDB, DoGetAppServerEvent);
   ttSSReporting.SQLwithTZ := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE'));
   fileName := ttSSReporting.GetRunFileName(systemCode, GUID, ARNID, empId, empGUID); // Gets the filename of the run from the db
   filePath := AddBackslash(filePath) + systemCode + '\' + fileName; // Create a full file path with filename   Ex: Drive:\RootFolder\systemcode\filepath
   if Pos('r:',filePath) >= 0 then begin
      ProcessLog(ltDebug, 'filePath include r; map drive',filepath);
      Utility.MapDriveLetter('r:',
                OpenXMLGetTag('/CONFIGDATA/DRIVEMAPPING/NETWORKSHARE', '\\RNDB02\CORPSYS'),
                OpenXMLGetTag('/CONFIGDATA/DRIVEMAPPING/USERNAME', 'RNDB02\RNEMP'),
                OpenXMLGetTag('/CONFIGDATA/DRIVEMAPPING/PASSWORD', 'RNEmpTem120*1'),
                PL.ProcessLog);
   end;
   try
      memStream.LoadFromFile(filePath); // Loads the file into dynamic memory
      memStream.Position := 0;
   except
      on E: Exception do begin
         ProcessLog(ltWarning, 'Exception on DownloadSSRun', E.ClassName + ': ' + E.Message + ';  filepath = ' + filepath);
      end;
   end;
   Result := memStream;
end;

function TCustomerInfoModule.GetMimeTypeFromFileName(const fileName : string) : string;
var
   extension : string;
begin
   extension := extractFileExt(fileName);

   if extension = '.xls' then Result := 'application/vnd.ms-excel'
   else if extension = '.csv' then Result := 'text/csv'
   else if extension = '.xlsx' then Result := 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
   else if extension = '.xlsm' then Result := 'application/vnd.ms-excel.sheet.macroEnabled.12'
   else if extension = '.xlsb' then Result := 'application/vnd.ms-excel.sheet.binary.macroEnabled.12'
   else if extension = '.ods' then Result := 'application/vnd.oasis.opendocument.spreadsheet'
   else Result := 'text/plain';
end;

function TCustomerInfoModule.DeleteSSRun(AQueryFields, AContentFields : TStrings; const ARNID : string) : string;
var
   systemCode, GUID, filePath, fileName, deletionStatus, empId, empGUID : string;
begin
   deletionStatus := 'Failure';
   
   systemCode := ValidCharsOnly(AContentFields.Values['SYSTEMCODE'], false, true, ''); // Used to get specific row from db
   GUID := GuidOnly(AContentFields.Values['GUID']); // Used to get specific run from row
   filePath := OpenXMLGetTag('/CONFIGDATA/SSRTROOTFOLDER'); // Determines where the file we want to download is
   GetEmpIdentAndGuid(empId, empGUID); 
   
   ttSSReporting := TttSSReporting.Create(PL.ProcessLog, RNDB, DoGetAppServerEvent);
   ttSSReporting.SQLwithTZ := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE'));
   fileName := ttSSReporting.GetRunFileName(systemCode, GUID, ARNID, empId, empGUID); // Gets the filename of the run from the db
   filePath := AddBackslash(filePath) + systemCode + '\' + fileName; // Create a full file path with filename   Ex: Drive:\RootFolder\systemcode\filepath

   if ttSSReporting.DeleteSSRun(systemCode, GUID, ARNID, empId, empGUID) then begin // If the run was successfully removed...
      if fileExists(filePath) then begin // Check if the file exists and delete it
         if NOT deleteFile(filePath) then begin // If it was unable to be delete it send a message...
            ProcessLog(ltWarning, 'DeleteSSRun Exception', 'Unable to delete ' + filePath); // Hopefully someone will notice that it wasn't deleted
         end;
      end;

      deletionStatus := 'Success';
   end;

   Result := deletionStatus;
end;

function TCustomerInfoModule.GetSSReportHeaders(AQueryFields,AContentFields: TStrings; ARNID: string): string;
var
DisplayFormat : string;
ReportFormat: TReportFormatType;
begin
   result := '';
   DisplayFormat := ValidCharsOnly(AQueryfields.Values['DisplayType'],True,false,'');
   if (DisplayFormat <> '') then begin
      ReportFormat := StrToReportFormat(DisplayFormat);
      if (ReportFormat = ttrpftGrid) then begin
          result := GenerateReportGridHeaders();
      end;
   end;
end;

function TCustomerInfoModule.GetSSReportXMLAjax(AQueryFields, AContentFields: TStrings; ARNID: string): string;
var
ReportGUID,EmpIdent,EmployeeGUID :string;
begin
   ReportGUID := GUIDOnly(AQueryFields.Values['ReportGUID']);
   GetEmpIdentAndGuid(EmpIdent, EmployeeGUID);
   ttSSReporting := TttSSReporting.Create(PL.ProcessLog,RNDB,DoGetAppServerEvent);
   ttSSReporting.ChainCode := ChainCode;
   ttSSReporting.SQLwithTZ := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE'));
   result := ttSSReporting.GetSSReportXML(ReportGUID,EmpIdent,ARNID,EmployeeGUID);
end;

function TCustomerInfoModule.GetSSRNIDHeaders(AQueryFields,AContentFields: TStrings; ARNID: string): string;
var
DisplayFormat : string;
ReportFormat: TReportFormatType;
begin
   Result := '';
   DisplayFormat := ValidCharsOnly(AQueryfields.Values['DisplayType'],True,false,'');
   if (DisplayFormat <> '') then begin
      ReportFormat := StrToReportFormat(DisplayFormat);
      if (ReportFormat = ttrpftGrid) then begin
          Result := GenerateRNIDGridHeaders();
      end;
   end;
end;

function TCustomerInfoModule.GetSSStoreAttrGridAjax(AQueryFields, AContentFields: TStrings; ARNID: string): string;
var
StoreAttr : TTTStringList;
begin
   StoreAttr := TTTStringList.Create;
   RecursionDepth := 0;
   if GetStoreAttrOptionsSL(StoreAttr,NumericOnly(AQueryfields.Values['AttrNum'])) then begin  //false means we weren't able to open the query
      Result :=  StoreAttrSLToDHTMLXGrid(StoreAttr); //2018-02-02 jtm: F#3765
   end else begin
      Result := '';
   end;
   FreeAndNil(StoreAttr);
end;

function TCustomerInfoModule.SaveSSReportAjax(AQueryFields, AContentFields: TStrings; ARNID: string): string;
var
ReportGUID,ReportName,ReportDescription,EmpIdent,EmployeeGUID,WS2 :string;
begin
   ReportGUID := GUIDOnly(AQueryFields.Values['ReportGUID']);
   ReportName := ValidCharsOnly(AContentFields.Values['ReportName'],true,true,'.,-_&+=:;''/ ');
   ReportDescription := ValidCharsOnly(AContentFields.Values['ReportDescription'],true,true,'.,-_&+=:;''/ ');
   ProcessLog(ltInfo,'SAVESSREPORTAJAX ReportGUID;ReportName',ReportGUID+';'+ReportName);
   GetEmpIdentAndGuid(EmpIdent, EmployeeGUID);

   ProcessLog(ltDebug,'SAVESSREPORTAJAX GenerateReportXMLFromRequest result',WS2);
   ttSSReporting := TttSSReporting.Create(PL.ProcessLog,RNDB,DoGetAppServerEvent);
   ttSSReporting.HeaderDelimiter := ',';
   ttSSReporting.ChainCode := ChainCode;
   ttSSReporting.SQLwithTZ := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE'));
   ttSSReporting.ttWebUtility := ttWebUtility;
   ttSSReporting.WebConfigXML := ttSSReporting.ttWebUtility.DomainConfigXML;
   WS2 := ttSSReporting.GenerateReportXMLFromRequest(AContentFields);

   ProcessLog(ltDebug,'SAVESSREPORTAJAX ChainCode',IntToStr(ChainCode));
   result := ttSSReporting.SaveSSReportData(WS2,EmpIdent,ARNID,ReportGUID,ReportName,ReportDescription,EmployeeGUID);

   FreeAndNil(ttSSReporting);
end;
function TCustomerInfoModule.GenerateReportXMLFromRequest(ASL : TStrings): String;
const
   METHOD_NAME = 'TCustomerInfoModule.GenerateReportXMLFromRequest';
var
i, iter, it, hierIndex, stnum, count: integer;
StoreField1, StoreField2, StoreField3, ctCredit, ctDebit, RNIDXMLStr, RNIDStr, FromDate, ThruDate, ws, convertedXML: string;
StoreFieldExists, RNIDChecked, newSSRTExists: boolean;

xmlsl, RNIDs, AllowedRNIDs, CardBrands, SaleTypes, StoreFields, StrAttr: TTTStringList;
RNIDXML : TOpenXML;
RNIDXMLNode : TOpenXMLNode;
begin
   result := '';
   xmlsl := TTTStringList.Create();
   xmlsl.Append('<REPORT>');
	xmlsl.Append('<HEADERFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/HEADERFIELDNAMES','RNID,Auth Date,Type,Amount,Tran Type,Auth Code,NonAuthResp,Check #,Batch Date,Batch ID,Emp Ident,Tran Ident,Cust Ident,Station Ident,Transerial')+'</HEADERFIELDNAMES>');
	xmlsl.Append('<CARDFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CARDFIELDNAMES','StoreCode|AuthDate|SaleType|TranAmt||AuthCode|NonAuthResp||BatchDate|BatchID|TranEmployeeIdent|TranIdent|TranCustomerCode|StationIdent|StoreSystemCode')+'</CARDFIELDNAMES>');
	xmlsl.Append('<CASHFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CASHFIELDNAMES','StoreCode|TranDate|TranType|TranAmt|CurrencyType||||BatchDate|BatchCode|EmpIdent|TranIdent|CustIdent|StationIdent|StoreSystemCode')+'</CASHFIELDNAMES>');
	xmlsl.Append('<CHECKFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/CHECKFIELDNAMES','StoreCode|AuthDate||TranAmount|TCServiceName|ECATranStatus|DisplayText|ResponseCheckNumber|BatchDate|BatchSerial|TranEmployeeIdent|TranIdent|TranCustomerCode|StationIdent|StoreSystemCode')+'</CHECKFIELDNAMES>');
	xmlsl.Append('<OPENCARDFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/OPENCARDFIELDNAMES','')+'</OPENCARDFIELDNAMES>');
	xmlsl.Append('<OPENCASHFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/OPENCASHFIELDNAMES','')+'</OPENCASHFIELDNAMES>');
	xmlsl.Append('<OPENCHECKFIELDNAMES>'+ OpenXMLGetTag('/CONFIGDATA/SUPERREPORT/OPENCHECKFIELDNAMES','')+'</OPENCHECKFIELDNAMES>');
   xmlsl.Append('<USEBATCHFIELDSEARCH>' + OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEBATCHFIELDSEARCH','FALSE') + '</USEBATCHFIELDSEARCH>'); //2018-06-20 bls: F#2227
   xmlsl.Append('<SEARCHFILTERS>');
      xmlsl.Append('<TENDERTYPES>');
         xmlsl.Append('<CARDSEARCH>'+NumToBoolStr(NumericOnly(ASL.Values['SearchCard']))+'</CARDSEARCH>');
         xmlsl.Append('<CHECKSEARCH>'+NumToBoolStr(NumericOnly(ASL.Values['SearchCheckPaper']))+'</CHECKSEARCH>');
         xmlsl.Append('<ACHSEARCH>'+NumToBoolStr(NumericOnly(ASL.Values['SearchACH']))+'</ACHSEARCH>');
         xmlsl.Append('<CASHSEARCH>'+NumToBoolStr(NumericOnly(ASL.Values['SearchCash']))+'</CASHSEARCH>');
         xmlsl.Append('<VOUCHERSEARCH>'+NumToBoolStr(NumericOnly(ASL.Values['SearchVoucher']))+'</VOUCHERSEARCH>');
      xmlsl.Append('</TENDERTYPES>');
      xmlsl.Append('<DATERANGE>');

      ProcessLog(ltDebug,'GenerateReportXMLFromRequest: Fromdate before format',ASL.Values['FromDate']);

      FromDate := ASL.Values['FromDate'];
      ThruDate := ASL.Values['ThruDate'];
      ReplaceString(FromDate,'%2F','/');
      ReplaceString(ThruDate,'%2F','/');

      ProcessLog(ltDebug,'GenerateReportXMLFromRequest: Fromdate after format', FromDate);
         xmlsl.Append('<FROMDATE>'+ValidCharsOnly(FromDate,false,true,'/')+'</FROMDATE>');
         xmlsl.Append('<THRUDATE>'+ValidCharsOnly(ThruDate,false,true,'/')+'</THRUDATE>');
         xmlsl.Append('<RANGE>'+DateRangeNumToStr(NumericOnly(ASL.Values['daterange']))+'</RANGE>'); //2018-04-11 jtm F#3540
      xmlsl.Append('</DATERANGE>');
      xmlsl.Append('<BATCHSTATUS>');
         xmlsl.Append('<OPENBATCHSEARCH>'+NumToBoolStr(NumericOnly(ASL.Values['OpenBatchSearch']))+'</OPENBATCHSEARCH>');
         xmlsl.Append('<CLOSEDBATCHSEARCH>'+NumToBoolStr(NumericOnly(ASL.Values['ClosedBatchSearch']))+'</CLOSEDBATCHSEARCH>');
      xmlsl.Append('</BATCHSTATUS>');

      ctCredit := NumToBoolStr(NumericOnly(ASL.Values['SearchCTCredit'])); //2018-10-10 bls DVST-2245
      ctDebit := NumToBoolStr(NumericOnly(ASL.Values['SearchCTDebit']));

      xmlsl.Add('<CARDTYPE>');
      if ctCredit <> '' then xmlsl.Add('<CTCREDIT>' + ctCredit + '</CTCREDIT>');
      if ctDebit <> '' then xmlsl.Add('<CTDEBIT>' + ctDebit + '</CTDEBIT>');
      xmlsl.Add('</CARDTYPE>');

      RNIDs := TTTStringList.Create();
      AllowedRNIDs := TTTStringList.Create();
      GenerateAllLocationOptionsSL(RNIDs);

      Try
         if ASL.Values['RNIDGRIDDATA'] <> '' then begin
            RNIDXMLStr := ASL.Values['RNIDGRIDDATA'];
         end else begin
            RNIDXMLStr := '<?xml version="1.0" encoding="ISO-8859-1"?><rows></rows>';
         end;
         RNIDXML := TOpenXML.CreateFromString(Nil,RNIDXMLStr);
      except
         On E:Exception do begin
            Processlog(ltWarning, 'OpenXMLLoad Exception processing RNIDXML RNIDGRIDDATA',E.Message);
            If Assigned(RNIDXML) then FreeAndNil(RNIDXML);
            exit;
         end;
      end;

      ProcessLog(ltInfo,'RNIDGRIDDATA;', ASL.Values['RNIDGRIDDATA']);
      if (RNIDXML.GetNode('/rows') <> nil) then begin
         RNIDXMLNode :=  RNIDXML.GetNode('/rows').FindFirstChildElement;
         while (RNIDXMLNode <> nil) do begin
            RNIDChecked :=  RNIDXML.GetContextValueAsBoolean(RNIDXMLNode,'cell[1]'); //comes back as '0' or '1'
            RNIDStr := RNIDXML.GetContextValueAsWideString(RNIDXMLNode,'cell[2]'); //RNID
            if (RNIDChecked) then begin
               if (UpperCase(RNIDStr) = 'ALL') then begin
                  AllowedRNIDs.CommaText := RNIDs.CommaText;
                  break;
               end else begin
                  AllowedRNIDs.Append(RNIDStr);
               end;
            end;
            RNIDXMLNode := RNIDXMLNode.FindNextSiblingElement;
         end;
      end;
      RNIDXML.Free;

      xmlsl.Append('<RNIDS>'+AllowedRNIDs.CommaText+'</RNIDS>');

      StoreField1 := ValidCharsOnly(ASL.Values['StoreField1'], true, true, '-,. '); //2018-10-10 bls DVST-2245
      StoreField2 := ValidCharsOnly(ASL.Values['StoreField2'], true, true, '-,. ');
      StoreField3 := ValidCharsOnly(ASL.Values['StoreField3'], true, true, '-,. ');
      if StoreField1 <> '' then xmlsl.Add('<STOREFIELD1>' + StoreField1 + '</STOREFIELD1>');
      if StoreField2 <> '' then xmlsl.Add('<STOREFIELD2>' + StoreField2 + '</STOREFIELD2>');
      if StoreField3 <> '' then xmlsl.Add('<STOREFIELD3>' + StoreField3 + '</STOREFIELD3>');

   xmlsl.Append('</SEARCHFILTERS>');

   xmlsl.Append('<SEARCHFIELDS>');
   xmlsl.Append('<CARDLASTFOUR>'+ValidCharsOnly(ASL.Values['last4'],false,true,',')+'</CARDLASTFOUR>');
   xmlsl.Append('<EMPIDENT>'+ValidCharsOnly(ASL.Values['empident'],true,true,'.\-_:/&,')+'</EMPIDENT>');
   xmlsl.Append('<TRANIDENT>'+ValidCharsOnly(ASL.Values['tranident'],true,true,'.\-_:/&,')+'</TRANIDENT>');
   xmlsl.Append('<CUSTIDENT>'+ValidCharsOnly(ASL.Values['custident'],true,true,'.\-_:/&,')+'</CUSTIDENT>');
   xmlsl.Append('<STORESYSTEMCODES>'+ValidCharsOnly(ASL.Values['transerial'],false,true,',')+'</STORESYSTEMCODES>');
   xmlsl.Append('<CARDNAME>'+ValidCharsOnly(ASL.Values['cardname'],true,true,'/-,')+'</CARDNAME>');

      CardBrands := TTTStringList.Create();
      if (NumToBoolStr(NumericOnly(ASL.Values['SearchAllCardBrands']))= 'FALSE') then begin
         if (NumToBoolStr(NumericOnly(ASL.Values['SearchVisa']))= 'TRUE') then begin
            CardBrands.Append('VISA');
         end;
         if (NumToBoolStr(NumericOnly(ASL.Values['SearchMC']))= 'TRUE') then begin
            CardBrands.Append('MC');
         end;
         if (NumToBoolStr(NumericOnly(ASL.Values['SearchDisc']))= 'TRUE') then begin
            CardBrands.Append('DISC');
         end;
         if (NumToBoolStr(NumericOnly(ASL.Values['SearchAmex']))= 'TRUE') then begin
            CardBrands.Append('AMEX');
         end;
         if (NumToBoolStr(NumericOnly(ASL.Values['SearchOtherBrand']))= 'TRUE') then begin
            CardBrands.Append('OTHER');
         end;
      end else begin // 2019-4-17 ss DVST-2897
         CardBrands.Append('ALL');
      end;

      xmlsl.Append('<CARDBRAND>'+CardBrands.CommaText+'</CARDBRAND>'); ///TODO multiple cards

      SaleTypes := TTTStringList.Create();
      if (NumToBoolStr(NumericOnly(ASL.Values['SearchAllSaleTypes']))= 'FALSE') then begin
         if (NumToBoolStr(NumericOnly(ASL.Values['SearchSTCredit']))= 'TRUE') then begin
            SaleTypes.Append('CREDIT');
         end;
         if (NumToBoolStr(NumericOnly(ASL.Values['SearchSTReversal']))= 'TRUE') then begin
            SaleTypes.Append('REVERSAL');
         end;
         if (NumToBoolStr(NumericOnly(ASL.Values['SearchSTSale']))= 'TRUE') then begin
            SaleTypes.Append('SALE');
         end;
         if (NumToBoolStr(NumericOnly(ASL.Values['SearchSTVoid']))= 'TRUE') then begin
            SaleTypes.Append('VOID');
            SaleTypes.Append('CRVOID');
         end;
         if (NumToBoolStr(NumericOnly(ASL.Values['SearchSTDebit']))= 'TRUE') then begin
            SaleTypes.Append('DEBIT');
         end;
         if (NumToBoolStr(NumericOnly(ASL.Values['SearchSTRefund']))= 'TRUE') then begin
            SaleTypes.Append('REFUND');
         end;
      end else begin // 2019-4-17 ss DVST-2897
         SaleTypes.Append('ALL');
      end;
      
      xmlsl.Append('<SALETYPE>'+SaleTypes.CommaText+'</SALETYPE>'); ///TODO multiple types


      
      xmlsl.Append('<MID>'+ValidCharsOnly(ASL.Values['mid'],false,true,',')+'</MID>');
      xmlsl.Append('<AUTHCODE>'+ValidCharsOnly(ASL.Values['authcode'],true,true,',')+'</AUTHCODE>');
      xmlsl.Append('<DEPOSITSLIP>'+ValidCharsOnly(ASL.Values['depositslip'],true,true,',')+'</DEPOSITSLIP>');
      xmlsl.Append('<BAGNUMBER>'+ValidCharsOnly(ASL.Values['bagnumber'],true,true,',')+'</BAGNUMBER>');

      xmlsl.Append('<STATIONIDENT>'+ValidCharsOnly(ASL.Values['stationident'],true,true,'.\-_:/&,')+'</STATIONIDENT>');
      xmlsl.Append('<SETTLEDONLY>'+NumericOnly(ASL.Values['settleonly'])+'</SETTLEDONLY>');
      xmlsl.Append('<DOLLARAMT>'+ValidCharsOnly(ASL.Values['tranamt'],false,true,'.')+'</DOLLARAMT>');
      xmlsl.Append('<DOLLARAMTCOMP>'+NumericOnly(ASL.Values['dollaramtcomp'])+'</DOLLARAMTCOMP>');
   xmlsl.Append('</SEARCHFIELDS>');

   xmlsl.Append('</REPORT>');

result := xmlsl.Text;
Processlog(ltInfo, 'GenerateReportXMLFromRequest result',xmlsl.Text);
FreeAndNil(RNIDs);
FreeAndNil(AllowedRNIDs);
FreeAndNIl(CardBrands);
FreeAndNil(SaleTypes);
end;



function TCustomerInfoModule.TextWithoutNewLine(sL : TStringList) : string; //2018-07-18 bls: F#4978
var
  I, L, Size, Count: Integer;
  P: PChar;
  S: string;
begin
  Count := sL.Count; // GetCount; // Get amount of strings in stringlist
  Size := 0;
  for I := 0 to Count - 1 do Inc(Size, Length(sL.Strings[I])); // Increases size by each string
  SetString(Result, nil, Size); // Sets the size of the resulting string
  P := Pointer(Result); // points to the address of the resulting string
  for I := 0 to Count - 1 do // For every string...
  begin
    S := sL.Strings[I]; // Get the string at index i
    L := Length(S); // Get its length

    if L <> 0 then // If its length is not 0...
    begin
      System.Move(Pointer(S)^, P^, L); // Copies the string to the resulting string
      Inc(P, L); // increases the pointer to the end of that string's length
    end;
  end;
end;

function TCustomerInfoModule.SavedReportNameExists(AQueryFields, AContentFields: TStrings; ARNID: string): string;
var
ReportGUID,ReportName,ReportDescription,EmpIdent,EmployeeGUID,WS2 :string;
begin
   ReportName := ValidCharsOnly(AContentFields.Values['ReportName'],true,true,'.,-_&+=:;''/ ');
   GetEmpIdentAndGuid(EmpIdent, EmployeeGUID);
   ProcessLog(ltInfo,'CheckSavedReportName EmpIdent;EmployeeGUID;ReportName',EmpIdent+';'+ EmployeeGUID+';'+ReportName);

   ttSSReporting := TttSSReporting.Create(PL.ProcessLog,RNDB,DoGetAppServerEvent);

   result := booltostr(ttSSReporting.CheckForSavedSSReport(EmpIdent,ARNID,ReportName,EmployeeGUID));
   ProcessLog(ltInfo,'CheckSavedReportName result',result);
   FreeAndNil(ttSSReporting);

end;

Function TCustomerInfoModule.GetCardQueryTable5000(const AQueryFields, AContentFields: TStrings; xExport : TOExport) : string;
var
   RecordFormatType : TRecordFormatType;

   TabText : TTTStringList;
   RNIDList, ServNameList, ServNameDescList : TStringList;
   QueryOptions : TStrings;
   xlsWorkSheet : TExportWorksheet;

   CCResults : TDataSet;

   DisplayFormat, TranIdentHeader, CustIdentHeader, AVSDataHeader, StoreSystemCodeLabel, Header, CustomField1Value, CustomField2Value, CustomField3Value, CustomField4Value, CustomField5Value, CustomField6Value,
      LocationRNID, CardName, CustIdent, DollarAmt, DollarAmtComp, EmpIdent, LastFour, TranHistFrom, TranHistSettlementStatus, TranHistThru, TranHistType, TranIdent : string;

   UsingAll, DisplayStoreName, DisplayInTZ, IncludeEmpIdent, IncludeServiceName, IncludeServiceNameDesc, IncludeCardHolderName, IncludeProfileFields, ExcludeExtraAmount,
      IncludeSFINDICATOR, IncludeCVVResp, IncludeAVSResp, IncludeAVSData, IncludeOtherCardType, AAllowAll, ASeparateStores, ShowLinks : boolean;

   Procedure GetProfileInfo(const AStoreCode : String);
   begin
      if (assigned(ProfileXML)) then begin
         FreeAndNil(ProfileXML);
      end;
      if AStoreCode <> '' then begin
         ProfileXML := TTProfileXML.Create(StrToInt(AStoreCode), HDQuery);
         CustomField1Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD1/VALUE', '');
         CustomField2Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD2/VALUE', '');
         CustomField3Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD3/VALUE', '');
         CustomField4Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD4/VALUE', '');
         CustomField5Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD5/VALUE', '');
         CustomField6Value := ProfileXML.GetXMLValueAsString('/PROFILE/DRAWERSETTINGS/CUSTOMFIELDS/FIELD6/VALUE', '');
      end else begin
         CustomField1Value := '';
         CustomField2Value := '';
         CustomField3Value := '';
         CustomField4Value := '';
         CustomField5Value := '';
         CustomField6Value := '';
      end;
      if (assigned(RNProfileDI)) then begin
         FreeAndNil(RNProfileDI);
      end;
      if (assigned(RNProfile)) then begin
         FreeAndNil(RNProfile);
      end;
      RNProfileDI := TTADODataLayer.Create(RNDB);
      RNProfile := TTProfile.Create(AStoreCode,false, RNProfileDI);
   end;

   Function ProcessHeader(const AStoreCode: String; const ADetailRecsExists: Boolean) : string;
   var
      HeaderList : TStringList;
   begin

   end;

   Function FormatXLS(const HeaderInfo : string) : String;
   var
      oldXLS : TStringList;
   begin
      oldXLS := TStringList.Create();

   end;

   Function FormatHTML(const HeaderInfo : string; const isHTMLTable : boolean) : string;
   var
      HTML : TStringList;
   begin

   end;

   Function FormatJSON(const HeaderInfo : string) : String;
   var
      JSON : TStringList;
   begin

   end;

   Function FormatGRID(const HeaderInfo : string) : String;
   var
      GRID : TStringList;

      PreviousRNID : Variant;
      rnidStr, MaskAcct : string;
      ServiceNamesByRNID, Index : integer;
      rnidField, scField : TField;
      scIsNull : boolean;
   begin
      GRID := TStringList.Create();
      GRID.Add('{"total_count":' + SessionVarEval.GetValueAsString('totalCount') + ', "pos":' + AQueryFields.Values['posStart'] + ',"rows":[');

      PreviousRNID := Null;
      rnidField := CCResults.FieldByName('RNID');
      scField := CCResults.FieldByName('StoreCode');

      rnidStr := Trim(rnidField.AsString);
      scIsNull := scField.IsNull;
      while NOT CCResults.EOF do begin
         if (PreviousRNID <> rnidStr) then begin
            GetProfileInfo(rnidStr); //2017-05-10 jtm F#1696
            if (IncludeServiceName) then begin //2018-01-29 jtm: D#3693
               ServiceNamesByRNID := GetServiceNamesByRNID(rnidStr, '', ServNameList, ServNameDescList);
            end;
            PreviousRNID := rnidStr;
         end;

         if (scIsNull) then begin
            CCResults.Next;
            continue;
         end;
         GRID.Add('{"id":' + CCResults.FieldByName('row').AsString + ',"data":[');
         GRID.Add('"' + Trim(CCResults.FieldByName('StoreCode').AsString) + '",');

         if DisplayStoreName then begin  //2018-04-30 bls: F#1129
            GRID.Add('"' + Trim(CCResults.FieldByName('NAME').AsString) + '",');
         end;

         if (DisplayInTZ) then begin //2017-12-20 jtm: D#2620 //2018-04-11 jtm: F#3664 removed
            GRID.Add('"' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', CCResults.FieldByname('AuthDatetz').AsDateTime)) + '",');
         end else begin
            GRID.Add('"' + Trim(FormatDateTime('MM/DD/YYYY HH:NN:SS', CCResults.FieldByname('AuthDate').AsDateTime)) + '",');
         end;

         GRID.Add('"' + Trim(CCResults.FieldByName('SaleType').AsString) + '",');

         if (Trim(CCResults.FieldByName('SaleType').AsString) = 'CREDIT') or (Trim(CCResults.FieldByName('SaleType').AsString) = 'REFUND') then begin   //2017-11-16 jtm: D#2021
            GRID.Add('"(' + Trim(Format('%m',[CCResults.FieldByName('TranAmt').AsFloat])) + ')",');
         end else if Trim(CCResults.FieldByName('SaleType').AsString) = 'VOID' then begin
            GRID.Add('"<DEL>' + Trim(Format('%m',[CCResults.FieldByName('TranAmt').AsFloat])) + '<\/DEL>",');
         end else begin
            GRID.Add('"' + Trim(Format('%m',[CCResults.FieldByName('TranAmt').AsFloat])) + '",');
         end;

         If (Trim(CCResults.FieldByName('SaleType').AsString) = 'CREDIT') or (Trim(CCResults.FieldByName('SaleType').AsString) = 'REFUND') then begin   //2017-11-16 jtm: D#2021
            GRID.Add('"<IMG SRC=\"\/Images\/General\/CashSmall.gif\" border=\"0\" style=\"display: inline-block\" \/>');
            if (Trim(CCResults.FieldByName('SaleType').AsString) = 'CREDIT') then begin
                GRID.Add('",');
            end else begin
                GRID.Add(Trim(CCResults.FieldByName('AuthCode').AsString) + '",');
            end;

         end else if (Trim(CCResults.FieldByName('SaleType').AsString) = 'VOID') or (Trim(CCResults.FieldByName('SaleType').AsString) = 'CRVOID') then begin  //2017-11-16 jtm: D#2021
            GRID.Add('"<IMG SRC=\"\/Images\/General\/YellowExclamation.gif\" border=\"0\" style=\"display: inline-block\" \/>');
            GRID.Add(trim(CCResults.FieldByName('AuthCode').AsString) + '",');
         end else if Trim(CCResults.FieldByName('AuthCode').AsString) <> '' then begin
            GRID.Add('"<IMG SRC=\"\/Images\/General\/CheckSuccess.gif\" border=\"0\" style=\"display: inline-block\" \/>');
            GRID.Add('<font color=\"GREEN\">' + trim(CCResults.FieldByName('AuthCode').AsString) + '<\/FONT>",');
         end else begin
            GRID.Add('"<IMG SRC=\"\/Images\/General\/XFailed.gif\" border=\"0\" style=\"display: inline-block\" \/>');
            GRID.Add('<font color=\"Red\">' + trim(CCResults.FieldByName('NonAuthResp').AsString) + '<\/FONT>",');
         end;

         MaskAcct := '';
         if (Trim(CCResults.FieldByName('CardAcct').AsString) <> '') then begin  //2017-03-22 jtm: F#2430
            if (Trim(CCResults.FieldByName('ProcessorToken').AsString) <> '') then begin  //card number sent in, but either tokenized or not
               MaskAcct := MaskStr(Trim(CCResults.FieldByName('ProcessorToken').AsString), DigitsToMask(Trim(CCResults.FieldByName('ProcessorToken').AsString)));
               MaskAcct := '*..*' + NumericOnly(MaskAcct);
            end else begin
               MaskAcct := Trim(CCResults.FieldByName('CardAcct').AsString);
               MaskAcct := 'X..X' + NumericOnly(MaskAcct);
            end;
         end else if (Trim(CCResults.FieldByName('CardAcct').AsString) = '')  and (Trim(CCResults.FieldByName('ProcessorToken').AsString) <> '') then begin //token passed directly
            MaskAcct := MaskStr(Trim(CCResults.FieldByName('ProcessorToken').AsString), DigitsToMask(Trim(CCResults.FieldByName('ProcessorToken').AsString)));
            MaskAcct := '#..#' + NumericOnly(MaskAcct);
         end;

         GRID.Add('"' + Trim(CCResults.FieldByName('BatchDate').AsString) + '",');
         GRID.Add('"' + Trim(CCResults.FieldByName('BatchID').AsString) + '",');
         GRID.Add('"' + trim(CCResults.FieldByName('CardType').AsString) + '",');
         GRID.Add('"' + MaskAcct + '",');
         GRID.Add('"' + trim(CCResults.FieldByName('TranIdent').AsString) + '",');
         GRID.Add('"' + trim(CCResults.FieldByName('TranCustomerCode').AsString) + '",');

         if IncludeServiceName then begin  //2018-01-25 ajs: F#2378
            if IncludeServiceNameDesc then begin
               Index :=  ServNameList.IndexOf(trim(CCResults.FieldByName('CCServiceName').AsString));
               if (Index = -1) then begin
                   GRID.Add('"' + Trim(CCResults.FieldByName('CCServiceName').AsString) + '",');
               end else begin
                   GRID.Add('"' + ServNameDescList[Index] + '",');
               end;
            end else begin
               GRID.Add('"' + Trim(CCResults.FieldByName('CCServiceName').AsString) + '",');
            end;
         end;

         if IncludeEmpIdent then  GRID.Add('"' + Trim(CCResults.FieldByName('TranEmployeeIdent').AsString) + '",');
         if IncludeCardHolderName then  GRID.Add('"' + Trim(CCResults.FieldByName('CardName').AsString) + '",');
         if IncludeSFINDICATOR then begin
            if (Trim(CCResults.FieldByName('SFTranGUID').AsString) <> '') then begin
                GRID.Add('"' + 'X' + '",');
            end else begin
                GRID.Add('"' + ' ' + '",');
            end;
         end;
         if IncludeCVVResp then GRID.Add('"' + Trim(CCResults.FieldByName('CVVResp').AsString) + '",'); //2018-3-14 ajs: F#3629
         if IncludeAVSResp then GRID.Add('"' + Trim(CCResults.FieldByName('AVSResp').AsString) + '",'); //2018-3-14 ajs: F#3629
         if IncludeAVSData then GRID.Add('"' + Trim(CCResults.FieldByName('AVSData').AsString) + '",'); // 2019-06-15 tjr: DVST-564

         GRID.Append('"' + GetCCTranEntryModeDisplayCode(CCResults.FieldByName('TranEntryMode').AsString) + '",');

         GRID.Append('"' + Trim(CCResults.FieldByName('StationIdent').AsString) + '",');

         If ShowLinks then begin
            if (AAllowAll) and (LocationRNID = 'ALL') then begin   //2016-6-28 jtm
               GRID.Add('"<a href=\"javascript:\/\/\" onclick=\"GetVTCardDetailAJAX(''' + trim(CCResults.FieldByName('StoreCode').AsString) + ''',''' + Trim(CCResults.FieldByName('StoreSystemCode').AsString) + ''')\">' + Trim(CCResults.FieldByName('StoreSystemCode').AsString) + '<\/a>"]}');
            end else begin
               GRID.Add('"<a href=\"javascript:\/\/\" onclick=\"GetVTCardDetailAJAX(''' + LocationRNID + ''','''+ CCResults.FieldByName('StoreSystemCode').AsString + ''')\">' + CCResults.FieldByName('StoreSystemCode').AsString + '<\/a>"]}');
            end;
         end else begin
            GRID.Add('"' + CCResults.FieldByName('StoreSystemCode').AsString + '"]}');
         end;

      end;
      GRID.Add(']}');
      Result := TextWithoutNewLine(GRID);
      GRID.Free;
   end;

   Function FormatXML(const HeaderInfo : string) : String;
   var
      XML : TStringList;
   begin

   end;
begin
   if (assigned(ProfileXML)) then begin
		FreeAndNil(ProfileXML);
	end;
	if (assigned(RNProfileDI)) then begin
		FreeAndNil(RNProfileDI);
	end;
	if (assigned(RNProfile)) then begin
		FreeAndNil(RNProfile);
	end;

   DisplayFormat := AQueryFields.Values['FORMAT'];

   LocationRNID := AQueryFields.Values['LOCATIONRNID'];
   if NOT (LocationRNID = 'ALL') then begin
      LocationRNID := NumericOnly(LocationRNID);
   end;

   TranIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CCTRANIDENTDESC', 'Tran Ident'));
   CustIdentHeader := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CCCUSTIDENTDESC', 'Cust Ident'));
   StoreSystemCodeLabel := trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SYSTEMCODELABEL', ''));
   TabText.Delimiter := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/PREFERREDDELIMITER', TAB)[1];

   DisplayStoreName := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/CARDHISTDISPLAYSTORENAME', 'FALSE'));
   DisplayInTZ := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE')) OR strtobool(RNReg.RegGetValAsString('PMACCESS.DISPLAYINTZ', 'FALSE'));
   IncludeEmpIdent := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEEMPIDENT', 'FALSE'));
   IncludeServiceName := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESERVICENAME', 'FALSE'));
   IncludeServiceNameDesc := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESERVICENAMEDESCRIPTION', 'FALSE'));
   IncludeCardHolderName := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDECARDHOLDERNAME', 'FALSE'));
   IncludeProfileFields := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEPROFILEFIELDS', 'FALSE'));
   ExcludeExtraAmount := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/EXCLUDEEXTRAAMOUNT', 'FALSE'));
   IncludeSFINDICATOR := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDESFINDICATOR', 'FALSE'));
   IncludeCVVResp := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDECVVRESP', 'FALSE'));
   IncludeAVSResp := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEAVSRESP', 'FALSE'));
   IncludeAVSData := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEAVSDATA', 'FALSE')); // 2019-06-15 tjr: DVST-564
   AVSDataHeader := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/AVSDATAHEADER', 'AVSDATA'); // 2019-06-15 tjr: DVST-564
   IncludeOtherCardType := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/INCLUDEOTHERCARDTYPE', 'FALSE'));
   AAllowAll := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/ALLOWALLSEARCH', 'FALSE'));

   RNIDList := TStringList.Create();
   if ((AAllowAll) and (LocationRNID = 'ALL')) then begin
      UsingAll := true;
      GetChainRNIDs(RNIDList);
   end else begin
      If NOT ValidateRNID(LocationRNID) then begin
         Result := 'Invalid Store Code';
         exit;
      end;
      UsingAll := false;
      RNIDList.Add(NumericOnly(LocationRNID));
   end;

   QueryOptions := TStrings.Create();
   QueryOptions.AddStrings(AQueryFields);
   QueryOptions.AddStrings(AContentFields);
   QueryOptions.Values['DisplayInTZ'] := booltostr(DisplayInTZ);
   QueryOptions.Values['SearchEmpIdent'] := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHEMPIDENT', 'FALSE');
   QueryOptions.Values['SearchCardName'] := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHCARDNAME', 'FALSE');
   QueryOptions.Values['SearchTranIdent'] := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHTRANIDENT', 'FALSE');
   QueryOptions.Values['SearchDollarAmt'] := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHDOLLARAMT', 'FALSE');
   QueryOptions.Values['SearchCustIdent'] := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHCUSTIDENT', 'FALSE');
   QueryOptions.Values['SearchOnServiceName'] := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHONSERVICENAME', 'FALSE');

   CCResults := GetCardQueryData(RNDB, QueryOptions);
   CCResults.DisableControls;

   if (UsingAll) then begin
      Header := ProcessHeader('',true); //2017-05-10 jtm F#1696
   end else begin
      Header := ProcessHeader(Trim(RNQuery.FieldByName('RNID').AsString), not(RNQuery.FieldByName('StoreCode').IsNull));
   end;

   If DisplayFormat = 'XML' then begin
      Result := FormatXML(Header);
   end else If DisplayFormat = 'XLS'  then begin
      if xExport <> Nil then begin
         xlsWorkSheet := xExport.AddWorkSheet;
      end;
      Result := FormatXLS(Header);
   end else If DisplayFormat = 'AJAX' then begin
      if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SHOWCARDDETAILS', 'FALSE') = 'TRUE' then begin
         ShowLinks := True;
      end else begin
         ShowLinks := Not UserIs('READONLY', LocationRNID);
      end;
      Result := FormatHTML(Header, False);
   end else If DisplayFormat = 'JSON' then begin
      Result := FormatJSON(Header);
   end else If DisplayFormat = 'GRID' then begin
      if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SHOWCARDDETAILS', 'FALSE') = 'TRUE' then begin
         ShowLinks := True;
      end else begin
         ShowLinks := Not UserIs('READONLY', LocationRNID);
      end;
      Result := FormatGRID(Header);
   end else begin
      if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SHOWCARDDETAILS', 'FALSE') = 'TRUE' then begin
         ShowLinks := True;
      end else begin
         ShowLinks := Not UserIs('READONLY', LocationRNID);
      end;
      Result := FormatHTML(Header, True);
   end;
end;

Function TCustomerInfoModule.GetCardQueryData(const dbConnection : TADOConnection; const QueryOptions : TStrings) : TDataSet;
var
	CCQuery : TADOQuery;
	ParameterList, QueryBuilder : TStringList;
	FromDateL, ThruDateL : TDateTime;

	ASeparateStores, SearchOnServiceName, SearchCustIdent, DisplayInTZ, SearchEmpIdent, SearchCardName, SearchTranIdent, SearchDollarAmt, SettledOnly, isGrid : boolean;

	DisplayType, FromDate, ThruDate, LastFour, EmpIdent, CardName, TranIdent, DollarAmtComp, DollarAmt, CustIdent, ServiceName, SaleType, StationIdent, RNIDList,
      posStart, count, orderBy, direction, totalCount : string;

   Procedure SetLocalValues;
   begin
      DisplayInTZ := strtobool(QueryOptions.Values['DisplayInTZ']);
      SearchEmpIdent := strtobool(QueryOptions.Values['SearchEmpIdent']);
      SearchCardName := strtobool(QueryOptions.Values['SearchCardName']);
      SearchTranIdent := strtobool(QueryOptions.Values['SearchTranIdent']);
      SearchDollarAmt := strtobool(QueryOptions.Values['SearchDollarAmt']);
      SearchCustIdent := strtobool(QueryOptions.Values['SearchCustIdent']);
      SearchOnServiceName := strtobool(QueryOptions.Values['SearchOnServiceName']);

      FromDateL := StrToDate(ValidCharsOnly(QueryOptions.Values['FromDate'], False, True, '/: '));
      FromDate := FormatDateTime('MM/DD/YYYY', FromDateL);  // Add support for
      ThruDateL := StrToDate(ValidCharsOnly(QueryOptions.Values['ThruDate'], False, True, '/: '));
      ThruDate := FormatDateTime('MM/DD/YYYY', ThruDateL + 1);

      SettledOnly := QueryOptions.Values['TRANHISTSETTLEMENTSTATUS'] = 'SETTLED';
      LastFour := NumericOnly(QueryOptions.Values['LastFour']);
      EmpIdent := ValidCharsonly(QueryOptions.Values['EmpIdent'], True, True, '.-_:/&');
      CardName := ValidCharsonly(QueryOptions.Values['CardName'], True, True, '/ ');
      TranIdent := ValidCharsonly(QueryOptions.Values['TranIdent'], True, True, '.-_:/& ');
      DollarAmtComp := NumericOnly(QueryOptions.Values['DollarAmtComp']);
      DollarAmt := ValidCharsonly(QueryOptions.Values['DollarAmt'], False, True, '.');
      CustIdent := ValidCharsonly(QueryOptions.Values['CustIdent'], True, True, '.-_:/& ');
      ServiceName := ValidCharsonly(QueryOptions.Values['ServiceName'], True, True, '.-_:/& ');
      SaleType := UpCaseString(AlphaOnly(QueryOptions.Values['SaleType']));
      StationIdent := ValidCharsOnly(QueryOptions.Values['StationIdent'], True, True, '-._');
      DisplayType := ValidCharsonly(QueryOptions.Values['DisplayType'], True, False, '');

      RNIDList := QueryOptions.Values['RNIDList'];
      isGrid := DisplayType = 'GRID';

      if isGrid then begin
         posStart := NumericOnly(Trim(QueryOptions.Values['posStart']));
         count := NumericOnly(Trim(QueryOptions.Values['count']));
         orderBy := ValidCharsOnly(Trim(QueryOptions.Values['orderBy']), True, False, '');
         direction := ValidCharsOnly(Trim(QueryOptions.Values['direction']), True, False, '');
      end;
   end;
begin
	CCQuery := TADOQuery.Create(nil);
	ParameterList := TStringList.Create();
	QueryBuilder := TStringList.Create();

	CCQuery.Connection := dbConnection;

   SetLocalValues();

	ParameterList.Add(DRSQLVarsDec);
	ParameterList.Add('set @BegDate = ''' + FromDate + '''; set @EndDate =''' + ThruDate + ''';');
	ParameterList.Add(DRSQLSetTZ);
	ParameterList.Add('set @BegDateHAST = DATEADD(hour,+' + HASTOffsetEST + ',@BegDate);set @EndDateHAST = DATEADD(hour,+' + HASTOffsetEST + ',@EndDate); ');
	
	if (DisplayType = 'GRID') AND (posStart <> '') AND (count <> '') then ParameterList.Add('Set @StartPos = ' + posStart + '; set @count = ' + count + ';');
	
	QueryBuilder.Add('SELECT');
	if (DisplayInTZ) then begin
		QueryBuilder.Add('CASE r.KeyValue WHEN ''AST'' THEN DATEADD(hour,+1,cc.AuthDate) WHEN ''CST'' THEN DATEADD(hour,-1,cc.AuthDate) WHEN ''MST'' THEN DATEADD(hour,-2,cc.AuthDate) ' +
							'WHEN ''PST'' THEN DATEADD(hour,-3,cc.AuthDate) WHEN ''AKST'' THEN DATEADD(hour,-4,cc.AuthDate)' +
							'WHEN ''HAST'' THEN DATEADD(hour,-' + HASTOffsetEST + ',cc.AuthDate) ELSE cc.AuthDate END authdatetz,');
	end;

	QueryBuilder.Add('s.SystemCode RNID, cc.*,s.Name,s.City,s.State,s.ZIP '); // update this to use only the fields we need

	if isGrid then begin
		if orderBy = '' then begin
			QueryBuilder.Add(',ROW_NUMBER() OVER (ORDER BY cc.AuthDate) as row');
		end else begin
			QueryBuilder.Add(',ROW_NUMBER() OVER (ORDER BY ' + orderBy + ' ' + direction + ') as row');
		end;
	end;

	QueryBuilder.Add('from CCAuth cc left outer join');
	QueryBuilder.Add(' Store s on cc.StoreCode = s.SystemCode');
	if DisplayInTZ then QueryBuilder.Add('left outer join REGISTRY r on r.SubKey1 = cc.storecode');
	
	QueryBuilder.Add('where (s.SystemCode in(' + RNIDList + '))');

	if DisplayInTZ then begin
		QueryBuilder.Add('and r.subkey2 = ''storetz''');
		QueryBuilder.Add('and (Authdate >= case r.KeyValue WHEN ''AST'' THEN @BegDateAST WHEN ''CST'' THEN @BegDateCST WHEN ''MST'' THEN @BegDateMST WHEN ''PST'' THEN @BegDatePST WHEN ''AKST'' THEN @BegDateAKST WHEN ''HAST'' THEN @BegDateHAST ELSE @BegDate END)'); //figure out DST for AZ and HI
		QueryBuilder.Add('and (Authdate < case r.KeyValue WHEN ''AST'' THEN @EndDateAST WHEN ''CST'' THEN @EndDateCST WHEN ''MST'' THEN @EndDateMST WHEN ''PST'' THEN @EndDatePST WHEN ''AKST'' THEN @EndDateAKST WHEN ''HAST'' THEN @EndDateHAST ELSE @EndDate END)');
	end else begin
		QueryBuilder.Add('and (AuthDate >= @BegDate)');
		QueryBuilder.Add('and (AuthDate < @EndDate)');
	end;

	If LastFour <> '' then begin
		QueryBuilder.Add('And ((ProcessorToken LIKE ''%' + LastFour + ''')');
		QueryBuilder.Add('or (CardAcct LIKE ''%X' + LastFour + '''))');
	end;
	if SearchEmpIdent and (EmpIdent <> '') then begin
		QueryBuilder.Add('And (TranEmployeeIdent LIKE ''' + EmpIdent + '%'')');
	end;
	if SearchCardName and (CardName <> '') then begin
		QueryBuilder.Add('And (CardName LIKE ''%' + CardName + '%'')');
	end;
	if SearchTranIdent and (TranIdent <> '') then begin
		QueryBuilder.Add('And (TranIdent LIKE ''' + TranIdent + '%'')');
	end;
	if SearchDollarAmt and (DollarAmt <> '') then begin
		if (DollarAmtComp = '0') then begin
			QueryBuilder.Add('And (TranAmt = ''' + DollarAmt + ''')');
		end else if(NumericOnly(Request.queryfields.Values['DOLLARAMTCOMP']) = '1') then begin
			QueryBuilder.Add('And (TranAmt > ''' + DollarAmt + ''')');
		end else if (NumericOnly(Request.queryfields.Values['DOLLARAMTCOMP']) = '2') then begin
			QueryBuilder.Add('And (TranAmt < ''' + DollarAmt + ''')');
		end;
	end;
	if SearchCustIdent and (CustIdent <> '') then begin
		QueryBuilder.Add('And (TranCustomerCode LIKE ''' + CustIdent + '%'')');
	end;
	Processlog(ltInfo, 'GetCardQueryTable Search on ServiceName:', ServiceName);

	if SearchOnServiceName and (ServiceName <> '') then begin
      QueryBuilder.Add('And (CCServiceName = ''' + ServiceName + ''')');
	end;
	
	If SaleType <> '' then QueryBuilder.Add('And (SaleType=''' + SaleType + ''')');
	If StationIdent <> '' then QueryBuilder.Add('And (StationIdent =''' + StationIdent + ''')');
	If SettledOnly then QueryBuilder.Add('And (captureflag = 1)'); 
	
	Processlog(ltDebug, 'GetCardQueryTable SQL Text', ParameterList.Text + QueryBuilder.Text);
	CCQuery.CursorType := ctOpenForwardOnly;
	CCQuery.DisableControls;
	TADODataSet(CCQuery).CommandTimeout := 300;

	if isGrid then begin
		if StrToInt(posStart) = 0 then begin // Get the total amount of records in the query
			CCQuery.SQL.Add(parameterList.Text + ' SELECT COUNT(*) as totalCount FROM(' + QueryBuilder.Text + ') as a');
			CCQuery.Open();
			totalCount := CCQuery.FieldByName('totalCount').AsString;
			SessionVarEval.AddValue('totalCount', totalCount);
			ProcessLog(ltinfo, 'getCardQueryTable', 'Query Opened - Total Record Count: ' + totalCount);
			CCQuery.Close();
			CCQuery.SQL.Clear();
		end;
		CCQuery.SQL.Add(ParameterList.Text + ' SELECT * FROM(' + QueryBuilder.Text + ') as a WHERE row between (@StartPos + 1) and (@StartPos + @count)');
	end else begin
		if ASeparateStores then begin
			QueryBuilder.Add('Order by s.SystemCode, cc.AuthDate');
		end else begin
			QueryBuilder.Add('Order by cc.AuthDate');
		end;
		CCQuery.SQL.Add(ParameterList.Text + QueryBuilder.Text);
	end;

	CCQuery.Open();
	Result := CCQuery;

	ParameterList.Free();
	QueryBuilder.Free();
end;

Function TCustomerInfoModule.CustomerSearch(const AQueryFields, AContentFields: TStrings; const allowedRNIDs : string): string;
const
   METHOD_NAME = 'TCustomerInfoModule.CustomerSearch(...)';// 2019-4-17 ss DVST-4900
var
   WS, WS2, CustPosStart, CustCount, CustSQLText, CustTotalCount : string;
   IsDisplayTimeInTZ: Boolean; // 2019-4-17 ss DVST-4900
begin
   WS := '';
   WS2 := '';
   IsDisplayTimeInTZ := StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE'))); // 2019-4-17 ss DVST-4900
   ProcessLog(ltInfo, METHOD_NAME, '/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ = '+Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE'))); // 2019-4-17 ss DVST-4900
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYCUSTOMERSASGRID', 'FALSE') = 'TRUE' then begin  //2018-05-16 bls: D#2586, F#1472
      CustPosStart := '0';
      CustCount := '100';
      if NumericOnly(Trim(UpCaseString(AQueryFields.Values['posStart']))) <> '' then begin
          CustPosStart := NumericOnly(Trim(UpCaseString(AQueryFields.Values['posStart']))); // Get Starting position
      end;
      if NumericOnly(Trim(UpCaseString(AQueryFields.Values['count']))) <> '' then begin
          CustCount := NumericOnly(Trim(UpCaseString(AQueryFields.Values['count']))); // Get amount of rows to receive from db
      end;
      CustSQLText :=  'SELECT *, ROW_NUMBER() OVER (ORDER BY LastName) as row FROM Customers where ChainCode = ''' + Stri(ChainCode, -1) + ''''; // 2018-04-49 bls: D#2586
      WS := Trim(UpCaseString(ValidCharsOnly(AQueryFields.Values['Name'],True,True,'-'' ')));
      WS := stringreplace(WS, #39, #39 + #39, [rfReplaceAll]);
      If WS <> '' then begin
         CustSQLText := CustSQLText + 'AND LastName like ''' + WS + '%''';
      end;
      WS := Trim(UpCaseString(ValidCharsOnly(AQueryFields.Values['FIRSTNAME'],True,True,'-'' '))); //2019-04-17 jtm: DSVT-5415 updated field name to look in
      WS := stringreplace(WS, #39, #39 + #39, [rfReplaceAll]);
      if ((OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERSEARCH/SHOWSEARCHONFIRSTNAME','FALSE') = 'TRUE') and (WS <> '')) then begin //2017-10-26 ajs: F#2207
         CustSQLText := CustSQLText + 'AND FirstName like ''' + WS + '%''';
         WS := '';
      end;
      if ValidCharsOnly(Trim(UpCaseString(AQueryFields.Values['CompanyName'])),true,true,' -.') <> '' then
         CustSQLText := CustSQLText + 'AND Employer like ''' + ValidCharsOnly(Trim(UpCaseString(AQueryFields.Values['CompanyName'])),true,true,' -.') + '%''';
      if (NumericOnly(AQueryFields.Values['CUSTLOCATION']) <> '') then begin
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERSEARCH/SEARCHONCHILDRNID','FALSE') = 'TRUE') then begin //2017-10-04 jtm: F#2238
            CustSQLText := CustSQLText + ' and (EXISTS (SELECT NULL FROM CustChild where (custchild.custguid = customers.customercode) and (CustChild.Hidden=0) and (CustChild.RNID = ''' + NumericOnly(AQueryFields.Values['CUSTLOCATION'])+ ''')))';
         end else begin
            if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERSEARCH/SEARCHALLOWEDSTORESONLY', 'FALSE') = 'TRUE' then begin // check config for using allowed locations
               WS := AllowedRNIDs;
               if WS = '' then begin
                  WS := QuotedStr(WS);
               end;
               CustSQLText := CustSQLText + ' and StoreCode in (' + WS + ') '; // Add that list to the query
            end else begin
               CustSQLText := CustSQLText + ' and (StoreCode = ' + NumericOnly(AQueryFields.Values['CUSTLOCATION'])+ ')';
            end;
         end;
      end;
      if Trim(UpCaseString(AQueryFields.Values['UNVALIDATED'])) = 'TRUE' then
         CustSQLText := CustSQLText + ' and (CONFIRMGUID <> ''VALIDATED'')';
      if Trim(UpCaseString(AQueryFields.Values['CUSTACCOUNTNUMBER'])) <> '' then
         CustSQLText := CustSQLText + ' and (Customers.AccountNumber = ''' + ValidCharsOnly(AQueryFields.Values['CUSTACCOUNTNUMBER'],true,true,'')+ ''')';
      if Trim(UpCaseString(AQueryFields.Values['CUSTCHILDACCOUNTNUMBER'])) <> '' then
         CustSQLText := CustSQLText + ' and (EXISTS (SELECT NULL FROM CustChild where (custchild.custguid = customers.customercode) and (CustChild.accountNumber = ''' + ValidCharsOnly(AQueryFields.Values['CUSTCHILDACCOUNTNUMBER'],true,true,'')+ ''')))';
      if StrToInt(CustPosStart) = 0 then begin // 2018-04-49 bls: D#2586
         RNQuery.Close;
         RNQuery.SQL.Clear;
         RNQuery.SQL.Text := CustSQLText;
         RNQuery.Open;
         CustTotalCount := IntToStr(RNQuery.RecordCount);
         SessionVarEval.AddValue('CustTotalCount', CustTotalCount);
         ProcessLog(ltinfo,'CUSTOMERSEARCH','Query Opened; Total Record Count: ' + CustTotalCount);
      end;
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('SET ARITHABORT ON; Declare @StartPos as int; Declare @count as int; Set @StartPos = '+ CustPosStart +'; set @count = '+ CustCount +';');
      if(IsDisplayTimeInTZ) then begin // 2019-4-17 ss DVST-4900
         RNQuery.SQL.Add('SELECT *, ');
         RNQuery.SQL.Add('CASE r.KeyValue WHEN ''AST'' THEN DATEADD(hour,+1,a.LastWebLogon) WHEN ''CST'' THEN DATEADD(hour,-1,a.LastWebLogon) WHEN ''MST'' THEN DATEADD(hour,-2,a.LastWebLogon)');
         RNQuery.SQL.Add('WHEN ''PST'' THEN DATEADD(hour,-3,a.LastWebLogon) WHEN ''AKST'' THEN DATEADD(hour,-4,a.LastWebLogon)');
         RNQuery.SQL.Add('WHEN ''HAST'' THEN DATEADD(hour,-'+HASTOffsetEST+',a.LastWebLogon) ELSE a.LastWebLogon END LastWebLogontz, ');
         RNQuery.SQL.Add('CASE r.KeyValue WHEN ''AST'' THEN DATEADD(hour,+1,a.LockedUntil) WHEN ''CST'' THEN DATEADD(hour,-1,a.LockedUntil) WHEN ''MST'' THEN DATEADD(hour,-2,a.LockedUntil)');
         RNQuery.SQL.Add('WHEN ''PST'' THEN DATEADD(hour,-3,a.LockedUntil) WHEN ''AKST'' THEN DATEADD(hour,-4,a.LockedUntil)');
         RNQuery.SQL.Add('WHEN ''HAST'' THEN DATEADD(hour,-'+HASTOffsetEST+',a.LockedUntil) ELSE a.LockedUntil END LockedUntiltz ');
         RNQuery.SQL.Add('FROM(' + CustSQLText + ') as a ');
         RNQuery.SQL.Add('left outer join REGISTRY r ON r.SubKey1 = a.STORECODE ');
         RNQuery.SQL.Add('and r.subkey2 = ''storetz''');
         RNQuery.SQL.Add(' WHERE row between (@StartPos + 1) and (@StartPos + @count)');
      end else begin
      RNQuery.SQL.Add('SELECT * FROM(' + CustSQLText + ') as a WHERE row between (@StartPos + 1) and (@StartPos + @count)');
      end;
      ProcessLog(ltInfo, METHOD_NAME, 'RNQuery.SQL.Text = '+RNQuery.SQL.Text); // 2019-4-17 ss DVST-4900
      RNQUERY.Open;
      WS := '';
      If RNQuery.RecordCount > 0  then begin
         WS := WS + '<?xml version="1.0" encoding="UTF-8"?><rows total_count=''' + SessionVarEval.GetValueAsString('CustTotalCount') + ''' pos= ''' + CustPosStart + '''>'; // 2018-04-49 bls: D#2586
         While Not RNQuery.EOF do begin
               WS := WS + '<row id=''' + RNQuery.FieldByName('row').AsString + '''>';
               WS := WS + '<cell><![CDATA[<A HREF="javascript:GetCustomerProfile(''' + Trim(RnQuery.FieldByName('CustomerCode').AsString)+''')">' +Trim(RNQuery.FieldByName('FirstName').AsString) + ' ' +Trim(RNQuery.FieldByName('LastName').AsString) + '</A>]]></cell>';
               WS := WS + '<cell>' + Trim(RNQuery.FieldByName('Email').AsString) + '</cell>';
               if StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERSEARCH/DISPLAYACCOUNTNUM','FALSE')) then begin //2019-06-15 tjr: DVST-3091
                  WS := WS + '<cell>' + Trim(RNQuery.FieldByName('AccountNumber').AsString) + '</cell>';
               end;
               WS := WS + '<cell>' + Trim(RNQuery.FieldByName('City').AsString) + ', ' +
                                     Trim(RNQuery.FieldByName('State').AsString)+  ' ' +
                                     Trim(RNQuery.FieldByName('ZIP').AsString) + '</cell>';
               if(IsDisplayTimeInTZ) then begin // 2019-4-17 ss DVST-4900
                  WS := WS + '<cell>' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',RNQuery.FieldByName('LastWebLogontz').AsDateTime) + '</cell>';
               end else begin
               WS := WS + '<cell>' + FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',RNQuery.FieldByName('LastWebLogon').AsDateTime) + ' EST</cell>';
               end;
               If RNQuery.FieldByName('LockedUntil').AsDateTime <> 0 then begin
                  if(IsDisplayTimeInTZ) then begin // 2019-4-17 ss DVST-4900
                     WS := WS + '<cell>' +FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',RNQuery.FieldByName('LockedUntiltz').AsDateTime)+'</cell>'+
                              '<cell><![CDATA[<A HREF="javascript:UnlockUser(''' + Trim(RnQuery.FieldByName('CustomerCode').AsString)+''')">Unlock</A>]]></cell>';
                  end else begin
                  WS := WS + '<cell>' +FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',RNQuery.FieldByName('LockedUntil').AsDateTime)+' EST</cell>'+
                             '<cell><![CDATA[<A HREF="javascript:UnlockUser(''' + Trim(RnQuery.FieldByName('CustomerCode').AsString)+''')">Unlock</A>]]></cell>';
                  end;
               end else begin
                  WS := WS + '<cell>Unlocked</cell>' +
                             '<cell><![CDATA[<A HREF="javascript:LockUser(''' + Trim(RnQuery.FieldByName('CustomerCode').AsString)+''')">Lock</A>]]></cell>';
               end;
               WS := WS + '</row>';
            RNQuery.Next;
         end;
      end else begin
         WS := WS + '<?xml version="1.0" encoding="UTF-8"?><rows total_count=''0'' pos= ''0''>'; // 2018-04-49 bls: D#2586
      end;
      WS := WS + '</rows>';
   end else begin // Unchunked, html table data goes here
      RNQuery.Close;
      RNQuery.SQL.Clear;
      if(IsDisplayTimeInTZ) then begin // 2019-4-17 ss DVST-4900
         RNQuery.SQL.Add('SELECT TOP 500 *, ');
         RNQuery.SQL.Add('CASE r.KeyValue WHEN ''AST'' THEN DATEADD(hour,+1,customers.LastWebLogon) WHEN ''CST'' THEN DATEADD(hour,-1,customers.LastWebLogon) WHEN ''MST'' THEN DATEADD(hour,-2,customers.LastWebLogon)');
         RNQuery.SQL.Add('WHEN ''PST'' THEN DATEADD(hour,-3,customers.LastWebLogon) WHEN ''AKST'' THEN DATEADD(hour,-4,customers.LastWebLogon)');
         RNQuery.SQL.Add('WHEN ''HAST'' THEN DATEADD(hour,-'+HASTOffsetEST+',customers.LastWebLogon) ELSE customers.LastWebLogon END LastWebLogontz, ');
         RNQuery.SQL.Add('CASE r.KeyValue WHEN ''AST'' THEN DATEADD(hour,+1,customers.LockedUntil) WHEN ''CST'' THEN DATEADD(hour,-1,customers.LockedUntil) WHEN ''MST'' THEN DATEADD(hour,-2,customers.LockedUntil)');
         RNQuery.SQL.Add('WHEN ''PST'' THEN DATEADD(hour,-3,customers.LockedUntil) WHEN ''AKST'' THEN DATEADD(hour,-4,customers.LockedUntil)');
         RNQuery.SQL.Add('WHEN ''HAST'' THEN DATEADD(hour,-'+HASTOffsetEST+',customers.LockedUntil) ELSE customers.LockedUntil END LockedUntiltz ');
         RNQuery.SQL.Add('FROM customers ');
         RNQuery.SQL.Add('left outer join REGISTRY r ON r.SubKey1 = customers.STORECODE ');
         RNQuery.SQL.Add('and r.subkey2 = ''storetz''');
         RNQuery.SQL.Add('WHERE customers.ChainCode = ''' + Stri(ChainCode,-1) + ''' ');
      end else begin
         RNQuery.SQL.Add('SELECT TOP 500 * FROM customers WHERE ChainCode = ''' + Stri(ChainCode,-1) + '''');
      end;
      WS := Trim(UpCaseString(ValidCharsOnly(AQueryFields.Values['Name'],True,True,'-'' ')));
      WS := stringreplace(WS, #39, #39 + #39, [rfReplaceAll]);
      If WS <> '' then begin
         if(IsDisplayTimeInTZ) then begin // 2019-4-17 ss DVST-4900
            RNQuery.SQL.Add('AND customers.LastName like ''' + WS + '%''');
         end else begin
            RNQuery.SQL.Add('AND LastName like ''' + WS + '%''');
         end;
      end;
      WS := Trim(UpCaseString(ValidCharsOnly(AQueryFields.Values['FirstName'],True,True,'-'' ')));
      WS := stringreplace(WS, #39, #39 + #39, [rfReplaceAll]);
      if ((OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERSEARCH/SHOWSEARCHONFIRSTNAME','FALSE') = 'TRUE') and (WS <> '')) then begin //2017-10-26 ajs: F#2207
         if(IsDisplayTimeInTZ) then begin // 2019-4-17 ss DVST-4900
            RNQuery.SQL.Add('AND customers.FirstName like ''' + WS + '%''');
         end else begin
            RNQuery.SQL.Add('AND FirstName like ''' + WS + '%''');
         end;
         WS := ''; // 2019-4-17 ss DVST-4900
      end;
      if ValidCharsOnly(Trim(UpCaseString(AQueryFields.Values['CompanyName'])),true,true,' -.') <> '' then
         if(IsDisplayTimeInTZ) then begin // 2019-4-17 ss DVST-4900
            RNQuery.SQL.Add('AND customers.Employer like ''' + ValidCharsOnly(Trim(UpCaseString(AQueryFields.Values['CompanyName'])),true,true,' -.') + '%''');
         end else begin
            RNQuery.SQL.Add('AND Employer like ''' + ValidCharsOnly(Trim(UpCaseString(AQueryFields.Values['CompanyName'])),true,true,' -.') + '%''');
         end;
      if ((NumericOnly(AQueryFields.Values['CUSTLOCATION']) <> '')) then begin // 2019-4-17 ss DVST-4900
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERSEARCH/SEARCHONCHILDRNID','FALSE') = 'TRUE') then begin //2017-10-04 jtm: F#2238
            RNQuery.SQL.Add(' and (EXISTS (SELECT NULL FROM CustChild where (custchild.custguid = customers.customercode) and (CustChild.Hidden=0) and (CustChild.RNID = ''' + NumericOnly(AQueryFields.Values['CUSTLOCATION'])+ ''')))');
         end else begin
            if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERSEARCH/SEARCHALLOWEDSTORESONLY', 'FALSE') = 'TRUE' then begin // check config for using allowed locations
               WS := AllowedRNIDs;
               if WS = '' then begin
                  WS := QuotedStr(WS);
               end;
               if(IsDisplayTimeInTZ) then begin // 2019-4-17 ss DVST-4900
                  RNQuery.SQL.Add(' and customers.StoreCode in (' + WS + ') '); // Add that list to the query
               end else begin
                  RNQuery.SQL.Add(' and StoreCode in (' + WS + ') '); // Add that list to the query
               end;
            end else begin
               if(IsDisplayTimeInTZ) then begin
                  RNQuery.SQL.Add(' and (customers.StoreCode = ' + NumericOnly(AQueryFields.Values['CUSTLOCATION'])+ ')');
               end else begin
                  RNQuery.SQL.Add(' and (StoreCode = ' + NumericOnly(AQueryFields.Values['CUSTLOCATION'])+ ')');
               end;
            end;
         end;
      end;
      if ((Trim(UpCaseString(AQueryFields.Values['UNVALIDATED'])) = 'TRUE')) then begin // 2019-4-17 ss DVST-4900: added some brackets that helps in testing like doing ((......) Or (True)) to force those code to be hit during testing. Same reason for later
         if(IsDisplayTimeInTZ) then begin
            RNQuery.SQL.Add(' and (customers.CONFIRMGUID <> ''VALIDATED'')');
         end else begin
            RNQuery.SQL.Add(' and (CONFIRMGUID <> ''VALIDATED'')');
         end;
      end;
      if ((Trim(UpCaseString(AQueryFields.Values['CUSTACCOUNTNUMBER'])) <> '')) then // 2019-4-17 ss DVST-4900
         RNQuery.SQL.Add(' and (Customers.AccountNumber = ''' + ValidCharsOnly(AQueryFields.Values['CUSTACCOUNTNUMBER'],true,true,'')+ ''')');
      if ((Trim(UpCaseString(AQueryFields.Values['CUSTCHILDACCOUNTNUMBER'])) <> '')) then // 2019-4-17 ss DVST-4900
         RNQuery.SQL.Add(' and (EXISTS (SELECT NULL FROM CustChild where (custchild.custguid = customers.customercode) and (CustChild.Hidden=0) and (CustChild.accountNumber = ''' + ValidCharsOnly(AQueryFields.Values['CUSTCHILDACCOUNTNUMBER'],true,true,'')+ ''')))');
      if(IsDisplayTimeInTZ) then begin // 2019-4-17 ss DVST-4900
         RNQuery.SQL.Add('Order by Customers.lastname, Customers.FirstName');
      end else begin
         RNQuery.SQL.Add('Order by lastname, FirstName');
      end;
      ProcessLog(ltInfo, METHOD_NAME, 'RNQuery.SQL.Text = '+RNQuery.SQL.Text); // 2019-4-17 ss DVST-4900
      RNQUERY.Open;
      WS := '';
      If RNQuery.RecordCount >0  then begin
         WS :='<TABLE class="paymenthist"><TR><Th><B>Name</B></Th><Th><B>Email</B></Th>';
         if StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERSEARCH/DISPLAYACCOUNTNUM','FALSE')) then begin //2019-06-15 tjr: DVST-3091
            WS := WS + '<Th><B>Account Number</B></Th>';
         end;
         WS := WS + '<Th><B>Address</B></Th><Th><B>Last Logon</B></Th><Th><B>Locked Until</B></Th><Th><B>Action</B></Th></TR>';
         While Not RNQuery.EOF do begin
               WS := WS + '<tr><td><A HREF="javascript:GetCustomerProfile(''' + Trim(RnQuery.FieldByName('CustomerCode').AsString)+''')">' +Trim(RNQuery.FieldByName('FirstName').AsString) + ' ' +Trim(RNQuery.FieldByName('LastName').AsString) + '</A></td>' +
                              '<td>' + Trim(RNQuery.FieldByName('Email').AsString)+'</td>';
               if StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERSEARCH/DISPLAYACCOUNTNUM','FALSE')) then begin //2019-06-15 tjr: DVST-3091
                  WS := WS + '<td>' + Trim(RNQuery.FieldByName('AccountNumber').AsString) + '</td>';
               end;
               WS := WS + '<td>' + Trim(RNQuery.FieldByName('City').AsString)+ ', ' +
                                       Trim(RNQuery.FieldByName('State').AsString)+  ' ' +
                                       Trim(RNQuery.FieldByName('ZIP').AsString)+'</td>';
               if(IsDisplayTimeInTZ) then begin // 2019-4-17 ss DVST-4900
                  WS := WS + '<td>' +FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',RNQuery.FieldByName('LastWebLogontz').AsDateTime)+'</td>';
               end else begin
                  WS := WS + '<td>' +FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',RNQuery.FieldByName('LastWebLogon').AsDateTime)+' EST</td>';
               end;
               If RNQuery.FieldByName('LockedUntil').AsDateTime <> 0 then begin
                  if(IsDisplayTimeInTZ) then begin
                     WS := WS + '<td>' +FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',RNQuery.FieldByName('LockedUntiltz').AsDateTime)+'</td>'+
                                            '<td><A HREF="javascript:UnlockUser(''' + Trim(RnQuery.FieldByName('CustomerCode').AsString)+''')">Unlock</A></td>';
                              end else begin
                     WS := WS + '<td>' +FormatDateTime('MM/DD/YYYY HH:NN:SS AM/PM',RNQuery.FieldByName('LockedUntil').AsDateTime)+' EST</td>'+
                              '<td><A HREF="javascript:UnlockUser(''' + Trim(RnQuery.FieldByName('CustomerCode').AsString)+''')">Unlock</A></td>';
                  end;
               end else begin
                     ws := WS + '<td>Unlocked</td><td><A HREF="javascript:LockUser(''' + Trim(RnQuery.FieldByName('CustomerCode').AsString)+''')">Lock</A></td>';
               end;
               WS := WS + '</tr>';
            RNQuery.Next;
         end;
         WS := WS + '</TABLE>';
      end else begin
         WS := '<B>**No Customers Found**</B>' ;
      end;
   end;
   Result := WS;
end;
procedure TCustomerInfoModule.SetTheChainCode(const ARNIDasInt: Integer);
var
   RNIDStr: String;
begin
   if (CacheChainCode and (ChainCode = 0)) then begin
      RNIDStr := StrI(ARNIDasInt, -1);
      ChainCode := FRegistry.ReadInteger('RetailNet ChainCodes', RNIDStr, 0);
      if (ChainCode = 0) then begin //HDQuery.Parameters.ParamByName
         RNQuery.Close;    //2016-10-25 bah
         RNQuery.SQL.Text := 'select * from store where Systemcode = :RNID';     //2016-10-25 bah
         RNQuery.Parameters.ParamByName('RNID').Value := RNIDStr;
         try
            RNQuery.Open;
            if (RNQuery.RecordCount <> 0) then begin
               ChainCode := RNQuery.FieldByName('ChainCode').AsInteger;
               FRegistry.WriteInteger('RetailNet ChainCodes', RNIDStr, ChainCode);
            end;
            RNQuery.Close;
         except
            on e:Exception do begin
               processlog(ltWarning, 'ChainCode Cache Lookup', E.Message);
            end;
         end;
      end;
   end;
end;

function TCustomerInfoModule.GetVTTranTypeAjax(const AQueryFields, AContentFields : TStrings) : string;
var
   rnidL : string;
   RespHTML : TStringList;
begin
   rnidL := NumericOnly(AQueryFields.Values['LOCATIONRNID']);
   ProcessLog(ltInfo, 'GETVTTRANTYPEAJAX LocationRNID:', rnidL);
   if (Not ValidateRNID(rnidL)) then begin
      Result := 'INVALID RNID';
      exit;
   end;

   RespHTML := TStringList.Create();
   RespHTML.Add('<select id="' + ValidCharsOnly(AQueryFields.Values['ID'], true, true, '') + '" name="' + ValidCharsOnly(AQueryFields.Values['NAME'], true, true, '') + '">');
   RespHTML.Add('<option Value="CCSALE">' + OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/CCSALENAME', 'Sale') + '</option>');

   if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ALLOWAUTHTYPE', 'FALSE')) then begin
      RespHTML.Add('<option value="CCAUTH">Auth</option>');
   end;

   if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ALLOWISSUECREDIT', 'FALSE')) and not UserIs('READONLY', rnidL) then begin
      RespHTML.Add('<option value="CCCREDIT">Credit</option>');
   end;
   RespHTML.Add('</select>' + CRLF);

   Result := RespHTML.Text;
   RespHTML.Free;
end;

function TCustomerInfoModule.GetVTCardDetailAjax(const AQueryFields, AContentFields : TStrings): string;
var
   rnidL, systemCodeL, WS : string;
   BatchFieldNamesL : TStringList;
   CCBatchWasSuccessful, UserIsReadOnly,UserIsChargeAgain : boolean;
begin
   Result := 'There was a problem retrieving the data you requested.';

   rnidL := NumericOnly(AQueryFields.Values['LOCATIONRNID']);
   systemCodeL := NumericOnly(AQueryFields.Values['CCSYSTEMCODE']);
   UserIsReadOnly := UserIs('READONLY', rnidL);
   UserIsChargeAgain := UserIs('CHARGEAGAIN', rnidL);//2019-02-13 jtm: DVST-3067
   CCBatchWasSuccessful := False;

   VarEvaluator.AddValue('LOCATIONRNID', rnidL);
   VarEvaluator.AddValue('GatewayRNID', rnidL); //2018-07-18 bls: D#5061

   if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEBATCHFIELDSEARCH', 'FALSE')) then begin //2018-06-20 bls: F#2227
      BatchFieldNamesL := TStringList.Create();
      BatchFieldNamesL.CommaText := 'PROFILE,SYSTEMCODE,TICKETGUID,AUTHDATE,VOIDED,TRANAMT,SALETYPE,CARDTYPE,CARDACCT,PROCESSORTOKEN,AUTHCODE,NONAUTHRESP,TRANENTRYMODE,' +
                                    'CARDTRACKDATA,CARDNAME,MID,CCSERVICENAME,TRANIDENT,TRANCUSTOMERCODE,STATIONIDENT,BATCHCODE,BATCHID,BATCHDATE,VOIDDATETIME,SIGDATATYPE,' +
                                    'CAPTUREFLAG';
      CCBatchWasSuccessful := GetCCBatchFields(rnidL, systemCodeL, BatchFieldNamesL);
      BatchFieldNamesL.Free;
   end else begin
      CCBatchWasSuccessful := GetCCBatch(rnidL, systemCodeL, True);
   end;

   if CCBatchWasSuccessful then begin
      ProcessLog(ltInfo, 'Starting Batch XML to HTML', InstanceGUID);
      WS := LoadWebFileFromFolder('AuthDetails.htm', 'PPADMIN');
      if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SEARCHONSERVICENAME', 'FALSE')) then begin //2017-05-10 jtm F#1564
         VarEvaluator.AddValue('ServiceName', BatchOXML.GetValueAsWideString('/TRANRESP/CCBATCHDETAIL/CCAUTHDETAIL/CCSERVICENAME'));
      end;
      if AQueryFields.Values['DETAILONLY'] = 'TRUE' then begin
         Result := SingleBatchXMLToTableHTML(UserIsReadOnly,UserIsChargeAgain); //2017-03-22 jtm:  F#1267
      end else begin
         ReplaceString(WS, '%AUTHDETAIL%', SingleBatchXMLToTableHTML(UserIsReadOnly,UserIsChargeAgain));  //2017-03-22 jtm:  F#1267
         ReplaceString(WS, '%MAXCREDIT%', BatchOXML.GetValueAsWideString('/TRANRESP/CCBATCHDETAIL/CCAUTHDETAIL/TRANAMT'));
         ReplaceString(WS, '%TRANIDENT%', BatchOXML.GetValueAsWideString('/TRANRESP/CCBATCHDETAIL/CCAUTHDETAIL/TRANIDENT'));
         ReplaceString(WS, '%LOCATIONRNID%', rnidL);
         ReplaceString(WS, '%CCSYSTEMCODE%', systemCodeL);

         Result := WS;
      end;
   end;
end;

function TCustomerInfoModule.VTChargeAgainSystemcode(const AQueryFields, AContentFields : TStrings): string;
const
   METHOD_NAME = 'TCustomerInfoModule.VTChargeAgainSystemcode(...)';
var
   tranIdentL, custIdentL, systemCodeL, rnidL : string;
   amountL : Real;
   BatchFieldNamesL : TStringList;
   CCBatchWasSuccessful : Boolean;
   CCAuthType: String; //2019-5-15 SS DVST-4406
begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');//2019-5-15 SS DVST-4406
   rnidL := NumericOnly(AQueryFields.Values['LOCATIONRNID']);
   systemCodeL := NumericOnly(AQueryFields.Values['CCSYSTEMCODE']);
   amountL := ValuReal(AQueryFields.Values['AMOUNT']);
   tranIdentL := AQueryFields.Values['TRANIDENT'];
   custIdentL := AQueryFields.Values['CUSTIDENT'];
   CCBatchWasSuccessful := False;

   CCAuthType := 'SALE';
   if(StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ADMINCHARGEAGAIN/ALLOWAUTH')))) then begin //2019-5-15 SS DVST-4406
      if(Trim(UpCaseString(AQueryFields.Values['CCAUTHTYPE'])) = 'AUTH') then begin
         CCAuthType := 'AUTH';
      end;
   end;
   if(StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ADMINCHARGEAGAIN/ALLOWCVV')))) then begin //2019-5-15 SS DVST-4406
      if(Trim(UpCaseString(AQueryFields.Values['CCAUTHTYPE'])) = 'CVV') then begin
         CCAuthType := 'CVV';
      end;
   end;
   if(StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ADMINCHARGEAGAIN/ALLOWAVS')))) then begin //2019-5-15 SS DVST-4406
      if(Trim(UpCaseString(AQueryFields.Values['CCAUTHTYPE'])) = 'AVS') then begin
         CCAuthType := 'AVS';
      end;
   end;

   VarEvaluator.AddValue('GatewayRNID', rnidL);
   if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEBATCHFIELDSEARCH', 'FALSE')) then begin
      BatchFieldNamesL := TStringList.Create();
      BatchFieldNamesL.CommaText := 'TRANIDENT,TRANCUSTOMERCODE,CARDNAME,CCSERVICENAME';
      CCBatchWasSuccessful := GetCCBatchFields(rnidL, systemCodeL, BatchFieldNamesL);
      BatchFieldNamesL.Free;
   end else begin
      CCBatchWasSuccessful := GetCCBatch(rnidL, systemCodeL, True);
   end;

   if CCBatchWasSuccessful then begin
      ProcessLog(ltInfo, 'Starting VTCHARGEAGAINSYSTEMCODE', InstanceGUID);
      Result := ChargeAgainCC(rnidL, systemCodeL, amountL, tranIdentL, custIdentL, CCAuthType); //2019-5-15 SS DVST-4406
   end else begin
      Result := 'Authorization could not be complete.';
   end;
   ProcessLog(ltInfo, METHOD_NAME, 'END. RESULT - '+Result);//2019-5-15 SS DVST-4406
end;

function TCustomerInfoModule.PPAuthenticateTempusUser(const AQueryFields, AContentFields: TStrings; const ARNID: string;const ARNSessionID: string): string;
var
   Username : string;
   Email : string;
   Password : string;
   WS : string;
   CASAuthenticated : boolean;
   CASUserName : string;
   CASOutput : TStringList;
   AccessToken : string;
begin
   result := '';
   UserName := AContentFields.Values['UserName'];
   Username := ValidCharsOnly(username,True,True,'_.-');
   ReplaceString(Username,'--','-');


   Email := AContentFields.Values['email'];
   Email := ValidCharsOnly(email,True,True,'_.-#@+/'); //2019-04-05 jtm: DVST-5486
   ReplaceString(email,'--','-');
   SessionVarEval.AddValue('WEUSERID', EMail);

   Password := AContentFields.Values['password'];

   ProcessLog(ltDebug, 'PPAuthenticateTempusUser', 'UserName = '+UserName);//2019-1-13 SS DVST-3865 Testing how the password is sent from the front end
   ProcessLog(ltDebug, 'PPAuthenticateTempusUser', 'Password = '+Password);//2019-1-13 SS DVST-3865 Testing how the password is sent from the front end

   SessionAuthQuery.Close;
   SessionAuthQuery.SQL.Clear;
   SessionAuthQuery.SQL.Add('Select * from WWWSession where RNSessionID = ''' + ARNSessionID + '''');
   SessionAuthQuery.Open;

   If OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/AUTHENTICATIONTYPE') = 'USER' then begin
      WS := LoadWebFileFromFolder('employee_login.htm','');
      If Username = '' then begin
         ReplaceString(WS,'%ERROR%', '<B><font color="red">Please enter valid Username</font></B>');
         result := WS;
         Exit;
      end else if Password = '' then begin
         ReplaceString(WS,'%ERROR%', '<B><font color="red">Please enter your Password</font></B>');
         result:= WS;
         Exit;
      end;
      PL.AddAppValue('USERNAME',  Username);
      If GetRNUser(Username) then begin
         If (CardUtil.StringToSHADigestHex(Password) = EmployeeXMLGetTag('/EMPLOYEE/PASSWORDHASH')) AND (UserQuery.FieldByName('LockedOutTill').AsDateTime < NOW)then begin   //2016-10-19 jtm Def OT# 1281
            if UserXMLGetTag('/USERPROFILE/DEACTIVATED','FALSE') = 'FALSE' then begin    //2016-09-29 jtm Feat OT# 1178

               Try
                  UserQuery.Edit;
                  UserQuery.FieldByName('FailedLoginCount').AsInteger := 0;
                  UserQuery.FieldByName('LastLogin').AsDateTime := Now;
                  UserQuery.FieldByName('LockedOutTill').AsDateTime := 0;
                  UserQuery.Post;
               except
                  On E:Exception do begin
                  end;
               end;
               SessionAuthQuery.Edit;
               SessionAuthQuery.FieldByName('CustomerSC').AsInteger := -1;
               SessionAuthQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime := Now + EncodeTime(1,0,0,0);
               SessionAuthQuery.FieldByName('Username').AsString := Trim(UpCaseString(UserName));
               SessionAuthQuery.FieldByName('MembType').AsString := 'ADMIN';
               SessionAuthQuery.Post;
               LoadSessionVars(SessionAuthQuery);
               SessionAuthQuery.Close;

               If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOGINURL') <> '' then begin
                  result := '<head><title>Portal Logon</title>' +
                          '<meta http-equiv="refresh" content="0;URL='+ OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOGINURL')+'"></head>';
               end else begin
                  result := '<head><title>Portal Logon</title>' +
                          '<meta http-equiv="refresh" content="0;URL=/PP"></head>';
               end;
               if UserXMLGetTag('/USERPROFILE/FIRSTLOGIN') = 'TRUE' then begin   //2016-9-19 jtm: Feat OT# 1054
                  ProcessLog(ltInfo,'AUTHENTICATE FIRSTLOGIN','Username= ' +Trim(Username));
                  result := '<head><title>Portal Logon</title>' +
                          '<meta http-equiv="refresh" content="0;URL=/PP?PAGE=EDITUSERLOGIN"></head>';
               end;
            end else begin
               ReplaceString(WS,'%ERROR%', '<B><font color="red">Invalid User</font></B>');
               result := WS;
            end;
            exit;
         end else begin
            Try
               UserQuery.Edit;
               UserQuery.FieldByName('FailedLoginCount').AsInteger := UserQuery.FieldByName('FailedLoginCount').AsInteger + 1;
               UserQuery.FieldByName('LastFailedLogin').AsDateTime := Now;
               If UserQuery.FieldByName('FailedLoginCount').AsInteger >= 5 then
                  UserQuery.FieldByName('LockedOutTill').AsDateTime := NOW + EncodeTime(0,5,0,0); //2017-03-22 jtm: Def OT#1523
               UserQuery.Post;
            except
               On E:Exception do begin
               end;
            end;
            If UserQuery.FieldByName('LockedOutTill').AsDateTime > NOW then begin   //2016-10-19 jtm Def OT# 1281
               ReplaceString(WS,'%ERROR%', '<B><font color="red">Account Locked</font></B>');
            end else begin
               ReplaceString(WS,'%ERROR%', '<B><font color="red">Invalid Password</font></B>');
            end;

            result := WS;
            Exit;
         end;
      end else begin
         ReplaceString(WS,'%ERROR%', '<B><font color="red">Invalid Username</font></B>');
         result := WS;
         Exit;
      end;

      ReplaceString(WS,'%ERROR%', '<B><font color="green">continuing</font></B>');
      result := WS;
      Exit;
   end else If OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/AUTHENTICATIONTYPE') = 'CAS' then begin
      CASAuthenticated := false;
      CASUserName := '';

      If Request.queryfields.Values['ticket'] <> '' then begin
         CASOutput := TStringList.Create;
         ProcessLog(ltInfo,'CASTicket' + Aqueryfields.Values['ticket'],'');
         ProcessLog(ltInfo,'SessionTicket' + SessionAuthQuery.FieldByName('CASTOKEN').AsString,'');


         if (NOT CasAuthenticated) and (ExternalWebsvc(nil, CASOutput,OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/CASCHECKTICKETURL') + Aqueryfields.Values['ticket'],'GET','') = 200) then begin
            ProcessLog(ltInfo,'CAS AUTHENTICATED',Trim(CASOutput.text));
            CASAuthenticated := True;
            CasUserName := Trim(CASOutput.text);
            ProcessLog(ltInfo,'CAS UserName',CASUsername);
         end;

         if CASAuthenticated then begin
            PL.AddAppValue('USERNAME',  CASUsername);
            If GetRNUser(CASUsername) then begin
               SessionAuthQuery.Edit;
               SessionAuthQuery.FieldByName('CustomerSC').AsInteger := -1;
               SessionAuthQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime := Now + EncodeTime(1,0,0,0);
               SessionAuthQuery.FieldByName('CASTOKEN').AsString := Trim(Aqueryfields.Values['ticket']);
               SessionAuthQuery.FieldByName('Username').AsString := CASUsername;
               SessionAuthQuery.FieldByName('MembType').AsString := 'ADMIN';
               SessionAuthQuery.FieldByName('ExternalXML').AsString := GetHJSchoolsByRepID(UserXMLGetTag('/USERPROFILE/EXTERNALINTEGRATION/HJREPID'));
               SessionAuthQuery.Post;
               LoadSessionVars(SessionAuthQuery);
               SessionAuthQuery.Close;
            end else begin
               result := '<HTML><head><title>CAS USER NOT FOUND</title></head><BODY>USER ' + CASUSERNAME + ' NOT PROVISIONED ON THIS SYSTEM</BODY></HTML>';
               ProcessLog(ltWarning,'CAS User Not Found',CasUserName);
               exit;
            end;
         end else begin
            ProcessLog(ltWarning,'CAS AUTHENTICATION FAILED',CASOutput.text);
         end;
         CASOutPut.Free;
      end;

      If CASAuthenticated then begin
         If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOGINURL') <> '' then begin
            result := '<head><title>Portal Logon</title>' +
               '<meta http-equiv="refresh" content="0;URL='+ OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOGINURL')+'"></head>';
         end else begin
            result := '<head><title>Portal Logon</title>' +
                                '<meta http-equiv="refresh" content="0;URL=/PP"></head>';
         end;
      end else begin
         result := '<HTML><head><title>CAS Authentication Failed</title></head><BODY>AUTHENTICATION FAILED</BODY></HTML>';
      end;
      exit;
   end else if OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/AUTHENTICATIONTYPE') = 'EXTERNAL' then begin    //2018-09-12 jtm: DVST-1392
      AccessToken := trim(AContentFields.Values['AccessToken']);
      if (AuthenticateOktaUser(AccessToken,ARNID)) then begin
         result := RNSessionID;
      end else begin
         result := 'Authentication Failed';
      end;
      exit;
   end else begin  //Custer end user authentication
      ProcessLog(ltInfo,'End user authentication',email);
      IsRedirectToChangePW := False; //2019-2-13 ss: DVST-3838
      PL.AddAppValue('EMAIL',  Email);
      RNQuery.Close;
      RNQuery.SQL.Clear;
      RNQuery.SQL.Add('Select * from Customers where (StoreCode = '+ARNID + ') and (Email = ''' + email + ''')');
      RNQuery.Open;
      WS := LoadWebFileFromFolder('default.htm','');
      If OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/CASESENSITIVE', 'FALSE') = 'FALSE' then Password := UpCaseString(Password);

      If RNQuery.RecordCount = 1 then begin
         ProcessLog(ltInfo,'End user authentication Email Found',email);
         If Email = '' then begin
            ReplaceString(WS,'%ERROR%', '<B><font color="red">Please enter valid Email</font></B>');
         end else if Password = '' then begin
            ReplaceString(WS,'%ERROR%', '<B><font color="red">Please enter your Password</font></B>');
         end else if (Trim(RNQuery.FieldByName('PasswordBcrypt').asString) = '') and (Trim(RNQuery.FieldByName('PasswordHash').asString) = StringToSHADigestHex('u.G&ONy@=NYWoKaiJ+_npPv.%Gj' + Trim(Password)))
                     AND (RNQuery.FieldByName('LockedUntil').AsDateTime < NOW)then begin
            ProcessLog(ltInfo,'new password hash added for:',email);

            if((RNQuery.FieldByName('MEMBTYPECODE').AsInteger = 0) And (StrToBool(OpenXMLGetTag('/CONFIGDATA/CHECKEXTCUSTOMERFIRSTLOGON','FALSE')))) then begin // 2019-2-13 ss: DVST-3838
               IsRedirectToChangePW := True;
               SessionVarEval.AddValue('MEMBTYPECODE',trim(RNQuery.FieldByName('MEMBTYPECODE').AsString));
            end;

            RNQuery.Edit;
            RNQuery.FieldByName('PasswordHash').AsString := '';
            RNQuery.FieldByName('PasswordBcrypt').AsString := BCryptPassword(Trim(Password),trim(RNQuery.FieldByName('CustomerCode').AsString));
            RNQuery.FieldByName('LastWebLogon').AsDateTime := Now;
            RNQuery.FieldByName('PWFailureCount').AsInteger := 0;

            if (RNQuery.FieldByName('MembType').AsString = 'ADMIN') and (RNQuery.FieldByName('RNEmployeeGUID').AsString = '') then begin  //2018-10-10 jtm: DVST-545
                RNQuery.FieldByName('RNEmployeeGUID').AsString := GetRNEmployeeGuidByEmail(Email);
            end;
            SessionVarEval.AddValue('RNEmployeeGUID',GuidOnly(RNQuery.FieldByName('RNEmployeeGUID').AsString));//2018-10-10 jtm: DVST-2076
            SessionVarEval.AddValue('CUSTOMERS.CUSTOMERCODE',GuidOnly(RNQuery.FieldByName('CustomerCode').AsString));//2018-12-19 jtm:
            SessionVarEval.AddValue('FirstName',RNQuery.FieldByName('FirstName').AsString);//2018-12-19 jtm:
            RNQuery.Post;
            SessionAuthQuery.Edit;
            SessionAuthQuery.FieldByName('CustomerSC').AsInteger := RNQuery.FieldByName('SystemCode').AsInteger;
            SessionAuthQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime := Now + EncodeTime(1,0,0,0);
            SessionAuthQuery.FieldByName('MembType').AsString := Trim(RNQuery.FieldByName('MembType').AsString);
            SessionVarEval.AddValue('MembType',trim(RNQuery.FieldByName('MembType').AsString));
            SessionVarEval.AddValue('MEMBSTATUS',trim(RNQuery.FieldByName('MEMBSTATUS').AsString));

            SessionAuthQuery.Post;
            SessionAuthQuery.Close;
            if (strtobool(OpenXMLGetTag('/CONFIGDATA/HEUPDATEEXISTINGACCOUNT','FALSE')) and (trim(RNQuery.FieldByName('MEMBSTATUS').AsString) = '')) then begin
               HEUpdateExistingAccount(RNQuery.FieldByName('SystemCode').AsInteger,ARNID);
            end;

            if(IsRedirectToChangePW) then begin // 2019-2-13 ss: DVST-3838
                  ProcessLog(ltDebug, 'Page=Authenticate', '3');
                  result := '<head><title>Portal Logon</title>' +
                          '<meta http-equiv="refresh" content="0;URL=/PP?PAGE=EDITLOGIN"></head>';
            end else begin
               ProcessLog(ltDebug, 'Page=Authenticate', '4');
               If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOGINURL') <> '' then begin
                  result := '<head><title>Portal Logon</title>' +
                          '<meta http-equiv="refresh" content="0;URL='+ OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOGINURL')+'"></head>';
               end else begin
                  result := '<head><title>Portal Logon</title>' +
                          '<meta http-equiv="refresh" content="0;URL=/PP"></head>';
               end;
            end;
            exit;
         end else If (CheckBCryptPassword(Trim(Password),trim(RNQuery.FieldByName('CustomerCode').AsString),Trim(RNQuery.FieldByName('PasswordBcrypt').asString))) AND (RNQuery.FieldByName('LockedUntil').AsDateTime < NOW) then begin
            ProcessLog(ltInfo,'Authenticated with bcrypt hash:',email);
            if((RNQuery.FieldByName('MEMBTYPECODE').AsInteger = 0) And (StrToBool(OpenXMLGetTag('/CONFIGDATA/CHECKEXTCUSTOMERFIRSTLOGON','FALSE')))) then begin // 2019-2-13 ss: DVST-3838
               IsRedirectToChangePW := True;
               SessionVarEval.AddValue('MEMBTYPECODE',trim(RNQuery.FieldByName('MEMBTYPECODE').AsString));
            end;

            RNQuery.Edit;
            RNQuery.FieldByName('LastWebLogon').AsDateTime := Now;
            RNQuery.FieldByName('PWFailureCount').AsInteger := 0;

            if (RNQuery.FieldByName('MembType').AsString = 'ADMIN') and (RNQuery.FieldByName('RNEmployeeGUID').AsString = '') then begin
                RNQuery.FieldByName('RNEmployeeGUID').AsString := GetRNEmployeeGuidByEmail(Email);
            end;
            SessionVarEval.AddValue('RNEmployeeGUID',GuidOnly(RNQuery.FieldByName('RNEmployeeGUID').AsString));
            SessionVarEval.AddValue('CUSTOMERS.CUSTOMERCODE',GuidOnly(RNQuery.FieldByName('CustomerCode').AsString));//2018-12-19 jtm:
            SessionVarEval.AddValue('accountFirstName',RNQuery.FieldByName('FirstName').AsString);//2018-12-19 jtm:
            RNQuery.Post;
            SessionAuthQuery.Edit;
            SessionAuthQuery.FieldByName('CustomerSC').AsInteger := RNQuery.FieldByName('SystemCode').AsInteger;
            SessionAuthQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime := Now + EncodeTime(1,0,0,0);
            SessionAuthQuery.FieldByName('MembType').AsString := Trim(RNQuery.FieldByName('MembType').AsString);
            SessionVarEval.AddValue('MembType',trim(RNQuery.FieldByName('MembType').AsString));
            SessionVarEval.AddValue('MEMBSTATUS',trim(RNQuery.FieldByName('MEMBSTATUS').AsString));

            SessionAuthQuery.Post;
            SessionAuthQuery.Close;
            if (strtobool(OpenXMLGetTag('/CONFIGDATA/HEUPDATEEXISTINGACCOUNT','FALSE')) and (trim(RNQuery.FieldByName('MEMBSTATUS').AsString) = '')) then begin
               HEUpdateExistingAccount(RNQuery.FieldByName('SystemCode').AsInteger,ARNID);
            end;
            
            if(IsRedirectToChangePW) then begin // 2019-2-13 ss: DVST-3838
               ProcessLog(ltDebug, 'Page=Authenticate', '5'); // 2019-2-13 ss: DVST-3838
               result := '<head><title>Portal Logon</title>' +
                       '<meta http-equiv="refresh" content="0;URL=/PP?PAGE=EDITLOGIN"></head>';
            end else begin
               If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOGINURL') <> '' then begin
                  result := '<head><title>Portal Logon</title>' +
                          '<meta http-equiv="refresh" content="0;URL='+ OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOGINURL')+'"></head>';
               end else begin
                  result := '<head><title>Portal Logon</title>' +
                          '<meta http-equiv="refresh" content="0;URL=/PP"></head>';
               end;
            end;
            exit;
         end else begin
            ProcessLog(ltWarning,'Password failure #' + IntToStr(RNQuery.FieldByName('PWFailureCount').AsInteger+1),email);

            RNQuery.Edit;
            RNQuery.FieldByName('PWFailureCount').AsInteger := RNQuery.FieldByName('PWFailureCount').AsInteger+1;
            RNQuery.Post;

            If RNQuery.FieldByName('PWFailureCount').AsInteger >3 then begin
               RNQuery.Edit;
               RNQuery.FieldByName('LockedUntil').AsDateTime := NOW + EncodeTime(0,30,0,0);
               RNQuery.Post;
            end;

            If RNQuery.FieldByName('LockedUntil').AsDateTime > NOW then begin
               ReplaceString(WS,'%ERROR%', '<B><font color="red">Account Locked</font></B>');


            end else If RNQuery.FieldByName('PWFailureCount').AsInteger = 3 then begin
               RNQuery.Edit;
               RNQuery.FieldByName('ResetExpires').AsDateTime := NOW + EncodeTime(2,00,0,0);
               RNQuery.FieldByName('ResetGuid').AsString := GenerateGUID;
               RNQuery.Post;
               VarEvaluator.AddDSCurrentRecord(RNQuery, 'Customers');

               SendPWReset(RNquery);
               ReplaceString(WS,'%ERROR%', '<B><font color="red">Password Reset Link sent</font></B>');
            end else
               ReplaceString(WS,'%ERROR%', '<B><font color="red">Invalid Password, please try again.</font></B>');



            ReplaceString(WS,'%EMAIL%', email);
         end;
      end;
      ReplaceString(WS,'%ERROR%', '<B><font color="red">E-Mail address not found.</font></B>');
      ReplaceString(WS,'%EMAIL%', email);

      RNQuery.Close;
      result := WS;
   end;
end;
Procedure TCustomerInfoModule.SendPWReset(ADS : TDataSet);
var
   WS : String;
Begin
   WS := LoadWebFileFromFolder('PWResetEmail.htm','');
   If WS = '' then begin
      WS := '<HTML>Thank you for your login request.<BR>If you are having difficulty accessing your account, click <A HREF="https://'+UpCaseString(Request.Host)+'/PP?PAGE=PWRESET&RESETGUID='+
            Trim(ADS.FieldByName('ResetGUID').AsString) +'&CUSTIDENT='+Trim(ADS.FieldByName('CustomerCode').AsString)+'">here</A> to Reset your password.<BR>Thank you.';
   end;
   clMail.BuildMessage('',WS);
   clMail.From.FullAddress := '"' + DomainFriendlyName+'"<'+DomainSendAsEmail+'>';
   clMail.ToList.EmailAddresses := Trim(ADS.FieldByName('Email').AsString);
   clMail.Subject := 'Password Reset Request from ' + DomainFriendlyName;
   ProcessLog(ltinfo,'SendPWReset','Email:'+Trim(ADS.FieldByName('Email').AsString));
   SMTP.Open();
   try
      SMTP.Send(clMail);
   finally
      SMTP.Close();
   end;
end;
function TCustomerInfoModule.AuthenticateOktaUser(const AAccessToken: string; const ARNID: string): boolean;
var
EPRequest : TStringList;
EPResult : TStringList;
HTTPStatus : integer;
xmlstr : string;
OktaXML : TOpenXML;
OktaXMLNode : TOpenXMLNode;
requestsuccess : boolean;
ADS : TdataSet;
CustGUID : string;
begin
   result := false;
   EPRequest := TStringList.Create;
   EPResult := TStringList.Create;
   SessionVarEval.AddValue('RNSessionID',RNSessionID);
   SessionVarEval.AddValue('AccessToken',trim(AAccessToken));
   SessionVarEval.AddValue('ClientID',OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/OKTACLIENTID'));
   EPRequest.Add(trim(LoadWebFileFromFolder('OktaAuth.txt', 'OktaAuth')));
   HTTPStatus := ExternalWebSvcEx(EPRequest,EPResult,OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/WEBAPIURL'),'POST','','',false);
   if (EPResult.Text <> '') and (HTTPStatus = 200) then begin
      xmlstr :=  EPResult.Text;
      xmlstr := JSONToXML(xmlstr);
      Try
         OktaXML := TOpenXML.CreateFromString(Nil,xmlstr);
      except
         On E:Exception do begin
            ProcessLog(ltWarning, 'Exception OktaXML: ', E.Message);
            exit;
         end;
      end;

      OktaXMLNode := OktaXML.GetNode('/JSON').FindFirstChildElement;

      while (OktaXMLNode <> nil) do begin
         SessionVarEval.AddValue(OktaXMLNode.NodeName, OktaXMLNode.TextContent);
         OktaXMLNode := OktaXMLNode.FindNextSiblingElement;
      end;
      requestsuccess := OktaXML.GetValueAsBoolean('/JSON/active');
      if (requestsuccess) then begin
         ADS := GetCustomerByAccountNum(ARNID, Trim(OktaXML.GetValueAsWideString('/JSON/uid')));
         If (assigned(ADS)) then begin
            CustGUID := '';
            if (ADS.RecordCount > 1) then begin
               requestsuccess := false;
            end else if (ADS.RecordCount = 1) then begin
               CustGUID:= Trim(ADS.FieldByName('CustomerCode').AsString);
            end else begin
               ADS.Insert;
               CustGUID := GenerateGUID;
               ADS.FieldByName('ChainCode').AsInteger := ChainCode;
               ADS.FieldByName('StoreCode').AsString := ARNID;
               ADS.FieldByName('StartDate').AsDateTime := Now;
               ADS.FieldByName('CustomerCode').AsString := CustGUID;
               ADS.FieldByName('AccountNumber').AsString :=  Trim(OktaXML.GetValueAsWideString('/JSON/uid'));
               ADS.FieldByName('ConfirmGUID').AsString := GenerateGUID;
               if Pos('@',OktaXML.GetValueAsWideString('/JSON/username')) > 0 then begin
                  ADS.FieldByName('Email').AsString := OktaXML.GetValueAsWideString('/JSON/username');
               end;
               if GetConfigBoolean('REQUIREVALIDATION',True) then begin
                  ADS.FieldByName('ConfirmGUID').AsString := GenerateGUID;
               end else begin
                  ADS.FieldByName('ConfirmGUID').AsString := 'VALIDATED';
               end;
               ADS.Post;
            end;
            SessionVarEval.AddDSCurrentRecord(ADS,'Customers');
            SessionVarEval.AddValue('OktaTokenExp',FormatDateTime('MM/DD/YYYY HH:MM:SS',UnixToDateTime(OktaXML.GetValueAsInteger('/JSON/exp'))));
            SessionVarEval.AddValue('OktaTokenIssued',FormatDateTime('MM/DD/YYYY HH:MM:SS',UnixToDateTime(OktaXML.GetValueAsInteger('/JSON/iat'))));
            SessionAuthQuery.Close;
            SessionAuthQuery.SQL.Clear;
            SessionAuthQuery.SQL.Add('Select * from WWWSession where RNSessionID = ''' + RnSessionID + '''');
            SessionAuthQuery.Open;

            If SessionAuthQuery.RecordCount = 1 then begin
               SessionAuthQuery.Edit;
               SessionAuthQuery.FieldByName('CustomerSC').AsString := ADS.FieldByName('SystemCode').AsString;
               if strtobool(OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/USEOKTASESSIONEXP','FALSE')) then begin
                  SessionAuthQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime := UnixToDateTime(OktaXML.GetValueAsInteger('/JSON/exp')); //Now + EncodeTime(1,0,0,0);
               end else begin
                  SessionAuthQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime := Now + EncodeTime(1,0,0,0);
               end;
               SessionAuthQuery.FieldByName('MembType').AsString := '';
               SessionAuthQuery.Post;
            end;
         end else begin
            requestsuccess := false;
         end;
      end;
   end else begin
     requestsuccess := false;
   end;
   Result := requestsuccess;
   FreeAndNil(OktaXML);
   FreeAndNil(EPRequest);
   FreeAndNil(EPResult);
end;

function TCustomerInfoModule.GetCustomerByAccountNum(const ARNID,AAccountNumber: string): TDataset;
Var
   ADS : TADOQuery;
   WS : String;
Begin
   Result := NIL;
   ADS := NewADOQUery;
   Result := ADS;
   Try
      ADS.SQL.Clear;
      ADS.ParamCheck := True;
      ADS.SQL.Add('Select * from Customers where (StoreCode = :CustRNID) and (AccountNumber = :AccountNumber)');

      if (AAccountNumber = '') then begin
         ADS.Parameters.ParamByName('AccountNumber').DataType := ftString;
         ADS.Parameters.ParamByName('AccountNumber').Value := null;
      end else begin
         ADS.Parameters.ParamByName('AccountNumber').Value := AAccountNumber;
      end;
      if (ARNID = '') then begin
         ADS.Parameters.ParamByName('CustRNID').DataType := ftString;
         ADS.Parameters.ParamByName('CustRNID').Value := null;
      end else begin
         ADS.Parameters.ParamByName('CustRNID').Value := ARNID;
      end;

      ADS.Open;
   except
      on E:Exception do begin
         ProcessLog(ltWarning,'Exception GetCustomerByAccountNum' + E.Message,InstanceGUID);
      end;
   end;
end;

Function TCustomerInfoModule.GetTempusJS(const AQueryFields, AContentFields: TStrings): string;
Var
   WS : String;
   FileVersion : string;
   FileName : string;
Begin
   Result := '';
   if (ValidateSessionID) then begin
      FileVersion := ValidCharsOnly(AQueryFields.Values['VERSION'],false,True,'-.');
      FileName := ValidCharsOnly(AQueryFields.Values['FILENAME'],true,True,'-.');
      if strtobool(OpenXMLGetTag('/CONFIGDATA/TEMPUSJS/FILE[NAME="' + trim(FileName) + '"]/ENABLED','FALSE')) then begin
         if (FileVersion <>'') then begin
            WS := LoadWebFileFromFolder(AddBackslash(FileName)+AddBackslash(FileVersion)+FileName+'.js', 'TempusJS');
         end else begin
            WS := LoadWebFileFromFolder(AddBackslash(FileName)+AddBackslash('current')+FileName+'.js','TempusJS');
         end;
         Response.ContentType := 'application/javascript';
      end else begin
          WS := 'File not configured';
      end;
   end else begin
      WS := 'Invalid Session';
   end;
   Result := WS;
end;

function TCustomerInfoModule.MakeCustomSplitTable(xmlWithData: String):String;
const
   STR_FIRST_CHAR_INDEX = 1;
   TARGET_CHILD_NODE = 'SPLITDETAIL';
var
   xml: String;
   delimitedXMLTags: String;
   delimitedHeaders: String;
   delimitedColDataTypes: String;
   delimiterStr: String;
   delimiter: Char;
   table: string;
   headers: string;
   tableData: string;
begin
   table:= '';
   headers:= '';
   tableData:= '';

   delimiterStr := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SPLITTABLE/DELIMITER');
   delimiter := delimiterStr[STR_FIRST_CHAR_INDEX];
   delimitedXMLTags := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SPLITTABLE/SPLITDETAILTAGS');
   delimitedHeaders := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SPLITTABLE/RECEIPTTABLEHEADERS');
   delimitedColDataTypes := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SPLITTABLE/COLUMNDATATYPE');

   If IsValidTableConfig(delimiter, delimitedXMLTags, delimitedHeaders) then begin
      headers := GetTableHeader(delimiter, delimitedHeaders);
      tableData := GetTableData(delimiter, xmlWithData, TARGET_CHILD_NODE, delimitedXMLTags, delimitedColDataTypes);
      table := '<TABLE>' + headers + tableData + '</TABLE>';
   end Else begin
      table:= 'Invalid SPLITTABLE configuration in DomainConfigXML. Please check the number of SPLITDETAILTAGS and TABLEHEADERS.';
   end;

   Result:= table;
end;
function TCustomerInfoModule.GetAStringListFromDelimiterAndDelimitedText(delimiter: Char; delimitedText: String):TTTStringList;
var
   ATTStringList: TTTStringList;
begin
   ATTStringList := TTTStringList.Create();
   ATTStringList.Delimiter := delimiter;
   ATTStringList.StrictDelimiter := true;
   ATTStringList.DelimitedText := delimitedText;
   Result := ATTStringList;
end;

function TCustomerInfoModule.IsValidTableConfig(delimiter: Char; delimitedTags, delimitedHeaders: String):Boolean;
var
   tagList : TTTStringList;
   headerList: TTTStringList;
begin
   tagList := GetAStringListFromDelimiterAndDelimitedText(delimiter, delimitedTags);
   headerList := GetAStringListFromDelimiterAndDelimitedText(delimiter, delimitedHeaders);
   Result := tagList.Count = headerList.Count;
   FreeAndNil(tagList);
   FreeAndNil(headerList);
end;

function TCustomerInfoModule.GetTableHeader(delimiter: Char; delimitedHeaders: String):String;
var
   headers: string;
   tableHeaders: TTTStringlist;
   i: integer;
begin
   headers := '';
   tableHeaders := GetAStringListFromDelimiterAndDelimitedText(delimiter, delimitedHeaders);
   for i := 0 to tableHeaders.Count-1  do begin
      headers := headers + '<TH align="CENTER">'+tableHeaders[i]+'</TH>';
   end;
   headers := '<TR>' + headers + '</TR>';
   FreeAndNil(tableHeaders);
   Result:= headers;
end;

function TCustomerInfoModule.GetTableData(delimiter: Char; xmlWithData, targetChildNode, delimitedTags, delimitedDataTypes: String):String;
var
   tableData: string;
   i: Integer;
   targetXMLNode: string;
   xmlTagList: TTTStringlist;
   dataTypeList: TTTStringlist;
begin
   tableData:= '';
   xmlTagList:= GetAStringListFromDelimiterAndDelimitedText(delimiter, delimitedTags);
   dataTypeList:= GetAStringListFromDelimiterAndDelimitedText(delimiter, delimitedDataTypes);

   i := 1;
   targetXMLNode := Utility.GetNXMLTagStr(xmlWithData, targetChildNode, i);
   while targetXMLNode <> '' do begin
      tableData := tableData + '<TR>' +
                   BuildTableDataOfTargetNode(targetXMLNode, xmlTagList, dataTypeList) +
                   '</TR>';
      Inc(i);
      targetXMLNode := Utility.GetNXMLTagStr(xmlWithData, targetChildNode, i);
   end;
   Result := tableData;
   FreeAndNil(xmlTagList);
   FreeAndNil(dataTypeList);
end;

function TCustomerInfoModule.BuildTableDataOfTargetNode(targetXMLNode: String; xmlTagList, dataTypeList: TTTStringList):String;
var
   i: Integer;
   tableData: String;
begin
   tableData := '';
   for i:= 0 to xmlTagList.Count-1 do begin
      tableData := tableData + '<TD align="CENTER">';
      if i < dataTypeList.Count then begin
         tableData := tableData + MapDataTypeAndGetXMLTagStr(targetXMLNode, xmlTagList[i], dataTypeList[i]);
      end else begin
         tableData := tableData + GetXMLTagStr(targetXMLNode, xmlTagList[i]);
      end;
      tableData := tableData + '</TD>';
   end;
   Result := tableData;
end;

function TCustomerInfoModule.MapDataTypeAndGetXMLTagStr(targetXMLNode, tagName, dataType: String):String;
begin
   if dataType = 'Cur' then begin
      Result := '$'+Trim(StriReal(ValuReal(GetXMLTagStr(targetXMLNode,tagName)),2)); // 2018-12-19 ss: DVST-3056 $ for amount at receipt emails and sub row grid of dhtmlx
   end else if dataType = 'Int' then begin
      Result := GetXMLTagStr(targetXMLNode, tagName);
   end else if dataType = 'Str' then begin
      Result := GetXMLTagStr(targetXMLNode, tagName);
   end else begin
      Result := GetXMLTagStr(targetXMLNode, tagName);
   end;
end;
function TCustomerInfoModule.HealthEdgeAPIRequest(const ARequestName: string; var AHEResponse: TStringList): boolean;
var
requestsuccess : boolean;
AHERequest : TStringList;
begin
   requestsuccess := false;
   AHERequest := TStringList.Create;
   if (ARequestName = 'accountReferenceLookup') then begin
      requestsuccess := HealthEdgeAccountReferenceLookup(AHERequest,AHEResponse);
   end else if (ARequestName = 'findBills') then begin
      requestsuccess := HealthEdgeFindBills(AHERequest,AHEResponse);
   end else if (ARequestName = 'getBillDetailsByID') then begin
      requestsuccess := HealthEdgeGetBillDetailsByID(AHERequest,AHEResponse);
   end else if (ARequestName = 'getMemberDetailsByHccId') then begin
      requestsuccess := HealthEdgeGetMemberDetailsByHccId(AHERequest,AHEResponse);
   end else if (ARequestName = 'membershipLookup') then begin
      requestsuccess := HealthEdgeMembershipLookup(AHERequest,AHEResponse);
   end else begin
      requestsuccess := false;
   end;
   result := requestsuccess;
   FreeAndNil(AHERequest);
end;
function TCustomerInfoModule.HealthEdgeAccountReferenceLookup(var AHERequest,AHEResponse: TStringList): boolean;
var
HTTPStatus : integer;
requestsuccess : boolean;
employerStr : string;
begin
   result := false;
   SessionVarEval.AddValue('RNSessionID',RNSessionID);
   AHERequest.Add(trim(LoadWebFileFromFolder('accountReferenceLookup.xml', 'HealthEdgeAPI')));
   HTTPStatus := ExternalWebSvcEx(AHERequest,AHEResponse,OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/HE/ACCOUNTREFERENCELOOKUP/APIURL'),'POST',OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/HE/ACCOUNTREFERENCELOOKUP/APIUN'),OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/HE/ACCOUNTREFERENCELOOKUP/APIPW'),false);
   if (AHEResponse.Text <> '') and (HTTPStatus = 200) then begin
      if (GetXMLTagStr(AHEResponse.Text,'status') =  'Multiple Match Found') or (GetXMLTagStr(AHEResponse.Text,'status') =  'Match Found') then begin
         employerStr := '<accountReference>'+GetXMLTagStr(AHEResponse.Text,'accountReference')+'<childGUID>'+VarEvaluator.GetValueAsString('ChildGUID')+'</childGUID></accountReference>';
         SessionVarEval.AddValue('subscriptionId',trim(GetXMLTagStr(employerStr,'parentAccountHccIdentificationNumber')));
         VarEvaluator.AddValue('subscriptionId',trim(GetXMLTagStr(employerStr,'parentAccountHccIdentificationNumber')));
         VarEvaluator.AddValue('employerXML', employerStr);
         result := true;
      end;
   end;

end;

function TCustomerInfoModule.HealthEdgeFindBills(var AHERequest,AHEResponse: TStringList): boolean;
var
HTTPStatus : integer;
requestsuccess : boolean;
billXML : TOpenXML;
billXMLNode : TOpenXMLNode;
billXMLStr : string;
begin
   result := false;
   AHERequest.Add(trim(LoadWebFileFromFolder('findBills.xml', 'HealthEdgeAPI')));
   HTTPStatus := ExternalWebSvcEx(AHERequest,AHEResponse,OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/HE/FINDBILLS/APIURL'),'POST',OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/HE/FINDBILLS/APIUN'),OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/HE/FINDBILLS/APIPW'),false);
   if (AHEResponse.Text <> '') and (HTTPStatus = 200) then begin
      if (LoadOpenXML(billXML,AHEResponse.Text)) then begin
         billXMLNode := billXML.GetNode('/soap:Envelope/soap:Body/*');
         if (billXMLNode <> nil) and (billXMLNode.HasChildNodes) then begin
            SessionVarEval.AddValue('BillID', billXMLNode.FindLastChildElement.TextContent);
            VarEvaluator.AddValue('BillID', billXMLNode.FindLastChildElement.TextContent);
            result := true;
         end;
      end;
      FreeAndNil(billXML);
   end;
end;

function TCustomerInfoModule.HealthEdgeGetBillDetailsByID(var AHERequest,AHEResponse: TStringList): boolean;
var
HTTPStatus : integer;
requestsuccess : boolean;
billStr : string;
HEResponseXML : TOpenXML;
HEResponseXMLNode : TOpenXMLNode;
billSL : TStringList;
procedure RemoveXML(AXPath:string);
var
Node : TOpenXMLNode;
begin
   Node := HEResponseXML.GetNode(AXPath);
   while (Node <> nil) do begin     //loop through to make sure we get all of them
      HEResponseXML.RemoveNode(AXPath);
      Node := HEResponseXML.GetNode(AXPath);
   end;
end;
begin
   result := false;
   AHERequest.Add(trim(LoadWebFileFromFolder('getBillDetailsByID.xml', 'HealthEdgeAPI')));
   HTTPStatus := ExternalWebSvcEx(AHERequest,AHEResponse,OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/HE/GETBILLDETAILSBYID/APIURL'),'POST',OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/HE/GETBILLDETAILSBYID/APIUN'),OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/HE/GETBILLDETAILSBYID/APIPW'),false);
   if (AHEResponse.Text <> '') and (HTTPStatus = 200) then begin
      if (VarEvaluator.GetValueAsString('memberType') <> 'Employer') then begin
       billStr := '<bill>'+GetXMLTagStr(AHEResponse.Text,'bill')+'<childGUID>'+VarEvaluator.GetValueAsString('ChildGUID')+'</childGUID></bill>';

      end else begin
         if (LoadOpenXML(HEResponseXML,'<bill>'+GetXMLTagStr(AHEResponse.Text,'bill')+'</bill>')) then begin
            RemoveXML('/bill/billRecepient');
            RemoveXML('/bill/payToAddress');
            RemoveXML('/bill/reportedPremiumPayments');
            RemoveXML('/bill/subAccountSections/subAccountSection/benefitPlanSections');

            billStr := HEResponseXML.DocumentAsString;
            FreeAndNil(HEResponseXML);
         end;
      end;
       VarEvaluator.AddValue('billXML', billStr);
       result := true;
   end;

end;

function TCustomerInfoModule.HealthEdgeGetMemberDetailsByHccId(var AHERequest,AHEResponse: TStringList): boolean;
var
HTTPStatus : integer;
requestsuccess : boolean;
HEResponseXML : TOpenXML;
HEResponseXMLNode : TOpenXMLNode;
memberStr,dob : string;
memberSL : TStringList;
procedure RemoveXML(AXPath:string);
var
Node : TOpenXMLNode;
begin
   Node := HEResponseXML.GetNode(AXPath);
   while (Node <> nil) do begin     //loop through to make sure we get all of them
      HEResponseXML.RemoveNode(AXPath);
      Node := HEResponseXML.GetNode(AXPath);
   end;
end;
procedure AddXMLToSL(AXPath:string);
begin
   memberSL.Add(HEResponseXML.GetXPathNodeAsXMLString(AXPath,false));
end;
begin
   result := false;
   ProcessLog(ltDebug, 'VarEvaluator MemberHCCID:',VarEvaluator.GetValueAsString('MemberHCCID'));
   AHERequest.Add(trim(LoadWebFileFromFolder('getMemberDetailsByHccId.xml', 'HealthEdgeAPI')));
   HTTPStatus := ExternalWebSvcEx(AHERequest,AHEResponse,OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/HE/GETMEMBERSHIPDETAILS/APIURL'),'POST',OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/HE/GETMEMBERSHIPDETAILS/APIUN'),OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/HE/GETMEMBERSHIPDETAILS/APIPW'),false);
   if (AHEResponse.Text <> '') and (HTTPStatus = 200) then begin
      if (LoadOpenXML(HEResponseXML,'<member>'+GetXMLTagStr(AHEResponse.Text,'member')+'</member>')) then begin
         RemoveXML('/member/historicalPlans/planInformation/valueList');
         RemoveXML('/member/currentPlans/planInformation/valueList');
         RemoveXML('/member/subscriberInformation');
         RemoveXML('/member/otherIds');
         RemoveXML('/member/phoneNumbers');
         RemoveXML('/member/account/correspondenceAddress');
         RemoveXML('/member/account/udtList');
         RemoveXML('/member/account/taxId');
         RemoveXML('/member/hierarchialAccountInformation/topAccountUDTList');
         RemoveXML('/member/correspondenceAddress');

         memberSL := TStringList.Create;
         memberSL.Add('<member>');
         AddXMLToSL('/member/birthDate');
         AddXMLToSL('/member/effectiveDate');
         AddXMLToSL('/member/firstName');
         AddXMLToSL('/member/lastName');
         AddXMLToSL('/member/subscriberId');
         AddXMLToSL('/member/subscriberSystemId');
         AddXMLToSL('/member/subscriptionId');
         AddXMLToSL('/member/subscriptionSystemId');
         AddXMLToSL('/member/systemId');
         AddXMLToSL('/member/account');
         AddXMLToSL('/member/currentPlans');
         AddXMLToSL('/member/historicalPlans');
         memberSL.Add('<childGUID>'+VarEvaluator.GetValueAsString('ChildGUID')+'</childGUID></member>');
         memberStr := memberSL.Text;//HEResponseXML.DocumentAsString;
         VarEvaluator.AddValue('memberXML', memberStr);
         SessionVarEval.AddValue('subscriptionId',trim(GetXMLTagStr(memberStr,'subscriptionId')));
         SessionVarEval.AddValue('Member.subscriptionId',trim(GetXMLTagStr(memberStr,'subscriptionId')));
         SessionVarEval.AddValue('Member.subscriberId',trim(GetXMLTagStr(memberStr,'subscriberId')));
         SessionVarEval.AddValue('Member.subscriberSystemId',trim(GetXMLTagStr(memberStr,'subscriberSystemId')));
         SessionVarEval.AddValue('Member.subscriptionSystemId',trim(GetXMLTagStr(memberStr,'subscriptionSystemId')));
         SessionVarEval.AddValue('Member.systemId',trim(GetXMLTagStr(memberStr,'systemId')));
         VarEvaluator.AddValue('subscriptionId',trim(GetXMLTagStr(memberStr,'subscriptionId')));
         VarEvaluator.AddValue('Member.subscriptionId',trim(GetXMLTagStr(memberStr,'subscriptionId')));
         VarEvaluator.AddValue('Member.subscriberId',trim(GetXMLTagStr(memberStr,'subscriberId')));
         VarEvaluator.AddValue('Member.subscriberSystemId',trim(GetXMLTagStr(memberStr,'subscriberSystemId')));
         VarEvaluator.AddValue('Member.subscriptionSystemId',trim(GetXMLTagStr(memberStr,'subscriptionSystemId')));
         VarEvaluator.AddValue('Member.systemId',trim(GetXMLTagStr(memberStr,'systemId')));
         dob := FormatDateTime('MM/DD/YYYY',DateTimeStringWithMilliSecondsToDateTime(trim(GetXMLTagStr(memberStr,'birthDate'))+' 00:00:00.000')); //Takes datettime string of YYYY/MM/DD HH:NN:SS.ZZZ
         VarEvaluator.AddValue('Member.birthDate',dob);
         VarEvaluator.AddValue('Member.lastName',trim(GetXMLTagStr(memberStr,'lastName')));
         VarEvaluator.AddValue('Member.firstName',trim(GetXMLTagStr(memberStr,'firstName')));

         VarEvaluator.AddValue('Member.account.id',trim(HEResponseXML.GetValueAsWideString('/member/account/id')));
         VarEvaluator.AddValue('Member.account.name',trim(HEResponseXML.GetValueAsWideString('/member/account/name')));
         VarEvaluator.AddValue('Member.account.accountType',trim(HEResponseXML.GetValueAsWideString('/member/account/accountType')));
         VarEvaluator.AddValue('Member.account.accountTypeCode',trim(HEResponseXML.GetValueAsWideString('/member/account/accountTypeCode')));
         FreeAndNil(memberSL);
         FreeAndNil(HEResponseXML);
      end;
      result := true;
   end;

end;

function TCustomerInfoModule.HealthEdgeMembershipLookup(var AHERequest,AHEResponse: TStringList): boolean;
var
HTTPStatus : integer;
requestsuccess : boolean;
membershipStr : string;
begin
   result := false;
   AHERequest.Add(trim(LoadWebFileFromFolder('membershipLookup.xml', 'HealthEdgeAPI')));
   HTTPStatus := ExternalWebSvcEx(AHERequest,AHEResponse,OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/HE/MEMBERSHIPLOOKUP/APIURL'),'POST',OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/HE/MEMBERSHIPLOOKUP/APIUN'),OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/HE/MEMBERSHIPLOOKUP/APIPW'),false);
   if (AHEResponse.Text <> '') and (HTTPStatus = 200) then begin
      if (GetXMLTagStr(AHEResponse.Text,'status') =  'Multiple Match Found') or (GetXMLTagStr(AHEResponse.Text,'status') =  'Match Found') then begin
         membershipStr := '<membership>'+GetXMLTagStr(AHEResponse.Text,'ns8:membership')+'<childGUID>'+VarEvaluator.GetValueAsString('ChildGUID')+'</childGUID></membership>';
         VarEvaluator.AddValue('membershipXML', membershipStr);
         result := true;
      end;
   end;
end;

procedure TCustomerInfoModule.XMLToVarEval(AVarEval: TVarEval; AXML,AParentTag: string);
var
OXML : TOpenXML;
OXMLNode : TOpenXMLNode;
   procedure  ProcessChildNodes(AOXMLNode:TOpenXMLNode; AParentTag: string);
   begin
      AOXMLNode := AOXMLNode.FindFirstChildElement;
      while (AOXMLNode <> nil) do begin
         if (AOXMLNode.FindFirstChildElement <> nil) then begin
            ProcessChildNodes(AOXMLNode,AParentTag + '.' + AOXMLNode.NodeName);
         end else begin
            AVarEval.AddValue(AParentTag + '.' +AOXMLNode.NodeName, AOXMLNode.TextContent);
         end;
         AOXMLNode := AOXMLNode.FindNextSiblingElement;
      end;
   end;
begin
   Try
      OXML := TOpenXML.CreateFromString(Nil,AXML);
   except
      On E:Exception do begin
         ProcessLog(ltWarning, 'Exception OktaXML: ', E.Message);
         exit;
      end;
   end;

   OXMLNode := OXML.GetNode('/'+AParentTag).FindFirstChildElement;

   while (OXMLNode <> nil) do begin
      if (OXMLNode.FindFirstChildElement <> nil) then begin
         ProcessChildNodes(OXMLNode,OXMLNode.NodeName);
      end else begin
         AVarEval.AddValue(OXMLNode.NodeName, OXMLNode.TextContent);
      end;
      OXMLNode := OXMLNode.FindNextSiblingElement;
   end;
   FreeAndNil(OXML);
end;

function TCustomerInfoModule.AddAccountAjax(const AQueryFields, AContentFields: TStrings; ARNID : string): string;
var
email,Password,memberType,ParentGUID,firstname,lastname,dob,accountnum,EmployerAccountID: string;
WS,totalAmountDue: string;
ResponseJSON : TStringList;
TranSuccess,MemberValidated,MemberTermed : boolean;
TranMessage : string;
   Procedure FinalizeJSONRespAndFree;
   Begin
      ResponseJSON.Add('"serverdate" : "'+FormatDateTime('MM/DD/YYYY', now)+'",');
      ResponseJSON.Add('"servertime" : "'+FormatDateTime('HH:NN:SS', now)+'",');
      ResponseJSON.Add('"tranrespmessage" : "'+TranMessage+'",');
      ResponseJSON.Add('"profile" : "'+ARNID+'",');
      if TranSuccess then begin
         ResponseJSON.Add('"transuccess" : true');
      end else begin
         ResponseJSON.Add('"transuccess" : false');
         ProcessLog(ltWarning, 'AddAccountAjax transucces false:',TranMessage);
   end;
      ResponseJSON.Add('}');
      Result := ResponseJSON.Text;
      ResponseJSON.Free;
   end;
begin
   result := '';
   MemberValidated := false;
   MemberTermed := false;
   TranSuccess := false;
   ResponseJSON := TStringList.Create;
   ResponseJSON.Add('{');
   EMail := ValidCharsOnly(Trim(AContentFields.Values['email']),True,True,'_.-#@+/');
   SessionVarEval.AddValue('WEUSERID', Email);
   Password := AContentFields.Values['password'];

   if (Email = '') then begin
      TranSuccess := false;
      TranMessage := 'Invalid Email';
      FinalizeJSONRespAndFree;
      Exit;
   end;

   RNQuery.Close;
   RNQuery.SQL.Clear;
   RNQuery.SQL.Add('Select * from Customers where (StoreCode = '+ARNID + ') and (Email = ''' + email + ''')');
   RNQuery.Open;
   If RNQuery.RecordCount > 0 then begin
      RNQuery.Close;
      TranSuccess := false;
      TranMessage := 'Account Already exists';
      FinalizeJSONRespAndFree;
      exit;
   end;
   memberType := ValidCharsOnly(Trim(AContentFields.Values['memberType']),True,false,'');
   if (memberType = 'Member') or (memberType = 'Employer') or (memberType = 'Guest') then begin
      SessionVarEval.AddValue('MemberHCCID',ValidCharsOnly(Trim(AContentFields.Values['memberID']),True,true,'- '));
      SessionVarEval.AddValue('EmployerAccountID',ValidCharsOnly(Trim(AContentFields.Values['EmployerAccountID']),True,true,'- '));
      SessionVarEval.AddValue('TaxID',ValidCharsOnly(Trim(AContentFields.Values['TaxIDNumber']),True,true,'- '));
      VarEvaluator.AddValue('MemberHCCID',ValidCharsOnly(Trim(AContentFields.Values['memberID']),True,true,'- '));
      VarEvaluator.AddValue('EmployerAccountID',ValidCharsOnly(Trim(AContentFields.Values['EmployerAccountID']),True,true,'- '));
      VarEvaluator.AddValue('TaxID',ValidCharsOnly(Trim(AContentFields.Values['TaxIDNumber']),True,true,'- '));
      VarEvaluator.AddValue('memberType',memberType);
      TranSuccess := ValidateHEUser(memberType,TranMessage);
      if not TranSuccess then begin
         FinalizeJSONRespAndFree;
         exit;
      end else begin  //validate against other fields
         if (memberType = 'Member') then begin
             try
                if (Trim(AContentFields.Values['lastname']) <> trim(VarEvaluator.GetValueAsString('Member.lastName'))) then begin
                  TranMessage := 'Member Validation failed';
                  ProcessLog(ltWarning, 'AddAccountAjax Member Validation failed lastname:',Trim(AContentFields.Values['lastname'])+':'+ trim(VarEvaluator.GetValueAsString('Member.lastName')));
                  TranSuccess := false;
                  FinalizeJSONRespAndFree;
                  exit;
                end else if (StrToDateTime(Trim(AContentFields.Values['parentdob'])) <> StrToDateTime(VarEvaluator.GetValueAsString('Member.birthDate'))) then begin
                  TranMessage := 'Member Validation failed';
                  ProcessLog(ltWarning, 'AddAccountAjax Member Validation failed dob:',Trim(AContentFields.Values['parentdob'])+':'+ trim(VarEvaluator.GetValueAsString('Member.birthDate')));
                  TranSuccess := false;
                  FinalizeJSONRespAndFree;
                  exit;
      end;
                MemberValidated := true;
             except
               on e:exception do begin
                  TranMessage := 'Member Validation failed';
                  TranSuccess := false;
                  FinalizeJSONRespAndFree;
                  exit;
   end;
             end;
             if (GetXMLTagStr(VarEvaluator.GetValueAsString('memberXML'),'currentPlans') = '') then begin
                 if HEGetBills(TranMessage) then begin
                    totalAmountDue := ValidCharsOnly(GetXMLTagStr(VarEvaluator.GetValueAsString('billXML'),'totalAmountDue'),false,true,'().');
                    if totalAmountDue <> '' then begin
                       if Pos('(',totalAmountDue) > 0 then begin
                          MemberTermed := true;
                       end else begin
                        try
                          if StrToCurr(totalAmountDue) <= 0 then begin
                              MemberTermed := true;
                          end;
                        except
                           on e:exception do begin
                             MemberTermed := true;
                           end;
                         end;
                       end;
                    end else begin
                      MemberTermed := true;
                    end;
                 end else begin
                    MemberTermed := true;
                 end;
                 if MemberTermed then begin
                     TranSuccess := false;
                     TranMessage := 'Member Termed';
                     FinalizeJSONRespAndFree;
                     exit;
                 end;
             end;

             if not (VarEvaluator.GetValueAsString('Member.account.accountTypeCode') = '3') and not (Pos('EGWP',VarEvaluator.GetValueAsString('Member.account.name')) > 0) then begin  //individual or medicare
                 if (Pos('COBRA',VarEvaluator.GetValueAsString('Member.account.name')) > 0) or (Pos('AB1401',VarEvaluator.GetValueAsString('Member.account.name')) > 0)
                 or (Pos('SHC Per Diem',VarEvaluator.GetValueAsString('Member.account.name')) > 0) or (Pos('DirCobra',VarEvaluator.GetValueAsString('Member.account.name')) > 0)  then begin
                    if (IsCobraAccount(VarEvaluator.GetValueAsString('Member.account.id'),VarEvaluator.GetValueAsString('Member.account.name'))) then begin
                       TranSuccess := false;
                       TranMessage := 'Group Member';
                       FinalizeJSONRespAndFree;
                       exit;
                    end;
                 end else begin
                   TranSuccess := false;
                   TranMessage := 'Group Member';
                   FinalizeJSONRespAndFree;
                   exit;
                 end;
             end;
         end else if (memberType = 'Employer') then begin
             EmployerAccountID := VarEvaluator.GetValueAsString('EmployerAccountID');
             if (Pos('-',EmployerAccountID) > 0) then begin
               EmployerAccountID := Copy(EmployerAccountID,1,Pos('-',EmployerAccountID)-1);
             end;
             if (Trim(EmployerAccountID) <> trim(VarEvaluator.GetValueAsString('subscriptionId'))) then begin
               TranMessage := 'Employer Validation failed';
               ProcessLog(ltWarning, 'AddAccountAjax Employer Validation failed accountid:',Trim(VarEvaluator.GetValueAsString('EmployerAccountID'))+':'+ trim(VarEvaluator.GetValueAsString('subscriptionId')));
               TranSuccess := false;
               FinalizeJSONRespAndFree;
               exit;
             end;
         end else if (memberType = 'Guest') then begin
             try
                if (Trim(AContentFields.Values['memberLastName']) <> trim(VarEvaluator.GetValueAsString('Member.lastName'))) then begin
                  TranMessage := 'Member Validation failed';
                  ProcessLog(ltWarning, 'AddAccountAjax Member Validation failed lastname:',Trim(AContentFields.Values['memberLastName'])+':'+ trim(VarEvaluator.GetValueAsString('Member.lastName')));
                  TranSuccess := false;
                  FinalizeJSONRespAndFree;
                  exit;
                end else if (StrToDateTime(Trim(AContentFields.Values['memberdob'])) <> StrToDateTime(VarEvaluator.GetValueAsString('Member.birthDate'))) then begin
                  TranMessage := 'Member Validation failed';
                  ProcessLog(ltWarning, 'AddAccountAjax Member Validation failed dob:',Trim(AContentFields.Values['parentdob'])+':'+ trim(VarEvaluator.GetValueAsString('Member.birthDate')));
                  TranSuccess := false;
                  FinalizeJSONRespAndFree;
                  exit;
                end;
                MemberValidated := true;
             except
               on e:exception do begin
                  TranMessage := 'Member Validation failed';
                  TranSuccess := false;
                  FinalizeJSONRespAndFree;
                  exit;
               end;
             end;
             if (GetXMLTagStr(VarEvaluator.GetValueAsString('memberXML'),'currentPlans') = '') then begin
                 if HEGetBills(TranMessage) then begin
                    totalAmountDue := ValidCharsOnly(GetXMLTagStr(VarEvaluator.GetValueAsString('billXML'),'totalAmountDue'),false,true,'().');
                    if totalAmountDue <> '' then begin
                       if Pos('(',totalAmountDue) > 0 then begin
                          MemberTermed := true;
                       end else begin
                        try
                          if StrToCurr(totalAmountDue) <= 0 then begin
                              MemberTermed := true;
                          end;
                        except
                           on e:exception do begin
                             MemberTermed := true;
                           end;
                         end;
                       end;
                    end else begin
                      MemberTermed := true;
                    end;
                 end else begin
                    MemberTermed := true;
                 end;
                 if MemberTermed then begin
                     TranSuccess := false;
                     TranMessage := 'Member Termed';
                     FinalizeJSONRespAndFree;
                     exit;
                 end;
             end;
         end;
      end;
   end;


   RNQuery.Insert;
   ParentGUID := GenerateGUID;
   ProcessLog(ltinfo,'AddingCustomerAccount',ParentGUID);
   RNQuery.FieldByName('CustomerCode').AsString := ParentGUID;
   RNQuery.FieldByName('Storecode').AsString := ARNID;
   RNQuery.FieldByName('ChainCode').AsInteger := ChainCode;
   RNQuery.FieldByName('StartDate').AsDateTime := Now;
   RNQuery.FieldByName('LastWeblogon').AsDateTime := Now;
   RNQuery.FieldByName('Email').AsString := UpCaseString(email);

   RNQuery.FieldByName('COMMENTS1').AsString := VarEvaluator.GetValueAsString('subscriptionId');
   RNQuery.FieldByName('COMMENTS2').AsString := VarEvaluator.GetValueAsString('Member.subscriptionId');
   RNQuery.FieldByName('COMMENTS3').AsString := VarEvaluator.GetValueAsString('Member.subscriberId');
   RNQuery.FieldByName('COMMENTS4').AsString := VarEvaluator.GetValueAsString('Member.subscriberSystemId');
   RNQuery.FieldByName('COMMENTS5').AsString := VarEvaluator.GetValueAsString('Member.subscriptionSystemId');
   RNQuery.FieldByName('COMMENTS6').AsString := VarEvaluator.GetValueAsString('Member.systemId');
   if GetConfigBoolean('REQUIREVALIDATION',True) then begin
      RNQuery.FieldByName('ConfirmGUID').AsString := GenerateGUID;
   end else begin
      RNQuery.FieldByName('ConfirmGUID').AsString := 'VALIDATED';
   end;
   if (memberType = 'Guest') then begin
      AccountNum := ValidCharsOnly(AContentFields.Values['parentaccountnumber'],True,true,'-');
      if (AccountNum <> '') then begin
         VarEvaluator.AddValue('MemberHCCID',AccountNum); //validate the top level account number if provided
         if not ValidateHEUser(memberType,TranMessage) then begin
            TranSuccess := false;
            FinalizeJSONRespAndFree;
            exit;
         end else begin
            if (Trim(AContentFields.Values['lastname']) <> trim(VarEvaluator.GetValueAsString('Member.lastName'))) then begin
               TranMessage := 'Member Validation failed';
               ProcessLog(ltWarning, 'EditAccountInformationAjaxin Member Validation failed lastname:',Trim(AContentFields.Values['lastname'])+':'+ trim(VarEvaluator.GetValueAsString('Member.lastName')));
               TranSuccess := false;
               FinalizeJSONRespAndFree;
               exit;
            end;
         end;
      end;
      AccountNum := '';
   end;
   LoadCustomerFormData(RNQuery,AQueryFields,AContentFields);
   if (memberType <> '') then begin
      RNQuery.FieldByName('MEMBSTATUS').AsString := memberType; //MEMBTYPE is reserved for ADMIN, so let's use membstatus
      SessionVarEval.AddValue('MEMBSTATUS',memberType);
      VarEvaluator.AddValue('MEMBSTATUS',memberType);
   end;
   if (VarEvaluator.GetValueAsString('Member.birthDate')<>'') then begin
      RNQuery.FieldByName('DOB').AsString := VarEvaluator.GetValueAsString('Member.birthDate');
   end;
   if OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/CASESENSITIVE', 'FALSE') = 'FALSE' then begin
      Password := UpCaseString(Password);
   end;

   if (memberType = 'Employer') then begin
      RNQuery.FieldByName('CUSTOM9').AsString := VarEvaluator.GetValueAsString('employerXML');
   end else if (memberType = 'Member') then begin
   RNQuery.FieldByName('CUSTOM9').AsString := VarEvaluator.GetValueAsString('memberXML');
   end;
   RNQuery.FieldByName('PasswordBcrypt').AsString := BCryptPassword(Trim(Password),Trim(ParentGUID));
   ProcessLog(ltinfo,'AddingCustomerAccount beforepost',RNQuery.FieldByName('SystemCode').AsString);
   RNQuery.Post;
   RNQuery.Close;
   RNQuery.SQL.Clear;
   RNQuery.SQL.Add('Select * from Customers where (StoreCode = '+ARNID + ') and (Customercode = ''' + ParentGUID + ''')');
   RNQuery.Open;

   CustomerSC :=RNQuery.FieldByName('SystemCode').AsInteger;
   ProcessLog(ltinfo,'AddingCustomerAccount',Stri(CustomerSC,-1));

   if (MemberValidated) then begin
      LastName := Trim(VarEvaluator.GetValueAsString('Member.lastName'));
   end else begin
   if (AContentFields.Values['memberLastName'] <> '') then begin
      LastName := ValidCharsOnly(AContentFields.Values['memberLastName'],True,True,'-'' ');
   end else if (AContentFields.Values['lastname'] <> '') then begin
      LastName := ValidCharsOnly(AContentFields.Values['lastname'],True,True,'-'' ');
   end else begin
      LastName := ValidCharsOnly(AContentFields.Values['ParentLast'],True,True,'-'' ');
   end;
   end;
   if (MemberValidated) then begin
      FirstName := Trim(VarEvaluator.GetValueAsString('Member.firstName'));
   end else begin
   if (AContentFields.Values['memberFirstName'] <> '') then begin
      FirstName := ValidCharsOnly(AContentFields.Values['memberFirstName'],True,True,'-'' ');
   end else if (AContentFields.Values['firstname'] <> '') then begin
      FirstName := ValidCharsOnly(AContentFields.Values['firstname'],True,True,'-'' ');
   end else begin
      FirstName := ValidCharsOnly(AContentFields.Values['ParentFirst'],True,True,'-'' ');
   end;
   end;

   if (AContentFields.Values['memberdob'] <> '') then begin
      dob := ValidCharsOnly(AContentFields.Values['memberdob'],True,True,'-/');
   end else if (AContentFields.Values['parentdob'] <> '') then begin
      dob := ValidCharsOnly(AContentFields.Values['parentdob'],True,True,'-/');
   end;
   if (VarEvaluator.GetValueAsString('Member.birthDate') <> '') then begin
      dob := VarEvaluator.GetValueAsString('Member.birthDate');
   end;
   if (AContentFields.Values['accountnumber'] <> '') then begin
      AccountNum:= ValidCharsOnly(AContentFields.Values['accountnumber'],True,True,' /.-');
   end else if (AContentFields.Values['memberID'] <> '') then begin
      AccountNum := ValidCharsOnly(AContentFields.Values['memberID'],True,True,' /.-');
   end else if (AContentFields.Values['ApplicantID'] <> '') then begin
      AccountNum := ValidCharsOnly(AContentFields.Values['ApplicantID'],True,True,' /.-');
   end else if (AContentFields.Values['EmployerAccountID'] <> '') then begin
      AccountNum := ValidCharsOnly(AContentFields.Values['EmployerAccountID'],True,True,' /.-');
   end;

   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/CREATECHILDONCREATE','TRUE') = 'TRUE' then begin
      if (NumericOnly(AContentFields.Values['Locations'])<>'') then begin
         ARNID := NumericOnly(AContentFields.Values['Locations']);
      end;
      AddChildToAccount(ParentGUID,ARNID,firstname,lastname,dob,accountnum,ValidCharsOnly(Trim(AContentFields.Values['TaxIDNumber']),True,true,'- '),VarEvaluator.GetValueAsString('subscriptionId'));
   end;
   SessionVarEval.AddValue('CUSTOMERS.CUSTOMERCODE',ParentGUID);
   SessionVarEval.AddValue('memberFirstName',firstname);

   if (AContentFields.Values['firstname'] <> '') then begin
      FirstName := ValidCharsOnly(AContentFields.Values['firstname'],True,True,'-'' ');
   end else if (AContentFields.Values['ParentFirst'] <> '') then begin
      FirstName := ValidCharsOnly(AContentFields.Values['ParentFirst'],True,True,'-'' ');
   end;
   SessionVarEval.AddValue('accountFirstName',firstname);
   ProcessLog(ltinfo,'Updating WWW Session',Stri(CustomerSC,-1));

   SessionAuthQuery.Close;
   SessionAuthQuery.SQL.Clear;
   SessionAuthQuery.SQL.Add('Select * from WWWSession where RNSessionID = ''' + RnSessionID + '''');
   SessionAuthQuery.Open;
   SessionAuthQuery.Edit;
   SessionAuthQuery.FieldByName('CustomerSC').AsInteger := CustomerSC;
   SessionAuthQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime := Now + EncodeTime(1,0,0,0);
   SessionAuthQuery.Post;
   SessionAuthQuery.Close;
   TranSuccess := true;
   ResponseJSON.Add('"rnSessionID": "'+RNSessionID+'",');
   ResponseJSON.Add('"customerSC": "'+IntToStr(CustomerSC)+'",');
   ResponseJSON.Add('"custGuid": "'+ParentGUID+'",');
   FinalizeJSONRespAndFree;
end;

procedure TCustomerInfoModule.AddChildToAccount(const CustGUID, ARNID: string;FirstName,LastName,DOB,AccountNum,ExternalCustIdent,ASubscriptionId: string);
begin
   RNQuery.Close;
   RNQuery.SQL.Clear;
   RNQuery.SQL.Add('Select * from CustChild where (CustGUID = '''+CustGUID + ''')');
   RNQuery.Open;
   RNQuery.Insert;
   RNQuery.FieldByName('CustGUID').AsString := CustGUID;
   RNQuery.FieldByName('ChildGUID').AsString := GenerateGUID;
   RNQuery.FieldByName('RNID').AsString := ARNID;
   if Trim(ARNID) = '' then begin
      if (UserXMLGetTag('/USERPROFILE/PORTALRNID') <> '') then begin
         RNQuery.FieldByName('RNID').AsString := UserXMLGetTag('/USERPROFILE/PORTALRNID')
      end;
   end;
   RNQuery.FieldByName('LastName').AsString := LastName;
   RNQuery.FieldByName('FirstName').AsString := FirstName;
   Try
      RNQuery.FieldByName('DOB').AsString := ValidCharsOnly(DOB,False,True,'/-');
   except
      on E:Exception do begin
         ProcessLog(ltWarning, 'AddChildToAccount DOB as string failed:', E.Message);
         Try
            RNQuery.FieldByName('DOB').AsDateTime := StrToDate(DOB);
         except
            On E:Exception do begin
               ProcessLog(ltWarning, 'AddChildToAccount DOB as DateTime failed:', E.Message);
            end;
         end;
      end;
   end;
   RNQuery.FieldByName('DateAdded').AsDateTime := Now;
   RNQuery.FieldByName('AccountNumber').AsString := ValidCharsOnly(AccountNum,True,True,'-:/.');
   RNQuery.FieldByName('ExternalCustIdent').AsString := ExternalCustIdent;
   RNquery.FieldByName('ExternalIntegration').AsString := ASubscriptionId;
   RNQuery.Post;
   RNQuery.Close;
end;

function TCustomerInfoModule.GetProfileAjax(const AQueryFields,AContentFields: TStrings; ARNID: string): string;
var
memberType,CustGUID,ChildGUID,memberJSON,employerJSON,memberStr,billStr,planIdNumber,planName: string;
WS: string;
AccountID,AccountName,AccountType,AccountTypeCode :string;
ResponseJSON : TStringList;
TranSuccess : boolean;
TranMessage : string;
HEResponse : TStringList;
memberSL,billSL : TStringlist;
memberXML : TOpenXML;
memberXMLNode : TOpenXMLNode;
includeBills,AccountVerified : boolean;
   Procedure FinalizeJSONRespAndFree;
   Begin
      ResponseJSON.Add('"serverdate" : "'+FormatDateTime('MM/DD/YYYY', now)+'",');
      ResponseJSON.Add('"servertime" : "'+FormatDateTime('HH:NN:SS', now)+'",');
      ResponseJSON.Add('"tranrespmessage" : "'+TranMessage+'",');
      ResponseJSON.Add('"profile" : "'+ARNID+'",');
      if TranSuccess then begin
         ResponseJSON.Add('"transuccess" : true');
      end else begin
         ResponseJSON.Add('"transuccess" : false');
         ProcessLog(ltWarning, 'GetProfileAjax transucces false:',TranMessage);
      end;
      ResponseJSON.Add('}');
      Result := ResponseJSON.Text;
      ResponseJSON.Free;
   end;
begin
   TranSuccess := false;
   AccountVerified := false;
   ResponseJSON := TStringList.Create;
   ResponseJSON.Add('{');
   if OpenCustomerQuery(AQueryFields) then begin
      memberType := RNQuery.FieldByName('MEMBSTATUS').AsString;
      SessionVarEval.AddValue('memberType',memberType);
      VarEvaluator.AddValue('memberType',memberType);
      CustGUID := trim(RNQuery.FieldByName('CustomerCode').AsString);
      ResponseJSON.Add('"memberType" : "'+memberType+'",');
      ResponseJSON.Add('"custGUID" : "'+CustGUID+'",');
      if (ValidCharsOnly(AContentFields.Values['includeBill'],true,true,'') <> '') then begin
         includeBills := strtobool(ValidCharsOnly(AContentFields.Values['includeBill'],true,true,''));
      end else begin
         includeBills := false;
      end;

      if (memberType = 'Member') or (memberType = 'Employer') or (memberType = 'Guest') then begin
         RNQuery2.Close;
         RNQuery2.SQL.Clear;
         RNQuery2.SQL.Add('Select * from CustChild left outer join store on (store.systemcode = CustChild.RNID) where (CustGUID = '''+CustGUID + ''') and (Hidden=0)');
         RNQuery2.Open;
         memberSL := TStringList.Create;
         billSL := TStringList.Create;
         if (RNQuery2.RecordCount > 0) then begin
            memberSL.Add('<members>');
            if includeBills then billSL.Add('<bills>');
            while Not RNQuery2.EOF do begin
               ChildGUID := RNQuery2.FieldByName('ChildGUID').AsString;
               VarEvaluator.AddValue('ChildGUID',ChildGUID);
               if (memberType = 'Member') or (memberType = 'Guest') then begin
                  SessionVarEval.AddValue('MemberHCCID',RNQuery2.FieldByName('AccountNumber').AsString);
                  VarEvaluator.AddValue('MemberHCCID',RNQuery2.FieldByName('AccountNumber').AsString);
               end else if (memberType = 'Employer') then begin
                  SessionVarEval.AddValue('EmployerAccountID',RNQuery2.FieldByName('AccountNumber').AsString);
                  SessionVarEval.AddValue('TaxID',RNQuery2.FieldByName('ExternalCustIdent').AsString);
                  VarEvaluator.AddValue('EmployerAccountID',RNQuery2.FieldByName('AccountNumber').AsString);
                  VarEvaluator.AddValue('TaxID',RNQuery2.FieldByName('ExternalCustIdent').AsString);
               end;
               TranSuccess := ValidateHEUser(memberType,TranMessage);
               if TranSuccess then begin
                  AccountVerified := true;
                  if (memberType = 'Member') or (memberType = 'Guest') then begin

                     if (LoadOpenXML(memberXML,VarEvaluator.GetValueAsString('memberXML'))) then begin
                        memberSL.Add('<member>');
                        memberSL.Add('<subscriptionId>'+VarEvaluator.GetValueAsString('Member.subscriptionId')+'</subscriptionId>');
                        memberSL.Add('<subscriberId>'+VarEvaluator.GetValueAsString('Member.subscriberId')+'</subscriberId>');
                        memberSL.Add('<subscriberSystemId>'+VarEvaluator.GetValueAsString('Member.subscriberSystemId')+'</subscriberSystemId>');
                        memberSL.Add('<subscriptionSystemId>'+VarEvaluator.GetValueAsString('Member.subscriptionSystemId')+'</subscriptionSystemId>');
                        memberSL.Add('<childGUID>'+VarEvaluator.GetValueAsString('ChildGUID')+'</childGUID>');
                        memberSL.Add('<accountNumber>'+VarEvaluator.GetValueAsString('MemberHCCID')+'</accountNumber>');
                        if (Trim(RNQuery2.FieldByName('ExternalIntegration').AsString) = '') then begin
                           memberSL.Add('<nonvalidatedChildAccount>true</nonvalidatedChildAccount>');
                        end;
                        memberXMLNode := memberXML.GetNode('/member/currentPlans');
                        if (memberXMLNode <> nil) then begin
                           memberXMLNode := memberXMLNode.FindFirstChildElement;
                           memberSL.Add('<currentPlans>');
                           while (memberXMLNode <> nil) do begin
                              memberSL.Add('<currentPlan>');
                              memberSL.Add('<endDate>'+memberXML.GetContextValueAsWideString(memberXMLNode,'endDate')+'</endDate>');

                              planIdNumber := memberXML.GetContextValueAsWideString(memberXMLNode,'otherIdList/identificationNumber/idNumber');
                              planName := memberXML.GetContextValueAsWideString(memberXMLNode,'planName');
                              ReplaceString(planName,planIdNumber,'');
                              memberSL.Add('<planId>'+memberXML.GetContextValueAsWideString(memberXMLNode,'planId')+'</planId>');
                              memberSL.Add('<planName>'+trim(planName)+'</planName>');
                              memberSL.Add('<startDate>'+memberXML.GetContextValueAsWideString(memberXMLNode,'startDate')+'</startDate>');
                              memberSL.Add('</currentPlan>');
                              memberXMLNode := memberXMLNode.FindNextSiblingElement;
                           end;
                           memberSL.Add('</currentPlans>');
                        end;
                        memberXMLNode := memberXML.GetNode('/member/historicalPlans');
                        if (memberXMLNode <> nil) then begin
                           memberXMLNode := memberXMLNode.FindFirstChildElement;
                           memberSL.Add('<historicalPlans>');
                           while (memberXMLNode <> nil) do begin
                              memberSL.Add('<historicalPlan>');
                              memberSL.Add('<endDate>'+memberXML.GetContextValueAsWideString(memberXMLNode,'endDate')+'</endDate>');

                              planIdNumber := memberXML.GetContextValueAsWideString(memberXMLNode,'otherIdList/identificationNumber/idNumber');
                              planName := memberXML.GetContextValueAsWideString(memberXMLNode,'planName');
                              ReplaceString(planName,planIdNumber,'');
                              memberSL.Add('<planId>'+memberXML.GetContextValueAsWideString(memberXMLNode,'planId')+'</planId>');
                              memberSL.Add('<planName>'+trim(planName)+'</planName>');
                              memberSL.Add('<startDate>'+memberXML.GetContextValueAsWideString(memberXMLNode,'startDate')+'</startDate>');
                              memberSL.Add('</historicalPlan>');
                              memberXMLNode := memberXMLNode.FindNextSiblingElement;
                           end;
                           memberSL.Add('</historicalPlans>');
                        end;

                        AccountID := VarEvaluator.GetValueAsString('Member.account.id');
                        AccountName := VarEvaluator.GetValueAsString('Member.account.name');
                        AccountType := VarEvaluator.GetValueAsString('Member.account.accountType');
                        AccountTypeCode := VarEvaluator.GetValueAsString('Member.account.accountTypeCode');

                        if not (AccountTypeCode = '3') and not (Pos('EGWP',AccountName) > 0) then begin  //individual  or medicare
                           if (Pos('COBRA',AccountName) > 0) or (Pos('AB1401',AccountName) > 0) or (Pos('SHC Per Diem',AccountName) > 0) or (Pos('DirCobra',AccountName) > 0) then begin
                              if (IsCobraAccount(AccountID,AccountName)) then begin
                                 memberSL.Add('<groupAccount>true</groupAccount>');
                              end;
                           end else begin
                              memberSL.Add('<groupAccount>true</groupAccount>');
                           end;
                        end;

                        memberSL.Add('</member>');
                     end else begin
                        TranMessage := 'Member XML Failure';
                        FinalizeJSONRespAndFree;
                        exit;
                     end;
                     if includeBills then begin
                     if HEGetBills(TranMessage) then begin
                        billSL.Add(trim(VarEvaluator.GetValueAsString('billXML')));
                     end else begin
                        TranMessage := 'Bill Failed to load';
                     end;
                     end;
                  end else if (memberType = 'Employer') then begin
                     if (LoadOpenXML(memberXML,VarEvaluator.GetValueAsString('employerXML'))) then begin
                        memberSL.Add('<accountReference>');
                        memberSL.Add('<subscriptionId>'+VarEvaluator.GetValueAsString('subscriptionId')+'</subscriptionId>');
                        memberSL.Add('<accountId>'+VarEvaluator.GetValueAsString('EmployerAccountID')+'</accountId>');
                        memberSL.Add('<childGUID>'+VarEvaluator.GetValueAsString('ChildGUID')+'</childGUID>');
                        memberSL.Add('</accountReference>');
                     end else begin
                        TranMessage := 'Member XML Failure';
                        FinalizeJSONRespAndFree;
                        exit;
                     end;
                     if includeBills then begin
                     if HEGetBills(TranMessage) then begin
                        billSL.Add(trim(VarEvaluator.GetValueAsString('billXML')));
                     end else begin
                        TranMessage := 'Bill Failed to load';
                     end;
                  end;
               end;
               end else begin
                  memberSL.Add('<member>');
                  memberSL.Add('<subscriptionId></subscriptionId>');
                  memberSL.Add('<subscriberId>'+trim(RNQuery2.FieldByName('AccountNumber').AsString)+'</subscriberId>');
                  memberSL.Add('<subscriberSystemId></subscriberSystemId>');
                  memberSL.Add('<subscriptionSystemId></subscriptionSystemId>');
                  memberSL.Add('<childGUID>'+VarEvaluator.GetValueAsString('ChildGUID')+'</childGUID>');
                  memberSL.Add('<nonvalidatedUser>true</nonvalidatedUser>');
                  memberSL.Add('<firstName>'+trim(RNQuery2.FieldByName('FirstName').AsString)+'</firstName>');
                  memberSL.Add('<lastName>'+trim(RNQuery2.FieldByName('LastName').AsString)+'</lastName>');
                  memberSL.Add('<externalCustIdent>'+trim(RNQuery2.FieldByName('externalCustIdent').AsString)+'</externalCustIdent>');
                  memberSL.Add('</member>');
               end;
               RNQuery2.Next;
               FreeAndNil(memberXML);
            end;
            if includeBills then billSL.Add('</bills>');
            memberSL.Add('</members>');
            if (GetXMLTagStr(memberSL.Text,'member') <> '') then begin
               VarEvaluator.AddValue('memberXMLAfter',memberSL.Text);
               memberStr := XMLToJSON(memberSL.Text);
               delete(memberStr,1,Pos('"member"',memberStr)-1);
               delete(memberStr,length(memberStr)-1,2);//remove the beginning and ending brackets
               ResponseJSON.Add(memberStr+',');
            end else if (GetXMLTagStr(memberSL.Text,'accountReference') <> '') then begin
               memberStr := XMLToJSON(memberSL.Text);
               delete(memberStr,1,Pos('"accountReference"',memberStr)-1);
               delete(memberStr,length(memberStr)-1,2);//remove the beginning and ending brackets
               ResponseJSON.Add(memberStr+',');
            end else begin
               ResponseJSON.Add('"member" : {},');
            end;
            if (GetXMLTagStr(billSL.Text,'bill') <> '') then begin
               billStr := XMLToJSON(billSL.Text);
               delete(billStr,1,Pos('"bill"',billStr)-1);
               delete(billStr,length(billStr)-1,2);//remove the beginning and ending brackets
               ResponseJSON.Add(billStr+',');
            end else begin
               ResponseJSON.Add('"bill" : {},');
            end;
            FreeAndNil(memberSL);
            FreeAndNil(billSL);
            if not TranSuccess and AccountVerified then begin
               TranSuccess := AccountVerified; ///if we have a validated account then the response back to the browser should be true
               TranMessage := '';
            end;
            FinalizeJSONRespAndFree;
         end else begin
            TranMessage := 'Members Not Found';
            FinalizeJSONRespAndFree;
         end;
      end else begin
         TranMessage := 'Invalid memberType';
         FinalizeJSONRespAndFree;
      end;
   end else begin
      TranMessage := 'Customer Not Found';
      FinalizeJSONRespAndFree;
   end;
end;



function TCustomerInfoModule.ValidateHEUser(const AMembType: string;  var ATranMessage: string): boolean;
var
HEResponse : TStringList;
TranSuccess : boolean;
begin
   result := false;
   HEResponse := TStringList.Create;
   if (AMembType = 'Member') or (AMembType = 'Guest') then begin
      if HealthEdgeAPIRequest('getMemberDetailsByHccId',HEResponse) then begin
         TranSuccess := true;
         ATranMessage := 'Member Account Validated';
      end else begin
         TranSuccess := false;
         ATranMessage := 'Member Account Not Validated';
      end;
   end else begin //employer look up
      if HealthEdgeAPIRequest('accountReferenceLookup',HEResponse) then begin
         TranSuccess := true;
         ATranMessage := 'Employer Account Validated';
      end else begin
         TranSuccess := false;
         ATranMessage := 'Employer Account Not Validated';
      end;
   end;
   result := TranSuccess;
   FreeAndNil(HEResponse);
end;

function TCustomerInfoModule.HEGetBills(var ATranMessage: string): boolean;
var
HEResponse : TStringList;
TranSuccess : boolean;
begin
   result := false;
   HEResponse := TStringList.Create;
   if HealthEdgeAPIRequest('findBills',HEResponse) then begin
      if HealthEdgeAPIRequest('getBillDetailsByID',HEResponse) then begin
         TranSuccess := true;
         ATranMessage := 'Bill Found';
      end else begin
         TranSuccess := false;
         ATranMessage := 'BillID Not Found';
      end;
   end else begin
      TranSuccess := false;
      ATranMessage := 'Bills Not Found';
   end;
   result := TranSuccess;
   FreeAndNil(HEResponse);

end;

function TCustomerInfoModule.LoadOpenXML(var AOpenXML: TOpenXML;const AXMLStr:string): boolean;
begin
   result := false;
   if (AXMLStr   <> '') then begin
      Try
         AOpenXML := TOpenXML.CreateFromString(Nil,AXMLStr);
         result := true;
      except
         On E:Exception do begin
            Processlog(ltWarning, 'OpenXMLLoad Exception processing AOpenXML' ,E.Message);
            If Assigned(AOpenXML) then FreeAndNil(AOpenXML);
            result := false;
         end;
      end;
   end;
end;

function TCustomerInfoModule.AddChildAccountAjax(const AQueryFields,AContentFields: TStrings; ARNID: string): string;
var
email,Password,memberType,ParentGUID,firstname,lastname,dob,accountnum,EmployerAccountID: string;
WS: string;
ResponseJSON : TStringList;
TranSuccess : boolean;
TranMessage : string;
   Procedure FinalizeJSONRespAndFree;
   Begin
      ResponseJSON.Add('"serverdate" : "'+FormatDateTime('MM/DD/YYYY', now)+'",');
      ResponseJSON.Add('"servertime" : "'+FormatDateTime('HH:NN:SS', now)+'",');
      ResponseJSON.Add('"tranrespmessage" : "'+TranMessage+'",');
      ResponseJSON.Add('"profile" : "'+ARNID+'",');
      if TranSuccess then begin
         ResponseJSON.Add('"transuccess" : true');
      end else begin
         ResponseJSON.Add('"transuccess" : false');
         ProcessLog(ltWarning, 'AddChildAccountAjax transucces false:',TranMessage);
      end;
      ResponseJSON.Add('}');
      Result := ResponseJSON.Text;
      ResponseJSON.Free;
   end;
begin
   result := '';
   ResponseJSON := TStringList.Create;
   ResponseJSON.Add('{');
   TranSuccess := false;
   If OpenCustomerQuery(AQueryFields) then begin
      ParentGUID := Trim(RNQuery.FieldByName('CustomerCode').AsString);
      memberType := Trim(RNQuery.FieldByName('MEMBSTATUS').AsString);
      if (memberType = 'Member') or (memberType = 'Employer') or (memberType = 'Guest') then begin
         if (AContentFields.Values['memberID'] <> '') then begin
            AccountNum := ValidCharsOnly(AContentFields.Values['memberID'],True,True,' /.-');
         end else if (AContentFields.Values['EmployerAccountID'] <> '') then begin
            AccountNum := ValidCharsOnly(AContentFields.Values['EmployerAccountID'],True,True,' /.-');
         end;
         if (AccountNum = '') then begin
            TranMessage := 'Member Account ID Empty';
            FinalizeJSONRespAndFree;
            exit;
         end;
         if not (ChildAccountExists(ParentGUID,AccountNum)) then begin
            SessionVarEval.AddValue('MemberHCCID',ValidCharsOnly(Trim(AContentFields.Values['memberID']),True,true,'- '));
            SessionVarEval.AddValue('EmployerAccountID',ValidCharsOnly(Trim(AContentFields.Values['EmployerAccountID']),True,true,'- '));
            SessionVarEval.AddValue('TaxID',ValidCharsOnly(Trim(AContentFields.Values['TaxIDNumber']),True,true,'- '));
            VarEvaluator.AddValue('MemberHCCID',ValidCharsOnly(Trim(AContentFields.Values['memberID']),True,true,'- '));
            VarEvaluator.AddValue('EmployerAccountID',ValidCharsOnly(Trim(AContentFields.Values['EmployerAccountID']),True,true,'- '));
            VarEvaluator.AddValue('TaxID',ValidCharsOnly(Trim(AContentFields.Values['TaxIDNumber']),True,true,'- '));
            dob := Trim(AContentFields.Values['memberdob']);
            ReplaceString(dob,'-','/');
            TranSuccess := ValidateHEUser(memberType,TranMessage);
            if not TranSuccess then begin
               FinalizeJSONRespAndFree;
               exit;
            end else begin  //validate against other fields
               if (memberType = 'Employer') then begin
                   EmployerAccountID := VarEvaluator.GetValueAsString('EmployerAccountID');
                   if (Pos('-',EmployerAccountID) > 0) then begin
                     EmployerAccountID := Copy(EmployerAccountID,1,Pos('-',EmployerAccountID)-1);
            end;
                   if (Trim(EmployerAccountID) <> trim(VarEvaluator.GetValueAsString('subscriptionId'))) then begin
                     TranMessage := 'Employer Validation failed';
                     ProcessLog(ltWarning, 'AddChildAccountAjax Employer Validation failed accountid:',Trim(VarEvaluator.GetValueAsString('EmployerAccountID'))+':'+ trim(VarEvaluator.GetValueAsString('subscriptionId')));
                     TranSuccess := false;
                     FinalizeJSONRespAndFree;
                     exit;
            end;
               end else if (memberType = 'Guest') or (memberType = 'Member') then begin
                   try
                      if (Trim(AContentFields.Values['memberLastName']) <> trim(VarEvaluator.GetValueAsString('Member.lastName'))) then begin
                        TranMessage := 'Member Validation failed';
                        ProcessLog(ltWarning, 'AddChildAccountAjax Member Validation failed lastname:',Trim(AContentFields.Values['memberLastName'])+':'+ trim(VarEvaluator.GetValueAsString('Member.lastName')));
                        TranSuccess := false;
                        FinalizeJSONRespAndFree;
                        exit;
                      end else if (StrToDateTime(dob) <> StrToDateTime(VarEvaluator.GetValueAsString('Member.birthDate'))) then begin
                        TranMessage := 'Member Validation failed';
                        ProcessLog(ltWarning, 'AddChildAccountAjax Member Validation failed dob:',dob +':'+ trim(VarEvaluator.GetValueAsString('Member.birthDate')));
                        TranSuccess := false;
                        FinalizeJSONRespAndFree;
                        exit;
                      end;
                   except
                     on e:exception do begin
                        TranMessage := 'Member Validation failed';
                        TranSuccess := false;
                        FinalizeJSONRespAndFree;
                        exit;
                     end;
                   end;
                   if not (VarEvaluator.GetValueAsString('Member.account.accountTypeCode') = '3') and not (Pos('EGWP',VarEvaluator.GetValueAsString('Member.account.name')) > 0) then begin  //individual  or medicare
                       if (Pos('COBRA',VarEvaluator.GetValueAsString('Member.account.name')) > 0) or (Pos('AB1401',VarEvaluator.GetValueAsString('Member.account.name')) > 0)
                       or (Pos('SHC Per Diem',VarEvaluator.GetValueAsString('Member.account.name')) > 0) or (Pos('DirCobra',VarEvaluator.GetValueAsString('Member.account.name')) > 0) then begin
                          if (IsCobraAccount(VarEvaluator.GetValueAsString('Member.account.id'),VarEvaluator.GetValueAsString('Member.account.name'))) then begin
                             TranSuccess := false;
                             TranMessage := 'Group Member';
                             FinalizeJSONRespAndFree;
                             exit;
                          end;
                       end else begin
                         TranSuccess := false;
                         TranMessage := 'Group Member';
                         FinalizeJSONRespAndFree;
                         exit;
                       end;
                  end;
               end;
            end;
            LastName := Trim(VarEvaluator.GetValueAsString('Member.lastName'));
            FirstName := Trim(VarEvaluator.GetValueAsString('Member.firstName'));
               dob := VarEvaluator.GetValueAsString('Member.birthDate');

            if (NumericOnly(AContentFields.Values['Locations'])<>'') then begin
               ARNID := NumericOnly(AContentFields.Values['Locations']);
            end;
            AddChildToAccount(ParentGUID,ARNID,firstname,lastname,dob,accountnum,ValidCharsOnly(Trim(AContentFields.Values['TaxIDNumber']),True,true,'- '),VarEvaluator.GetValueAsString('subscriptionId'));

            TranSuccess := true;
            ResponseJSON.Add('"rnSessionID": "'+RNSessionID+'",');
            ResponseJSON.Add('"customerSC": "'+IntToStr(CustomerSC)+'",');
            ResponseJSON.Add('"custGuid": "'+ParentGUID+'",');
            FinalizeJSONRespAndFree;
         end else begin
            TranMessage := 'Member Account Already Exists';
            FinalizeJSONRespAndFree;
         end;
      end else begin
         TranMessage := 'Invalid MemberType';
         FinalizeJSONRespAndFree;
      end;
   end else begin
      TranMessage := 'Customer Not Found';
      FinalizeJSONRespAndFree;
   end;
end;
function TCustomerInfoModule.DeleteChildAccountAjax(const AQueryFields,AContentFields: TStrings; ARNID: string): string;
var
email,Password,memberType,ParentGUID,ChildGUID: string;
WS: string;
ResponseJSON : TStringList;
TranSuccess : boolean;
TranMessage : string;
   Procedure FinalizeJSONRespAndFree;
   Begin
      ResponseJSON.Add('"serverdate" : "'+FormatDateTime('MM/DD/YYYY', now)+'",');
      ResponseJSON.Add('"servertime" : "'+FormatDateTime('HH:NN:SS', now)+'",');
      ResponseJSON.Add('"tranrespmessage" : "'+TranMessage+'",');
      ResponseJSON.Add('"profile" : "'+ARNID+'",');
      if TranSuccess then begin
         ResponseJSON.Add('"transuccess" : true');
      end else begin
         ResponseJSON.Add('"transuccess" : false');
         ProcessLog(ltWarning, 'DeleteChildAccountAjax transucces false:',TranMessage);
      end;
      ResponseJSON.Add('}');
      Result := ResponseJSON.Text;
      ResponseJSON.Free;
   end;
begin
   result := '';
   ResponseJSON := TStringList.Create;
   ResponseJSON.Add('{');
   TranSuccess := false;
   If OpenCustomerQuery(AQueryFields) then begin
      ParentGUID := Trim(RNQuery.FieldByName('CustomerCode').AsString);
      memberType := Trim(RNQuery.FieldByName('MEMBSTATUS').AsString);
      ResponseJSON.Add('"custGuid": "'+ParentGUID+'",');
         ChildGUID := GuidOnly(AContentFields.Values['childguid']);
         if (ChildGUID <> '') then begin
            RNQuery2.Close;
            RNQuery2.SQL.Clear;
            RNQuery2.SQL.Add('select * from CustChild where (ChildGUID = '''+ChildGUID + ''') And (CustGUID = '''+ParentGUID + ''')');
            RNQuery2.Open;
            If RnQuery2.RecordCount = 0 then begin
               ProcessLog(ltWarning,'Attempt to remove child with invalid childguid ',ChildGUID + '/' + ParentGUID);
               TranMessage := 'Invalid ChildGUID';
            end else begin
               if (ComputeCustomerSchedulesUsedByChildGUID(ParentGUID,ChildGUID)>0) then begin
                  TranMessage := 'Schedules Exist';
               end else begin
                  RNQuery2.Close;
                  RNQuery2.SQL.Clear;
                  RNQuery2.SQL.Add('Update CustChild set hidden = 1 where (CustGUID = '''+ParentGUID + ''') and (ChildGUID = ''' + ChildGUID + ''')');
                  RNQuery2.ExecSQL;
                  TranSuccess := true;
               end;
            end;
            RNQuery2.Close;
         end else begin
            TranMessage := 'ChildGUID Empty';
         end;
      end else begin
      TranMessage := 'Customer Not Found';
   end;
   FinalizeJSONRespAndFree;
end;

function TCustomerInfoModule.GetChildAccountsAjax(const AQueryFields, AContentFields: TStrings; ARNID: string): string;
var
CustGUID: string;
ResponseJSON : TStringList;
TranSuccess : boolean;
TranMessage : string;
SchedCnt : integer;
   Procedure FinalizeJSONRespAndFree;
   Begin
      ResponseJSON.Add('"serverdate" : "'+FormatDateTime('MM/DD/YYYY', now)+'",');
      ResponseJSON.Add('"servertime" : "'+FormatDateTime('HH:NN:SS', now)+'",');
      ResponseJSON.Add('"tranrespmessage" : "'+TranMessage+'",');
      ResponseJSON.Add('"profile" : "'+ARNID+'",');
      if TranSuccess then begin
         ResponseJSON.Add('"transuccess" : true');
      end else begin
         ResponseJSON.Add('"transuccess" : false');
         ProcessLog(ltWarning, 'GetChildAccountsAjax transucces false:',TranMessage);
      end;
      ResponseJSON.Add('}');
      Result := ResponseJSON.Text;
      ResponseJSON.Free;
   end;
begin
   TranSuccess := false;
   ResponseJSON := TStringList.Create;
   ResponseJSON.Add('{');
   if OpenCustomerQuery(AQueryFields) then begin
      CustGUID := RNQuery.FieldByName('CustomerCode').AsString;
      RNQuery2.Close;
      RNQuery2.SQL.Clear;
      RNQuery2.SQL.Add('Select * from CustChild left outer join store on (store.systemcode = CustChild.RNID) where (CustGUID = '''+CustGUID + ''') and (Hidden=0)');
      RNQuery2.Open;
      ResponseJSON.Add('"custGUID" : "'+CustGUID+'",');
      ResponseJSON.Add('"accountNumber" : "'+trim(RNQuery.FieldByName('Accountnumber').AsString)+'",');
      ResponseJSON.Add('"childAccounts" : [');
      if RNQuery2.RecordCount > 0 then begin
         while Not RNQuery2.EOF do begin
            SchedCnt := ComputeCustomerSchedulesUsedByChildGUID(CustGUID,(RNQuery2.FieldByName('ChildGUID').AsString));
            ResponseJSON.Add('{');
            ResponseJSON.Add('"FirstName" : "'+Trim(RNQuery2.FieldByName('FirstName').AsString)+'",');
            ResponseJSON.Add('"LastName" : "'+Trim(RNQuery2.FieldByName('LastName').AsString)+'",');

            ResponseJSON.Add('"childGUID" : "'+Trim(RNQuery2.FieldByName('ChildGUID').AsString)+'",');
            ResponseJSON.Add('"accountNumber" : "'+Trim(RNQuery2.FieldByName('AccountNumber').AsString)+'",');
            ResponseJSON.Add('"dob" : "'+FormatDateTime('MM/DD/YYYY',RNQuery2.FieldByName('dob').AsDatetime)+'",');
            ResponseJSON.Add('"schedules" : "'+IntToStr(SchedCnt)+'",');

            if (Trim(RNQuery2.FieldByName('ExternalIntegration').AsString) = '') then begin
               ResponseJSON.Add('"nonvalidatedChildAccount" : true,');
            end;

            ResponseJSON.Add('"externalCustIdent" : "'+Trim(RNQuery2.FieldByName('ExternalCustIdent').AsString)+'"');
            ResponseJSON.Add('}');
            RNQuery2.Next;
            if not RNQuery2.EOF then begin
               ResponseJSON.Add(',');
            end;
         end;
         TranSuccess := true;
      end else begin
         TranMessage := 'No Children on File';
      end;
      ResponseJSON.Add('],');
      FinalizeJSONRespAndFree;
   end else begin
      TranMessage := 'Customer Not Found';
      FinalizeJSONRespAndFree;
   end;

end;
function TCustomerInfoModule.ChildAccountExists(const ACustGUID, AAccountNum: string): boolean;
begin
   result := false;
   if (AAccountNum <> '') then begin
      try
         RNQuery2.Close;
         RNQuery2.SQL.Clear;
         RNQuery2.SQL.Add('Select * from CustChild left outer join store on (store.systemcode = CustChild.RNID) where (CustGUID = '''+trim(ACustGUID) + ''') and (Hidden=0)');
         RNQuery2.SQL.Add('and (AccountNumber = ''' + AAccountNum + ''')');
         RNQuery2.Open;
         result := RNQuery2.RecordCount > 0;
      except
         On E:Exception do begin
            Processlog(ltWarning, 'ChildAccountExists Exception' ,E.Message);
            result := false;
         end;
      end;
      RNQuery2.Close;
   end;
end;

function TCustomerInfoModule.GetPaymentMethodsAjax(const AQueryFields, AContentFields: TStrings; ARNID: string): string;
var
CustGUID,cardJSON,checkJSON: string;
ResponseJSON : TStringList;
TranSuccess : boolean;
TranMessage : string;
paymethodCount : integer;
   Procedure FinalizeJSONRespAndFree;
   Begin
      ResponseJSON.Add('"serverdate" : "'+FormatDateTime('MM/DD/YYYY', now)+'",');
      ResponseJSON.Add('"servertime" : "'+FormatDateTime('HH:NN:SS', now)+'",');
      ResponseJSON.Add('"tranrespmessage" : "'+TranMessage+'",');
      ResponseJSON.Add('"profile" : "'+ARNID+'",');
      if TranSuccess then begin
         ResponseJSON.Add('"transuccess" : true');
      end else begin
         ResponseJSON.Add('"transuccess" : false');
         ProcessLog(ltWarning, 'GetPaymentMethodsAjax transucces false:',TranMessage);
      end;
      ResponseJSON.Add('}');
      Result := ResponseJSON.Text;
      ResponseJSON.Free;
   end;
   Procedure BuildCheckJSON;
   begin
      checkJSON := checkJSON + '{';
      checkJSON := checkJSON + '"PaymentName": "'+ Trim(RNQuery2.FieldByName('PaymentName').AsString)+'",';

      if Trim(RNQuery2.FieldByName('Status').AsString) = 'ACTIVE' then begin
         checkJSON := checkJSON + '"Active": true,';
      end else begin
         checkJSON := checkJSON + '"Active": false,';
      end;
      checkJSON := checkJSON + '"PaymentGUID": "'+ Trim(RNQuery2.FieldByName('PAYMENTGUID').AsString)+'"}';
   end;
   Procedure BuildCardJSON;
   begin
      cardJSON := cardJSON + '{';

      cardJSON := cardJSON + '"PaymentName": "'+ Trim(RNQuery2.FieldByName('PaymentName').AsString)+'",';
      cardJSON := cardJSON + '"CardIssueType": "'+ Trim(RNQuery2.FieldByName('CardIssueType').AsString)+'",';
      cardJSON := cardJSON + '"CardExpires": "'+ FormatDateTime('MM/YY', RNquery2.FieldByName('CardExpires').AsDateTime) +'",';
      if Trim(RNQuery2.FieldByName('Status').AsString) = 'ACTIVE' then begin
         cardJSON := cardJSON + '"Active": true,';
      end else begin
         cardJSON := cardJSON + '"Active": false,';
      end;
      cardJSON := cardJSON + '"PaymentGUID": "'+ Trim(RNQuery2.FieldByName('PAYMENTGUID').AsString)+'"}';
   end;
begin
   TranSuccess := false;
   ResponseJSON := TStringList.Create;
   paymethodCount := 0;
   ResponseJSON.Add('{');
   if OpenCustomerQuery(AQueryFields) then begin
      CustGUID := RNQuery.FieldByName('CustomerCode').AsString;
      cardJSON  := '"cards" : [';
      checkJSON := '"checks" : [';
      RNQuery2.Close;
      RNQuery2.SQL.Clear;

      RNQuery2.SQL.Add('SELECT *  FROM (');
      RNQuery2.SQL.Add('Select PAYMENTNAME, CARDISSUETYPE, CARDEXPIRES,CustPayment.PAYMENTGUID, ROW_NUMBER() OVER(PARTITION BY CustPayment.PAYMENTGUID order by STATUS asc) rn,');
      RNQuery2.SQL.Add('CASE WHEN STATUS = ''ACTIVE'' THEN ''ACTIVE'' WHEN STATUS = ''SUSPENDED'' THEN ''ACTIVE'' ELSE ''INACTIVE'' END AS STATUS from CustPayment ');
      RNQuery2.SQL.Add('left outer join custpaysched on (CustPaySched.PaymentGUID = CustPayment.PaymentGUID)  where (CustPayment.CustGUID = '''+CustGUID + ''') and (Hidden = 0) and PaymentType = ''CARD''');
      RNQuery2.SQL.Add(') a WHERE rn = 1');
      RNQuery2.Open;
      paymethodCount := RNQuery2.RecordCount;
      If RNQuery2.RecordCount >0  then begin
         While Not RNQuery2.EOF do begin
            BuildCardJSON;
            RNQuery2.Next;
            if not RNQuery2.EOF then begin
               cardJSON := cardJSON + ',';
            end;
         end;
      end;
      RNQuery2.Close;
      RNQuery2.SQL.Clear;

      RNQuery2.SQL.Add('SELECT *  FROM (');
      RNQuery2.SQL.Add('Select PAYMENTNAME, CustPayment.PAYMENTGUID, ROW_NUMBER() OVER(PARTITION BY CustPayment.PAYMENTGUID order by STATUS asc) rn,');
      RNQuery2.SQL.Add('CASE WHEN STATUS = ''ACTIVE'' THEN ''ACTIVE'' WHEN STATUS = ''SUSPENDED'' THEN ''ACTIVE'' ELSE ''INACTIVE'' END AS STATUS from CustPayment ');
      RNQuery2.SQL.Add('left outer join custpaysched on (CustPaySched.PaymentGUID = CustPayment.PaymentGUID)  where (CustPayment.CustGUID = '''+CustGUID + ''') and (Hidden = 0) and PaymentType = ''CHECK''');
      RNQuery2.SQL.Add(') a WHERE rn = 1');
      RNQuery2.Open;
      paymethodCount := paymethodCount + RNQuery2.RecordCount;
      If RNQuery2.RecordCount >0  then begin
         While Not RNQuery2.EOF do begin
            BuildCheckJSON;
            RNQuery2.Next;
            if not RNQuery2.EOF then begin
               checkJSON := checkJSON + ',';
            end;
         end;
      end;
      if paymethodCount = 0 then begin
         TranMessage := 'No Payment Methods on File';
      end else begin
         TranSuccess := true;
      end;
      cardJSON  := cardJSON + '],';
      checkJSON := checkJSON + '],';
      ResponseJSON.Add(cardJSON);
      ResponseJSON.Add(checkJSON);
      FinalizeJSONRespAndFree;
   end else begin
      TranMessage := 'Customer Not Found';
      FinalizeJSONRespAndFree;
   end;

end;

function TCustomerInfoModule.GetAutomatedPaymentsAjax(const AQueryFields, AContentFields: TStrings; ARNID: string): string;
var
CustGUID: string;
ResponseJSON : TStringList;
TranSuccess : boolean;
TranMessage : string;
   Procedure FinalizeJSONRespAndFree;
   Begin
      ResponseJSON.Add('"serverdate" : "'+FormatDateTime('MM/DD/YYYY', now)+'",');
      ResponseJSON.Add('"servertime" : "'+FormatDateTime('HH:NN:SS', now)+'",');
      ResponseJSON.Add('"tranrespmessage" : "'+TranMessage+'",');
      ResponseJSON.Add('"profile" : "'+ARNID+'",');
      if TranSuccess then begin
         ResponseJSON.Add('"transuccess" : true');
      end else begin
         ResponseJSON.Add('"transuccess" : false');
         ProcessLog(ltWarning, 'GetAutomatedPaymentsAjax transucces false:',TranMessage);
      end;
      ResponseJSON.Add('}');
      Result := ResponseJSON.Text;
      ResponseJSON.Free;
   end;
begin
   TranSuccess := false;
   ResponseJSON := TStringList.Create;
   ResponseJSON.Add('{');
   if OpenCustomerQuery(AQueryFields) then begin
      CustGUID := RNQuery.FieldByName('CustomerCode').AsString;
      RNQuery2.Close;
      RNQuery2.SQL.Clear;
      RNQuery2.SQL.Add('select CustPaySched.ExternalIntegration, PaySchedGUID,NextPayment,Custom1,Custom2,Custom3,Custom4,FirstPayment,Frequency,EndDate,');
      RNQuery2.SQL.Add(' PaymentAmount, Status, firstname, lastname, paymentName,Name, Address1, City,State,Zip,PaymentsMade,paymentsremaining, NumberOfPayments from custpaysched');
      RNQuery2.SQL.Add('left outer join store on (RNID=Store.SystemCode)');
      RNQuery2.SQL.Add('left outer join custpayment on (CustPaySched.PaymentGUID=CustPayment.PaymentGUID)');
      RNQuery2.SQL.Add('left outer join custchild on (CustPaySched.ChildGuid=custchild.ChildGUID)');
      RNQuery2.SQL.Add('Where (custpaysched.CustGUID = '''+CustGUID + ''')');
      RNQuery2.Open;
      ResponseJSON.Add('"custGUID" : "'+CustGUID+'",');
      ResponseJSON.Add('"scheduledpayments" : [');
      if RNQuery2.RecordCount > 0 then begin
         while Not RNQuery2.EOF do begin
            ResponseJSON.Add('{');
            If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SCHEDPAY/CHILDNAME') = 'TRUE' then begin   //Use the child account name that the payment was made for -JTM 12/18/14
               ResponseJSON.Add('"Name" : "'+ Trim(RNQuery2.FieldByName('firstname').AsString)+ ' ' + Trim(RNQuery2.FieldByName('lastname').AsString)+'",');
            end else begin
               ResponseJSON.Add('"Name" : "'+Trim(RNQuery2.FieldByName('Name').AsString)+'",');
            end;
            ResponseJSON.Add('"paymentName" : "'+Trim(RNQuery2.FieldByName('PaymentName').AsString)+'",');
            ResponseJSON.Add('"frequency" : "'+Trim(RNQuery2.FieldByName('Frequency').AsString)+'",');
            ResponseJSON.Add('"nextPayment" : "'+Trim(RNQuery2.FieldByName('NextPayment').AsString)+'",');
            ResponseJSON.Add('"paymentAmount" : "'+Trim(StriReal(RNQuery2.FieldByName('PaymentAmount').AsFloat,2))+'",');
            ResponseJSON.Add('"paymentsMade" : "'+Trim(RNQuery2.FieldByName('PaymentsMade').AsString)+'",');
            ResponseJSON.Add('"numberOfPayments" : "'+Trim(RNQuery2.FieldByName('NumberOfPayments').AsString)+'",');
            ResponseJSON.Add('"paymentsRemaining" : "'+Trim(RNQuery2.FieldByName('paymentsremaining').AsString)+'",');
            ResponseJSON.Add('"startDate" : "'+Trim(RNQuery2.FieldByName('FirstPayment').AsString)+'",');
            ResponseJSON.Add('"endDate" : "'+Trim(RNQuery2.FieldByName('enddate').AsString)+'",');
            ResponseJSON.Add('"custom1" : "'+Trim(RNQuery2.FieldByName('custom1').AsString)+'",');
            ResponseJSON.Add('"custom2" : "'+Trim(RNQuery2.FieldByName('custom2').AsString)+'",');
            ResponseJSON.Add('"custom3" : "'+Trim(RNQuery2.FieldByName('custom3').AsString)+'",');
            ResponseJSON.Add('"custom4" : "'+Trim(RNQuery2.FieldByName('custom4').AsString)+'",');
            if (Trim(RNQuery2.FieldByName('ExternalIntegration').AsString) = '') then begin
               ResponseJSON.Add('"nonvalidatedAutomatedPayment" : true,');
            end;

            ResponseJSON.Add('"paymentSchedGUID" : "'+Trim(RNQuery2.FieldByName('PAYSCHEDGUID').AsString)+'"');

            ResponseJSON.Add('}');
            RNQuery2.Next;
            if not RNQuery2.EOF then begin
               ResponseJSON.Add(',');
            end;
         end;
         TranSuccess := true;
      end else begin
         TranMessage := 'No Payment Schedules on File';
      end;
      ResponseJSON.Add('],');
      FinalizeJSONRespAndFree;
   end else begin
      TranMessage := 'Customer Not Found';
      FinalizeJSONRespAndFree;
   end;

end;

function TCustomerInfoModule.AddAutomatedPaymentAjax(const AQueryFields, AContentFields: TStrings; ARNID: string): string;
var
CustGUID,ChildGUID,SchedGUID,memberType,startdatestr,enddatestr,subscriptionId: string;
CustomField1,CustomField2,CustomField3,CustomField4,CustomField5,CustomField6,CustomField7,CustomField8,CustomField9,CustomField10 : string;
ResponseJSON : TStringList;
TranSuccess : boolean;
TranMessage : string;
FREQ : String;
SchedPayLoc : String;
PayAmt : Currency;
GrossAmt : Currency;
NumberOfPayments : Integer;
totalAmountDue,currentAmountDue,fixedAmountDue : boolean;
   Procedure FinalizeJSONRespAndFree;
   Begin
      ResponseJSON.Add('"serverdate" : "'+FormatDateTime('MM/DD/YYYY', now)+'",');
      ResponseJSON.Add('"servertime" : "'+FormatDateTime('HH:NN:SS', now)+'",');
      ResponseJSON.Add('"tranrespmessage" : "'+TranMessage+'",');
      ResponseJSON.Add('"profile" : "'+ARNID+'",');
      if TranSuccess then begin
         ResponseJSON.Add('"transuccess" : true');
      end else begin
         ResponseJSON.Add('"transuccess" : false');
         ProcessLog(ltWarning, 'AddAutomatedPaymentAjax transucces false:',TranMessage);
      end;
      ResponseJSON.Add('}');
      Result := ResponseJSON.Text;
      ResponseJSON.Free;
   end;
   function ValidFrequency(AFreq : string):boolean;
   begin
      AFreq := Trim(UpCaseString(AFreq));
      result := false;
      if AFreq ='MONTHLY' then begin
         result := true;
      end else if AFreq ='ANNUALLY' then begin
         result := true;
      end else if AFreq='QUARTERLY' then begin
         result := true;
      end else if AFreq='BIMONTHLY' then begin
         result := true;
      end else if AFreq ='BIWEEKLY' then begin
         result := true;
      end else if AFreq='WEEKLY' then begin
         result := true;
      end;
   end;
begin
   TranSuccess := false;
   ResponseJSON := TStringList.Create;
   ResponseJSON.Add('{');
   if OpenCustomerQuery(AQueryFields) then begin
      CustGUID := RNQuery.FieldByName('CustomerCode').AsString;

      SchedPayLoc := NumericOnly(AContentFields.Values['Location']);

      if SchedPayLoc <> '' then begin
         if not ValidateRNID(SchedPayLoc) then begin
            ProcessLog(ltWarning,'Attempt to add scheduled payment from Invalid Location RNID',SchedPayLoc);
            TranMessage := 'Invalid Location RNID';
            FinalizeJSONRespAndFree;
            exit;
         end;
      end;

      ChildGUID := GuidOnly(AContentFields.Values['childguid']);
      if (ChildGUID <> '') then begin
         RNQuery2.Close;
         RNQuery2.SQL.Clear;
         RNQuery2.SQL.Add('select * from CustChild where (ChildGUID = '''+ChildGUID + ''') And (CustGUID = '''+CustGUID + ''')');
         RNQuery2.Open;
         If RnQuery2.RecordCount = 0 then begin
            ProcessLog(ltWarning,'Attempt to add schedule with invalid childguid ',ChildGUID + '/' + CustGUID);
            TranMessage := 'Invalid ChildGUID';
            FinalizeJSONRespAndFree;
            exit;
         end else begin
            SchedPayLoc := Trim(RNquery2.FieldByName('RNID').AsString);
            subscriptionId := Trim(RNquery2.FieldByName('ExternalIntegration').AsString);
         end;
         RNQuery2.Close;
      end else begin
         TranMessage := 'ChildGUID Empty';
         FinalizeJSONRespAndFree;
         exit;
      end;

      if SchedPayLoc = '' then begin
         SchedPayLoc := ARNID;
      end;
      memberType := RNQuery.FieldByName('MEMBSTATUS').AsString;

      ResponseJSON.Add('"memberType" : "'+memberType+'",');
      ResponseJSON.Add('"custGUID" : "'+CustGUID+'",');
      ResponseJSON.Add('"childGUID" : "'+ChildGUID+'",');
      RNQuery2.Close;
      RNQuery2.SQL.Clear;
      RNQuery2.SQL.Add('Select * from CustPaySched where (CustGUID = '''+CustGUID + ''')');
      RNQuery2.Open;
      RNQuery2.Insert;
      RNQuery2.FieldByName('SiteRNID').AsString := ARNID;
      RNQuery2.FieldByName('RNID').AsString := SchedPayLoc;
      RNQuery2.FieldByName('CustGUID').AsString := CustGUID;
      RNQuery2.FieldByName('ChildGUID').AsString := ChildGUID;
      SchedGUID := GenerateGUID;
      RNQuery2.FieldByName('PAYSCHEDGUID').AsString := SchedGUID;
      RNQuery2.FieldByName('PAYMENTGUID').AsString := GUIDOnly(AContentFields.Values['paymentguid']);
      RNQuery2.FieldByName('Status').AsString := 'ACTIVE';
      RNQuery2.FieldByName('ScheduleAdded').AsDateTime := Now;
      RNQuery2.FieldByName('PaymentsMade').AsInteger := 0;
      FREQ := Trim(UpCaseString(ValidCharsOnly(AContentFields.Values['frequency'],true,true,'')));
      if not (ValidFrequency(FREQ)) then begin
         TranMessage := 'Invalid Frequency';
         ProcessLog(ltWarning,'Attempt to add schedule with invalid frequency ',FREQ);
         FinalizeJSONRespAndFree;
         exit;
      end;
      RNQuery2.FieldByName('Frequency').AsString := FREQ;
      startdatestr := ValidCharsOnly(AContentFields.Values['startdate'],true,true,'-/: ');
      try
         RNQuery2.FieldByName('FirstPayment').AsString := startdatestr;
      except
         on e:exception do begin
            TranMessage := 'Invalid Start Date '+startdatestr;
            ProcessLog(ltWarning,'Attempt to add schedule with invalid startdate ',startdatestr);
            FinalizeJSONRespAndFree;
            exit;
         end;
      end;
      enddatestr := ValidCharsOnly(AContentFields.Values['enddate'],true,true,'-/: ');
      try
         RNQuery2.FieldByName('EndDate').AsString := enddatestr;
      except
         on e:exception do begin
            TranMessage := 'Invalid End Date '+enddatestr;
            ProcessLog(ltWarning,'Attempt to add schedule with invalid startdate ',enddatestr);
            FinalizeJSONRespAndFree;
            exit;
         end;
      end;
      RNQuery2.FieldByName('NextPayment').AsDateTime := RNQuery2.FieldByName('FirstPayment').AsDateTime;
      If (OpenXMLGetTag('/CONFIGDATA/STORECUSTOMFIELDS','FALSE') = 'TRUE') then begin //2017-09-20 jtm: F#2192
         CustomField1 := ValidCharsOnly(AContentFields.Values['Custom1'],true,true,'/.-&(),:+=_ ');
         CustomField2 := ValidCharsOnly(AContentFields.Values['Custom2'],true,true,'/.-&(),:+=_ ');
         CustomField3 := ValidCharsOnly(AContentFields.Values['Custom3'],true,true,'/.-&(),:+=_ ');
         CustomField4 := ValidCharsOnly(AContentFields.Values['Custom4'],true,true,'/.-&(),:+=_ ');
         CustomField5 := ValidCharsOnly(AContentFields.Values['Custom5'],true,true,'/.-&(),:+=_ ');
         CustomField6 := ValidCharsOnly(AContentFields.Values['Custom6'],true,true,'/.-&(),:+=_ ');
         CustomField7 := ValidCharsOnly(AContentFields.Values['Custom7'],true,true,'/.-&(),:+=_ ');
         CustomField8 := ValidCharsOnly(AContentFields.Values['Custom8'],true,true,'/.-&(),:+=_ ');
         CustomField9 := ValidCharsOnly(AContentFields.Values['Custom9'],true,true,'/.-&(),:+=_ ');
         CustomField10 := ValidCharsOnly(AContentFields.Values['Custom10'],true,true,'/.-&(),:+=_ ');
         if Length(CustomField1) > 200 then CustomField1 := Copy(CustomField1,0,200);
         if Length(CustomField2) > 200 then CustomField2 := Copy(CustomField2,0,200);
         if Length(CustomField3) > 200 then CustomField3 := Copy(CustomField3,0,200);
         if Length(CustomField4) > 200 then CustomField4 := Copy(CustomField4,0,200);
         if Length(CustomField5) > 200 then CustomField5 := Copy(CustomField5,0,200);
         if Length(CustomField6) > 200 then CustomField6 := Copy(CustomField6,0,200);
         if Length(CustomField7) > 200 then CustomField7 := Copy(CustomField7,0,200);
         if Length(CustomField8) > 200 then CustomField8 := Copy(CustomField8,0,200);

         RNQuery2.FieldByName('Custom1').AsString := CustomField1;
         RNQuery2.FieldByName('Custom2').AsString := CustomField2;
         RNQuery2.FieldByName('Custom3').AsString := CustomField3;
         RNQuery2.FieldByName('Custom4').AsString := CustomField4;
         RNQuery2.FieldByName('Custom5').AsString := CustomField5;
         RNQuery2.FieldByName('Custom6').AsString := CustomField6;
         RNQuery2.FieldByName('Custom7').AsString := CustomField7;
         RNQuery2.FieldByName('Custom8').AsString := CustomField8;
         RNQuery2.FieldByName('Custom9').AsString := CustomField9;
         RNQuery2.FieldByName('Custom10').AsString := CustomField10;
      end;

      RNQuery2.FieldByName('NumberOfPayments').AsInteger := Valu(NumericOnly(AContentFields.Values['numberOfPayments'])); //need to calculate this on the frontend
      RNQuery2.FieldByName('PaymentsRemaining').AsInteger := RNQuery2.FieldByName('numberOfPayments').AsInteger;
      RNQuery2.FieldByName('PaymentAmount').AsString := ValidCharsOnly(AContentFields.Values['amount'],false,true,'.');
      if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SCHEDPAY/EXTERNALINTEGRATION','FALSE')) then begin
         if (memberType = 'Member') or (memberType = 'Employer') or (memberType = 'Guest') then begin
            RNquery2.FieldByName('ExternalIntegration').AsString := subscriptionId;
            RNQuery2.FieldByName('GrossAmount').AsCurrency := 0;
         end;
         if strtobool(ValidCharsOnly(AContentFields.Values['oneTimePay'],true,true,'')) then begin
            RNQuery2.FieldByName('Custom3').AsString := 'oneTimePay';
            RNQuery2.FieldByName('GrossAmount').AsCurrency := RNQuery2.FieldByName('PaymentAmount').AsCurrency;
            RNQuery2.FieldByName('NumberOfPayments').AsInteger := 1;  //enforce 1 payment
            RNQuery2.FieldByName('PaymentsRemaining').AsInteger := 1;
         end;
         fixedAmountDue := strtobool(ValidCharsOnly(AContentFields.Values['fixedAmountDue'],true,true,''));
         totalAmountDue := strtobool(ValidCharsOnly(AContentFields.Values['totalAmountDue'],true,true,''));
         currentAmountDue := strtobool(ValidCharsOnly(AContentFields.Values['currentAmountDue'],true,true,''));
         if fixedAmountDue then begin
            RNQuery2.FieldByName('Custom4').AsString := 'fixedAmountDue';
         end else if totalAmountDue then begin
            RNQuery2.FieldByName('Custom4').AsString := 'totalAmountDue';
         end else if currentAmountDue then begin
            RNQuery2.FieldByName('Custom4').AsString :=  'currentAmountDue';
         end;
      end else begin
         RNQuery2.FieldByName('GrossAmount').AsCurrency := ValuReal(ValidCharsOnly(AContentFields.Values['Balance'],false,true,'.'));
         PayAmt := RNQuery2.FieldByName('PaymentAmount').AsCurrency;
         GrossAmt := RNQuery2.FieldByName('GrossAmount').AsCurrency;
         NumberOfPayments := RNQuery2.FieldByName('NumberOfPayments').AsInteger;
         If (GrossAmt> 0) and (NumberOfPayments > 0) and (PayAmt=0) then begin  //only calculate the PaymentAmount if it is not present
            PayAmt := GrossAmt / NumberOfPayments * 100;
            If Frac(PayAmt) > 0 then PayAmt := Trunc(PayAmt + 1);
            PayAmt := PayAmt / 100;
            RNQuery2.FieldByName('PaymentAmount').AsCurrency := PayAmt;
         end else if (GrossAmt= 0) and (NumberOfPayments > 0) and (PayAmt > 0) then begin  //only calculate the GrossAmount if it is not present
            GrossAmt := PayAmt * NumberOfPayments;
            RNQuery2.FieldByName('GrossAmount').AsCurrency := GrossAmt;
         end;
      end;

      RNQuery2.Post;
      RNQuery2.Close;
      ResponseJSON.Add('"schedGUID" : "'+SchedGUID+'",');
      TranSuccess := true;
      FinalizeJSONRespAndFree;
   end else begin
      TranMessage := 'Customer Not Found';
      FinalizeJSONRespAndFree;
   end;

end;
function TCustomerInfoModule.DeleteAutomatedPaymentAjax(const AQueryFields, AContentFields: TStrings; ARNID: string): string;
var
CustGUID,SchedGUID: string;
ResponseJSON : TStringList;
TranSuccess : boolean;
TranMessage : string;
   Procedure FinalizeJSONRespAndFree;
   Begin
      ResponseJSON.Add('"serverdate" : "'+FormatDateTime('MM/DD/YYYY', now)+'",');
      ResponseJSON.Add('"servertime" : "'+FormatDateTime('HH:NN:SS', now)+'",');
      ResponseJSON.Add('"tranrespmessage" : "'+TranMessage+'",');
      ResponseJSON.Add('"profile" : "'+ARNID+'",');
      if TranSuccess then begin
         ResponseJSON.Add('"transuccess" : true');
      end else begin
         ResponseJSON.Add('"transuccess" : false');
         ProcessLog(ltWarning, 'DeleteAutomatedPaymentAjax transucces false:',TranMessage);
      end;
      ResponseJSON.Add('}');
      Result := ResponseJSON.Text;
      ResponseJSON.Free;
   end;
begin
   TranSuccess := false;
   ResponseJSON := TStringList.Create;
   ResponseJSON.Add('{');
   if OpenCustomerQuery(AQueryFields) then begin
      CustGUID := RNQuery.FieldByName('CustomerCode').AsString;
      SchedGUID := GuidOnly(AContentFields.Values['PAYSCHEDGUID']);
      ResponseJSON.Add('"custGUID" : "'+CustGUID+'",');
      ResponseJSON.Add('"schedGUID" : "'+SchedGUID+'",');
      RNQuery2.Close;
      RNQuery2.SQL.Clear;
      RNQuery2.SQL.Add('Select * from CustPaySched where (CustGUID = '''+CustGUID + ''') and (PaySchedGUID = ''' + SchedGUID + ''')');
      RNQuery2.Open;
      if RNQuery2.RecordCount = 1 then begin
         RNQuery2.Delete;
         TranSuccess := true;
      end else begin
         TranMessage := 'Schedule Not Found';
      end;
      RNQuery2.Close;
      FinalizeJSONRespAndFree;
   end else begin
      TranMessage := 'Customer Not Found';
      FinalizeJSONRespAndFree;
   end;
end;

function TCustomerInfoModule.GetBillingInformationAjax(const AQueryFields,AContentFields: TStrings; ARNID: string): string;
var
memberType,CustGUID,ChildGUID,billStr,subscriptionId: string;
WS: string;
ResponseJSON : TStringList;
TranSuccess : boolean;
TranMessage : string;
HEResponse : TStringList;
billSL : TStringlist;
   Procedure FinalizeJSONRespAndFree;
   Begin
      ResponseJSON.Add('"serverdate" : "'+FormatDateTime('MM/DD/YYYY', now)+'",');
      ResponseJSON.Add('"servertime" : "'+FormatDateTime('HH:NN:SS', now)+'",');
      ResponseJSON.Add('"tranrespmessage" : "'+TranMessage+'",');
      ResponseJSON.Add('"profile" : "'+ARNID+'",');
      if TranSuccess then begin
         ResponseJSON.Add('"transuccess" : true');
      end else begin
         ResponseJSON.Add('"transuccess" : false');
         ProcessLog(ltWarning, 'GetBillingInformationAjax transucces false:',TranMessage);
      end;
      ResponseJSON.Add('}');
      Result := ResponseJSON.Text;
      ResponseJSON.Free;
   end;
begin
   TranSuccess := false;
   ResponseJSON := TStringList.Create;
   ResponseJSON.Add('{');
   if OpenCustomerQuery(AQueryFields) then begin
      memberType := RNQuery.FieldByName('MEMBSTATUS').AsString;
      CustGUID := trim(RNQuery.FieldByName('CustomerCode').AsString);
      ChildGUID := GUIDOnly(AContentFields.Values['ChildGUID']);
      ResponseJSON.Add('"memberType" : "'+memberType+'",');
      ResponseJSON.Add('"custGUID" : "'+CustGUID+'",');
      ResponseJSON.Add('"childGUID" : "'+ChildGUID+'",');
      VarEvaluator.AddValue('memberType',memberType);
      if (memberType = 'Member') or (memberType = 'Employer') or (memberType = 'Guest') then begin
         RNQuery2.Close;
         RNQuery2.SQL.Clear;
         RNQuery2.SQL.Add('Select * from CustChild left outer join store on (store.systemcode = CustChild.RNID) where (CustGUID = '''+ CustGUID+ ''') and (Hidden=0)');
         if (ChildGUID = '') then begin
            TranMessage := 'ChildGUID Empty';
            FinalizeJSONRespAndFree;
            exit;
         end;
         RNQuery2.SQL.Add('and (ChildGUID = ''' + ChildGUID + ''')');
         RNQuery2.Open;
         billSL := TStringList.Create;
         if (RNQuery2.RecordCount = 1) then begin
               if (memberType = 'Member') or (memberType = 'Guest') then begin
                  SessionVarEval.AddValue('MemberHCCID',RNQuery2.FieldByName('AccountNumber').AsString);
                  VarEvaluator.AddValue('MemberHCCID',RNQuery2.FieldByName('AccountNumber').AsString);
               end else if (memberType = 'Employer') then begin
                  SessionVarEval.AddValue('EmployerAccountID',RNQuery2.FieldByName('AccountNumber').AsString);
                  SessionVarEval.AddValue('TaxID',RNQuery2.FieldByName('ExternalCustIdent').AsString);
                  VarEvaluator.AddValue('EmployerAccountID',RNQuery2.FieldByName('AccountNumber').AsString);
                  VarEvaluator.AddValue('TaxID',RNQuery2.FieldByName('ExternalCustIdent').AsString);
               end;
               SessionVarEval.AddValue('subscriptionId',RNQuery2.FieldByName('ExternalIntegration').AsString);
               VarEvaluator.AddValue('subscriptionId',RNQuery2.FieldByName('ExternalIntegration').AsString);
               TranSuccess := HEGetBills(TranMessage);
               if TranSuccess then begin
                     billStr := trim(VarEvaluator.GetValueAsString('billXML'));
                  end;
            if (billStr <> '') then begin
               billStr := XMLToJSON(billStr);
               delete(billStr,1,1);
               delete(billStr,length(billStr),1);//remove the beginning and ending brackets
               ResponseJSON.Add(billStr+',');
            end else begin
               ResponseJSON.Add('"bill" : {},');
            end;
            ResponseJSON.Add('"billID" : "'+VarEvaluator.GetValueAsString('BillID')+'",');
            FreeAndNil(billSL);
            FinalizeJSONRespAndFree;
         end else begin
            TranMessage := 'Child Not Found';
            FinalizeJSONRespAndFree;
         end;
      end else begin
         TranMessage := 'Invalid memberType';
         FinalizeJSONRespAndFree;
      end;
   end else begin
      TranMessage := 'Customer Not Found';
      FinalizeJSONRespAndFree;
   end;
end;



function TCustomerInfoModule.EditAccountInformationAjax(const AQueryFields,  AContentFields: TStrings; ARNID: string): string;
var
CustGUID,SchedGUID,memberType,newMemberType: string;
ResponseJSON : TStringList;
TranSuccess : boolean;
TranMessage : string;
accountNumber : string;
   Procedure FinalizeJSONRespAndFree;
   Begin
      ResponseJSON.Add('"serverdate" : "'+FormatDateTime('MM/DD/YYYY', now)+'",');
      ResponseJSON.Add('"servertime" : "'+FormatDateTime('HH:NN:SS', now)+'",');
      ResponseJSON.Add('"tranrespmessage" : "'+TranMessage+'",');
      ResponseJSON.Add('"profile" : "'+ARNID+'",');
      if TranSuccess then begin
         ResponseJSON.Add('"transuccess" : true');
      end else begin
         ResponseJSON.Add('"transuccess" : false');
         ProcessLog(ltWarning, 'EditAccountInformationAjax transucces false:',TranMessage);
      end;
      ResponseJSON.Add('}');
      Result := ResponseJSON.Text;
      ResponseJSON.Free;
   end;
begin
   TranSuccess := false;
   ResponseJSON := TStringList.Create;
   ResponseJSON.Add('{');
   if OpenCustomerQuery(AQueryFields) then begin
      CustGUID := RNQuery.FieldByName('CustomerCode').AsString;
      memberType := RNQuery.FieldByName('MEMBSTATUS').AsString;
      ResponseJSON.Add('"custGUID" : "'+CustGUID+'",');
      RNQuery.Edit;
      if (memberType = 'Member') or (memberType = 'Guest') then begin
          newMemberType := ValidCharsOnly(AContentFields.Values['newMemberType'],True,false,'');
          if (memberType <> newMemberType) and ((newMemberType = 'Member') or (newMemberType = 'Guest')) then begin
             RNQuery.FieldByName('MEMBSTATUS').AsString := newMemberType;
             SessionVarEval.AddValue('MEMBSTATUS',newMemberType);
             TranMessage := 'MemberType updated';
          end;
          accountNumber := ValidCharsOnly(AContentFields.Values['accountNumber'],True,true,'-');
          if (accountNumber <> '') then begin
            if (accountNumber <> trim(RNQuery.FieldByName('AccountNumber').AsString)) then begin
               VarEvaluator.AddValue('MemberHCCID',accountNumber);
               if not ValidateHEUser(memberType,TranMessage) then begin
                  FinalizeJSONRespAndFree;
                  exit;
               end else begin
                  if (Trim(AContentFields.Values['lastname']) <> trim(VarEvaluator.GetValueAsString('Member.lastName'))) then begin
                     TranMessage := 'Member Validation failed';
                     ProcessLog(ltWarning, 'EditAccountInformationAjaxin Member Validation failed lastname:',Trim(AContentFields.Values['lastname'])+':'+ trim(VarEvaluator.GetValueAsString('Member.lastName')));
                     TranSuccess := false;
                     FinalizeJSONRespAndFree;
                     exit;
                  end;
               end;
            end;
          end;
      end;
      LoadCustomerFormData(RNQuery,AQueryFields,AContentFields);
      Try
         RNQuery.Post;
         TranSuccess := true;
      except
         ON E:Exception do begin
            TranMessage := 'Account Update Failed';
            ProcessLog(ltWarning,'Exception on EditAccountInformationAjax;custguid:'+CustGUID,e.message);
         end;
      end;
      GetAccountInformationJSON(RNQuery,ResponseJSON);
      RNQuery.Close;
      FinalizeJSONRespAndFree;
   end else begin
      TranMessage := 'Customer Not Found';
      FinalizeJSONRespAndFree;
   end;

end;

function TCustomerInfoModule.GetAccountInformationAjax(const AQueryFields,  AContentFields: TStrings; ARNID: string): string;
var
CustGUID,SchedGUID: string;
ResponseJSON : TStringList;
TranSuccess : boolean;
TranMessage : string;
   Procedure FinalizeJSONRespAndFree;
   Begin
      ResponseJSON.Add('"serverdate" : "'+FormatDateTime('MM/DD/YYYY', now)+'",');
      ResponseJSON.Add('"servertime" : "'+FormatDateTime('HH:NN:SS', now)+'",');
      ResponseJSON.Add('"tranrespmessage" : "'+TranMessage+'",');
      ResponseJSON.Add('"profile" : "'+ARNID+'",');
      if TranSuccess then begin
         ResponseJSON.Add('"transuccess" : true');
      end else begin
         ResponseJSON.Add('"transuccess" : false');
         ProcessLog(ltWarning, 'GetAccountInformationAjax transucces false:',TranMessage);
      end;
      ResponseJSON.Add('}');
      Result := ResponseJSON.Text;
      ResponseJSON.Free;
   end;
begin
   TranSuccess := false;
   ResponseJSON := TStringList.Create;
   ResponseJSON.Add('{');
   if OpenCustomerQuery(AQueryFields) then begin
      CustGUID := RNQuery.FieldByName('CustomerCode').AsString;
      ResponseJSON.Add('"custGUID" : "'+CustGUID+'",');
      GetAccountInformationJSON(RNQuery,ResponseJSON);
      TranSuccess := true;
      RNQuery.Close;
      FinalizeJSONRespAndFree;
   end else begin
      TranMessage := 'Customer Not Found';
      FinalizeJSONRespAndFree;
   end;
end;

procedure TCustomerInfoModule.GetAccountInformationJSON(AQuery: TADOQuery; var ASL: TStringList);
begin
   ASL.Add('"email" : "'+Trim(AQuery.FieldByName('EMAIL').AsString)+'",');
   ASL.Add('"firstname" : "'+Trim(AQuery.FieldByName('FIRSTNAME').AsString)+'",');
   ASL.Add('"lastname" : "'+Trim(AQuery.FieldByName('LASTNAME').AsString)+'",');
   ASL.Add('"middlename" : "'+Trim(AQuery.FieldByName('middlename').AsString)+'",');
   ASL.Add('"address" : "'+Trim(AQuery.FieldByName('ADDRESS').AsString)+'",');
   ASL.Add('"address2" : "'+Trim(AQuery.FieldByName('HOMEADDRESS2').AsString)+'",');
   ASL.Add('"city" : "'+Trim(AQuery.FieldByName('CITY').AsString)+'",');
   ASL.Add('"state" : "'+Trim(AQuery.FieldByName('STATE').AsString)+'",');
   ASL.Add('"zip" : "'+Trim(AQuery.FieldByName('ZIP').AsString)+'",');
   ASL.Add('"country" : "'+Trim(AQuery.FieldByName('country').AsString)+'",');
   ASL.Add('"hphone" : "'+Trim(AQuery.FieldByName('HPHONE').AsString)+'",');
   ASL.Add('"wphone" : "'+Trim(AQuery.FieldByName('WPHONE').AsString)+'",');
   ASL.Add('"mobilephone" : "'+Trim(AQuery.FieldByName('MOBILEPHONE').AsString)+'",');
   ASL.Add('"employer" : "'+Trim(AQuery.FieldByName('EMPLOYER').AsString)+'",');
   ASL.Add('"workaddress1" : "'+Trim(AQuery.FieldByName('WORKADDRESS1').AsString)+'",');
   ASL.Add('"workaddress2" : "'+Trim(AQuery.FieldByName('WORKADDRESS2').AsString)+'",');
   ASL.Add('"workcity" : "'+Trim(AQuery.FieldByName('WORKCITY').AsString)+'",');
   ASL.Add('"workstate" : "'+Trim(AQuery.FieldByName('WORKSTATE').AsString)+'",');
   ASL.Add('"workzip" : "'+Trim(AQuery.FieldByName('WORKZIP').AsString)+'",');
   ASL.Add('"salutation" : "'+Trim(AQuery.FieldByName('Salutation').AsString)+'",');
   ASL.Add('"workextension" : "'+Trim(AQuery.FieldByName('WORKEXTENSION').AsString)+'",');
   ASL.Add('"accountnumber" : "'+Trim(AQuery.FieldByName('ACCOUNTNUMBER').AsString)+'",');
   ASL.Add('"custom1" : "'+Trim(AQuery.FieldByName('CUSTOM1').AsString)+'",');
   ASL.Add('"custom2" : "'+Trim(AQuery.FieldByName('CUSTOM2').AsString)+'",');
   ASL.Add('"custom3" : "'+Trim(AQuery.FieldByName('CUSTOM3').AsString)+'",');
   ASL.Add('"custom4" : "'+Trim(AQuery.FieldByName('CUSTOM4').AsString)+'",');
   ASL.Add('"custom5" : "'+Trim(AQuery.FieldByName('CUSTOM5').AsString)+'",');
   ASL.Add('"custom6" : "'+Trim(AQuery.FieldByName('CUSTOM6').AsString)+'",');
   ASL.Add('"custom7" : "'+Trim(AQuery.FieldByName('CUSTOM7').AsString)+'",');
   ASL.Add('"custom8" : "'+Trim(AQuery.FieldByName('CUSTOM8').AsString)+'",');
   ASL.Add('"custom10" : "'+Trim(AQuery.FieldByName('CUSTOM10').AsString)+'",');
end;

function TCustomerInfoModule.GetPaymentHistoryAjax(const AQueryFields,AContentFields: TStrings; ARNID: string): string;
var
memberType,CustGUID,ChildGUID,PSGUID,paymentStr: string;
WS: string;
ResponseJSON : TStringList;
TranSuccess : boolean;
TranMessage : string;
HEResponse : TStringList;
paymentXML : TOpenXML;
paymentXMLNode : TOpenXMLNode;
paymentXMLChildNode : TOpenXMLNode;
   Procedure FinalizeJSONRespAndFree;
   Begin
      ResponseJSON.Add('"serverdate" : "'+FormatDateTime('MM/DD/YYYY', now)+'",');
      ResponseJSON.Add('"servertime" : "'+FormatDateTime('HH:NN:SS', now)+'",');
      ResponseJSON.Add('"tranrespmessage" : "'+TranMessage+'",');
      ResponseJSON.Add('"profile" : "'+ARNID+'",');
      if TranSuccess then begin
         ResponseJSON.Add('"transuccess" : true');
      end else begin
         ResponseJSON.Add('"transuccess" : false');
         ProcessLog(ltWarning, 'GetPaymentHistoryAjax transucces false:',TranMessage);
      end;
      ResponseJSON.Add('}');
      Result := ResponseJSON.Text;
      ResponseJSON.Free;
   end;
begin
   TranSuccess := false;
   ResponseJSON := TStringList.Create;
   ResponseJSON.Add('{');
   if OpenCustomerQuery(AQueryFields) then begin
      memberType := RNQuery.FieldByName('MEMBSTATUS').AsString;
      CustGUID := trim(RNQuery.FieldByName('CustomerCode').AsString);
      ChildGUID := GUIDOnly(AContentFields.Values['ChildGUID']);
      ResponseJSON.Add('"memberType" : "'+memberType+'",');
      ResponseJSON.Add('"custGUID" : "'+CustGUID+'",');
      ResponseJSON.Add('"childGUID" : "'+ChildGUID+'",');
      RNQuery2.Close;
      RNQuery2.SQL.Clear;
      RNQuery2.SQL.Add('Select * from CustChild left outer join store on (store.systemcode = CustChild.RNID) where (CustGUID = '''+ CustGUID+ ''') and (Hidden=0)');
      if (ChildGUID = '') then begin
         TranMessage := 'ChildGUID Empty';
         FinalizeJSONRespAndFree;
         exit;
      end;
      RNQuery2.SQL.Add('and (ChildGUID = ''' + ChildGUID + ''')');
      RNQuery2.Open;
      if (RNQuery2.RecordCount = 1) then begin
         (*if (memberType = 'Member') or (memberType = 'Employer') or (memberType = 'Guest') then begin
            if (memberType = 'Member') or (memberType = 'Guest') then begin
               SessionVarEval.AddValue('MemberHCCID',RNQuery2.FieldByName('AccountNumber').AsString);
               VarEvaluator.AddValue('MemberHCCID',RNQuery2.FieldByName('AccountNumber').AsString);
            end else if (memberType = 'Employer') then begin
               SessionVarEval.AddValue('EmployerAccountID',RNQuery2.FieldByName('AccountNumber').AsString);
               SessionVarEval.AddValue('TaxID',RNQuery2.FieldByName('ExternalCustIdent').AsString);
               VarEvaluator.AddValue('EmployerAccountID',RNQuery2.FieldByName('AccountNumber').AsString);
               VarEvaluator.AddValue('TaxID',RNQuery2.FieldByName('ExternalCustIdent').AsString);
            end;
            SessionVarEval.AddValue('subscriptionId',RNQuery.FieldByName('COMMENTS1').AsString);
            VarEvaluator.AddValue('subscriptionId',RNQuery.FieldByName('COMMENTS1').AsString);
            TranSuccess := HEGetBills(TranMessage);
            if TranSuccess then begin
               if (memberType = 'Member') or (memberType = 'Guest') then begin
                  paymentStr := trim(VarEvaluator.GetValueAsString('billXML'));
               end else if (memberType = 'Employer') then begin
                  paymentStr := trim(VarEvaluator.GetValueAsString('billXML'));
               end;
            end;
            ResponseJSON.Add('"payments" : [');
            if (paymentStr <> '') then begin
               paymentStr := '<reportedPremiumPayments>'+GetXMLTagStr(paymentStr,'reportedPremiumPayments')+'</reportedPremiumPayments>';
               if LoadOpenXML(paymentXML, paymentStr) then begin
                  paymentXMLNode := paymentXML.GetNode('/reportedPremiumPayments');
                  if (paymentXMLNode <> nil) then begin
                     paymentXMLNode := paymentXMLNode.FindFirstChildElement;
                     while (paymentXMLNode <> nil) do begin
                        ResponseJSON.Add('{');
                        ResponseJSON.Add('"paymentdate" : "'+paymentXML.GetContextValueAsWideString(paymentXMLNode,'processDate')+'",');
                        ResponseJSON.Add('"paymentamount" : "' + paymentXML.GetContextValueAsWideString(paymentXMLNode,'totalAmount')+ '",');
                        ResponseJSON.Add('"paymentserial" : "' + paymentXML.GetContextValueAsWideString(paymentXMLNode,'paymentIdentifier')+ '"');
                        ResponseJSON.Add('}');
                        paymentXMLNode := paymentXMLNode.FindNextSiblingElement;
                        if (paymentXMLNode <> nil) then begin
                           ResponseJSON.Add(',');
                        end;
                     end;
                     FreeAndNil(paymentXML);
                  end else begin
                     TranMessage := 'PaymentXML Error';
                     TranSuccess := false;
                     FinalizeJSONRespAndFree;
                     exit;
                  end;
               end else begin
                  TranMessage := 'PaymentXML Error';
                  TranSuccess := false;
                  FinalizeJSONRespAndFree;
                  exit;
               end;
            end;
            ResponseJSON.Add('],');
         end else begin*)
            RNQuery.Close;
            RNQuery.SQL.Clear;

            RNQuery.SQL.Add('Declare @BegDate as varchar(40); declare @DateRangeName as varchar(20);');
            RNQuery.SQL.Add('set @DateRangeName = ''' + OpenXMLGetTag('/CONFIGDATA/UIPARAMS/CUSTOMERPROFILE/PAYMENTHISTORYDATERANGE','LAST18MONTHS') + ''';');
            if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/CUSTOMERPROFILE/PAYMENTHISTORYBEGDATE','') <> '' then begin
               RNQuery.SQL.Add(' set @BegDate = ''' + OpenXMLGetTag('/CONFIGDATA/UIPARAMS/CUSTOMERPROFILE/PAYMENTHISTORYBEGDATE','') + '''');
            end else begin
               RNQuery.SQL.Add(' set @BegDate = ''08/01/2018''');
            end;
            RNQuery.SQL.Add('set @BegDate = case @DateRangeName' +
                     ' when ''TODAY'' then DATEADD(day,DATEDIFF(day,0,GETDATE()),0)' +
                     ' when ''YESTERDAY'' then DATEADD(day,DATEDIFF(day,0,GETDATE()-1),0)' +
                     ' when ''LAST7DAYS'' then DATEADD(day,DATEDIFF(day,0,GETDATE()-7),0)' +
                     ' when ''LAST30DAYS'' then DATEADD(day,DATEDIFF(day,0,GETDATE()-30),0)' +
                     ' when ''LAST6MONTHS'' then DATEADD(month,DATEDIFF(month,0,GETDATE())-6,0)' +
                     ' when ''LAST12MONTHS'' then DATEADD(month,DATEDIFF(month,0,GETDATE())-12,0)' +
                     ' when ''LAST18MONTHS'' then DATEADD(month,DATEDIFF(month,0,GETDATE())-18,0)' +
                     ' when ''MTD'' then DATEADD(month,DATEDIFF(month,0,GETDATE()),0)' +
                     ' when ''YTD'' then DATEADD(year,DATEDIFF(year,0,GETDATE()),0)' +
                     ' when ''LASTWEEK'' then DATEADD(week, DATEDIFF(week,0,GETDATE())-1,-1)' +
                     ' when ''THISWEEK'' then DATEADD(week, DATEDIFF(week,0,GETDATE()),-1)' +
                     ' when ''LASTMONTH'' then DATEADD(month, DATEDIFF(month,0,GETDATE())-1,0)' +
                     ' when ''LASTYEAR'' then DATEADD(year, DATEDIFF(year,0,GETDATE())-1,0) else @BegDate end;');

            RNQuery.SQL.Add('select Store.SystemCode as RNID, CustPaymentHistory.SystemCode as PaymentSerial,CustPaymentHistory.ApprovalCode as AC, CustPaymentHistory.PaymentGUID as PayGUID, custHistDesc, PaymentDate,PayHistGUID,CustPaymentHistory.PaymentAmount, ' +
                         'paymentName,paymentType,custpaymenthistory.CHILDGUID,custpaymenthistory.Custom1,custpaymenthistory.Custom2, custchild.FIRSTNAME as childfirstname, custchild.LASTNAME as childlastname,');

            If ((OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERPROFILE/INCLUDETRANIDENT','FALSE') = 'TRUE') or (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERPROFILE/INCLUDECUSTIDENT','FALSE') = 'TRUE')) then begin
               RNQuery.SQL.Add('checkauth.TranIdent as CKTranIdent, cardauth.TranIdent as CCTranIdent, checkauth.TranCustomerCode as CKCustIdent,cardauth.TranCustomerCode as CCCustIdent,');
            end;
            RNQuery.SQL.Add('Name, Address1, City,State,Zip from custpaymenthistory');
            RNQuery.SQL.Add('left outer join store on (RNID=Store.SystemCode)');
            RNQuery.SQL.Add('left outer join custpayment on (custpaymenthistory.PaymentGUID=CustPayment.PaymentGUID)');
            RNQuery.SQL.Add('left outer join custchild on (custpaymenthistory.CHILDGUID=custchild.CHILDGUID)');
            If ((OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERPROFILE/INCLUDETRANIDENT','FALSE') = 'TRUE') or (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERPROFILE/INCLUDECUSTIDENT','FALSE') = 'TRUE')) then begin
               RNQuery.SQL.Add('left outer join (Select TranIdent,TranCustomerCode,StoreSystemCode,StoreCode From CCAuth)cardauth on (cardauth.StoreCode=Store.SYSTEMCODE and cardauth.StoreSystemCode=CustPaymentHistory.GWSystemCode)');
               RNQuery.SQL.Add('left outer join (Select TranIdent,TranCustomerCode,StoreSystemCode,StoreCode From TCAuth)checkauth on (checkauth.StoreCode=Store.SYSTEMCODE and checkauth.StoreSystemCode=CustPaymentHistory.GWSystemCode)');
            end;
            RNQuery.SQL.Add('Where (custpaymenthistory.CustGUID = '''+CustGUID + ''') and (ApprovalCode <> '''') ');
            if (PSGUID <> '') then begin
               RNQuery.SQL.Add('And (custpaymenthistory.PaySchedGUID = '''+PSGUID + ''')');
            end;

            RNQuery.SQL.Add('And (custpaymenthistory.paymentdate >= @BegDate)');

            RNQuery.SQL.Add('order by paymentdate desc');
            ProcessLog(ltInfo, 'GetPaymentHistoryAjax RNQuery.SQL.Text',RNQuery.SQL.Text);
            RNQuery.Open;

            ResponseJSON.Add('"payments" : [');

            While Not RNQuery.EOF do begin
               ResponseJSON.Add('{');
               ResponseJSON.Add('"paymentdate" : "'+FormatDateTime('MM/DD/YYYY',RNquery.FieldByName('PaymentDate').AsDateTime)+'",');
               if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYHIST/CHILDNAME') = 'TRUE' then begin
                  ResponseJSON.Add('"name" : "'+ Trim(RNQuery.FieldByName('childfirstname').AsString)+ ' ' + Trim(RNQuery.FieldByName('childlastname').AsString)+'",');
               end else begin
                  ResponseJSON.Add('"name" : "'+ Trim(RNQuery.FieldByName('Name').AsString)+'",');
               end;
               if Trim(RNQuery.FieldByName('PaymentName').AsString) <> '' then begin
                  ResponseJSON.Add('"paymentname" : "'+ Trim(RNQuery.FieldByName('PaymentName').AsString)+'",');
               end else if Trim(RNQuery.FieldByName('AC').AsString) = 'OFFLINE' then begin
                  ResponseJSON.Add('"paymentname" : "offline",');
               end else begin
                  ResponseJSON.Add('"paymentname" : "' + Trim(RNQuery.FieldByName('CustHistDesc').AsString)+ '",');
               end;

               ResponseJSON.Add('"paymentamount" : "' + Trim(StriReal(RNQuery.FieldByName('PaymentAmount').AsFloat,2))+ '",');
               ResponseJSON.Add('"payhistguid" : "' + Trim(RNQuery.FieldByName('PayHistGuid').AsString)+ '",');

               If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERPROFILE/INCLUDETRANIDENT','FALSE') = 'TRUE' then begin
                  ResponseJSON.Add('"ccTranIdent" : "' + Trim(RNQuery.FieldByName('CCTranIdent').AsString)+ '",');
                  ResponseJSON.Add('"ckTranIdent" : "' + Trim(RNQuery.FieldByName('CKTranIdent').AsString)+ '",');
               end;
               If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERPROFILE/INCLUDECUSTIDENT','FALSE') = 'TRUE' then begin
                  ResponseJSON.Add('"ccCustIdent" : "' + Trim(RNQuery.FieldByName('CCCustIdent').AsString)+ '",');
                  ResponseJSON.Add('"ckCustIdent" : "' + Trim(RNQuery.FieldByName('CKCustIdent').AsString)+ '",');
               end;
               ResponseJSON.Add('"paymentType" : "' + Trim(RNQuery.FieldByName('paymentType').AsString)+ '",');
               ResponseJSON.Add('"custom1" : "' + Trim(RNQuery.FieldByName('custom1').AsString)+ '",');
               ResponseJSON.Add('"custom2" : "' + Trim(RNQuery.FieldByName('custom2').AsString)+ '",');
               ResponseJSON.Add('"paymentserial" : "' + Trim(RNQuery.FieldByName('PaymentSerial').AsString)+ '"');
               ResponseJSON.Add('}');
               RNQuery.Next;
               if not RNQuery.EOF then begin
                  ResponseJSON.Add(',');
               end;
            end;
            ResponseJSON.Add('],');
            TranSuccess := true;
      end else begin
         TranMessage := 'Child Not Found';
      end;
   end else begin
      TranMessage := 'Customer Not Found';
   end;
   FinalizeJSONRespAndFree;
end;

function TCustomerInfoModule.EditAccountPWAjax(const AQueryFields, AContentFields: TStrings; ARNID: string): string;
var
CustGUID,Password: string;
ResponseJSON : TStringList;
TranSuccess : boolean;
TranMessage : string;
   Procedure FinalizeJSONRespAndFree;
   Begin
      ResponseJSON.Add('"serverdate" : "'+FormatDateTime('MM/DD/YYYY', now)+'",');
      ResponseJSON.Add('"servertime" : "'+FormatDateTime('HH:NN:SS', now)+'",');
      ResponseJSON.Add('"tranrespmessage" : "'+TranMessage+'",');
      ResponseJSON.Add('"profile" : "'+ARNID+'",');
      if TranSuccess then begin
         ResponseJSON.Add('"transuccess" : true');
      end else begin
         ResponseJSON.Add('"transuccess" : false');
         ProcessLog(ltWarning, 'EditAccountPWAjax transucces false:',TranMessage);
      end;
      ResponseJSON.Add('}');
      Result := ResponseJSON.Text;
      ResponseJSON.Free;
   end;
begin
   TranSuccess := false;
   ResponseJSON := TStringList.Create;
   ResponseJSON.Add('{');
   if OpenCustomerQuery(AQueryFields) then begin
      CustGUID := trim(RNQuery.FieldByName('CustomerCode').AsString);
      ResponseJSON.Add('"custGUID" : "'+CustGUID+'",');
      Password := AContentFields.Values['passwordold'];
      if OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/CASESENSITIVE', 'FALSE') = 'FALSE' then Password := UpCaseString(Password);

      if CheckBCryptPassword(Trim(Password),CustGUID,Trim(RNQuery.FieldByName('PasswordBcrypt').asString)) then begin
         Password := AContentFields.Values['passwordnew'];
         If OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/CASESENSITIVE', 'FALSE') = 'FALSE' then Password := UpCaseString(Password);
         RNQuery.Edit;
         RNQuery.FieldByName('PasswordHash').AsString := '';
         RNQuery.FieldByName('PasswordBcrypt').AsString := BCryptPassword(Trim(Password),CustGUID);
         RNQuery.Post;
         TranSuccess := true;
      end else begin
         TranMessage := 'Current password is invalid';
      end;
   end else begin
      TranMessage := 'Customer Not Found';
   end;
   FinalizeJSONRespAndFree;
end;

function TCustomerInfoModule.UpdateAccountAjax(const AQueryFields, AContentFields: TStrings; ARNID: string): string;
var
email,Password,memberType,memberTypeAPI,ParentGUID,ChildGUID,firstname,lastname,dob,accountnum,EmployerAccountID: string;
ResponseJSON : TStringList;
TranSuccess : boolean;
TranMessage : string;
TaxID : string;
   Procedure FinalizeJSONRespAndFree;
   Begin
      ResponseJSON.Add('"serverdate" : "'+FormatDateTime('MM/DD/YYYY', now)+'",');
      ResponseJSON.Add('"servertime" : "'+FormatDateTime('HH:NN:SS', now)+'",');
      ResponseJSON.Add('"tranrespmessage" : "'+TranMessage+'",');
      ResponseJSON.Add('"profile" : "'+ARNID+'",');
      if TranSuccess then begin
         ResponseJSON.Add('"transuccess" : true');
      end else begin
         ResponseJSON.Add('"transuccess" : false');
         ProcessLog(ltWarning, 'UpdateAccountAjax transucces false:',TranMessage);
      end;
      ResponseJSON.Add('}');
      Result := ResponseJSON.Text;
      ResponseJSON.Free;
   end;
begin
   result := '';
   ResponseJSON := TStringList.Create;
   ResponseJSON.Add('{');
   TranSuccess := false;
   If OpenCustomerQuery(AQueryFields) then begin
      ParentGUID := Trim(RNQuery.FieldByName('CustomerCode').AsString);
      ChildGUID := GUIDOnly(AContentFields.Values['ChildGUID']);
      memberType := Trim(RNQuery.FieldByName('MEMBSTATUS').AsString);
      memberTypeAPI := memberType;
      TaxID := ValidCharsOnly(trim(AContentFields.Values['TaxIDNumber']),True,true,'-');
      if (memberType = 'Applicant') or (memberType = 'Member') or (memberType = 'Employer') or (memberType = 'Guest') then begin
         AccountNum := ValidCharsOnly(AContentFields.Values['memberID'],True,True,' /.-');
         if (memberType <> 'Employer') then begin
         if (AccountNum = '') then begin
            TranMessage := 'Member Account ID Empty';
            FinalizeJSONRespAndFree;
            exit;
         end;
            memberTypeAPI := 'Member';
         end else if (TaxID = '') then begin
            TranMessage := 'Tax ID Empty';
            FinalizeJSONRespAndFree;
            exit;
         end;
         SessionVarEval.AddValue('MemberHCCID',AccountNum);
         VarEvaluator.AddValue('MemberHCCID',AccountNum);
         SessionVarEval.AddValue('EmployerAccountID',ValidCharsOnly(trim(AContentFields.Values['EmployerAccountID']),True,true,'- '));
         SessionVarEval.AddValue('TaxID',TaxID);
         VarEvaluator.AddValue('EmployerAccountID',ValidCharsOnly(trim(AContentFields.Values['EmployerAccountID']),True,true,'- '));
         VarEvaluator.AddValue('TaxID',TaxID);
         TranSuccess := ValidateHEUser(memberTypeAPI,TranMessage);
         if not TranSuccess then begin
            FinalizeJSONRespAndFree;
            exit;
         end else begin
            if (memberType = 'Employer') then begin
                EmployerAccountID := VarEvaluator.GetValueAsString('EmployerAccountID');
                if (Pos('-',EmployerAccountID) > 0) then begin
                  EmployerAccountID := Copy(EmployerAccountID,1,Pos('-',EmployerAccountID)-1);
         end;
                if (Trim(EmployerAccountID) <> trim(VarEvaluator.GetValueAsString('subscriptionId'))) then begin
                  TranMessage := 'Employer Validation failed';
                  ProcessLog(ltWarning, 'UpdateAccountAjax Employer Validation failed accountid:',Trim(VarEvaluator.GetValueAsString('EmployerAccountID'))+':'+ trim(VarEvaluator.GetValueAsString('subscriptionId')));
                  TranSuccess := false;
                  FinalizeJSONRespAndFree;
                  exit;
                end;
            end else begin
                try
                   if (Trim(AContentFields.Values['memberLastName']) <> trim(VarEvaluator.GetValueAsString('Member.lastName'))) then begin
                     TranMessage := 'Member Validation failed';
                     ProcessLog(ltWarning, 'UpdateAccountAjax Member Validation failed lastname:',Trim(AContentFields.Values['memberLastName'])+':'+ trim(VarEvaluator.GetValueAsString('Member.lastName')));
                     TranSuccess := false;
                     FinalizeJSONRespAndFree;
                     exit;
                   end else if (StrToDateTime(Trim(AContentFields.Values['memberdob'])) <> StrToDateTime(VarEvaluator.GetValueAsString('Member.birthDate'))) then begin
                     TranMessage := 'Member Validation failed';
                     ProcessLog(ltWarning, 'UpdateAccountAjax Member Validation failed dob:',Trim(AContentFields.Values['memberdob'])+':'+ trim(VarEvaluator.GetValueAsString('Member.birthDate')));
                     TranSuccess := false;
                     FinalizeJSONRespAndFree;
                     exit;
                   end;
                except
                  on e:exception do begin
                     TranMessage := 'Member Validation failed';
                     TranSuccess := false;
                     FinalizeJSONRespAndFree;
                     exit;
                  end;
                end;
            end;
         end;
         RNQuery.Edit;
         RNQuery.FieldByName('COMMENTS1').AsString := VarEvaluator.GetValueAsString('subscriptionId');
         RNQuery.FieldByName('COMMENTS2').AsString := VarEvaluator.GetValueAsString('Member.subscriptionId');
         RNQuery.FieldByName('COMMENTS3').AsString := VarEvaluator.GetValueAsString('Member.subscriberId');
         RNQuery.FieldByName('COMMENTS4').AsString := VarEvaluator.GetValueAsString('Member.subscriberSystemId');
         RNQuery.FieldByName('COMMENTS5').AsString := VarEvaluator.GetValueAsString('Member.subscriptionSystemId');
         RNQuery.FieldByName('COMMENTS6').AsString := VarEvaluator.GetValueAsString('Member.systemId');
         if (memberType = 'Applicant') then begin
         RNQuery.FieldByName('MEMBSTATUS').AsString := 'Member'; //MEMBTYPE is reserved for ADMIN, so let's use membstatus
         SessionVarEval.AddValue('MEMBSTATUS','Member');
         RNQuery.FieldByName('AccountNumber').AsString := AccountNum;
         RNQuery.FieldByName('DOB').AsString := VarEvaluator.GetValueAsString('Member.birthDate');
         end;

         RNQuery2.Close;
         RNQuery2.SQL.Clear;
         RNQuery2.SQL.Add('select * from CustChild where (ChildGUID = '''+ChildGUID + ''') And (CustGUID = '''+ParentGUID + ''')');
         RNQuery2.Open;
         if (RNQuery2.RecordCount = 1) then begin
            RNQuery2.Edit;
            if (memberType = 'Employer') then begin
               RNQuery2.FieldByName('AccountNumber').AsString := VarEvaluator.GetValueAsString('EmployerAccountID');
               RNQuery2.FieldByName('ExternalCustIdent').AsString := VarEvaluator.GetValueAsString('TaxID');
            end else begin
            RNQuery2.FieldByName('AccountNumber').AsString := AccountNum;
            end;
            RNQuery2.FieldByName('ExternalIntegration').AsString := VarEvaluator.GetValueAsString('subscriptionId');
            RNQuery2.FieldByName('DOB').AsString := VarEvaluator.GetValueAsString('Member.birthDate');
            RNQuery2.FieldByName('firstname').AsString := VarEvaluator.GetValueAsString('Member.firstName');
            RNQuery2.FieldByName('lastname').AsString := VarEvaluator.GetValueAsString('Member.lastName');
            RNQuery2.Post;
            RNQuery.Post;
            TranSuccess := true;
         end else begin
            TranMessage := 'Invalid ChildGUID';
            FinalizeJSONRespAndFree;
            exit;
         end;
         ResponseJSON.Add('"custGuid": "'+ParentGUID+'",');
         ResponseJSON.Add('"childGUID": "'+ChildGUID+'",');
         TranMessage := 'Account Updated';
         FinalizeJSONRespAndFree;
      end else begin
         TranMessage := 'Invalid MemberType';
         FinalizeJSONRespAndFree;
      end;
   end else begin
      TranMessage := 'Customer Not Found';
      FinalizeJSONRespAndFree;
   end;

end;



function TCustomerInfoModule.GetTransHistoryGridDataAsXML(const TransHistSQL: String; AQueryFields: TStrings; const DisplayRNID, DisplayStoreName: boolean): String;
var
   ADOQuery: TADOQuery;
   CHCORNID: String;
   CustGUID: String;
   PayHistGUID: String;
   PaymentDate: String;
   Name: String;
   Amount: String;
   PaymentType: String;
   PaymentName: String;
   ReceiptNumber: String;
   PaymentResult: String;
   Temp2: String;// 2018-12-19 ss: DVST-3056 Starting with 2 and then 3 because to keep consitent to original 2 and 3 of W2 and W3 in GETSTOREPAYMENTHISTORY
   Temp3: String;
   storeRNID: string;
   storeName: string;
   row: Integer;
   XMLLines : TStringList;
   XMLLine : TStringList;
   IsDisplayTimeInTZ: Boolean;
   procedure CleanUp();
   begin
      FreeAndNil(ADOQuery);
      FreeAndNil(XMLLines);
      FreeAndNil(XMLLine);
   end;
begin
   XMLLines := TStringList.Create();
   XMLLine := TStringList.Create();
   ProcessLog(ltDebug,'GetTransHistoryGridDataAsXML','Passed QueryFieldsCommaText = '+AQueryFields.CommaText);
   IsDisplayTimeInTZ := StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE')); // 2019-4-17 ss DVST-4900
   ADOQuery := TADOQuery.Create(Nil);
   ADOQuery.Connection := RNDB;
   ADOQuery.SQL.Add(TransHistSQL);
   ADOQuery.Open();
   ProcessLog(ltDebug,'GetTransHistoryGridDataAsXML','Query Opened; Record Count: '+Stri(ADOQuery.RecordCount,-1));
   row:= 1;
   if ADOQuery.RecordCount > 0 then begin
      XMLLines.Add('<?xml version="1.0" encoding="UTF-8"?><rows total_count="'+IntToStr(ADOQuery.RecordCount)+'" pos= "0">');
      while not ADOQuery.Eof do begin
         if DisplayRNID then storeRNID := Trim(ADOQuery.FieldByName('StoreSystemCode').AsString);
         if DisplayStoreName then storeName := Trim(ADOQuery.FieldByName('StoreName').AsString);

         CustGUID := Trim(ADOQuery.FieldByName('CustomerCode').AsString);
         PayHistGUID := Trim(ADOQuery.FieldByName('PAYHISTGUID').AsString);
         CHCORNID := ADOQuery.FieldByName('RNID').AsString;

         If(IsDisplayTimeInTZ) then begin // 2019-4-17 ss DVST-4900
            PaymentDate := ADOQuery.FieldByName('PaymentDatetz').AsString;
         end else begin
            PaymentDate := ADOQuery.FieldByName('PaymentDate').AsString;
         end;

         Temp2 := '<a href="javascript:GetCustomerProfile(''' + Trim(ADOQuery.FieldByName('CustomerCode').AsString)+''')"> ' +
                  Trim(Trim(ADOQuery.FieldByName('FirstName').AsString) +
                  ' ' +Trim(ADOQuery.FieldByName('LastName').AsString) +
                  '</a> '+ Trim(ADOQuery.FieldByName('AccountNumber').AsString));
         Temp3 := Trim(Trim(ADOQuery.FieldByName('ChildFirstName').AsString) +
                  ' ' +Trim(ADOQuery.FieldByName('ChildLastName').AsString) +
                  ' '+Trim(ADOQuery.FieldByName('ChildAccountNumber').AsString));

         if Temp3 <> '' then begin
            Temp2 := Temp2 + '<br>' + Temp3;
         end;
         Name := Temp2;
         Amount := Trim(StriReal(ADOQuery.FieldByName('PaymentAmount').AsFloat,2));
         PaymentType := Trim(ADOQuery.FieldByName('PaymentType').AsString);

         if ((Length(PaymentType) = 0) And (StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DEFAULTEMPTYPAYMENTTYPETOCARD','FALSE')))) then begin // 2019-1-16 SS DVST-3660
            PaymentType := 'Card';
         end;

         if Trim(ADOQuery.FieldByName('PaymentName').AsString) <> '' then begin
            PaymentName := Trim(ADOQuery.FieldByName('PaymentName').AsString);
         end else begin
            PaymentName := Trim(ADOQuery.FieldByName('CustHistDesc').AsString);
         end;

         ReceiptNumber := Trim(ADOQuery.FieldByName('RNID').AsString) + '-' +
                          Trim(ADOQuery.FieldByName('Systemcode').AsString) + '-' +
                          FormatDateTime('YYMMDD',ADOQuery.FieldByName('PaymentDate').AsDateTime);


         if AQueryFields.Values['SUPRESSDECLINES'] <> 'TRUE' then begin
            if Trim(ADOQuery.FieldByName('NonAuthReason').AsString) <> '' then begin
               PaymentResult:= '<cell style="background-color:#FF0000;">'+ToUTF(Trim(ADOQuery.FieldByName('NonAuthReason').AsString))+'</cell>';
            end else begin
               PaymentResult:= '<cell style="background-color:#00FF00;">'+ToUTF(Trim(ADOQuery.FieldByName('ApprovalCode').AsString))+'</cell>';
            end;
         end;

         XMLLine.Append('<row id="'+ IntToStr(row) +'">');
         if StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/HASSPLITPAYMENTS', 'FALSE')) then begin // 2019-1-16 SS DVST-3660
            XMLLine.Append('<cell type="sub_row_grid">PP?PAGE=GETTRANSHISTSUBROWGRIDDATAAJAX&amp;RNID='+CHCORNID+'&amp;CustGUID='+CustGUID+'&amp;PayHistGUID='+PayHistGUID+'</cell>');
         end;
         if DisplayRNID then XMLLine.Add('<cell>' + ToUTF(storeRNID) + '</cell>');
         if DisplayStoreName then XMLLine.Add('<cell>' + ToUTF(storeName) + '</cell>');
         XMLLine.Append('<cell>'+ToUTF(PaymentDate)+'</cell>');
         XMLLine.Append('<cell>'+ToUTF(Name)+'</cell>');
         XMLLine.Append('<cell>'+ToUTF(Amount)+'</cell>');
         XMLLine.Append('<cell>'+ToUTF(PaymentType)+'</cell>');
         XMLLine.Append('<cell>'+ToUTF(PaymentName)+'</cell>');
         XMLLine.Append('<cell>'+ToUTF(ReceiptNumber)+'</cell>');
         XMLLine.Append(PaymentResult);
         XMLLine.Append('</row>');

         XMLLines.Append(XMLLine.Text);
         XMLLine.Clear();
         ADOQuery.Next();
         Inc(row);
      end;
   end else begin
      XMLLines.Add('<?xml version="1.0" encoding="UTF-8"?><rows total_count="0" pos="0">');
   end;
   XMLLines.Append('</rows>');
   ProcessLog(ltDebug,'GetTransHistoryGridDataAsXML','End');

   Result := XMLLines.Text;
   ADOQuery.Close();
   CleanUp();
   ProcessLog(ltDebug,'GetTransHistoryGridDataAsXML','GetTransHistoryGridDataAsXML Result = '+Result); // 2018-12-19 ss: DVST-3056 For Testing
end;

function TCustomerInfoModule.ReturnZeroSubRowGridDataAsXML(): String;
var
   ErrorMsg: String;
begin
   ProcessLog(ltDebug,'ReturnZeroSubRowGridDataAsXML','Begin Function'); // 2018-12-19 ss: DVST-3056 For Testing
   ErrorMsg := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/TRANSACTIONTAB/GRIDSUBROWERRORMSG', 'NO SPLIT PAYMENT HISTORY ON FILE');
   ErrorMsg := '<B>**' + ErrorMsg + '**</B>';
   Result := '<?xml version="1.0" encoding="UTF-8"?>'+
             '<rows total_count="1" pos="0">'+
               '<head><column width="*" type="ro" sort="str">'+ToUTF(ErrorMsg)+'</column></head>'+  
               '<row id="1"><cell></cell></row>'+
             '</rows>';
   ProcessLog(ltDebug,'ReturnZeroSubRowGridDataAsXML','Result = '+Result);
   ProcessLog(ltDebug,'ReturnZeroSubRowGridDataAsXML','End Function'); // 2018-12-19 ss: DVST-3056 For Testing
end;
function TCustomerInfoModule.GetTransHistSubRowGidDataAsXML(const RNID, CustGUID, PayHistGUID: String): String; // TODO pass them as const and take away HostName
const
   XMLMETA = '<?xml version="1.0" encoding="UTF-8"?>';
var
   ADomainConfigXML: TOpenXML;
   SplitDetailsXML: TOpenXML;
   TotalSplitDetailsRows: Integer;
   XML : String;
   XMLHeader: String;
   XMLBody: String;
   HostNameXPath: String;
   HostName: String;
begin
   ProcessLog(ltDebug, 'GetTransHistSubRowGidDataAsXML', 'BEGIN FUNCTION');

   ADomainConfigXML := Nil;
   SplitDetailsXML := Nil;
   XMLHeader := '';
   XMLBody := '';

   HostNameXPath:= '/CONFIGDATA/UIPARAMS/TRANSACTIONTAB/SPLITTABLES/SPLITTABLE[@RNID='''+RNID+''']';
   HostName := OpenXMLGetTag(HostNameXPath,'');
   ProcessLog(ltDebug, 'GetTransHistSubRowGidDataAsXML', 'Length(HostName) = '+Stri(Length(HostName),-1));

   If Length(HostName) <> 0 then begin
      ADomainConfigXML := GetDomainConfigXMLByRNIDAndHostName(RNID, HostName);
      SplitDetailsXML  := GetSplitDetailsXMLByCustAndPayHistGUID(CustGUID, PayHistGUID);
      TotalSplitDetailsRows:= 0;
      If((ADomainConfigXML <> Nil) And (SplitDetailsXML <> Nil)) then begin
         XMLHeader := BuildSplitXMLHeaderByAConfigXML(ADomainConfigXML);
         XMLBody := BuildSplitXMLBodyByAConfigAndSplitXML(ADomainConfigXML, SplitDetailsXML, TotalSplitDetailsRows);
         XML :=  XMLMETA +
                '<rows total_count="'+IntToStr(TotalSplitDetailsRows)+'" pos="0">' +
                 XMLHeader +
                 XMLBody +
                 '</rows>';
         Result := XML;
      end else begin
         Result := ReturnZeroSubRowGridDataAsXML();
      end;
   end else begin
      Result := ReturnZeroSubRowGridDataAsXML();
   end;
   ProcessLog(ltDebug, 'GetTransHistSubRowGidDataAsXML', 'Result = '+Result);
   FreeAndNil(ADomainConfigXML);
   FreeAndNil(SplitDetailsXML);
   ProcessLog(ltDebug, 'GetTransHistSubRowGidDataAsXML', 'END FUNCTION');
end;

function TCustomerInfoModule.GetDomainConfigXMLByRNIDAndHostName(RNID, HostName: String):TOpenXML;
const
   SQL = 'SELECT ConfigData FROM WWWHost WHERE RNID = :rnid AND HostName = :hostName';
var
   ADOQuery: TADOQuery;
   RNIDParam: TParameter;
   HostNameParam: TParameter;
   ADomainConfigXML: TOpenXML; // 2018-12-19 ss:DVST-3056 Freed at calling function
begin
   ProcessLog(ltDebug, 'GetDomainConfigXMLByRNIDAndHostName', 'Begin Function.');
   ADOQuery := Nil;
   ADomainConfigXML := Nil;
   RNIDParam := Nil;
   HostNameParam := Nil;

   ADOQuery := TADOQuery.Create(Nil);
   ADOQuery.Connection := RNDB;
   ADOQuery.SQL.Add(SQL);

   RNIDParam:= ADOQuery.Parameters.ParamByName('rnid');
   RNIDParam.DataType := ftInteger;
   RNIDParam.Value := StrToInt(RNID);

   HostNameParam := ADOQuery.Parameters.ParamByName('hostName');
   HostNameParam.DataType := ftString;
   HostNameParam.Value := HostName;

   try
      ADOQuery.Prepared := True;
      ADOQuery.Open();
      ADomainConfigXML := TOpenXML.CreateFromString(Nil, ADOQuery.FieldByName('ConfigData').AsString);
      Result := ADomainConfigXML;
      ProcessLog(ltDebug, 'GetDomainConfigXMLByRNIDAndHostName', 'Finished Setting Up and Returning ADomainConfigXML.');
   except
      on e: Exception do begin
         ADOQuery.Close();
         FreeAndNil(ADOQuery);
         ProcessLog(ltDebug, 'GetDomainConfigXMLByRNIDAndHostName', 'ADOQuery Error: '+E.Message);
         Result := Nil;
      end;
   end;
   ADOQuery.Close();
   FreeAndNil(ADOQuery);
   ProcessLog(ltDebug, 'GetDomainConfigXMLByRNIDAndHostName', 'End Function.');
end;

function TCustomerInfoModule.GetSplitDetailsXMLByCustAndPayHistGUID(CustGUID, PayHistGUID: String):TOpenXML;
const
   SQL = 'SELECT SPLITDETAILS FROM CUSTPAYMENTHISTORY WHERE CUSTGUID = :custGUID AND PAYHISTGUID = :payHistGUID';
var
   ADOQuery: TADOQuery;
   CustGUIDParam: TParameter;
   PayHistGUIDParam: TParameter;
   SplitXML: String;
   SplitDetailsXML: TOpenXML; // 2018-12-19 ss:DVST-3056 Freed at calling function
begin
   ProcessLog(ltDebug, 'GetSplitDetailsXMLByCustAndPayHistGUID', 'Begin Function.');
   ADOQuery := Nil;
   SplitDetailsXML := Nil;
   CustGUIDParam := Nil;
   PayHistGUIDParam := Nil;
   SplitXML := '';

   ADOQuery := TADOQuery.Create(Nil);
   ADOQuery.Connection := RNDB;
   ADOQuery.SQL.Add(SQL);

   CustGUIDParam:= ADOQuery.Parameters.ParamByName('custGUID');
   CustGUIDParam.DataType := ftString;
   CustGUIDParam.Value := CustGUID;

   PayHistGUIDParam := ADOQuery.Parameters.ParamByName('payHistGUID');
   PayHistGUIDParam.DataType := ftString;
   PayHistGUIDParam.Value := PayHistGUID;

   try
      ADOQuery.Prepared := True;
      ADOQuery.Open();
      SplitXML := ADOQuery.FieldByName('SPLITDETAILS').AsString;
      If (Length(SplitXML) > 0) then begin
         SplitDetailsXML := TOpenXML.CreateFromString(Nil, SplitXML);
         Result := SplitDetailsXML;
         ProcessLog(ltDebug, 'GetSplitDetailsXMLByCustAndPayHistGUID', 'SplitDetailsXML created and returned.');
      end else begin
         Result := Nil;
         ProcessLog(ltDebug, 'GetSplitDetailsXMLByCustAndPayHistGUID', 'No SplitDetailsXML. Nil Returened.');
      end;
   except
      on e: Exception do begin
         Result := Nil;
         ADOQuery.Close();
         FreeAndNil(ADOQuery);
         ProcessLog(ltDebug, 'GetSplitDetailsXMLByCustAndPayHistGUID', 'ADOQuery Error: '+E.Message);
      end;
   end;
   ADOQuery.Close();
   FreeAndNil(ADOQuery);
   ProcessLog(ltDebug, 'GetSplitDetailsXMLByCustAndPayHistGUID', 'End Function.');
end;

function TCustomerInfoModule.BuildSplitXMLHeaderByAConfigXML(AConfigXML:TOpenXML):String;
const
   PIPEDELIMITER = '|';
   COMMADELIMITER = ',';
var
   XMLHeaderLine: TStringList;
   HeaderList: TTTStringList;
   ColTypeList: TTTStringList;
   ColSortList: TTTStringList;
   DelimitedHeaderText: String;
   DelimitedColTypesText: String;
   DelimitedColSortText: String;
   i: Integer;
   Line: String;
   procedure CleanUp();
   begin
      FreeAndNil(HeaderList);
      FreeAndNil(XMLHeaderLine);
      FreeAndNil(ColTypeList);
      FreeAndNil(ColSortList);
   end;
begin
   ProcessLog(ltDebug, 'BuildSplitXMLHeaderByAConfigXML', 'Begin Function.');
   XMLHeaderLine:= Nil;
   HeaderList := Nil;
   ColTypeList := Nil;
   ColSortList := Nil;
   Line := '';

   DelimitedHeaderText:= AConfigXML.GetValueAsWideString('/CONFIGDATA/UIPARAMS/SPLITTABLE/RECEIPTTABLEHEADERS');
   DelimitedColTypesText := AConfigXML.GetValueAsWideString('/CONFIGDATA/UIPARAMS/SPLITTABLE/HEADERFIELDCOLTYPES');
   DelimitedColSortText := AConfigXML.GetValueAsWideString('/CONFIGDATA/UIPARAMS/SPLITTABLE/HEADERFIELDCOLSORT');

   HeaderList := GetAStringListFromDelimiterAndDelimitedText(PIPEDELIMITER, DelimitedHeaderText);
   ColTypeList := GetAStringListFromDelimiterAndDelimitedText(COMMADELIMITER, DelimitedColTypesText);
   ColSortList := GetAStringListFromDelimiterAndDelimitedText(COMMADELIMITER, DelimitedColSortText);
   XMLHeaderLine := TStringList.Create();

   XMLHeaderLine.Add('<head>');
   for i:= 0 to HeaderList.Count-1 do begin
      Line := '<column width="*" type="'+ColTypeList[i]+'" sort="'+ColSortList[i]+'">'+HeaderList[i]+'</column>';
      XMLHeaderLine.Append(Line);
   end;
   XMLHeaderLine.Append('</head>');
   Result := Trim(XMLHeaderLine.Text);

   ProcessLog(ltDebug, 'BuildSplitXMLHeaderByAConfigXML', 'XMLHeader = '+Result);// Testing delete later
   ProcessLog(ltDebug, 'BuildSplitXMLHeaderByAConfigXML', 'End Function.');
   CleanUp();
end;

function TCustomerInfoModule.BuildSplitXMLBodyByAConfigAndSplitXML(AConfigXML, SplitXML:TOpenXML; var TotalSplitDetails: Integer):String;
const
   TARGETCHILDNODE = 'SPLITDETAIL';
   PIPEDELIMITER = '|';
var
   XMLBodyLine: TStringList;
   XMLTagList: TTTStringList;
   ColDataTypeList: TTTStringList;
   DelimitedXMLTagText: String;
   DelimitedColDataTypesText: String;
   RowOfTargetXMLNode: String;
   targetXMLNode: String;
   XMLWithData: String;
   I: Integer;
   procedure CleanUp();
   begin
      FreeAndNil(XMLBodyLine);
      FreeAndNil(XMLTagList);
      FreeAndNil(ColDataTypeList);
   end;
begin
   ProcessLog(ltDebug, 'BuildSplitXMLBodyByAConfigAndSplitXML', 'Begin Function.');
   XMLBodyLine:= Nil;
   XMLTagList:= Nil;
   ColDataTypeList := Nil;

   DelimitedXMLTagText := AConfigXML.GetValueAsWideString('/CONFIGDATA/UIPARAMS/SPLITTABLE/SPLITDETAILTAGS');
   DelimitedColDataTypesText := AConfigXML.GetValueAsWideString('/CONFIGDATA/UIPARAMS/SPLITTABLE/COLUMNDATATYPE');

   XMLTagList:= GetAStringListFromDelimiterAndDelimitedText(PIPEDELIMITER, DelimitedXMLTagText);
   ColDataTypeList := GetAStringListFromDelimiterAndDelimitedText(PIPEDELIMITER, DelimitedColDataTypesText);

   XMLBodyLine := TStringList.Create();
   XMLWithData := SplitXML.DocumentAsString();

   I:= 1;
   targetXMLNode := Utility.GetNXMLTag(XMLWithData, TARGETCHILDNODE, I);
   while targetXMLNode <> '' do begin
      RowOfTargetXMLNode:= '<row id="'+IntToStr(I)+'">' +
                           BuildXMLCellsOfTargetXMLNode(targetXMLNode, XMLTagList, ColDataTypeList) +
                           '</row>';
      XMLBodyLine.Append(RowOfTargetXMLNode);
      Inc(I);
      targetXMLNode := Utility.GetNXMLTag(XMLWithData, TARGETCHILDNODE, I);
   end;
   TotalSplitDetails := I-1;
   Result := XMLBodyLine.Text;
   ProcessLog(ltDebug, 'BuildSplitXMLBodyByAConfigAndSplitXML', 'XMLBody = '+Result);
   ProcessLog(ltDebug, 'BuildSplitXMLBodyByAConfigAndSplitXML', 'End Function.');
   CleanUp();
end;

function TCustomerInfoModule.BuildXMLCellsOfTargetXMLNode(targetXMLNode: String; xmlTagList, dataTypeList: TTTStringList):String;
var
   I: Integer;
   CellLines: String;
begin
   CellLines := '';
   for I:= 0 to xmlTagList.Count-1 do begin
      CellLines := CellLines + '<cell>';
      if I < dataTypeList.Count then begin
         CellLines := CellLines + ToUTF(MapDataTypeAndGetXMLTagStr(targetXMLNode, xmlTagList[I], dataTypeList[I]));
      end else begin
         CellLines := CellLines + ToUTF(GetXMLTagStr(targetXMLNode, xmlTagList[I]));
      end;
      CellLines := CellLines + '</cell>';
   end;
   Result := CellLines;
end;


function TCustomerInfoModule.ProcessPortalPaymentEx(RNID, CustGUID: String;InPutXML: TOpenXML; const AQueryFields, AContentFields: TStrings; var AResp: string;JSONResp : boolean): Boolean;
const
   METHOD_NAME = 'TCustomerInfoModule.ProcessPortalPaymentEx(...)';// 2019-5-15 SS DVST-572: helps with logging
var
   PaymentLocationRNID : String;
   Email : String;
   WS : String;
   WS2: String;
   CustIdent : String;
   TranIdent : String;
   StationIdent : String;
   AccountNumber : String;
   ChildGUID : String;
   PaymentRNID :String;
   PaymentHistGuid : String;
   PaymentGUID : String;
   PaymentAmount  :String;
   ReceiptNumber : String;
   TranAMount : String;

   PaymentResponse : String;
   PaymentRequest : String;
   PaymentToken : String;
   PaymentType : String;
   PaymentCardName : string; //2017-01-06 jtm F#1290
   PaymentServiceName : String;
   PaymentsAVS : string;
   XMLResp : TStringList;
   ApprovalCode : String;
   EmailMessage : String;
   NonAuthReason : String;
   GWSystemCode : String;
   TranIdentExpression : String;
   SupressReceipt : Boolean;
   SchedGUID : String;
   IsPlanPayment : Boolean;
   IsOffline : Boolean;
   SchedAmountDue : Currency;
   HTMLTemplate : String;
   HTMLEmail : String;
   OTPCardAcct : String;
   OTPCardExp : String;
   OTPCVV : String;
   OTPTAToken : String; //2017-10-26 ajs: F#2213
   OTPTACardExp : String; //2017-10-26 ajs: F#2213
   OTPTATokenType : String; //2017-10-26 ajs: F#2213
   ReceiptEmail : string;
   BillingZip : string;  //2016-3-28 jtm
   BillingStreet : string;
   OTPAVS : String;
   CardEventParms : string; //2016-8-22 jtm: Feat OT#1053
   EmpIdent : string;
   CustIdentExpression : String; //2016-10-27 jtm: Feat OT# 1228
   PaymentTransactionType : String; //2017-05-24 jtm F#1577
   UserName : string;
   IDTechDecrypt: TIDTechDecrypt;//2017-08-16 jtm: F#2082
   CustomField1 : string; //2017-09-20 jtm: F#2192
   CustomField2 : string;
   CustomField3 : string;
   CustomField4 : string;
   CustomField5 : string;
   CustomField6 : string;
   CustomField7 : string;
   CustomField8 : string;
   CustomField9 : string;
   CustomField10 : string;

   PromptForFraudReversal : boolean; //2018-06-20 bls: F#2076
   FraudAutoReversal : string; //2018-06-20 bls: F#2076
   ReceiptToCustEmail : boolean; //2018-09-12 ajs: DVST-1235
   CustEmail : string; //2018-09-12 ajs: DVST-1235
   RequestPaymentTransactionType : string;
   CCAuthType : string;
   RefererURL : string;
   memberType : string;
   ErrorMessage : string;
   totalAmountDue : boolean;
   currentAmountDue : boolean;
   fixedAmountDue : boolean;

   StationIdentExpression : String; // 2019-2-13 ss DVST-3178
   CardEventParamsXPath: String; //2019-5-15 SS DVST-572
Begin
   Result := False;
   SupressReceipt := False;
   isOffline := False;
   HTMLTemplate := '';
   TranIdent := '';
   StationIdent := 'WEBSITE';
   PromptForFraudReversal := false;
   FraudAutoReversal := '';
   ReceiptToCustEmail := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ALLOWEMAILRECEIPT','FALSE')); //2018-09-12 ajs: DVST-1235

   if SessionVarEval.GetValueAsString('StationIdent') <> '' then
      StationIdent :=  SessionVarEval.GetValueAsString('StationIdent');
   if (CustGUID = 'NONE') or OpenCustomerQueryGUID('',CustGUID) then begin
      ProcessLog(ltInfo,'PROCESS PAYMENT',NumericOnly(AContentFields.Values['School']));

      if (InputXML <> nil) then begin
         SchedGUID := GuidOnly(InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTSCHEDGUID'));
      end else begin
         SchedGUID := GuidOnly(AContentFields.Values['PAYSCHEDGUID']);
         if SchedGUID = '' then begin
            SchedGUID := GuidOnly(AQueryFields.Values['PAYSCHEDGUID']);
         end;
         ProcessLog(ltInfo,'PROCESS PAYMENT',SchedGUID);
      end;

      IsPlanPayment := False;
      if (InputXML <> nil) then begin
         IsPlanPayment := UpCaseString(InputXML.GetValueAsWideString('/TRANSACTION/PLANPAYMENT')) = 'TRUE';
      end;

      if (SchedGUID <> '') then begin
         if LoadSchedGUIDToVars(SchedGUID, RNID, VarEvaluator) then begin
            VarEvaluator.AddValue('PAYMENTSCHEDGUID', SchedGUID);
            PaymentGUID := VarEvaluator.GetValueAsString('CustPaySched.PaymentGUID');//Set this if it exists
            PaymentLocationRNID  := VarEvaluator.GetValueAsString('CustPaySched.RNID');//Set this if it exists
            ProcessLog(ltInfo,'Schedule Guid  found:' + PaymentLocationRNID + ':' + SchedGUID,PaymentLocationRNID);
            ProcessLog(ltInfo,'CusGUID:' + PaymentLocationRNID + ':' + CustGUID,PaymentLocationRNID);
         end else begin
            ProcessLog(ltWarning,'Schedule Guid not found',PaymentLocationRNID);
         end;
      end;

      if (PaymentLocationRNID = '') then begin
         if (InputXML <> nil) then begin
            if (InputXML.GetValueAsWideString('/TRANSACTION/LOCATIONRNID') <> '') then
               PaymentLocationRNID := GuidOnly(InputXML.GetValueAsWideString('/TRANSACTION/LOCATIONRNID'));
         end else begin
            PaymentLocationRNID := NumericOnly(AContentFields.Values['PaymentLocation']);
            if (PaymentLocationRNID = '') then begin
               PaymentLocationRNID := NumericOnly(AContentFields.Values['School']);
            end;
         end;
      end;

      if (VarEvaluator.GetValueAsString('CustPaySched.RNID') <> '') then begin  //If a custpaysched has been passed in we need to use this
         PaymentLocationRNID := VarEvaluator.GetValueAsString('CustPaySched.RNID');
      end;
      if (PaymentLocationRNID = '') and (SessionVarEval.GetValueAsString('PaymentLocationRNID') <> '') then begin   //2017-07-19 jtm: F#1820
          PaymentLocationRNID := SessionVarEval.GetValueAsString('PaymentLocationRNID');
      end;
      if (PaymentLocationRNID = '') then begin //If this is blank, we're not doing it on behalf of a specific location, use site RNID
         PaymentLocationRNID := RNID; //default to this site
      end else begin
         if Not ValidateRNID(PaymentLocationRNID) then begin
            ProcessLog(ltWarning,'Attempt to Process Payment For Invalid Location RNID',NumericOnly(AContentFields.Values['School']));
            if JSONResp then begin
               AResp := 'Invalid Location RNID';
            end else begin
               AResp := '<head><title>Make a Payment</title><meta http-equiv="refresh" content="0;URL=/PP"></head>';
            end;
            exit;
         end;
         OpenCustomerQueryGUID('',CustGUID); // we have to do this again because validaternid closed our query
      end;

      VarEvaluator.AddDSCurrentRecord(RNQuery, 'Customers');
      ProcessLog(ltInfo,'PROCESS PAYMENT',PaymentLocationRNID);

      if (inputXML = nil) then begin
         PaymentGUID := GuidOnly(AContentFields.Values['payment']);  //First assign it to the form field
         if (AContentFields.Values['payment'] = 'CASH') then begin
            PaymentGUID := 'CASH';
            IsOffline := True;
         end;
         if AContentFields.Values['payment'] = 'CHECK' then begin
            PaymentGUID := 'CHECK';
            IsOffline := True;
         end;
         If AContentFields.Values['payment'] = 'CARD' then begin
            PaymentGUID := 'CARD';
            IsOffline := True;
         end;
         If AContentFields.Values['payment'] = 'REFUND' then begin
            PaymentGUID := 'REFUND';
            IsOffline := True;
         end;
      end;
      If (InputXML <> Nil) and (Trim(InputXML.GetValueAsWideString('/TRANSACTION/TRANIDENT')) <> '') then  //2017-08-16 jtm: F#2071
         TranIdent := Trim(InputXML.GetValueAsWideString('/TRANSACTION/TRANIDENT'));
      If (InputXML <> Nil) and (Trim(InputXML.GetValueAsWideString('/TRANSACTION/CUSTIDENT')) <> '') then  //2017-08-16 jtm: F#2071
         CustIdent := Trim(InputXML.GetValueAsWideString('/TRANSACTION/CUSTIDENT'));

      If (SchedGUID <> '') and (PaymentGuid = '')  then
         PaymentGuid := VarEvaluator.GetValueAsString('CustPaySched.PaymentGUID'); //If there is a scheduled payment that has a payment GUID assigned, use that

      If (InputXML <> Nil) and (Trim(InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTGUID')) <> '') then begin
         PaymentGUID := GuidOnly(InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTGUID')); //If we're processing XML, assign it that way
         If InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTGUID') = 'CASH' then begin
           PaymentGUID := 'CASH';
           IsOffline := True;
         end;
         If InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTGUID') = 'CHECK' then begin
           PaymentGUID := 'CHECK';
           IsOffline := True;
         end;
         If InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTGUID') = 'CARD' then begin
           PaymentGUID := 'CARD';
           IsOffline := True;
         end;
         If InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTGUID') = 'REFUND' then begin
           PaymentGUID := 'REFUND';
           IsOffline := True;
         end;
      end;

      if (PaymentGUID = '') and (NumericOnly(AContentFields.Values['retypeNumber']) <> '') then begin
         OTPCardAcct := NumericOnly(AContentFields.Values['retypeNumber']);
         OTPCardExp := FormatDateTime('MM/YY', ValidateExp(NumericOnly(AContentFields.Values['expMonth']) +'/' +  NumericOnly(AContentFields.Values['expYear']), true));
         OTPCVV := NumericOnly(AContentFields.Values['cvv']);
         PaymentGUID := 'CARD KEYED';
         PaymentServiceName := 'CARD';
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/SHOWSERVICENAME','FALSE') = 'TRUE') and (ValidCharsOnly(AContentFields.Values['VTCardServiceName'],True,True,'-') <> '')  //2017-05-24 jtm F#1568
            and (UpperCase(ValidCharsOnly(AContentFields.Values['VTCardServiceName'],True,True,'-')) <> 'ALL')  then begin
            PaymentServiceName := ValidCharsOnly(AContentFields.Values['VTCardServiceName'],True,True,'-');
            ProcessLog(ltInfo,'VTCardServiceName:',PaymentServiceName);
         end;

         Tranident := ValidCharsOnly(AContentFields.Values['TranIdent'],True,True,'.-_:/& ');  //2017-05-10 jtm D#1605
         Custident := ValidCharsOnly(AContentFields.Values['CustIdent'],True,True,'.-_:/& ');  //2017-05-10 jtm D#1605
         BillingZip := ValidCharsOnly(AContentFields.Values['billingZip'],False,True,'');   //2016-3-28 jtm
         BillingStreet := ValidCharsOnly(AContentFields.Values['billingStreet'],True,True,'');
         if (Length(BillingZip) >= 5) and (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ZIPREQUIRED','FALSE')='TRUE') then begin
            if BillingStreet = '' then begin
                if (Length(BillingZip) = 5) or (Length(BillingZip) = 9) then OTPAVS := BillingZip;
            end else begin
               if Length(BillingStreet) > 20 then BillingStreet := Copy(BillingStreet,0,20);
               if Length(BillingZip) = 5  then begin
                  OTPAVS := BillingZip + '0000' + BillingStreet;
               end else if Length(BillingZip) = 9 then begin
                  OTPAVS := BillingZip + BillingStreet;
               end;
            end;
            if Length(OTPAVS) > 29 then OTPAVS := Copy(OTPAVS,0,29);
         end else begin
            OTPAVS := '';
         end;
      end;

      if (PaymentGUID = '') and (NumericOnly(VarEvaluator.GetValueAsString('OTPCARDACCT')) <> '') then begin
         OTPCardAcct := NumericOnly(VarEvaluator.GetValueAsString('OTPCARDACCT'));
         OTPCardExp := FormatDateTime('MM/YY', ValidateExp(NumericOnly(VarEvaluator.GetValueAsString('OTPEXPMONTH')) +'/' +  NumericOnly(VarEvaluator.GetValueAsString('OTPEXPYEAR')), true));
         OTPCVV := NumericOnly(VarEvaluator.GetValueAsString('OTPCVV'));
         PaymentGUID := 'CARD KEYED';
         PaymentServiceName := 'CARD';
         If VarEvaluator.GetValueAsString('PAYMENTSERVICENAME') = '' then
            PaymentServiceName := 'CARD';
         Tranident := ValidCharsOnly(VarEvaluator.GetValueAsString('TRANIDENT'),True,True,'.-_:/& '); //2017-05-10 jtm D#1605
         Custident := ValidCharsOnly(VarEvaluator.GetValueAsString('CUSTIDENT'),True,True,'.-_:/& '); //2017-05-10 jtm D#1605
         BillingZip := ValidCharsOnly(VarEvaluator.GetValueAsString('OTPZIP'),False,True,'');   ////2017-08-02 jtm: F#2035
         BillingStreet := ValidCharsOnly(VarEvaluator.GetValueAsString('OTPBillingStreet'),True,True,'');
         if (Length(BillingZip) >= 5) then begin
            if BillingStreet = '' then begin
                if (Length(BillingZip) = 5) or (Length(BillingZip) = 9) then OTPAVS := BillingZip;
            end else begin
               if Length(BillingStreet) > 20 then BillingStreet := Copy(BillingStreet,0,20);
               if Length(BillingZip) = 5  then begin
                  OTPAVS := BillingZip + '0000' + BillingStreet;
               end else if Length(BillingZip) = 9 then begin
                  OTPAVS := BillingZip + BillingStreet;
               end;
            end;
            if Length(OTPAVS) > 29 then OTPAVS := Copy(OTPAVS,0,29);
         end else begin
            OTPAVS := '';
         end;
      end;

      CardEventParms := Trim(AContentFields.Values['CARDEVENTPARAMS']); //2016-8-22 jtm: Feat OT#1053
      if (PaymentGUID = '') and (CardEventParms <> '') then begin
         PaymentGUID := 'CARD KEYED';
         PaymentServiceName := 'CARD';
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/SHOWSERVICENAME','FALSE') = 'TRUE') and (ValidCharsOnly(AContentFields.Values['VTCardServiceName'],True,True,'-') <> '')  //2017-05-24 jtm F#1568
            and (UpperCase(ValidCharsOnly(AContentFields.Values['VTCardServiceName'],True,True,'-')) <> 'ALL')  then begin
            PaymentServiceName := ValidCharsOnly(AContentFields.Values['VTCardServiceName'],True,True,'-');
            ProcessLog(ltInfo,'VTCardServiceName:',PaymentServiceName);
         end;
         Tranident := ValidCharsOnly(AContentFields.Values['TranIdent'],True,True,'.-_:/& '); //2017-05-10 jtm D#1605
         Custident := ValidCharsOnly(AContentFields.Values['CustIdent'],True,True,'.-_:/& '); //2017-05-10 jtm D#1605
         BillingZip := ValidCharsOnly(AContentFields.Values['billingZip'],False,True,'');
         BillingStreet := ValidCharsOnly(AContentFields.Values['billingStreet'],True,True,'');
         if (Length(BillingZip) >= 5) and (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ZIPREQUIRED','FALSE')='TRUE') then begin
            if BillingStreet = '' then begin
                if (Length(BillingZip) = 5) or (Length(BillingZip) = 9) then OTPAVS := BillingZip;
            end else begin
               if Length(BillingStreet) > 20 then BillingStreet := Copy(BillingStreet,0,20);
               if Length(BillingZip) = 5  then begin
                  OTPAVS := BillingZip + '0000' + BillingStreet;
               end else if Length(BillingZip) = 9 then begin
                  OTPAVS := BillingZip + BillingStreet;
               end;
            end;
            if Length(OTPAVS) > 29 then OTPAVS := Copy(OTPAVS,0,29);
         end else begin
            OTPAVS := '';
         end;
      end;

      if (PaymentGUID = '') and (NumericOnly(AContentFields.Values['VTTokenNumber']) <> '') then begin  //2017-10-26 ajs: F#2213
         OTPTAToken := NumericOnly(AContentFields.Values['VTTokenNumber']);
         OTPTACardExp := FormatDateTime('MM/YY', ValidateExp(NumericOnly(AContentFields.Values['expMonth']) +'/' +  NumericOnly(AContentFields.Values['expYear']), true));
         OTPTATokenType := NumericOnly(AContentFields.Values['providerID']);
         PaymentGUID := 'CARD KEYED';
         PaymentServiceName := 'CARD';
         if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/SHOWSERVICENAME','FALSE') = 'TRUE') and (ValidCharsOnly(AContentFields.Values['VTCardServiceName'],True,True,'-') <> '')  //2017-05-24 jtm F#1568
            and (UpperCase(ValidCharsOnly(AContentFields.Values['VTCardServiceName'],True,True,'-')) <> 'ALL')  then begin
            PaymentServiceName := ValidCharsOnly(AContentFields.Values['VTCardServiceName'],True,True,'-');
            ProcessLog(ltInfo,'VTCardServiceName:',PaymentServiceName);
         end;

         Tranident := ValidCharsOnly(AContentFields.Values['TranIdent'],True,True,'.-_:/& ');  //2017-05-10 jtm D#1605
         Custident := ValidCharsOnly(AContentFields.Values['CustIdent'],True,True,'.-_:/& ');  //2017-05-10 jtm D#1605
         BillingZip := ValidCharsOnly(AContentFields.Values['billingZip'],False,True,'');   //2016-3-28 jtm
         BillingStreet := ValidCharsOnly(AContentFields.Values['billingStreet'],True,True,'');
         if (Length(BillingZip) >= 5) and (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ZIPREQUIRED','FALSE')='TRUE') then begin
            if BillingStreet = '' then begin
                if (Length(BillingZip) = 5) or (Length(BillingZip) = 9) then OTPAVS := BillingZip;
            end else begin
               if Length(BillingStreet) > 20 then BillingStreet := Copy(BillingStreet,0,20);
               if Length(BillingZip) = 5  then begin
                  OTPAVS := BillingZip + '0000' + BillingStreet;
               end else if Length(BillingZip) = 9 then begin
                  OTPAVS := BillingZip + BillingStreet;
               end;
            end;
            if Length(OTPAVS) > 29 then OTPAVS := Copy(OTPAVS,0,29);
         end else begin
            OTPAVS := '';
         end;
      end;

      If PaymentGUID = '' then begin
         ProcessLog(ltWarning,'Attempt to Process Payment For Blank Payment GUID',NumericOnly(AContentFields.Values['School']));
         if JSONResp then begin
            AResp := 'Blank Payment GUID';
         end else begin
            AResp := '<head><title>Make a Payment</title><meta http-equiv="refresh" content="0;URL=/PP?PAGE=MAKEPAYMENT"></head>';
         end;
         exit;
      end;

      if (RNQuery.FindField('Email') <> nil) then begin
         Email := Trim(RNQuery.FieldByName('Email').AsString);
      end;
      EMail := ValidCharsOnly(Email,True,True,'_.-#@+/');
      SessionVarEval.AddValue('CUSTOMEREMAIL', Email); //2018-06-20 bls: F#2076
      WS := LoadWebFileFromFolder('payment_confirmation.htm','');
      if (ReceiptToCustEmail AND (AContentFields.Values['CustEmail'] <> '')) then begin
         CustEmail := '';
         CustEmail := Trim(AContentFields.Values['CustEmail']);
         CustEmail := ValidCharsOnly(CustEmail,True,True,'_.-#@+/');
         SessionVarEval.AddValue('CUSTRECEIPTEMAIL', CustEmail);
      end;

      If CustIdent = '' then begin
         if (RNQuery.FindField('FirstName') <> nil) then begin
            CustIdent := Trim(RNQuery.FieldByName('FirstName').AsString);
         end;
         if (RNQuery.FindField('LastName') <> nil) then begin
            CustIdent := CustIdent + ' ' +Trim(RNQuery.FieldByName('LastName').AsString);
         end;
         if (RNQuery.FindField('employer') <> nil) then begin
            If Trim(RNQuery.FieldByName('employer').AsString) <> '' then begin
             CustIdent := CustIdent + '/' +Trim(RNQuery.FieldByName('employer').AsString);
            end;
         end;
      end;
      if (RNQuery.FindField('AccountNumber') <> nil) then begin
         AccountNumber := Trim(RNQuery.FieldByName('AccountNumber').AsString);
      end;
         WS2 := ValidCharsOnly(AContentFields.Values['custname'],true,true,'/. ');
         If WS2 <> '' then begin
            WS2 := '/' + WS2;
         end;

         ChildGUID := GuidOnly(AContentFields.Values['nameandacct']);
         If (InputXML <> Nil) and (Trim(InputXML.GetValueAsWideString('/TRANSACTION/CHILDGUID')) <> '') then
            ChildGUID := InputXML.GetValueAsWideString('/TRANSACTION/CHILDGUID'); //If we're processing XML, assign it that way
         If (SchedGUID <> '')  and (VarEvaluator.GetValueAsString('CustPaySched.ChildGUID') <> '' ) then
            ChildGUID := GuidOnly(VarEvaluator.GetValueAsString('CustPaySched.ChildGUID')); //If there is a scheduled payment that has a Child GUID assigned, use that

         If ChildGUID <> '' then begin
            RNQuery.Close;
            RNQuery.SQL.Clear;
            RNQuery.SQL.Add('select * from CustChild');
            RNQuery.SQL.Add('where (ChildGUID = '''+ChildGUID + ''')');
            RNQuery.SQL.Add('And (CustGUID = '''+CustGUID + ''')');
            RNQuery.Open;
            If RnQuery.RecordCount = 0 then begin
               ProcessLog(ltWarning,'Attempt to process payment with invalid child guid ' + ChildGUID + '/' + CustGUID,NumericOnly(AContentFields.Values['School']));
            end else begin
               VarEvaluator.AddDSCurrentRecord(RNQuery, 'CustChild');
               if VarEvaluator.GetValueAsString('CustPaySched.RNID') = '' then //The schedule RNID takes precidence over the child if it exists
                  PaymentLocationRNID := Trim(RNquery.FieldByName('RNID').AsString);
               If (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINADDSCHEDULE/ALLOWTRANIDENT','FALSE')='TRUE') then begin //2018-02-13 ajs: Feat OT#3756
                  TranIdent := VarEvaluator.GetValueAsString('CustPaySched.Custom1');
               end else begin
                  TranIdent := Trim(RNquery.FieldByName('AccountNumber').AsString);
                  If TranIdent <> '' then
                     TranIdent := TranIdent + '/';
                  TranIdent := TranIdent + Trim(RNquery.FieldByName('LastName').AsString) + ' ' + Trim(RNquery.FieldByName('FirstName').AsString);
               end;
               If (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINADDSCHEDULE/ALLOWCUSTIDENT','FALSE')='TRUE') then begin //2018-05-16 ajs: D#4048
                  CustIdent := VarEvaluator.GetValueAsString('CustPaySched.Custom2');
                  ProcessLog(ltDebug,'ADMINADDSCHEDULE/ALLOWCUSTIDENT Custident',CustIdent);
               end;
               if (strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/SCHEDPAY/EXTERNALINTEGRATION','FALSE')) and (VarEvaluator.GetValueAsString('PAYMENTSCHEDGUID')<> '') and (VarEvaluator.GetValueAsString('CustPaySched.Custom3') = '') and (VarEvaluator.GetValueAsString('CustPaySched.ExternalIntegration') <> '')) or
                  ((OpenXMLGetTag('/CONFIGDATA/EXTERNALINTEGRATION/HE') <>'') and (VarEvaluator.GetValueAsString('Customers.CUSTOMERCODE') <> '')) then begin
                  PaymentAmount := '0';
                  memberType := VarEvaluator.GetValueAsString('Customers.MEMBSTATUS');
                  VarEvaluator.AddValue('memberType',memberType);

                  fixedAmountDue := strtobool(ValidCharsOnly(AContentFields.Values['fixedAmountDue'],true,true,''));
                     totalAmountDue := strtobool(ValidCharsOnly(AContentFields.Values['totalAmountDue'],true,true,''));
                     currentAmountDue := strtobool(ValidCharsOnly(AContentFields.Values['currentAmountDue'],true,true,''));

                  if (VarEvaluator.GetValueAsString('CustPaySched.Custom4') <> '') then begin
                     ProcessLog(ltInfo,'ProcessPortalPaymentEx CustPaySched.Custom4',VarEvaluator.GetValueAsString('CustPaySched.Custom4'));
                     if (VarEvaluator.GetValueAsString('CustPaySched.Custom4') = 'fixedAmountDue') then begin
                        fixedAmountDue := true;
                         totalAmountDue := false;
                        currentAmountDue := false;
                     end else if (VarEvaluator.GetValueAsString('CustPaySched.Custom4') = 'totalAmountDue') then begin
                        fixedAmountDue := false;
                        totalAmountDue := true;
                        currentAmountDue := false;
                     end else if (VarEvaluator.GetValueAsString('CustPaySched.Custom4') = 'currentAmountDue') then begin
                        fixedAmountDue := false;
                        totalAmountDue := false;
                         currentAmountDue := true;
                     end;
                  end;

                  if fixedAmountDue then begin
                     PaymentAmount := ValidCharsOnly(AContentFields.Values['fixedamount'],False,True,'.'); //if it's a schedule then this will be empty and we'll pick up the amount later on
                     ProcessLog(ltInfo,'ProcessPortalPaymentEx using fixedAmount',PaymentAmount);
                  end else begin

                     if (memberType = 'Member') or (memberType = 'Guest') or (memberType = 'Employer') then begin
                        ErrorMessage :='';
                        if (VarEvaluator.GetValueAsString('CustPaySched.ExternalIntegration') <> '') then begin
                           VarEvaluator.AddValue('subscriptionId',VarEvaluator.GetValueAsString('CustPaySched.ExternalIntegration'));
                        end else begin
                           VarEvaluator.AddValue('subscriptionId',RNQuery.FieldByName('ExternalIntegration').AsString);
                        end;
                        if (memberType = 'Member') or (memberType = 'Guest') then begin
                           SessionVarEval.AddValue('MemberHCCID',RNQuery.FieldByName('AccountNumber').AsString);
                           VarEvaluator.AddValue('MemberHCCID',RNQuery.FieldByName('AccountNumber').AsString);
                        end else if (memberType = 'Employer') then begin
                           SessionVarEval.AddValue('EmployerAccountID',RNQuery.FieldByName('AccountNumber').AsString);
                           SessionVarEval.AddValue('TaxID',RNQuery.FieldByName('ExternalCustIdent').AsString);
                           VarEvaluator.AddValue('EmployerAccountID',RNQuery.FieldByName('AccountNumber').AsString);
                           VarEvaluator.AddValue('TaxID',RNQuery.FieldByName('ExternalCustIdent').AsString);
                        end;
                        if ValidateHEUser(memberType,ErrorMessage) then begin
                           ProcessLog(ltInfo,'ProcessPortalPaymentEx ValidateHEUser','success');
                              if HEGetBills(ErrorMessage) then begin
                                 if totalAmountDue then begin
                                    PaymentAmount := ValidCharsOnly(GetXMLTagStr(VarEvaluator.GetValueAsString('billXML'),'totalAmountDue'),false,true,'().');
                                    ErrorMessage := '';
                                 end else if currentAmountDue then begin
                                    PaymentAmount := ValidCharsOnly(GetXMLTagStr(VarEvaluator.GetValueAsString('billXML'),'currentAmountDue'),false,true,'().');
                                    ErrorMessage := '';
                                 end;
                                 if (Pos('(',PaymentAmount)>0) then begin
                                    ProcessLog(ltInfo,'ProcessPortalPaymentEx PaymentAmount is negative',PaymentAmount);
                                    PaymentAmount := '-1';  //set the payment amount to negative so it fails later
                                 end;
                                 ProcessLog(ltInfo,'ProcessPortalPaymentEx HEGetBills success; PaymentAmount',PaymentAmount);
                                 ErrorMessage := '';
                              end else begin
                                 ErrorMessage := 'Bill Failed to load';
                              end;
                           end;
                        try
                           if (ErrorMessage <> '') or (StrToCurr(PaymentAmount) <= 0) then begin
                           ProcessLog(ltWarning,'Failed Process Payment For External Integration',ErrorMessage);
                           if JSONResp then begin
                              AResp := 'Failed Process Payment For External Integration';
                           end else begin
                              AResp := '<head><title>Make a Payment</title><meta http-equiv="refresh" content="0;URL=/PP?PAGE=MAKEPAYMENT"></head>';
                           end;
                           exit;
                        end;
                        except
                            on e:exception do begin
                              ProcessLog(ltWarning,'Failed Process Payment For External Integration',ErrorMessage);
                              ProcessLog(ltWarning,'Exception converting Payment Amount to currency',e.message);
                              if JSONResp then begin
                                 AResp := 'Failed Process Payment For External Integration';
                              end else begin
                                 AResp := '<head><title>Make a Payment</title><meta http-equiv="refresh" content="0;URL=/PP?PAGE=MAKEPAYMENT"></head>';
                     end;
                              exit;
                  end;
               end;
                        try
                           if (StrToCurr(PaymentAmount) > 8000) then begin  //if payment amount greater than 8k, check the payment method to make sure it's not a check
                              RNQuery.Close;
                              RNQuery.SQL.Clear;
                              RNQuery.SQL.Add('select * from custpayment where PaymentGUID =''' + PaymentGUID +'''');
                              RNQuery.Open;
                              if RNQuery.RecordCount > 0 then begin
                                  if (trim(RNQuery.FieldByName('PAYMENTTYPE').AsString) = 'CHECK') then begin
                                    PaymentAmount := '8000';
            end;
                              end;
                           end;
                        except
                           on e:exception do begin
                              ProcessLog(ltWarning,'Failed Process Payment For External Integration',ErrorMessage);
                              ProcessLog(ltWarning,'Exception converting Payment Amount to currency',e.message);
                              Response.Content := '<head><title>Make a Payment</title><meta http-equiv="refresh" content="0;URL=/PP?PAGE=MAKEPAYMENT"></head>';
                              exit;
                           end;
                        end;
                     end;
                  end;
               end;
            end;
            RNQuery.Close;
         end;

         PaymentRNID := RNID;
         if GetConfigString('GATEWAYRNID','') = 'LOCATION' then begin //This is to bill to the location of the multi-tennant
            PaymentRNID := PaymentLocationRNID;
            ProcessLog(ltInfo,'Location Payment',PaymentRNID);
         end;
         ProcessLog(ltInfo,'PaymentLocationRNID:' + PaymentLocationRNID,PaymentRNID);

         If OpenXMLGetTag('/CONFIGDATA/GATEWAYRNIDOVERRIDES/GATEWAYRNID[@RNID=''' + PaymentLocationRNID + ''']') <> '' then begin
            PaymentRNID := OpenXMLGetTag('/CONFIGDATA/GATEWAYRNIDOVERRIDES/GATEWAYRNID[@RNID=''' + PaymentLocationRNID + ''']');
            ProcessLog(ltInfo,'Gateway RNID Override:' + PaymentRNID + '/' + PaymentLocationRNID,PaymentRNID);
         end;
         If (OpenXMLGetTag('/CONFIGDATA/STORECUSTOMFIELDS','FALSE') = 'TRUE') then begin //2017-09-20 jtm: F#2192
            if (SchedGUID = '') then begin
               CustomField1 := ValidCharsOnly(AContentFields.Values['Custom1'],true,true,'/.-&(),:+=_ ');
               CustomField2 := ValidCharsOnly(AContentFields.Values['Custom2'],true,true,'/.-&(),:+=_ ');
               CustomField3 := ValidCharsOnly(AContentFields.Values['Custom3'],true,true,'/.-&(),:+=_ ');
               CustomField4 := ValidCharsOnly(AContentFields.Values['Custom4'],true,true,'/.-&(),:+=_ ');
               CustomField5 := ValidCharsOnly(AContentFields.Values['Custom5'],true,true,'/.-&(),:+=_ ');
               CustomField6 := ValidCharsOnly(AContentFields.Values['Custom6'],true,true,'/.-&(),:+=_ ');
               CustomField7 := ValidCharsOnly(AContentFields.Values['Custom7'],true,true,'/.-&(),:+=_ ');
               CustomField8 := ValidCharsOnly(AContentFields.Values['Custom8'],true,true,'/.-&(),:+=_ ');
               CustomField9 := ValidCharsOnly(AContentFields.Values['Custom9'],true,true,'/.-&(),:+=_ ');
               CustomField10 := ValidCharsOnly(AContentFields.Values['Custom10'],true,true,'/.-&(),:+=_ ');
               if Length(CustomField1) > 200 then CustomField1 := Copy(CustomField1,0,200);
               if Length(CustomField2) > 200 then CustomField2 := Copy(CustomField2,0,200);
               if Length(CustomField3) > 200 then CustomField3 := Copy(CustomField3,0,200);
               if Length(CustomField4) > 200 then CustomField4 := Copy(CustomField4,0,200);
               if Length(CustomField5) > 200 then CustomField5 := Copy(CustomField5,0,200);
               if Length(CustomField6) > 200 then CustomField6 := Copy(CustomField6,0,200);
               if Length(CustomField7) > 200 then CustomField7 := Copy(CustomField7,0,200);
               if Length(CustomField8) > 200 then CustomField8 := Copy(CustomField8,0,200);
            end else begin
               CustomField1 := VarEvaluator.GetValueAsString('CustPaySched.Custom1');
               CustomField2 := VarEvaluator.GetValueAsString('CustPaySched.Custom2');
               CustomField3 := VarEvaluator.GetValueAsString('CustPaySched.Custom3');
               CustomField4 := VarEvaluator.GetValueAsString('CustPaySched.Custom4');
               CustomField5 := VarEvaluator.GetValueAsString('CustPaySched.Custom5');
               CustomField6 := VarEvaluator.GetValueAsString('CustPaySched.Custom6');
               CustomField7 := VarEvaluator.GetValueAsString('CustPaySched.Custom7');
               CustomField8 := VarEvaluator.GetValueAsString('CustPaySched.Custom8');
               CustomField9 := VarEvaluator.GetValueAsString('CustPaySched.Custom9');
               CustomField10 := VarEvaluator.GetValueAsString('CustPaySched.Custom10');
            end;
            VarEvaluator.AddValue('CustomField1',CustomField1);
            VarEvaluator.AddValue('CustomField2',CustomField2);
            VarEvaluator.AddValue('CustomField3',CustomField3);
            VarEvaluator.AddValue('CustomField4',CustomField4);
            VarEvaluator.AddValue('CustomField5',CustomField5);
            VarEvaluator.AddValue('CustomField6',CustomField6);
            VarEvaluator.AddValue('CustomField7',CustomField7);
            VarEvaluator.AddValue('CustomField8',CustomField8);
            VarEvaluator.AddValue('CustomField9',CustomField9);
            VarEvaluator.AddValue('CustomField10',CustomField10);
         end;
         if (ValidCharsOnly(AContentFields.Values['RefererURL'],true,true,'/.-&(),:+=_ ') <> '') then begin
            RefererURL := ExtractDomain(ValidCharsOnly(AContentFields.Values['RefererURL'],true,true,'/.-&(),:+=_ ')); //2018-12-19 jtm: DVST-126
         end;
         if RefererURL = '' then begin
            RefererURL := DomainHostname;
         end;
         LoadRNIDToVars(PaymentLocationRNID,VarEvaluator);
         VarEvaluator.AddValue('PaymentLocationRNID',PaymentLocationRNID);

         PaymentHistGuid := GenerateGUID;
         VarEvaluator.AddValue('PAYMENTGUID', PaymentHistGuid);

         RNQuery.Close;
         RNQuery.SQL.Clear;
         RNQuery.SQL.Add('select * from CustPaymentHistory');
         RNQuery.SQL.Add('where (PayHistGUID = '''+PaymentHistGUID + ''')');
         RNQuery.Open;
         RNQuery.Insert;
         RNQuery.FieldByName('SiteRNID').AsString := RNID;
         RNQuery.FieldByName('ChildGUID').AsString := ChildGUID;
         RNQuery.FieldByName('RNID').AsString := PaymentLocationRNID;
         RNQuery.FieldByName('CustGUID').AsString := CustGUID;
         RNQuery.FieldByName('PAYHISTGUID').AsString := PaymentHistGuid;
         RNQuery.FieldByName('PaySchedGUID').AsString := SchedGUID;
         RNQuery.FieldByName('PAYMENTGUID').AsString := PaymentGUID; //Request.ContentFields.Values['payment'];
         RNQuery.FieldByName('PaymentDate').AsDateTime := NOW;
         If (OpenXMLGetTag('/CONFIGDATA/STORECUSTOMFIELDS','FALSE') = 'TRUE') then begin //2017-09-20 jtm: F#2192
            RNQuery.FieldByName('Custom1').AsString := CustomField1;
            RNQuery.FieldByName('Custom2').AsString := CustomField2;
            RNQuery.FieldByName('Custom3').AsString := CustomField3;
            RNQuery.FieldByName('Custom4').AsString := CustomField4;
            RNQuery.FieldByName('Custom5').AsString := CustomField5;
            RNQuery.FieldByName('Custom6').AsString := CustomField6;
            RNQuery.FieldByName('Custom7').AsString := CustomField7;
            RNQuery.FieldByName('Custom8').AsString := CustomField8;
            RNQuery.FieldByName('Custom9').AsString := CustomField9;
            RNQuery.FieldByName('Custom10').AsString := CustomField10;
         end;
         RNQuery.FieldByName('RefererURL').AsString := RefererURL;
         If Trim(PaymentAmount) = '' then PaymentAmount := ValidCharsOnly(AContentFields.Values['otamount'],False,True,'.');
         If Trim(PaymentAmount) = '' then PaymentAmount := ValidCharsOnly(AContentFields.Values['amount'],False,True,'.');

         If Trim(PaymentAmount) = '' then PaymentAmount := ValidCharsOnly(VarEvaluator.GetValueAsString('PAYMENTAMOUNT'),False,True,'.');

         If (InputXML <> Nil) then begin
            if strtobool(OpenXMLGetTag('/CONFIGDATA/APIPARAMS/CHECKPAYMENTAMOUNT','FALSE')) then begin
               if (ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTAMOUNT'),False,True,'.') <> '') then begin
                  PaymentAmount := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTAMOUNT'),False,True,'.');
               end;
            end else begin
            PaymentAmount := ValidCharsOnly(InputXML.GetValueAsWideString('/TRANSACTION/PAYMENTAMOUNT'),False,True,'.'); //If we're processing XML, assign it that way
            end;
         end;
         If PaymentAmount = '' then begin
            PaymentAmount := VarEvaluator.GetValueAsString('CustPaySched.PaymentAmount');
         end;

         ProcessLog(ltInfo,VarEvaluator.GetValueAsString('CustPaySched.GrossAmount') + '/' +
                       VarEvaluator.GetValueAsString('CustPaySched.AmountPaid') + '/' +
                       VarEvaluator.GetValueAsString('CustPaySched.GrossAmount') + '/' ,NumericOnly(AContentFields.Values['School']));
         If VarEvaluator.GetValueAsCurrency('CustPaySched.GrossAmount') > 0 then begin
            SchedAmountDue := VarEvaluator.GetValueAsCurrency('CustPaySched.GrossAmount') -
                              VarEvaluator.GetValueAsCurrency('CustPaySched.AmountPaid');
            If (SchedAmountDue < ValuReal(PaymentAmount)) and (NOT IsOffline) then begin
               PaymentAmount := Trim(StriReal(SchedAmountDue,2));
            end;


         end;


         If (PaymentGUID = 'REFUND') then begin
            PaymentAmount := Trim(StriReal(0-(ABS(ValuReal(PaymentAMount))),2));
         end;



         RNQuery.FieldByName('PaymentAmount').AsString := PaymentAmount;
         RNQuery.FieldByName('SplitDetails').AsString := AContentFields.Values['split'];
         If (InputXML <> Nil) then
            RNQuery.FieldByName('SplitDetails').AsString := InputXML.GetValueAsWideString('/TRANSACTION/SPLIT');

         RNQuery.Post;
         VarEvaluator.AddDSCurrentRecord(RNQuery, 'CustPaymentHistory');
         VarEvaluator.AddValue('PaymentAmount', PaymentAmount);

         ReceiptNumber := Trim(PaymentLocationRNID) + '-' +
                         RNQuery.FieldByName('SystemCode').AsString + '-' +
                         FormatDateTime('YYMMDD',date);

         VarEvaluator.AddValue('ReceiptNumber', ReceiptNumber);  //make this available for custom receipt email
         VarEvaluator.AddValue('InputTranIdent',ValidCharsOnly(AContentFields.Values['TranIdent'],True,True,'.-_:/& '));  //2017-12-20 jtm D#3416

         If TranIdent <> '' then begin
         end else if GetConfigString('TRANIDENTTYPE','STD') = 'STD' then begin
            TranIdent := ReceiptNumber;
         end else if (GetConfigString('TRANIDENTTYPE','') = 'OTP') and (ValidCharsOnly(AContentFields.Values['TranIdent'],True,True,'.-_:/& ') <> '') then begin  //2017-05-10 jtm D#1605
            TranIdent := ValidCharsOnly(AContentFields.Values['TranIdent'],True,True,'.-_:/& ');  //2017-05-10 jtm D#1605
         end else begin
            TranIdent := AccountNumber + '/' + ValidCharsOnly(AContentFields.Values['invoice'],true,true,'.-_:/& '); //2017-05-10 jtm D#1605
            If ValidCharsOnly(AContentFields.Values['dob'],false,true,'/.-') <> '' then
               TranIdent :=  '(' + ValidCharsOnly(AContentFields.Values['dob'],false,true,'/.-') + ')' + TranIdent;
         end;
         TranAmount := '$' + Trim(StriReal(RNQuery.FieldByName('PaymentAmount').AsFloat,2));

         ProcessLog(ltInfo,'PROCESS PAYMENT CustPaymentHistory inserted',NumericOnly(AContentFields.Values['School']));

         If (PaymentGUID = 'CASH') or
            (PaymentGUID = 'CHECK') or
            (PaymentGUID = 'CARD') or
            (PaymentGUID = 'REFUND')  then begin
            GWSystemCode := '99999';
            PaymentResponse := 'Offline OK';
            ApprovalCode := 'OFFLINE';
            PaymentType := 'OFFLINE';
            PaymentToken := 'OFFLINE';
            SupressReceipt := True;
            Result := True;
         end else if (PaymentGUID = 'CARD KEYED') then begin
            PaymentType := 'CARD';
         end else begin
            RNQuery.Close;
            RNQuery.SQL.Clear;
            RNQuery.SQL.Add('select * from custpayment where PaymentGUID =''' + PaymentGUID +'''');
            RNQuery.Open;

            ProcessLog(ltInfo,'PROCESS PAYMENT custpayment open',NumericOnly(AContentFields.Values['School']));

            If RNQuery.RecordCount = 0 then begin
               ProcessLog(ltWarning,'Attempt to Process Payment, Payment GUID not found',PaymentGUID);
               AResp := '<head><title>Make a Payment</title><meta http-equiv="refresh" content="0;URL=/PP?PAGE=MAKEPAYMENT"></head>';
               if JSONResp then begin
                  AResp := 'Payment GUID not found';
               end else begin
                  AResp := '<head><title>Make a Payment</title><meta http-equiv="refresh" content="0;URL=/PP?PAGE=MAKEPAYMENT"></head>';
               end;
               RNQuery.Close;
               exit;
            end;
            VarEvaluator.AddDSCurrentRecord(RNQuery, 'CustPayment');
            If RnQuery.FieldByName('CardExpires').AsString <> '' then
               VarEvaluator.AddValue('CARDEXP',FormatDateTime('M/YY', RnQuery.FieldByName('CardExpires').AsDateTime));

            PaymentToken := Trim(RNQuery.FieldByName('PaymentToken').AsString);
            PaymentType := Trim(RNQuery.FieldByName('PaymentType').AsString);
            PaymentServiceName := Trim(RNQuery.FieldByName('ServiceName').AsString);
            PaymentCardName := Trim(RNQuery.FieldByName('CardAccountHolder').AsString); //2017-01-06 jtm F#1290
            BillingZip := ValidCharsOnly(Trim(RNQuery.FieldByName('PaymentZip').AsString),False,True,'');   //2016-3-28 jtm
            BillingStreet := ValidCharsOnly(Trim(RNQuery.FieldByName('PaymentAddress').AsString),True,True,'');
            if (Length(BillingZip) >= 5) then begin
               if BillingStreet = '' then begin
                   if (Length(BillingZip) = 5) or (Length(BillingZip) = 9) then PaymentsAVS := BillingZip;
               end else begin
                  if Length(BillingStreet) > 20 then BillingStreet := Copy(BillingStreet,0,20);
                  if Length(BillingZip) = 5  then begin
                     PaymentsAVS := BillingZip + '0000' + BillingStreet;
                  end else if Length(BillingZip) = 9 then begin
                     PaymentsAVS := BillingZip + BillingStreet;
                  end;
               end;
               if Length(PaymentsAVS) > 29 then PaymentsAVS := Copy(PaymentsAVS,0,29);
            end else begin
               PaymentsAVS := '';
            end;
         end;

         EmpIdent := '';
         if ((OpenXMLGetTag('/CONFIGDATA/SENDEMPIDENT', '') = 'TRUE') and
         ((SessionVarEval.GetValueAsString('Session.Username') <> '') or (ExternalXMLGetTag('/EXTERNALXML/USERNAME') <> ''))) then begin
            EmpIdent := SessionVarEval.GetValueAsString('Session.Username');
            if EmpIdent = '' then EmpIdent := trim(ExternalXMLGetTag('/EXTERNALXML/USERNAME'));
            ProcessLog(ltInfo,'ProcessPortalPaymentEx EmpIdent', EmpIdent);
         end;
         VarEvaluator.AddValue('EmpIdent',EmpIdent); // 2019-3-13 ss DVST-3178

         if not (OpenXMLGetTag('/CONFIGDATA/SENDCARDNAME', '') = 'TRUE') then begin  //2017-01-06 jtm F#1290
            PaymentCardName := '';
         end;

         UserName := VarEvaluator.GetValueAsString('Session.Username');
         if UserName = '' then UserName := trim(ExternalXMLGetTag('/EXTERNALXML/USERNAME'));
         PaymentTransactionType := 'CCAUTH';
         CCAuthType := 'SALE';
         if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/DISPLAYAUTHTYPES', 'FALSE')) and (CustomerMembType = 'ADMIN') then begin  //2017-05-24 jtm F#1577
            RequestPaymentTransactionType := ValidCharsOnly(AContentFields.Values['PaymentTransactionType'], true, false, '');
            if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ALLOWISSUECREDIT', 'FALSE')) AND (RequestPaymentTransactionType = 'CCCREDIT') then begin  // DVST-148
               if Not UserIs('READONLY', PaymentRNID) then begin
                  PaymentTransactionType := 'CCCREDIT';
                  CCAuthType := '';
                  ProcessLog(ltInfo,'PaymentTransactionType; changed by;', PaymentTransactionType + ' ' + UserName);
               end;
            end else if RequestPaymentTransactionType = 'CCAUTH' then begin
               CCAuthType := 'AUTH';
            end;
         end;


         PaymentResponse := '';

         TranIdentExpression := OpenXMLGetTag('/CONFIGDATA/TRANIDENTEXPRESSION');
         If TranIdentExpression <> '' then begin
            TranIdent := VarEvaluator.VarExprEvalAsString('',TranIdentExpression);
         end;
         CustIdentExpression := OpenXMLGetTag('/CONFIGDATA/CUSTIDENTEXPRESSION');
         If CustIdentExpression <> '' then begin
            CustIdent := VarExprEvalAsString('',CustIdentExpression);
         end;
         StationIdentExpression := OpenXMLGetTag('/CONFIGDATA/STATIONIDENTEXPRESSION');// 2019-3-13 ss DVST-3178
         if(StationIdentExpression <> '') then begin
            ProcessLog(ltDebug, 'ProcessPortalPaymentEx', 'StationIdentExpression = '+StationIdentExpression);
            StationIdent := VarExprEvalAsString('',StationIdentExpression);
         end;
         VarEvaluator.AddValue('StationIdent',StationIdent); // 2019-3-13 ss DVST-3178
         ProcessLog(ltDebug, 'ProcessPortalPayment', 'StationIdent = '+StationIdent);// 2019-4-17 ss DVST-5369

         VarEvaluator.AddValue('TRANIDENT',TranIdent);
         VarEvaluator.AddValue('PAYMENTTYPE',PAYMENTTYPE);
         VarEvaluator.AddValue('CUSTIDENT',CustIdent); //2018-06-20 bls: F#2076


         If PaymentType = 'CARD' then begin
            PaymentRequest := '<TRANSACTION> <RNID>'+PaymentRNID+'</RNID>' +
                              '<TRANSACTIONTYPE>'+PaymentTransactionType+'</TRANSACTIONTYPE>';
            if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/DISPLAYAUTHTYPES', 'FALSE')) and (CCAuthType <> '') and (PaymentTransactionType = 'CCAUTH') then begin
               PaymentRequest := PaymentRequest + '<CCAUTHTYPE>' + CCAuthType + '</CCAUTHTYPE>';
            end;
            ProcessLog(ltInfo,'PaymentTransactionType', PaymentTransactionType);
            if OpenXMLGetTag('/CONFIGDATA/PAYMENTTYPES/PAYMENTTYPE[@NAME=''CREDIT'']/SERVICENAME') <> '' then
                  PaymentServiceName := OpenXMLGetTag('/CONFIGDATA/PAYMENTTYPES/PAYMENTTYPE[@NAME=''CREDIT'']/SERVICENAME');
            if PaymentServiceName = '' then
               PaymentServiceName := 'CARD';
            PaymentRequest := PaymentRequest + '<SERVICENAME>'+ PaymentServiceName+'</SERVICENAME>';
            ProcessLog(ltInfo,'PaymentServiceName', PaymentServiceName);
            if OTPCardAcct <> '' then begin
               PaymentRequest := PaymentRequest + '<CCACCOUNT>'+OTPCardAcct+'</CCACCOUNT>';
               PaymentRequest := PaymentRequest + '<CCEXP>'+OTPCardExp+'</CCEXP>';
               if OTPCVV <> '' then
                  PaymentRequest := PaymentRequest + '<CCCVV>'+OTPCVV+'</CCCVV>';
               if OTPAVS <> '' then
                  PaymentRequest := PaymentRequest + '<CCAVS>'+OTPAVS+'</CCAVS>';  //2016-3-28 jtm

            end else if CardEventParms <> '' then begin     //2016-8-22 jtm: Feat OT#1053
               CardEventParamsXPath := '/CARDEVENTPARAMS'; // 2019-5-15 SS DVST-572
               if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/ENABLESURCHARGESANDFEES', 'FALSE')) then begin
                  PaymentRequest := PaymentRequest + '<SURCHARGEAMT>' + ValidCharsOnly(AContentFields.Values['SURCHARGEAMT'], false, true, '.') + '</SURCHARGEAMT>' +
                                    '<SURCHARGELEGAL>' + ValidCharsOnly(AContentFields.Values['SURCHARGELEGAL'], true, true, '!?'';-.,()*": ') + '</SURCHARGELEGAL>';
               end;
               if NumericOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCDEVICETYPE'))) = '3' then begin //2017-08-02 jtm: F#2035
                 IDTechDecrypt := TIDTechDecrypt.Create(Trim(GetXMLTagStr(CardEventParms,'ENCDVCENCRYPTEDBLOCK')), PL.ProcessLog);
                 CardEventParms := AddDeviceCapabilities(IDTechDecrypt.GenerateCardEventParmsXML, CardEventParamsXPath, ['MKEY', 'MSR']); // 2019-5-15 SS DVST-572
                 PaymentRequest := PaymentRequest + CardEventParms; // 2019-5-15 SS DVST-572
               end else if NumericOnly(Trim(GetXMLTagStr(CardEventParms,'ENCDVCDEVICETYPE'))) = '6' then begin //2018-11-14 bls: DVST-1944
                  PaymentRequest := PaymentRequest + CardEventParms;
               end else begin
                  CardEventParms := '<CARDEVENTPARAMS>'+ // 2019-5-15 SS DVST-572
                                    '<MTKSN>'+ ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'MTKSN')),True,True,'') +'</MTKSN>'+
                                    '<MTSESSIONID>' + Trim(GetXMLTagStr(CardEventParms,'MTSESSIONID')) + '</MTSESSIONID>'+
                                    '<MTENCRYPTEDTRACK1>' + Trim(GetXMLTagStr(CardEventParms,'MTENCRYPTEDTRACK1')) + '</MTENCRYPTEDTRACK1>'+
                                    '<MTENCRYPTEDTRACK2>' + Trim(GetXMLTagStr(CardEventParms,'MTENCRYPTEDTRACK2')) + '</MTENCRYPTEDTRACK2>'+
                                    '<MTDEVICESERIAL>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'MTDEVICESERIAL')),True,True,'') + '</MTDEVICESERIAL>'+
                                    '<MTMPDATA>' + Trim(GetXMLTagStr(CardEventParms,'MTMPDATA')) + '</MTMPDATA>'+
                                    '<MTMPSTATUS>' + ValidCharsOnly(Trim(GetXMLTagStr(CardEventParms,'MTMPSTATUS')),True,True,'') + '</MTMPSTATUS>'+
                                 '</CARDEVENTPARAMS>';
                  PaymentRequest := PaymentRequest + AddDeviceCapabilities(CardEventParms, CardEventParamsXPath, ['MKEY', 'MSR']); // 2019-5-15 SS DVST-572
               end;
               ProcessLog(ltInfo,'CardEventParms', CardEventParms);
                 if OTPAVS <> '' then
                     PaymentRequest := PaymentRequest + '<CCAVS>'+OTPAVS+'</CCAVS>';
            end else if OTPTAToken <> '' then begin
               PaymentRequest := PaymentRequest + '<TRANSARMORTOKEN>'+OTPTAToken+'</TRANSARMORTOKEN>';
               PaymentRequest := PaymentRequest + '<CCEXP>'+OTPTACardExp+'</CCEXP>';
               PaymentRequest := PaymentRequest + '<TRANSARMORTOKENPROVIDERID>'+OTPTATokenType+'</TRANSARMORTOKENPROVIDERID>';
               if OTPAVS <> '' then
                  PaymentRequest := PaymentRequest + '<CCAVS>'+OTPAVS+'</CCAVS>';  

            end else begin
               if PaymentsAVS <> '' then
                  PaymentRequest := PaymentRequest + '<CCAVS>'+PaymentsAVS+'</CCAVS>';

               PaymentRequest := PaymentRequest + '<REPTOKEN>'+PaymentToken+'</REPTOKEN>';
            end;
            if EmpIdent <> '' then
               PaymentRequest := PaymentRequest + '<EMPIDENT>'+EmpIdent+'</EMPIDENT>'; //2016-8-22 jtm: Feat OT#915
            if PaymentCardName <> '' then begin
               PaymentRequest := PaymentRequest + '<CCNAME>'+PaymentCardName+'</CCNAME>'; //2017-01-06 jtm F#1290
            end;
            if (OpenXMLGetTag('/CONFIGDATA/INCLUDEEMPTYTAXAMOUNT','FALSE') = 'TRUE') then begin  //2017-12-13 jtm D#2146
               PaymentRequest := PaymentRequest + '<TAXAMOUNT>0</TAXAMOUNT>';
            end;
            PaymentRequest := PaymentRequest + '<CCAUTHTYPE>SALE</CCAUTHTYPE> <CCAMT>'+PaymentAmount+'</CCAMT>' +
                                               '<TRANIDENT>'+Tranident+'</TRANIDENT> <CUSTIDENT>'+CustIdent+WS2+'</CUSTIDENT> <STATIONIDENT>'+StationIdent+'</STATIONIDENT>';
            if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then    //2016-9-19 jtm: Feat OT# 1145
               PaymentRequest := PaymentRequest + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';


            PaymentRequest := PaymentRequest + ' </TRANSACTION>'+CRLF;
            XMLResp := TStringList.Create;
            VarEvaluator.AddValue('GatewayRNID',PaymentRNID);//2017-05-24 jtm: F#1821
            ProcessLog(ltDebug, METHOD_NAME, 'REQUEST TO GW = '+PaymentRequest);// 2019-5-15 SS DVST-572
            ProcessPPSAPIXML(PaymentRequest, XMLResp,GetAppServerHost,0);
            ProcessLog(ltDebug, METHOD_NAME, 'RESPONSE FROM GW = '+XMLResp.Text);// 2019-5-15 SS DVST-572

            PromptForFraudReversal := strtobool(GetXMLTag(XMLResp, 'PROMPTFORFRAUDREVERSAL')); //2018-06-20 bls: F#2076
            FraudAutoReversal := GetXMLTag(XMLResp, 'REVERSALREASON'); //2018-06-20 bls: F#2076

            IF GetXMLTag(XMLResp,'CCAUTHCODE') <> '' then begin
               ApprovalCode := GetXMLTag(XMLResp,'CCAUTHCODE');
               if (NOT PromptForFraudReversal) and (FraudAutoReversal = '') then begin //2018-06-06 bls: F#2076

                  HTMLTemplate := 'ReceiptCardApproved.htm';

                  EmailMessage := '<HTML>Thank you for your Payment.<BR>'+//PaymentToken + '/' + PaymentType +  Trim(Request.ContentFields.Values['payment'])+  PaymentREsponse +
                                  'Receipt Number:' + ReceiptNumber + '<BR>' +
                                  'Amount:' + TranAmount+ '<BR>' +
                                  'Date:' + FormatDateTime('MM/DD/YYYY', NOW)+ '<BR>';
                  EmailMessage := EMailMessage + '<BR>' +CustIdent;
                  EmailMessage := EMailMessage + '<BR>' +AccountNumber;

                  If OpenXMLGetTag('/CONFIGDATA/EMAILPAYMENTMATERECEIPT') = 'TRUE' then begin
                     ProcessLog(ltInfo,'Retrieving PaymentMate Receipt', 'PaymentLocationRNID:'+ VarEvaluator.GetValueAsString('PaymentLocationRNID') + ' CCSYSTEMCODE:'+ GetXMLTag(XMLResp,'CCSYSTEMCODE'));
                     ReceiptEmail := RetrieveReceipt(VarEvaluator.GetValueAsString('PaymentLocationRNID'),GetXMLTag(XMLResp,'CCSYSTEMCODE'),GetXMLTag(XMLResp,'TICKETGUID'),'CCRECEIPTRETRIEVE');
                     if ReceiptEmail <> '' then begin
                        ProcessLog(ltInfo,'PaymentMate Receipt found:', 'Adding it to Email');
                        EmailMessage := ReceiptEmail;
                     end;
                  end;
                  if (ReceiptToCustEmail AND (CustEmail <> '')) then begin
                     ReceiptEmail := EmailReceipt(CustEmail,VarEvaluator.GetValueAsString('PaymentLocationRNID'),GetXMLTag(XMLResp,'CCSYSTEMCODE'),GetXMLTag(XMLResp,'TICKETGUID'),'CARD');
                     ProcessLog(ltInfo,'PaymentMate Receipt to Customer:', ReceiptEmail);
                  end;

                  If OpenXMLGetTag('/CONFIGDATA/APPROVEDEMAILEXPRESSION') <> '' then begin
                     EmailMessage := VarEvaluator.VarExprEvalAsString('',OpenXMLGetTag('/CONFIGDATA/APPROVEDEMAILEXPRESSION'));
                  end;

               end else if (FraudAutoReversal <> '') then begin
                  HTMLTemplate := 'ReceiptCardDeclined.htm';
                  EmailMessage := '<HTML>Your Credit card Payment was automatically reversed based on fraud detection settings.';
               end;
               VarEvaluator.AddValue('CVVRespText', GetXMLTag(XMLResp, 'CVVRESPTEXT')); //2018-06-20 bls: F#2076
               VarEvaluator.AddValue('AVSRespText', GetXMLTag(XMLResp, 'AVSRESPTEXT')); //2018-06-20 bls: F#2076
               VarEvaluator.AddValue('CCSystemCode', GetXMLTag(XMLResp, 'CCSYSTEMCODE')); //2018-06-20 bls: F#2076
               VarEvaluator.AddValue('AccountNumber', AccountNumber); //2018-06-20 bls: F#2076
               VarEvaluator.AddValue('TranAmount', AContentFields.Values['amount']); //2018-06-20 bls: F#2076
               
               Result := True;

            end else begin
               NonAuthReason := GetXMLTag(XMLResp,'TRANRESPMESSAGE');
               HTMLTemplate := 'ReceiptCardDeclined.htm';

               EmailMessage := '<HTML>We''re sorry, but your Credit card Payment was not processed.<BR>'+
                               'Please confirm your account information is correct or call your card issuer for further assistance.<BR>';
               EmailMessage := EMailMessage + '<BR>' +CustIdent;
               EmailMessage := EMailMessage + '<BR>' +AccountNumber;
            end;
            if PaymentTransactionType = 'CCCREDIT' then begin  //2017-05-24 jtm F#1577
               if GetXMLTag(XMLResp,'TRANSUCCESS') = 'TRUE' then begin
                  HTMLTemplate := 'ReceiptCardApproved.htm';

                  EmailMessage := '<HTML>Credit Issued.<BR>'+
                                  'Receipt Number:' + ReceiptNumber + '<BR>' +
                                  'Amount:' + TranAmount+ '<BR>' +
                                  'Date:' + FormatDateTime('MM/DD/YYYY', NOW)+ '<BR>';
                  EmailMessage := EMailMessage + '<BR>' +CustIdent;
                  EmailMessage := EMailMessage + '<BR>' +AccountNumber;

                  If OpenXMLGetTag('/CONFIGDATA/EMAILPAYMENTMATERECEIPT') = 'TRUE' then begin
                     ProcessLog(ltInfo,'Retrieving PaymentMate Receipt', 'PaymentLocationRNID:'+ VarEvaluator.GetValueAsString('PaymentLocationRNID') + ' CCSYSTEMCODE:'+ GetXMLTag(XMLResp,'CCSYSTEMCODE'));
                     ReceiptEmail := RetrieveReceipt(VarEvaluator.GetValueAsString('PaymentLocationRNID'),GetXMLTag(XMLResp,'CCSYSTEMCODE'),GetXMLTag(XMLResp,'TICKETGUID'),'CCRECEIPTRETRIEVE');
                     if ReceiptEmail <> '' then begin
                        ProcessLog(ltInfo,'PaymentMate Receipt found:', 'Adding it to Email');
                        EmailMessage := ReceiptEmail;
                     end;
                  end;
                  If OpenXMLGetTag('/CONFIGDATA/APPROVEDEMAILEXPRESSION') <> '' then
                     EmailMessage := VarEvaluator.VarExprEvalAsString('',OpenXMLGetTag('/CONFIGDATA/APPROVEDEMAILEXPRESSION'));

                  Result := True;
               end else begin
                  NonAuthReason := GetXMLTag(XMLResp,'TRANRESPMESSAGE');
                  HTMLTemplate := 'ReceiptCardDeclined.htm';

                  EmailMessage := '<HTML>We''re sorry, but your credit was not issued.<BR>'+
                                  'Please confirm your account information is correct or call your card issuer for further assistance.<BR>';
                  EmailMessage := EMailMessage + '<BR>' +CustIdent;
                  EmailMessage := EMailMessage + '<BR>' +AccountNumber;
               end;
            end;
            GWSystemCode := GetXMLTag(XMLResp,'CCSYSTEMCODE');

            PaymentResponse := GetXMLTag(XMLResp,'CCAUTHCODE');
            VarEvaluator.AddValue('CardType',GetXMLTag(XMLResp,'CCCARDTYPEEX')); //2017-10-04 jtm: F#2224
            XMLResp.Free;

         end;
         If PaymentType = 'CHECK' then begin
            PaymentRequest := '<TRANSACTION>' +
                              '   <TRANSACTIONTYPE>TCAUTH</TRANSACTIONTYPE>' +
                              '   <SERVICENAME>ICA</SERVICENAME>' +
                              '   <RNID>'+PaymentRNID+'</RNID>' +
                              '   <CHECKTYPE>PERSONAL</CHECKTYPE>' +
                              '   <CHECKAMT>' + PaymentAmount + '</CHECKAMT>';

            ProcessLog(ltDebug,METHOD_NAME, 'CheckAccount POS of *;'+IntToStr(Pos('*',Trim(RNQuery.FieldByName('CheckAccount').AsString))));
            if (Pos('*',Trim(RNQuery.FieldByName('CheckAccount').AsString)) > 0) then begin
               PaymentRequest := PaymentRequest + '<REPTOKEN>'+PaymentToken+'</REPTOKEN>';
               ProcessLog(ltInfo,METHOD_NAME, 'Processing check with REPTOKEN');
            end else begin
               PaymentRequest := PaymentRequest + '   <CHECKROUTING>'+Trim(RNQuery.FieldByName('CheckRouting').AsString)+'</CHECKROUTING>' +
                                                  '   <CHECKACCOUNT>'+Trim(RNQuery.FieldByName('CheckAccount').AsString)+'</CHECKACCOUNT>';
               if (OpenXMLGetTag('/CONFIGDATA/SENDCHECKDL', 'TRUE') = 'TRUE') then begin  //2017-04-06 jtm Feat #1650 don't send for clients who have waivers
                  PaymentRequest := PaymentRequest + '   <CHECKDL>'+Trim(RNQuery.FieldByName('LicenseNum').AsString)+'</CHECKDL>' +
                                 '   <CHECKDLSTATE>'+Trim(RNQuery.FieldByName('LicenseState').AsString)+'</CHECKDLSTATE>';
               end;
            end;

            PaymentRequest := PaymentRequest + '   <CHECKNAME>'+CustIdent+WS2+'</CHECKNAME>' +
                              '   <CUSTIDENT>'+ CustIDent+'</CUSTIDENT>'+
                              '   <TRANIDENT>'+ TranIdent+'</TRANIDENT>'+
                              '   <STATIONIDENT>'+ StationIdent+'</STATIONIDENT>';

            XMLResp := TStringList.Create;
            if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then      //2016-9-19 jtm: Feat OT# 1145
               PaymentRequest := PaymentRequest + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';

            PaymentRequest := PaymentRequest + ' </TRANSACTION>'+CRLF;
            VarEvaluator.AddValue('GatewayRNID',PaymentRNID);//2017-05-24 jtm: F#1821
            ProcessPPSAPIXML(PaymentRequest, XMLResp,GetAppServerHost,0);

            GWSystemCode := GetXMLTag(XMLResp,'TCSYSTEMCODE');
            IF GetXMLTag(XMLResp,'TCECASTATUS') = '1' then begin
               ApprovalCode := GetXMLTag(XMLResp,'TCDISPLAYTEXT');
               HTMLTemplate := 'ReceiptCheckApproved.htm'; //2017-09-20 jtm: F#2196
               EmailMessage := '<HTML>Thank you for your Payment.<BR>'+//PaymentToken + '/' + PaymentType +  Trim(Request.ContentFields.Values['payment'])+  PaymentREsponse +
                               'Receipt Number:' + TranIdent + '<BR>' +
                               'Amount:' + TranAmount+ '<BR>' +
                               'Date:' + FormatDateTime('MM/DD/YYYY', NOW)+ '<BR>';
               EmailMessage := EMailMessage + '<BR>' +CustIdent;
               EmailMessage := EMailMessage + '<BR>' +AccountNumber;

               If OpenXMLGetTag('/CONFIGDATA/APPROVEDEMAILEXPRESSION') <> '' then
                  EmailMessage := VarEvaluator.VarExprEvalAsString('',OpenXMLGetTag('/CONFIGDATA/APPROVEDEMAILEXPRESSION'));


               Result := True;
            end else begin
               NonAuthReason := GetXMLTag(XMLResp,'TCDISPLAYTEXT');
               HTMLTemplate := 'ReceiptCheckDeclined.htm'; //2017-09-20 jtm: F#2196
               EMailMessage := '<HTML>Your check payment has not been processed.<BR><BR>'+
                               'We are sorry that we cannot accept your check at this time.  Our decision is based, in whole or in part, on '+
                               'information provided to us by TeleCheck(r).  We encourage you to call TeleCheck at 1-800-366-2425 or write TeleCheck '+
                               'Customer Care at P.O. Box 6806, Hagerstown, MD 21741-6806.  TeleCheck can discuss with you the information that led to '+
                               'our decision not to accept your check at this time.  Please provide TeleCheck your driver''s license number and the '+
                               'state where it was issued, and the complete banking numbers printed on the bottom of your check. Under the Fair Credit '+
                               'Reporting Act, you have the right to a free copy of your information held in TeleCheck''s files within 60 days from today. '+
                               'You may also dispute the accuracy or completeness of any information in TeleCheck''s consumer report.<BR><BR></HTML>';
               EmailMessage := EMailMessage + '<BR>' +CustIdent;
               EmailMessage := EMailMessage + '<BR>' +AccountNumber;
            end;
            PaymentResponse := GetXMLTag(XMLResp,'TCDISPLAYTEXT');


            XMLResp.Free;


         end;
         VarEvaluator.AddValue('PR',PaymentResponse);
         VarEvaluator.AddValue('GWSC',GWSystemCode);
         VarEvaluator.AddValue('ApprovalCode',ApprovalCode);
         VarEvaluator.AddValue('NonAuthReason',NonAuthReason);
         VarEvaluator.AddValue('PromptForFraudReversal', booltostr(PromptForFraudReversal)); //2018-06-20 bls: F#2076
         VarEvaluator.AddValue('FraudAutoReversal', FraudAutoReversal); //2018-06-20 bls: F#2076

         RNQuery.Close;
         RNQuery.SQL.Clear;
         RNQuery.SQL.Add('select * from CustPaymentHistory');
         RNQuery.SQL.Add('where (PayHistGUID = '''+PaymentHistGUID + ''')');
         RNQuery.Open;
         RNQuery.Edit;
         RNQuery.FieldByName('ApprovalCode').AsString := ApprovalCode;
         RNQuery.FieldByName('NonAuthReason').AsString := NonAuthReason;
         RNQuery.FieldByName('GWSystemCode').AsInteger := Valu(GWSystemCode);

         if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/STORECARDTYPE','FALSE')) then begin
            RNQuery.FieldByName('Custom8').AsString := VarEvaluator.GetValueAsString('CardType');
         end;

         RNQuery.Post;

         If SchedGUID <> '' then begin
            ComputeSchedule(SchedGUID,RNID,IsPlanPayment,Email);
         end;

         If ApprovalCode <> '' then begin
            ProcessExternalPaymentPosts(PaymentLocationRNID); //process any external payments if necessary
         end;

         if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAIL/INCLUDESPILT') = 'TRUE' then begin
            If RNQuery.FieldByName('SplitDetails').ASString <> '' then
               EMailMessage := EMailMessage + '<BR>' + GenerateSplitTable(RNQuery.FieldByName('SplitDetails').ASString);
         end;

         ReplaceString(WS, '%RECEIPTURL%','/PP?PAGE=PAYMENTRECEIPT&PAYHISTGUID=' + Trim(RNQuery.FieldByName('PAYHISTGUID').AsString));
         ReplaceString(WS, '%PAYMENTSYSTEMCODE%',receiptNumber);
         if JSONResp then begin
            if (result) then begin
               AResp := 'Payment confirmed';
            end else begin
               AResp := 'Payment unsuccessful';
            end;
         end else begin
            AResp := WS;
         end;

      If ValuReal(PaymentAmount) = 0 then SupressReceipt := True;

      If (NOT (SupressReceipt) and (Email <> '') AND (NOT PromptForFraudReversal)) then begin
         if ((FraudAutoReversal <> '') AND (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/VIRTUALTERMINAL/FRAUDAUTOREVERSALSENDEMAIL', 'FALSE')='FALSE')) then begin //2018-06-20 bls: F#2076
         end else begin
            If HTMLTemplate <> '' then begin
               HTMLEmail := LoadWebFileFromFolder(HTMLTemplate,'');   //we need to do this here so all of the variables are loaded.
               If HTMLEmail <> '' then EmailMessage := HTMLEmail;
            end;

            clMail.BuildMessage('',EmailMessage);
            clMail.From.FullAddress := '"' + DomainFriendlyName+'"<'+DomainSendAsEmail+'>';
            clMail.ToList.EmailAddresses := Email;
            clMail.BCCList.EmailAddresses := GetConfigString('CONFIRMATIONBCC','');
            if SessionVarEval.GetValueAsString('BCCEMAIL') <> '' then
               clMail.BCCList.EmailAddresses := clMail.BCCList.EmailAddresses + ',' + SessionVarEval.GetValueAsString('BCCEMAIL');
            if SessionVarEval.GetValueAsString('EmployeeEmail') <> '' then     //2016-8-08 jtm: Feat OT#979
               clMail.BCCList.EmailAddresses := clMail.BCCList.EmailAddresses + ',' + SessionVarEval.GetValueAsString('EmployeeEmail');

            ProcessLog(ltInfo,'bccemails', clMail.BCCList.EmailAddresses);
            If ApprovalCode  = '' then begin
               If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAIL/DECLINEDPAYMENTSUBJECT') <> '' then
                  clMail.Subject := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAIL/DECLINEDPAYMENTSUBJECT') + ' ' + FormatDateTime('MM/DD/YYYY', Date)
               else
                  clMail.Subject := 'Payment Failure Notification ' + FormatDateTime('MM/DD/YYYY', Date);
            end else begin
               If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAIL/APPROVEDPAYMENTSUBJECT') <> '' then
                  clMail.Subject := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAIL/APPROVEDPAYMENTSUBJECT') + ' ' + FormatDateTime('MM/DD/YYYY', Date)
               else
                  clMail.Subject := 'Payment Receipt ' + FormatDateTime('MM/DD/YYYY', Date);
            end;
               If ((OpenXMLGetTag('/CONFIGDATA/UIPARAMS/PAYMENTINVITE/REPLYTOEMPLOYEE','FALSE') = 'TRUE') and (SessionVarEval.GetValueAsString('EmployeeEmail') <> '')) then begin
                  clMail.ReplyTo := SessionVarEval.GetValueAsString('EmployeeEmail');
               end else begin
            clMail.ReplyTo := GetConfigString('CONFIRMATIONREPLYTO','');
               end;
            SMTP.Open();
            try
               try
                  SMTP.Send(clMail);
               except  //2017-08-16 jtm: D#1857
                 On E:Exception do begin
                     ProcessLog(ltWarning,'Exception on Sending Email ', E.Message);
                 end;
               end;
            finally
               SMTP.Close();
            end;
         end;
      end;

   end else begin
      ProcessLog(ltWarning,'PROCESS Portal PAYMENT Customer GUID not found ' + CustGUID,'');
   end;
end;

function TCustomerInfoModule.ProcessPaymentAjax(const AQueryFields, AContentFields: TStrings; ARNID: string): string;
var
Resp,ParentGUID: string;
ResponseJSON : TStringList;
TranSuccess : boolean;
TranMessage : string;
   Procedure FinalizeJSONRespAndFree;
   Begin
      ResponseJSON.Add('"serverdate" : "'+FormatDateTime('MM/DD/YYYY', now)+'",');
      ResponseJSON.Add('"servertime" : "'+FormatDateTime('HH:NN:SS', now)+'",');
      ResponseJSON.Add('"tranrespmessage" : "'+TranMessage+'",');
      ResponseJSON.Add('"profile" : "'+ARNID+'",');
      if TranSuccess then begin
         ResponseJSON.Add('"transuccess" : true');
      end else begin
         ResponseJSON.Add('"transuccess" : false');
         ProcessLog(ltWarning, 'ProcessPaymentAjax transucces false:',TranMessage);
      end;
      ResponseJSON.Add('}');
      Result := ResponseJSON.Text;
      ResponseJSON.Free;
   end;
begin
   result := '';
   ResponseJSON := TStringList.Create;
   ResponseJSON.Add('{');
   TranSuccess := false;
   VarEvaluator.ClearAll;
   if OpenCustomerQuery(AQueryFields) then begin
      ParentGUID := Trim(RNQuery.FieldByName('CustomerCode').AsString);
      ResponseJSON.Add('"custGuid": "'+ParentGUID+'",');
      transuccess:= ProcessPortalPaymentEx(ARNID,ParentGUID,nil,AQueryFields, AContentFields,Resp,true);
      TranMessage := Resp;
      FinalizeJSONRespAndFree;
   end else begin
      TranMessage := 'Customer Not Found';
      FinalizeJSONRespAndFree;
   end;
end;

procedure TCustomerInfoModule.HEUpdateExistingAccount(ACustomerSC: Integer;ARNID:string);
var
CustGUID,ChildAccountNumber,AccountPrefix,TranMessage,memberType : string;
firstname,lastname,DOB: string;
FirstChild,MemberVerified,isApplicant : boolean;
begin
   FirstChild := true;
   MemberVerified := false;
   isApplicant := true;
   RNQuery.Close;
   RNQuery.SQL.Clear;
   RNQuery.SQL.Add('Select * from Customers where (SystemCode = '+Stri(ACustomerSC,-1) + ')');
   RNQuery.Open;
   if RNQuery.RecordCount = 1 then begin
      CustGUID := RNQuery.FieldByName('CUSTOMERCODE').AsString;
      if (RNQuery.FieldByName('MEMBSTATUS').AsString = '') then begin
         RNQuery2.Close;
         RNQuery2.SQL.Clear;
         RNQuery2.SQL.Add('Select * from CustChild left outer join store on (store.systemcode = CustChild.RNID) where (CustGUID = '''+CustGUID + ''') and (Hidden=0)');
         RNQuery2.Open;
         if (RNQuery2.RecordCount > 0) then begin
            RNQuery.Edit;
            RNQuery2.Edit;
            while not (RNQuery2.EOF) do begin
               RNQuery2.Edit;
               ChildAccountNumber := RNQuery2.FieldByName('AccountNumber').AsString;
               AccountPrefix := ChildAccountNumber;
               if Pos(':',ChildAccountNumber) > 0 then begin
                  ParseToChar(ChildAccountNumber,':');
                  Delete(AccountPrefix,Pos(':',AccountPrefix),length(AccountPrefix));
                  while Pos(':',ChildAccountNumber) > 0 do begin //cleanup any more occurrences
                     ParseToChar(ChildAccountNumber,':');
                  end;
               end;
               if (AccountPrefix = 'EAID') then begin
                  ProcessLog(ltInfo, 'HEUpdateExistingAccount adding child as employer:' + RNQuery2.FieldByName('ChildGUID').AsString,Stri(CustomerSC,-1));

                  memberType := 'Employer';
                  RNQuery.FieldByName('MEMBSTATUS').AsString := memberType; //MEMBTYPE is reserved for ADMIN, so let's use membstatus
                  RNQuery.FieldByName('AccountNumber').AsString := ChildAccountNumber;
                  RNQuery2.FieldByName('AccountNumber').AsString := ChildAccountNumber;
                  SessionVarEval.AddValue('MEMBSTATUS',memberType);
                  VarEvaluator.AddValue('memberType',memberType);
                  FirstChild := false;
                  isApplicant := false;
               end else begin
                  if ((Pos('92',ChildAccountNumber)>0) and (Pos('-01',ChildAccountNumber)>0))
                   or (Pos('S',ChildAccountNumber)=1) then begin
                     memberType := 'Member';
                     VarEvaluator.AddValue('memberType',memberType);
                     SessionVarEval.AddValue('MemberHCCID',ChildAccountNumber);
                     VarEvaluator.AddValue('MemberHCCID',ChildAccountNumber);
                     ProcessLog(ltInfo, 'HEUpdateExistingAccount attempting to add child as member:' + RNQuery2.FieldByName('ChildGUID').AsString,Stri(CustomerSC,-1));
                     if ValidateHEUser(memberType,TranMessage) then begin
                        ProcessLog(ltInfo, 'HEUpdateExistingAccount adding child as member:' + RNQuery2.FieldByName('ChildGUID').AsString,Stri(CustomerSC,-1));
                        if not MemberVerified then begin  //only update the parent account for the first child
                           RNQuery.FieldByName('AccountNumber').AsString := VarEvaluator.GetValueAsString('Member.subscriberId');
                           RNQuery.FieldByName('COMMENTS1').AsString := VarEvaluator.GetValueAsString('subscriptionId');
                           RNQuery.FieldByName('COMMENTS2').AsString := VarEvaluator.GetValueAsString('Member.subscriptionId');
                           RNQuery.FieldByName('COMMENTS3').AsString := VarEvaluator.GetValueAsString('Member.subscriberId');
                           RNQuery.FieldByName('COMMENTS4').AsString := VarEvaluator.GetValueAsString('Member.subscriberSystemId');
                           RNQuery.FieldByName('COMMENTS5').AsString := VarEvaluator.GetValueAsString('Member.subscriptionSystemId');
                           RNQuery.FieldByName('COMMENTS6').AsString := VarEvaluator.GetValueAsString('Member.systemId');
                           RNQuery.FieldByName('MEMBSTATUS').AsString := memberType; //MEMBTYPE is reserved for ADMIN, so let's use membstatus
                           SessionVarEval.AddValue('MEMBSTATUS',memberType);
                           if (VarEvaluator.GetValueAsString('Member.birthDate')<>'') then begin
                              RNQuery.FieldByName('DOB').AsString := VarEvaluator.GetValueAsString('Member.birthDate');
                           end;
                           FirstChild := false;
                           MemberVerified := true;
                        end;
                        RNQuery2.FieldByName('ExternalIntegration').AsString := VarEvaluator.GetValueAsString('subscriptionId');
                        RNQuery2.FieldByName('AccountNumber').AsString := VarEvaluator.GetValueAsString('Member.subscriberId');
                        if (VarEvaluator.GetValueAsString('Member.birthDate')<>'') then begin
                           RNQuery.FieldByName('DOB').AsString := VarEvaluator.GetValueAsString('Member.birthDate');
                        end;
                        if (GetXMLTagStr(VarEvaluator.GetValueAsString('memberXML'),'firstName') <> '') then begin
                           RNQuery2.FieldByName('firstname').AsString := GetXMLTagStr(VarEvaluator.GetValueAsString('memberXML'),'firstName');
                        end;
                        if (GetXMLTagStr(VarEvaluator.GetValueAsString('memberXML'),'lastName') <> '') then begin
                           RNQuery2.FieldByName('lastname').AsString := GetXMLTagStr(VarEvaluator.GetValueAsString('memberXML'),'lastName');
                        end;
                        isApplicant := false;
                     end;
                  end else if (Pos('92',ChildAccountNumber)=1) then begin
                     if not MemberVerified then begin
                        ProcessLog(ltInfo, 'HEUpdateExistingAccount adding child as Guest with invalid plan:' + RNQuery2.FieldByName('ChildGUID').AsString,Stri(CustomerSC,-1));
                        memberType := 'Guest';
                        RNQuery.FieldByName('MEMBSTATUS').AsString := memberType; //MEMBTYPE is reserved for ADMIN, so let's use membstatus
                        RNQuery.FieldByName('AccountNumber').AsString := ChildAccountNumber;
                        RNQuery2.FieldByName('AccountNumber').AsString := ChildAccountNumber;
                        SessionVarEval.AddValue('MEMBSTATUS',memberType);
                        VarEvaluator.AddValue('memberType',memberType);
                        FirstChild := false;
                        isApplicant := false;
                     end else begin
                        RNQuery2.FieldByName('AccountNumber').AsString := ChildAccountNumber; //remove the prefix
                     end;
                  end;
               end;
               if (isApplicant) then begin
                  ProcessLog(ltInfo, 'HEUpdateExistingAccount adding child as applicant:' + RNQuery2.FieldByName('ChildGUID').AsString,Stri(CustomerSC,-1));
                  memberType := 'Applicant';
                  if (FirstChild) then begin  //only update the parent account for the first child
                     RNQuery.FieldByName('AccountNumber').AsString := ChildAccountNumber;
                     RNQuery.FieldByName('MEMBSTATUS').AsString := memberType; //MEMBTYPE is reserved for ADMIN, so let's use membstatus
                     SessionVarEval.AddValue('MEMBSTATUS',memberType);
                     FirstChild := false;
                  end;
               end;
               RNQuery2.Post;
               RNQuery2.Next;
               isApplicant := true;
            end;
            RNQuery.Post;
         end else begin
            ProcessLog(ltInfo, 'HEUpdateExistingAccount no children add as applicant',Stri(CustomerSC,-1));
            memberType := 'Applicant';
            RNQuery.Edit;
            ChildAccountNumber := RNQuery.FieldByName('AccountNumber').AsString;
            RNQuery.FieldByName('MEMBSTATUS').AsString := memberType; //MEMBTYPE is reserved for ADMIN, so let's use membstatus
            SessionVarEval.AddValue('MEMBSTATUS',memberType);
            firstname := trim(RNQuery.FieldByName('FirstName').AsString);
            lastname := trim(RNQuery.FieldByName('lastname').AsString);
            DOB := trim(RNQuery.FieldByName('dob').AsString);
            RNQuery.Post;
            AddChildToAccount(CustGUID,ARNID,firstname,lastname,DOB,ChildAccountNumber,'','');
         end;
      end else begin
         ProcessLog(ltWarning, 'HEUpdateExistingAccount failure. already updated. MEMBSTATUS:',RNQuery.FieldByName('MEMBSTATUS').AsString);
      end;
   end else begin
      ProcessLog(ltWarning, 'HEUpdateExistingAccount failure. Customer record not found:',Stri(CustomerSC,-1));
   end;
end;

function TCustomerInfoModule.buildJSONStrForTransData(ASQLQuery: String):String;
const
   DOWNLOADXLSHEADERNAMES = 'Payment Date|First Name|Last Name|Account Number|Order First Name|Order Last Name|Order Number|Payment Amount|Payment Name|Receipt Number|Approval Code|Failure Reason';
   DOWNLOADXLSDBTBLCOLNAMES = 'PaymentDate|FirstName|LastName|AccountNumber|ChildFirstName|ChildLastName|ChildAccountNumber|PaymentAmount|PaymentName|ToEvalInCode|ApprovalCode|NonAuthReason';
   ERRORMSGHOSTNAMENOTCONFIGURED = 'THIS LOCATION (RNID = ^) WHERE THIS TRANSACTION TOOK PLACE HAS SPLIT PAYMENT TRANSACTION DATA, HOWEVER CURRENTLY, IT IS NOT CONFIGURED TO DISPLAY THOSE. CHECK /CONFIGDATA/UIPARAMS/TRANSACTIONTAB/SPLITTABLES/SPLITTABLE';
var
   Errors: TStringList;
   ADOQuery: TADOQuery;
   HeaderNamesList: TTTStringList;
   ColNamesOfHeadersList: TTTStringList;
   ADomainConfigOpenXMLObj: TOpenXML;
   SplitDetailsOpenXMLObj: TOpenXML;

   DelimitedHeaderNames: String;
   DelimitedColNames: String;
   SubHeaderPrefix : String;
   NoDataMsg: String;
   ASplitDetails: String;
   JSON: String;
   HostName: String;
   ErrMsgHostNameNotConfigured: String;
   RNID: String;
   CustGUID: String;
   PayHistGUID: String;

   procedure SetUpLocalObjectsAsNeeded();
   begin
      ADOQuery := Nil; HeaderNamesList := Nil; ColNamesOfHeadersList := Nil;
      Errors := TStringList.Create();
   end;

   procedure SetUpLocalVarAsNeeded();
   begin
      if(StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/TRANSACTIONTAB/DOWNLOADXLSCONFIG/ENABLED', 'FALSE'))) then begin
         DelimitedHeaderNames := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/TRANSACTIONTAB/DOWNLOADXLSCONFIG/DOWNLOADXLSHEADERNAMES', DOWNLOADXLSHEADERNAMES);
         DelimitedColNames := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/TRANSACTIONTAB/DOWNLOADXLSCONFIG/DOWNLOADXLSDBTBLCOLNAMES', DOWNLOADXLSHEADERNAMES);
      end else begin
         DelimitedHeaderNames := DOWNLOADXLSHEADERNAMES;
         DelimitedColNames := DOWNLOADXLSHEADERNAMES;
      end;
      SubHeaderPrefix := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/TRANSACTIONTAB/DOWNLOADXLSCONFIG/SUBROWHEADERPREFIX', 'SPSH');
      NoDataMsg := OpenXMLGetTag('/CONFIGDATA/UIPARAMS/TRANSACTIONTAB/DOWNLOADXLSCONFIG/NODATAMSG', 'NO RECORD(s) ON FILE');
      ErrMsgHostNameNotConfigured := ERRORMSGHOSTNAMENOTCONFIGURED;
      HeaderNamesList := GetAStringListFromDelimiterAndDelimitedText('|', DelimitedHeaderNames);
      ColNamesOfHeadersList := GetAStringListFromDelimiterAndDelimitedText('|', DelimitedColNames);
      ADomainConfigOpenXMLObj := Nil; SplitDetailsOpenXMLObj := Nil;
      JSON := ''; HostName := ''; ASplitDetails := ''; RNID := ''; CustGUID:= ''; PayHistGUID:= '';

      if ((HeaderNamesList = Nil) Or (ColNamesOfHeadersList = Nil)) then begin
         Errors.Add('Error @ SetUpLocalVarAsNeeded(): HeaderNamesList/ColNamesOfHeadersList = Nil');
      end;
   end;

   procedure SetUpAndOpenADOQuery(SQL:String);
   begin
      try
         ADOQuery := TADOQuery.Create(Nil);
         ADOQuery.Connection := RNDB;
         ADOQuery.SQL.Add(SQL);
         ADOQuery.Open();
      except
         on e: Exception do begin
            Errors.Add('Error @ SetUpAndOpenADOQuery(): '+ e.Message);
         end;
      end;
   end;

   function getHostNameByRNID(RNID:String):String;
   var
      HostNameXPath : String;
   begin
      HostNameXPath:= '/CONFIGDATA/UIPARAMS/TRANSACTIONTAB/SPLITTABLES/SPLITTABLE[@RNID='''+RNID+''']';
      Result := OpenXMLGetTag(HostNameXPath,'');
   end;

   function getResult():String;
   begin
      if(Errors.Count > 0) then begin
         ProcessLog(ltDebug, 'getJSONStrForTransData', Errors.CommaText);
         ProcessLog(ltDebug, 'getJSONStrForTransData', JSON);
         JSON := '{"FAILED TO ASSEMBLE EXCEL DATA":"PLEASE TRY AGAIN LATER. IF THE PROBLEM STILL PERSISTS, PLEASE CONTACT TEMPUS TECHNOLOGIES."}'; // Optional
      end;
      Result := '[' + JSON + ']';
   end;

   procedure CleanUp();
   begin
      FreeAndNil(ADOQuery); FreeAndNil(HeaderNamesList); FreeAndNil(ColNamesOfHeadersList);
      FreeAndNil(Errors); FreeAndNil(ADomainConfigOpenXMLObj); FreeAndNil(SplitDetailsOpenXMLObj);
   end;
begin
   SetUpLocalObjectsAsNeeded();
   SetUpLocalVarAsNeeded();
   SetUpAndOpenADOQuery(ASQLQuery);
   try
      if ADOQuery.RecordCount > 0 then begin
         while ((not ADOQuery.Eof) And (Errors.Count = 0)) do begin

            ASplitDetails := Trim(ADOQuery.FieldByName('SPLITDETAILS').AsString);
            RNID := Trim(ADOQuery.FieldByName('RNID').AsString);
            CustGUID := Trim(ADOQuery.FieldByName('CustomerCode').AsString);
            PayHistGUID := Trim(ADOQuery.FieldByName('PAYHISTGUID').AsString);

            if Length(ASplitDetails) = 0 then begin
               JSON := JSON + buildJSONByADOQueryHeaderAndColumnPairs(ADOQuery, HeaderNamesList, ColNamesOfHeadersList, Errors) + ',';
            end else begin
               JSON := JSON + buildJSONByADOQueryHeaderAndColumnPairs(ADOQuery, HeaderNamesList, ColNamesOfHeadersList, Errors) + ',';
               HostName := getHostNameByRNID(RNID);
               if Length(HostName) > 0 then begin
                  ADomainConfigOpenXMLObj := GetDomainConfigXMLByRNIDAndHostName(RNID, HostName);
                  SplitDetailsOpenXMLObj := GetSplitDetailsXMLByCustAndPayHistGUID(CustGUID, PayHistGUID);
                  if((ADomainConfigOpenXMLObj <> Nil) And (SplitDetailsOpenXMLObj <> Nil)) then begin
                     JSON := JSON + buildSplitXLSMainAndSubRowHeadersAsJSON(ADomainConfigOpenXMLObj, HeaderNamesList, SubHeaderPrefix, Errors) + ',';
                     JSON := JSON + buildSplitXLSMainAndSubRowBodyAsJSON(ADomainConfigOpenXMLObj, SplitDetailsOpenXMLObj, HeaderNamesList, SubHeaderPrefix, Errors) + ',';
                  end else begin
                     Errors.Add('Error @ buildJSONStrForTransData(): ADomainConfigOpenXMLObj/SplitDetailsOpenXMLObj = Nil');
                     JSON := JSON + '{"":""}' + ',';
                  end;
               end else begin
                  ErrMsgHostNameNotConfigured := StringReplace(ErrMsgHostNameNotConfigured, '^', RNID, []);
                  Errors.Add('Error @ buildJSONStrForTransData(): HostNameNotConfigured '+ErrMsgHostNameNotConfigured);
                  JSON := JSON + '{"":""}' + ',';
               end;
            end;
            ADOQuery.Next();
            FreeAndNil(ADomainConfigOpenXMLObj);
            FreeAndNil(SplitDetailsOpenXMLObj);
         end;
      end else begin
         JSON := '{"Download Result":"'+NoDataMsg+'"}';
      end;
   except
      on e: Exception do begin
            Errors.Add('Error @ getJSONStrForTransData(): '+ e.Message);
      end;
   end;
   JSON := Trim(JSON);
   if JSON[Length(JSON)] = ',' then begin
      SetLength(JSON, Length(JSON)-1);
   end;
   Result := getResult();
   CleanUp();
end;

function TCustomerInfoModule.buildJSONByADOQueryHeaderAndColumnPairs(ADOQuery: TADOQuery; HeaderList, ColList: TTTStringList; var Errors: TStringList):String;
var
   JSONData: TVarEval;
   key, value: String;
   i, l: Integer;
   IsDisplayTimeInTZ: Boolean; // 2019-4-17 ss DVST-4900
begin
   JSONData := TVarEval.Create();
   IsDisplayTimeInTZ := StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE')); // 2019-4-17 ss DVST-4900
   if HeaderList.Count <> ColList.Count then begin
      Errors.Add('Error @ getJSONByADOQueryHeaderAndColumnPairs(): Check the Domain Config''s DOWNLOADXLSHEADERNAMES and DOWNLOADXLSDBTBLCOLNAMES tag''s values. They must contain equal number of values.');
      Result := '{"":""}';
   end else begin
      l := HeaderList.Count -1;
      for i:= 0 to l do begin
         key := Trim(HeaderList[i]);
         if key = 'Name' then begin
            value := Trim(ADOQuery.FieldByName('FirstName').AsString) + ' ' +Trim(ADOQuery.FieldByName('LastName').AsString);
         end else if key = 'Payment Name' then begin
            value := Trim(ADOQuery.FieldByName('PaymentName').AsString);
            if(Length(value) = 0) then begin
               value := Trim(ADOQuery.FieldByName('CustHistDesc').AsString);
            end;
         end else if key = 'Receipt Number' then begin
            value := Trim(ADOQuery.FieldByName('RNID').AsString) + '-' + Trim(ADOQuery.FieldByName('Systemcode').AsString) + '-' + FormatDateTime('YYMMDD',ADOQuery.FieldByName('PaymentDate').AsDateTime);
         end else if key = 'Result' then begin
            value := Trim(ADOQuery.FieldByName('NonAuthReason').AsString);
            if(Length(value) = 0) then begin
               value := Trim(ADOQuery.FieldByName('ApprovalCode').AsString);
            end;
         end else if key = 'Phone Number' then begin
            key := Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERPROFILE/HOMEPHONECUSTOMLABEL', 'Phone Number'));
            value := Trim(ColList[i]);
            value := ADOQuery.FieldByName(value).AsString;
         end else if key = 'Type'  then begin
            value := Trim(ColList[i]);
            value := ADOQuery.FieldByName(value).AsString;
            if((Length(value) = 0) And (StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DEFAULTEMPTYPAYMENTTYPETOCARD','FALSE')))) then begin
               value := 'Card';
            end;
         end else if key = 'Payment Date' then begin // 2019-4-17 ss DVST-4900
            if(IsDisplayTimeInTZ) then begin
               value := ADOQuery.FieldByName('PaymentDatetz').AsString;
         end else begin
               value := Trim(ColList[i]); // PaymentDate is stored as the db column from which the get the value in DOWNLOADXLSDBTBLCOLNAMES config 
               value := ADOQuery.FieldByName(value).AsString;
            end;
         end else begin
            value := Trim(ColList[i]);
            value := ADOQuery.FieldByName(value).AsString;
         end;
         JSONData.AddValue(key, Trim(value));
      end;
      Result := JSONData.ToJSON();
   end;
   FreeAndNil(JSONData);
end;

function TCustomerInfoModule.buildEmptySubRowJSONByHeaderList(HeaderList: TTTStringList):TVarEval;
var
   JSONData: TVarEval;
   key, value: String;
   i, l: Integer;
begin
   JSONData := TVarEval.Create();
   l := HeaderList.Count - 1;
   value := '';
   for i:= 0 to l do begin
      key := Trim(HeaderList[i]);
      JSONData.AddValue(key, value);
   end;
   Result := JSONData;
end;
function TCustomerInfoModule.buildSplitXLSMainAndSubRowHeadersAsJSON(AConfigOpenXMLObj: TOpenXML; HeaderList: TTTStringList; Prefix: String; var Errors: TStringList):String;
var
   JSONData: TVarEval;
   SubRowHeaderList: TTTStringList;
   key, value: String;
   i, l : Integer;
begin
   SubRowHeaderList := Nil;
   JSONData := Nil;
   JSONData:= buildEmptySubRowJSONByHeaderList(HeaderList);
   SubRowHeaderList := GetAStringListFromDelimiterAndDelimitedText('|', Trim(AConfigOpenXMLObj.GetValueAsWideString('/CONFIGDATA/UIPARAMS/SPLITTABLE/RECEIPTTABLEHEADERS')));
   key := ''; value := '';
   if((JSONData <> Nil) And (SubRowHeaderList <> Nil)) then begin
      l:= SubRowHeaderList.Count - 1;
      for i:= 0 to l do begin
         key := Prefix + Stri((i+1), -1);
         value := SubRowHeaderList[i];
         JSONData.AddValue(Trim(key), Trim(value));
      end;
      Result := JSONData.ToJSON();
   end else begin
      Errors.Add('Error @ buildXLSMainAndSubRowHeadersAsJSON(): JSONData/SubRowHeaderList = Nil');
      Result := '{"":""}';
   end;
   FreeAndNil(JSONData);
   FreeAndNil(SubRowHeaderList)
end;

function TCustomerInfoModule.buildSplitXLSMainAndSubRowBodyAsJSON(AConfigXMLObj, ASplitDetailsXMLObj: TOpenXML; HeaderList: TTTStringList; Prefix: String; var Errors: TStringList):String;
var
   XMLTagNameList, ColDataTypeList: TTTStringList;
   JSONData: TVarEval;
   TargetXMLNode: TOPENXMLNode;
   TargetNodeXPath: String;
   i, l: Integer;
   key, value: String;
   JSON: String;
begin
   XMLTagNameList := Nil; ColDataTypeList := Nil; JSONData:= Nil; TargetXMLNode:= Nil;
   XMLTagNameList := GetAStringListFromDelimiterAndDelimitedText('|', Trim(AConfigXMLObj.GetValueAsWideString('/CONFIGDATA/UIPARAMS/SPLITTABLE/SPLITDETAILTAGS')));
   ColDataTypeList := GetAStringListFromDelimiterAndDelimitedText('|', Trim(AConfigXMLObj.GetValueAsWideString('/CONFIGDATA/UIPARAMS/SPLITTABLE/COLUMNDATATYPE')));
   TargetNodeXPath := '/SPLITDETAILS';
   key := ''; value := ''; JSON:= '';
   if ((XMLTagNameList <> Nil) And (ColDataTypeList <> Nil)) then begin
      if (XMLTagNameList.Count <> ColDataTypeList.Count) then begin
         Errors.Add('Error @ buildXLSMainAndSubRowBodyAsJSON(): XMLTagNameList.Count <> ColDataTypeList.Count');
         JSON := '{"":""}';
      end else begin
         l := XMLTagNameList.Count - 1;
         TargetXMLNode := ASplitDetailsXMLObj.GetNode(TargetNodeXPath);
         TargetXMLNode := TargetXMLNode.FindFirstChildElement();
         while (TargetXMLNode <> Nil) do begin
            JSONData := buildEmptySubRowJSONByHeaderList(HeaderList);
            if JSONData <> Nil then begin
               for i:= 0 to l do begin
                  key := Prefix + Stri((i+1), -1);
                  value := ASplitDetailsXMLObj.GetContextValueAsWideString(TargetXMLNode, Trim(XMLTagNameList[i]));
                  value := convertValueToDataType(value, Trim(ColDataTypeList[i]));
                  JSONData.AddValue(Trim(key), Trim(value));
               end;
            end else begin
               Errors.Add('Error @ buildXLSMainAndSubRowBodyAsJSON(): JSONData = Nil');
               JSON := '{"":""}';
               Break;
            end;
            JSON := JSON + JSONData.ToJSON() + ',';
            FreeAndNil(JSONData);
            TargetXMLNode := TargetXMLNode.FindNextSiblingElement();
         end;
         JSON := Trim(JSON);
         if JSON[Length(JSON)] = ',' then begin
            SetLength(JSON, Length(JSON)-1);
         end;
      end;
   end else begin
      Errors.Add('Error @ buildXLSMainAndSubRowBodyAsJSON(): XMLTagNameList/ColDataTypeList = Nil');
      JSON := '{"":""}';
   end;
   Result := JSON;
   FreeAndNil(XMLTagNameList); FreeAndNil(ColDataTypeList); FreeAndNil(JSONData);
   FreeAndNil(TargetXMLNode);
end;

function TCustomerInfoModule.convertValueToDataType(value, datatype:String): String;
begin
   if dataType = 'Cur' then begin
      Result := '$'+Trim(StriReal(ValuReal(value),2));
   end else if dataType = 'Int' then begin
      Result := value; // TODO: Future Mod
   end else if dataType = 'Str' then begin
      Result := value;
   end else begin
      Result := value;
   end;
end;

function TCustomerInfoModule.buildCustPaySchedTablsDateColsPerCustTimeZone(AScheduleGUID, SiteRNID : String):String;
var
   SQL: String;
begin
   SQL:= ''
         +'SELECT c.SITERNID'
         +' ,c.RNID'
         +' ,c.CUSTGUID'
         +' ,c.PAYSCHEDGUID'
         +' ,c.PAYMENTGUID'
         +' ,c.PAYMENTAMOUNT'
         +' ,c.NUMBEROFPAYMENTS'
         +' ,c.PAYMENTSMADE'
         +' ,c.STATUS'
         +' ,c.FREQUENCY'
         +' ,c.CHILDGUID'
         +' ,c.GrossAmount'
         +' ,c.AmountPaid'
         +' ,c.FailedPaymentCount'
         +' ,c.PaymentsRemaining'
         +' ,c.Custom1'
         +' ,c.Custom2'
         +' ,c.Custom3'
         +' ,c.Custom4'
         +' ,c.Custom5'
         +' ,c.Custom6'
         +' ,c.Custom7'
         +' ,c.Custom8'
         +' ,c.Custom9'
         +' ,c.Custom10'
         +' ,c.ExternalIntegration'
         +' ,c.FIRSTPAYMENT as FirstPayment'
         +' ,c.NEXTPAYMENT as NextPayment'
         +' ,c.COMPLETEDDATE as CompleteDate'
         +' ,c.ENDDATE as EndDate'
         +' ,CASE r.KeyValue'
               +' WHEN ''AST'''
               +' THEN DATEADD(hour, + 1, c.SCHEDULEADDED)'
               +' WHEN ''CST'''
               +' THEN DATEADD(hour, - 1, c.SCHEDULEADDED)'
               +' WHEN ''MST'''
               +' THEN DATEADD(hour, - 2, c.SCHEDULEADDED)'
               +' WHEN ''PST'''
               +' THEN DATEADD(hour, - 3, c.SCHEDULEADDED)'
               +' WHEN ''AKST'''
               +' THEN DATEADD(hour, - 4, c.SCHEDULEADDED)'
               +' WHEN ''HAST'''
               +' THEN DATEADD(hour, - '+HASTOffsetEST+', c.SCHEDULEADDED)'
               +' ELSE c.SCHEDULEADDED'
         +' END ScheduleAdded'
         +' FROM CUSTPAYSCHED c'
         +' LEFT JOIN REGISTRY r ON c.SITERNID = r.SubKey1'
         +' WHERE (siteRNID = '+SiteRNID+')'
         +' AND (PaySchedGuid = '''+AScheduleGUID+''')'
         +' AND r.SubKey2 = ''storetz''';

   Result:= SQL;
end;


function TCustomerInfoModule.IsCobraAccount(AAccountID, AAccountName: string): boolean;
begin
   result := strtobool(OpenXMLGetTag('/CONFIGDATA/COBRAACCOUNTS/ACCOUNTNUMBER[@ID=''' + trim(AAccountID) + ''']','FALSE'));
   ProcessLog(ltDebug,'IsCobraAccount value:',OpenXMLGetTag('/CONFIGDATA/COBRAACCOUNTS/ACCOUNTNUMBER[@ID=''' + trim(AAccountID) + ''']','FALSE'));
end;

function TCustomerInfoModule.VTIssueRefundToSystemcode(const AQueryFields, AContentFields: TStrings; ARNID: string): string;
var
BatchFieldNames : TStringList;
begin
   result := '';
   VarEvaluator.AddValue('GatewayRNID', NumericOnly(AQueryfields.Values['LOCATIONRNID']));
   ProcessLog(ltInfo,'Starting VTIssueRefundToSystemcode RNID;SystemCode',NumericOnly(AQueryfields.Values['LOCATIONRNID']) + ';' + NumericOnly(AQueryfields.Values['TCSYSTEMCODE']));
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEBATCHFIELDSEARCH','FALSE') = 'TRUE') then begin
      BatchFieldNames := TStringList.Create();
      BatchFieldNames.CommaText := ('TCSYSTEMCODE,TCSERVICENAME');
      if GetTCBatchFields(NumericOnly(AQueryfields.Values['LOCATIONRNID']),NumericOnly(AQueryfields.Values['TCSYSTEMCODE']),BatchFieldNames) then begin
         ProcessLog(ltInfo,'Starting VTIssueRefundToSystemcode',InstanceGUID);
         result:= IssueRefundTC(NumericOnly(AQueryfields.Values['LOCATIONRNID']),NumericOnly(AQueryfields.Values['TCSYSTEMCODE']), ValuReal(AQueryfields.Values['AMOUNT']));
         Exit;
      end else begin
         result := 'Refund could not be issued.';
      end;
   end else if GetTCBatch(NumericOnly(AQueryfields.Values['LOCATIONRNID']),NumericOnly(AQueryfields.Values['TCSYSTEMCODE']), True) then begin
      ProcessLog(ltInfo,'Starting VTIssueRefundToSystemcode',InstanceGUID);
      result := IssueRefundTC(NumericOnly(AQueryfields.Values['LOCATIONRNID']),NumericOnly(AQueryfields.Values['TCSYSTEMCODE']), ValuReal(AQueryfields.Values['AMOUNT']));
   end else begin
      result := 'Refund could not be issued.';
   end;
   FreeandNil(BatchFieldNames);
end;

procedure TCustomerInfoModule.ProcessPaymentApplePay(AResponse: TWebResponse; AQueryFields, AContentFields: TStrings; const HostName: String);
begin
   AResponse.Content := '';
end;

procedure TCustomerInfoModule.ValidateApplePaySession(AResponse: TWebResponse; AQueryFields, AContentFields: TStrings; const HostName: string);
const
   METHOD_NAME = 'TCustomerInfoModule.ValidateApplePaySession';
   APPLE_PAY_PATH = '/CONFIGDATA/EXTERNALINTEGRATION/APPLEPAY/';
   REQUEST_PATH = APPLE_PAY_PATH + 'REQUEST/PARAM[@name="%s"]';
   CERTIFICATE_PATH = APPLE_PAY_PATH + 'CERTSETTINGS/CERTIFICATE[@name="MerchantID"]/';
var
   validationURL, merchantID, displayName, domainName, merchantIDCertFriendlyName, certStore, certStoreLocation: String;
   statusCode: integer;

   RequestPacket, ResponsePacket: TJSONWriter;
   ResponseContent: TStringList;
   ApplePay: TApplePaySessionGetter;

   Function GetXMLRequestPath(const paramName: String): String;
   begin
      Result := format(REQUEST_PATH, [paramName]);
   end;
begin
   AResponse.ContentType := 'application/json';
   AResponse.Content := '';

   validationURL := AContentFields.Values['VALIDATIONURL'];
   ProcessLog(ltInfo, METHOD_NAME + ' validationURL', validationURL);
   if validationURL = '' then begin
      ResponsePacket := TJSONWriter.Create;

      with ResponsePacket do begin
         OpenObject;
         Boolean('tranSuccess', False);
         Text('tranRespMessage', 'Invalid validation URL');
         CloseObject;
         AResponse.Content := AsString;
      end;
      FreeAndNil(ResponsePacket);
      exit;
   end;

   ResponseContent := TStringList.Create;
   merchantID := OpenXMLGetTag(GetXMLRequestPath('merchantID'), 'merchant.com.tempustechnologies.websvc');
   displayName := OpenXMLGetTag(GetXMLRequestPath('displayName'), 'Tempus Technologies');

   RequestPacket := TJSONWriter.Create;
   with RequestPacket do begin
      OpenObject;
      Text('merchantIdentifier', merchantID);
      Text('domainName', HostName);
      Text('displayName', displayName);
      CloseObject;
      ProcessLog(ltInfo, METHOD_NAME + ' requestPacket', AsString);
   end;

   merchantIDCertFriendlyName := OpenXMLGetTag(CERTIFICATE_PATH + 'FRIENDLYNAME', 'Apple Pay Merchant Identity:merchant.com.tempustechnologies.websvc');
   certStore := OpenXMLGetTag(CERTIFICATE_PATH + 'CERTSTORE', 'WebHosting');

   ProcessLog(ltInfo, METHOD_NAME + ' merchantIDFriendlyName', merchantIDCertFriendlyName);
   ProcessLog(ltInfo, METHOD_NAME + ' certStore', certStore);

   ApplePay := TApplePaySessionGetter.Create(merchantIDCertFriendlyName, certStore);
   ApplePay.AppleProcessLog := ProcessLog;
   statusCode := ApplePay.GetApplePaySessionObject(validationURL, RequestPacket.AsString, ResponseContent);

   ProcessLog(ltInfo, METHOD_NAME + ' statusCode', inttostr(statusCode));
   ProcessLog(ltInfo, METHOD_NAME + ' responseContent', ResponseContent.Text);

   if statusCode = 200 then begin
      AResponse.Content := ResponseContent.Text;
   end else begin
      ProcessLog(ltWarning, METHOD_NAME, 'The ApplePay servers were unable to generate an ApplePaySession object. Check the response and configurations to make sure everything is set up properly.');

      ResponsePacket := TJSONWriter.Create;
      with ResponsePacket do begin
         OpenObject;
         Boolean('tranSuccess', False);
         Text('tranRespMessage', 'Unable to obtain ApplePaySession Object');
         CloseObject;
         AResponse.Content := AsString;
      end;
      FreeAndNil(ResponsePacket);
   end;

   FreeAndNil(RequestPacket);
   FreeAndNil(ResponseContent);
   FreeAndNil(ApplePay);
end;

procedure TCustomerInfoModule.GetStoreScheduledPayments(AResponse: TWebResponse; AContentFields, AQueryFields: TStrings; const ARNID: String; const AChainCode: integer);
var
   ChildInfo, ShowAction, ShowLinks, DisplayFormat, AdminRNID, CustName, PaymentName: String;
   DisplayAction, DisplayLinks, DisplayRNID, DisplayBalanceDue, isHTML, isXLS, isJSON: boolean;
   iterator: integer;
   GrossAmount, AmountPaid, NetAmount: double;

   HTML, JSON: TStringList;

   xExport: TOExport;
   xlsExporter: TOExporterXLT;
   xlsWorkSheet: TExportWorksheet;
   Row: TExportRow;
   xlsStream: TMemoryStream;
begin
   AResponse.CustomHeaders.Values['Cache-Control'] := 'private';
   AResponse.CustomHeaders.Values['Pragma'] := 'private';

   DisplayRNID := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/SCHEDPAYMENTDISPLAYRNID', 'FALSE'));
   DisplayBalanceDue := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/DISPLAYBALANCEDUE', 'FALSE'));

   CustName := AlphaOnly(trim(UpCaseString(AQueryFields.Values['Name'])));
   DisplayAction := strtobool(AQueryFields.Values['SHOWACTION']);
   DisplayLinks := strtobool(AQueryFields.Values['SHOWLINKS']);
   DisplayFormat := AQueryFields.Values['DISPLAYFORMAT'];

   isXLS := DisplayFormat = 'XLS';
   isJSON := DisplayFormat = 'JSON';
   isHTML := Not (isJSON or isXLS);

   AdminRNID := NumericOnly(AQueryFields.Values['RNID']); //If there is no sub account, do it on the portal account
   If AdminRNID = '' then
      AdminRNID := 'ALL'
   else if AdminRNID = 'ALL' then begin
      AdminRNID := 'ALL';  // make it use profileid
   end else begin
      if (Not ValidateRNID(AdminRNID)) then begin
         AResponse.Content := 'INVALID RNID';
         exit;
      end;
   end;

   RNQuery.Close;
   RNQuery.SQL.Clear;
   RNQuery.SQL.Add('select CustPaySched.CustGUID as CustGUID, CustPaySched.GrossAmount, CustChild.FirstName as CFN, CustChild.LastName as CLN, CustChild.AccountNumber as CAN, CustPaySched.AmountPaid,PaySchedGUID, ScheduleAdded, CustPaySched.Status, ');
   RNQuery.SQL.Add('ScheduleAdded,NextPayment,firstpayment,completeddate, Store.Name as LocName, frequency, ');

   if DisplayRNID then begin
      RNQuery.SQL.Add('Store.SystemCode as LocRNID,');
   end;

   RNQuery.SQL.Add('customers.customercode, Customers.FirstName as FN, Customers.LastName as LN, customers.accountnumber, paymentAmount, PaymentType, CardExpires, PaymentName, NumberOfPayments,paymentsremaining, PaymentsMade, ');
   RNQuery.SQL.Add('custpaysched.Custom4 as CustPaySchedCustom4  from custpaysched'); // 2019-2-13 ss DVST-3148
   RNQuery.SQL.Add('left outer join CustChild on ((CustChild.CustGUID = CustPaySched.CustGUID) And (CustChild.ChildGUID = CustPaySChed.ChildGUID))');
   RNQuery.SQL.Add('left outer join customers on ((customercode = custpaysched.custguid) and (Customers.ChainCode =' + Stri(AChainCode, -1) + '))');
   RNQuery.SQL.Add('left outer Join CustPayment on (CustPayment.CustGUID = CustPaySched.CustGUID) and (CustPayment.PaymentGUID = CustPaySched.PaymentGUID)');
   RNQuery.SQL.Add('left outer Join Store on (Store.SystemCode = CustPaySched.RNID) ');

   if AdminRNID = 'ALL' then begin
      if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/ALLOWSCHEDQUERYBYCHAINCODE', 'FALSE')) then begin
         RNQuery.SQL.Add('where customers.CHAINCODE=' + Stri(AChainCode, -1) + '');
      end else begin
         RNQuery.SQL.Add('where custpaysched.SiteRNID=' + ARNID + '');
      end;
   end else begin
      RNQuery.SQL.Add('where custpaysched.RNID=' + AdminRNID + '');
   end;

   if Trim(Request.queryfields.Values['STATUS'])= 'ACTIVE' then
      RNQuery.SQL.Add('AND CustPaySched.Status=''ACTIVE''');
   if Trim(Request.queryfields.Values['STATUS'])= 'COMPLETED' then
      RNQuery.SQL.Add('AND CustPaySched.Status=''COMPLETED''');
   if Trim(Request.queryfields.Values['STATUS'])= 'SUSPENDED' then
      RNQuery.SQL.Add('AND CustPaySched.Status=''SUSPENDED''');
   if Trim(Request.queryfields.Values['STATUS'])= 'CANCELLED' then
      RNQuery.SQL.Add('AND CustPaySched.Status=''CANCELLED''');

   if guidonly(Request.queryfields.Values['CUSTGUID']) <> '' then begin
      RNQuery.SQL.Add('AND Customers.CustomerCode = ''' + GuidOnly(AQueryfields.Values['CUSTGUID']) + '''');
   end;

   If CustName <> '' then begin
      RNQuery.SQL.Add('AND Customers.LastName like ''' + CustName + '%''');
   end;

   if ValidCharsOnly(Request.queryfields.Values['CUSTACCOUNTNUMBER'], true, true, '') <> '' then begin
      RNQuery.SQL.Add(' and (Customers.AccountNumber = ''' + ValidCharsOnly(AQueryfields.Values['CUSTACCOUNTNUMBER'], true, true, '') + ''')');
   end;

   RNQuery.SQL.Add('order by Customers.lastName');
   RNQuery.Open;

   if isXLS then begin
      xExport := TOExport.Create;
      xlsExporter := TOExporterXLT.Create;
      xlsWorkSheet := xExport.AddWorkSheet;
   end else if isJSON then begin
      JSON := TStringList.Create;
      JSON.Append('[');
   end else begin
      HTML := TStringList.Create;
   end;

   If RNQuery.RecordCount > 0 then begin
      if isXLS then begin
         Row := xlsWorkSheet.AddRow;

         if DisplayRNID then begin
            Row.AddCellString('RNID');
         end;

         Row.AddCellString('Location');
         Row.AddCellString('Status');
         Row.AddCellString('Add Date');
         Row.AddCellString('First Payment Date').SetCalculateColWidth;
         Row.AddCellString('Next Payment Date').SetCalculateColWidth;
         Row.AddCellString('Completed Date').SetCalculateColWidth;
         Row.AddCellString('Frequency');
         Row.AddCellString('First Name');
         Row.AddCellString('Last Name');
         Row.AddCellString('Account Number').SetCalculateColWidth;
         Row.AddCellString('Total Amount').SetCalculateColWidth;
         Row.AddCellString('Amount Paid').SetCalculateColWidth;
         Row.AddCellString('Amount Due').SetCalculateColWidth;
         Row.AddCellString('Payment Amount').SetCalculateColWidth;
         Row.AddCellString('Payment Type').SetCalculateColWidth;
         Row.AddCellString('Expires');
         Row.AddCellString('Payment Name');
         Row.AddCellString('Payments Scheduled').SetCalculateColWidth;
         Row.AddCellString('Payments Made').SetCalculateColWidth;
         Row.AddCellString('Payments Remaining').SetCalculateColWidth;

         For iterator := 0 to Row.Cells.Count - 1 do begin
            Row.Cells.Items[iterator].SetFontColor(clBlack).SetBorder(cbBottom).SetBGColor(TColor($80000000)).SetAlignment(cahCenter);
         end;
      end else if isHTML then begin
         HTML.Add('<TABLE class="paymenthist"><TR>');

         if DisplayRNID then begin
            HTML.Add('<th><strong>RNID</strong></th>');
         end;

         HTML.Add('<Th><B>Location</B></Th><Th><B>Next Pay</B></Th><Th><B>Freq</B></Th><Th><B>Name</B></Th><Th><B>Total</B></Th><Th><B>Paid</B></Th><Th><B>Balance</B></Th><Th><B>Each Pay</B></Th><Th><B>Type</B></Th><Th><B>Exp</B></Th> ' +
                                             '<Th><B>Payment Name</B></Th><Th><B>Sched<BR>Made<BR>Remain</B></Th>');
         If DisplayAction then begin
           HTML.Add('<Th><B>Action</B></Th><Th><B>Edit</B></Th>');
         end;
         HTML.Add('</TR>');
      end;
      While Not RNQuery.EOF do begin
         GrossAmount := RNQuery.FieldByName('GrossAmount').AsFloat;
         AmountPaid := RNQuery.FieldByName('AmountPaid').AsFloat;
         NetAmount := GrossAmount - AmountPaid;

         
         If isXLS then begin
            Row := xlsWorkSheet.AddRow;

            if DisplayRNID then begin
               Row.AddCellString(Trim(RNQuery.FieldByName('LocRNID').AsString));
            end;

            Row.AddCellString(Trim(RNQuery.FieldByName('LocName').AsString)).SetCalculateColWidth;
            Row.AddCellString(Trim(RNQuery.FieldByName('Status').AsString));
            Row.AddCellDate(RNQuery.FieldByName('ScheduleAdded').AsDateTime);
            Row.AddCellDate(RNQuery.FieldByName('firstpayment').AsDateTime);
            Row.AddCellDate(RNQuery.FieldByName('NextPayment').AsDateTime);
            Row.AddCellString(FormatDateTime('MM/DD/YY',RNQuery.FieldByName('completeddate').AsDateTime));
            Row.AddCellString(Trim(RNQuery.FieldByName('Frequency').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('FN').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('LN').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('AccountNumber').AsString));
            Row.AddCellString('$' + Trim(StriReal(GrossAmount, 2)));
            Row.AddCellString('$' + Trim(StriReal(AmountPaid, 2)));

            if NetAmount < 0 then begin
               Row.AddCellString('-$' + Trim(StriReal(NetAmount * -1, 2)));
            end else begin
               Row.AddCellString('$' + Trim(StriReal(NetAmount, 2)));
            end;

            Row.AddCellString('$' + Trim(StriReal(RNQuery.FieldByName('PaymentAmount').AsFloat, 2)));
            Row.AddCellString(Trim(RNQuery.FieldByName('PaymentType').AsString));
            Row.AddCellString(FormatDateTime('M/YY', RNQuery.FieldByName('CardExpires').AsDateTime));
            Row.AddCellString(Trim(RNQuery.FieldByName('PaymentName').AsString)).SetCalculateColWidth;
            Row.AddCellString(Trim(RNQuery.FieldByName('NumberOfPayments').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('PaymentsMade').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('PaymentsRemaining').AsString));
         end else If isJSON then begin
            if DisplayRNID then begin
               JSON.Add('{"RNID":"' + Trim(RNQuery.FieldByName('LocRNID').AsString) + '",');
            end;

            JSON.Add('"Location":"' + Trim(RNQuery.FieldByName('LocName').AsString) + '",');
            JSON.Add('"Status":"' + Trim(RNQuery.FieldByName('Status').AsString) + '",');
            JSON.Add('"Add Date":"' + FormatDateTime('MM/DD/YY',RNQuery.FieldByName('ScheduleAdded').AsDateTime) + '",');
            JSON.Add('"First Payment Date":"' + FormatDateTime('MM/DD/YY',RNQuery.FieldByName('firstpayment').AsDateTime) + '",');
            JSON.Add('"Next Payment Date":"' + FormatDateTime('MM/DD/YY',RNQuery.FieldByName('NextPayment').AsDateTime) + '",');
            JSON.Add('"Completed Date":"' + FormatDateTime('MM/DD/YY',RNQuery.FieldByName('completeddate').AsDateTime) + '",');
            JSON.Add('"Frequency":"' + Trim(RNQuery.FieldByName('Frequency').AsString) + '",');
            JSON.Add('"First Name":"' + Trim(RNQuery.FieldByName('FN').AsString) + '",');
            JSON.Add('"Last Name":"' + Trim(RNQuery.FieldByName('LN').AsString) + '",');
            JSON.Add('"Account Number":"' + Trim(RNQuery.FieldByName('AccountNumber').AsString) + '",');
            JSON.Add('"Total Amount":"' + '$' + Trim(StriReal(GrossAmount, 2)) + '",');
            JSON.Add('"Amount Paid":"' + '$' + Trim(StriReal(AmountPaid, 2)) + '",');

            if NetAmount < 0 then begin
               JSON.Add('"Amount Due":"' + '-$' + Trim(StriReal(NetAmount * -1, 2)) + '",');
            end else begin
               JSON.Add('"Amount Due":"' + '$' + Trim(StriReal(NetAmount, 2)) + '",');
            end;

            JSON.Add('"Payment Amount":"' + '$' + Trim(StriReal(RNQuery.FieldByName('PaymentAmount').AsFloat, 2)) + '",');
            JSON.Add('"Payment Type":"' + Trim(RNQuery.FieldByName('PaymentType').AsString) + '",');
            JSON.Add('"Expires":"' + FormatDateTime('M/YY', RNQuery.FieldByName('CardExpires').AsDateTime) + '",');
            JSON.Add('"Payment Name":"' + Trim(RNQuery.FieldByName('PaymentName').AsString) + '",');
            JSON.Add('"Payments Scheduled":"' + Trim(RNQuery.FieldByName('NumberOfPayments').AsString) + '",');
            JSON.Add('"Payments Made":"' + Trim(RNQuery.FieldByName('PaymentsMade').AsString) + '",');
            JSON.Add('"Payments Remaining":"' + Trim(RNQuery.FieldByName('PaymentsRemaining').AsString) + '"');
            JSON.Add('}');
         end else begin
            HTML.Add('<tr ID="' + Trim(RNQuery.FieldByName('PaySchedGUID').AsString) + '">');

            if DisplayRNID then begin
               HTML.Add('<td>' + Trim(RNQuery.FieldByName('LocRNID').AsString) + '</td>');
            end;

            HTML.Add('<td>' + Trim(RNQuery.FieldByName('LocName').AsString) + '</td>');
            if Trim(RNQuery.FieldByName('Status').AsString) = 'COMPLETED' then
               HTML.Add('<td align="CENTER" bgcolor=#C0C0C0>Completed</td>')
            else if Trim(RNQuery.FieldByName('Status').AsString) = 'SUSPENDED' then
               HTML.Add('<td align="CENTER" bgcolor=#FF0000>Suspended</td>')
            else if Trim(RNQuery.FieldByName('Status').AsString) = 'CANCELLED' then
               HTML.Add('<td align="CENTER" bgcolor=#900000>Cancelled</td>')
            else
               HTML.Add('<td align="CENTER" bgcolor=#00FF00>' + FormatDateTime('MM/DD/YY',RNQuery.FieldByName('NextPayment').AsDateTime) + '</td>');

            HTML.Add('<td>' + Trim(RNQuery.FieldByName('Frequency').AsString) + '</td>');
            HTML.Add('<td>');
            If DisplayLinks then begin
               HTML.Add('<a href="javascript:GetCustomerProfile(''' + Trim(RNQuery.FieldByName('CustomerCode').AsString) + ''')">');
            end;
            HTML.Add(Trim(RNQuery.FieldByName('FN').AsString) + ' ' + Trim(RNQuery.FieldByName('LN').AsString));
            If DisplayLinks then begin
               HTML.Add('</A>');
            end;
            ChildInfo := Trim(RNQuery.FieldByName('CFN').AsString) + ' ' + Trim(RNQuery.FieldByName('CLN').AsString) + ' ' + Trim(RNQuery.FieldByName('CAN').AsString);
            If ChildInfo <> '' then HTML.Add('<BR>' + ChildInfo);

            HTML.Add('</td>');
            HTML.Add('<td align="RIGHT">$' + Trim(StriReal(GrossAmount, 2)) + '</td>');
            HTML.Add('<td align="RIGHT">$' + Trim(StriReal(AmountPaid, 2)) + '</td>');
            HTML.Add('<td align="RIGHT">$' + Trim(StriReal(NetAmount, 2)) + '</td>');

            if DisplayBalanceDue AND (Trim(RNQuery.FieldByName('CustPaySchedCustom4').AsString) = 'balanceDue') then begin // 2019-2-13 ss DVST-3842
               HTML.Add('<td align="RIGHT">On Current Balance Due</td>');
            end else begin
               HTML.Add('<td align="RIGHT">$' + Trim(StriReal(RNQuery.FieldByName('PaymentAmount').AsFloat, 2)) + '</td>'); // 2019-2-13 ss DVST-3148
            end;

            HTML.Add('<td>' + Trim(RNQuery.FieldByName('PaymentType').AsString) + '</td>');  // 2019-2-13 ss DVST-3148

            If RNQuery.FieldByName('CardExpires').AsDateTime > 0 then begin // 2019-2-13 ss DVST-3148
               If LastDayOfMonthOfDate(RNQuery.FieldByName('CardExpires').AsDateTime) < Date then begin
                  HTML.Add('<td bgcolor=#FF0000>' + FormatDateTime('M/YY', RNQuery.FieldByName('CardExpires').AsDateTime) + '</td>');   //expired
               end else begin
                  HTML.Add('<td bgcolor=#00FF00>' + FormatDateTime('M/YY', RNQuery.FieldByName('CardExpires').AsDateTime) + '</td>');
               end;
            end else begin
               HTML.Add('<td></td>');
            end;

            PaymentName := Trim(RNQuery.FieldByName('PaymentName').AsString);
            ReplaceString(PaymentName, '*', '');
            HTML.Add('<td>' + PaymentName + '</td>');

            HTML.Add('<td align="RIGHT">' + Trim(RNQuery.FieldByName('NumberOfPayments').AsString) + '/' +
                                                   Trim(RNQuery.FieldByName('PaymentsMade').AsString) + '/' +
                                                   Trim(RNQuery.FieldByName('PaymentsRemaining').AsString) + '</td>');
            If DisplayAction then begin
               HTML.Add('<td align="center"><a name="RemoveSchedPay" href="" OnClick="RemoveScheduledPayment(''' + Trim(RNQuery.FieldByName('PaySchedGUID').AsString) + '''); return false;">' +
                                       '<IMG alt="Remove Payment" name="RemovePayIcon"  SRC="/Images/General/CalendarDelete.png" border="0"></a></td>');
               HTML.Add('<td align="center"><a name="RemoveSchedPay" href="" OnClick="GetCustomerScheduleEditorAJAX(''' + Trim(RNQuery.FieldByName('CustGUID').AsString) + ''',''' +
                                       Trim(RNQuery.FieldByName('PaySchedGUID').AsString) + '''); return false;">' +
                                       '<IMG alt="Remove Payment" name="RemovePayIcon"  SRC="/Images/General/CalendarEdit.png" border="0"></a></td>');
            end;
            HTML.Add('</tr>');
         end;
         RNQuery.Next;
         if (NOT RNQuery.EOF) AND (DisplayFormat = 'JSON') then JSON.Add(',')
         else if (RNQuery.EOF) AND isHTML then HTML.Add('</TABLE>');
      end;
   end else begin
      if isHTML then begin
         HTML.Add('<BR><BR><B><CENTER>**NO SCHEDULED PAYMENTS ON FILE**</B></CENTER><BR>');
      end;
   end;

   if isXLS then begin
      AResponse.CustomHeaders.Values['Content-Disposition'] := 'attachment; filename=ScheduledPayments-' + FormatDateTime('YYYYMMDDHHNNSS', now) + '.xls';
      xlsStream := TMemoryStream.Create();

      xExport.SaveToStream(xlsStream, xlsExporter);
      xlsStream.Position := 0;

      AResponse.ContentStream := xlsStream;
      AResponse.ContentType := 'application/vnd.ms-excel';

      FreeAndNil(Row);
      FreeAndNil(xlsWorkSheet);
      FreeAndNil(xExport);
      FreeAndNil(xlsExporter);
   end else if isJSON then begin
      JSON.Add(']');
      AResponse.Content := TextWithoutNewLine(JSON); // Sends the complete JSONString back with a closing square bracket
      AResponse.ContentType := 'application/json';
      FreeAndNil(JSON);
   end else begin
      AResponse.Content := HTML.Text;
      AResponse.ContentType := 'text/html';
      FreeAndNil(HTML);
   end;
end;

procedure TCustomerInfoModule.GetStorePaymentHistory(AResponse: TWebResponse; AContentFields, AQueryFields: TStrings; const ARNID, AHASTOffsetEST: String; const AChainCode: integer);
const
   METHOD_NAME = 'TCustomerInfoModule.GetStorePaymentHistory';
var
   CustName, AdminRNID, DisplayFormat, ChildInfo: String;
   IsDisplayTimeInTZ, DisplayRNID, DisplayStoreName, isXLS, isJSON, isHTML: boolean;
   iterator: integer;

   JSON, HTML: TStringList;
   
   xExport: TOExport;
   xlsExporter: TOExporterXLT;
   xlsWorkSheet: TExportWorksheet;
   Row: TExportRow;
   xlsStream: TMemoryStream;
begin
   AResponse.CustomHeaders.Values['Cache-Control'] := 'private';
   AResponse.CustomHeaders.Values['Pragma'] := 'private';

   IsDisplayTimeInTZ := StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYINTZ', 'FALSE')); // 2019-4-17 ss DVST-4900
   DisplayRNID := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/TRANSACTIONSDISPLAYRNID', 'FALSE'));
   DisplayStoreName := strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/TRANSACTIONSDISPLAYSTORENAME', 'FALSE'));

   ProcessLog(ltdebug, METHOD_NAME, 'DisplayRNID: ' + booltostr(DisplayRNID));
   ProcessLog(ltdebug, METHOD_NAME, 'DisplayStoreName: ' + booltostr(DisplayStoreName));

   AdminRNID := NumericOnly(AQueryFields.Values['RNID']);
   DisplayFormat := AQueryFields.Values['DISPLAYFORMAT'];

   isXLS := DisplayFormat = 'XLS';
   isJSON := DisplayFormat = 'JSON';
   isHTML := NOT (isXLS or isJSON);

   If AdminRNID = '' then AdminRNID := ARNID;
   if Trim(AQueryfields.Values['RNID'])= 'ALL' then begin
      AdminRNID := 'ALL';  // make it use profileid
   end else begin
      if Not ValidateRNID(AdminRNID) then begin
         AResponse.Content := 'INVALID RNID';
         exit;
      end;
   end;

   if IsDisplayTimeInTZ then begin // 2019-4-17 ss DVST-4900
      BuildTransactionTabSQLInTZ(AQueryFields, RNQuery, AChainCode, AHASTOffsetEST, AdminRNID, ARNID, DisplayRNID, DisplayStoreName);
   end else begin
      BuildTransactionTabSQL(AQueryFields, RNQuery, AChainCode, AdminRNID, ARNID, DisplayRNID, DisplayStoreName);
   end;
   ProcessLog(ltdebug, METHOD_NAME, RNQuery.SQL.Text);
   RNQuery.Open;

   ProcessLog(ltdebug, METHOD_NAME, 'RNQuery Opened');

   if isXLS then begin
      xExport := TOExport.Create;
      xlsWorkSheet := xExport.AddWorkSheet;
   end else if isJSON then begin
      JSON := TStringList.Create;
      JSON.Append('[');
   end else begin
      HTML := TStringList.Create;
   end;
   
   If (RNQuery.RecordCount > 0) And ((Length(DisplayFormat) <> 0) Or NOT StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYTRANSACTIONASGRID', 'FALSE'))) then begin // 2019-1-16 SS DVST-3660
      ProcessLog(ltdebug, METHOD_NAME, 'Record Count > 0');
      If isXLS then begin
         Row := xlsWorkSheet.AddRow;

         if DisplayRNID then Row.AddCellString('RNID');
         if DisplayStoreName then Row.AddCellString('Location');

         Row.AddCellString('Payment Date');
         Row.AddCellString('First Name').SetCalculateColWidth;
         Row.AddCellString('Last Name' ).SetCalculateColWidth;
         Row.AddCellString('Account Number').SetCalculateColWidth;
         Row.AddCellString('Order First Name').SetCalculateColWidth;
         Row.AddCellString('Order Last Name').SetCalculateColWidth;
         Row.AddCellString('Order Number').SetCalculateColWidth;
         Row.AddCellString('Payment Amount').SetCalculateColWidth;
         Row.AddCellString('Payment Name');
         Row.AddCellString('Receipt Number');
         Row.AddCellString('Approval Code').SetCalculateColWidth;
         Row.AddCellString('Failure Reason').SetCalculateColWidth;

         if StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERSEARCH/INCLUDESPLITPAYMENTDETAILS', 'FALSE')) then begin // 2018-12-19 ss: DVST-3056
            Row.AddCellString('Split Payment Details').SetCalculateColWidth;
         end;

         For iterator := 0 to Row.Cells.Count - 1 do begin
            Row.Cells.Items[iterator].SetFontColor(clBlack).SetBorder(cbBottom).SetBGColor(TColor($80000000)).SetAlignment(cahCenter);
         end;
      end else if isHTML then begin
         ProcessLog(ltdebug, METHOD_NAME, 'HTML Header Build Start');
         HTML.Add('<table class="paymenthist"><tr>');

         if DisplayRNID then HTML.Add('<th><strong>RNID</strong></th>');
         if DisplayStoreName then HTML.Add('<th><strong>Location</strong></th>');

         HTML.Add('<th><strong>Payment Date</strong></th><th><strong>Name</strong></th><th><strong>Amount</strong></th><th><strong>Type</strong></th><th><strong>Payment Name</strong></th><th><strong>Receipt Number</strong></th>');
         If NOT strtobool(AQueryFields.Values['SUPRESSDECLINES']) then begin
            HTML.Add('<th><strong>Result</strong></th>');
         end;
         HTML.Add('</tr>');
         ProcessLog(ltdebug, METHOD_NAME, 'HTML Header Build End');
      end;
      While Not RNQuery.EOF do begin // 2019-1-16 ss: DVST-3660
         If isXLS then begin
            Row := xlsWorkSheet.AddRow;

            if DisplayRNID then Row.AddCellString(Trim(RNQuery.FieldByName('StoreSystemCode').AsString));
            if DisplayStoreName then Row.AddCellString(Trim(RNQuery.FieldByName('StoreName').AsString));

            if IsDisplayTimeInTZ then begin // 2019-4-17 ss DVST-4900
               Row.AddCellString(Trim(RNQuery.FieldByName('PaymentDatetz').AsString)).SetCalculateColWidth;
            end else begin
               Row.AddCellString(Trim(RNQuery.FieldByName('PaymentDate').AsString)).SetCalculateColWidth;
            end;
            Row.AddCellString(Trim(RNQuery.FieldByName('FirstName').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('LastName').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('AccountNumber').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('ChildFirstName').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('ChildLastName').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('ChildAccountNumber').AsString));
            Row.AddCellString(Format('%m', [RNQuery.FieldByName('PaymentAmount').AsFloat]));
            Row.AddCellString(Trim(RNQuery.FieldByName('PaymentName').AsString)).SetCalculateColWidth;
            Row.AddCellString(Trim(RNQuery.FieldByName('RNID').AsString) + '-' + Trim(RNQuery.FieldByName('Systemcode').AsString) + '-' + FormatDateTime('YYMMDD',RNQuery.FieldByName('PaymentDate').AsDateTime)).SetCalculateColWidth;
            Row.AddCellString(Trim(RNQuery.FieldByName('ApprovalCode').AsString));
            Row.AddCellString(Trim(RNQuery.FieldByName('NonAuthReason').AsString));
            if StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERSEARCH/INCLUDESPLITPAYMENTDETAILS', 'FALSE')) then begin // 2018-12-19 ss: DVST-3056
               Row.AddCellString(Trim(RNQuery.FieldByName('SPLITDETAILS').AsString));
            end;
         end else if isJSON then begin
            if StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/TRANSACTIONTAB/DOWNLOADXLSCONFIG/ENABLED', 'FALSE')) then begin // 2019-1-16 SS DVST-3660 - If DisplayFormat is JSON and if DOWNLOADXLSCONFIG is Enabled which refers to getting the json along with split payments, the idea is to break out of this while loop and build the JSON later when we are setting Respons's content
               break;
            end;
            JSON.Add('{');
            if DisplayRNID then JSON.Add('"RNID":"' + Trim(RNQuery.FieldByName('StoreSystemCode').AsString) + '",');
            if DisplayStoreName then JSON.Add('"Location":"' + Trim(RNQuery.FieldByName('StoreName').AsString) + '",');

            if IsDisplayTimeInTZ then begin // 2019-4-17 ss DVST-4900
               JSON.Add('"Payment Date":"' + Trim(RNQuery.FieldByName('PaymentDatetz').AsString) + '",');
            end else begin
               JSON.Add('"Payment Date":"' + Trim(RNQuery.FieldByName('PaymentDate').AsString) + '",');
            end;
            JSON.Add('"First Name":"' + Trim(RNQuery.FieldByName('FirstName').AsString) + '",');
            JSON.Add('"Last Name":"' + Trim(RNQuery.FieldByName('LastName').AsString) + '",');
            JSON.Add('"Account Number":"' + Trim(RNQuery.FieldByName('AccountNumber').AsString) + '",');
            JSON.Add('"Order First Name":"' + Trim(RNQuery.FieldByName('ChildFirstName').AsString) + '",');
            JSON.Add('"Order Last Name":"' + Trim(RNQuery.FieldByName('ChildLastName').AsString) + '",');
            JSON.Add('"Order Number":"' + Trim(RNQuery.FieldByName('ChildAccountNumber').AsString) + '",');
            JSON.Add('"Payment Amount":"' + Format('%m', [RNQuery.FieldByName('PaymentAmount').AsFloat]) + '",');
            JSON.Add('"Payment Name":"' + Trim(RNQuery.FieldByName('PaymentName').AsString) + '",');
            JSON.Add('"Receipt Number":"' + Trim(RNQuery.FieldByName('RNID').AsString) + '-' + Trim(RNQuery.FieldByName('Systemcode').AsString) + '-' + FormatDateTime('YYMMDD',RNQuery.FieldByName('PaymentDate').AsDateTime) + '",');
            JSON.Add('"Approval Code":"' + Trim(RNQuery.FieldByName('ApprovalCode').AsString) + '",');
            JSON.Add('"Failure Reason":"' + Trim(RNQuery.FieldByName('NonAuthReason').AsString) + '"');
            if StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINCUSTOMERSEARCH/INCLUDESPLITPAYMENTDETAILS', 'FALSE')) then begin // 2018-12-19 ss: DVST-3056
               JSON.Add(',' +'"Split Payment Details":"' + Trim(RNQuery.FieldByName('SPLITDETAILS').AsString) + '"}');
            end else begin
               JSON.Add('}');
            end;
         end else begin
            HTML.Add('<tr>');
            if DisplayRNID then HTML.Add('<td>' + Trim(RNQuery.FieldByName('StoreSystemCode').AsString) + '</td>');
            if DisplayStoreName then HTML.Add('<td>' + Trim(RNQuery.FieldByName('StoreName').AsString) + '</td>');

            if IsDisplayTimeInTZ then begin // 2019-4-17 ss DVST-4900
               HTML.Add('<td>' + Trim(RNQuery.FieldByName('PaymentDatetz').AsString) + '</td>');
            end else begin
               HTML.Add('<td>' + Trim(RNQuery.FieldByName('PaymentDate').AsString) + '</td>');
            end;

            HTML.Add('<td><a href="javascript:GetCustomerProfile(''' + Trim(RnQuery.FieldByName('CustomerCode').AsString) + ''')"> ' +
                        Trim(Trim(RNQuery.FieldByName('FirstName').AsString) + ' ' + Trim(RNQuery.FieldByName('LastName').AsString) + '</a>' + Trim(RNQuery.FieldByName('AccountNumber').AsString)));
                        
            ChildInfo := Trim(Trim(RNQuery.FieldByName('ChildFirstName').AsString) + ' ' + Trim(RNQuery.FieldByName('ChildLastName').AsString) + ' ' + Trim(RNQuery.FieldByName('ChildAccountNumber').AsString));
            If ChildInfo <> '' then HTML.Add('<br>' + ChildInfo);

            HTML.Add('</td><td align="right">$' + Trim(StriReal(RNQuery.FieldByName('PaymentAmount').AsFloat, 2)) + '</td><td>' + Trim(RNQuery.FieldByName('PaymentType').AsString) + '</td>');
            If Trim(RNQuery.FieldByName('PaymentName').AsString) <> '' then HTML.Add('<td align="left">' + RNQuery.FieldByName('PaymentName').AsString + '</td>')
            else HTML.Add('<td align="left">' + Trim(RNQuery.FieldByName('CustHistDesc').AsString)+ '</td>');

            HTML.Add('<td align="right">' + Trim(RNQuery.FieldByName('RNID').AsString) + '-' + Trim(RNQuery.FieldByName('Systemcode').AsString) + '-' + FormatDateTime('YYMMDD',RNQuery.FieldByName('PaymentDate').AsDateTime) + '</td>');
            If NOT strtobool(AQueryfields.Values['SUPRESSDECLINES']) then begin
               If Trim(RNQuery.FieldByName('NonAuthReason').AsString) <> '' then HTML.Add('<td bgcolor=#FF0000>' + Trim(RNQuery.FieldByName('NonAuthReason').AsString) + '</td>')
               else HTML.Add('<td bgcolor=#00FF00>' + Trim(RNQuery.FieldByName('ApprovalCode').AsString) + '</td>');
            end;

            HTML.Add('</tr>');
         end;
         RNQuery.Next;
         if (NOT RNQuery.EOF) and isJSON then JSON.Add(',')
         else if RNQuery.EOF and isHTML then HTML.Add('</table>');
      end;
   end else begin
      ProcessLog(ltdebug, METHOD_NAME, 'No Records');
      if isHTML then begin
         HTML.Add('<strong>**NO PAYMENT HISTORY ON FILE**</strong>');
      end;
   end;
   If isXLS then begin
      Response.CustomHeaders.Values['Content-Disposition'] := 'attachment; filename=StorePaymentHistory-' + FormatDateTime('YYYYMMDDHHNNSS',now) + '.xls';
      xlsStream := TMemoryStream.Create();

      xlsExporter := TOExporterXLT.Create;
      xExport.SaveToStream(xlsStream, xlsExporter);
      xlsStream.Position := 0;

      AResponse.ContentStream := xlsStream;
      AResponse.ContentType := 'application/vnd.ms-excel';

      FreeAndNil(Row);
      FreeAndNil(xlsWorksheet);
      FreeAndNil(xExport);
      FreeAndNil(xlsExporter);
   end else if isJSON then begin
      if StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/TRANSACTIONTAB/DOWNLOADXLSCONFIG/ENABLED', 'FALSE')) then begin // 2019-1-16: SS DVST-3660
         ProcessLog(ltDebug, 'GETSTOREPAYMENTHISTORY', 'BEFORE CALL TO buildJSONStrForTransData');
         AResponse.Content := buildJSONStrForTransData(RNQuery.SQL.Text);
      end else begin
         JSON.Add(']');
         AResponse.Content := TextWithoutNewLine(JSON);
      end;
      AResponse.ContentType := 'application/json';
      FreeAndNil(JSON);
   end else begin
      if StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/DISPLAYTRANSACTIONASGRID', 'FALSE')) then begin // 2018-12-19 ss: DVST-3056 Either return trans hist data as html table or xml based on config setup using DISPLAYTRANSACTIONASGRID
         ProcessLog(ltDebug, 'PAGE GETSTOREPAYMENTHISTORY', 'DISPLAYTRANSACTIONASGRID = TRUE. BEGIN Calling GetTransHistoryGridDataAsXML to get grid data as xml.');
         AResponse.Content := GetTransHistoryGridDataAsXML(RNQuery.SQL.Text, Request.QueryFields, DisplayRNID, DisplayStoreName); //TODO: work with sudipta on this
         AResponse.ContentType := 'application/xml';
         ProcessLog(ltDebug, 'PAGE GETSTOREPAYMENTHISTORY', 'END Calling GetTransHistoryGridDataAsXML to get grid data as xml.');
      end else begin
         ProcessLog(ltdebug, METHOD_NAME, 'Begin Wrapping up HTML export');
         AResponse.Content := HTML.Text;
         AResponse.ContentType := 'text/html';
      end;
      FreeAndNil(HTML);
   end;   
end;

function TCustomerInfoModule.PaymentReceipt(const AQueryFields, AContentFields: TStrings; const ARNID: string; out ContentType: string): string;
const
   GET_RECEIPT = 'SELECT * FROM CUSTPAYMENTHISTORY LEFT OUTER JOIN CUSTOMERS ON (CUSTPAYMENTHISTORY.CustGUID = Customers.CustomerCode) and (Customers.StoreCode = :RNID) ' +
                  'WHERE CUSTPAYMENTHISTORY.PayHistGUID = :PayHistGUID';
var
   payHistGUIDPOST, payHistGUID, responseStr : string;

   nameOnReceipt, payDate, payAmt, splitTable, receiptAddress, receiptNum, receiptSchool, receiptRNID: string;

   procedure setFunctionScopeVariables;
   begin
      nameOnReceipt := RNQuery.FieldByName('FirstName').AsString + ' ' +RNQuery.FieldByName('LastName').AsString + ' ';
      payDate := RNQuery.FieldByName('PaymentDate').AsString;
      payAmt := '$' + Trim(StriReal(RNQuery.FieldByName('PaymentAMount').AsFloat, 2));
      receiptAddress := (RNQuery.FieldByName('ADDRESS').AsString + ' ' + RNQuery.FieldByName('City').AsString + ', ' + RNQuery.FieldByName('State').AsString +  ' ' + RNQuery.FieldByName('ZIP').AsString);
      receiptNum := Trim(RNQuery.FieldByName('RNID').AsString) + '-' + Trim(RNQuery.FieldByName('SystemCode').AsString) + '-' + FormatDateTime('YYMMDD', RNQuery.FieldByName('PaymentDate').AsDateTime);
      receiptSchool := StoreName + ' ' + StoreAddress1 + ', ' + StoreCity + ', ' + StoreState;
      receiptRNID := RNQuery.FieldByName('RNID').AsString;
   end;

   function buildHTMResp: string;
   var
      htmFile: string;
   begin
      htmFile := LoadWebFileFromFolder('receipt.htm', '');
      ReplaceString(htmFile, '%NAME%', nameOnReceipt);
      ReplaceString(htmFile, '%PAYDATE%', payDate);
      ReplaceString(htmFile, '%PAYAMOUNT%', payAmt);
      ReplaceString(htmFile, '%SPLITTABLE%', GenerateSplitTable(RNQuery.FieldByName('SplitDetails').AsString));
      ReplaceString(htmFile, '%ADDRESS%', receiptAddress);
      ReplaceString(htmFile, '%CUSTOM1%', RNQuery.FieldByName('Custom1').AsString);
      ReplaceString(htmFile, '%CUSTOM2%', RNQuery.FieldByName('Custom2').AsString);
      ReplaceString(htmFile, '%CUSTOM3%', RNQuery.FieldByName('Custom3').AsString);
      ReplaceString(htmFile, '%CUSTOM4%', RNQuery.FieldByName('Custom4').AsString);
      ReplaceString(htmFile, '%CUSTOM5%', RNQuery.FieldByName('Custom5').AsString);
      ReplaceString(htmFile, '%CUSTOM6%', RNQuery.FieldByName('Custom6').AsString);
      ReplaceString(htmFile, '%CUSTOM7%', RNQuery.FieldByName('Custom7').AsString);
      ReplaceString(htmFile, '%CUSTOM8%', RNQuery.FieldByName('Custom8').AsString);
      ReplaceString(htmFile, '%CUSTOM9%', RNQuery.FieldByName('Custom9').AsString);
      ReplaceString(htmFile, '%CUSTOM10%', RNQuery.FieldByName('Custom10').AsString);
      ReplaceString(htmFile, '%RECEIPTNUM%', receiptNum);

      ValidateRNID(receiptRNID);

      ReplaceString(htmFile, '%SCHOOL%', receiptSchool);
      Result := htmFile;
   end;
   function buildJSONResp: string;
   const JSON_RESP = '{' +
                        '"payDate": "%s",' +
                        '"payNumber": "%s",' +
                        '"payAmt": "%s",' +
                        '"transuccess": %s,' +
                        '"tranrespmessage": "%s"' +
                      '}';
   begin
      Result := format(JSON_RESP, [payDate, receiptNum, payAmt, 'true', 'Receipt info successfully obtained']);
   end;
begin
   payHistGUID := GuidOnly(AQueryFields.Values['PAYHISTGUID']);
   payHistGUIDPOST := GuidOnly(AContentFields.Values['PAYHISTGUID']);
   if payHistGUIDPOST <> '' then payHistGUID := payHistGUIDPOST;

   ValidateRNID(ARNID);

   RNQuery.Close;
   RNQuery.SQL.Clear;
   RNQuery.SQL.Add(GET_RECEIPT);
   RNQuery.Parameters.ParamByName('RNID').Value := ARNID;
   RNQuery.Parameters.ParamByName('PayHistGUID').Value := payHistGUID;
   RNQuery.Prepared := True;
   RNQuery.Open;

   VarEvaluator.AddDSCurrentRecord(RNQuery, 'custpaymenthistory');

   setFunctionScopeVariables;
   if strtobool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/CUSTRECEIPT/USEJSONRESP', 'FALSE')) then begin
      ContentType := 'text/javascript';
      Result := buildJSONResp;
   end else begin
      ContentType := 'text/html';
      Result := buildHTMResp;
   end;
end;

function TCustomerInfoModule.GetPortalConfig(const AQueryFields, AContentFields: TStrings; const ARNID: string): string;
const
   TAB_XPATH = '/CONFIGDATA/TAB[@name="%s"]';
var   
   ParentTag, Tab, FormattedXPath: String;
begin
   Result := '';
   ParentTag := ValidCharsOnly(AContentFields.Values['ParentTag'], true, false, '');
   Tab := ValidCharsOnly(AContentFields.Values['Tab'], true, false, '');

   if (ParentTag = 'TAB') then begin
      FormattedXPath := format(TAB_XPATH, [Tab]);
      Result := DomainConfigXML.GetXPathNodeASXMLString(FormattedXPath, true);
   end;
end;

function TCustomerInfoModule.GetDHTMLXForm(const AQueryFields, AContentFields: TStrings; const ARNID: string): string;
const
   FILE_PATH = 'DHTMLXFORM/';
var
   formFileName, postFileName: string;
begin
   formFileName := AQueryFields.Values['FileName'];
   postFileName := AContentFields.Values['FileName'];
   if (postFileName <> '') then formFileName := postFileName;

   Result := LoadWebFileFromFolder(FILE_PATH + formFileName, '');
end;

function TCustomerInfoModule.IssueRefundTC(RNID, BatchSystemCode: String; Amount: Currency): String;
var
   BDR : String;
   EmpIdent : string;
Begin
   Result := '';

   if Not ValidateRNID(RNID) then exit;

   BDR := '<TRANSACTION> <RNID>'+RNID+'</RNID>' +
          '<TRANSACTIONTYPE>TCREFUND</TRANSACTIONTYPE>' +
          '<ENCODING>UTF-8</ENCODING>' +
          '<TCREFUNDAMT>' + Trim(StriReal(Amount,2)) + '</TCREFUNDAMT>' +
          '<STATIONIDENT>WEBSITE</STATIONIDENT>' +

          '<TCSYSTEMCODE>' + BatchSystemCode + '</TCSYSTEMCODE>';
          

   if (OpenXMLGetTag('/CONFIGDATA/APPSERVERSI', '') <> '') then begin
      BDR := BDR + '<SOLUTIONIDENT>' + trim(OpenXMLGetTag('/CONFIGDATA/APPSERVERSI')) + '</SOLUTIONIDENT>';
   end;

   if (GetXMLTag(BatchXML,'TCSERVICENAME') <> '') then begin
      BDR := BDR + '<SERVICENAME>' + GetXMLTag(BatchXML,'TCSERVICENAME') + '</SERVICENAME>';
   end;

   EmpIdent := '';
   if ((OpenXMLGetTag('/CONFIGDATA/SENDEMPIDENT', '') = 'TRUE') and
   ((SessionVarEval.GetValueAsString('Session.Username') <> '') or (ExternalXMLGetTag('/EXTERNALXML/USERNAME') <> ''))) then begin
      EmpIdent := SessionVarEval.GetValueAsString('Session.Username');
      if EmpIdent = '' then EmpIdent := trim(ExternalXMLGetTag('/EXTERNALXML/USERNAME'));
      ProcessLog(ltInfo,'ProcessPortalPayment EmpIdent', EmpIdent);
      if (EmpIdent <> '') then begin
         BDR := BDR + '<EMPIDENT>'+EmpIdent+'</EMPIDENT>';
      end;
   end;

   BDR := BDR + ' </TRANSACTION>'+CRLF;
   VarEvaluator.AddValue('GatewayRNID',RNID);
   ProcessPPSAPIXML(BDR, BatchXML,GetAppServerHost,0);
   Result := Utility.GetXMLTag(BatchXML,'TRANRESPMESSAGE');
end;

procedure TCustomerInfoModule.AdjustPaymetByCustGUIDAndPaymentAmount(CustGUID, Amount: String); // 2019-2-13 ss DVST-3840
const
   SQL = 'SELECT BALANCEDUE FROM CUSTOMERS WHERE CUSTOMERCODE = :custCode';
var
   ADOQuery: TADOQuery;
   CustGUIDParam: TParameter;
   BalanceDue, AmountAsCurr: Currency;
begin
   ProcessLog(ltDebug,'AdjustPaymetByCustGUIDAndPaymentAmount()', 'CustGUID: '+CustGUID);
   AmountAsCurr := ValCurr(Amount);
   ProcessLog(ltDebug,'AdjustPaymetByCustGUIDAndPaymentAmount()', 'AmountAsCurr: '+StriCurr(AmountAsCurr));
   ADOQuery := Nil; CustGUIDParam := Nil;

   ADOQuery := TADOQuery.Create(Nil);
   ADOQuery.Connection := RNDB; 
   ADOQuery.SQL.Add(SQL);

   CustGUIDParam:= ADOQuery.Parameters.ParamByName('custCode');
   CustGUIDParam.DataType := ftString;
   CustGUIDParam.Value := CustGUID;

   try
      ADOQuery.Prepared := True;
      ADOQuery.Open();
      BalanceDue := ADOQuery.FieldByName('BALANCEDUE').AsCurrency;
      ProcessLog(ltDebug,'AdjustPaymetByCustGUIDAndPaymentAmount()', 'BalanceDue: '+StriCurr(BalanceDue));

      BalanceDue := BalanceDue - AmountAsCurr;
      ProcessLog(ltDebug,'AdjustPaymetByCustGUIDAndPaymentAmount()', 'New BalanceDue: '+StriCurr(BalanceDue));

      ADOQuery.Edit();
      ADOQuery.FieldByName('BALANCEDUE').AsString := StriCurr(BalanceDue);

      ADOQuery.Post();
      ADOQuery.Close();
      FreeAndNil(ADOQuery);
   except
      on E: Exception do begin
         ADOQuery.Close();
         FreeAndNil(ADOQuery);
         ProcessLog(ltDebug, 'AdjustPaymetByCustGUIDAndPaymentAmount()', 'Exception raised: '+E.Message);
         ProcessLog(ltCritical, 'AdjustPaymetByCustGUIDAndPaymentAmount()', 'Exception raised: '+E.Message);
      end;
   end;
end;

function TCustomerInfoModule.GetVTCheckDetailAjax(const AQueryFields, AContentFields: TStrings): string;
var
   rnidL, systemCodeL, WS : string;
   BatchFieldNamesL : TStringList;
   TCBatchWasSuccessful, UserIsReadOnly : boolean;
begin
   Result := 'There was a problem retrieving the data you requested.';
   rnidL := NumericOnly(AQueryFields.Values['LOCATIONRNID']);
   systemCodeL := NumericOnly(AQueryFields.Values['TCSYSTEMCODE']);
   UserIsReadOnly := UserIs('READONLY', rnidL);
   TCBatchWasSuccessful := False;

   VarEvaluator.AddValue('LOCATIONRNID', rnidL);
   VarEvaluator.AddValue('GatewayRNID', rnidL);
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USEBATCHFIELDSEARCH','FALSE') = 'TRUE') then begin
      BatchFieldNamesL := TStringList.Create();
      BatchFieldNamesL.CommaText := 'AUTHDATE,VOIDED,VOIDEDDATE,TRANAMOUNT,RESPONSECHECKNUMBER,CHECKTYPE,ECATRANSTATUS,ECAACCEPTDATE,DISPLAYTEXT,APPROVALCODE,TRANIDENT,' +
                                          'BATCHSERIAL,DENIALRECORDNUMBER,TCMID,TCSERVICENAME,STATIONIDENT,IMAGESIZE,REFUNDAMOUNT,REFUNDDATE,REFUNDCOUNT';

      TCBatchWasSuccessful := GetTCBatchFields(rnidL, systemCodeL, BatchFieldNamesL);
   end else begin
      TCBatchWasSuccessful := GetTCBatch(rnidL, systemCodeL, True);
   end;

   if (TCBatchWasSuccessful) then begin
      ProcessLog(ltInfo,'Starting Batch XML to HTML',InstanceGUID);
      WS := LoadWebFileFromFolder('TCAuthDetails.htm','PPADMIN');
      if Request.queryfields.Values['DETAILONLY'] = 'TRUE' then begin
         Result := SingleCheckBatchXMLToTableHTML(UserIsReadOnly);
      end else begin
         ReplaceString(WS, '%AUTHDETAIL%', SingleCheckBatchXMLToTableHTML(UserIsReadOnly));
         ReplaceString(WS, '%MAXREFUND%', GetXMLTag(BatchXML,'TRANAMT'));
         ReplaceString(WS, '%LOCATIONRNID%', NumericOnly(Request.queryfields.Values['LOCATIONRNID']));
         ReplaceString(WS, '%TCSYSTEMCODE%', NumericOnly(Request.queryfields.Values['TCSYSTEMCODE']));
         Result := WS;
      end;
   end;
end;
function TCustomerInfoModule.ParseAndUploadFileDataToDB(UploadFileLocation, XMLAsFilePathOrString, RNID, ChainCode: String; RNDB : TADOConnection; DomainConfigXMLNode : TOPENXMLNode):String;
var
   fileUploader : TUploadFileContent;
   ReturnCode: Integer;
begin
   fileUploader := Nil;
   Result := 'INTERNALERROR'; // default
   if((UploadFileLocation = '') Or (RNID = '') Or (ChainCode = '') Or (RNDB = Nil) Or ((XMLAsFilePathOrString = '') And (DomainConfigXMLNode = Nil))) then begin
      Result := 'INTERNALERROR';
      Exit;
   end else begin
      fileUploader := TUploadFileContent.Create(UploadFileLocation, '', RNID, RNDB, DomainConfigXMLNode);
      fileUploader.ChainCode := ChainCode; // Need to store chain code so that if new customers are created they will show up in the admin portal
   end;

   if(StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINFILEUPLOAD/FILEPARSEBYEMAILANDRNID/ENABLED','FALSE'))) then begin //2019-2-13 ss: DVST-3865 This will set up what function will be called after every line read from the uploaded file
      fileUploader.IsParseFileByEmailAndRnid := True;
      if(Length(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINFILEUPLOAD/FILEPARSEBYEMAILANDRNID/PAYINGAGAINST')) <> 0) then begin
         fileUploader.RNIDPayingAgainst := Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINFILEUPLOAD/FILEPARSEBYEMAILANDRNID/PAYINGAGAINST'));
      end else begin
         fileUploader.RNIDPayingAgainst := RNID;
      end;
   end;

   if(StrToBool(OpenXMLGetTag('/CONFIGDATA/CHECKEXTCUSTOMERFIRSTLOGON','FALSE'))) then begin
      fileUploader.IsNewCustSetForFirstLogon := True;
   end;

   if(StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINFILEUPLOAD/SETPASSWORDFROMFILE','FALSE'))) then begin
      fileUploader.IsSetPasswordFromFile := True;
   end;

   If (StrToBool(OpenXMLGetTag('/CONFIGDATA/AUTHENTICATION/CASESENSITIVE', 'FALSE'))) then begin
      fileUploader.IsPassWordCaseSensitive := True; // by default this is set to false
   end;

   if(StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINFILEUPLOAD/FILEVALIDATION/RUNENGINE', 'FALSE'))) then begin // 2019-2-13 ss: DVST-3865 set configs of validation engine
      if(StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINFILEUPLOAD/FILEVALIDATION/CHECKREQUIREDFIELDS/CHECK', 'FALSE'))) then begin
         fileUploader.IsCheckRequiredFields := True;
         fileUploader.FieldsToCheckAsCommaText := Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINFILEUPLOAD/FILEVALIDATION/CHECKREQUIREDFIELDS/REQUIREDFIELDS',''));
      end;
      if(StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINFILEUPLOAD/FILEVALIDATION/CHECKSUPPORTEDRNIDS', 'FALSE'))) then begin
         fileUploader.IsCheckSupportedRnids := True;
         fileUploader.SupportedRnidsAsCommaText := Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINFILEUPLOAD/SUPPORTEDRNIDS',''));
      end;
      if(StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINFILEUPLOAD/FILEVALIDATION/CHECKUNIQUEEMAIL', 'FALSE'))) then begin
         fileUploader.IsCheckUniqueEmails := True;
      end;
      if(StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINFILEUPLOAD/FILEVALIDATION/CHECKUNIQUEEMAILANDRNID', 'FALSE'))) then begin
         fileUploader.IsCheckUniqueEmailAndRnid := True;
      end;
      if(StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINFILEUPLOAD/FILEVALIDATION/CHECKHEADERANDDATACOUNT', 'FALSE'))) then begin
         fileUploader.IsCheckHeaderAndDataCount := True;
      end;
      if(StrToBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINFILEUPLOAD/FILEVALIDATION/CHECKDATAANDFIELDSTOPARSECOUNT', 'FALSE'))) then begin //2019-2-13 ss: DVST-3865
         fileUploader.IsCheckDataAndFieldsToParseCount := True;
      end;

      ReturnCode := 1; // No validation failure
      ReturnCode:= fileUploader.RunFileValidationEngine(); // run the engine

      if(ReturnCode = 0)then begin
         ProcessLog(ltDebug, 'PAGE=UPLOADFILEAJAX', 'Validation Error: Internal Error during validation.' );
         Result := 'INTERNALERROR';
      end else if(ReturnCode = -1) then begin
         Result := '-1';
         ProcessLog(ltDebug, 'PAGE=UPLOADFILEAJAX', 'Validation Error: Required Field Validation Failed.');
      end else if(ReturnCode = -2) then begin
         Result := '-2';
         ProcessLog(ltDebug, 'PAGE=UPLOADFILEAJAX', 'Validation Error: Not Supported RNID');
      end else if(ReturnCode = -3) then begin
         Result := '-3';
         ProcessLog(ltDebug, 'PAGE=UPLOADFILEAJAX', 'Validation Error: Not Unique Email');
      end else if(ReturnCode = -4) then begin
         Result := '-4'; // Replace ResonseContent with Response.Content in main
         ProcessLog(ltDebug, 'PAGE=UPLOADFILEAJAX', 'Validation Error: Not Unique Email And RNID');
      end else if(ReturnCode = -5) then begin
         ProcessLog(ltDebug, 'PAGE=UPLOADFILEAJAX', 'Validation Error: # Header and Data column mismatch. Check file.' );
         Result := '-5';
      end else if(ReturnCode = -6) then begin // 2019-3-13 ss DVST-3865
         ProcessLog(ltDebug, 'PAGE=UPLOADFILEAJAX', 'Validation Error: # Data count is less than FieldsToParse.Count. Check file and FILEFIELDSTOPARSE config.' );
         Result := '-6';
      end else if(ReturnCode = -7) then begin // 2019-3-13 ss DVST-3865
         ProcessLog(ltDebug, 'PAGE=UPLOADFILEAJAX', 'Validation Error: # Invalid file path.' );
         Result := '-7';
      end else if(ReturnCode = -8) then begin // 2019-3-13 ss DVST-3865
         ProcessLog(ltDebug, 'PAGE=UPLOADFILEAJAX', 'Validation Error: # Invalid file type.' );
         Result := '-8';
      end;

      if(ReturnCode < 1) then begin  // some validation or internal error has happened
         FreeAndNil(fileUploader);
         Exit;
      end else begin
         ProcessLog(ltDebug, 'PAGE=UPLOADFILEAJAX', 'file validation successful, carry on.');
      end;
   end;

   try
      fileUploader.ParseAndUploadFile();
      if(fileUploader.Errors.Count > 0) then begin
         Result := 'INTERNALERROR';
         ProcessLog(ltDebug, 'PAGE=UPLOADFILEAJAX', 'No Data Uploaded.'+Result + fileUploader.Errors.CommaText);
      end else if(fileUploader.ErrNoRNIDEmailList.Count > 0) then begin
         Result := 'EMPTYRNID|'+fileUploader.ErrNoRNIDEmailList.CommaText;
         ProcessLog(ltDebug, 'PAGE=UPLOADFILEAJAX', 'No Customers with Empty RNID Uploaded to DB.'+Result);
      end else if(fileUploader.ErrRNIDEmailList.Count > 0) then begin
         Result := 'PARTIALSUCCESS|'+fileUploader.ErrRNIDEmailList.CommaText;
         ProcessLog(ltDebug, 'PAGE=UPLOADFILEAJAX', 'Duplicate Customer Data Not Uploaded to DB.'+Result);
      end else if(fileUploader.ErrOfDoAfterLineRead.Count > 0) then begin
         Result := 'DOAFTERLINEREADERR|'+fileUploader.ErrRNIDEmailList.CommaText;
         ProcessLog(ltDebug, 'PAGE=UPLOADFILEAJAX', 'Data Count and Header count does not match for the following rows in uploaded file.'+Result);
      end else begin
         Result := 'SUCCESS';
         ProcessLog(ltDebug, 'PAGE=UPLOADFILEAJAX', Result);
      end;
   except
      On E: Exception do begin
         ProcessLog(ltDebug, 'PAGE=UPLOADFILEAJAX', 'Error @ fileUploader.ParseAndUploadFile(): '+E.Message);
         Result := 'INTERNALERROR|'+E.Message; //2019-2-13 ss this will help to see what the internal error for the developers.
         ProcessLog(ltDebug, 'PAGE=UPLOADFILEAJAX', E.Message);
      end;
   end;
   FreeAndNil(fileUploader);
end;

function TCustomerInfoModule.UpdateSessionVarsByConfig(AADOQuery: TADOQuery; APIXML:TOpenXML; CommaSeperatedUpdateList: String):String;
const
   METHOD_NAME = 'TCustomerInfoModule.UpdateSessionVarsByConfig(...)';// 2019-4-17 ss DVST:5434
var
   ASessionVarEval: TVarEval;
   UpdateTagList: TStringList;
   i: Integer;
   ToUpdateTagName, ToUpdateTagValue, ToUpdateTagXPath, AuthenticatedTill, Error: String;
   ADateTime: TDateTime;
begin
   Error:= ''; // when empty it means successfully updated the SessionVars
   CommaSeperatedUpdateList := Trim(UpCaseString(CommaSeperatedUpdateList));
   if((AADOQuery <> Nil) And  (APIXML <> Nil) And  (CommaSeperatedUpdateList <> '')) then begin
      ProcessLog(ltDebug, 'UpldateSessionVarsByConfig', 'BEGIN');
      ASessionVarEval := TVarEval.Create();
      ASessionVarEval.Vars.Text := AADOQuery.FieldByName('SessionVars').AsString;

      UpdateTagList := TStringList.Create();
      UpdateTagList.CommaText := CommaSeperatedUpdateList;
      for i:=0 to UpdateTagList.Count-1 do begin
         ToUpdateTagName := Trim(UpdateTagList[i]); // 2019-4-17 ss DVST-5314
         ToUpdateTagXPath := '/TRANSACTION/' + ToUpdateTagName;
         if(ToUpdateTagName = 'USERDATA') then begin // 2019-4-17 ss DVST-5314
            ToUpdateTagValue := Trim(APIXML.GetXPathNodeAsXMLString(ToUpdateTagXPath, false));
            ReplaceString(ToUpdateTagValue, CRLF, '');
            if(GetXMLTagStr(ToUpdateTagValue, 'USERDATA') = '') then begin
               ToUpdateTagValue := ''; // if <USERDATA> has no child tags or is empty then store ''
            end;
         end else begin
            ToUpdateTagValue := Trim(APIXML.GetValueAsWideString(ToUpdateTagXPath));
         end;
         ASessionVarEval.AddValue(ToUpdateTagName, ToUpdateTagValue);
      end;
      if(Not (AADOQuery.State in [dsEdit])) then begin
         AADOQuery.Edit;
      end;
      AuthenticatedTill := Trim(ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/AUTHENTICATETILL'),True,True,'/-:. ')); //2019-4-17 ss DVST-5434: ConvertADateTimeStrToDateTime expects a ADateTimeStr
      if ((UpdateTagList.IndexOf('AUTHENTICATETILL') >= 0) And (AuthenticatedTill <> '')) then begin // check to see if AUTHENTICATETILL is in our update list. Update it only if it is listed in config
         ADateTime := ConvertADateTimeStrToDateTime(AuthenticatedTill);
         if(ADateTime <> 0) then begin
             AADOQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime := ADateTime;
         end
      end;
      AADOQuery.FieldByName('SessionVars').AsString := ASessionVarEval.Vars.Text;
      AADOQuery.Post;
      FreeAndNil(UpdateTagList);
      FreeAndNil(ASessionVarEval);
      ProcessLog(ltDebug, 'UpldateSessionVarsByConfig', 'END');
   end else begin
      Error := 'INTERNALERROR';
      ProcessLog(ltDebug, 'UpldateSessionVarsByConfig', 'AADOQuery/APIXML = Nil or CommaSeperatedUpdateList = ''''. Failed Precondition as such Postcondition not achieved.');
   end;
   Result := Error;
end;
function TCustomerInfoModule.UpdateSessionVarsByUpdateTagList(AADOQuery: TADOQuery; APIXML:TOpenXML; UpdateTagList:TStringList):String;
const
   METHOD_NAME = 'TCustomerInfoModule.UpdateSessionVarsByUpdateTagList(...)';// 2019-4-17 ss DVST:5434
var
   ASessionVarEval: TVarEval;
   ToUpdateTagName, ToUpdateTagValue, TransactionNodeXPath, AuthenticatedTill, Error: String;
   ADateTime: TDateTime;
   TransactionChildNode: TOPENXMLNode;
begin
   Error := ''; // when empty it means successfully updated the SessionVars
   if((AADOQuery <> Nil) And (APIXML <> Nil) And (UpdateTagList <> Nil)) then begin
      try
         ProcessLog(ltInfo, 'UpldateSessionVarsByUpdateTagList', 'BEGIN');
         TransactionChildNode := Nil;
         TransactionNodeXPath := '/TRANSACTION';
         ASessionVarEval := TVarEval.Create();
         ASessionVarEval.Vars.Text := AADOQuery.FieldByName('SessionVars').AsString;

         TransactionChildNode := APIXML.GetNode(TransactionNodeXPath);
         TransactionChildNode := TransactionChildNode.FindFirstChildElement();
         While(TransactionChildNode <> Nil) do begin
            ToUpdateTagName := Trim(TransactionChildNode.NodeName);
            if(ToUpdateTagName = 'USERDATA')then begin // 2019-4-17 ss DVST-5314
               ToUpdateTagValue := Trim(APIXML.GetXPathNodeAsXMLString('/TRANSACTION/USERDATA', false));// 2019-4-17 ss DVST:5434
               ReplaceString(ToUpdateTagValue, CRLF, '');
               if(GetXMLTagStr(ToUpdateTagValue, 'USERDATA') = '') then begin
                  ToUpdateTagValue := ''; // if <USERDATA> has no child tags or is empty then store ''
               end;
            end else begin
               ToUpdateTagValue := Trim(TransactionChildNode.TextContent);
            end;
            if(UpdateTagList.IndexOf(ToUpdateTagName) >= 0) then begin
               ASessionVarEval.AddValue(ToUpdateTagName, ToUpdateTagValue);
            end;
            TransactionChildNode := TransactionChildNode.FindNextSiblingElement();
         end;
         if(Not (AADOQuery.State in [dsEdit])) then begin
            AADOQuery.Edit;
         end;
         AuthenticatedTill := Trim(ValidCharsOnly(APIXML.GetValueAsWideString('/TRANSACTION/AUTHENTICATETILL'),True,True,'/-:. '));
         if(AuthenticatedTill <> '') then begin //2019-4-17 ss DVST-5434: ConvertADateTimeStrToDateTime expects a ADateTimeStr
            ADateTime := ConvertADateTimeStrToDateTime(AuthenticatedTill);
            if(ADateTime <> 0) then begin
               AADOQuery.FieldByName('CustomerAuthenticatedTill').AsDateTime := ADateTime;
            end;
         end;

         AADOQuery.FieldByName('SessionVars').AsString := ASessionVarEval.Vars.Text;
         AADOQuery.Post;
         FreeAndNil(ASessionVarEval);
         FreeAndNil(TransactionChildNode);
         ProcessLog(ltDebug, 'UpldateSessionVarsByUpdateTagList', 'END');
      except
         On E: Exception do begin
            Error := 'INTERNALERROR';
            ProcessLog(ltWarning, 'UpldateSessionVarsByUpdateTagList', 'Exception thrown, reason: '+E.Message);
         end;
      end;
   end else begin
      Error := 'INTERNALERROR';
      ProcessLog(ltWarning, 'UpldateSessionVarsByUpdateTagList', 'AADOQuery/APIXML/UpdateTagList = Nil. Failed Precondition as such Postcondition not achieved.');
   end;
   Result := Error;
end;

function TCustomerInfoModule.ConvertADateTimeStrToDateTime(ADateTimeStr: String):TDateTime;
begin
   if(Trim(ADateTimeStr) <> '') then begin
      try
         if Pos('Z',ADateTimeStr)> 0 then begin
            Result := ZTimeToLocalTimeWithDST(ADateTimeStr);
         end else begin
            Result := StrToDateTime(ADateTimeStr);
         end;
      except
         On E:Exception do begin
            Result := 0;
            ProcessLog(ltWarning, 'ConvertADateTimeStrToDateTime', 'Exception thrown:' + E.Message);
         end;
      end;
   end else begin
      Result := 0; // this should never happen in prod. Developer notes: ensure passed params meets precondition
      ProcessLog(ltWarning, 'ConvertADateTimeStrToDateTime', 'ADateTimeStr = ''''. Failed Precondition as such Postcondition not achieved.');
   end;
end;

procedure TCustomerInfoModule.SetCurrentUpdateTagList(AStringListToFill:TStringList); //2019-3-13 ss DVST-3483
begin
   if(AStringListToFill <> Nil) then begin
      ProcessLog(ltDebug, 'SetCurrentUpdateTagList', 'BEGIN');
      AStringListToFill.Clear();
      AStringListToFill.Add('SESSIONID');
      AStringListToFill.Add('FIRSTNAME');
      AStringListToFill.Add('LASTNAME');
      AStringListToFill.Add('TRANIDENT');
      AStringListToFill.Add('STATIONIDENT');
      AStringListToFill.Add('CUSTIDENT');
      AStringListToFill.Add('TXNAUTH');
      AStringListToFill.Add('AVSDATA');
      AStringListToFill.Add('CCNAME');
      AStringListToFill.Add('REFERURL');
      AStringListToFill.Add('ACCOUNTNUMBER');
      AStringListToFill.Add('EMAIL');
      AStringListToFill.Add('BCCEMAIL');
      AStringListToFill.Add('BALANCEDUE');
      AStringListToFill.Add('BILLINGNAME');
      AStringListToFill.Add('BILLINGADDRESS');
      AStringListToFill.Add('BILLINGCITY');
      AStringListToFill.Add('BILLINGSTATE');
      AStringListToFill.Add('BILLINGZIP');
      AStringListToFill.Add('PAYMENTRNID');
      AStringListToFill.Add('LOCATIONNAME');
      AStringListToFill.Add('LOCATIONIDENT');
      AStringListToFill.Add('USERDATA');
      AStringListToFill.Add('EMPLOYEENAME');
      AStringListToFill.Add('EMPLOYEEEMAIL');
      AStringListToFill.Add('EMPIDENT');
      AStringListToFill.Add('SERVICENAME');
      AStringListToFill.Add('CUSTOM');
      AStringListToFill.Add('CUSTOM2');
      AStringListToFill.Add('CUSTOM3');

      AStringListToFill.Add('CUSTOM4');
      AStringListToFill.Add('CUSTOM5');
      AStringListToFill.Add('CUSTOM6');
      AStringListToFill.Add('PHONENO');
      AStringListToFill.Add('CLIENTURL');
      AStringListToFill.Add('IVRACTIONID');
      AStringListToFill.Add('IVRACTIONCALLTYPE');
      AStringListToFill.Add('IVRPIN');
      AStringListToFill.Add('IVRPHONENOTOCALL');
      AStringListToFill.Add('IVRACTIONS');

      AStringListToFill.Add('RETURNPHONENUMBER');
      AStringListToFill.Add('SESSIONTYPE');
      AStringListToFill.Add('CCAUTHTYPE');

      AStringListToFill.Add('POSTRANIDENTGUID'); // 2019-4-17 ss DVST-5434
      AStringListToFill.Add('TICKETIDENT');

      ProcessLog(ltInfo, 'SetCurrentUpdateTagList', 'END');
   end else begin
      ProcessLog(ltWarning, 'SetCurrentUpdateTagList', 'AStringListToFill is Nil. Failed Precondition as such Postcondition not achieved.');
   end;
end;
function TCustomerInfoModule.GetPPSQLBySysCodeSessionIDRNID(AXMLResp:TStringList; RNID, SystemCode, SessionID: String):String;
var
   SQL: String;
begin
   SystemCode := Trim(SystemCode);
   SessionID := Trim(SessionID);
   RNID := Trim(RNID);
   if((AXMLResp <> Nil) And  ((SystemCode <> '') OR (SessionID <> '')) And (RNID <> '')) then begin
      SQL := 'SELECT * FROM WWWSESSION WHERE RNID = '+RNID; // RNID is int in DB, so don't have to worry about quotes
      if(SystemCode <> '') then begin
         SQL := SQL + ' AND SYSTEMCODE = '+SystemCode; // SystemCode is int in DB, so don't have to worry about quotes
         AXMLResp.Add(' <SYSTEMCODE>'+ SystemCode + '</SYSTEMCODE>');
      end;
      if(SessionID <> '') then begin
         SQL := SQL + ' AND RNSessionID = '''+SessionID+'''';
         AXMLResp.Add(' <SESSIONID>'+SessionID + '</SESSIONID>');
      end;
      Result := SQL;
   end else begin
      Result:= 'INTERNALERROR'; // failed to meet precondition
      ProcessLog(ltWarning, 'GetPPSQLBySysCodeSessionID', 'Failed to meet precondition.');
   end;
end;

function TCustomerInfoModule.GetXMLTargetNodeValueByXPath(AXML, TargetXPath: String):String;
var
   AOpenXMLObj: TOpenXML;
   TargetValue: String;
begin
   Result := '';
   if((AXML <> '') And (TargetXPath <> '')) then begin
      if LoadOpenXML(AOpenXMLObj,AXML) then begin
         TargetValue := AOpenXMLObj.GetValueAsWideString(TargetXPath);
         Result := Trim(TargetValue);
         FreeAndNil(AOpenXMLObj);
      end;
   end else begin
      ProcessLog(ltInfo, 'GetDeviceInfoTargetNodeValueByXPath', 'Precondition not met, Empty string returned.');
   end;
end;
function TCustomerInfoModule.GetReceiptFromRNSessionIDInURL(const AQueryFields, AContentFields: TStrings):String; //2019-3-13 ss DVST-3849
const
   SMSWEBFILE = 'retrieve_receipt.htm';
   METHOD_NAME = 'TCustomerInfoModule.GetReceiptFromRNSessionIDInURL(...)';
   TRANTYPE = 'CCRECEIPTRETRIEVE';
var
   ResponseHTML, Receipt, SessionID:String;
   RNID, CCSystemCode, TicketGUID: String;
begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   if((AQueryFields = Nil) Or (AContentFields = Nil)) then begin
      ProcessLog(ltWarning, METHOD_NAME, 'Request Query or Content field passed in is Nil. Empty Receipt returned. END');
      Result := '';
      Exit;
   end;
   Receipt := '';
   ResponseHTML:= LoadWebFileFromFolder(SMSWEBFILE,'');
   ProcessLog(ltInfo, METHOD_NAME, 'Web File Loaded for SMS Receipt Retrieve = '+SMSWEBFILE);

   SessionID := Trim(AQueryFields.Values['SESSIONID']);
   ProcessLog(ltInfo, METHOD_NAME, 'SessionID = '+SessionID);
   ProcessLog(ltInfo, METHOD_NAME, 'Global SessionVarEval = '+SessionVarEval.ToJSON());
   
   if(SessionID <> '') then begin
      RNID := Trim(SessionVarEval.GetValueAsString('RNID'));
      CCSystemCode := Trim(SessionVarEval.GetValueAsString('CCSYSTEMCODE'));
      TicketGUID := Trim(SessionVarEval.GetValueAsString('TICKETGUID'));

      if((RNID <> '') And ((CCSystemCode <> '') OR (TicketGUID <> ''))) then begin
         Receipt := RetrieveReceipt(RNID, CCSystemCode, TicketGUID, TRANTYPE);
         ProcessLog(ltInfo, METHOD_NAME, 'Receipt = '+Receipt);
      end else begin
         Receipt := 'No receipt found';
         ProcessLog(ltWarning, METHOD_NAME, 'Global SessionVarEval does not have the needed values for function RetrieveReceipt(...) to get the receipt corresponding to RNSessionID = '+SessionID +'. Check WWWSession Table''s SessionVars column. It should have key/value pairs, which should have been created by RetailNet when a RECEIPTDISPATCH transaction was made to it.');
      end;

   end else begin
      Receipt := 'No receipt found';
      ProcessLog(ltWarning, METHOD_NAME, 'No SessionID passed in SMS link. Need SessionID to retrieve receipt.');
   end;
   ReplaceString(ResponseHTML, '%RECEIPT%',Receipt);
   Result:= ResponseHTML;
   ProcessLog(ltInfo, METHOD_NAME, 'END');
end;
function TCustomerInfoModule.GetSessionVarsFromWWWSessionBySessionID(SessionID: String; SessionVarsEval: TVarEval): Boolean;
const
   METHOD_NAME = 'TCustomerInfoModule.GetSessionVarsFromWWWSessionBySessionID(...)';
   SQL = 'SELECT SESSIONVARS FROM WWWSESSION WHERE RNSESSIONID = :rnsessionID';
var
   ADOQuery : TADOQuery;
   RowCount: Integer;
   SessionVars: String;
begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   Result := False;
   SessionVars := '';
   if((SessionID <> '') And (SessionVarsEval <> Nil)) then begin
      ADOQuery:= NewAdoQuery();
      ADOQuery.SQL.Add(SQL);
      ADOQuery.Parameters.ParamByName('rnsessionID').Value := SessionID;
      ADOQuery.Prepared := true;
      try
         ADOQuery.Open();
         RowCount := ADOQuery.RecordCount;
         ProcessLog(ltInfo, METHOD_NAME, 'Number of rows returned = '+Stri(RowCount,-1));
         if(RowCount = 1) then begin
            SessionVars := ADOQuery.FieldByName('SESSIONVARS').AsString;
            ProcessLog(ltDebug, METHOD_NAME, 'SessionVars = '+SessionVars);
            SessionVarsEval.Vars.Text := SessionVars;
            Result := True;
         end else begin
            Result := False;
            ProcessLog(ltWarning, METHOD_NAME, 'More than one or zero row returned while querying WWWSession with SessionID = '+SessionID);
         end;
      except
         on E: Exception do begin
            ProcessLog(ltWarning, METHOD_NAME, 'Exception thrown. Message = '+E.Message);
         end;
      end;
   end else begin
      ProcessLog(ltWarning, METHOD_NAME, 'Precondition not meet.');
   end;
   ProcessLog(ltInfo, METHOD_NAME, 'END - Result : '+BoolToStr(Result));
end;
function TCustomerInfoModule.IsPOSTicketOpen(ASessionVarEval, AVarEval: TVarEval): Boolean;
const
   METHOD_NAME = 'TCustomerInfoModule.IsPOSTicketOpen(...)';
var
   Request: String;
   Response: TStringList;
   ARequestVarEval: TVarEval;
   ToReturn: Boolean;
begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   ToReturn := False;
   Response := Nil;
   ARequestVarEval := TVarEval.Create();

   ARequestVarEval.AddValue('TRANSACTIONTYPE', 'POSTICKETOPEN');
   ARequestVarEval.AddValue('POSTRANIDENTGUID', ASessionVarEval.GetValueAsString('POSTRANIDENTGUID'));
   ARequestVarEval.AddValue('TICKETTOTAL',AVarEval.GetValueAsString('PAYMENTAMOUNT'));  
   ARequestVarEval.AddValue('TICKETIDENT', ASessionVarEval.GetValueAsString('TICKETIDENT'));
   ARequestVarEval.AddValue('CUSTIDENT',AVarEval.GetValueAsString('CUSTIDENT'));
   if(ARequestVarEval.GetValueAsString('CUSTIDENT') = '') then begin
      ARequestVarEval.AddValue('CUSTIDENT',ASessionVarEval.GetValueAsString('CUSTIDENT'));
   end;
   ARequestVarEval.AddValue('TRANIDENT',AVarEval.GetValueAsString('TRANIDENT'));
   if(ARequestVarEval.GetValueAsString('TRANIDENT') = '') then begin
      ARequestVarEval.AddValue('TRANIDENT',ASessionVarEval.GetValueAsString('TRANIDENT'));
   end;
   ARequestVarEval.AddValue('POSEFEATURESET','100');
   ARequestVarEval.AddValue('RNID',AVarEval.GetValueAsString('POSRNID'));

   ARequestVarEval.AddValue('STATIONIDENT',AVarEval.GetValueAsString('STATIONIDENT'));
   if(ARequestVarEval.GetValueAsString('STATIONIDENT') = '') then begin
      ARequestVarEval.AddValue('STATIONIDENT',ASessionVarEval.GetValueAsString('STATIONIDENT'));
   end;
   ARequestVarEval.AddValue('EMPIDENT',AVarEval.GetValueAsString('EMPIDENT'));
   if(ARequestVarEval.GetValueAsString('EMPIDENT') = '') then begin
      ARequestVarEval.AddValue('EMPIDENT',ASessionVarEval.GetValueAsString('EMPIDENT'));
   end;
   try
      Request := '<TRANSACTION>'+ARequestVarEval.ToXML() + '</TRANSACTION>';
      ProcessLog(ltInfo, METHOD_NAME, 'POSTicketOpen Request API call = '+Request);
      POSTicketAPI.GeneratePOSResponse(Request, 'POSTICKETOPEN');
      Response := POSTicketAPI.XMLResp;
      ProcessLog(ltInfo, METHOD_NAME, 'POSTicketOpen Response after  POSTicketAPI.GeneratePOSResponse(...) = '+Response.Text);

      if(GetXMLTag(Response, 'TRANSUCCESS') = 'TRUE') then begin
         AVarEval.AddValue('POSTICKETGUID',GetXMLTag(Response, 'TICKETGUID')); // add the ticket guid that will be used later
         AVarEval.AddValue('POSTICKETDATETIME',GetXMLTag(Response, 'TICKETDATETIME'));
         ToReturn := True;
         ProcessLog(ltInfo, METHOD_NAME, 'POSTicket Open successful.');
         ProcessLog(ltInfo, METHOD_NAME, 'POSTicket Open: New TICKETGUID (stored as POSTICKETGUID in VarEvaluator) = '+AVarEval.GetValueAsString('POSTICKETGUID'));
      end;
   except
      On E: Exception do begin
         ToReturn:= False;
         AVarEval.AddValue('I2PAYERROR','POSTicket Open Failed.');
         ProcessLog(ltWarning, METHOD_NAME, 'Exception Thrown = '+E.Message);
      end;
   end;
   Result := ToReturn;
   FreeAndNil(ARequestVarEval);
   ProcessLog(ltInfo, METHOD_NAME, 'END. Result = '+BoolToStr(Result));
end;
function TCustomerInfoModule.IsPOSTicketAdd(ASessionVarEval, AVarEval: TVarEval):Boolean;
const
   METHOD_NAME = 'TCustomerInfoModule.IsPOSTicketAdd(...)';
var
   Request: String;
   Response: TStringList;
   ARequestVarEval: TVarEval;
   ToReturn: Boolean;
begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   ToReturn := False;
   Response := Nil;
   ARequestVarEval := TVarEval.Create();

   ARequestVarEval.AddValue('TRANSACTIONTYPE','POSTICKETADDPAYMENTHA');
   ARequestVarEval.AddValue('POSEFEATURESET','100');
   ARequestVarEval.AddValue('TICKETGUID',AVarEval.GetValueAsString('POSTICKETGUID'));
   ARequestVarEval.AddValue('PAYMENTTYPE',AVarEval.GetValueAsString('POSPAYMENTTYPE'));
   ARequestVarEval.AddValue('APPLIEDAMOUNT',AVarEval.GetValueAsString('PAYMENTAMOUNT'));
   ARequestVarEval.AddValue('ACTIVITY',AVarEval.GetValueAsString('POSACTIVITY'));
   ARequestVarEval.AddValue('RNID',AVarEval.GetValueAsString('POSRNID'));

   ARequestVarEval.AddValue('STATIONIDENT',AVarEval.GetValueAsString('STATIONIDENT'));
   if(ARequestVarEval.GetValueAsString('STATIONIDENT') = '') then begin
      ARequestVarEval.AddValue('STATIONIDENT',ASessionVarEval.GetValueAsString('STATIONIDENT'));
   end;
   ARequestVarEval.AddValue('EMPIDENT',AVarEval.GetValueAsString('EMPIDENT'));
   if(ARequestVarEval.GetValueAsString('EMPIDENT') = '') then begin
      ARequestVarEval.AddValue('EMPIDENT',ASessionVarEval.GetValueAsString('EMPIDENT'));
   end;
   try
      Request := '<TRANSACTION>'+ARequestVarEval.ToXML() + '</TRANSACTION>';
      ProcessLog(ltInfo, METHOD_NAME, 'POSTicketAdd Request API call = '+Request);
      POSTicketAPI.GeneratePOSResponse(Request, 'POSTICKETADDPAYMENTHA');
      Response := POSTicketAPI.XMLResp;
      ProcessLog(ltInfo, METHOD_NAME, 'POSTicketAdd Response after  POSTicketAPI.GeneratePOSResponse(...) = '+Response.Text);

      if(GetXMLTag(Response, 'TRANSUCCESS') = 'TRUE') then begin
         AVarEval.AddValue('POSPAYMENTGUID',GetXMLTag(Response, 'PAYMENTGUID')); // add the payment guid that will used later
         ToReturn := True;
         ProcessLog(ltInfo, METHOD_NAME, 'POSTicket Add successful.');
         ProcessLog(ltInfo, METHOD_NAME, 'POSTicket Add PAYMENTGUID = (stored as POSPAYMENTGUID in VarEvaluator) '+AVarEval.GetValueAsString('POSPAYMENTGUID'));
      end;
   except
      On E: Exception do begin
         ToReturn:= False;
         AVarEval.AddValue('I2PAYERROR','POSTicket Add Failed.');
         ProcessLog(ltWarning, METHOD_NAME, 'Exception Thrown = '+E.Message);
      end;
   end;
   Result := ToReturn;
   FreeAndNil(ARequestVarEval);
   ProcessLog(ltInfo, METHOD_NAME, 'END. Result = '+BoolToStr(Result));
end;

function TCustomerInfoModule.IsPOSTicketUpdate(ASessionVarEval, AVarEval: TVarEval; AGWResponseXML:TStringList):Boolean;
const
   METHOD_NAME = 'TCustomerInfoModule.IsPOSTicketUpdate(...)';
var
   Request, Activity: String;
   Response: TStringList;
   ARequestVarEval: TVarEval;
   ToReturn: Boolean;
begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   ToReturn := False;
   Response := Nil;
   ARequestVarEval := TVarEval.Create();

   ARequestVarEval.AddValue('TRANSACTIONTYPE','POSTICKETUPDATEPAYMENTHA');
   ARequestVarEval.AddValue('POSEFEATURESET','100');
   ARequestVarEval.AddValue('TICKETGUID',AVarEval.GetValueAsString('POSTICKETGUID'));
   ARequestVarEval.AddValue('PAYMENTGUID',AVarEval.GetValueAsString('POSPAYMENTGUID'));
   ARequestVarEval.AddValue('PAYMENTTYPE',AVarEval.GetValueAsString('POSPAYMENTTYPE'));
   ARequestVarEval.AddValue('APPROVEDAMOUNT',GetXMLTag(AGWResponseXML, 'CCAMT'));
   ARequestVarEval.AddValue('APPLIEDAMOUNT',GetXMLTag(AGWResponseXML, 'CCAMT')); // 2017-4-17 ss DVST-3651
   ARequestVarEval.AddValue('GWSYSTEMCODE',GetXMLTag(AGWResponseXML, 'CCSYSTEMCODE'));
   ARequestVarEval.AddValue('AUTHDATE',GetXMLTag(AGWResponseXML, 'AUTHDATE'));
   ARequestVarEval.AddValue('APPROVALCODE',GetXMLTag(AGWResponseXML, 'CCAUTHCODE'));

   Activity := '';
   if (Trim(GetXMLTag(AGWResponseXML, 'CCSALETYPE')) = 'DEBIT') then begin
      Activity := 'DEBITCARDAUTH';
   end else begin
      Activity := 'CREDITCARDAUTH';
   end;
   ARequestVarEval.AddValue('ACTIVITY',Activity);
   AVarEval.AddValue('POSACTIVITY',Activity); // update it in VarEvaluator as well. Incase we need it later.

   ARequestVarEval.AddValue('RNID',AVarEval.GetValueAsString('POSRNID'));
   ARequestVarEval.AddValue('STATIONIDENT',AVarEval.GetValueAsString('STATIONIDENT'));
   if(ARequestVarEval.GetValueAsString('STATIONIDENT') = '') then begin
      ARequestVarEval.AddValue('STATIONIDENT',ASessionVarEval.GetValueAsString('STATIONIDENT'));
   end;
   ARequestVarEval.AddValue('EMPIDENT',AVarEval.GetValueAsString('EMPIDENT'));
   if(ARequestVarEval.GetValueAsString('EMPIDENT') = '') then begin
      ARequestVarEval.AddValue('EMPIDENT',ASessionVarEval.GetValueAsString('EMPIDENT'));
   end;
   ARequestVarEval.AddValue('AUXDATA',GetXMLTag(AGWResponseXML, 'TRANRESP'));

   try
      Request := '<TRANSACTION>'+ARequestVarEval.ToXML() + '</TRANSACTION>';
      ProcessLog(ltInfo, METHOD_NAME, 'POSTicketUpdate Request API call = '+Request);
      POSTicketAPI.GeneratePOSResponse(Request, 'POSTICKETUPDATEPAYMENTHA');
      Response := POSTicketAPI.XMLResp;
      ProcessLog(ltInfo, METHOD_NAME, 'POSTicketUpdate Response after  POSTicketAPI.GeneratePOSResponse(...) = '+Response.Text);

      if(GetXMLTag(Response, 'TRANSUCCESS') = 'TRUE') then begin
         ToReturn := True;
         ProcessLog(ltInfo, METHOD_NAME, 'POSTicket Update successful.');
      end;
   except
      On E: Exception do begin
         ToReturn:= False;
         AVarEval.AddValue('I2PAYERROR','POSTicket Update Failed.');
         ProcessLog(ltWarning, METHOD_NAME, 'Exception Thrown = '+E.Message);
      end;
   end;
   Result := ToReturn;
   FreeAndNil(ARequestVarEval);
   ProcessLog(ltInfo, METHOD_NAME, 'END. Result = '+BoolToStr(Result));
end;
function TCustomerInfoModule.IsPOSTicketDelete(ASessionVarEval, AVarEval: TVarEval; AGWResponseXML:TStringList):Boolean;
const
   METHOD_NAME = 'TCustomerInfoModule.IsPOSTicketDelete(...)';
var
   Request: String;
   Response: TStringList;
   ARequestVarEval: TVarEval;
   ToReturn: Boolean;
begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   ToReturn := False;
   Response := Nil;
   ARequestVarEval := TVarEval.Create();

   ARequestVarEval.AddValue('TRANSACTIONTYPE','POSTICKETDELETEPAYMENT');
   ARequestVarEval.AddValue('RNID',AVarEval.GetValueAsString('POSRNID'));
   ARequestVarEval.AddValue('TICKETGUID',AVarEval.GetValueAsString('POSTICKETGUID'));
   ARequestVarEval.AddValue('PAYMENTGUID',AVarEval.GetValueAsString('POSPAYMENTGUID'));
   ARequestVarEval.AddValue('GWSYSTEMCODE',GetXMLTag(AGWResponseXML, 'CCSYSTEMCODE'));
   ARequestVarEval.AddValue('TENDERPAYMENTCANCELLED', 'TRUE');
   try
      Request := '<TRANSACTION>'+ARequestVarEval.ToXML() + '</TRANSACTION>';
      ProcessLog(ltInfo, METHOD_NAME, 'POSTicketDelete Request API call = '+Request);
      POSTicketAPI.GeneratePOSResponse(Request, 'POSTICKETDELETEPAYMENT');
      Response := POSTicketAPI.XMLResp;
      ProcessLog(ltInfo, METHOD_NAME, 'POSTicketDelete Response after  POSTicketAPI.GeneratePOSResponse(...) = '+Response.Text);

      if(GetXMLTag(Response, 'TRANSUCCESS') = 'TRUE') then begin
         ToReturn := True;
         ProcessLog(ltInfo, METHOD_NAME, 'POSTicketDelete successful.');
      end;
   except
      On E: Exception do begin
         ToReturn:= False;
         AVarEval.AddValue('I2PAYERROR','POSTicketDelete Failed.');
         ProcessLog(ltWarning, METHOD_NAME, 'Exception Thrown = '+E.Message);
      end;
   end;
   Result := ToReturn;
   FreeAndNil(ARequestVarEval);
   ProcessLog(ltInfo, METHOD_NAME, 'END. Result = '+BoolToStr(Result));
end;

procedure TCustomerInfoModule.BuildTransactionTabSQLInTZ(const AQueryFields:TStrings; ARNQuery:TADOQuery; const AChainCode:Integer;
                                                            const AHASTOffsetEST, AAdminRNID, ARNID:String;
                                                            const DisplayRNID, DisplayStoreName: boolean);
const
   METHOD_NAME = 'TCustomerInfoModule.BuildTransactionTabSQLInTZ(...)';
var
   AName: String;
begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   AName := Trim(AlphaOnly(Trim(UpCaseString(AQueryFields.Values['Name']))));
   ARNQuery.Close;
   ARNQuery.SQL.Clear;
   ARNQuery.SQL.Add(DRSQLVarsDec); // this const is in ttWebUtilityU
   ARNQuery.SQL.Add('set @BegDate = '''+AQueryFields.Values['FROMDATE']+''';set @EndDate = '''+FormatDateTime('MM/DD/YYYY',StrToDate(AQueryFields.Values['THRUDATE']) +1)+''';');
   ARNQuery.SQL.Add(DRSQLSetTZ); // this const is in ttWebUtilityU
   ARNQuery.SQL.Add('set @BegDateHAST = DATEADD(hour,+'+AHASTOffsetEST+',@BegDate);set @EndDateHAST = DATEADD(hour,+'+AHASTOffsetEST+',@EndDate); ');

   ARNQuery.SQL.Add('select ');
   if DisplayRNID then begin
      ARNQuery.SQL.Add('Store.systemcode as StoreSystemCode,');
   end;
   if DisplayStoreName then begin
      ARNQuery.SQL.Add('Store.name as StoreName,');
   end;
   ARNQuery.SQL.Add('NonAuthReason, ApprovalCode, PaymentDate, Customers.CustomerCode, Customers.FirstName, CustHistDesc,Customers.LastName, CustPaymentHistory.PaymentAmount,CustPaymentHistory.RNID,' +
                   'CustPaymentHistory.SystemCode,CustPayment.PaymentType,CustPayment.PaymentName,' +
                   'Customers.AccountNumber, CustChild.FirstName as ChildFirstName, CustChild.Lastname as ChildLastName, CustChild.AccountNumber as ChildAccountNumber, ');

   ARNQuery.SQL.Add('CASE r.KeyValue WHEN ''AST'' THEN DATEADD(hour,+1,custpaymenthistory.PaymentDate) WHEN ''CST'' THEN DATEADD(hour,-1,custpaymenthistory.PaymentDate) WHEN ''MST'' THEN DATEADD(hour,-2,custpaymenthistory.PaymentDate)');
   ARNQuery.SQL.Add('WHEN ''PST'' THEN DATEADD(hour,-3,custpaymenthistory.PaymentDate) WHEN ''AKST'' THEN DATEADD(hour,-4,custpaymenthistory.PaymentDate)');
   ARNQuery.SQL.Add('WHEN ''HAST'' THEN DATEADD(hour,-'+AHASTOffsetEST+',custpaymenthistory.PaymentDate) ELSE custpaymenthistory.PaymentDate END PaymentDatetz, ');

   ARNQuery.SQL.Add('CustPaymentHistory.SPLITDETAILS, CustPaymentHistory.PAYHISTGUID, CUSTOMERS.EMAIL as Email, CUSTOMERS.HPHONE as hphone  from custpaymenthistory'); // 2019-1-16 ss: DVST-3660
   ARNQuery.SQL.Add('left outer join customers on (custpaymenthistory.CustGUID = Customers.CustomerCode) and (Customers.ChainCode = ' + Stri(AChainCode,-1) + ')');
   ARNQuery.SQL.Add('left outer join Store on (CustPaymentHistory.RNID = Store.SystemCode)');
   ARNQuery.SQL.Add('Left Outer Join CustPayment on (CustPaymentHistory.PaymentGUID = CustPayment.PaymentGUID)');
   ARNQuery.SQL.Add('left outer join CustChild on (CustChild.CHILDGUID = CustPaymentHistory.ChildGUID)');
   ARNQuery.SQL.Add('left outer join REGISTRY r ON r.SubKey1 = custpaymenthistory.RNID');
   ARNQuery.SQL.Add('and r.subkey2 = ''storetz''');

   if AAdminRNID = 'ALL' then begin
      if StrtoBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USECHAINCODEONTRANSHISTORY','FALSE')) then begin
         ARNQuery.SQL.Add('where Store.chaincode = ' + Stri(AChainCode,-1));
      end else begin
         ARNQuery.SQL.Add('where CustPaymentHistory.siteRNID=' + ARNID);
      end;
   end else begin
      ARNQuery.SQL.Add('where CustPaymentHistory.RNID=' + AAdminRNID);
   end;
   If AQueryFields.Values['FROMDATE'] <> '' then begin
      ARNQuery.SQL.Add('and (PaymentDate>= case r.KeyValue WHEN ''AST'' THEN @BegDateAST WHEN ''CST'' THEN @BegDateCST WHEN ''MST'' THEN @BegDateMST WHEN ''PST'' THEN @BegDatePST WHEN ''AKST'' THEN @BegDateAKST WHEN ''HAST'' THEN @BegDateHAST ELSE @BegDate END)');
   end;
   If AQueryFields.Values['THRUDATE'] <> '' then begin
      ARNQuery.SQL.Add('and (PaymentDate< case r.KeyValue WHEN ''AST'' THEN @EndDateAST WHEN ''CST'' THEN @EndDateCST WHEN ''MST'' THEN @EndDateMST WHEN ''PST'' THEN @EndDatePST WHEN ''AKST'' THEN @EndDateAKST WHEN ''HAST'' THEN @EndDateHAST ELSE @EndDate END)');
   end;
   If AQueryFields.Values['SUPRESSDECLINES'] = 'TRUE' then begin
      ARNQuery.SQL.Add('AND (ApprovalCode <> '''')');
   end;
   If GuidOnly(AQueryFields.Values['CUSTGUID']) <> '' then begin
      ARNQuery.SQL.Add('AND Customers.CustomerCode = ''' + GuidOnly(AQueryFields.Values['CUSTGUID']) + '''');
   end;
   If ValidCharsOnly(AQueryFields.Values['CUSTACCOUNTNUMBER'],true,true,'') <> '' then begin
      ARNQuery.SQL.Add(' and (Customers.AccountNumber = ''' + ValidCharsOnly(AQueryFields.Values['CUSTACCOUNTNUMBER'],true,true,'')+ ''')');
   end;
   If AName <> '' then begin
      ARNQuery.SQL.Add('AND Customers.LastName like ''' + AName + '%''');
   end;
   ARNQuery.SQL.Add(' And CustPaymentHistory.PaymentAmount IS NOT NULL');//2019-5-15 SS DVST-5164
   ARNQuery.SQL.Add(' order by PaymentDate');
   ProcessLog(ltInfo, METHOD_NAME, 'RNQuery.SQL.Text = '+ARNQuery.SQL.Text);
   ProcessLog(ltInfo, METHOD_NAME, 'END');
end;

procedure TCustomerInfoModule.BuildTransactionTabSQL(const AQueryFields: TStrings; ARNQuery: TADOQuery; const AChainCode: Integer;
                                                         const AAdminRNID, ARNID: String; const DisplayRNID, DisplayStoreName: boolean);
const
   METHOD_NAME = 'TCustomerInfoModule.BuildTransactionTabSQL(...)';
var
   AName: String;
begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   AName := Trim(AlphaOnly(Trim(UpCaseString(AQueryFields.Values['Name']))));
   ARNQuery.Close;
   ARNQuery.SQL.Clear;

   ARNQuery.SQL.Add('select ');
   if DisplayRNID then begin
     ARNQuery.SQL.Add('Store.systemcode,');
   end;
   if DisplayStoreName then begin
     ARNQuery.SQL.Add('Store.name,');
   end;

   ARNQuery.SQL.Add('NonAuthReason, ApprovalCode, PaymentDate, Customers.CustomerCode, Customers.FirstName, CustHistDesc,Customers.LastName, CustPaymentHistory.PaymentAmount,CustPaymentHistory.RNID,' +
                   'CustPaymentHistory.SystemCode,CustPayment.PaymentType,CustPayment.PaymentName,' +
                   'Customers.AccountNumber, CustChild.FirstName as ChildFirstName, CustChild.Lastname as ChildLastName, CustChild.AccountNumber as ChildAccountNumber, ');
   ARNQuery.SQL.Add('CustPaymentHistory.SPLITDETAILS, CustPaymentHistory.PAYHISTGUID, CUSTOMERS.EMAIL as Email, CUSTOMERS.HPHONE as hphone  from custpaymenthistory'); // 2019-1-16 ss: DVST-3660
   ARNQuery.SQL.Add('left outer join customers on (custpaymenthistory.CustGUID = Customers.CustomerCode) and (Customers.ChainCode = ' + Stri(AChainCode,-1) + ')');
   ARNQuery.SQL.Add('left outer join Store on (CustPaymentHistory.RNID = Store.SystemCode)');
   ARNQuery.SQL.Add('Left Outer Join CustPayment on (CustPaymentHistory.PaymentGUID = CustPayment.PaymentGUID)');
   ARNQuery.SQL.Add('left outer join CustChild on (CustChild.CHILDGUID = CustPaymentHistory.ChildGUID)');
   if AAdminRNID = 'ALL' then begin
      if StrtoBool(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ADMINREPORTS/USECHAINCODEONTRANSHISTORY','FALSE')) then begin // 2018-12-19 SS DVST-3484
         ARNQuery.SQL.Add('where Store.chaincode = ' + Stri(AChainCode,-1));
      end else begin
         ARNQuery.SQL.Add('where CustPaymentHistory.siteRNID=' + ARNID);
      end;
   end else begin
      ARNQuery.SQL.Add('where CustPaymentHistory.RNID=' + AAdminRNID);
   end;
   If AQueryFields.Values['FROMDATE'] <> '' then begin
      ARNQuery.SQL.Add('AND PaymentDate>=''' + AQueryFields.Values['FROMDATE']+'''');
   end;
   If AQueryFields.Values['THRUDATE'] <> '' then begin
      ARNQuery.SQL.Add('AND PaymentDate<''' + FormatDateTime('MM/DD/YYYY',StrToDate(AQueryFields.Values['THRUDATE']) +1)+'''');
   end;
   If AQueryFields.Values['SUPRESSDECLINES'] = 'TRUE' then
      ARNQuery.SQL.Add('AND (ApprovalCode <> '''')');
   If GuidOnly(AQueryFields.Values['CUSTGUID']) <> '' then begin
      ARNQuery.SQL.Add('AND Customers.CustomerCode = ''' + GuidOnly(AQueryFields.Values['CUSTGUID']) + '''');
   end;
   If ValidCharsOnly(AQueryFields.Values['CUSTACCOUNTNUMBER'],true,true,'') <> '' then begin
      ARNQuery.SQL.Add(' and (Customers.AccountNumber = ''' + ValidCharsOnly(AQueryFields.Values['CUSTACCOUNTNUMBER'],true,true,'')+ ''')');
   end;
   If AName <> '' then begin
      ARNQuery.SQL.Add('AND Customers.LastName like ''' + AName + '%''');
   end;
   ARNQuery.SQL.Add(' And CustPaymentHistory.PaymentAmount IS NOT NULL');//2019-5-15 SS DVST-5164
   ARNQuery.SQL.Add(' order by PaymentDate');
   ProcessLog(ltInfo, METHOD_NAME, 'RNQuery.SQL.Text = '+ARNQuery.SQL.Text);
   ProcessLog(ltInfo, METHOD_NAME, 'END');
end;

function TCustomerInfoModule.GetCustPaymentOptionsAjax(const AQueryFields:TStrings; ARNQuery:TADOQuery):String;
const
   METHOD_NAME = 'TCustomerInfoModule.GetCustPaymentOptionsAjax(...)';
var
   AParentGUID, APaySchedGUID, AWebPage: String;
   ChildCount, PaymentOptionsCount: Integer;
begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   AParentGUID := GuidOnly(AQueryFields.Values['CUSTGUID']);
   If AParentGUID = '' then exit;
   APaySchedGUID := GuidOnly(AQueryFields.Values['PAYSCHEDGUID']);
   AWebPage := LoadWebFileFromFolder('OneTimeCustAdminPay.htm','PPADMIN');
   ARNQuery.Close;
   ARNQuery.SQL.Clear;
   ARNQuery.SQL.Add('select distinct RNID,SystemCode, name,city, state, convert(varchar(max),siblings) as siblings, firstname,lastname,accountnumber, ChildGUID from custchild');
   ARNQuery.SQL.Add('left outer join store on systemcode = rnid');
   ARNQuery.SQL.Add('where (CustGUID = '''+AParentGUID +''') and (Hidden =0) ');
   ARNQuery.SQL.Add('order by State,Name');
   ARNQuery.Open;
   ReplaceString(AWebPage, '%SCHOOLOPTIONS%', GenerateSchoolOptions(ARNQuery));
   if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/CHILDACCOUNTHIDERNIDS', 'FALSE') = 'TRUE') then begin //2017-11-16 ajs: F#2303
      ReplaceString(AWebPage, '%LOCATIONOPTIONS%', GenerateAllSchoolOptions(False,true));
   end else begin
      ReplaceString(AWebPage,'%LOCATIONOPTIONS%', GenerateAllLocationsOptions);
   end;
   ReplaceString(AWebPage, '%LOCATIONSTATEOPTIONS%', GenerateAllLocationStateOptions);
   ReplaceString(AWebPage, '%CHILDNAMEOPTIONS%', GenerateChildNameOptions(ARNQuery, ChildCount)); // Refactored function
   ReplaceString(AWebPage, '%PAYMENTOPTIONS%', GeneratePaymentOptions(AParentGUID, 'ONETIME','', PaymentOptionsCount)); // Refactored function
   ReplaceString(AWebPage,'%CUSTGUID%',AParentGUID);
   ReplaceString(AWebPage,'%PAYSCHEDGUID%',APaySchedGUID);
   Result := AWebPage;
   ProcessLog(ltInfo, METHOD_NAME, 'CHILDCOUNT AND PAYMENTOPTIONSCOUNT AFTER REFACTORED METHOD CALL: ChildCount = '+Stri(ChildCount,-1)+' . PaymentOptionsCount = '+Stri(PaymentOptionsCount,-1)); // Checking ChildCount and PaymentOptionsCount after refactored method call
   ProcessLog(ltInfo, METHOD_NAME, 'RNQuery.SQL.Text = '+ARNQuery.SQL.Text);
   ProcessLog(ltInfo, METHOD_NAME, 'END');
end;

function TCustomerInfoModule.GenerateSchoolOptions(ADS : TDataSet) : String;
const
   METHOD_NAME = 'TCustomerInfoModule.GenerateSchoolOptions(...)';
var
  WS, StoreProfile: String;
Begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   WS := '';
   ADS.First;
   While Not ADS.EOF do begin
      StoreProfile := ADS.FieldByName('Siblings').AsString;

      if ShowStore(StoreProfile) then begin
         WS := WS + '<option value="'+ ADS.FieldByName('SystemCode').AsString +'"> ';
         If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONNAMEFORMAT') = 'NAMEONLY' then begin //2016-09-29 jtm Feat OT# 1179
            WS := WS + Trim(ADS.FieldByName('Name').AsString);
         end else if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONNAMEFORMAT') = 'UNITCITYSTATE' then begin //2017-07-05
            WS := WS + Trim(ADS.FieldByName('StoreId').AsString) + ', '+ Trim(ADS.FieldByName('City').AsString)+', '+ Trim(ADS.FieldByName('State').AsString);
         end else if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONNAMEFORMAT') = 'RNIDANDNAME' then begin
            WS := WS + Trim(ADS.FieldByName('SYSTEMCODE').AsString) + ', ' + Trim(ADS.FieldByName('Name').AsString);
         end else begin
            WS := WS + Trim(ADS.FieldByName('State').AsString) + '-' +Trim(ADS.FieldByName('Name').AsString);
         end;
         WS := WS + '</option>';
      end;
      ADS.Next;
   end;
   Result := WS;
   ProcessLog(ltInfo, METHOD_NAME, 'END. RESULT = '+Result);
end;

function TCustomerInfoModule.GenerateAllSchoolOptions(IncludeALLOption : Boolean; IncludePleaseSelect : Boolean) : String;
const
   METHOD_NAME = 'TCustomerInfoModule.GenerateAllSchoolOptions(...)';
Var
   Locs : String;
   AllowedRNIDs : String;
   RNIDAccess : TStringList;
Begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   AllowedRNIDs := UserXMLGetTag('/USERPROFILE/ALLOWEDRNIDS');
   RNIDAccess := TStringList.Create;
   if GetUserRNIDAccess(RNIDAccess,false) > 0 then AllowedRNIDs := RNIDAccess.CommaText; //2016-09-29 jtm Feat OT# 1177
   if UserXMLGetTag('/USERPROFILE/CHAINACCESS/CHAIN[@ID="'+trim(Stri(ChainCode,-1))+'"]/READONLY') <> '' then  AllowedRNIDs := '';   //2016-11-03 jtm Feat OT# 1247
   if (AllowedRNIDs = '') then AllowedRNIDs := ExternalXMLGetTag('/EXTERNALXML/ALLOWEDRNIDS'); //2016-8-22 jtm: Feat OT#1074
   If (AllowedRNIDs <> '') then IncludeAllOption := False;

   If (OpenXMLGetTag('/CONFIGDATA/RNIDACCESSBYSTOREATTRIBUTES/ONDROPDOWN', 'FALSE') = 'TRUE') then begin //2018-01-25 jtm F#2360
      if (GetUserRNIDAccessByStoreAttr(RNIDAccess) > 0) then begin
         AllowedRNIDs := RNIDAccess.CommaText;
      end else if (OpenXMLGetTag('/CONFIGDATA/RNIDACCESSBYSTOREATTRIBUTES/OVERRIDEOTHERCONFIGS', 'FALSE') = 'TRUE') then begin
         AllowedRNIDs := '1234'; //give it a dummy rnid when overriding other config settings
      end;
   end;

   RNQuery2.Close;
   RNQuery2.SQL.Clear;
   RNQuery2.SQL.Add('Select * from Store where (Chaincode = ' + Stri(ChainCode,-1) + ')');
   If GetConfigString('HIDECHAINRNIDS','') <> '' then begin
      RNQuery2.SQL.Add('and (NOT systemcode in (' + GetConfigString('HIDECHAINRNIDS','')+'))');
   end;
   If AllowedRNIDs <> '' then begin
      RNQuery2.SQL.Add('and (systemcode in (' + AllowedRNIDs+'))');
   end;

   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONORDER','') <> '' then begin //2017-05-24 jtm: F#1778
      RNQuery2.SQL.Add('Order by ' + OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONORDER',''));
   end else begin
      RNQuery2.SQL.Add('Order by State,Name');
   end;
   RNQuery2.Open;
   Locs := GenerateSchoolOptions(RNquery2);

   If IncludeAllOption then begin
      Locs := '<option value="ALL"> All Locations</option>' + Locs;
   end;
   If (RNQuery2.RecordCount > 1) and (IncludePleaseSelect) then begin
      Locs := '<option value=""> Please Select</option>' + Locs;
   end;
   If (IncludePleaseSelect) and (RNQuery2.RecordCount = 1) and (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/INCLUDEPLEASESELECT','FALSE')='TRUE') then begin //2017-06-07 jtm: D#1713
      Locs := '<option value=""> Please Select</option>' + Locs;
   end;

   Result := Locs;
   RNQuery2.Close;
   FreeAndNil(RNIDAccess);
   ProcessLog(ltInfo, METHOD_NAME, 'END. RESULT = '+Result);
end;

function TCustomerInfoModule.GenerateAllLocationsOptions : String;
const
   METHOD_NAME = 'TCustomerInfoModule.GenerateAllLocationsOptions()';
var
  WS : String;
Begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   RNQuery2.Close;
   RNQuery2.SQL.Clear;


   RNQuery2.SQL.Add('Select * from Store where (Chaincode = ' + Stri(ChainCode,-1) + ')');
   If GetConfigString('HIDECHAINRNIDS','') <> '' then begin
      RNQuery2.SQL.Add('and (NOT systemcode in (' + GetConfigString('HIDECHAINRNIDS','')+'))');
   end;
   if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONORDER','') <> '' then begin //2017-05-24 jtm: F#1778
      RNQuery2.SQL.Add('Order by ' + OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONORDER',''));
   end else begin
      RNQuery2.SQL.Add('Order by State,City,Name');
   end;

   RNQuery2.Open;
   RNQuery2.First;
   While Not RNQuery2.EOF do begin
      if ShowStore(RNQuery2.FieldByName('Siblings').AsString) then begin
         WS := WS + '<option value="'+ RNQuery2.FieldByName('SystemCode').AsString +'"> ';
         If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONFORMAT') = 'CITYLOCNAME' then begin
            WS := WS + Trim(RNQuery2.FieldByName('City').AsString) + ', ' + Trim(RNQuery2.FieldByName('State').AsString) + ':' +
                       Trim(RNQuery2.FieldByName('Name').AsString) + ' ' +'</option>';
         end else if (OpenXMLGetTag('/CONFIGDATA/UIPARAMS/LOCATIONFORMAT') = 'NAMEONLY') then begin //2017-11-16 ajs: F#2282
            WS := WS + Trim(RNQuery2.FieldByName('Name').AsString) + ' ' +'</option>';
         end else begin
            WS := WS + Trim(RNQuery2.FieldByName('State').AsString) + '-' +
                       Trim(RNQuery2.FieldByName('Name').AsString) + ' ' +
                       Trim(RNQuery2.FieldByName('Address1').AsString) + ', ' +
                       Trim(RNQuery2.FieldByName('City').AsString)+'</option>';
         end;
      end;
      RNQuery2.Next;
   end;
   Result := WS;
   RNQuery2.Close;
   ProcessLog(ltInfo, METHOD_NAME, 'END. RESULT = '+Result);
end;

function TCustomerInfoModule.GenerateAllLocationStateOptions : String;
const
   METHOD_NAME = 'TCustomerInfoModule.GenerateAllLocationStateOptions()';
var
  WS : String;
Begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   RNQuery2.Close;
   RNQuery2.SQL.Clear;
   RNQuery2.SQL.Add('Select distinct State from Store where Chaincode = ' + Stri(ChainCode,-1));
   If GetConfigString('HIDECHAINRNIDS','') <> '' then begin
      RNQuery2.SQL.Add('and (NOT systemcode in (' + GetConfigString('HIDECHAINRNIDS','')+'))');
   end;
   RNquery2.SQL.Add(' Order by State');

   RNQuery2.Open;
   RNQuery2.First;
   While Not RNQuery2.EOF do begin
         WS := WS + '<option value="'+ RNQuery2.FieldByName('State').AsString +'"> ';
         WS := WS + Trim(RNQuery2.FieldByName('State').AsString)+'</option>';
      RNQuery2.Next;
   end;
   Result := WS;
   RNQuery2.Close;
   ProcessLog(ltInfo, METHOD_NAME, 'END. RESULT = '+Result);
end;
function TCustomerInfoModule.GenerateChildNameOptions(ADS : TDataSet; var ChildCount: Integer) : String;
const
   METHOD_NAME = 'TCustomerInfoModule.GenerateChildNameOptions(...)';
var
  WS : String;
Begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   ADS.First;
   WS := '';
   ChildCount := 0;
   While Not ADS.EOF do begin
      if ShowStore(ADS.FieldByName('Siblings').AsString) then begin
         inc(ChildCount);
         WS := WS + '<option value="'+ Trim(ADS.FieldByName('ChildGUID').AsString) + '"';
         If ((ADS.RecordCount = 1) AND (Not (StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/DISPLAYINVOICENUMBER','FALSE')))))) then begin
            WS := WS + ' selected';
         end;
         if(StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/DISPLAYINVOICENUMBER','FALSE')))) then begin // 2019-5-15 SS DVST-3126
            WS := WS + ' class="'+Trim(ADS.FieldByName('RNID').AsString)+'"> ';
         end else begin
         WS := WS + '> ';
         end;
         If OpenXMLGetTag('/CONFIGDATA/UIPARAMS/CHILDNAMEFORMAT') = 'LOCATIONNAMECS' then begin
            WS := WS + Trim(ADS.FieldByName('Name').AsString) + ', ' +Trim(ADS.FieldByName('City').AsString) + ' ' +Trim(ADS.FieldByName('State').AsString);
         end else begin
            WS := WS + Trim(ADS.FieldByName('FirstName').AsString) + ' ' +Trim(ADS.FieldByName('LastName').AsString) + ' ' +Trim(ADS.FieldByName('AccountNumber').AsString)
         end;
         WS := WS + '</option>';
      end;
      ADS.Next;
   end;
   Result := WS;
   ProcessLog(ltInfo, METHOD_NAME, 'ChildCount = '+Stri(ChildCount,-1));
   ProcessLog(ltInfo, METHOD_NAME, 'END. RESULT = '+Result);
end;

function TCustomerInfoModule.GeneratePaymentOptions(ACustGUID : String;PaymentType : String; SelectPaymentGUID : String; var PaymentOptionsCount: Integer): String;
const
   METHOD_NAME = 'TCustomerInfoModule.GeneratePaymentOptions(...)';
var
  WS : String;
  RowType : String;
  Procedure AddItem;
  Begin
     Inc(PaymentOptionsCount);
     WS := WS + '<option value="'+ Trim(RNQuery2.FieldByName('PaymentGUID').AsString) + '"';
     If (RNQuery2.RecordCount = 1) or (Trim(RNQuery2.FieldByName('PaymentGUID').AsString) = SelectPaymentGUID) then
         WS := WS + ' selected';
     WS := WS + '> ';
     WS := WS + Trim(RNQuery2.FieldByName('PaymentName').AsString)+'</option>';
  end;
Begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   If PaymentType = '' then PaymentType := 'ONETIME';
   RNQuery2.Close;
   RNQuery2.SQL.Clear;
   RNQuery2.SQL.Add('Select * from CustPayment where (CustGUID = '''+ACustGUID + ''') and (Hidden =0)');
   RNQuery2.Open;
   PaymentOptionsCount := 0;
   While Not RNQuery2.EOF do begin
      RowType := Trim(RNQuery2.FieldByName('PaymentType').AsString);
      If (RowType <> '') then begin
         If (RowType = 'CARD') and (Trim(RNQuery2.FieldByName('CARDISSUETYPE').AsString) = 'DEBIT') then begin
            If (PaymentType = 'RECURRING') and (OpenXMLGetTag('/CONFIGDATA/PAYMENTTYPES/PAYMENTTYPE[@NAME=''DEBIT'']/ALLOWRECURRING') = 'TRUE') then AddItem;
            If (PaymentType = 'ONETIME') and (OpenXMLGetTag('/CONFIGDATA/PAYMENTTYPES/PAYMENTTYPE[@NAME=''DEBIT'']/ALLOWONETIME') = 'TRUE') then AddItem;
         end else If RowType = 'CARD' then begin
            If (PaymentType = 'RECURRING') and (OpenXMLGetTag('/CONFIGDATA/PAYMENTTYPES/PAYMENTTYPE[@NAME=''CREDIT'']/ALLOWRECURRING') = 'TRUE') then AddItem;
            If (PaymentType = 'ONETIME') and (OpenXMLGetTag('/CONFIGDATA/PAYMENTTYPES/PAYMENTTYPE[@NAME=''CREDIT'']/ALLOWONETIME') = 'TRUE') then AddItem;
         end else If (RowType = 'CHECK')  then begin
            If (PaymentType = 'RECURRING') and (OpenXMLGetTag('/CONFIGDATA/PAYMENTTYPES/PAYMENTTYPE[@NAME=''CHECK'']/ALLOWRECURRING') = 'TRUE') then AddItem;
            If (PaymentType = 'ONETIME') and (OpenXMLGetTag('/CONFIGDATA/PAYMENTTYPES/PAYMENTTYPE[@NAME=''CHECK'']/ALLOWONETIME') = 'TRUE') then AddItem;
         end;
      end;

      RNQuery2.Next;
   end;
   RNquery2.Close;
   Result := WS;
   ProcessLog(ltInfo, METHOD_NAME, 'PaymentOptionsCount = '+Stri(PaymentOptionsCount,-1));
   ProcessLog(ltInfo, METHOD_NAME, 'END. RESULT = '+Result);
end;

function TCustomerInfoModule.AddActivationAjax(const AContentFields: TStrings; AHDQuery:TADOQuery; ASessionVar:TVarEval):String;
const
   METHOD_NAME = 'TCustomerInfoModule.AddActivationAjax(...)'; // 2019-5-15 SS DVST-210
   EMAIL_SERVER_IP = '192.168.100.195';
var
   AHTMLEmail, AEmail, AEmailSubject, ARNID, ZIP, ActivationCode, NumActivations: String; // 2019-5-15 SS DVST-210
   EmailServerIP, ReturnMsg, ReturnErrMsg, MaxActivationsForSite: String;
   EmailObj: TEmail;
   ActivationAdded, AddNActivations: Boolean; // 2019-5-15 SS DVST-210
   ActivationCodeList: TStringList;
   N,NMax, I: Integer;

   function StringListToActivationCodesTableRow(const AStringList: TStringList): String;
   const
      METHOD_NAME = 'StringListToActivationCodesTableRow(...)';
   var
      I: Integer;
      TableData: String;
   begin
      TableData:= '';
      for I:=0 to AStringList.Count-1 do begin
         if(I = 0) then begin
            TableData:= '<tr><td>Activation Codes&nbsp;</td>';
            TableData:= TableData+'<td>&nbsp;<b>'+Trim(AStringList[I])+'</b>&nbsp;</td>';
            TableData:= TableData+'</tr>';
         end else begin
            TableData:= TableData + '<tr><td></td>';
            TableData:= TableData+'<td>&nbsp;<b>'+Trim(AStringList[I])+'</b>&nbsp;</td>';
            TableData:= TableData+'</tr>';
         end;
      end;
      Result:= TableData;
      ProcessLog(ltInfo, METHOD_NAME, Result);
   end;
begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   ActivationAdded := False; AddNActivations := False;
   ActivationCodeList:= TStringList.Create();
   ActivationCode := ''; Result := ''; ReturnMsg := ''; ReturnErrMsg := '';
   EmailServerIP := ''; NumActivations:= ''; MaxActivationsForSite:= '';
   EmailObj := Nil;
   NMax:= 1; N:= 1;

   ARNID := NumericOnly(AContentFields.Values['ActivationLocation']);
   if ARNID = '' then begin // 2019-5-15 SS DVST-210
       Result := 'Please select a location and try again';
       Exit;
   end;

   AEmail := Trim(ValidCharsOnly(AContentFields.Values['email'],True,True,'_.-#@+/'));
   if(AEmail = '') then begin
      Result := 'Please enter a valid email address.';
      Exit;
   end;

   EmailServerIP := Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/EMAIL/SMTPSEVERIP','')); // 2019-5-15 SS DVST-210
   if(EmailServerIP = '') then begin
      EmailServerIP := EMAIL_SERVER_IP;
   end;
   AddNActivations := StrToBool(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/MULTIPLEACTIVATIONS/ENABLED','FALSE')));
   ProcessLog(ltInfo, METHOD_NAME, 'AddNActivations = '+BoolToStr(AddNActivations));

   NumActivations := Trim(AContentFields.Values['addActivationNum']); // when MULTIPLEACTIVATIONS is ENABLED, addActivationNum is always sent to the back end from the front end
   if(NumActivations = '') then begin
      NumActivations := '1';
   end;
   N := Valu(NumActivations);

   if(AddNActivations) then begin
      MaxActivationsForSite := NumericOnly(Trim(OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/MULTIPLEACTIVATIONS/MAXACTIVATIONSALLOWED','5')));
      NMax := Valu(MaxActivationsForSite);
      if(N <= NMax) then begin
         ActivationAdded := AddNProductActivations(AContentFields, AHDQuery, ASessionVar, N, ARNID, AEmail, ActivationCodeList);
      end else begin
         ActivationAdded := False;
         ProcessLog(ltWarning, METHOD_NAME, 'N = '+NumActivations+'. NMax = '+MaxActivationsForSite+'. No activations were added because N > NMax.');
      end;
   end else begin
      ActivationAdded := AddNProductActivations(AContentFields, AHDQuery, ASessionVar, N, ARNID, AEmail, ActivationCodeList);
   end;
   if(ActivationAdded) then begin
      ActivationCode := Trim(ActivationCodeList.CommaText);
   end;
   ASessionVar.AddValue('ActivationCode', ActivationCode);
   ProcessLog(ltInfo, METHOD_NAME, 'Number of Activations to Add = '+NumActivations);
   ProcessLog(ltInfo, METHOD_NAME, 'ActivationCode = '+ActivationCode); // 2019-5-15 SS DVST-210
   ProcessLog(ltInfo, METHOD_NAME, 'ActivationAdded = '+BoolToStr(ActivationAdded)); // 2019-5-15 SS DVST-210

   if(ActivationAdded) then begin
      ZIP := GetCustomerZIPByAHDQueryAndARNID(AHDQuery, ARNID);
      ProcessLog(ltInfo, METHOD_NAME, 'Customer ZIP: '+ZIP);
      ASessionVar.AddValue('ZIP', ZIP);

      if(AddNActivations) then begin
         if(N = 1) then begin
            ReturnMsg := 'One Activation Added! You can search for it by selecting the Pending radio button on the activation search form.';
         end else begin
         ReturnMsg := NumActivations+' Activations Added! You can search for it by selecting the Pending radio button on the activation search form.';
         end;
         ReturnErrMsg := 'Failed to send email to address: '+ AEmail +'. However, '+NumActivations+' Activation Codes added for ZIP: '+ZIP +'. You can search for it by selecting the Pending radio button on the activation search form.';
      end else begin
         ReturnMsg := 'Activation Code ' + ActivationCode +  ' Added! You can search for it by selecting the Pending radio button on the activation search form.';
         ReturnErrMsg := 'Failed to send email to address '+ AEmail +'. However, Activation Code: ' + ActivationCode +' added for ZIP: '+ZIP +'. You can search for it by selecting the Pending radio button on the activation search form.';
      end;

      AEmailSubject := 'New Activation for '  + DomainFriendlyName;
      AHTMLEmail := LoadWebFileFromFolder('NewActivationEmail.htm','PPADMIN');
      ReplaceString(AHTMLEmail, '%ACTIVATIONCODES%', StringListToActivationCodesTableRow(ActivationCodeList));

      EmailObj := TEmail.CreateEmail(EmailServerIP, ProcessLog);
      if(EmailObj <> Nil) then begin
         EmailObj.SetEmailAddresses(AEmail, GetConfigString('CONFIRMATIONBCC',''), GetConfigString('CONFIRMATIONREPLYTO',''), DomainFriendlyName, DomainSendAsEmail);// 2019-5-15 SS DVST-210: using one function to set addresses instead of two
         EmailObj.SetEmailMessageAndSubject(AHTMLEmail, AEmailSubject);

         if(EmailObj.SendEmail()) then begin
            Result := ReturnMsg;
         end else begin
            Result := ReturnErrMsg;
            ProcessLog(ltWarning, METHOD_NAME, 'FAILED TO SEND EMAIL.');
         end;
      end else begin
         Result := ReturnErrMsg; // same error message as when FAILED TO SEND EMAIL depending on AddNActivations, because we want to keep these message generic to customers and provide specefic messages in the processlog
         ProcessLog(ltWarning, METHOD_NAME, 'FAILED TO CREATE TEmail OBJECT.');
      end;
   end else begin
      Result := 'Failed to add new product activation(s). Please try again later.'//2019-5-15 SS DVST-210: as there can be multiple activation additions
   end;
   FreeAndNil(EmailObj);
   FreeAndNil(ActivationCodeList);
   ProcessLog(ltInfo, METHOD_NAME, 'END. RESULT = '+Result);
end;

function TCustomerInfoModule.AddNewProductActivation(const AContentFields: TStrings; AHDQuery:TADOQuery; ASessionVar:TVarEval; ARNID, AEmail: String; var ActivationCode: String):Boolean;
const
   METHOD_NAME = 'TCustomerInfoModule.AddNewProductActivation(...)';
var
   ProductActivationsCols, CustomersCols: String;
   ADistrictCode, ATechID: String;
begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   Result := True;
   
   ProductActivationsCols := 'pa.ActivatedDate, pa.ExpirationDate, pa.LastCheckin, pa.Disabled, pa.ComputerName';
   ProductActivationsCols := ProductActivationsCols + ',pa.ActivatedIP, pa.WinID, pa.DriveID ,pa.ActivationCode, pa.RNID, pa.ProfileXML';
   ProductActivationsCols := ProductActivationsCols + ',pa.StartDate, pa.ExpirationDate, pa.CheckinUser, pa.SendActivationToEmail, pa.ActivationCode';

   ADistrictCode := NumericOnly(Trim(AContentFields.Values['districtcode']));
   ATechID := NumericOnly(Trim(AContentFields.Values['techid']));

   AHDQuery.Close;
   AHDQuery.SQL.Clear;
   AHDQuery.SQL.Add('SET ARITHABORT ON; Select ' + ProductActivationsCols +' from ProductActivations pa');
   AHDQuery.SQL.Add('where pa.RNID = ''' + ARNID + '''');
   AHDQuery.SQL.Add('and pa.ActivatedDate is null');
   AHDQuery.SQL.Add('and pa.ExpirationDate < ''' + FormatDateTime('MM/DD/YYYY', Now()) + '''');
   AHDQuery.SQL.Add('and IsNull(pa.LastCheckin,'''') < ''' + FormatDateTime('MM/DD/YYYY', IncMonth(Now(),-6)) + ''''); //2018-10-10 jtm: DVST-585 only recycle activations that haven't checked in within 6 months
   AHDQuery.SQL.Add('Order by pa.ExpirationDate');
   ProcessLog(ltInfo,METHOD_NAME ,'ADDACTIVATIONAJAX recyclable activations sql = ' + AHDQuery.SQL.Text);
   try
      AHDQuery.Open;
      if AHDQuery.RecordCount > 0 then begin //if a record has never been activated and is expired then re-use it for a new activation
         ProcessLog(ltInfo,METHOD_NAME, 'Using previous activation. As such doing an edit.'); // 2019-5-15 SS DVST-210
         AHDQuery.First;
         AHDQuery.Edit;
         AHDQuery.FieldByName('Disabled').AsBoolean := False;
         AHDQuery.FieldByName('ComputerName').Clear;
         AHDQuery.FieldByName('ActivatedIP').Clear;
         AHDQuery.FieldByName('WinID').Clear;
         AHDQuery.FieldByName('DriveID').Clear;
      end else begin
         ProcessLog(ltInfo,METHOD_NAME, 'Using new activation. As such doing an insert.'); // 2019-5-15 SS DVST-210
         AHDQuery.Insert;
         AHDQuery.FieldByName('ActivationCode').AsString := ActivationCode;
         AHDQuery.FieldByName('RNID').AsString := ARNID;
      end;
      ProcessLog(ltinfo,METHOD_NAME,'DistrictCode:' + ADistrictCode+ 'TechID:'+ ATechID);
      if (ADistrictCode <> '') and (ATechID <> '') then begin
         ProcessLog(ltinfo, METHOD_NAME, 'adding profile XML');
         AHDQuery.FieldByName('ProfileXML').AsString :='<ACTIVATIONPROFILE><TRANIDENTPREFIX>'+ ADistrictCode + ATechID + '</TRANIDENTPREFIX></ACTIVATIONPROFILE>';

         if OpenXMLGetTag('/CONFIGDATA/UIPARAMS/ACTIVATIONS/SETRESTRICTEDDAYS','FALSE') = 'TRUE' then begin  //2017-11-17 jtm: D#2053
            AHDQuery.FieldByName('ProfileXML').AsString := '<ACTIVATIONPROFILE><TRANIDENTPREFIX>'+ ADistrictCode + ATechID + '</TRANIDENTPREFIX><RESTRICTEDDAYS>SUNDAY</RESTRICTEDDAYS></ACTIVATIONPROFILE>';
         end;
      end;
      AHDQuery.FieldByName('StartDate').AsDateTime := Now();
      AHDQuery.FieldByName('ExpirationDate').AsDateTime := Date() + 60;

      if Length(ValidCharsOnly(Trim(AContentFields.Values['User']),true,true,'')) > 30 then begin  //db field is char(30) so we can't allow strings longer
         AHDQuery.FieldByName('CheckinUser').AsString := Copy(ValidCharsOnly(Trim(AContentFields.Values['User']),true,true,''),1,30);
         ProcessLog(ltInfo, METHOD_NAME, 'Truncating CheckInUser: Copying only 30 chars as db field is char(30)');
      end else begin
         AHDQuery.FieldByName('CheckinUser').AsString := ValidCharsOnly(Trim(AContentFields.Values['User']),true,true,'');
      end;
      
      ProcessLog(ltInfo, METHOD_NAME, 'Actiovation Email will be set to: '+AEmail);
      AHDQuery.FieldByName('SendActivationToEmail').AsString := AEmail;
      AHDQuery.Post;
      ActivationCode := Trim(AHDQuery.FieldByName('ActivationCode').AsString); // because if AHDQuery.RecordCount > 0 then we reuse old activation code

      ProcessLog(ltInfo, METHOD_NAME, ActivationCode+' was added to RNID = '+ARNID);
      
      ASessionVar.AddValue('RNID', ARNID);
      if (ADistrictCode <> '') and (ATechID <> '') then begin   //2016-06-13 jtm
         ASessionVar.AddValue('DistrictCode', trim(ADistrictCode));
         ASessionVar.AddValue('TechID', Trim(ATechID));
      end;

      AHDQuery.Close;
      AHDQuery.SQL.Clear;
   except
      On E:Exception do begin
         Result := False;
         AHDQuery.Close;
         AHDQuery.SQL.Clear;
         ProcessLog(ltWarning,METHOD_NAME,'Exception Adding Activation: ' + E.Message);
      end;
   end;
   ProcessLog(ltInfo, METHOD_NAME, 'END. RESULT = '+BoolToStr(Result));
end;

function TCustomerInfoModule.GetCustomerZIPByAHDQueryAndARNID(AHDQuery:TADOQuery; ARNID:String):String;
const
   METHOD_NAME = 'TCustomerInfoModule.GetCustomerZIPByAHDQuery(...)';
   SQL = 'SELECT ZIP FROM CUSTOMERS WHERE RETAILNETID = :ARNID';
var
   ZIP: String;
begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   ZIP := '';
   AHDQuery.Close();
   AHDQuery.SQL.Clear();
   AHDQuery.SQL.Add(SQL);
   AHDQuery.Parameters.ParamByName('ARNID').Value := ARNID;
   AHDQuery.Prepared := True;
   try
      AHDQuery.Open();
      ZIP := AHDQuery.FieldByName('ZIP').AsString;
   except
      on E: Exception do begin
         ProcessLog(ltWarning, METHOD_NAME, 'FAILED TO GET ZIP. EXCEPTION THROWN: '+E.Message);
      end;
   end;
   Result := Trim(ZIP);
   ProcessLog(ltInfo, METHOD_NAME, 'END. RESULT(ZIP) = '+Result);
end;

function TCustomerInfoModule.GetUniqueActivationCodeForRNID(ARNID: String; AHDQuery:TADOQuery):String;
const
   METHOD_NAME = 'TCustomerInfoModule.GetUniqueActivationCodeForRNID(...)';
var
   ActivationExists: Boolean;
   ActivationCode, SQL: String;
begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   Result := '';
   if(ARNID = '') then begin
      ProcessLog(ltWarning, METHOD_NAME, 'NO RNID PROVIDED. AS SUCH NO ACTIVATION CODE GENERATED.');
      Exit;
   end;
   if(AHDQuery = Nil) then begin
      ProcessLog(ltWarning, METHOD_NAME, 'AHDQUERY PROVIDED IS NIL. AS SUCH NO ACTIVATION CODE GENERATED.');
      Exit;
   end;
      ActivationCode:= GenerateActivationCode();
      ActivationExists:= True;
      while ActivationExists do begin
         ActivationExists := False;
         SQL := 'SELECT SYSTEMCODE FROM PRODUCTACTIVATIONS WHERE RNID='''+ARNID+'''';
         SQL := SQL + ' AND ACTIVATIONCODE='''+ActivationCode+'''';
      AHDQuery.Close;
      AHDQuery.SQL.Clear();
      AHDQuery.SQL.Add(SQL);
         try
         AHDQuery.Open();
         if(AHDQuery.RecordCount > 0) then begin
               ActivationExists := True;
               ActivationCode := GenerateActivationCode();
            end;
         except
            On E: Exception do begin
            ActivationCode := '';
            ActivationExists := False;
            AHDQuery.Close;
            AHDQuery.SQL.Clear();
            ProcessLog(ltWarning, METHOD_NAME, 'NO ACTIVATION CODE GENERATED. EXCEPTION THROWN = '+E.Message);
            end;
         end;
      end;
   Result:= ActivationCode;
   ProcessLog(ltInfo, METHOD_NAME, 'END. Activation Code = '+ActivationCode);
end;

function TCustomerInfoModule.GetUniqueActivationCodeForRNIDWithMaxTries(MaxTries: Integer;ARNID: String; AHDQuery:TADOQuery):String;
const
   METHOD_NAME = 'TCustomerInfoModule.GetUniqueActivationCodeForRNIDWithMaxTries(...)';
var
   I: Integer;
   ActivationCode: String;
begin
   ProcessLog(ltDebug, METHOD_NAME, 'BEGIN');
   ProcessLog(ltDebug, METHOD_NAME, 'MaxTries = '+Stri(MaxTries,-1));
   I:= 0;
   ActivationCode := GetUniqueActivationCodeForRNID(ARNID, AHDQuery);
   while ((I < MaxTries) And (ActivationCode = '')) do begin
      ProcessLog(ltInfo, METHOD_NAME, 'Try #'+Stri(I+1, -1)+' FAILED. CALLING GetUniqueActivationCodeForRNID(...) TO TRY AND GET ACTIVATION CODE.');
      Inc(I);
      ActivationCode := GetUniqueActivationCodeForRNID(ARNID, AHDQuery);
   end;
   Result := ActivationCode;
   ProcessLog(ltDebug, METHOD_NAME, 'END. Result = '+Result);
end;

function TCustomerInfoModule.AddNProductActivations(const AContentFields: TStrings; AHDQuery:TADOQuery; ASessionVar:TVarEval; N:Integer; ARNID, AEmail: String; ACList: TStringList):Boolean;
const
   METHOD_NAME = 'TCustomerInfoModule.AddNProductActivations(...)';
   MAX_TRIES = 3;
var
   I: Integer;
   ActivationCode, TempAC: String;
   ACAdded: Boolean;
begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   ProcessLog(ltDebug, METHOD_NAME, 'AContentFields.CommaText = '+AContentFields.CommaText);
   ProcessLog(ltDebug, METHOD_NAME, 'ASessionVar.Vars.Text = '+ASessionVar.Vars.Text);
   ActivationCode := '';
   I:= 0;
   ACAdded := True;
   if(ACList = Nil) then begin
      ACAdded := False;
   end;
   while ((I < N) And (ACAdded)) do begin
      ActivationCode := GetUniqueActivationCodeForRNIDWithMaxTries(MAX_TRIES, ARNID, AHDQuery);
      if(ActivationCode = '') then begin
         ACAdded := False;
         Break;
      end;
      TempAC:= ActivationCode;
      ACAdded := AddNewProductActivation(AContentFields, AHDQuery, ASessionVar, ARNID, AEmail, ActivationCode);

      ProcessLog(ltDebug, METHOD_NAME, 'ActivationCode passed for activating : '+TempAC);
      ProcessLog(ltDebug, METHOD_NAME, 'ActivationCode used for activating: '+ActivationCode);// If we are reusing activation codes, the activation code passed in AddNewProductActivation(...) might not be what is used to add a new activation.
      ProcessLog(ltDebug, METHOD_NAME, Stri(I+1,-1)+'# AddNewProductActivation RESULT = '+BoolToStr(ACAdded));

      ACList.Add(ActivationCode);
      Inc(I);
   end;
   Result := ACAdded;
   ProcessLog(ltInfo, METHOD_NAME, 'END. RESULT = '+BoolToStr(Result));
end;

function TCustomerInfoModule.GenerateActivationOptions(maxNumOptions:String):String;
const
   METHOD_NAME = 'TCustomerInfoModule.GenerateActivationOptions(...)';
var
   Options: String;
   N, I: Integer;
begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   Options:= '';
   maxNumOptions := Trim(NumericOnly(maxNumOptions));
   N := Valu(maxNumOptions);
   for I:=0 to N-1 do begin
      Options := Options+ '<option value='''+Stri((I+1),-1)+'''>'+Stri((I+1),-1)+'</option>';
   end;
   Result:= Options;
   ProcessLog(ltInfo, METHOD_NAME, 'END - '+Result);
end;

function TCustomerInfoModule.isCardDisbursable(const responseXML: String): boolean;
const
   METHOD_NAME = 'TCustomerInfoModule.isCardDisbursable';
var
   onDemandPaymentCreditCapable, fastFundsDisburseCapable: string;
begin
   onDemandPaymentCreditCapable := GetXMLTagStr(responseXML, 'ONDEMANDPAYMENTCREDITCAPABLE');
   fastFundsDisburseCapable := GetXMLTagStr(responseXML, 'FASTFUNDSDISBURSECAPABLE');

   ProcessLog(ltInfo, METHOD_NAME, 'onDemandPaymentCreditCapable: ' + onDemandPaymentCreditCapable);
   ProcessLog(ltInfo, METHOD_NAME, 'fastFundsDisburseCapable: ' + fastFundsDisburseCapable);

   Result := strtobool(onDemandPaymentCreditCapable) or strtobool(fastFundsDisburseCapable);
end;

function TCustomerInfoModule.wasTransactionSuccessful(const responseXML: String): boolean;
const
   METHOD_NAME = 'TCustomerInfoModule.wasTransactionSuccessful';
var
   tranSuccess: String;
begin
   tranSuccess := GetXMLTagStr(responseXML, 'TRANSUCCESS');

   ProcessLog(ltInfo, METHOD_NAME, GetXMLTagStr(responseXML, 'TRANRESPMESSAGE'));
   ProcessLog(ltInfo, METHOD_NAME, tranSuccess);
   Result := strtobool(tranSuccess);
end;

function TCustomerInfoModule.CheckIfCardIsDisbursable(CardDetails: TStringList; const ARNID: String; const UseGetBinDetail: boolean = false;
                                                               ServiceName: String = 'CARD'; const ClientTxnGUID: String = '';
                                                               const AppServerSI: String = ''): boolean;
const
   METHOD_NAME = 'TCustomerInfoModule.CheckIfCardIsDisbursable';
var
   CEP, AVS: String;
   cardIsDisbursable: boolean;
   Request, Response: TStringList;

   function getValidCEPParams(const TagName: String; const SpecialCharacters: String = ''): String;
   begin
      Result := ValidCharsOnly(Trim(GetXMLTagStr(CEP, TagName)), True, True, SpecialCharacters);
   end;
begin
   Result := False;

   if ARNID = '' then begin
      ProcessLog(ltWarning, METHOD_NAME, 'RNID is empty');
      exit;
   end;

   CEP := CardDetails.Values['CEP'];
   if CEP = '' then begin
      ProcessLog(ltWarning, METHOD_NAME, 'CardEventParams is empty');
      exit;
   end;

   if ServiceName = '' then ServiceName := 'CARD';

   Request := TStringList.Create;
   Response := TStringList.Create;

   if UseGetBinDetail then begin
      with Request do begin
         Add('<TRANSACTION>');
         Add('<TRANSACTIONTYPE>GETBINDETAIL</TRANSACTIONTYPE>');
         Add('<SERVICENAME>' + ServiceName + '</SERVICENAME>');
         Add('<RNID>' + ARNID + '</RNID>');
         Add('<CARDEVENTPARAMS>');
         Add('<CARDEVENTPARAM>');
         Add('<ENCDVCDEVICETYPE>' + getValidCEPParams('ENCDVCDEVICETYPE') + '</ENCDVCDEVICETYPE>');
         Add('<ENCDVCKSN>' + getValidCEPParams('ENCDVCKSN') + '</ENCDVCKSN>');
         Add('<ENCDVCENCTYPE>' + getValidCEPParams('ENCDVCENCTYPE') + '</ENCDVCENCTYPE>');
         Add('<ENCDVCENCOAEPPADDED>' + getValidCEPParams('ENCDVCENCOAEPPADDED') + '</ENCDVCENCOAEPPADDED>');
         Add('<ENCDVCCARDDATASOURCE>' + getValidCEPParams('ENCDVCCARDDATASOURCE') + '</ENCDVCCARDDATASOURCE>');
         Add('<ENCDVCENCRYPTEDPAN>' + getValidCEPParams('ENCDVCENCRYPTEDPAN', '+=/') + '</ENCDVCENCRYPTEDPAN>');
         Add('<ENCDVCCCCVV>' + getValidCEPParams('ENCDVCCCCVV') + '</ENCDVCCCCVV>');
         Add('<ENCDVCCCAVS>' + NumericOnly(CardDetails.Values['AVS']) + '</ENCDVCCCAVS>');
         Add('</CARDEVENTPARAM>');
         Add('</CARDEVENTPARAMS>');
         if AppServerSI <> '' then begin
            Add('<SOLUTIONIDENT>' + AppServerSI + '</SOLUTIONIDENT>');
         end;
         Add('</TRANSACTION>');
      end;
   end else begin
      with Request do begin
         Add('<TRANSACTION>');
         Add('<RNID>' + ARNID + '</RNID>');
         Add('<TRANSACTIONTYPE>CCAUTH</TRANSACTIONTYPE>');
         Add('<CCAUTHTYPE>AVS</CCAUTHTYPE>');
         Add('<CCAMT>0.00</CCAMT>');
         Add('<CCACCOUNT>' + NumericOnly(CardDetails.Values['CCACCOUNT']) + '</CCACCOUNT>');
         Add('<CARDEVENTPARAMS>');
         Add('<ENCDVCDEVICETYPE>' + getValidCEPParams('ENCDVCDEVICETYPE') + '</ENCDVCDEVICETYPE>');
         Add('<ENCDVCKSN>' + getValidCEPParams('ENCDVCKSN') + '</ENCDVCKSN>');
         Add('<ENCDVCENCTYPE>' + getValidCEPParams('ENCDVCENCTYPE') + '</ENCDVCENCTYPE>');
         Add('<ENCDVCENCOAEPPADDED>' + getValidCEPParams('ENCDVCENCOAEPPADDED') + '</ENCDVCENCOAEPPADDED>');
         Add('<ENCDVCCARDDATASOURCE>' + getValidCEPParams('ENCDVCCARDDATASOURCE') + '</ENCDVCCARDDATASOURCE>');
         Add('<ENCDVCENCRYPTEDPAN>' + getValidCEPParams('ENCDVCENCRYPTEDPAN', '+=/') + '</ENCDVCENCRYPTEDPAN>');
         Add('<ENCDVCCCEXP>' + getValidCEPParams('ENCDVCENCRYPTEDEXP') + '</ENCDVCCCEXP>');
         Add('<ENCDVCCCAVS>' + NumericOnly(CardDetails.Values['AVS']) + '</ENCDVCCCAVS>');
         Add('</CARDEVENTPARAMS>');
         Add('<SERVICENAME>' + ServiceName + '</SERVICENAME>');
         Add('<INCLUDECCBINDETAIL>TRUE</INCLUDECCBINDETAIL>');
         if ClientTxnGUID <> '' then begin
            Add('<CLIENTTXNGUID>' + ClientTxnGUID + '</CLIENTTXNGUID>');
         end;
         if AppServerSI <> '' then begin
            Add('<SOLUTIONIDENT>' + AppServerSI + '</SOLUTIONIDENT>');
         end;
         Add('</TRANSACTION>');
      end;
   end;

   ProcessLog(ltDebug, METHOD_NAME, Request.Text);
   ProcessPPSAPIXML(Request.Text, Response, GetAppServerHost, 0);
   ProcessLog(ltDebug, METHOD_NAME, Response.Text);

   cardIsDisbursable := isCardDisbursable(Response.Text);
   if UseGetBinDetail or NOT cardIsDisbursable then begin
      ProcessLog(ltInfo, METHOD_NAME, 'isCardDisbursable: ' + booltostr(cardIsDisbursable));
      Result := cardIsDisbursable;
   end else begin
      Result := wasTransactionSuccessful(Response.Text);
   end;

   FreeAndNil(Request);
   FreeAndNil(Response);
end;

function TCustomerInfoModule.GetUsersAjax(const AQueryFields, AContentFields: TStrings; var ContentType: String):String;
const
   METHOD_NAME = 'TCustomerInfoModule.GetUsersAjax(...)';
var
   UserName, EmployeeGUID: String;
begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   Result:= ''; UserName:= ''; EmployeeGUID:= '';
   ContentType := 'text/html';

   if (UserXMLGetTag('/USERPROFILE/ALLOWADMINUSERMANAGEMENT','FALSE')='TRUE') then begin
      Username := ValidCharsOnly(AQueryFields.Values['USERNAME'],True,True,'_.-');
      EmployeeGUID := GuidOnly(AQueryFields.Values['USERGUID']);

      if AQueryfields.Values['DISPLAYFORMAT'] = 'XML' then begin
         Result := GetUserQueryTable(Username,EmployeeGUID,'XML', False); // 2019-5-15 SS DVST-702: False to idicate it's not a download, but a display
         ContentType := 'text/xml';

      end else if ((Trim(AQueryfields.Values['DOWNLOAD']) <> '') And (Trim(AQueryfields.Values['DISPLAYFORMAT']) = 'JSON')) then begin // 2019-5-15 SS DVST-702: JSON is used for download because our front end expects the data in a special JSON format: [{"key1":"valueA1", "key2": "valueB1"},{"key1":"valueA2", "key2": "valueB2"}]
         Result := GetUserQueryTable(Username,EmployeeGUID,'JSON', True);
         ContentType := 'application/json';

      end else if (Request.queryfields.Values['DISPLAYFORMAT'] = 'JSON') then begin
         Result := GetUserQueryTable(Username,EmployeeGUID,'JSON', False); // 2019-5-15 SS DVST-702: False to idicate it's not a download, but a display
         ContentType := 'application/json';
      end else begin // 2019-5-15 SS DVST-702
         Result := '<BR><B><font color="red">Invalid Request</font></B>';
         ProcessLog(ltWarning, METHOD_NAME, 'Unsupported DISPLAYFORMAT value sent with URL to backend.');
      end;
   end else begin
      Result := '<BR><B><font color="red">Unauthorized Access</font></B>';
   end;
   ProcessLog(ltInfo, METHOD_NAME, 'END - '+Result);
end;

function TCustomerInfoModule.AddDeviceCapabilities(XML, CardEventParamsXPath: String; Capabilities: Array of String):String;
const
   METHOD_NAME = 'TCustomerInfoModule.AddDeviceCapabilities(...)';
var
   DeviceCapabilitiesParentTag, DeviceCapabilitiesTag: String;
   DeviceCapabilitiesParentTagXPath: String;
   AOpenXML: TOpenXML;
   I:Integer;
begin
   ProcessLog(ltInfo, METHOD_NAME, 'BEGIN');
   Result:= XML;
   AOpenXML:= Nil;
   DeviceCapabilitiesParentTag := 'ENCDVCTERMCAPS';
   DeviceCapabilitiesTag:= 'ENCDVCTERMCAP';
   DeviceCapabilitiesParentTagXPath := CardEventParamsXPath + '/' + DeviceCapabilitiesParentTag;

   try
      AOpenXML:= TOpenXML.CreateFromString(Nil, XML);
   except
      On E: Exception do ProcessLog(ltWarning, METHOD_NAME, 'EXCEPTION THROWN = '+E.Message);
   end;
   if(AOpenXML <> Nil) then begin
      AOpenXML.AddChildAsParent(CardEventParamsXPath, DeviceCapabilitiesParentTag);
      for I:= 0 to Length(Capabilities)-1 do begin
         AOpenXML.AddChildNode(DeviceCapabilitiesParentTagXPath, DeviceCapabilitiesTag, Trim(Capabilities[I]));
      end;
      Result := AOpenXML.DocumentAsString(); // Convert AOpenXML to string, that has the new child tags (corresponding to device capabilites) added to the XML passed in.
      ProcessLog(ltInfo, METHOD_NAME, 'SUCCESSFULLY ADDED DEVICE CAPABILITIES TO XML.');
   end else begin
      ProcessLog(ltWarning, METHOD_NAME, 'UNABLE TO CREATE TOpenXML OBJECT. THEREFORE FAILED TO ADD DEVICE CAPABILITIES TO XML.');
   end;
   FreeAndNil(AOpenXML);
   ProcessLog(ltInfo, METHOD_NAME, 'END. Result = '+Result);
end;

function TCustomerInfoModule.LockUserAjax(const AQueryFields:TStrings; ARNQuery:TADOQuery; CustomerMembType, ARNID: String): String;
const
   METHOD_NAME = 'TCustomerInfoModule.LockUserAjax(...)';
var
   Answer: String;
begin
   ProcessLog(ltDebug, METHOD_NAME, 'BEGIN');
   Answer := '';
   if(Not(OpenCommonDBQueryForLockUnlockAjax(AQueryFields, ARNQuery, CustomerMembType, ARNID, Answer))) then begin
      Result := Answer;
      Exit;
   end;
   if(ARNQuery.RecordCount > 0) then begin
      ARNQuery.Edit;
      ARNQuery.FieldByName('LockedUntil').AsDateTime := EncodeDate(2050,1,1);
      ARNQuery.Post;
      Result := 'Customer ' + Trim(ARNQuery.FieldByName('FirstName').AsString) + ' ' +Trim(ARNQuery.FieldByName('LastName').AsString) + ' Locked.';
   end else begin
      Result := '**Customer not on File**';
   end;
   ProcessLog(ltDebug, METHOD_NAME, 'END. RESULT = '+Result);
end;

function TCustomerInfoModule.UnlockUserAjax(const AQueryFields:TStrings; ARNQuery:TADOQuery; CustomerMembType, ARNID: String): String; // 2019-5-15 SS DVST-572
const
   METHOD_NAME = 'TCustomerInfoModule.UnlockUserAjax(...)';
var
   Answer: String;
begin
   ProcessLog(ltDebug, METHOD_NAME, 'BEGIN');
   Answer := '';
   if(Not(OpenCommonDBQueryForLockUnlockAjax(AQueryFields, ARNQuery, CustomerMembType, ARNID, Answer))) then begin
      Result := Answer;
      Exit;
   end;
   if(ARNQuery.RecordCount > 0) then begin
      ARNQuery.Edit;
      ARNQuery.FieldByName('LockedUntil').Clear;
      ARNQuery.Post;
      Result := 'Customer ' + Trim(ARNQuery.FieldByName('FirstName').AsString) + ' ' +Trim(ARNQuery.FieldByName('LastName').AsString) + ' Unlocked.';
   end else begin
      Result := '**Customer not on File**';
   end;
   ProcessLog(ltDebug, METHOD_NAME, 'END. RESULT = '+Result);
end;

function TCustomerInfoModule.OpenCommonDBQueryForLockUnlockAjax(const AQueryFields:TStrings; ARNQuery:TADOQuery; CustomerMembType, ARNID: String; var Answer:String):Boolean;
const
   METHOD_NAME = 'TCustomerInfoModule.DoCommonWorkForLockUnlockAjax(...)';
var
   CustomerCode, SQL: String;
begin
   ProcessLog(ltDebug, METHOD_NAME, 'BEGIN');

   Answer := '';
   Result := False;

   if(CustomerMembType <> 'ADMIN') then begin
      Answer := '<B>**Invalid Credentials**</B>';
      Exit;
   end;

   if((AQueryFields = Nil) Or (ARNQuery = Nil)) then begin
      Answer := 'Unable to find customer. Please try again later.'; // generic error message to user
      ProcessLog(ltWarning, METHOD_NAME, 'INVALID PARAM PASSED INTO FUNCTION. AQueryFields/ARNQuery IS NILL.');
      Exit;
   end;

   CustomerCode := ValidCharsOnly(AQueryFields.Values['CUSTIDENT'],TRUE,True,'-');
   SQL := 'Select * from Customers where (StoreCode = '+ARNID + ') and (CustomerCode = ''' + CustomerCode + ''')'; // SQL1

   if(Not (TryOpen(ARNQuery, SQL))) then begin
     Answer := 'Unable to find customer. Please try again later.'; // generic error message to user when exception is thrown
     ProcessLog(ltWarning, METHOD_NAME, 'CALL TO TryOpen(...) THREW AN EXCEPTION.');
     Exit;
   end;

   if(ARNQuery.RecordCount = 0) then begin
      SQL := 'Select * from Customers where (CustomerCode = ''' + CustomerCode + ''')'; // SQL2
      if(Not (TryOpen(ARNQuery, SQL))) then begin
         Answer := 'Unable to find customer. Please try again later.';
         ProcessLog(ltWarning, METHOD_NAME, 'CALL TO TryOpen(...) THREW AN EXCEPTION.');
         Exit;
      end;
   end;

   Result := True; // successfully opened connection to database either using RNID and Customer Code (SQL1), or only using Customer Code (SQL2)
   ProcessLog(ltDebug, METHOD_NAME, 'END. RESULT = '+BoolToStr(Result));
end;

function TCustomerInfoModule.LookupRegistryFromMerchantSessionID(ADOQuery: TADOQuery; const ARNID, MerchantSessionID: string): boolean;
const
   METHOD_NAME = 'TCustomerInfoModule.LookupRegistryFromMerchantSessionID';
   GET_REGISTRY_FROM_MERCHANTSESSIONID = 'SELECT R.STORECODE, R.KEYNAME, R.SUBKEY1, R.SUBKEY2, R.KEYVALUE AS KEYVALUE, R.OPTIONS AS OPTIONS,' +
         'S.RNSESSIONID, S.CUSTOMERAUTHENTICATEDTILL AS AUTHENTICATEDTILL, S.SESSIONVARS as SessionVars ' +
         'FROM REGISTRY AS R ' +
         'LEFT OUTER JOIN WWWSESSION AS S ON R.KEYVALUE = S.RNSESSIONID ' +
         'WHERE R.STORECODE = :RNID ' +
         'AND R.KEYNAME = ''MerchantSessionID'' ' +
         'AND R.SUBKEY1 = :MerchantSessionID';
begin
   Result := True;
   if ADOQuery = nil then begin
      ProcessLog(ltDebug, METHOD_NAME, 'ADOQuery = nil');
      Result := False;
      exit;
   end;

   with ADOQuery do begin
      Close();
      SQL.Clear();
      SQL.Add(GET_REGISTRY_FROM_MERCHANTSESSIONID);
      Parameters.ParamByName('RNID').Value := NumericOnly(ARNID);
      Parameters.ParamByName('MerchantSessionID').Value := NumericOnly(MerchantSessionID);
      Open();
   end;
end;

function TCustomerInfoModule.AddProductionActivationChangeLog(AChangeHost: String; ADataSet:TDataSet; UserName, RemoteAddress, HDDBConnString: String):Boolean; // 2019-6-26 ss DVST-3764
const
   METHOD_NAME = 'TCustomerInfoModule.AddProductionActivationChangeLog(...)';
var
   ActivationRecord : TProductActivationChangeLog;
   ActivationChangeQ : TADOQuery;
begin
   ProcessLog(ltDebug, METHOD_NAME, 'BEGIN.');
   ProcessLog(ltDebug, METHOD_NAME, 'AChangeHost = '+AChangeHost);
   ProcessLog(ltDebug, METHOD_NAME, 'HDDBConnString = '+HDDBConnString);
   ActivationRecord := Nil; ActivationChangeQ := Nil;
   Result := False;
   try
      try
         if((ADataSet.Modified = True) Or (ADataSet.State = dsInsert)) then begin
            ProcessLog(ltDebug, METHOD_NAME, 'ADDING RECORD TO ProductActivationChangeLog TABLE.');
            ActivationRecord := TProductActivationChangeLog.Create(AChangeHost, ADataSet, ProcessLog); // can trow exception if incorrect DataSet is passed and when are try to access a field that does not exist
            ActivationRecord.ChangeMade := ActivationRecord.CreateChangeXML(ADataSet); // same reason as above
            ActivationRecord.User := UserName;
            if(ActivationRecord.RemoteAddress = '') then begin
               ActivationRecord.RemoteAddress := RemoteAddress;
            end;
            ActivationChangeQ := CreateAdoQFromADBConnString(HDDBConnString);
            if(ActivationChangeQ <> Nil) then begin
               ActivationRecord.InsertChangeRecord(ActivationChangeQ); // can throw an exception
               ProcessLog(ltDebug, METHOD_NAME, 'ActivationChangeQ.SQL.TEXT = '+ActivationChangeQ.SQL.Text);
               ProcessLog(ltDebug, METHOD_NAME, 'DONE ADDING RECORD TO ProductActivationChangeLog TABLE.');
               Result := True;
            end else begin
               ProcessLog(ltWarning, METHOD_NAME, 'EXCEPTION THROWN @ CreateAdoQFromADBConnString(...). CHECK CONNECTION STRING.');
            end;
         end;
      except
         on E: Exception do begin
            ProcessLog(ltDebug, METHOD_NAME, 'EXCEPTION THROWN = '+E.Message);
         end;
      end;
   finally
      FreeAndNil(ActivationRecord);
      FreeAndNil(ActivationChangeQ);
      ProcessLog(ltDebug, METHOD_NAME, 'END. RESULT = '+BoolToStr(Result));
   end;
end;

initialization
OExportDateFormat := OEXPORT_SYS_DATE;
OExportTimeFormat := OEXPORT_SYS_TIME;


finalization


end.


-----------------------------------------------------------------------------------------
